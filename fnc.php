<?php
/**
 * Exoplanet functions and definitions
 *
 * @package Exoplanet
 */

if (!function_exists('shorttrips_prebook_mock_enabled')) {
    function shorttrips_prebook_mock_enabled(): bool
    {
        $forced = apply_filters('shorttrips_prebook_force_mock', null);
        if ($forced === true) {
            return true;
        }
        if ($forced === false) {
            return false;
        }
        if (defined('SHORTTRIPS_PREBOOK_MODE') && strtolower((string) SHORTTRIPS_PREBOOK_MODE) === 'mock') {
            return true;
        }
        return get_option('shorttrips_prebook_mock_mode', '0') === '1';
    }
}
if (!function_exists('shorttrips_prebook_mock_rooms')) {
    function shorttrips_prebook_mock_rooms(array $context = []): array
    {
        $scenario = sanitize_file_name(get_option('shorttrips_prebook_mock_scenario', 'default'));
        if ($scenario === '') {
            $scenario = 'default';
        }
        $slashit = function ($path) {
            return rtrim($path, '/\\') . '/';
        };
        $baseDir = defined('WP_CONTENT_DIR')
            ? WP_CONTENT_DIR
            : (defined('ABSPATH') ? $slashit(ABSPATH) . 'wp-content' : dirname(__FILE__));
        $mockDir = (function_exists('trailingslashit') ? trailingslashit($baseDir) : $slashit($baseDir)) . 'uploads/shorttrips-mocks';

        $rooms = [];
        $filePath = $mockDir . '/' . $scenario . '.json';
        if (file_exists($filePath) && is_readable($filePath)) {
            $decoded = json_decode(file_get_contents($filePath), true);
            if (is_array($decoded)) {
                foreach ($decoded as $row) {
                    if (is_array($row)) {
                        $rooms[] = $row;
                    }
                }
            }
        }

        $checkin = $context['checkin'] ?? '';
        $checkout = $context['checkout'] ?? '';
        $nights = 1;
        if ($checkin && $checkout) {
            $ci = strtotime($checkin);
            $co = strtotime($checkout);
            if ($ci && $co && $co > $ci) {
                $daySeconds = defined('DAY_IN_SECONDS') ? DAY_IN_SECONDS : 86400;
                $nights = max(1, (int) round(($co - $ci) / $daySeconds));
            }
        }

        if (empty($rooms)) {
            $rooms = [
                [
                    'type' => 'Junior Suite Zeezicht (mock)',
                    'meal' => 'All Inclusive',
                    'price' => round(189.50 * $nights, 2),
                    'desc' => 'Mockdata: ruime suite met balkon, zeezicht en late check-out.',
                    'policy' => 'Gratis annuleren tot 7 dagen voor aankomst',
                    'beds' => 1,
                    'extrabeds' => 1,
                    'shared_room' => 0,
                    'shared_facilities' => 0,
                    'superdeal' => false,
                    'bestbuy' => true,
                    'amen' => ['Gratis WiFi', 'Airconditioning', 'Balkon', 'Zeezicht'],
                ],
                [
                    'type' => 'Familiesuite Mockville',
                    'meal' => 'Halfpension',
                    'price' => round(149.00 * $nights, 2),
                    'desc' => 'Mockdata: familiesuite met aparte slaapkamer en inclusief diner.',
                    'policy' => 'Gedeeltelijk restitueerbaar tot 21 dagen voor aankomst',
                    'beds' => 2,
                    'extrabeds' => 2,
                    'shared_room' => 0,
                    'shared_facilities' => 0,
                    'superdeal' => true,
                    'bestbuy' => false,
                    'amen' => ['Ontbijt inbegrepen', 'Gratis WiFi', 'Eigen badkamer'],
                ],
            ];
        }

        return apply_filters('shorttrips_prebook_mock_rooms', $rooms, $context);
    }
}

// =============================================================================
// CITY CACHE ‚Äì Materialiseer destinations/resorts voor snel zoekformulier
// =============================================================================
if (!function_exists('shorttrips_rebuild_city_cache')) {
    function shorttrips_rebuild_city_cache(bool $force = false): array
    {
        global $wpdb;
        $lastBuilt = (int) get_option('st_city_cache_last_built', 0);
        $now = time();
        // Throttle: alleen als force of ouder dan 12h
        if (!$force && ($now - $lastBuilt) < 12 * HOUR_IN_SECONDS) {
            return ['skipped' => true, 'message' => 'Cache is recent genoeg'];
        }

        // Haal destinations/resorts uit bestaande tabellen
        $rows = $wpdb->get_results("
            SELECT destination_id AS id,
                   destination_name AS name,
                   country_id,
                   country_name
            FROM bravo_destinations
            WHERE deleted_at IS NULL
        ", ARRAY_A);

        $inserted = 0;
        $byCountry = [];
        $all = [];

        if ($rows) {
            foreach ($rows as $r) {
                $id = (int) ($r['id'] ?? 0);
                $name = trim((string) ($r['name'] ?? ''));
                $countryId = (int) ($r['country_id'] ?? 0);
                $countryName = trim((string) ($r['country_name'] ?? ''));
                if ($id <= 0 || $name === '') {
                    continue;
                }
                $nameLc = mb_strtolower($name, 'UTF-8');
                $slug = sanitize_title($name);
                $wpdb->query($wpdb->prepare("
                    REPLACE INTO st_city_cache (id, name, name_lc, country_id, country_name, slug, updated_at)
                    VALUES (%d, %s, %s, %d, %s, %s, NOW())
                ", $id, $name, $nameLc, $countryId, $countryName, $slug));
                $inserted++;

                $item = [
                    'id' => $id,
                    'name' => $name,
                    'country_id' => $countryId,
                    'country' => $countryName,
                    'slug' => $slug,
                ];
                $all[] = $item;
                if (!isset($byCountry[$countryId])) {
                    $byCountry[$countryId] = [];
                }
                $byCountry[$countryId][] = $item;
            }
        }

        // Cache JSON blobs (per land en alle)
        set_transient('st_cities_all', $all, 12 * HOUR_IN_SECONDS);
        set_transient('st_cities_by_country', $byCountry, 12 * HOUR_IN_SECONDS);
        update_option('st_city_cache_last_built', $now);

        return [
            'skipped' => false,
            'inserted' => $inserted,
            'countries' => count($byCountry),
            'total' => count($all),
        ];
    }
}

if (!function_exists('shorttrips_get_cities_cached')) {
    function shorttrips_get_cities_cached(int $countryId = 0): array
    {
        $all = get_transient('st_cities_all');
        $byCountry = get_transient('st_cities_by_country');
        if ($all === false || $byCountry === false) {
            shorttrips_rebuild_city_cache(true);
            $all = get_transient('st_cities_all');
            $byCountry = get_transient('st_cities_by_country');
        }
        if ($countryId > 0) {
            return isset($byCountry[$countryId]) ? $byCountry[$countryId] : [];
        }
        return is_array($all) ? $all : [];
    }
}

// AJAX + init endpoint om cache te verversen (lichte achtergrond-call)
add_action('wp_ajax_shorttrips_refresh_cities', 'shorttrips_refresh_cities');
add_action('wp_ajax_nopriv_shorttrips_refresh_cities', 'shorttrips_refresh_cities');
function shorttrips_refresh_cities()
{
    $nonce = $_REQUEST['_wpnonce'] ?? '';
    if (empty($nonce) || !wp_verify_nonce($nonce, 'shorttrips_cities')) {
        wp_send_json_error(['message' => 'Invalid nonce'], 403);
    }
    $force = isset($_GET['force']) && $_GET['force'] === '1';
    $res = shorttrips_rebuild_city_cache($force);
    wp_send_json_success($res);
}

// Lichtgewicht front-end trigger via query param (zonder UI impact)
add_action('init', function () {
    if (!isset($_GET['shorttrips_refresh_cities'])) {
        return;
    }
    $nonce = $_GET['_wpnonce'] ?? '';
    if (empty($nonce) || !wp_verify_nonce($nonce, 'shorttrips_cities')) {
        status_header(403);
        exit('Invalid nonce');
    }
    $force = isset($_GET['force']) && $_GET['force'] === '1';
    $res = shorttrips_rebuild_city_cache($force);
    header('Content-Type: application/json; charset=utf-8');
    echo shorttrips_safe_json_encode($res);
    exit;
});

if (!function_exists('shorttrips_register_sync_exception_handler')) {
    function shorttrips_register_sync_exception_handler(): void
    {
        if (defined('SHORTTRIPS_SYNC_EXCEPTION_HANDLER')) {
            return;
        }
        define('SHORTTRIPS_SYNC_EXCEPTION_HANDLER', true);
        $renderPayload = static function (array $payload, string $format): void {
            if ($format === 'json') {
                if (!headers_sent()) {
                    header('Content-Type: application/json; charset=utf-8');
                }
                echo shorttrips_safe_json_encode($payload);
            } else {
                if (!headers_sent()) {
                    header('Content-Type: text/plain; charset=utf-8');
                }
                echo "‚ùå Fatal error: {$payload['message']} ({$payload['file']}:{$payload['line']})\n";
            }
        };

        set_exception_handler(static function (Throwable $e) use ($renderPayload): void {
            $format = $_GET['format'] ?? 'text';
            $payload = [
                'error' => true,
                'message' => $e->getMessage(),
                'exception' => get_class($e),
                'file' => $e->getFile(),
                'line' => $e->getLine(),
                'trace_id' => uniqid('sts_', true),
            ];
            error_log(sprintf('[Shorttrips Sync Fatal] %s in %s on line %d', $e->getMessage(), $e->getFile(), $e->getLine()));
            $renderPayload($payload, $format);
            exit;
        });

        register_shutdown_function(static function () use ($renderPayload): void {
            $error = error_get_last();
            if (!$error) {
                return;
            }
            $fatalTypes = [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR, E_USER_ERROR];
            if (!in_array($error['type'], $fatalTypes, true)) {
                return;
            }
            $format = $_GET['format'] ?? 'text';
            $payload = [
                'error' => true,
                'message' => $error['message'],
                'file' => $error['file'],
                'line' => $error['line'],
                'trace_id' => uniqid('sts_shutdown_', true),
            ];
            error_log(sprintf('[Shorttrips Sync Fatal Shutdown] %s in %s on line %d', $error['message'], $error['file'], $error['line']));
            $renderPayload($payload, $format);
        });
    }
}

if (!function_exists('shorttrips_safe_json_encode')) {
    /**
     * Safely encode data as JSON without bailing on invalid UTF-8 coming from API/database.
     */
    function shorttrips_safe_json_encode($data, int $options = 0, int $depth = 512): string
    {
        $defaults = JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES;
        if (defined('JSON_INVALID_UTF8_SUBSTITUTE')) {
            $defaults |= JSON_INVALID_UTF8_SUBSTITUTE;
        }
        if (defined('JSON_PARTIAL_OUTPUT_ON_ERROR')) {
            $defaults |= JSON_PARTIAL_OUTPUT_ON_ERROR;
        }
        $options = $options ? ($options | $defaults) : $defaults;
        $encoder = function_exists('wp_json_encode') ? 'wp_json_encode' : 'json_encode';
        $json = $encoder($data, $options, $depth);
        if ($json === false || $json === null) {
            $fallback = [
                'error' => true,
                'message' => 'JSON encoding failed',
                'code' => function_exists('json_last_error') ? json_last_error() : null,
                'error_message' => function_exists('json_last_error_msg') ? json_last_error_msg() : null,
            ];
            $json = $encoder($fallback, $options, $depth);
        }
        return (string) $json;
    }
}

if (!function_exists('shorttrips_wpdb_replace_retry')) {
    /**
     * Wrapper around $wpdb->replace with automatic retry on deadlocks.
     */
    function shorttrips_wpdb_replace_retry(string $table, array $data, $format = null, int $maxAttempts = 4): bool
    {
        global $wpdb;
        $attempt = 0;
        $delayUs = 200000; // 200ms back-off

        do {
            $attempt++;
            $result = $wpdb->replace($table, $data, $format);
            $error = $wpdb->last_error ?? '';

            if ($result !== false && $error === '') {
                return true;
            }

            $isDeadlock = stripos($error, 'deadlock') !== false;
            if (!$isDeadlock || $attempt >= $maxAttempts) {
                if ($isDeadlock) {
                    error_log(sprintf('[Shorttrips Sync] Deadlock on %s (attempt %d/%d) ‚Äì giving up: %s', $table, $attempt, $maxAttempts, $error));
                }
                return $result !== false;
            }

            error_log(sprintf('[Shorttrips Sync] Deadlock on %s (attempt %d/%d) ‚Äì retrying after %dms', $table, $attempt, $maxAttempts, (int) ($delayUs / 1000)));
            usleep($delayUs);
            $delayUs = min($delayUs * 2, 2000000); // cap at 2 seconds
        } while (true);
    }
}

if (!defined('SHORTTRIPS_SQL_NULL_SENTINEL')) {
    define('SHORTTRIPS_SQL_NULL_SENTINEL', '__SHORTTRIPS_NULL__');
}

if (!function_exists('shorttrips_wpdb_insert_on_duplicate')) {
    /**
     * INSERT ... ON DUPLICATE KEY UPDATE with retry/backoff on deadlocks.
     *
     * @param string $table
     * @param array  $data          Column => value map
     * @param array  $formats       Column => format map (%d / %s), defaults to %s
     * @param array  $updateClauses Array of "column = expression" strings
     * @param int    $maxAttempts
     */
    function shorttrips_wpdb_insert_on_duplicate(string $table, array $data, array $formats, array $updateClauses, int $maxAttempts = 4): bool
    {
        global $wpdb;

        if (empty($data) || empty($updateClauses)) {
            return false;
        }

        $columns = array_keys($data);
        $placeholders = [];
        $values = [];
        foreach ($columns as $column) {
            $fmt = $formats[$column] ?? '%s';
            $placeholders[] = $fmt;
            $value = $data[$column];

            if (is_bool($value)) {
                $value = $value ? 1 : 0;
            } elseif ($value !== null && !is_scalar($value)) {
                $value = wp_json_encode($value);
            }

            $values[] = ($value === null) ? SHORTTRIPS_SQL_NULL_SENTINEL : $value;
        }

        $insertSql = sprintf(
            "INSERT INTO `%s` (`%s`) VALUES (%s)",
            $table,
            implode('`,`', $columns),
            implode(',', $placeholders)
        );
        $fullSql = $insertSql . ' ON DUPLICATE KEY UPDATE ' . implode(', ', $updateClauses);

        $attempt = 0;
        $delayUs = 200000;

        do {
            $attempt++;
            $prepared = $wpdb->prepare($fullSql, $values);
            if ($prepared === false) {
                return false;
            }
            $prepared = str_replace("'" . SHORTTRIPS_SQL_NULL_SENTINEL . "'", 'NULL', $prepared);
            $result = $wpdb->query($prepared);
            $error = $wpdb->last_error ?? '';

            if ($result !== false && $error === '') {
                return true;
            }

            $isDeadlock = stripos($error, 'deadlock') !== false;
            if (!$isDeadlock || $attempt >= $maxAttempts) {
                if ($error !== '') {
                    error_log(sprintf('[Shorttrips Sync] SQL upsert failed on %s (attempt %d/%d): %s', $table, $attempt, $maxAttempts, $error));
                }
                return $result !== false;
            }

            error_log(sprintf('[Shorttrips Sync] Deadlock on %s (attempt %d/%d) ‚Äì retrying after %dms', $table, $attempt, $maxAttempts, (int) ($delayUs / 1000)));
            usleep($delayUs);
            $delayUs = min($delayUs * 2, 2000000);
        } while (true);
    }
}

if (!function_exists('shorttrips_get_hotels_page_url')) {
    function shorttrips_get_hotels_page_url()
    {
        $manualUrl = trim(get_option('shorttrips_hotels_page_url'));
        if (!empty($manualUrl)) {
            return trailingslashit($manualUrl);
        }

        $pageId = (int) get_option('shorttrips_hotels_page_id');
        if ($pageId > 0) {
            $permalink = get_permalink($pageId);
            if ($permalink) {
                return trailingslashit($permalink);
            }
        }

        $page = get_page_by_path('hotels');
        if ($page) {
            return trailingslashit(get_permalink($page->ID));
        }

        $pageByTitle = get_page_by_title('Hotels');
        if ($pageByTitle) {
            return trailingslashit(get_permalink($pageByTitle->ID));
        }

        $fallback = trailingslashit(home_url('/hotels/'));
        if ($fallback === trailingslashit(home_url('/'))) {
            $fallback = trailingslashit(home_url()) . 'hotels/';
        }

        return $fallback;
    }
}

// =============================================================================
// ULTRA-EARLY HANDLER - Runs BEFORE WordPress loads templates
// =============================================================================
// Intercept sync AND nonce generation requests immediately

// NONCE GENERATOR - With login check
if (isset($_GET['get_hotel_sync_nonce']) && $_GET['get_hotel_sync_nonce'] === '1') {
    // Load WordPress if needed
    if (!function_exists('is_user_logged_in')) {
        $wp_load = dirname(__FILE__) . '/../../../wp-load.php';
        if (file_exists($wp_load)) {
            require_once($wp_load);
        }
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        nocache_headers();
        status_header(403);
        exit('‚ùå Not allowed - Please log in as WordPress admin first');
    }

    if (!headers_sent()) {
        nocache_headers();
    }
    header('Content-Type: text/plain; charset=utf-8');
    $nonce = wp_create_nonce('shorttrips_sync');
    $currentBatch = get_option('shorttrips_sync_next_batch', 1);
    global $wpdb;
    $hotelCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_bravo_hotels");

    echo "================================================================================\n";
    echo "‚úÖ HOTEL SYNC NONCE GENERATED\n";
    echo "================================================================================\n\n";
    echo "üîë Your Nonce: $nonce\n\n";
    echo "üìä Hotels in database: $hotelCount\n";
    echo "üìä Next batch: $currentBatch\n\n";
    echo "================================================================================\n";
    echo "üöÄ CLICK ONE OF THESE LINKS:\n";
    echo "================================================================================\n\n";
    echo "‚ñ∂Ô∏è  AUTOMATIC RUNNER (Recommended):\n";
    echo home_url('/?sync_static_hotels=1&auto=1&_wpnonce=' . $nonce) . "\n\n";
    echo "‚ñ∂Ô∏è  Resume from batch $currentBatch:\n";
    echo home_url('/?sync_static_hotels=' . $currentBatch . '&auto=1&_wpnonce=' . $nonce) . "\n\n";
    echo "üí° Nonce is valid for 24 hours\n";
    exit;
}

// SYNC HANDLER ‚Äì intercept sync_static_hotels requests early (after WordPress is fully loaded)
add_action('init', function () {
    if (!isset($_GET['sync_static_hotels']) || defined('SHORTTRIPS_SYNC_INTERCEPTED')) {
        return;
    }
    define('SHORTTRIPS_SYNC_INTERCEPTED', true);
    if (function_exists('shorttrips_register_sync_exception_handler')) {
        shorttrips_register_sync_exception_handler();
    }

    // Allow CLI / internal calls (no HTTP_HOST) zonder browser-auth/nonce
    $sapi = php_sapi_name();
    $isCli = ($sapi === 'cli') || ($sapi === 'phpdbg') || (defined('WP_CLI') && WP_CLI) || empty($_SERVER['HTTP_HOST']);
    if ($isCli) {
        if (empty($_SERVER['HTTP_HOST'])) {
            $_SERVER['HTTP_HOST'] = parse_url(home_url(), PHP_URL_HOST) ?: 'localhost';
        }
        if (empty($_SERVER['REQUEST_URI'])) {
            $_SERVER['REQUEST_URI'] = '/';
        }
        return;
    }

    // Check authentication (now safe: pluggable functions are loaded on init)
    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        nocache_headers();
        status_header(403);
        exit('‚ùå Not allowed - Please log in as WordPress admin first');
    }

    // Check nonce
    $nonce = isset($_GET['_wpnonce']) ? $_GET['_wpnonce'] : '';
    if (empty($nonce) || !wp_verify_nonce($nonce, 'shorttrips_sync')) {
        nocache_headers();
        status_header(403);
        echo '‚ùå Invalid or expired nonce!' . "\n\n";
        echo 'üîë Generate a new nonce here:' . "\n";
        echo home_url('/?quick_nonce=1') . "\n";
        exit;
    }

    // Authentication passed ‚Äì the heavy sync logic itself runs later in de file,
    // maar template loading is al verhinderd door deze vroege exit indien nodig.
});

// =============================================================================
// TEMPORARY: Hotel Sync Nonce Generator
// =============================================================================
// URL: https://www.shorttrips.eu/?get_hotel_sync_nonce=1
// After getting nonce, you can REMOVE this code block
// =============================================================================
add_action('init', function () {
    // Quick nonce generator (bypass login check if coming from specific IP)
    if (isset($_GET['quick_nonce']) && $_GET['quick_nonce'] === '1') {
        if (!headers_sent()) {
            nocache_headers();
            header('Content-Type: text/plain; charset=utf-8');
        }
        $nonce = wp_create_nonce('shorttrips_sync');

        // Check current batch from database
        $currentBatch = get_option('shorttrips_sync_next_batch', 1);

        echo "Your nonce: $nonce\n\n";
        echo "=== SYNC URLs ===\n\n";
        echo "Start from beginning:\n";
        echo home_url('/?sync_static_hotels=1&auto=1&_wpnonce=' . $nonce) . "\n\n";
        echo "Resume from batch $currentBatch:\n";
        echo home_url('/?sync_static_hotels=' . $currentBatch . '&auto=1&_wpnonce=' . $nonce) . "\n\n";
        echo "Start from custom batch (replace NNN):\n";
        echo home_url('/?sync_static_hotels=NNN&auto=1&_wpnonce=' . $nonce) . "\n\n";
        echo "Reset & start over:\n";
        echo home_url('/?sync_static_hotels=1&reset=1&auto=1&_wpnonce=' . $nonce) . "\n";
        exit;
    }

    if (isset($_GET['get_hotel_sync_nonce']) && $_GET['get_hotel_sync_nonce'] === '1') {
        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            status_header(403);
            die('‚ùå Not allowed - Please log in as WordPress admin first');
        }

        nocache_headers();
        header('Content-Type: text/plain; charset=utf-8');

        $nonce = wp_create_nonce('shorttrips_sync');
        $syncUrl = home_url('/?sync_static_hotels=1&_wpnonce=' . $nonce);
        $autoUrl = home_url('/?sync_static_hotels=1&auto=1&_wpnonce=' . $nonce);

        echo "================================================================================\n";
        echo "‚úÖ HOTEL SYNC NONCE GENERATED\n";
        echo "================================================================================\n\n";
        echo "üîë Your Nonce: $nonce\n\n";
        echo "================================================================================\n";
        echo "üìä CURRENT STATUS:\n";
        echo "================================================================================\n\n";

        global $wpdb;
        $hotelCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_bravo_hotels");
        $nextBatch = get_option('shorttrips_sync_next_batch', 1);

        echo "Hotels in database: $hotelCount\n";
        echo "Next batch number: $nextBatch\n\n";

        echo "================================================================================\n";
        echo "üöÄ HOW TO USE:\n";
        echo "================================================================================\n\n";

        echo "OPTION 1: Manual Batch Sync\n";
        echo "----------------------------\n";
        echo "Run specific batch:\n";
        echo "$syncUrl&sync_static_hotels=1\n\n";

        echo "OPTION 2: Automatic Runner (RECOMMENDED)\n";
        echo "-----------------------------------------\n";
        echo "Runs all batches automatically:\n";
        echo "$autoUrl\n\n";

        echo "OPTION 3: Reset and Start Over\n";
        echo "-------------------------------\n";
        echo "Reset to batch 1:\n";
        echo home_url('/?sync_static_hotels=1&reset=1&_wpnonce=' . $nonce) . "\n\n";

        echo "================================================================================\n";
        echo "üí° TIPS:\n";
        echo "================================================================================\n\n";
        echo "- Use OPTION 2 (auto runner) for easiest experience\n";
        echo "- Nonce is valid for 24 hours\n";
        echo "- After sync, REMOVE the nonce generator code from functions.php\n";
        echo "- Current hotels: $hotelCount (you had 59,207 yesterday)\n\n";

        echo "================================================================================\n";
        exit;
    }
}, 1);

// =============================================================================
// ADMIN MENU: ShortTrips Sync Dashboard
// =============================================================================
add_action('admin_menu', function () {
    add_menu_page(
        'ShortTrips Sync',           // Page title
        'ShortTrips Sync',           // Menu title
        'manage_options',            // Capability
        'shorttrips-sync',           // Menu slug
        'shorttrips_sync_dashboard', // Callback function
        'dashicons-update',          // Icon
        30                           // Position
    );
});

// Submenu: Freestays Price Comparison (Google Custom Search)
add_action('admin_menu', function () {
    add_submenu_page(
        'shorttrips-sync',
        'Freestays Comparison',
        'Freestays Comparison',
        'manage_options',
        'freestays-comparison',
        'freestays_comparison_admin_page'
    );
});

/**
 * Admin page to configure competitor price comparison (Google Custom Search API).
 *
 * NOTE: Actual cron/price lookup logic is defined in specs and will be implemented later.
 * This page only manages basic toggles and shows API status.
 */
function freestays_comparison_admin_page()
{
    if (!current_user_can('manage_options')) {
        wp_die('Unauthorized');
    }
    global $wpdb;

    // Handle form submit
    $message = '';
    $testOutput = '';
    if (!empty($_POST['freestays_comparison_submitted'])) {
        check_admin_referer('freestays_comparison_save', 'freestays_comparison_nonce');

        $enabled = !empty($_POST['freestays_show_competitor_prices_google']) ? '1' : '0';
        update_option('freestays_show_competitor_prices_google', $enabled);

        $ttl = isset($_POST['freestays_competitor_ttl_hours']) ? (int) $_POST['freestays_competitor_ttl_hours'] : 24;
        if ($ttl < 1) {
            $ttl = 1;
        }
        if ($ttl > 72) {
            $ttl = 72;
        }
        update_option('freestays_competitor_ttl_hours', $ttl);

        $maxQueue = isset($_POST['freestays_competitor_max_queue_per_run']) ? (int) $_POST['freestays_competitor_max_queue_per_run'] : 20;
        if ($maxQueue < 1) {
            $maxQueue = 1;
        }
        if ($maxQueue > 100) {
            $maxQueue = 100;
        }
        update_option('freestays_competitor_max_queue_per_run', $maxQueue);

        // (De)activeer cron-event op basis van toggle
        if ($enabled === '1') {
            if (!wp_next_scheduled('freestays_competitor_cron')) {
                // Start over 5 minuten, daarna volgens standaard interval (hourly)
                wp_schedule_event(time() + 5 * 60, 'hourly', 'freestays_competitor_cron');
            }
        } else {
            // Verwijder alle geplande events voor deze hook
            wp_clear_scheduled_hook('freestays_competitor_cron');
        }

        $message = 'Instellingen opgeslagen.';
    }

    // Handle test query submit
    if (!empty($_POST['freestays_comparison_test_submitted'])) {
        check_admin_referer('freestays_comparison_test', 'freestays_comparison_test_nonce');
        $testQuery = isset($_POST['freestays_comparison_test_query']) ? sanitize_text_field(wp_unslash($_POST['freestays_comparison_test_query'])) : '';
        if ($testQuery !== '') {
            $results = freestays_gcs_search($testQuery, 10);
            if (is_wp_error($results)) {
                $testOutput = '<p style="color:#dc2626;font-weight:600;">Fout bij Google Custom Search: ' . esc_html($results->get_error_message()) . '</p>';
            } else {
                $best = freestays_gcs_extract_lowest_price($results);
                if ($best === null) {
                    $testOutput = '<p style="color:#b91c1c;">Geen prijs gevonden in de eerste resultaten voor deze zoekopdracht.</p>';
                } else {
                    $testOutput = '<p><strong>Laagste gevonden prijs:</strong> ‚Ç¨' . esc_html(number_format($best['price_total'], 2, ',', '.')) . ' (' . esc_html($best['provider']) . ')</p>';
                    if (!empty($best['deeplink'])) {
                        $testOutput .= '<p><a href="' . esc_url($best['deeplink']) . '" target="_blank" rel="noopener noreferrer">Open resultaat in nieuw tabblad</a></p>';
                    }
                    if (!empty($best['snippet'])) {
                        $testOutput .= '<p style="font-size:12px;color:#4b5563;"><strong>Snippet:</strong> ' . esc_html($best['snippet']) . '</p>';
                    }
                }
            }
        } else {
            $testOutput = '<p style="color:#b91c1c;">Voer eerst een zoekterm in.</p>';
        }
    }

    // Current values
    $enabled = get_option('freestays_show_competitor_prices_google', '0');
    $ttl = (int) get_option('freestays_competitor_ttl_hours', 24);
    $maxQueue = (int) get_option('freestays_competitor_max_queue_per_run', 20);

    // Handle manual queue processing
    $processSummary = null;
    if (!empty($_POST['freestays_comparison_run_queue'])) {
        check_admin_referer('freestays_comparison_run_queue', 'freestays_comparison_run_queue_nonce');
        $limit = isset($_POST['freestays_comparison_run_queue_limit']) ? (int) $_POST['freestays_comparison_run_queue_limit'] : null;
        $processSummary = freestays_competitor_process_queue($limit);
    }

    // API status
    $apiKeyDefined = defined('FREESTAYS_GCS_API_KEY') && FREESTAYS_GCS_API_KEY !== '';
    $cxDefined = defined('FREESTAYS_GCS_CX') && FREESTAYS_GCS_CX !== '';

    $apiKeyMasked = '';
    if ($apiKeyDefined) {
        $raw = FREESTAYS_GCS_API_KEY;
        $len = strlen($raw);
        if ($len <= 8) {
            $apiKeyMasked = str_repeat('‚Ä¢', $len);
        } else {
            $apiKeyMasked = substr($raw, 0, 4) . str_repeat('‚Ä¢', max(0, $len - 8)) . substr($raw, -4);
        }
    }

    ?>
    <div class="wrap">
        <h1>Freestays Comparison ‚Äì Google Custom Search</h1>

        <?php if ($message): ?>
            <div id="message" class="updated notice is-dismissible">
                <p><?php echo esc_html($message); ?></p>
            </div>
        <?php endif; ?>

        <div class="card" style="max-width: 900px; margin-top: 20px;">
            <h2>üîå API status</h2>
            <table class="widefat" style="margin-top:10px;">
                <tbody>
                    <tr>
                        <td style="width:220px;"><strong>API key constant</strong></td>
                        <td>
                            <?php
                            if ($apiKeyDefined) {
                                echo '<span style="color:#16a34a;font-weight:600;">Gevonden</span> ';
                                echo '<code>' . esc_html($apiKeyMasked) . '</code>';
                            } else {
                                echo '<span style="color:#dc2626;font-weight:600;">NIET gevonden</span> ‚Äì voeg <code>FREESTAYS_GCS_API_KEY</code> toe in <code>wp-config.php</code>.';
                            }
                            ?>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Search Engine ID (CX)</strong></td>
                        <td>
                            <?php
                            if ($cxDefined) {
                                echo '<span style="color:#16a34a;font-weight:600;">Gevonden</span> ';
                                echo '<code>' . esc_html(FREESTAYS_GCS_CX) . '</code>';
                            } else {
                                echo '<span style="color:#dc2626;font-weight:600;">NIET gevonden</span> ‚Äì voeg <code>FREESTAYS_GCS_CX</code> toe in <code>wp-config.php</code>.';
                            }
                            ?>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p style="margin-top:10px;color:#4b5563;">
                Deze gegevens komen direct uit <code>wp-config.php</code>. De echte API key wordt hier alleen gemaskeerd
                getoond.
            </p>
        </div>

        <form method="post" action="">
            <?php wp_nonce_field('freestays_comparison_save', 'freestays_comparison_nonce'); ?>
            <input type="hidden" name="freestays_comparison_submitted" value="1" />

            <div class="card" style="max-width: 900px; margin-top: 20px;">
                <h2>‚öôÔ∏è Basisinstellingen</h2>
                <table class="form-table">
                    <tr>
                        <th scope="row">
                            <label for="freestays_show_competitor_prices_google">Prijsvergelijking inschakelen</label>
                        </th>
                        <td>
                            <label>
                                <input type="checkbox" name="freestays_show_competitor_prices_google"
                                    id="freestays_show_competitor_prices_google" value="1" <?php checked($enabled, '1'); ?> />
                                Toon extra prijsregel onder eigen prijs in prebook (indien data beschikbaar).
                            </label>
                            <p class="description">
                                Wanneer dit is ingeschakeld, zal de toekomstige cron Google Custom Search gebruiken om
                                indicatieve prijzen bij andere aanbieders op te halen.
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="freestays_competitor_ttl_hours">Maximale leeftijd van prijsdata (uren)</label>
                        </th>
                        <td>
                            <input type="number" name="freestays_competitor_ttl_hours" id="freestays_competitor_ttl_hours"
                                value="<?php echo esc_attr($ttl); ?>" min="1" max="72" />
                            <p class="description">Na deze tijd zal een nieuwe Google‚Äëquery worden ingepland. Aanbevolen: 24
                                uur.</p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="freestays_competitor_max_queue_per_run">Max. queue‚Äëitems per cron‚Äërun</label>
                        </th>
                        <td>
                            <input type="number" name="freestays_competitor_max_queue_per_run"
                                id="freestays_competitor_max_queue_per_run" value="<?php echo esc_attr($maxQueue); ?>"
                                min="1" max="100" />
                            <p class="description">Beperk het aantal Google‚Äëqueries per run om binnen het dagquotum te
                                blijven.</p>
                        </td>
                    </tr>
                </table>

                <p>
                    <button type="submit" class="button button-primary">Instellingen opslaan</button>
                </p>
            </div>
        </form>

        <form method="post" action="" style="margin-top:20px;">
            <?php wp_nonce_field('freestays_comparison_test', 'freestays_comparison_test_nonce'); ?>
            <input type="hidden" name="freestays_comparison_test_submitted" value="1" />

            <div class="card" style="max-width: 900px; margin-top: 10px;">
                <h2>üß™ Test Google Custom Search query</h2>
                <p>Gebruik dit om te testen of de Google API goed werkt en of er prijzen uit snippets gedetecteerd worden.
                </p>
                <table class="form-table">
                    <tr>
                        <th scope="row">
                            <label for="freestays_comparison_test_query">Zoekopdracht</label>
                        </th>
                        <td>
                            <input type="text" name="freestays_comparison_test_query" id="freestays_comparison_test_query"
                                class="regular-text" placeholder="Bijv. Alaaddin Beach Hotel Adults Only prijzen Alanya"
                                value="<?php echo isset($_POST['freestays_comparison_test_query']) ? esc_attr(wp_unslash($_POST['freestays_comparison_test_query'])) : ''; ?>" />
                            <p class="description">
                                Tip: neem hotelnaam + plaats + woorden als "prijzen", "hotel", eventueel data. De API zoekt
                                maximaal in de eerste 10 resultaten.
                            </p>
                        </td>
                    </tr>
                </table>

                <p>
                    <button type="submit" class="button">Test zoekopdracht</button>
                </p>

                <?php
                if ($testOutput) {
                    echo '<div style="margin-top:10px;padding:10px 12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;">' . $testOutput . '</div>';
                }
                ?>
            </div>
        </form>

        <div class="card" style="max-width: 900px; margin-top: 20px;">
            <h2>üìò Opmerking</h2>
            <p style="color:#4b5563;">
                Dit scherm configureert de basisinstellingen en biedt een test voor Google Custom Search.
                De cron/queue‚Äëverwerking kan hieronder handmatig gestart worden voor debugging. Volledige
                automatische integratie in prebook gebeurt volgens het plan in
                <code>FREESTAYS-COMPETITOR-PRICES-GOOGLE-CSE.md</code>.
            </p>
        </div>

        <form method="post" action="" style="margin-top:20px;">
            <?php wp_nonce_field('freestays_comparison_run_queue', 'freestays_comparison_run_queue_nonce'); ?>
            <input type="hidden" name="freestays_comparison_run_queue" value="1" />

            <div class="card" style="max-width: 900px; margin-top: 10px;">
                <h2>‚öôÔ∏è Handmatig queue verwerken (Google prijsvergelijking)</h2>
                <p>Gebruik dit om pending queue‚Äëitems direct te verwerken via Google Custom Search.</p>
                <table class="form-table">
                    <tr>
                        <th scope="row">
                            <label for="freestays_comparison_run_queue_limit">Max. items in deze run</label>
                        </th>
                        <td>
                            <input type="number" name="freestays_comparison_run_queue_limit"
                                id="freestays_comparison_run_queue_limit" value="" min="1" max="100" />
                            <p class="description">
                                Leeg laten om de standaard max per run te gebruiken
                                (<?php echo (int) $maxQueue; ?> items).
                            </p>
                        </td>
                    </tr>
                </table>

                <p>
                    <button type="submit" class="button button-secondary"
                        onclick="return confirm('Queue nu verwerken via Google Custom Search? Dit kan API‚Äëquota gebruiken.');">
                        Queue nu verwerken
                    </button>
                </p>

                <?php
                if (is_array($processSummary)) {
                    echo '<div style="margin-top:10px;padding:10px 12px;background:#ecfdf3;border:1px solid #bbf7d0;border-radius:6px;">';
                    echo '<p style="margin:0;color:#166534;">Verwerking voltooid: ';
                    echo 'items: <strong>' . (int) $processSummary['processed'] . '</strong>, ';
                    echo 'successen: <strong>' . (int) $processSummary['success'] . '</strong>, ';
                    echo 'fouten: <strong>' . (int) $processSummary['errors'] . '</strong>.';
                    echo '</p></div>';
                }

                // Toon recente queue-status + foutdetails
                $queueTable = $wpdb->prefix . 'fs_competitor_queue';
                $pricesTable = $wpdb->prefix . 'fs_competitor_prices';
                $stats = [
                    'pending' => 0,
                    'processing' => 0,
                    'done' => 0,
                    'error' => 0,
                ];
                $rowsStats = $wpdb->get_results("SELECT status, COUNT(*) as cnt FROM {$queueTable} GROUP BY status", ARRAY_A);
                if ($rowsStats) {
                    foreach ($rowsStats as $rowS) {
                        $st = $rowS['status'];
                        $cnt = (int) $rowS['cnt'];
                        if (isset($stats[$st])) {
                            $stats[$st] = $cnt;
                        }
                    }
                }

                echo '<div style="margin-top:15px;padding:10px 12px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;">';
                echo '<p style="margin:0 0 6px 0;font-weight:600;color:#111827;">Queue status:</p>';
                echo '<ul style="margin:0;padding-left:18px;font-size:12px;color:#4b5563;">';
                echo '<li>Pending: <strong>' . (int) $stats['pending'] . '</strong></li>';
                echo '<li>Processing: <strong>' . (int) $stats['processing'] . '</strong></li>';
                echo '<li>Done: <strong>' . (int) $stats['done'] . '</strong></li>';
                echo '<li>Errors: <strong>' . (int) $stats['error'] . '</strong></li>';
                echo '</ul>';

                // Laat laatste 5 fouten zien
                $errorRows = $wpdb->get_results(
                    "SELECT hotel_id, checkin, checkout, last_error, updated_at
                     FROM {$queueTable}
                     WHERE status = 'error'
                     ORDER BY updated_at DESC
                     LIMIT 5",
                    ARRAY_A
                );
                if ($errorRows) {
                    echo '<p style="margin:8px 0 4px 0;font-weight:600;color:#b91c1c;">Laatste fouten:</p>';
                    echo '<ul style="margin:0;padding-left:18px;font-size:11px;color:#7f1d1d;">';
                    foreach ($errorRows as $er) {
                        $label = 'Hotel ' . (int) $er['hotel_id'] . ' (' . esc_html($er['checkin']) . '‚Äì' . esc_html($er['checkout']) . ')';
                        $err = mb_substr((string) $er['last_error'], 0, 140);
                        $date = esc_html($er['updated_at']);
                        echo '<li><strong>' . $label . '</strong><br><span>' . esc_html($err) . '</span><br><span style="color:#9ca3af;">' . $date . '</span></li>';
                    }
                    echo '</ul>';
                }

                // Laat laatste 5 succesvolle prijsresultaten zien (uit prices-table)
                $doneRows = $wpdb->get_results(
                    "SELECT p.hotel_id, p.checkin, p.checkout, p.provider, p.price_total, p.currency, p.fetched_at
                     FROM {$pricesTable} p
                     ORDER BY p.fetched_at DESC
                     LIMIT 5",
                    ARRAY_A
                );
                if ($doneRows) {
                    echo '<p style="margin:10px 0 4px 0;font-weight:600;color:#065f46;">Laatste succesvolle prijsresultaten:</p>';
                    echo '<ul style="margin:0;padding-left:18px;font-size:11px;color:#065f46;">';
                    foreach ($doneRows as $dr) {
                        $label = 'Hotel ' . (int) $dr['hotel_id'] . ' (' . esc_html($dr['checkin']) . '‚Äì' . esc_html($dr['checkout']) . ')';
                        $amount = number_format((float) $dr['price_total'], 2, ',', '.');
                        $provider = esc_html($dr['provider']);
                        $date = esc_html($dr['fetched_at']);
                        echo '<li><strong>' . $label . '</strong><br>';
                        echo '‚Ç¨' . $amount . ' ' . esc_html($dr['currency']) . ' via ' . $provider . '<br>';
                        echo '<span style="color:#9ca3af;">' . $date . '</span></li>';
                    }
                    echo '</ul>';
                }

                echo '</div>';
                ?>
            </div>
        </form>
    </div>
    <?php
}

function shorttrips_sync_dashboard()
{
    if (!current_user_can('manage_options')) {
        wp_die('Unauthorized');
    }

    global $wpdb;

    // Get current stats
    $hotelCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_bravo_hotels");
    $roomTypesCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_room_types");
    $hotelsWithRooms = $wpdb->get_var("SELECT COUNT(DISTINCT hotel_id) FROM ghwk_hotel_room_types");
    $nextBatch = get_option('shorttrips_sync_next_batch', 1);

    // Generate nonce
    $nonce = wp_create_nonce('shorttrips_sync');

    $inlineFilters = shorttrips_render_filters_widget('inline');
    ?>
    <div class="wrap">
        <h1>üöÄ ShortTrips Sync Dashboard</h1>

        <div class="card" style="max-width: 800px; margin-top: 20px;">
            <h2>üìä Current Status</h2>
            <table class="widefat" style="margin-top: 10px;">
                <tbody>
                    <tr>
                        <td><strong>Hotels in Database</strong></td>
                        <td><?php echo number_format($hotelCount); ?></td>
                    </tr>
                    <tr>
                        <td><strong>Room Types with Images</strong></td>
                        <td><?php echo number_format($roomTypesCount); ?></td>
                    </tr>
                    <tr>
                        <td><strong>Hotels with Room Images</strong></td>
                        <td><?php echo number_format($hotelsWithRooms); ?> / <?php echo number_format($hotelCount); ?></td>
                    </tr>
                    <tr>
                        <td><strong>Next Batch to Sync</strong></td>
                        <td>Batch #<?php echo $nextBatch; ?></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="card" style="max-width: 800px; margin-top: 20px;">
            <h2>üîÑ Start Hotel Sync (with Room Images)</h2>
            <p><strong>‚ö†Ô∏è Important:</strong> Open these links in a <strong>NEW TAB</strong> to see the sync progress.</p>

            <h3>Option 1: Automatic Runner (Recommended)</h3>
            <p>Automatically syncs all batches one by one:</p>
            <p>
                <a href="<?php echo home_url('/?sync_static_hotels=1&auto=1&_wpnonce=' . $nonce); ?>"
                    class="button button-primary button-large" target="_blank" style="font-size: 16px; padding: 10px 20px;">
                    ‚ñ∂Ô∏è Start Auto Sync (All Batches)
                </a>
            </p>

            <h3>Option 2: Single Batch Sync</h3>
            <p>Sync one batch at a time (100 destinations per batch):</p>
            <p>
                <a href="<?php echo home_url('/?sync_static_hotels=' . $nextBatch . '&_wpnonce=' . $nonce); ?>"
                    class="button button-secondary" target="_blank">
                    üîÑ Sync Batch #<?php echo $nextBatch; ?>
                </a>
                <a href="<?php echo home_url('/?sync_static_hotels=1&_wpnonce=' . $nonce); ?>"
                    class="button button-secondary" target="_blank">
                    üîÑ Sync Batch #1
                </a>
            </p>

            <h3>Option 3: Reset & Start Over</h3>
            <p>
                <a href="<?php echo home_url('/?sync_static_hotels=1&reset=1&auto=1&_wpnonce=' . $nonce); ?>"
                    class="button button-secondary" target="_blank"
                    onclick="return confirm('Are you sure you want to reset and start from the beginning?');">
                    üîÑ Reset to Batch #1 & Auto Sync
                </a>
            </p>
        </div>

        <div class="card" style="max-width: 800px; margin-top: 20px;">
            <h2>üîë Manual Sync URLs</h2>
            <p>Copy these URLs if you want to run sync via command line or external tool:</p>

            <h4>Auto Sync (All Batches):</h4>
            <input type="text" value="<?php echo esc_attr(home_url('/?sync_static_hotels=1&auto=1&_wpnonce=' . $nonce)); ?>"
                style="width: 100%; font-family: monospace; padding: 8px;" readonly onclick="this.select();">

            <h4 style="margin-top: 15px;">Single Batch Sync:</h4>
            <input type="text"
                value="<?php echo esc_attr(home_url('/?sync_static_hotels=' . $nextBatch . '&_wpnonce=' . $nonce)); ?>"
                style="width: 100%; font-family: monospace; padding: 8px;" readonly onclick="this.select();">

            <p style="margin-top: 15px;"><strong>üí° Tip:</strong> Nonce is valid for 24 hours.</p>
        </div>

        <div class="card" style="max-width: 800px; margin-top: 20px; background: #fff3cd; border-left: 4px solid #ffc107;">
            <h2>üìñ How It Works</h2>
            <ol>
                <li><strong>Click "Start Auto Sync"</strong> button above (opens in new tab)</li>
                <li><strong>Watch the progress</strong> - you'll see real-time updates</li>
                <li><strong>Wait for completion</strong> - sync runs automatically through all batches</li>
                <li><strong>Room images</strong> are now included in the sync! üéâ</li>
            </ol>

            <h3>What's New? üÜï</h3>
            <ul>
                <li>‚úÖ <strong>Room image size increased</strong> - Photos now fill the entire block</li>
                <li>‚úÖ <strong>Room images from API</strong> - Images are fetched and stored in database</li>
                <li>‚úÖ <strong>Better navigation buttons</strong> - Larger, more visible image navigation</li>
            </ul>
        </div>
    </div>

    <style>
        .wrap .card {
            padding: 20px;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .wrap .card h2 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e5e5;
        }

        .wrap .card h3 {
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .wrap .card h4 {
            margin-bottom: 5px;
            font-weight: 600;
        }
    </style>
    <?php
}

// =============================================================================
// AUTO BACKGROUND SYNC - Hotel Room Types (WP-Cron)
// =============================================================================
// üö® TEMPORARILY DISABLED - Causing performance issues

// =============================================================================
/*
add_action('init', function() {
    if (!wp_next_scheduled('auto_sync_hotel_room_types')) {
        wp_schedule_event(time(), 'hourly', 'auto_sync_hotel_room_types');
    }
});
*/

add_action('auto_sync_hotel_room_types', function () {
    // üö® DISABLED - This cron action is not called anymore
    // If you re-enable the cron scheduler above, this will work
    return;

    /* DISABLED FOR PERFORMANCE:
    global $wpdb;

    // Check if complete
    $totalHotels = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_bravo_hotels");
    $synced = $wpdb->get_var("SELECT COUNT(DISTINCT hotel_id) FROM ghwk_hotel_room_types");

    if ($synced >= $totalHotels) {
        return; // Already complete!
    }

    // Get current offset
    $offset = get_option('hotel_room_types_sync_offset', 0);
    $limit = 100;

    // Trigger sync via internal request (non-blocking)
    $syncUrl = home_url('/?sync_hotel_room_types=1&limit=' . $limit . '&offset=' . $offset . '&cron=1');

    wp_remote_get($syncUrl, [
        'timeout' => 0.01,
        'blocking' => false,
        'sslverify' => false
    ]);

    // Update offset for next run
    update_option('hotel_room_types_sync_offset', $offset + $limit);*/
});

// üö® DEBUG LOGGING DISABLED FOR PERFORMANCE
// Force debug logging FIRST
if (!defined('WP_DEBUG_LOG')) {
    define('WP_DEBUG_LOG', false); // Changed to false
}
if (!defined('WP_DEBUG')) {
    define('WP_DEBUG', false); // Changed to false
}
if (!defined('WP_DEBUG_DISPLAY')) {
    define('WP_DEBUG_DISPLAY', false);
}

// === üî• DEBUG CODE DISABLED - Was causing disk I/O on every page load ===
/*
$debug_log_path = defined('WP_CONTENT_DIR') ? WP_CONTENT_DIR . '/debug.log' : dirname(__FILE__) . '/debug.log';
// @file_put_contents($debug_log_path, "\n" . str_repeat('=', 80) . "\n", FILE_APPEND);
// @file_put_contents($debug_log_path, 'üî•üî•üî• FUNCTIONS.PHP IS LOADED AT ' . date('Y-m-d H:i:s') . ' üî•üî•üî•' . "\n", FILE_APPEND);
// @file_put_contents($debug_log_path, 'üî•üî•üî• REQUEST URI: ' . ($_SERVER['REQUEST_URI'] ?? 'N/A') . "\n", FILE_APPEND);
// @file_put_contents($debug_log_path, str_repeat('=', 80) . "\n\n", FILE_APPEND);
*/
// === END DEBUG CODE ===

// =============================================================================
// CACHE MANAGEMENT - Clear homepage destination caches
// =============================================================================
// URL: https://www.shorttrips.eu/?clear_homepage_cache=1
// Admin only - use this after hotel database updates
// =============================================================================
add_action('init', function () {
    if (isset($_GET['clear_homepage_cache']) && current_user_can('manage_options')) {
        delete_transient('shorttrips_popular_destinations_v3');
        delete_transient('shorttrips_popular_destinations_v4');
        delete_transient('shorttrips_locations_v1');

        // Clear all trending caches (all hours)
        global $wpdb;
        $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_shorttrips_trending_destinations_%'");
        $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_shorttrips_trending_destinations_%'");

        wp_die('‚úÖ Homepage destination & location caches cleared! Refresh homepage to rebuild.', 'Cache Cleared', ['response' => 200]);
    }
});

// =============================================================================
// CACHE MANAGEMENT - Clear ALL search-related caches
// =============================================================================
// URL: https://www.shorttrips.eu/?clear_all_search_cache=1
// Admin only - use this after API changes or when search isn't working
// This clears destination ID caches, resort caches, and all transients
// =============================================================================
add_action('init', function () {
    if (isset($_GET['clear_all_search_cache']) && current_user_can('manage_options')) {
        global $wpdb;

        $cleared = [];

        // 1. Clear destination ID caches (st_first_dest_*)
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_st_first_dest_%'");
        $cleared[] = "Destination ID caches: " . ($result ?: 0) . " entries";
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_st_first_dest_%'");

        // 2. Clear static hotel caches (st_static_hotel_*)
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_st_static_hotel_%'");
        $cleared[] = "Static hotel caches: " . ($result ?: 0) . " entries";
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_st_static_hotel_%'");

        // 3. Clear hotel count caches (st_hotel_count_*)
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_st_hotel_count_%'");
        $cleared[] = "Hotel count caches: " . ($result ?: 0) . " entries";
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_st_hotel_count_%'");

        // 4. Clear popular destinations caches
        delete_transient('shorttrips_popular_destinations_v3');
        delete_transient('shorttrips_popular_destinations_v4');
        delete_transient('shorttrips_locations_v1');
        $cleared[] = "Popular destinations: cleared";

        // 5. Clear trending caches
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_shorttrips_trending_destinations_%'");
        $cleared[] = "Trending destinations: " . ($result ?: 0) . " entries";
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_shorttrips_trending_destinations_%'");

        // 6. Clear any other shorttrips transients
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_shorttrips_%'");
        $cleared[] = "Other shorttrips caches: " . ($result ?: 0) . " entries";
        $result = $wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_shorttrips_%'");

        // 7. Clear WordPress object cache if available
        if (function_exists('wp_cache_flush')) {
            wp_cache_flush();
            $cleared[] = "WordPress object cache: flushed";
        }

        // Output results
        nocache_headers();
        header('Content-Type: text/plain; charset=utf-8');
        echo "================================================================================\n";
        echo "‚úÖ ALL SEARCH CACHES CLEARED!\n";
        echo "================================================================================\n\n";
        echo "üìä Cleared items:\n\n";
        foreach ($cleared as $item) {
            echo "  ‚úì " . $item . "\n";
        }
        echo "\n================================================================================\n";
        echo "üéØ What to do next:\n";
        echo "================================================================================\n\n";
        echo "1. Try searching for countries that didn't work before\n";
        echo "2. Check if hotels now appear with availability\n";
        echo "3. Look at error logs for API responses\n";
        echo "\nüí° All searches will now use fresh API calls with correct parameters\n";
        echo "üí° First searches might be slower as caches rebuild\n";
        wp_die();
    }
});

// =============================================================================
// ‚ùå DEPRECATED SHORTCODE REMOVED
// =============================================================================
// [shorttrips_search_filters] was too simple and has been removed
// Use [freestays_filters] instead - it has all features and works better
// =============================================================================

// =============================================================================
// SHORTCODE: Header Search Bar (NEW - Compact horizontal design)
// =============================================================================
// Usage: [shorttrips_header_search]
// Compact search bar for hero/banner sections
// Fields: Destination, Date, Guests, Search/Reset buttons
// =============================================================================
add_shortcode('shorttrips_header_search', function () {
    ob_start();
    ?>
    <div class="shorttrips-header-search-container">
        <form id="shorttrips-header-search-form" class="header-search-form" action="<?php echo esc_url(home_url('/')); ?>"
            method="GET">
            <input type="hidden" name="type" value="search">

            <div class="header-search-fields">
                <!-- DESTINATION -->
                <div class="header-search-field destination-field">
                    <label class="field-label">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z" />
                        </svg>
                        Destination
                    </label>
                    <input type="text" name="q" placeholder="Land, stad of hotel..." class="field-input">
                </div>

                <!-- DATE -->
                <div class="header-search-field date-field">
                    <label class="field-label">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z" />
                        </svg>
                        Datum
                    </label>
                    <input type="date" name="checkin" required value="<?php echo date('Y-m-d', strtotime('+7 days')); ?>"
                        class="field-input">
                    <span class="date-separator">tot</span>
                    <input type="date" name="checkout" required value="<?php echo date('Y-m-d', strtotime('+14 days')); ?>"
                        class="field-input">
                </div>

                <!-- GUESTS -->
                <div class="header-search-field guests-field">
                    <label class="field-label">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z" />
                        </svg>
                        Gasten
                    </label>
                    <select name="adults" class="field-input">
                        <option value="1">1 persoon</option>
                        <option value="2" selected>2 personen</option>
                        <option value="3">3 personen</option>
                        <option value="4">4 personen</option>
                        <option value="5">5 personen</option>
                        <option value="6">6 personen</option>
                    </select>
                </div>

                <!-- BUTTONS -->
                <div class="header-search-buttons">
                    <button type="submit" class="btn-search">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                        </svg>
                        Search
                    </button>
                    <button type="reset" class="btn-reset">Reset</button>
                </div>
            </div>
        </form>
    </div>

    <style>
        .shorttrips-header-search-container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding-left: clamp(8px, 4vw, 60px);
            padding-right: clamp(8px, 4vw, 60px);
        }

        .header-search-form {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .header-search-fields {
            display: grid;
            grid-template-columns: 2fr 3fr 1.5fr auto;
            gap: 20px;
            align-items: end;
        }

        .header-search-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-field {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            align-items: center;
        }

        .date-field .field-label {
            grid-column: 1 / -1;
        }

        .date-separator {
            font-size: 14px;
            color: #6b7280;
            text-align: center;
        }

        .field-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .field-label svg {
            color: #2563eb;
        }

        .field-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            color: #1f2937;
            transition: all 0.2s;
            background: white;
        }

        .field-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .field-input::placeholder {
            color: #9ca3af;
        }

        .header-search-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-search {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            white-space: nowrap;
        }

        .btn-search:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        .btn-reset {
            padding: 14px 24px;
            background: white;
            color: #6b7280;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-reset:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: #374151;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .header-search-form {
                padding: 16px;
            }

            .header-search-fields {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .destination-field {
                grid-column: 1 / -1;
            }

            .guests-field {
                grid-column: 1 / -1;
            }

            .header-search-buttons {
                grid-column: 1 / -1;
                justify-content: stretch;
            }

            .btn-search,
            .btn-reset {
                flex: 1;
            }

            .field-label {
                font-size: 13px;
            }

            .field-input {
                padding: 10px 14px;
                font-size: 14px;
            }
        }

        @media (max-width: 640px) {
            .shorttrips-header-search-container {
                padding: 0 10px;
            }

            .header-search-form {
                padding: 12px;
                border-radius: 8px;
            }

            .header-search-fields {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .date-field {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .date-separator {
                display: none;
            }

            .field-label {
                font-size: 12px;
                gap: 4px;
            }

            .field-label svg {
                width: 14px;
                height: 14px;
            }

            .field-input {
                padding: 10px 12px;
                font-size: 14px;
            }

            .btn-search,
            .btn-reset {
                padding: 12px 20px;
                font-size: 15px;
            }

            .btn-search svg {
                width: 14px;
                height: 14px;
            }
        }

        @media (max-width: 400px) {
            .header-search-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .btn-search,
            .btn-reset {
                width: 100%;
            }
        }
    </style>

    <script>
        (function () {
            const form = document.getElementById('shorttrips-header-search-form');
            if (!form) return;

            // On page load, check if we have search parameters to show results
            const urlParams = new URLSearchParams(window.location.search);
            const hasSearchParams = urlParams.has('q') || urlParams.has('checkin') || urlParams.has('country');
            if (hasSearchParams) {
                const resultsSection = document.getElementById('search-results-section');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                    setTimeout(function () {
                        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 500);
                }
            }

            form.addEventListener('submit', function (e) {
                // Just submit the form normally, it will reload the page with results
                const resultsSection = document.getElementById('search-results-section');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                }
            });

            // Reset button
            form.addEventListener('reset', function () {
                // Clear URL params and hide results
                window.location.href = window.location.pathname;
            });
        })();
    </script>

    <style>
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <?php
    return ob_get_clean();
});

// =============================================================================
// SHORTCODE: Hotel Search Form (standalone)
// =============================================================================
// Usage: [shorttrips_search_form]
// Shows only the search form (without results container)
// Perfect for placing on any page (like bestemmingen/destinations page)
// =============================================================================
add_shortcode('shorttrips_search_form', function () {
    ob_start();
    ?>
    <div id="shorttrips-search-form-container" class="shorttrips-main-page"
        style="max-width:1200px;width:100%;margin:0 auto;padding:8px;">
        <!-- ZOEKFORMULIER (modern design met tabs) -->
        <div id="search-form-container" class="search-form-wrapper">
            <h2 class="search-title">Find your hotel</h2>

            <!-- UNIVERSAL SEARCH BAR (Google-style autocomplete) -->
            <div class="st-universal-search-container" style="margin-bottom:24px;">
                <div class="st-universal-search-wrapper" style="position:relative;max-width:700px;margin:0 auto;">
                    <div style="display:flex;align-items:center;background:white;border:2px solid #e5e7eb;border-radius:12px;padding:4px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.2s;"
                        id="st-search-input-wrapper-home">
                        <span style="padding:0 12px;font-size:20px;color:#6b7280;">üîç</span>
                        <input type="text" id="st-universal-search-home"
                            placeholder="Find hotel, city, region or country..." autocomplete="off"
                            style="flex:1;border:none;outline:none;padding:12px 8px;font-size:16px;color:#1f2937;" />
                        <button type="button" id="st-search-clear-home"
                            style="display:none;padding:8px 12px;background:transparent;border:none;color:#9ca3af;cursor:pointer;font-size:20px;"
                            title="Wissen">‚úï</button>
                    </div>

                    <!-- AUTOCOMPLETE DROPDOWN -->
                    <div id="st-autocomplete-results-home" class="st-autocomplete-dropdown"
                        style="display:none;position:absolute;top:100%;left:0;right:0;margin-top:8px;background:white;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-height:400px;overflow-y:auto;z-index:1000;">
                        <!-- Results will be injected here -->
                    </div>

                    <!-- LOADING INDICATOR -->
                    <div id="st-search-loading-home"
                        style="display:none;position:absolute;right:16px;top:50%;transform:translateY(-50%);pointer-events:none;">
                        <div
                            style="width:20px;height:20px;border:2px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 0.6s linear infinite;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB NAVIGATIE -->
            <div class="search-tabs">
                <button class="search-tab active" data-tab="search" type="button">
                    Find Hotel
                </button>
                <button class="search-tab" data-tab="country" type="button">
                    Per country
                </button>
                <button class="search-tab" data-tab="resort" type="button">
                    Per resort
                </button>
            </div>

            <!-- FORMULIER -->
            <form id="shorttrips-search-form" class="search-form"
                action="<?php echo esc_url(shorttrips_get_hotels_page_url()); ?>" method="GET">
                <input type="hidden" name="type" id="search-type" value="search">
                <input type="hidden" name="action" value="shorttrips_search_hotels">

                <!-- TAB CONTENT: HOTEL ZOEKEN -->
                <div class="tab-content active" data-tab-content="search">
                    <div class="form-row">
                        <div class="form-field form-field-full">
                            <input type="text" name="q" placeholder="Add a destination..." class="form-input form-input-lg">
                        </div>
                    </div>
                </div>

                <!-- TAB CONTENT: PER LAND -->
                <div class="tab-content" data-tab-content="country" style="display:none;">
                    <div class="form-row">
                        <div class="form-field form-field-full">
                            <input type="text" name="country"
                                placeholder="Enter country, for example Netherlands, Thailand...)"
                                class="form-input form-input-lg">
                        </div>
                    </div>
                </div>

                <!-- TAB CONTENT: PER RESORT -->
                <div class="tab-content" data-tab-content="resort" style="display:none;">
                    <div class="form-row">
                        <div class="form-field">
                            <input type="text" name="resort" placeholder="Resort name..." class="form-input">
                        </div>
                        <div class="form-field">
                            <input type="text" name="country_resort" placeholder="Country..." class="form-input">
                        </div>
                    </div>
                </div>

                <!-- GEMEENSCHAPPELIJKE VELDEN (voor alle tabs) -->
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-field">
                            <label class="form-label">Checkin</label>
                            <input type="date" name="checkin" required
                                value="<?php echo date('Y-m-d', strtotime('+7 days')); ?>" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Checkout</label>
                            <input type="date" name="checkout" required
                                value="<?php echo date('Y-m-d', strtotime('+14 days')); ?>" class="form-input">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-row form-row-three">
                        <div class="form-field">
                            <label class="form-label">Rooms</label>
                            <input type="number" name="rooms" min="1" value="1" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Adults</label>
                            <input type="number" name="adults" min="1" value="2" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Children</label>
                            <input type="number" name="children" min="0" value="0" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- SUBMIT BUTTON -->
                <div class="form-submit">
                    <button type="submit" class="btn-submit">
                        Find hotels
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function () {
            // ============================================================
            // UNIVERSAL AUTOCOMPLETE SEARCH (HOMEPAGE)
            // ============================================================
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function () {
                    if (typeof initUniversalSearch === 'function') {
                        initUniversalSearch(
                            'st-universal-search-home',
                            'st-autocomplete-results-home',
                            'st-search-input-wrapper-home',
                            'st-search-clear-home',
                            'st-search-loading-home'
                        );
                    }
                });
            } else {
                if (typeof initUniversalSearch === 'function') {
                    initUniversalSearch(
                        'st-universal-search-home',
                        'st-autocomplete-results-home',
                        'st-search-input-wrapper-home',
                        'st-search-clear-home',
                        'st-search-loading-home'
                    );
                }
            }

            // ============================================================
            // EXISTING FORM CODE
            // ============================================================
            var form = document.getElementById('shorttrips-search-form');
            var tabButtons = document.querySelectorAll('.search-tab');
            var tabContents = document.querySelectorAll('.tab-content');
            var typeInput = document.getElementById('search-type');

            // TAB SWITCHING
            tabButtons.forEach(function (btn) {
                btn.addEventListener('click', function () {
                    var targetTab = this.getAttribute('data-tab');

                    // Update active states
                    tabButtons.forEach(function (b) {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Show/hide content
                    tabContents.forEach(function (content) {
                        var contentTab = content.getAttribute('data-tab-content');
                        if (contentTab === targetTab) {
                            content.style.display = 'block';
                            content.classList.add('active');
                        } else {
                            content.style.display = 'none';
                            content.classList.remove('active');
                        }
                    });

                    // Update hidden type field
                    typeInput.value = targetTab;

                    // Clear form fields in other tabs
                    if (targetTab !== 'search') {
                        var qField = form.querySelector('input[name="q"]');
                        if (qField) qField.value = '';
                    }
                    if (targetTab !== 'country') {
                        var countryField = form.querySelector('input[name="country"]');
                        if (countryField) countryField.value = '';
                    }
                    if (targetTab !== 'resort') {
                        var resortField = form.querySelector('input[name="resort"]');
                        var countryResortField = form.querySelector('input[name="country_resort"]');
                        if (resortField) resortField.value = '';
                        if (countryResortField) countryResortField.value = '';
                    }
                });
            });
        })();
    </script>

    <style>
        /* Main Container */
        .shorttrips-main-page {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 20px clamp(8px, 4vw, 60px);
        }

        /* Search Form Wrapper */
        .search-form-wrapper {
            background: #ffffff;
            border-radius: 18px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 14px 50px rgba(15, 23, 42, 0.12);
            padding: 6px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .search-title {
            font-size: 26px;
            font-weight: 700;
            color: #0f172a;
            padding: 24px 28px 12px;
            margin: 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .search-subtitle {
            margin: 0;
            padding: 0 28px 16px;
            font-size: 14px;
            color: #1f2937;
            border-bottom: 1px solid #f1f5f9;
        }

        /* Tabs */
        .search-tabs {
            display: flex;
            gap: 8px;
            padding: 12px 16px 4px;
            background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
            border-bottom: 1px solid #e5e7eb;
        }

        .search-tab {
            flex: 1;
            padding: 14px 18px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 999px;
            color: #475569;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 52px;
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
        }

        .search-tab:hover {
            color: #1d4ed8;
            border-color: #c7d2fe;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.12);
        }

        .search-tab.active {
            color: #0b1b46;
            background: linear-gradient(135deg, #93c5fd 0%, #2563eb 100%);
            border-color: #2563eb;
            box-shadow: 0 10px 28px rgba(37, 99, 235, 0.25);
        }

        /* Form */
        .search-form {
            padding: 26px;
        }

        .tab-content {
            margin-bottom: 20px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-three {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-field {
            position: relative;
        }

        .form-field-full {
            grid-column: 1 / -1;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            color: #1f2937;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .form-input-lg {
            padding: 14px 18px;
            font-size: 16px;
        }

        /* Submit Button */
        .form-submit {
            margin-top: 24px;
        }

        .btn-submit {
            width: 100%;
            padding: 14px 24px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn-submit:hover {
            background: #1d4ed8;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        /* Force "Find hotels" buttons to Freestays blue */
        #search-form-container button[type="submit"],
        #st-header-search button[type="submit"],
        .search-form-wrapper .btn-submit,
        #st-header-search .btn-submit,
        .search-form-wrapper button[type="submit"],
        .shorttrips-main-page button[type="submit"],
        .shorttrips-main-page .st-search-container button,
        .shorttrips-main-page .st-search-container .btn,
        .shorttrips-main-page .st-search-container .btn-primary {
            background: #2563eb !important;
            border-color: #2563eb !important;
            color: #fff !important;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.22);
        }

        /* Responsive */
        @media (max-width: 768px) {

            .form-row,
            .form-row-three {
                grid-template-columns: 1fr;
            }

            .search-tab {
                padding: 12px 16px;
                font-size: 14px;
            }

            .search-title {
                font-size: 20px;
                padding: 20px 16px 12px;
            }

            .search-form {
                padding: 16px;
            }
        }
    </style>
    <?php
    return ob_get_clean();
});

// =============================================================================
// SHORTCODE: Popular Destinations Widget
// =============================================================================
// Usage: [shorttrips_popular_destinations]
// Shows top 12 destinations by hotel count (cached 6 hours)
// =============================================================================
add_shortcode('shorttrips_popular_destinations', function ($atts) {
    $atts = shortcode_atts([
        'limit' => 12,
        'cache' => 'yes',
    ], $atts);

    global $wpdb;

    // Check for hotel table
    $hotel_table = null;
    $tables_to_check = ['ghwk_bravo_hotels', 'bravo_hotels', $wpdb->prefix . 'bravo_hotels'];
    foreach ($tables_to_check as $table) {
        $exists = $wpdb->get_var("SELECT COUNT(*) FROM {$table} LIMIT 1");
        if ($exists !== null) {
            $hotel_table = $table;
            break;
        }
    }

    if (!$hotel_table) {
        return '<div class="notice notice-warning"><p>Populaire bestemmingen tijdelijk niet beschikbaar. Gebruik het zoekformulier.</p></div>';
    }

    $popularDestinations = [];

    if ($atts['cache'] === 'yes') {
        // Cached version
        $cache_key = 'shorttrips_popular_destinations_v4'; // v4 = with stars
        $popularDestinations = get_transient($cache_key);

        if (false === $popularDestinations) {
            // üö® PERFORMANCE: Removed AVG(star_rate) - database has NULL values
            // Stars will be fetched from NonStatic API when needed
            $popularDestinations = $wpdb->get_results($wpdb->prepare("
                SELECT 
                    h.destination_name as resort,
                    h.address as city,
                    h.country_name as country,
                    NULL as destination_id,
                    COUNT(DISTINCT h.hotel_id) as hotel_count,
                    MAX(h.image) as example_image
                FROM {$hotel_table} h
                WHERE h.destination_name IS NOT NULL 
                  AND h.destination_name != ''
                  AND h.country_name IS NOT NULL
                  AND h.country_name != ''
                GROUP BY h.destination_name, h.country_name
                HAVING hotel_count >= 3
                ORDER BY hotel_count DESC
                LIMIT %d
            ", $atts['limit']), ARRAY_A);

            if (!empty($popularDestinations)) {
                set_transient($cache_key, $popularDestinations, 6 * HOUR_IN_SECONDS);
            }
        }
    } else {
        // Non-cached version (slow but always fresh)
        // üö® PERFORMANCE: Removed AVG(star_rate) - database has NULL values
        $popularDestinations = $wpdb->get_results($wpdb->prepare("
            SELECT 
                h.destination_name as resort,
                h.address as city,
                h.country_name as country,
                NULL as destination_id,
                COUNT(DISTINCT h.hotel_id) as hotel_count,
                MAX(h.image) as example_image
            FROM {$hotel_table} h
            WHERE h.destination_name IS NOT NULL 
              AND h.destination_name != ''
              AND h.country_name IS NOT NULL
              AND h.country_name != ''
            GROUP BY h.destination_name, h.country_name
            HAVING hotel_count >= 3
            ORDER BY hotel_count DESC
            LIMIT %d
        ", $atts['limit']), ARRAY_A);
    }

    if (empty($popularDestinations)) {
        return '<div class="notice notice-info"><p>Populaire bestemmingen worden geladen...</p></div>';
    }

    // Generate HTML with compact 4-column grid (like destinations page)
    ob_start();
    ?>
    <div class="st-popular-destinations">
        <div class="section-header" style="text-align:center;margin-bottom:32px;">
            <h2 style="font-size:28px;font-weight:700;color:#111827;margin-bottom:8px;">
                ‚≠ê Populair Destinations
            </h2>
            <p style="font-size:15px;color:#6b7280;">Our top destinations</p>
        </div>

        <!-- Compact 4-column grid -->
        <div class="st-destinations-compact-grid">
            <?php foreach ($popularDestinations as $dest):
                $searchUrl = add_query_arg([
                    'action' => 'shorttrips_search_hotels',
                    'type' => 'resort',
                    'resort' => $dest['resort'],
                    'country' => $dest['country'],
                    'checkin' => date('Y-m-d', strtotime('+7 days')),
                    'checkout' => date('Y-m-d', strtotime('+14 days')),
                    'rooms' => 1,
                    'adults' => 2,
                    'children' => 0
                ], shorttrips_get_hotels_page_url());
                ?>
                <a href="<?php echo esc_url($searchUrl); ?>" class="st-dest-compact-card">
                    <?php if (!empty($dest['example_image'])): ?>
                        <div class="st-dest-image">
                            <img src="<?php echo esc_url($dest['example_image']); ?>" alt="<?php echo esc_attr($dest['resort']); ?>"
                                onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'st-dest-placeholder\'><span style=\'font-size:32px;\'>üè®</span></div>';">
                        </div>
                    <?php else: ?>
                        <div class="st-dest-placeholder">
                            <span style="font-size:32px;">üè®</span>
                        </div>
                    <?php endif; ?>

                    <div class="st-dest-content">
                        <h3 class="st-dest-name"><?php echo esc_html($dest['resort']); ?></h3>
                        <p class="st-dest-country"><?php echo esc_html($dest['country']); ?></p>
                        <p class="st-dest-count"><?php echo intval($dest['hotel_count']); ?> hotels</p>
                    </div>
                </a>
            <?php endforeach; ?>
        </div>
    </div>

    <style>
        /* Compact 4-column grid for destinations */
        .st-popular-destinations {
            width: 100%;
            margin: 40px 0;
            padding: 0 20px;
        }

        .st-destinations-compact-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 0;
        }

        .st-dest-compact-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            text-decoration: none;
            color: inherit;
        }

        .st-dest-compact-card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px);
        }

        .st-dest-image {
            width: 100%;
            height: 160px;
            overflow: hidden;
            position: relative;
        }

        .st-dest-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .st-dest-placeholder {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .st-dest-content {
            padding: 16px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .st-dest-name {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 6px 0;
            line-height: 1.3;
        }

        .st-dest-country {
            font-size: 13px;
            color: #6b7280;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .st-dest-country:before {
            content: "üìç";
            font-size: 13px;
        }

        .st-dest-count {
            font-size: 13px;
            color: #2563eb;
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .st-dest-count:before {
            content: "üè®";
            font-size: 13px;
        }

        /* Responsive: 3 columns on tablet */
        @media (max-width: 1024px) {
            .st-destinations-compact-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }
        }

        /* Responsive: 2 columns on mobile landscape */
        @media (max-width: 768px) {
            .st-destinations-compact-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .st-dest-image,
            .st-dest-placeholder {
                height: 120px;
            }

            .st-dest-content {
                padding: 12px;
            }

            .st-dest-name {
                font-size: 14px;
            }
        }

        /* Responsive: 1 column on mobile portrait */
        @media (max-width: 480px) {
            .st-destinations-compact-grid {
                grid-template-columns: 1fr;
            }

            .st-dest-image,
            .st-dest-placeholder {
                height: 180px;
            }
        }
    </style>
    <?php
    return ob_get_clean();
});

// =============================================================================
// AFFILIATE INTEGRATIONS - Footer Shortcodes & Hotel Page Integration
// =============================================================================
// 4 Footer shortcodes: [shorttrips_footer_experiences], [shorttrips_footer_rentacar],
// Plus integration in hotel cards and prebook page
// =============================================================================

// Admin settings page for affiliate codes
add_action('admin_menu', function () {
    add_submenu_page(
        'options-general.php',
        'Affiliate Integraties',
        'Affiliate Integraties',
        'manage_options',
        'shorttrips-affiliates',
        'shorttrips_render_affiliates_page'
    );
});

function shorttrips_render_affiliates_page()
{
    if (!current_user_can('manage_options')) {
        wp_die('Unauthorized');
    }

    // Save settings
    if (isset($_POST['shorttrips_affiliates_save']) && check_admin_referer('shorttrips_affiliates_settings')) {
        // Custom kses voor affiliate codes - staat scripts toe (veilig omdat alleen admins dit kunnen bewerken)
        $allowed_tags = wp_kses_allowed_html('post');
        $allowed_tags['script'] = array(
            'src' => true,
            'type' => true,
            'async' => true,
            'defer' => true,
            'id' => true,
            'data-currency' => true,
            'data-lang' => true,
            'data-affilid' => true,
            'data-from' => true,
            'data-to' => true,
            'data-vi-partner-id' => true,
            'data-vi-widget-ref' => true,
            'data-dev-env' => true,
            'data-location' => true,
            'data-utm-source' => true,
            'data-utm-medium' => true,
            'data-aff-code' => true,
            'data-autocomplete' => true,
            'data-style-submit-bg-color' => true,
            'data-style-submit-font-color' => true,
            'data-style-form-bg-color' => true,
            'data-style-form-font-color' => true,
            'data-style-submit-text' => true,
        );
        $allowed_tags['div']['data-vi-partner-id'] = true;
        $allowed_tags['div']['data-vi-widget-ref'] = true;
        $allowed_tags['iframe'] = array(
            'src' => true,
            'width' => true,
            'height' => true,
            'frameborder' => true,
            'allowfullscreen' => true,
            'style' => true,
        );

        update_option('shorttrips_affiliate_experiences_code', wp_kses($_POST['experiences_code'] ?? '', $allowed_tags));
        update_option('shorttrips_affiliate_rentacar_code', wp_kses($_POST['rentacar_code'] ?? '', $allowed_tags));
        update_option('shorttrips_affiliate_flights_code', wp_kses($_POST['flights_code'] ?? '', $allowed_tags));
        update_option('shorttrips_contact_info', wp_kses_post($_POST['contact_info'] ?? ''));
        update_option('shorttrips_affiliate_enable_cards', isset($_POST['enable_cards']) ? '1' : '0');
        update_option('shorttrips_affiliate_enable_prebook', isset($_POST['enable_prebook']) ? '1' : '0');

        // Footer copyright instellingen
        update_option('shorttrips_footer_copyright_text', wp_kses_post($_POST['footer_copyright_text'] ?? ''));
        update_option('shorttrips_footer_logo_url', esc_url_raw($_POST['footer_logo_url'] ?? ''));
        update_option('shorttrips_footer_company_name', sanitize_text_field($_POST['footer_company_name'] ?? ''));
        update_option('shorttrips_footer_company_url', esc_url_raw($_POST['footer_company_url'] ?? ''));

        echo '<div class="notice notice-success"><p>‚úÖ Affiliate instellingen opgeslagen!</p></div>';
    }

    $experiences = get_option('shorttrips_affiliate_experiences_code', '');
    $rentacar = get_option('shorttrips_affiliate_rentacar_code', '');
    $flights = get_option('shorttrips_affiliate_flights_code', '');
    $contact = get_option('shorttrips_contact_info', '');
    $enableCards = get_option('shorttrips_affiliate_enable_cards', '1');
    $enablePrebook = get_option('shorttrips_affiliate_enable_prebook', '1');

    // Footer copyright instellingen
    $footerCopyright = get_option('shorttrips_footer_copyright_text', '');
    $footerLogoUrl = get_option('shorttrips_footer_logo_url', '');
    $footerCompanyName = get_option('shorttrips_footer_company_name', '');
    $footerCompanyUrl = get_option('shorttrips_footer_company_url', '');

    ?>
    <div class="wrap">
        <h1>üåç Affiliate Integraties - ShortTrips</h1>
        <p>Beheer de affiliate codes voor Belevenissen, Rent a Car, Flights en Contact informatie.</p>

        <form method="post" action="">
            <?php wp_nonce_field('shorttrips_affiliates_settings'); ?>

            <h2>üé≠ Belevenissen (Viator)</h2>
            <p><strong>Shortcode:</strong> <code>[shorttrips_footer_experiences]</code></p>
            <textarea name="experiences_code" rows="8"
                style="width:100%;font-family:monospace;"><?php echo esc_textarea($experiences); ?></textarea>
            <p class="description">Plak hier de complete HTML/script code van Viator widget</p>

            <hr style="margin:30px 0;">

            <h2>üöó Rent a Car (DiscoverCars)</h2>
            <p><strong>Shortcode:</strong> <code>[shorttrips_footer_rentacar]</code></p>
            <textarea name="rentacar_code" rows="8"
                style="width:100%;font-family:monospace;"><?php echo esc_textarea($rentacar); ?></textarea>
            <p class="description">Plak hier de complete HTML/script code van DiscoverCars widget</p>

            <hr style="margin:30px 0;">

            <h2>‚úàÔ∏è Flights (Kiwi.com)</h2>
            <p><strong>Shortcode:</strong> <code>[shorttrips_footer_flights]</code></p>
            <textarea name="flights_code" rows="8"
                style="width:100%;font-family:monospace;"><?php echo esc_textarea($flights); ?></textarea>
            <p class="description">Plak hier de complete HTML/script code van Kiwi.com widget</p>

            <hr style="margin:30px 0;">

            <h2>üìç Contact Informatie</h2>
            <p><strong>Shortcode:</strong> <code>[shorttrips_footer_contact]</code></p>
            <textarea name="contact_info" rows="12"
                style="width:100%;font-family:monospace;"><?php echo esc_textarea($contact); ?></textarea>
            <p class="description">HTML voor contact informatie (adres, telefoon, email, KvK, BTW)</p>

            <hr style="margin:30px 0;">

            <h2>‚öôÔ∏è Integratie Opties</h2>
            <label style="display:block;margin-bottom:10px;">
                <input type="checkbox" name="enable_cards" value="1" <?php checked($enableCards, '1'); ?>>
                Toon affiliate buttons in hotel search cards
            </label>
            <label style="display:block;margin-bottom:10px;">
                <input type="checkbox" name="enable_prebook" value="1" <?php checked($enablePrebook, '1'); ?>>
                Toon affiliate buttons in prebook pagina
            </label>

            <hr style="margin:30px 0;">

            <h2>üìÑ Footer Copyright Instellingen</h2>
            <p style="color:#666;margin-bottom:20px;">Pas de tekst onderaan de pagina aan (in de "site-info" sectie). Laat
                velden leeg om de standaard WordPress tekst te behouden.</p>

            <label style="display:block;font-weight:600;margin-bottom:5px;">Logo URL</label>
            <input type="url" name="footer_logo_url" value="<?php echo esc_attr($footerLogoUrl); ?>"
                placeholder="https://example.com/logo.png" style="width:100%;max-width:600px;margin-bottom:15px;">
            <p style="color:#666;font-size:12px;margin-top:-10px;margin-bottom:15px;">Optioneel: URL naar jouw logo
                afbeelding</p>

            <label style="display:block;font-weight:600;margin-bottom:5px;">Bedrijfsnaam</label>
            <input type="text" name="footer_company_name" value="<?php echo esc_attr($footerCompanyName); ?>"
                placeholder="ShortTrips" style="width:100%;max-width:600px;margin-bottom:15px;">
            <p style="color:#666;font-size:12px;margin-top:-10px;margin-bottom:15px;">Naam van jouw bedrijf</p>

            <label style="display:block;font-weight:600;margin-bottom:5px;">Bedrijf URL</label>
            <input type="url" name="footer_company_url" value="<?php echo esc_attr($footerCompanyUrl); ?>"
                placeholder="https://shorttrips.eu" style="width:100%;max-width:600px;margin-bottom:15px;">
            <p style="color:#666;font-size:12px;margin-top:-10px;margin-bottom:15px;">Link naar jouw website</p>

            <label style="display:block;font-weight:600;margin-bottom:5px;">Copyright Tekst (HTML toegestaan)</label>
            <textarea name="footer_copyright_text" rows="3"
                style="width:100%;max-width:600px;margin-bottom:5px;"><?php echo esc_textarea($footerCopyright); ?></textarea>
            <p style="color:#666;font-size:12px;margin-top:-5px;">Bijvoorbeeld: ¬© 2024 ShortTrips - Alle rechten
                voorbehouden | KvK: 12345678</p>

            <hr style="margin:30px 0;">

            <p class="submit">
                <input type="submit" name="shorttrips_affiliates_save" class="button button-primary" value="üíæ Opslaan">
            </p>
        </form>

        <hr style="margin:40px 0;">

        <h2>üìñ Shortcode Gebruik</h2>
        <h3>Footer (4 kolommen naast elkaar)</h3>
        <pre style="background:#f5f5f5;padding:15px;border-radius:5px;"><code>&lt;div style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin:40px 0;"&gt;
        &lt;div&gt;[shorttrips_footer_experiences]&lt;/div&gt;
        &lt;div&gt;[shorttrips_footer_rentacar]&lt;/div&gt;
        &lt;div&gt;[shorttrips_footer_flights]&lt;/div&gt;
        &lt;div&gt;[shorttrips_footer_contact]&lt;/div&gt;
    &lt;/div&gt;</code></pre>

        <h3>Responsive Footer (stapelt op mobiel)</h3>
        <pre style="background:#f5f5f5;padding:15px;border-radius:5px;"><code>&lt;div class="st-footer-affiliates"&gt;
        [shorttrips_footer_experiences]
        [shorttrips_footer_rentacar]
        [shorttrips_footer_flights]
        [shorttrips_footer_contact]
    &lt;/div&gt;

    &lt;style&gt;
    .st-footer-affiliates {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin: 40px 0;
    }
    @media (max-width: 768px) {
        .st-footer-affiliates { grid-template-columns: 1fr; }
    }
    &lt;/style&gt;</code></pre>
    </div>
    <?php
}

// =============================================================================
// BESTEMMINGEN BEHEER - Admin Page voor Populaire Bestemmingen
// =============================================================================
// Admin panel om handmatig populaire bestemmingen te beheren
// Getoond via shortcode: [shorttrips_destinations_showcase]
// =============================================================================

// Admin settings page for destinations
add_action('admin_menu', function () {
    add_submenu_page(
        'options-general.php',
        'Bestemmingen Beheer',
        'Bestemmingen Beheer',
        'manage_options',
        'shorttrips-destinations',
        'shorttrips_render_destinations_page'
    );
});

function shorttrips_render_destinations_page()
{
    if (!current_user_can('manage_options')) {
        wp_die('Unauthorized');
    }

    // Save settings
    if (isset($_POST['shorttrips_destinations_save']) && check_admin_referer('shorttrips_destinations_settings')) {
        // Get existing destinations or initialize empty array
        $destinations = isset($_POST['destinations']) ? $_POST['destinations'] : [];

        // Clean and validate each destination
        $cleaned_destinations = [];
        foreach ($destinations as $dest) {
            if (!empty($dest['name']) && !empty($dest['continent'])) {
                $cleaned_destinations[] = [
                    'name' => sanitize_text_field($dest['name']),
                    'continent' => sanitize_text_field($dest['continent']),
                    'image_url' => esc_url_raw($dest['image_url'] ?? ''),
                    'description' => wp_kses_post($dest['description'] ?? ''),
                    'rating' => floatval($dest['rating'] ?? 0),
                    'price_from' => sanitize_text_field($dest['price_from'] ?? ''),
                    'hotel_count' => intval($dest['hotel_count'] ?? 0),
                    'order' => intval($dest['order'] ?? 0)
                ];
            }
        }

        // Sort by order
        usort($cleaned_destinations, function ($a, $b) {
            return $a['order'] - $b['order'];
        });

        update_option('shorttrips_custom_destinations', $cleaned_destinations);

        echo '<div class="notice notice-success"><p>‚úÖ Bestemmingen opgeslagen!</p></div>';
    }

    // Handle delete
    if (isset($_GET['delete']) && check_admin_referer('delete_destination_' . intval($_GET['delete']))) {
        $destinations = get_option('shorttrips_custom_destinations', []);
        $index = intval($_GET['delete']);
        if (isset($destinations[$index])) {
            unset($destinations[$index]);
            $destinations = array_values($destinations); // Re-index
            update_option('shorttrips_custom_destinations', $destinations);
            echo '<div class="notice notice-success"><p>‚úÖ Bestemming verwijderd!</p></div>';
        }
    }

    $destinations = get_option('shorttrips_custom_destinations', []);

    ?>
    <div class="wrap">
        <h1>üåç Bestemmingen Beheer - ShortTrips</h1>
        <p>Beheer de populaire bestemmingen die getoond worden op de homepage.</p>
        <p><strong>Shortcode:</strong> <code>[shorttrips_destinations_showcase]</code></p>

        <form method="post" action="">
            <?php wp_nonce_field('shorttrips_destinations_settings'); ?>

            <h2>üìç Destinations</h2>
            <p style="color:#666;margin-bottom:20px;">Voeg landen/bestemmingen toe die je wilt tonen per continent.</p>

            <div id="destinations-container">
                <?php
                if (!empty($destinations)) {
                    foreach ($destinations as $index => $dest) {
                        ?>
                        <div class="destination-item"
                            style="background:#f9fafb;padding:20px;margin-bottom:20px;border-radius:8px;border:1px solid #e5e7eb;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                                <h3 style="margin:0;">Bestemming #<?php echo $index + 1; ?></h3>
                                <a href="<?php echo wp_nonce_url(add_query_arg(['page' => 'shorttrips-destinations', 'delete' => $index], admin_url('options-general.php')), 'delete_destination_' . $index); ?>"
                                    class="button button-small"
                                    onclick="return confirm('Weet je zeker dat je deze bestemming wilt verwijderen?');"
                                    style="background:#ef4444;color:white;border:none;">
                                    üóëÔ∏è Verwijderen
                                </a>
                            </div>

                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Land/Bestemming Naam *</label>
                                    <input type="text" name="destinations[<?php echo $index; ?>][name]"
                                        value="<?php echo esc_attr($dest['name']); ?>"
                                        placeholder="Bijvoorbeeld: Netherlands, Thailand, Spain" style="width:100%;" required>
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Continent *</label>
                                    <select name="destinations[<?php echo $index; ?>][continent]" style="width:100%;" required>
                                        <option value="">-- Kies continent --</option>
                                        <option value="Europa" <?php selected($dest['continent'], 'Europa'); ?>>üá™üá∫ Europa</option>
                                        <option value="Azi√´" <?php selected($dest['continent'], 'Azi√´'); ?>>üåè Azi√´</option>
                                        <option value="Amerika" <?php selected($dest['continent'], 'Amerika'); ?>>üåé Amerika
                                        </option>
                                        <option value="Afrika" <?php selected($dest['continent'], 'Afrika'); ?>>üåç Afrika</option>
                                        <option value="Oceani√´" <?php selected($dest['continent'], 'Oceani√´'); ?>>üåä Oceani√´
                                        </option>
                                    </select>
                                </div>

                                <div style="grid-column:1/-1;">
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Afbeelding URL</label>
                                    <input type="url" name="destinations[<?php echo $index; ?>][image_url]"
                                        value="<?php echo esc_attr($dest['image_url'] ?? ''); ?>"
                                        placeholder="https://example.com/image.jpg (optioneel)" style="width:100%;">
                                    <p style="color:#666;font-size:12px;margin:5px 0 0 0;">Laat leeg voor automatische hotel foto
                                    </p>
                                </div>

                                <div style="grid-column:1/-1;">
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Beschrijving</label>
                                    <textarea name="destinations[<?php echo $index; ?>][description]" rows="3"
                                        placeholder="Korte beschrijving van de bestemming..."
                                        style="width:100%;"><?php echo esc_textarea($dest['description'] ?? ''); ?></textarea>
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">‚≠ê Rating</label>
                                    <select name="destinations[<?php echo $index; ?>][rating]" style="width:100%;">
                                        <option value="0" <?php selected($dest['rating'] ?? 0, 0); ?>>Geen rating</option>
                                        <option value="5" <?php selected($dest['rating'] ?? 0, 5); ?>>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5.0)</option>
                                        <option value="4.5" <?php selected($dest['rating'] ?? 0, 4.5); ?>>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (4.5)</option>
                                        <option value="4" <?php selected($dest['rating'] ?? 0, 4); ?>>‚≠ê‚≠ê‚≠ê‚≠ê (4.0)</option>
                                        <option value="3.5" <?php selected($dest['rating'] ?? 0, 3.5); ?>>‚≠ê‚≠ê‚≠ê‚≠ê (3.5)</option>
                                        <option value="3" <?php selected($dest['rating'] ?? 0, 3); ?>>‚≠ê‚≠ê‚≠ê (3.0)</option>
                                    </select>
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">üí∞ Vanaf Prijs</label>
                                    <input type="text" name="destinations[<?php echo $index; ?>][price_from]"
                                        value="<?php echo esc_attr($dest['price_from'] ?? ''); ?>" placeholder="bijv: ‚Ç¨45/nacht"
                                        style="width:100%;">
                                    <p style="color:#666;font-size:12px;margin:5px 0 0 0;">Optioneel, bijv: ‚Ç¨45/nacht</p>
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Hotel Count (optioneel)</label>
                                    <input type="number" name="destinations[<?php echo $index; ?>][hotel_count]"
                                        value="<?php echo esc_attr($dest['hotel_count'] ?? 0); ?>"
                                        placeholder="0 = automatisch tellen" style="width:100%;">
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Volgorde</label>
                                    <input type="number" name="destinations[<?php echo $index; ?>][order]"
                                        value="<?php echo esc_attr($dest['order'] ?? $index); ?>" style="width:100%;">
                                </div>
                            </div>
                        </div>
                        <?php
                    }
                } else {
                    echo '<p style="color:#666;">Nog geen bestemmingen toegevoegd. Klik op "Nieuwe Bestemming Toevoegen".</p>';
                }
                ?>
            </div>

            <p style="margin-top:20px;">
                <button type="button" onclick="addNewDestination()" class="button button-secondary">
                    ‚ûï Nieuwe Bestemming Toevoegen
                </button>
            </p>

            <hr style="margin:30px 0;">

            <p class="submit">
                <input type="submit" name="shorttrips_destinations_save" class="button button-primary button-large"
                    value="üíæ Alle Bestemmingen Opslaan">
            </p>
        </form>

        <script>
            let destinationIndex = <?php echo count($destinations); ?>;

            function addNewDestination() {
                const container = document.getElementById('destinations-container');
                const newItem = document.createElement('div');
                newItem.className = 'destination-item';
                newItem.style.cssText = 'background:#f9fafb;padding:20px;margin-bottom:20px;border-radius:8px;border:1px solid #e5e7eb;';
                newItem.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3 style="margin:0;">Bestemming #${destinationIndex + 1} (NIEUW)</h3>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="button button-small" style="background:#ef4444;color:white;border:none;">
                        üóëÔ∏è Verwijderen
                    </button>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Land/Bestemming Naam *</label>
                        <input type="text" 
                               name="destinations[${destinationIndex}][name]" 
                               placeholder="Bijvoorbeeld: Netherlands, Thailand, Spain"
                               style="width:100%;" 
                               required>
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Continent *</label>
                        <select name="destinations[${destinationIndex}][continent]" style="width:100%;" required>
                            <option value="">-- Kies continent --</option>
                            <option value="Europa">üá™üá∫ Europa</option>
                            <option value="Azi√´">üåè Azi√´</option>
                            <option value="Amerika">üåé Amerika</option>
                            <option value="Afrika">üåç Afrika</option>
                            <option value="Oceani√´">üåä Oceani√´</option>
                        </select>
                    </div>
                    
                    <div style="grid-column:1/-1;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Afbeelding URL</label>
                        <input type="url" 
                               name="destinations[${destinationIndex}][image_url]" 
                               placeholder="https://example.com/image.jpg (optioneel)"
                               style="width:100%;">
                        <p style="color:#666;font-size:12px;margin:5px 0 0 0;">Laat leeg voor automatische hotel foto</p>
                    </div>
                    
                    <div style="grid-column:1/-1;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Beschrijving</label>
                        <textarea 
                            name="destinations[${destinationIndex}][description]" 
                            rows="3"
                            placeholder="Korte beschrijving van de bestemming..."
                            style="width:100%;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">‚≠ê Rating</label>
                        <select name="destinations[${destinationIndex}][rating]" style="width:100%;">
                            <option value="0">Geen rating</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5.0)</option>
                            <option value="4.5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (4.5)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4.0)</option>
                            <option value="3.5">‚≠ê‚≠ê‚≠ê‚≠ê (3.5)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (3.0)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">üí∞ Vanaf Prijs</label>
                        <input type="text" 
                               name="destinations[${destinationIndex}][price_from]" 
                               placeholder="bijv: ‚Ç¨45/nacht"
                               style="width:100%;">
                        <p style="color:#666;font-size:12px;margin:5px 0 0 0;">Optioneel, bijv: ‚Ç¨45/nacht</p>
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Hotel Count (optioneel)</label>
                        <input type="number" 
                               name="destinations[${destinationIndex}][hotel_count]" 
                               placeholder="0 = automatisch tellen"
                               style="width:100%;">
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Volgorde</label>
                        <input type="number" 
                               name="destinations[${destinationIndex}][order]" 
                               value="${destinationIndex}"
                               style="width:100%;">
                    </div>
                </div>
            `;

                container.appendChild(newItem);
                destinationIndex++;
            }
        </script>

        <hr style="margin:40px 0;">

        <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:20px;border-radius:4px;">
            <h2 style="margin-top:0;">üìñ Hoe te gebruiken</h2>
            <ol>
                <li>Klik op "Nieuwe Bestemming Toevoegen"</li>
                <li>Vul de landnaam in (exact zoals in database, bijvoorbeeld "Netherlands")</li>
                <li>Kies het juiste continent</li>
                <li>Optioneel: Voeg een custom afbeelding URL toe</li>
                <li>Klik op "Alle Bestemmingen Opslaan"</li>
                <li>Gebruik shortcode <code>[shorttrips_destinations_showcase]</code> op je pagina</li>
            </ol>

            <h3>üí° Tips:</h3>
            <ul>
                <li>De volgorde bepaalt hoe de bestemmingen gesorteerd worden</li>
                <li>Als je geen afbeelding URL invult, wordt automatisch een hotel foto gebruikt</li>
                <li>Hotel count wordt automatisch berekend als je 0 invult</li>
            </ul>
        </div>
    </div>
    <?php
}

// =============================================================================
// BELEVENISSEN BEHEER - Admin Page voor Belevenissen/Experiences
// =============================================================================
// Admin panel om handmatig belevenissen/activiteiten te beheren
// Getoond via shortcode: [shorttrips_experiences_showcase]
// =============================================================================

// Admin settings page for experiences
add_action('admin_menu', function () {
    add_submenu_page(
        'options-general.php',
        'Belevenissen Beheer',
        'Belevenissen Beheer',
        'manage_options',
        'shorttrips-experiences',
        'shorttrips_render_experiences_page'
    );
});

function shorttrips_render_experiences_page()
{
    if (!current_user_can('manage_options')) {
        wp_die('Unauthorized');
    }

    // Save settings
    if (isset($_POST['shorttrips_experiences_save']) && check_admin_referer('shorttrips_experiences_settings')) {
        $experiences = isset($_POST['experiences']) ? $_POST['experiences'] : [];

        // Clean and validate each experience
        $cleaned_experiences = [];
        foreach ($experiences as $exp) {
            if (!empty($exp['name'])) {
                $cleaned_experiences[] = [
                    'name' => sanitize_text_field($exp['name']),
                    'category' => sanitize_text_field($exp['category'] ?? ''),
                    'image_url' => esc_url_raw($exp['image_url'] ?? ''),
                    'description' => wp_kses_post($exp['description'] ?? ''),
                    'rating' => floatval($exp['rating'] ?? 0),
                    'price' => sanitize_text_field($exp['price'] ?? ''),
                    'duration' => sanitize_text_field($exp['duration'] ?? ''),
                    'link_url' => esc_url_raw($exp['link_url'] ?? ''),
                    'order' => intval($exp['order'] ?? 0)
                ];
            }
        }

        // Sort by order
        usort($cleaned_experiences, function ($a, $b) {
            return $a['order'] - $b['order'];
        });

        update_option('shorttrips_custom_experiences', $cleaned_experiences);

        echo '<div class="notice notice-success"><p>‚úÖ Belevenissen opgeslagen!</p></div>';
    }

    // Handle delete
    if (isset($_GET['delete']) && check_admin_referer('delete_experience_' . intval($_GET['delete']))) {
        $experiences = get_option('shorttrips_custom_experiences', []);
        $index = intval($_GET['delete']);
        if (isset($experiences[$index])) {
            unset($experiences[$index]);
            $experiences = array_values($experiences);
            update_option('shorttrips_custom_experiences', $experiences);
            echo '<div class="notice notice-success"><p>‚úÖ Belevenis verwijderd!</p></div>';
        }
    }

    $experiences = get_option('shorttrips_custom_experiences', []);

    ?>
    <div class="wrap">
        <h1>üé≠ Belevenissen Beheer - ShortTrips</h1>
        <p>Beheer de belevenissen/activiteiten die getoond worden op de homepage.</p>
        <p><strong>Shortcode:</strong> <code>[shorttrips_experiences_showcase]</code></p>

        <form method="post" action="">
            <?php wp_nonce_field('shorttrips_experiences_settings'); ?>

            <h2>üé≠ Belevenissen</h2>
            <p style="color:#666;margin-bottom:20px;">Voeg belevenissen/activiteiten toe (tours, excursies, events, etc.)
            </p>

            <div id="experiences-container">
                <?php
                if (!empty($experiences)) {
                    foreach ($experiences as $index => $exp) {
                        ?>
                        <div class="experience-item"
                            style="background:#f9fafb;padding:20px;margin-bottom:20px;border-radius:8px;border:1px solid #e5e7eb;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                                <h3 style="margin:0;">Belevenis #<?php echo $index + 1; ?></h3>
                                <a href="<?php echo wp_nonce_url(add_query_arg(['page' => 'shorttrips-experiences', 'delete' => $index], admin_url('options-general.php')), 'delete_experience_' . $index); ?>"
                                    class="button button-small"
                                    onclick="return confirm('Weet je zeker dat je deze belevenis wilt verwijderen?');"
                                    style="background:#ef4444;color:white;border:none;">
                                    üóëÔ∏è Verwijderen
                                </a>
                            </div>

                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Naam *</label>
                                    <input type="text" name="experiences[<?php echo $index; ?>][name]"
                                        value="<?php echo esc_attr($exp['name']); ?>"
                                        placeholder="Bijvoorbeeld: Rondvaart Amsterdam, Safari Tanzania" style="width:100%;"
                                        required>
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Categorie</label>
                                    <select name="experiences[<?php echo $index; ?>][category]" style="width:100%;">
                                        <option value="">-- Kies categorie --</option>
                                        <option value="Rondvaarten" <?php selected($exp['category'], 'Rondvaarten'); ?>>üö§
                                            Rondvaarten</option>
                                        <option value="Musea" <?php selected($exp['category'], 'Musea'); ?>>üèõÔ∏è Musea</option>
                                        <option value="Tours" <?php selected($exp['category'], 'Tours'); ?>>üö∂ Tours</option>
                                        <option value="Outdoor" <?php selected($exp['category'], 'Outdoor'); ?>>‚õ∞Ô∏è Outdoor</option>
                                        <option value="Food & Drinks" <?php selected($exp['category'], 'Food & Drinks'); ?>>üç∑ Food
                                            & Drinks</option>
                                        <option value="Wellness" <?php selected($exp['category'], 'Wellness'); ?>>üíÜ Wellness
                                        </option>
                                        <option value="Entertainment" <?php selected($exp['category'], 'Entertainment'); ?>>üé™
                                            Entertainment</option>
                                        <option value="Sport" <?php selected($exp['category'], 'Sport'); ?>>‚öΩ Sport</option>
                                    </select>
                                </div>

                                <div style="grid-column:1/-1;">
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Afbeelding URL *</label>
                                    <input type="url" name="experiences[<?php echo $index; ?>][image_url]"
                                        value="<?php echo esc_attr($exp['image_url'] ?? ''); ?>"
                                        placeholder="https://example.com/image.jpg" style="width:100%;" required>
                                </div>

                                <div style="grid-column:1/-1;">
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Beschrijving</label>
                                    <textarea name="experiences[<?php echo $index; ?>][description]" rows="3"
                                        placeholder="Korte beschrijving van de belevenis..."
                                        style="width:100%;"><?php echo esc_textarea($exp['description'] ?? ''); ?></textarea>
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">‚≠ê Rating</label>
                                    <select name="experiences[<?php echo $index; ?>][rating]" style="width:100%;">
                                        <option value="0" <?php selected($exp['rating'] ?? 0, 0); ?>>Geen rating</option>
                                        <option value="5" <?php selected($exp['rating'] ?? 0, 5); ?>>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5.0)</option>
                                        <option value="4.5" <?php selected($exp['rating'] ?? 0, 4.5); ?>>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (4.5)</option>
                                        <option value="4" <?php selected($exp['rating'] ?? 0, 4); ?>>‚≠ê‚≠ê‚≠ê‚≠ê (4.0)</option>
                                        <option value="3.5" <?php selected($exp['rating'] ?? 0, 3.5); ?>>‚≠ê‚≠ê‚≠ê‚≠ê (3.5)</option>
                                        <option value="3" <?php selected($exp['rating'] ?? 0, 3); ?>>‚≠ê‚≠ê‚≠ê (3.0)</option>
                                    </select>
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">üí∞ Prijs</label>
                                    <input type="text" name="experiences[<?php echo $index; ?>][price]"
                                        value="<?php echo esc_attr($exp['price'] ?? ''); ?>" placeholder="bijv: ‚Ç¨35 p.p."
                                        style="width:100%;">
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">‚è±Ô∏è Duur</label>
                                    <input type="text" name="experiences[<?php echo $index; ?>][duration]"
                                        value="<?php echo esc_attr($exp['duration'] ?? ''); ?>" placeholder="bijv: 3 uur"
                                        style="width:100%;">
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Link URL *</label>
                                    <input type="url" name="experiences[<?php echo $index; ?>][link_url]"
                                        value="<?php echo esc_attr($exp['link_url'] ?? ''); ?>" placeholder="https://..."
                                        style="width:100%;" required>
                                    <p style="color:#666;font-size:12px;margin:5px 0 0 0;">Link naar detail/boekingspagina</p>
                                </div>

                                <div>
                                    <label style="display:block;font-weight:600;margin-bottom:5px;">Volgorde</label>
                                    <input type="number" name="experiences[<?php echo $index; ?>][order]"
                                        value="<?php echo esc_attr($exp['order'] ?? $index); ?>" style="width:100%;">
                                </div>
                            </div>
                        </div>
                        <?php
                    }
                } else {
                    echo '<p style="color:#666;">Nog geen belevenissen toegevoegd. Klik op "Nieuwe Belevenis Toevoegen".</p>';
                }
                ?>
            </div>

            <p style="margin-top:20px;">
                <button type="button" onclick="addNewExperience()" class="button button-secondary">
                    ‚ûï Nieuwe Belevenis Toevoegen
                </button>
            </p>

            <hr style="margin:30px 0;">

            <p class="submit">
                <input type="submit" name="shorttrips_experiences_save" class="button button-primary button-large"
                    value="üíæ Alle Belevenissen Opslaan">
            </p>
        </form>

        <script>
            let experienceIndex = <?php echo count($experiences); ?>;

            function addNewExperience() {
                const container = document.getElementById('experiences-container');
                const newItem = document.createElement('div');
                newItem.className = 'experience-item';
                newItem.style.cssText = 'background:#f9fafb;padding:20px;margin-bottom:20px;border-radius:8px;border:1px solid #e5e7eb;';
                newItem.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                    <h3 style="margin:0;">Belevenis #${experienceIndex + 1} (NIEUW)</h3>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="button button-small" style="background:#ef4444;color:white;border:none;">
                        üóëÔ∏è Verwijderen
                    </button>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Naam *</label>
                        <input type="text" 
                               name="experiences[${experienceIndex}][name]" 
                               placeholder="Bijvoorbeeld: Rondvaart Amsterdam, Safari Tanzania"
                               style="width:100%;" 
                               required>
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Categorie</label>
                        <select name="experiences[${experienceIndex}][category]" style="width:100%;">
                            <option value="">-- Kies categorie --</option>
                            <option value="Rondvaarten">üö§ Rondvaarten</option>
                            <option value="Musea">üèõÔ∏è Musea</option>
                            <option value="Tours">üö∂ Tours</option>
                            <option value="Outdoor">‚õ∞Ô∏è Outdoor</option>
                            <option value="Food & Drinks">üç∑ Food & Drinks</option>
                            <option value="Wellness">üíÜ Wellness</option>
                            <option value="Entertainment">üé™ Entertainment</option>
                            <option value="Sport">‚öΩ Sport</option>
                        </select>
                    </div>
                    
                    <div style="grid-column:1/-1;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Afbeelding URL *</label>
                        <input type="url" 
                               name="experiences[${experienceIndex}][image_url]" 
                               placeholder="https://example.com/image.jpg"
                               style="width:100%;"
                               required>
                    </div>
                    
                    <div style="grid-column:1/-1;">
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Beschrijving</label>
                        <textarea 
                            name="experiences[${experienceIndex}][description]" 
                            rows="3"
                            placeholder="Korte beschrijving van de belevenis..."
                            style="width:100%;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">‚≠ê Rating</label>
                        <select name="experiences[${experienceIndex}][rating]" style="width:100%;">
                            <option value="0">Geen rating</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5.0)</option>
                            <option value="4.5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (4.5)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4.0)</option>
                            <option value="3.5">‚≠ê‚≠ê‚≠ê‚≠ê (3.5)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (3.0)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">üí∞ Prijs</label>
                        <input type="text" 
                               name="experiences[${experienceIndex}][price]" 
                               placeholder="bijv: ‚Ç¨35 p.p."
                               style="width:100%;">
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">‚è±Ô∏è Duur</label>
                        <input type="text" 
                               name="experiences[${experienceIndex}][duration]" 
                               placeholder="bijv: 3 uur"
                               style="width:100%;">
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Link URL *</label>
                        <input type="url" 
                               name="experiences[${experienceIndex}][link_url]" 
                               placeholder="https://..."
                               style="width:100%;"
                               required>
                        <p style="color:#666;font-size:12px;margin:5px 0 0 0;">Link naar detail/boekingspagina</p>
                    </div>
                    
                    <div>
                        <label style="display:block;font-weight:600;margin-bottom:5px;">Volgorde</label>
                        <input type="number" 
                               name="experiences[${experienceIndex}][order]" 
                               value="${experienceIndex}"
                               style="width:100%;">
                    </div>
                </div>
            `;

                container.appendChild(newItem);
                experienceIndex++;
            }
        </script>

        <hr style="margin:40px 0;">

        <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:20px;border-radius:4px;">
            <h2 style="margin-top:0;">üìñ Hoe te gebruiken</h2>
            <ol>
                <li>Klik op "Nieuwe Belevenis Toevoegen"</li>
                <li>Vul de naam in (bijvoorbeeld: "Rondvaart Amsterdam")</li>
                <li>Kies een categorie</li>
                <li>Voeg een afbeelding URL toe</li>
                <li>Schrijf een beschrijving</li>
                <li>Voeg de link toe naar de detail/boekingspagina</li>
                <li>Klik op "Alle Belevenissen Opslaan"</li>
                <li>Gebruik shortcode <code>[shorttrips_experiences_showcase]</code> op je pagina</li>
            </ol>

            <h3>üí° Tips:</h3>
            <ul>
                <li>De volgorde bepaalt hoe de belevenissen gesorteerd worden</li>
                <li>Gebruik hoge kwaliteit afbeeldingen (min. 800x600px)</li>
                <li>Houd beschrijvingen kort en pakkend (max 2-3 zinnen)</li>
            </ul>
        </div>
    </div>
    <?php
}

// =============================================================================
// SHORTCODE 1: Belevenissen (Viator)
// =============================================================================
add_shortcode('shorttrips_footer_experiences', function ($atts) {
    $code = get_option('shorttrips_affiliate_experiences_code', '');
    if (empty($code)) {
        return '<div style="padding:20px;border:2px dashed #ccc;text-align:center;color:#999;">
            <p>üé≠ <strong>Belevenissen</strong></p>
            <p style="font-size:12px;">Configureer in: Instellingen ‚Üí Affiliate Integraties</p>
        </div>';
    }

    // Custom kses voor affiliate widgets - staat scripts toe
    $allowed_html = wp_kses_allowed_html('post');
    $allowed_html['script'] = array(
        'src' => true,
        'type' => true,
        'async' => true,
        'defer' => true,
        'id' => true,
    );
    $allowed_html['div']['data-vi-partner-id'] = true;
    $allowed_html['div']['data-vi-widget-ref'] = true;
    $allowed_html['img']['style'] = true;

    ob_start();
    ?>
    <div class="st-affiliate-box st-experiences">
        <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;color:#111827;">üé≠ Belevenissen</h3>
        <div class="st-widget-container" style="max-width:100%;overflow:hidden;">
            <?php
            // Output zonder filtering voor affiliate scripts (veilig omdat alleen admins dit kunnen bewerken)
            echo $code;
            ?>
        </div>
    </div>
    <?php
    return ob_get_clean();
});

// =============================================================================
// SHORTCODE 2: Rent a Car (DiscoverCars)
// =============================================================================
add_shortcode('shorttrips_footer_rentacar', function ($atts) {
    $code = get_option('shorttrips_affiliate_rentacar_code', '');
    if (empty($code)) {
        return '<div style="padding:20px;border:2px dashed #ccc;text-align:center;color:#999;">
            <p>üöó <strong>Rent a Car</strong></p>
            <p style="font-size:12px;">Configureer in: Instellingen ‚Üí Affiliate Integraties</p>
        </div>';
    }

    // Custom kses voor affiliate widgets - staat scripts toe
    $allowed_html = wp_kses_allowed_html('post');
    $allowed_html['script'] = array('src' => true, 'type' => true, 'async' => true, 'defer' => true, 'id' => true);
    $allowed_html['iframe'] = array('src' => true, 'width' => true, 'height' => true, 'frameborder' => true, 'allowfullscreen' => true, 'style' => true);

    ob_start();
    ?>
    <div class="st-affiliate-box st-rentacar">
        <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;color:#111827;">üöó Rent a Car</h3>
        <div class="st-widget-container" style="max-width:100%;overflow:hidden;" id="rentacar-widget-container">
            <?php
            // Output de widget code direct
            echo $code;
            ?>
            <script>
                // Verwijder duplicate widgets na laden
                (function () {
                    setTimeout(function () {
                        var containers = document.querySelectorAll('#rentacar-widget-container');
                        if (containers.length > 1) {
                            console.log('Duplicate DiscoverCars widgets detected, removing...');
                            // Verwijder alle behalve de eerste
                            for (var i = 1; i < containers.length; i++) {
                                var forms = containers[i].querySelectorAll('form');
                                forms.forEach(function (form) {
                                    form.remove();
                                });
                            }
                        }
                    }, 1000);
                })();
            </script>
        </div>
    </div>
    <?php
    return ob_get_clean();
});

// =============================================================================
// SHORTCODE 3: Flights (Kiwi.com)
// =============================================================================
add_shortcode('shorttrips_footer_flights', function ($atts) {
    $code = get_option('shorttrips_affiliate_flights_code', '');
    if (empty($code)) {
        return '<div style="padding:20px;border:2px dashed #ccc;text-align:center;color:#999;">
            <p>‚úàÔ∏è <strong>Flights</strong></p>
            <p style="font-size:12px;">Configureer in: Instellingen ‚Üí Affiliate Integraties</p>
        </div>';
    }

    ob_start();
    ?>
    <div class="st-affiliate-box st-flights">
        <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;color:#111827;">‚úàÔ∏è Flights</h3>
        <div class="st-widget-container" style="max-width:100%;overflow:hidden;">
            <?php
            // Output zonder filtering voor affiliate scripts (veilig omdat alleen admins dit kunnen bewerken)
            echo $code;
            ?>
        </div>
    </div>
    <?php
    return ob_get_clean();
});

// =============================================================================
// SHORTCODE 4: Contact Informatie
// =============================================================================
add_shortcode('shorttrips_footer_contact', function ($atts) {
    $contact = get_option('shorttrips_contact_info', '');
    if (empty($contact)) {
        return '<div style="padding:20px;background:#fff;border:2px dashed #ccc;text-align:center;color:#999;">
            <p>üìç <strong>Contact</strong></p>
            <p style="font-size:12px;">Configureer in: Instellingen ‚Üí Affiliate Integraties</p>
        </div>';
    }

    ob_start();
    ?>
    <div class="st-affiliate-box st-contact">
        <h3 style="font-size:18px;font-weight:600;margin-bottom:16px;color:#111827;">üìç Contact</h3>
        <?php echo $contact; ?>
    </div>
    <?php
    return ob_get_clean();
});

// =============================================================================
// SHORTCODE 5: Bestemmingen Showcase (Custom Destinations)
// =============================================================================
// Toont handmatig beheerde bestemmingen vanuit admin panel
// Usage: [shorttrips_destinations_showcase]
// =============================================================================
add_shortcode('shorttrips_destinations_showcase', function ($atts) {
    global $wpdb;

    // Parse attributes
    $atts = shortcode_atts([
        'show_count' => 'yes'
    ], $atts);

    $showCount = $atts['show_count'] === 'yes';

    // Get custom destinations from admin
    $customDestinations = get_option('shorttrips_custom_destinations', []);

    if (empty($customDestinations)) {
        return '<div style="padding:40px;text-align:center;background:#fff;border-radius:12px;margin:20px 0;">
            <h2 style="font-size:24px;margin-bottom:16px;">üåç Geen bestemmingen geconfigureerd</h2>
            <p style="font-size:16px;color:#6b7280;margin-bottom:24px;">Ga naar: Instellingen ‚Üí Bestemmingen Beheer om bestemmingen toe te voegen</p>
        </div>';
    }

    // Group by continent
    $data = [];
    foreach ($customDestinations as $dest) {
        $continent = $dest['continent'];
        if (!isset($data[$continent])) {
            $data[$continent] = [];
        }

        // Get hotel count if not manually set
        if (empty($dest['hotel_count'])) {
            $dest['hotel_count'] = $wpdb->get_var($wpdb->prepare(
                "SELECT COUNT(*) FROM ghwk_bravo_hotels WHERE country_name = %s",
                $dest['name']
            ));
        }

        $data[$continent][] = $dest;
    }

    // Cache for images
    $countryImages = [];

    ob_start();
    ?>
    <style>
        .st-continents-section {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding: 40px clamp(20px, 6vw, 80px);
        }

        .st-continents-title {
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            color: #111827;
        }

        .st-continents-subtitle {
            font-size: 18px;
            text-align: center;
            color: #6b7280;
            margin-bottom: 40px;
        }

        .st-continent-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .st-continent-tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .st-continent-tab:hover {
            border-color: #2563eb;
            color: #2563eb;
            transform: translateY(-2px);
        }

        .st-continent-tab.active {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        .st-continent-content {
            display: none;
        }

        .st-continent-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .st-countries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .st-country-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .st-country-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .st-country-image-wrapper {
            position: relative;
            height: 240px;
            overflow: hidden;
        }

        .st-country-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .st-country-card:hover .st-country-image {
            transform: scale(1.05);
        }

        .st-country-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(37, 99, 235, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            backdrop-filter: blur(4px);
        }

        .st-country-info {
            padding: 24px;
            background: white;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .st-country-name {
            font-size: 22px;
            font-weight: 700;
            color: #111827;
            margin: 0 0 8px 0;
            text-align: center;
            line-height: 1.3;
        }

        .st-country-description {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
            margin: 0;
            text-align: center;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .st-country-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin: 8px 0;
            font-size: 14px;
        }

        .st-country-rating-stars {
            color: #f59e0b;
            font-size: 14px;
        }

        .st-country-rating-value {
            color: #374151;
            font-weight: 600;
        }

        .st-country-price {
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: #2563eb;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .st-continents-title {
                font-size: 28px;
            }

            .st-continent-tab {
                padding: 10px 16px;
                font-size: 14px;
            }

            .st-countries-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .st-country-image-wrapper {
                height: 200px;
            }

            .st-country-name {
                font-size: 20px;
            }

            .st-country-badge {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>

    <div class="st-continents-section">
        <h2 class="st-continents-title">üåç Find populair destinations worldwide</h2>
        <p class="st-continents-subtitle">Choose your favorite continent and start your journey</p>

        <!-- Continent Tabs -->
        <div class="st-continent-tabs">
            <?php
            $first = true;
            foreach ($data as $continent => $countries):
                ?>
                <button class="st-continent-tab <?php echo $first ? 'active' : ''; ?>"
                    onclick="stSwitchContinent(event, '<?php echo esc_attr($continent); ?>')">
                    <?php
                    $flags = [
                        'Europa' => 'üá™üá∫',
                        'Azi√´' => 'üåè',
                        'Amerika' => 'üåé',
                        'Afrika' => 'üåç',
                        'Oceani√´' => 'üåä'
                    ];
                    echo $flags[$continent] . ' ' . esc_html($continent);
                    ?>
                </button>
                <?php
                $first = false;
            endforeach;
            ?>
        </div>

        <!-- Continent Content -->
        <?php
        $first = true;
        foreach ($data as $continent => $countries):
            ?>
            <div class="st-continent-content <?php echo $first ? 'active' : ''; ?>"
                id="continent-<?php echo esc_attr($continent); ?>">
                <div class="st-countries-grid">
                    <?php foreach ($countries as $country):
                        // Get country image
                        $imageUrl = '';

                        // Use custom image if provided
                        if (!empty($country['image_url'])) {
                            $imageUrl = $country['image_url'];
                        }

                        // Fallback: Get ONE hotel image from database
                        if (!$imageUrl) {
                            if (!isset($countryImages[$country['name']])) {
                                $countryImages[$country['name']] = $wpdb->get_var($wpdb->prepare(
                                    "SELECT image FROM ghwk_bravo_hotels 
                                     WHERE country_name = %s AND image IS NOT NULL AND image != '' 
                                     LIMIT 1",
                                    $country['name']
                                ));
                            }
                            if ($countryImages[$country['name']]) {
                                $imageUrl = $countryImages[$country['name']];
                            }
                        }

                        // Final fallback: placeholder
                        if (!$imageUrl) {
                            $imageUrl = 'https://via.placeholder.com/600x400/667eea/ffffff?text=' . urlencode($country['name']);
                        }

                        // Get first destination_id for this country
                        $firstDestinationId = $wpdb->get_var($wpdb->prepare(
                            "SELECT bd.destination_id 
                             FROM bravo_destinations bd
                             WHERE bd.country_name = %s
                               AND bd.destination_id IS NOT NULL
                               AND bd.deleted_at IS NULL
                             ORDER BY bd.destination_id ASC
                             LIMIT 1",
                            $country['name']
                        ));

                        // Fallback: Try LIKE match
                        if (!$firstDestinationId) {
                            $firstDestinationId = $wpdb->get_var($wpdb->prepare(
                                "SELECT bd.destination_id 
                                 FROM bravo_destinations bd
                                 WHERE bd.country_name LIKE %s
                                   AND bd.destination_id IS NOT NULL
                                   AND bd.deleted_at IS NULL
                                 ORDER BY bd.destination_id ASC
                                 LIMIT 1",
                                '%' . $wpdb->esc_like($country['name']) . '%'
                            ));
                        }

                        // Build search URL
                        $searchParams = [
                            'type' => 'country',
                            'country_name' => $country['name'],
                            'checkin' => date('Y-m-d', strtotime('+7 days')),
                            'checkout' => date('Y-m-d', strtotime('+14 days')),
                            'nights' => 7,
                            'rooms' => 1,
                            'adults' => 2,
                            'children' => 0
                        ];

                        if ($firstDestinationId) {
                            $searchParams['destinationID'] = $firstDestinationId;
                        }

                        $searchUrl = add_query_arg($searchParams, shorttrips_get_hotels_page_url());
                        ?>
                        <a href="<?php echo esc_url($searchUrl); ?>" class="st-country-card">
                            <div class="st-country-image-wrapper">
                                <img src="<?php echo esc_url($imageUrl); ?>" alt="<?php echo esc_attr($country['name']); ?>"
                                    class="st-country-image" loading="lazy" />
                                <?php if ($showCount && !empty($country['hotel_count'])): ?>
                                    <div class="st-country-badge">
                                        <?php echo number_format($country['hotel_count']); ?> Hotels
                                    </div>
                                <?php endif; ?>
                            </div>
                            <div class="st-country-info">
                                <h3 class="st-country-name"><?php echo esc_html($country['name']); ?></h3>
                                <?php if (!empty($country['rating']) && $country['rating'] > 0): ?>
                                    <div class="st-country-rating">
                                        <span class="st-country-rating-stars">
                                            <?php
                                            $fullStars = floor($country['rating']);
                                            $hasHalfStar = ($country['rating'] - $fullStars) >= 0.5;

                                            for ($i = 0; $i < $fullStars; $i++) {
                                                echo '‚≠ê';
                                            }
                                            if ($hasHalfStar) {
                                                echo '‚≠ê';
                                            }
                                            ?>
                                        </span>
                                        <span class="st-country-rating-value"><?php echo number_format($country['rating'], 1); ?></span>
                                    </div>
                                <?php endif; ?>
                                <?php if (!empty($country['description'])): ?>
                                    <p class="st-country-description"><?php echo wp_kses_post($country['description']); ?></p>
                                <?php endif; ?>
                                <?php if (!empty($country['price_from'])): ?>
                                    <div class="st-country-price">Vanaf <?php echo esc_html($country['price_from']); ?></div>
                                <?php endif; ?>
                            </div>
                        </a>
                    <?php endforeach; ?>

                    <?php if (empty($countries)): ?>
                        <p style="grid-column: 1/-1; text-align:center; color:#6b7280; padding:40px 0;">
                            Geen bestemmingen beschikbaar voor <?php echo esc_html($continent); ?>
                        </p>
                    <?php endif; ?>
                </div>
            </div>
            <?php
            $first = false;
        endforeach;
        ?>
    </div>

    <script>
        function stSwitchContinent(event, continent) {
            // Remove active class from all tabs
            document.querySelectorAll('.st-continent-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Hide all content
            document.querySelectorAll('.st-continent-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected content
            document.getElementById('continent-' + continent).classList.add('active');
        }
    </script>

    <?php
    return ob_get_clean();
});

// =============================================================================
// SHORTCODE 6: Belevenissen Showcase (Custom Experiences)
// =============================================================================
// Toont handmatig beheerde belevenissen vanuit admin panel
// Usage: [shorttrips_experiences_showcase]
// =============================================================================
add_shortcode('shorttrips_experiences_showcase', function ($atts) {
    // Parse attributes
    $atts = shortcode_atts([
        'limit' => 0, // 0 = show all
        'category' => '' // empty = all categories
    ], $atts);

    $limit = intval($atts['limit']);
    $category = sanitize_text_field($atts['category']);

    // Get custom experiences from admin
    $experiences = get_option('shorttrips_custom_experiences', []);

    if (empty($experiences)) {
        return '<div style="padding:40px;text-align:center;background:#fff;border-radius:12px;margin:20px 0;">
            <h2 style="font-size:24px;margin-bottom:16px;">üé≠ Geen belevenissen geconfigureerd</h2>
            <p style="font-size:16px;color:#6b7280;margin-bottom:24px;">Ga naar: Instellingen ‚Üí Belevenissen Beheer om belevenissen toe te voegen</p>
        </div>';
    }

    // Filter by category if specified
    if (!empty($category)) {
        $experiences = array_filter($experiences, function ($exp) use ($category) {
            return strtolower($exp['category']) === strtolower($category);
        });
    }

    // Apply limit if specified
    if ($limit > 0) {
        $experiences = array_slice($experiences, 0, $limit);
    }

    ob_start();
    ?>
    <style>
        .st-experiences-section {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding: 40px clamp(20px, 6vw, 80px);
        }

        .st-experiences-title {
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            color: #111827;
        }

        .st-experiences-subtitle {
            font-size: 18px;
            text-align: center;
            color: #6b7280;
            margin-bottom: 40px;
        }

        .st-experiences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .st-experience-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .st-experience-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .st-experience-image-wrapper {
            position: relative;
            height: 240px;
            overflow: hidden;
        }

        .st-experience-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .st-experience-card:hover .st-experience-image {
            transform: scale(1.05);
        }

        .st-experience-category {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(37, 99, 235, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            backdrop-filter: blur(4px);
        }

        .st-experience-content {
            padding: 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .st-experience-name {
            font-size: 22px;
            font-weight: 700;
            color: #111827;
            margin: 0 0 12px 0;
            line-height: 1.3;
        }

        .st-experience-rating {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .st-experience-rating-stars {
            color: #f59e0b;
            font-size: 14px;
        }

        .st-experience-rating-value {
            color: #374151;
            font-weight: 600;
        }

        .st-experience-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #6b7280;
            flex-wrap: wrap;
        }

        .st-experience-price {
            color: #2563eb;
            font-weight: 700;
            font-size: 15px;
        }

        .st-experience-duration {
            color: #6b7280;
        }

        .st-experience-description {
            font-size: 15px;
            color: #6b7280;
            line-height: 1.6;
            margin: 0 0 12px 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .st-experience-buttons {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .st-experience-link,
        .st-experience-read-more {
            flex: 1;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            text-decoration: none;
            display: inline-block;
        }

        .st-experience-link {
            background: #2563eb;
            color: white;
        }

        .st-experience-link:hover {
            background: #1d4ed8;
        }

        .st-experience-read-more {
            background: #f3f4f6;
            color: #374151;
        }

        .st-experience-read-more:hover {
            background: #e5e7eb;
        }

        /* Popup Modal Styles */
        .st-experiences-more {
            margin-top: 40px;
            text-align: center;
        }

        .st-experiences-more-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            border-radius: 999px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #fff;
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .st-experiences-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px rgba(37, 99, 235, 0.35);
        }

        .st-experience-modal {
            display: none;
            position: fixed;
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease;
        }

        .st-experience-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .st-experience-modal-header {
            position: relative;
            height: 300px;
            overflow: hidden;
        }

        .st-experience-modal-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .st-experience-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            color: #111;
            font-size: 28px;
            font-weight: bold;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .st-experience-modal-close:hover {
            background: #f3f4f6;
            transform: scale(1.1);
        }

        .st-experience-modal-body {
            padding: 30px;
        }

        .st-experience-modal-title {
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin: 0 0 10px 0;
        }

        .st-experience-modal-category {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .st-experience-modal-description {
            font-size: 16px;
            color: #374151;
            line-height: 1.8;
            margin-bottom: 30px;
        }

        .st-experience-modal-link {
            display: inline-block;
            padding: 14px 28px;
            background: #2563eb;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            transition: background 0.2s ease;
        }

        .st-experience-modal-link:hover {
            background: #1d4ed8;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .st-experiences-title {
                font-size: 28px;
            }

            .st-experiences-subtitle {
                font-size: 16px;
            }

            .st-experiences-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .st-experience-image-wrapper {
                height: 200px;
            }

            .st-experience-name {
                font-size: 20px;
            }
        }
    </style>

    <div class="st-experiences-section">
        <h2 class="st-experiences-title">üé≠ Belevenissen & Activiteiten</h2>
        <p class="st-experiences-subtitle">Ontdek unieke ervaringen en maak je reis onvergetelijk</p>

        <div class="st-experiences-grid">
            <?php
            $modal_id = 0;
            foreach ($experiences as $exp):
                $modal_id++;
                ?>
                <div class="st-experience-card">
                    <div class="st-experience-image-wrapper">
                        <img src="<?php echo esc_url($exp['image_url']); ?>" alt="<?php echo esc_attr($exp['name']); ?>"
                            class="st-experience-image" loading="lazy" />
                        <?php if (!empty($exp['category'])): ?>
                            <div class="st-experience-category">
                                <?php echo esc_html($exp['category']); ?>
                            </div>
                        <?php endif; ?>
                    </div>
                    <div class="st-experience-content">
                        <h3 class="st-experience-name"><?php echo esc_html($exp['name']); ?></h3>
                        <?php if (!empty($exp['rating']) && $exp['rating'] > 0): ?>
                            <div class="st-experience-rating">
                                <span class="st-experience-rating-stars">
                                    <?php
                                    $fullStars = floor($exp['rating']);
                                    $hasHalfStar = ($exp['rating'] - $fullStars) >= 0.5;

                                    for ($i = 0; $i < $fullStars; $i++) {
                                        echo '‚≠ê';
                                    }
                                    if ($hasHalfStar) {
                                        echo '‚≠ê';
                                    }
                                    ?>
                                </span>
                                <span class="st-experience-rating-value"><?php echo number_format($exp['rating'], 1); ?></span>
                            </div>
                        <?php endif; ?>
                        <?php if (!empty($exp['price']) || !empty($exp['duration'])): ?>
                            <div class="st-experience-meta">
                                <?php if (!empty($exp['price'])): ?>
                                    <span class="st-experience-price"><?php echo esc_html($exp['price']); ?></span>
                                <?php endif; ?>
                                <?php if (!empty($exp['duration'])): ?>
                                    <span class="st-experience-duration">‚è±Ô∏è <?php echo esc_html($exp['duration']); ?></span>
                                <?php endif; ?>
                            </div>
                        <?php endif; ?>
                        <?php if (!empty($exp['description'])): ?>
                            <p class="st-experience-description"><?php echo wp_kses_post($exp['description']); ?></p>
                        <?php endif; ?>
                        <div class="st-experience-buttons">
                            <?php if (!empty($exp['description'])): ?>
                                <button class="st-experience-read-more" onclick="openExperienceModal(<?php echo $modal_id; ?>)">
                                    üìñ Lees meer
                                </button>
                            <?php endif; ?>
                            <?php if (!empty($exp['link_url'])): ?>
                                <a href="<?php echo esc_url($exp['link_url']); ?>" class="st-experience-link" target="_blank">
                                    Boeken ‚Üí
                                </a>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>

                <!-- Modal for this experience -->
                <div id="experience-modal-<?php echo $modal_id; ?>" class="st-experience-modal"
                    onclick="if(event.target === this) closeExperienceModal(<?php echo $modal_id; ?>)">
                    <div class="st-experience-modal-content">
                        <div class="st-experience-modal-header">
                            <img src="<?php echo esc_url($exp['image_url']); ?>" alt="<?php echo esc_attr($exp['name']); ?>"
                                class="st-experience-modal-image" />
                            <button class="st-experience-modal-close"
                                onclick="closeExperienceModal(<?php echo $modal_id; ?>)">&times;</button>
                        </div>
                        <div class="st-experience-modal-body">
                            <h2 class="st-experience-modal-title"><?php echo esc_html($exp['name']); ?></h2>
                            <?php if (!empty($exp['category'])): ?>
                                <span class="st-experience-modal-category"><?php echo esc_html($exp['category']); ?></span>
                            <?php endif; ?>
                            <?php if (!empty($exp['description'])): ?>
                                <div class="st-experience-modal-description">
                                    <?php echo wp_kses_post($exp['description']); ?>
                                </div>
                            <?php endif; ?>
                            <?php if (!empty($exp['link_url'])): ?>
                                <a href="<?php echo esc_url($exp['link_url']); ?>" class="st-experience-modal-link" target="_blank">
                                    üé´ Boek nu deze belevenis ‚Üí
                                </a>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
        <div class="st-experiences-more">
            <a class="st-experiences-more-btn" href="<?php echo esc_url(home_url('/belevenissen/')); ?>">
                <?php echo esc_html(shorttrips_translate('Toon meer')); ?> ‚Üí
            </a>
        </div>
    </div>

    <script>
        function openExperienceModal(id) {
            document.getElementById('experience-modal-' + id).style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeExperienceModal(id) {
            document.getElementById('experience-modal-' + id).style.display = 'none';
            document.body.style.overflow = 'auto'; // Re-enable scrolling
        }

        // Close modal on ESC key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                var modals = document.querySelectorAll('.st-experience-modal');
                modals.forEach(function (modal) {
                    modal.style.display = 'none';
                });
                document.body.style.overflow = 'auto';
            }
        });
    </script>

    <?php
    return ob_get_clean();
});

// =============================================================================
// AFFILIATE POPUP MODALS - Voor hotel cards en prebook
// =============================================================================
add_action('wp_footer', function () {
    $enableCards = get_option('shorttrips_affiliate_enable_cards', '1');
    $enablePrebook = get_option('shorttrips_affiliate_enable_prebook', '1');

    if ($enableCards !== '1' && $enablePrebook !== '1') {
        return; // Beide uitgeschakeld
    }

    $experiences = get_option('shorttrips_affiliate_experiences_code', '');
    $rentacar = get_option('shorttrips_affiliate_rentacar_code', '');
    $flights = get_option('shorttrips_affiliate_flights_code', '');
    ?>
    <style>
        .st-affiliate-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .st-affiliate-modal.active {
            display: flex;
        }

        .st-affiliate-content {
            background: #fff;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .st-affiliate-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f3f4f6;
            border: none;
            cursor: pointer;
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
            color: #1f2937;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .st-affiliate-close:hover {
            background: #e5e7eb;
            transform: rotate(90deg);
            color: #000;
        }

        .st-affiliate-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .st-affiliate-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .st-affiliate-btn:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .st-affiliate-btn.secondary {
            background: #10b981;
        }

        .st-affiliate-btn.secondary:hover {
            background: #059669;
        }

        .st-affiliate-btn.tertiary {
            background: #f59e0b;
        }

        .st-affiliate-btn.tertiary:hover {
            background: #d97706;
        }
    </style>

    <?php
    // Custom kses voor modals - staat scripts en iframes toe met alle affiliate data-attributen
    $modal_allowed_html = wp_kses_allowed_html('post');
    $modal_allowed_html['script'] = array(
        'src' => true,
        'type' => true,
        'async' => true,
        'defer' => true,
        'id' => true,
        'data-currency' => true,
        'data-lang' => true,
        'data-affilid' => true,
        'data-from' => true,
        'data-to' => true
    );
    $modal_allowed_html['iframe'] = array('src' => true, 'width' => true, 'height' => true, 'frameborder' => true, 'allowfullscreen' => true, 'style' => true);
    $modal_allowed_html['div']['data-vi-partner-id'] = true;
    $modal_allowed_html['div']['data-vi-widget-ref'] = true;
    $modal_allowed_html['img']['style'] = true;
    ?>

    <!-- Experiences Modal -->
    <div id="st-modal-experiences" class="st-affiliate-modal">
        <div class="st-affiliate-content">
            <button class="st-affiliate-close" onclick="closeAffiliateModal('experiences')">√ó</button>
            <h2 style="font-size:24px;font-weight:700;margin-bottom:8px;">üé≠ Belevenissen</h2>
            <p style="color:#6b7280;margin-bottom:24px;">Ontdek activiteiten en excursies op uw bestemming</p>
            <div style="max-width:100%;overflow:hidden;">
                <?php echo $experiences; ?>
            </div>
        </div>
    </div>

    <!-- Rent a Car Modal -->
    <div id="st-modal-rentacar" class="st-affiliate-modal">
        <div class="st-affiliate-content">
            <button class="st-affiliate-close" onclick="closeAffiliateModal('rentacar')">√ó</button>
            <h2 style="font-size:24px;font-weight:700;margin-bottom:8px;">üöó Rent a Car</h2>
            <p style="color:#6b7280;margin-bottom:24px;">Vergelijk autoverhuur en vind de beste deal</p>
            <div style="max-width:100%;overflow:hidden;">
                <?php echo $rentacar; ?>
            </div>
        </div>
    </div>

    <!-- Flights Modal -->
    <div id="st-modal-flights" class="st-affiliate-modal">
        <div class="st-affiliate-content">
            <button class="st-affiliate-close" onclick="closeAffiliateModal('flights')">√ó</button>
            <h2 style="font-size:24px;font-weight:700;margin-bottom:8px;">‚úàÔ∏è Flights</h2>
            <p style="color:#6b7280;margin-bottom:24px;">Vind de beste vluchten naar uw bestemming</p>
            <div style="max-width:100%;overflow:hidden;padding:40px 20px;text-align:center;">
                <div
                    style="background:linear-gradient(135deg, #0066ff 0%, #00d4ff 100%);padding:60px 40px;border-radius:16px;box-shadow:0 8px 32px rgba(0,102,255,0.3);">
                    <div style="font-size:48px;margin-bottom:20px;">‚úàÔ∏è</div>
                    <h3 style="color:#fff;font-size:28px;font-weight:700;margin:0 0 16px 0;">Zoek en vergelijk vluchten</h3>
                    <p style="color:#e0f2ff;font-size:16px;margin:0 0 32px 0;line-height:1.6;">
                        Vind de beste deals van 100+ airlines<br>
                        Vergelijk prijzen en boek direct
                    </p>
                    <a href="https://www.kiwi.com/deep?affilid=travelargroupbvmynetwork2023&from=AMS&to=anywhere&currency=EUR&lang=en"
                        target="_blank" rel="noopener"
                        style="display:inline-block;background:#fff;color:#0066ff;padding:16px 48px;border-radius:12px;font-size:18px;font-weight:700;text-decoration:none;box-shadow:0 4px 16px rgba(0,0,0,0.2);transition:all 0.3s;"
                        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'"
                        onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(0,0,0,0.2)'">
                        üîç Zoek vluchten op Kiwi.com
                    </a>
                    <p style="color:#b3d9ff;font-size:13px;margin:24px 0 0 0;">
                        Je wordt doorgestuurd naar Kiwi.com om je boeking te voltooien
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openAffiliateModal(type, destination, country, checkin, checkout) {
            var modal = document.getElementById('st-modal-' + type);
            if (!modal) return;

            // Log voor debugging
            console.log('üåç Opening affiliate modal:', type, { destination, country, checkin, checkout });

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAffiliateModal(type) {
            var modal = document.getElementById('st-modal-' + type);
            if (!modal) return;

            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close on outside click
        document.querySelectorAll('.st-affiliate-modal').forEach(function (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeAffiliateModal(modal.id.replace('st-modal-', ''));
                }
            });
        });

        // Close on ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.st-affiliate-modal.active').forEach(function (modal) {
                    closeAffiliateModal(modal.id.replace('st-modal-', ''));
                });
            }
        });
    </script>
    <?php
}, 999);

// === DIRECT DEBUG API CALL - NO AUTH, DIRECT EXECUTION ===
// This runs on template_redirect (after WordPress is loaded, before theme renders)
add_action('template_redirect', function () {
    if (!isset($_GET['debug_hotel_api']) || empty($_GET['hotelId'])) {
        return; // Not a debug request, continue normal processing
    }$hotelId = intval($_GET['hotelId']);
    // Use closer dates by default (30 days from now)
    $checkin = !empty($_GET['checkin']) ? sanitize_text_field($_GET['checkin']) : date('Y-m-d', strtotime('+30 days'));
    $checkout = !empty($_GET['checkout']) ? sanitize_text_field($_GET['checkout']) : date('Y-m-d', strtotime('+37 days'));

    // Override with immediate dates if original dates show no availability
    if (!empty($_GET['use_near_dates'])) {
        $checkin = date('Y-m-d', strtotime('+7 days'));
        $checkout = date('Y-m-d', strtotime('+10 days'));
    }
    $rooms = !empty($_GET['rooms']) ? intval($_GET['rooms']) : 1;
    $adults = !empty($_GET['adults']) ? intval($_GET['adults']) : 2;
    $children = !empty($_GET['children']) ? intval($_GET['children']) : 0;

    $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : [
        'username' => defined('SUNHOTELS_USERNAME') ? SUNHOTELS_USERNAME : '',
        'password' => defined('SUNHOTELS_PASSWORD') ? SUNHOTELS_PASSWORD : '',
        'language' => 'en',
        'currency' => 'EUR'
    ];

    // Stop WordPress from rendering the theme
    status_header(200);
    header('Content-Type: text/html; charset=utf-8');
    while (ob_get_level())
        ob_end_clean(); // Clear any output buffers
    echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>API Debug - Hotel ' . $hotelId . '</title>';
    echo '<style>body{font-family:monospace;padding:20px;background:#1e1e1e;color:#d4d4d4;}';
    echo 'h2{color:#4ec9b0;}pre{background:#252526;padding:15px;border-radius:5px;overflow:auto;max-height:600px;}';
    echo '.error{color:#f48771;}.success{color:#4ec9b0;}.warning{color:#dcdcaa;}</style></head><body>';

    echo '<h2>üîç API DEBUG - Hotel ' . $hotelId . '</h2>';
    echo '<p class="warning">CheckIn: ' . $checkin . ' | CheckOut: ' . $checkout . ' | Rooms: ' . $rooms . ' | Adults: ' . $adults . ' | Children: ' . $children . '</p>';

    // Add helpful tip if dates are far in future
    $daysUntilCheckin = (strtotime($checkin) - time()) / (60 * 60 * 24);
    if ($daysUntilCheckin > 100) {
        echo '<div style="background:#4a4a4a;padding:15px;border-left:4px solid #dcdcaa;margin:15px 0;">';
        echo '<p class="warning">‚ö†Ô∏è <strong>Tip:</strong> Your check-in date is ' . round($daysUntilCheckin) . ' days away. Many hotels don\'t publish availability that far in advance.</p>';
        $nearUrl = add_query_arg('use_near_dates', '1');
        echo '<p class="success">üîó <a href="' . $nearUrl . '" style="color:#4ec9b0;">Click here to test with dates 7 days from now</a></p>';
        echo '</div>';
    }

    // TEST 1: PreBookV3
    echo '<h3>üìã Test 1: PreBookV3 SOAP API</h3>';
    $endpointPrebook = 'https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx';
    $prebookSoap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<PreBookV3 xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>' . esc_html($creds['username']) . '</userName>'
        . '<password>' . esc_html($creds['password']) . '</password>'
        . '<currency>' . esc_html($creds['currency']) . '</currency>'
        . '<language>' . esc_html($creds['language']) . '</language>'
        . '<checkInDate>' . esc_html($checkin . 'T12:00:00') . '</checkInDate>'
        . '<checkOutDate>' . esc_html($checkout . 'T12:00:00') . '</checkOutDate>'
        . '<rooms>' . intval($rooms) . '</rooms>'
        . '<adults>' . intval($adults) . '</adults>'
        . '<children>' . intval($children) . '</children>'
        . '<childrenAges></childrenAges>'
        . '<infant>0</infant>'
        . '<mealId>0</mealId>'
        . '<customerCountry>NL</customerCountry>'
        . '<b2c>true</b2c>'
        . '<hotelId>' . intval($hotelId) . '</hotelId>'
        . '<showPriceBreakdown>true</showPriceBreakdown>'
        . '</PreBookV3>'
        . '</soap:Body>'
        . '</soap:Envelope>';

    $prebookResp = wp_remote_post($endpointPrebook, [
        'headers' => [
            'Content-Type' => 'text/xml; charset=utf-8',
            'SOAPAction' => '"http://xml.sunhotels.net/15/PreBookV3"'
        ],
        'body' => $prebookSoap,
        'timeout' => 60
    ]);

    if (!is_wp_error($prebookResp) && !empty($prebookResp['body'])) {
        echo '<p class="success">‚úÖ Response received (' . strlen($prebookResp['body']) . ' bytes)</p>';
        echo '<pre>' . htmlspecialchars(substr($prebookResp['body'], 0, 10000)) . (strlen($prebookResp['body']) > 10000 ? "\n\n... (truncated)" : '') . '</pre>';

        // Parse room types
        $prebookXml = @simplexml_load_string($prebookResp['body']);
        if ($prebookXml) {
            $prebookXml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
            $prebookXml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

            $xpathPatterns = [
                '//soap:Body//sh:PreBookV3Result//sh:rooms//sh:room',
                '//soap:Body//PreBookV3Result//rooms//room',
                '//PreBookV3Result//rooms//room',
                '//rooms//room',
                '//room'
            ];

            echo '<h4 class="warning">üîé Parsed Room Types:</h4><pre>';
            foreach ($xpathPatterns as $pattern) {
                $nodes = $prebookXml->xpath($pattern);
                if ($nodes && count($nodes) > 0) {
                    echo "Pattern matched: $pattern (" . count($nodes) . " rooms)\n\n";
                    foreach ($nodes as $i => $room) {
                        echo "Room #" . ($i + 1) . ":\n";
                        echo "  roomTypeId: " . ($room->roomTypeId ?? $room->roomtypeId ?? $room->id ?? '(not found)') . "\n";
                        echo "  roomTypeName: " . ($room->roomTypeName ?? $room->roomtypeName ?? $room->name ?? '(not found)') . "\n";
                        echo "  description: " . ($room->description ?? '(not found)') . "\n";
                        echo "\n";
                    }
                    break;
                }
            }
            echo '</pre>';
        }
    } else {
        echo '<p class="error">‚ùå Error: ' . (is_wp_error($prebookResp) ? $prebookResp->get_error_message() : 'Empty response') . '</p>';
    }

    // TEST 2: Try different API methods
    $apiTests = [
        [
            'name' => 'GetAvailableHotel (SOAP)',
            'endpoint' => 'https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx',
            'method' => 'GetAvailableHotel',
            'type' => 'soap'
        ],
        [
            'name' => 'GetAvailableHotelV2 (POST)',
            'endpoint' => 'https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx/GetAvailableHotelV2',
            'method' => 'GetAvailableHotelV2',
            'type' => 'post'
        ],
        [
            'name' => 'GetRoomAvailability (SOAP)',
            'endpoint' => 'https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx',
            'method' => 'GetRoomAvailability',
            'type' => 'soap'
        ]
    ];

    foreach ($apiTests as $test) {
        echo '<h3>üìã Test: ' . $test['name'] . '</h3>';

        if ($test['type'] === 'soap') {
            // SOAP request
            $soapBody = '<?xml version="1.0" encoding="utf-8"?>'
                . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
                . '<soap:Body>'
                . '<' . $test['method'] . ' xmlns="http://xml.sunhotels.net/15/">'
                . '<userName>' . esc_html($creds['username']) . '</userName>'
                . '<password>' . esc_html($creds['password']) . '</password>'
                . '<language>' . esc_html($creds['language']) . '</language>'
                . '<currency>' . esc_html($creds['currency']) . '</currency>'
                . '<checkInDate>' . esc_html($checkin) . '</checkInDate>'
                . '<checkOutDate>' . esc_html($checkout) . '</checkOutDate>'
                . '<hotelId>' . intval($hotelId) . '</hotelId>'
                . '<numberOfRooms>' . intval($rooms) . '</numberOfRooms>'
                . '<numberOfAdults>' . intval($adults) . '</numberOfAdults>'
                . '<numberOfChildren>' . intval($children) . '</numberOfChildren>'
                . '</' . $test['method'] . '>'
                . '</soap:Body>'
                . '</soap:Envelope>';

            $resp = wp_remote_post($test['endpoint'], [
                'headers' => [
                    'Content-Type' => 'text/xml; charset=utf-8',
                    'SOAPAction' => '"http://xml.sunhotels.net/15/' . $test['method'] . '"'
                ],
                'body' => $soapBody,
                'timeout' => 60
            ]);
        } else {
            // POST request
            $params = [
                'userName' => $creds['username'],
                'password' => $creds['password'],
                'language' => $creds['language'],
                'currencies' => $creds['currency'],
                'hotelID' => $hotelId,
                'checkInDate' => $checkin,
                'checkOutDate' => $checkout,
                'numberOfRooms' => $rooms,
                'numberOfAdults' => $adults,
                'numberOfChildren' => $children
            ];

            $resp = wp_remote_post($test['endpoint'], [
                'headers' => ['Content-Type' => 'application/x-www-form-urlencoded'],
                'body' => http_build_query($params),
                'timeout' => 60
            ]);
        }

        if (!is_wp_error($resp) && !empty($resp['body'])) {
            echo '<p class="success">‚úÖ Response received (' . strlen($resp['body']) . ' bytes)</p>';

            // Check for error in response
            if (stripos($resp['body'], 'Exception') !== false || stripos($resp['body'], 'Error') !== false) {
                echo '<pre style="color:#f48771;">' . htmlspecialchars(substr($resp['body'], 0, 1000)) . '</pre>';
            } else {
                echo '<pre>' . htmlspecialchars(substr($resp['body'], 0, 5000)) . (strlen($resp['body']) > 5000 ? "\n\n... (truncated)" : '') . '</pre>';

                // Try to parse
                $xml = @simplexml_load_string($resp['body']);
                if ($xml) {
                    $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

                    // Try to find rooms
                    $roomPatterns = [
                        '//soap:Body//sh:rooms//sh:room',
                        '//rooms//room',
                        '//room'
                    ];

                    foreach ($roomPatterns as $pattern) {
                        $rooms = $xml->xpath($pattern);
                        if ($rooms && count($rooms) > 0) {
                            echo '<p class="success">üéâ Found ' . count($rooms) . ' rooms!</p>';
                            echo '<h4 class="warning">üîé Room Types:</h4><pre>';
                            foreach ($rooms as $i => $room) {
                                echo "Room #" . ($i + 1) . ":\n";
                                foreach ($room as $key => $value) {
                                    if (stripos($key, 'type') !== false || stripos($key, 'name') !== false || stripos($key, 'id') !== false) {
                                        echo "  $key: $value\n";
                                    }
                                }
                                echo "\n";
                                if ($i >= 2) {
                                    echo "... (showing first 3 rooms)\n";
                                    break;
                                }
                            }
                            echo '</pre>';
                            break;
                        }
                    }
                }
            }
        } else {
            echo '<p class="error">‚ùå Error: ' . (is_wp_error($resp) ? $resp->get_error_message() : 'Empty response') . '</p>';
        }

        echo '<hr style="border-color:#4ec9b0;margin:20px 0;">';
    }

    echo '</body></html>';
    exit;
}, -999);

// =============================================================================
// ‚ùå OLD EXOPLANET THEME SETUP CODE - DISABLED
// =============================================================================
// All Exoplanet theme-specific code has been disabled because we're now using
// Travel Booking theme which has its own setup in functions.php
// The code is wrapped in if(false) to prevent execution while keeping it readable
// =============================================================================
if (apply_filters('shorttrips_enable_exoplanet_theme_setup', false)) { // DISABLED - Exoplanet theme code
    if (!function_exists('exoplanet_setup')):

        //Sets up theme defaults and registers support for various WordPress features

        function exoplanet_setup()
        {
            // Make theme available for translation
            add_action('init', static function () {
                load_theme_textdomain('exoplanet', get_template_directory() . '/languages');
            }, 1);

            // Add default posts and comments RSS feed links to head
            add_theme_support('automatic-feed-links');

            // Let WordPress manage the document title
            add_theme_support('title-tag');

            // Support for woocommerce
            add_theme_support('woocommerce');

            //Enable support for Post Thumbnails on posts and pages.
            add_theme_support('post-thumbnails');
            add_image_size('exoplanet-about-thumb', 400, 420, true);
            add_image_size('exoplanet-blog-thumb', 800, 420, true);

            // This theme uses wp_nav_menu() in two locations.
            register_nav_menus(array(
                'primary' => esc_html__('Primary Menu', 'exoplanet'),
                'footer' => esc_html__('Footer Menu', 'exoplanet'),
            ));

            /*
             * Switch default core markup for search form, comment form, and comments
             * to output valid HTML5.
             */
            add_theme_support('html5', array(
                'search-form',
                'comment-list',
                'gallery',
                'caption',
            ));

            // Set up the WordPress core custom background feature
            add_theme_support('custom-background', apply_filters('exoplanet_custom_background_args', array(
                'default-color' => 'ffffff',
                'default-image' => '',
            )));

            // Enable support for Custom Logo
            add_theme_support('custom-logo', array(
                'width' => '300',
                'height' => '60',
            ));

            // Enable support for widgets selective refresh
            add_theme_support('customize-selective-refresh-widgets');

            // Support for WooCommerce 2.7+ product gallery features
            add_theme_support('wc-product-gallery-zoom');
            add_theme_support('wc-product-gallery-lightbox');
            add_theme_support('wc-product-gallery-slider');

            // Support for Gutenberg (5.0+ block editor)
            add_theme_support('align-wide');

        }
    endif; // exoplanet_setup
    add_action('after_setup_theme', 'exoplanet_setup');

    function exoplanet_content_width()
    {
        $GLOBALS['content_width'] = apply_filters('exoplanet_content_width', 1200);
    }
    add_action('after_setup_theme', 'exoplanet_content_width', 0);

    // Enables the Excerpt meta box in Page edit screen
    function exoplanet_add_excerpt_support_for_pages()
    {
        add_post_type_support('page', 'excerpt');
    }
    add_action('init', 'exoplanet_add_excerpt_support_for_pages');

    // Register widget area
    function exoplanet_widgets_init()
    {
        register_sidebar(array(
            'name' => esc_html__('Right Sidebar', 'exoplanet'),
            'id' => 'exoplanet-right-sidebar',
            'description' => '',
            'before_widget' => '<aside id="%1$s" class="widget %2$s">',
            'after_widget' => '</aside>',
            'before_title' => '<h4 class="widget-title">',
            'after_title' => '</h4>',
        ));

        register_sidebar(array(
            'name' => esc_html__('Left Sidebar', 'exoplanet'),
            'id' => 'exoplanet-left-sidebar',
            'description' => '',
            'before_widget' => '<aside id="%1$s" class="widget %2$s">',
            'after_widget' => '</aside>',
            'before_title' => '<h4 class="widget-title">',
            'after_title' => '</h4>',
        ));

        register_sidebar(array(
            'name' => esc_html__('Shop Sidebar', 'exoplanet'),
            'id' => 'exoplanet-shop-sidebar',
            'description' => '',
            'before_widget' => '<aside id="%1$s" class="widget %2$s">',
            'after_widget' => '</aside>',
            'before_title' => '<h4 class="widget-title">',
            'after_title' => '</h4>',
        ));

        register_sidebar(array(
            'name' => esc_html__('Footer Column 1', 'exoplanet'),
            'id' => 'exoplanet-footer1',
            'description' => '',
            'before_widget' => '<aside id="%1$s" class="widget %2$s">',
            'after_widget' => '</aside>',
            'before_title' => '<h5 class="widget-title">',
            'after_title' => '</h5>',
        ));

        register_sidebar(array(
            'name' => esc_html__('Footer Column 2', 'exoplanet'),
            'id' => 'exoplanet-footer2',
            'description' => '',
            'before_widget' => '<aside id="%1$s" class="widget %2$s">',
            'after_widget' => '</aside>',
            'before_title' => '<h5 class="widget-title">',
            'after_title' => '</h5>',
        ));

        register_sidebar(array(
            'name' => esc_html__('Footer Column 3', 'exoplanet'),
            'id' => 'exoplanet-footer3',
            'description' => '',
            'before_widget' => '<aside id="%1$s" class="widget %2$s">',
            'after_widget' => '</aside>',
            'before_title' => '<h5 class="widget-title">',
            'after_title' => '</h5>',
        ));

        register_sidebar(array(
            'name' => esc_html__('Footer Column 4', 'exoplanet'),
            'id' => 'exoplanet-footer4',
            'description' => '',
            'before_widget' => '<aside id="%1$s" class="widget %2$s">',
            'after_widget' => '</aside>',
            'before_title' => '<h5 class="widget-title">',
            'after_title' => '</h5>',
        ));

        register_sidebar(array(
            'name' => esc_html__('Middle Footer', 'exoplanet'),
            'id' => 'exoplanet-about-footer',
            'description' => '',
            'before_widget' => '<aside id="%1$s" class="widget %2$s">',
            'after_widget' => '</aside>',
            'before_title' => '<h5 class="widget-title">',
            'after_title' => '</h5>',
        ));
    }
    add_action('widgets_init', 'exoplanet_widgets_init');

    if (!function_exists('exoplanet_fonts_url')):
        /**
         * Register Google fonts for Exoplanet
         * @return string Google fonts URL for the theme
         */
        function exoplanet_fonts_url()
        {
            $fonts_url = '';
            $fonts = array();
            $subsets = 'latin,latin-ext';

            /*
             * Translators: If there are characters in your language that are not supported
             * by Source Sans Pro, translate this to 'off'. Do not translate into your own language.
             */
            if ('off' !== _x('on', 'Google fonts: on or off', 'exoplanet')) {

                $fonts[] = get_theme_mod('font_header', 'Ubuntu:300,400,500,700');
                $fonts[] = get_theme_mod('font_nav', 'Hind:300,400,500,600,700');
                $fonts[] = get_theme_mod('font_page_title', 'Ubuntu:300,400,500,700');
                $fonts[] = get_theme_mod('font_content', 'Source Sans Pro:300,400,600,700');
                $fonts[] = get_theme_mod('font_headings', 'Montserrat:400,700');
                $fonts[] = get_theme_mod('font_footer', 'Hind:300,400,500,600,700');

            }

            /*
             * Translators: To add an additional character subset specific to your language,
             * translate this to 'greek', 'cyrillic', 'devanagari' or 'vietnamese'. Do not translate into your own language.
             */
            $subset = _x('no-subset', 'Add new subset (greek, cyrillic, devanagari, vietnamese)', 'exoplanet');

            if ('cyrillic' == $subset) {
                $subsets .= ',cyrillic,cyrillic-ext';
            } elseif ('greek' == $subset) {
                $subsets .= ',greek,greek-ext';
            } elseif ('devanagari' == $subset) {
                $subsets .= ',devanagari';
            } elseif ('vietnamese' == $subset) {
                $subsets .= ',vietnamese';
            }

            if ($fonts) {
                $fonts_url = add_query_arg(array(
                    'family' => urlencode(implode('|', array_unique($fonts))),
                    'subset' => urlencode($subsets),
                ), '//fonts.googleapis.com/css');
            }

            return esc_url_raw($fonts_url);
        }
    endif;

    if (!function_exists('exoplanet_editor_fonts_url')):
        /**
         * Register Google fonts for Exoplanet
         * @return string Google fonts URL for the theme
         */
        function exoplanet_editor_fonts_url()
        {
            $fonts_url = '';
            $fonts = array();
            $subsets = 'latin,latin-ext';

            /*
             * Translators: If there are characters in your language that are not supported
             * by Source Sans Pro, translate this to 'off'. Do not translate into your own language.
             */
            if ('off' !== _x('on', 'Google fonts: on or off', 'exoplanet')) {

                $fonts[] = get_theme_mod('font_page_title', 'Ubuntu:300,400,500,700');
                $fonts[] = get_theme_mod('font_content', 'Source Sans Pro:300,400,600,700');
                $fonts[] = get_theme_mod('font_headings', 'Montserrat:400,700');

            }

            /*
             * Translators: To add an additional character subset specific to your language,
             * translate this to 'greek', 'cyrillic', 'devanagari' or 'vietnamese'. Do not translate into your own language.
             */
            $subset = _x('no-subset', 'Add new subset (greek, cyrillic, devanagari, vietnamese)', 'exoplanet');

            if ('cyrillic' == $subset) {
                $subsets .= ',cyrillic,cyrillic-ext';
            } elseif ('greek' == $subset) {
                $subsets .= ',greek,greek-ext';
            } elseif ('devanagari' == $subset) {
                $subsets .= ',devanagari';
            } elseif ('vietnamese' == $subset) {
                $subsets .= ',vietnamese';
            }

            if ($fonts) {
                $fonts_url = add_query_arg(array(
                    'family' => urlencode(implode('|', array_unique($fonts))),
                    'subset' => urlencode($subsets),
                ), '//fonts.googleapis.com/css');
            }

            return esc_url_raw($fonts_url);
        }
    endif;

    /**
     * Enqueue scripts and styles.
     */
    function exoplanet_scripts()
    {
        wp_enqueue_script('imagesloaded');
        wp_enqueue_script('modernizr', get_template_directory_uri() . '/js/modernizr.js', array(), '2.6.3', true);
        wp_enqueue_script('jquery-bxslider', get_template_directory_uri() . '/js/jquery.bxslider.js', array('jquery'), '4.1.2', true);
        wp_enqueue_script('jquery-superfish', get_template_directory_uri() . '/js/jquery.superfish.js', array('jquery'), '20160213', true);
        wp_enqueue_script('exoplanet-custom', get_template_directory_uri() . '/js/exoplanet-custom.js', array('jquery'), '20160520', true);
        wp_enqueue_style('exoplanet-fonts', exoplanet_fonts_url(), array(), null);
        wp_enqueue_style('animate', get_template_directory_uri() . '/css/animate.css', array(), '1.0');
        wp_enqueue_style('exoplanet-font-awesome', get_template_directory_uri() . '/css/font-awesome.min.css');
        wp_enqueue_style('exoplanet-style', get_stylesheet_uri());
        wp_add_inline_style('exoplanet-style', exoplanet_dynamic_style());
        if (is_singular() && comments_open() && get_option('thread_comments')) {
            wp_enqueue_script('comment-reply');
        }
    }
    add_action('wp_enqueue_scripts', 'exoplanet_scripts');

    /**
     * Enqueue admin style
     */
    function exoplanet_admin_scripts($hook)
    {
        if ('post.php' == $hook || 'post-new.php' == $hook) {
            wp_enqueue_style('exoplanet-admin-style', get_template_directory_uri() . '/functions/css/admin-style.css', array(), '1.0');
        } else {
            return;
        }
    }
    add_action('admin_enqueue_scripts', 'exoplanet_admin_scripts');

    /**
     * Enqueue scripts and styles for Block Editor.
     */
    function exoplanet_enqueue_gutenberg_block_editor_assets()
    {
        wp_enqueue_style('exoplanet-block-editor-fonts', exoplanet_editor_fonts_url());
        wp_enqueue_style('exoplanet-block-editor-style', get_template_directory_uri() . '/css/block-editor-style.css');
        wp_add_inline_style('exoplanet-block-editor-style', exoplanet_block_editor_dynamic_style());
    }
    add_action('enqueue_block_editor_assets', 'exoplanet_enqueue_gutenberg_block_editor_assets');

    // Old Exoplanet theme file requires (commented out - files don't exist in Travel Booking)
// require get_template_directory() . '/functions/custom-header.php';
// require get_template_directory() . '/functions/template-tags.php';
// require get_template_directory() . '/functions/extras.php';
// require get_template_directory() . '/functions/customizer.php';
// require get_template_directory() . '/functions/woo-functions.php';
// require get_template_directory() . '/functions/breadcrumbs.php';
// if ( is_admin() ) {
// 	require get_template_directory() . '/functions/theme-help.php';
// }

} // End if(false) - DISABLED Exoplanet theme code
// =============================================================================
// ‚úÖ END OF DISABLED EXOPLANET THEME CODE
// =============================================================================
/*  
|--------------------------------------------------------------------------shorttrips-functions.php
| SHORTTRIPS SEARCH MODULE ‚Äì DEEL 1 / 3 (UI & Form)
|--------------------------------------------------------------------------
*/
add_shortcode('shorttrips_hotels', function () {
    ob_start(); ?>
    <!-- Tailwind + Flatpickr + TomSelect -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/js/tom-select.complete.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.4.1/dist/css/tom-select.css">

    <!-- ‚úÖ RESULTS CONTAINER ONLY (No search form ever shown) -->
    <div class="max-w-7xl mx-auto" style="max-width:100%;padding:20px;">

        <!-- Sort & Results Summary -->
        <div class="flex items-center justify-between mb-6"
            style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
            <h3 id="st-results-summary" class="text-sm text-gray-500" style="font-size:14px;color:#6b7280;"></h3>
            <div class="flex items-center gap-2" style="display:flex;align-items:center;gap:8px;">
                <label for="st-sort-select" class="text-sm text-gray-600"
                    style="font-size:14px;color:#4b5563;">Sorteer:</label>
                <select id="st-sort-select" class="border p-2 rounded"
                    style="border:1px solid #d1d5db;padding:8px 12px;border-radius:6px;">
                    <option value="price_asc">Prijs (laag ‚Üí hoog)</option>
                    <option value="rating_desc">Beoordeling (hoog ‚Üí laag)</option>
                    <option value="stars_desc">Sterren (hoog ‚Üí laag)</option>
                </select>
            </div>
        </div>

        <!-- Results Grid -->
        <div id="st-results" class="mt-4" style="margin-top:16px;"></div>

        <!-- Load More (hidden by default) -->
        <div class="text-center mt-4" style="text-align:center;margin-top:16px;">
            <button id="st-load-more" class="hidden bg-gray-100 border rounded px-4 py-2"
                style="display:none;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;padding:8px 16px;">Laad
                meer</button>
        </div>
    </div>

    <!-- Hidden forms for JavaScript compatibility (not visible but functions still work) -->
    <div style="display:none !important;visibility:hidden !important;height:0 !important;overflow:hidden !important;">
        <div id="st-tab-free" class="st-tabcontent">
            <form id="st-form-free" class="space-y-4">
                <input type="text" id="st-q" placeholder="Add a destination‚Ä¶" class="w-full border rounded px-3 py-2" />
                <div>
                    <label class="text-sm text-gray-600">Check-in and Check-out</label>
                    <input type="text" id="st-daterange-free" class="w-full border rounded px-3 py-2 text-center" readonly>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label for="st-rooms-free" class="block text-sm text-gray-600 mb-1">Rooms</label>
                        <input type="number" id="st-rooms-free" min="1" value="1" class="border rounded px-3 py-2 w-full" />
                    </div>
                    <div>
                        <label for="st-adults-free" class="block text-sm text-gray-600 mb-1">Adults</label>
                        <input type="number" id="st-adults-free" min="1" value="2"
                            class="border rounded px-3 py-2 w-full" />
                    </div>
                    <div>
                        <label for="st-children-free" class="block text-sm text-gray-600 mb-1">Children</label>
                        <input type="number" id="st-children-free" min="0" value="0"
                            class="border rounded px-3 py-2 w-full" />
                    </div>
                </div>
                <div id="st-ages-free" class="grid grid-cols-3 gap-3 hidden"></div>
                <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg">Find hotels</button>
            </form>
        </div>

        <div id="st-tab-advanced" class="st-tabcontent hidden">
            <form id="st-form-advanced" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <select id="st-country" class="border p-2 rounded w-full">
                        <option value="">Select country</option>
                    </select>
                    <select id="st-resort" class="border p-2 rounded w-full">
                        <option value="">Select region</option>
                    </select>
                </div>
                <input type="text" id="st-daterange-adv" class="w-full border rounded px-3 py-2 text-center" readonly>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label for="st-rooms-adv" class="block text-sm text-gray-600 mb-1">Rooms</label>
                        <input type="number" id="st-rooms-adv" min="1" value="1" class="border rounded px-3 py-2 w-full" />
                    </div>
                    <div>
                        <label for="st-adults-adv" class="block text-sm text-gray-600 mb-1">Adults</label>
                        <input type="number" id="st-adults-adv" min="1" value="2" class="border rounded px-3 py-2 w-full" />
                    </div>
                    <div>
                        <label for="st-children-adv" class="block text-sm text-gray-600 mb-1">Children</label>
                        <input type="number" id="st-children-adv" min="0" value="0"
                            class="border rounded px-3 py-2 w-full" />
                    </div>
                </div>
                <div id="st-ages-adv" class="grid grid-cols-3 gap-3 hidden"></div>
                <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg">Find hotels</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".st-tablink").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".st-tabcontent").forEach(el => el.classList.add("hidden"));
                    document.querySelector(btn.dataset.target).classList.remove("hidden");
                });
            });

            const fpFree = flatpickr("#st-daterange-free", { mode: "range", dateFormat: "Y-m-d" });
            const fpAdv = flatpickr("#st-daterange-adv", { mode: "range", dateFormat: "Y-m-d" });
            const ajaxurl = '<?= admin_url('admin-ajax.php'); ?>';

            // TomSelect instanties bewaren om herhaalde initialisatie te voorkomen
            let tsCountry = null;
            let tsResort = null;

            // ---- Landen laden ----
            fetch(`${ajaxurl}?action=shorttrips_get_countries`)
                .then(r => r.json())
                .then(data => {
                    const sel = document.getElementById('st-country');
                    sel.innerHTML = '<option value="">Select country</option>';
                    data.forEach(row => {
                        const o = document.createElement('option');
                        o.value = row.country_id;
                        o.text = row.country_name;
                        sel.appendChild(o);
                    });
                    // Vernietig oude instantie als die bestaat
                    if (tsCountry) tsCountry.destroy();
                    tsCountry = new TomSelect('#st-country', { create: false, maxOptions: 5000 });
                });

            // ---- Regio's laden na selectie land ----
            document.getElementById('st-country').addEventListener('change', () => {
                const id = document.getElementById('st-country').value;
                if (!id) {
                    // Reset regio select als land wordt gewist
                    const s = document.getElementById('st-resort');
                    s.innerHTML = '<option value="">Select region</option>';
                    if (tsResort) { tsResort.destroy(); tsResort = null; }
                    return;
                }
                fetch(`${ajaxurl}?action=shorttrips_get_resorts&country_id=${id}`)
                    .then(r => r.json())
                    .then(data => {
                        console.log('üèôÔ∏è RESORTS ONTVANGEN:', data.length, 'steden');
                        console.log('Eerste stad:', data[0]?.destination_name);
                        console.log('Laatste stad:', data[data.length - 1]?.destination_name);

                        const s = document.getElementById('st-resort');
                        s.innerHTML = '<option value="">Select region</option>';

                        let added = 0;
                        data.forEach(r => {
                            const o = document.createElement('option');
                            o.value = r.destination_id;
                            o.text = r.destination_name;
                            s.appendChild(o);
                            added++;
                        });

                        console.log('‚úÖ TOEGEVOEGD AAN DROPDOWN:', added, 'options');
                        console.log('Total options in select:', s.options.length);

                        // Vernietig oude instantie als die bestaat
                        if (tsResort) tsResort.destroy();
                        tsResort = new TomSelect('#st-resort', { create: false, maxOptions: 5000 });

                        console.log('‚úÖ TomSelect ge√Ønitialiseerd');
                    });
            });

            // ---- Zoekfunctie ----
            function buildAgeInputs(containerId, count) {
                const c = document.getElementById(containerId);
                if (!c) return [];
                c.innerHTML = '';
                count = Math.max(0, Math.min(parseInt(count || 0, 10) || 0, 8));
                if (count === 0) { c.classList.add('hidden'); return []; }
                c.classList.remove('hidden');
                const selects = [];
                for (let i = 0; i < count; i++) {
                    const wrap = document.createElement('div');
                    wrap.className = 'flex items-center gap-2';
                    const lab = document.createElement('label');
                    lab.className = 'text-sm text-gray-600 whitespace-nowrap';
                    lab.textContent = `Leeftijd kind ${i + 1}`;
                    const sel = document.createElement('select');
                    sel.className = 'border rounded px-3 py-2 w-full';
                    for (let a = 0; a <= 17; a++) {
                        const opt = document.createElement('option');
                        opt.value = String(a);
                        opt.textContent = String(a);
                        if (a === 5) opt.selected = true;
                        sel.appendChild(opt);
                    }
                    wrap.appendChild(lab);
                    wrap.appendChild(sel);
                    c.appendChild(wrap);
                    selects.push(sel);
                }
                return selects;
            }

            // Dynamische age inputs bij wijziging kinderen
            const chFree = document.getElementById('st-children-free');
            if (chFree) {
                const updateFreeAges = () => buildAgeInputs('st-ages-free', chFree.value);
                chFree.addEventListener('input', updateFreeAges);
                updateFreeAges();
            }
            const chAdv = document.getElementById('st-children-adv');
            if (chAdv) {
                const updateAdvAges = () => buildAgeInputs('st-ages-adv', chAdv.value);
                chAdv.addEventListener('input', updateAdvAges);
                updateAdvAges();
            }

            function collectAges(containerId) {
                const c = document.getElementById(containerId);
                if (!c) return '';
                const values = Array.from(c.querySelectorAll('select')).map(s => parseInt(s.value || '0', 10) || 0);
                return values.join(',');
            }

            function stInitResults() {
                const grid = document.querySelector('#st-results .st-hotel-grid');
                const summary = document.getElementById('st-results-summary');
                const loadMoreBtn = document.getElementById('st-load-more');
                if (!grid) { summary && (summary.textContent = ''); loadMoreBtn && loadMoreBtn.classList.add('hidden'); return; }
                const items = Array.from(grid.querySelectorAll('.st-hotel-card'));
                const total = items.length;
                summary && (summary.textContent = total > 0 ? `${total} hotels found` : '');

                let batch = 9999; // show all from current server page
                let shown = 0;
                function applyVisibility() {
                    items.forEach((el, idx) => { el.style.display = (idx < shown) ? '' : 'none'; });
                    if (shown < total) { loadMoreBtn.classList.remove('hidden'); } else { loadMoreBtn.classList.add('hidden'); }
                }
                shown = Math.min(batch, total);
                applyVisibility();
                loadMoreBtn.onclick = () => { shown = Math.min(shown + batch, total); applyVisibility(); };

                function sortBy(mode) {
                    const getNum = (el, attr) => { const v = parseFloat(el.getAttribute(attr) || '0'); return isNaN(v) ? 0 : v; };
                    items.sort((a, b) => {
                        if (mode === 'price_asc') {
                            return getNum(a, 'data-price') - getNum(b, 'data-price');
                        } else if (mode === 'rating_desc') {
                            return getNum(b, 'data-rating') - getNum(a, 'data-rating');
                        } else if (mode === 'stars_desc') {
                            return getNum(b, 'data-stars') - getNum(a, 'data-stars');
                        }
                        return 0;
                    });
                    items.forEach(el => grid.appendChild(el));
                    shown = Math.min(batch, total);
                    applyVisibility();
                }

                const sortSel = document.getElementById('st-sort-select');
                if (sortSel) {
                    sortSel.onchange = () => sortBy(sortSel.value);
                    sortBy(sortSel.value);
                }

                // Bind pager clicks within results container
                const resWrap = document.getElementById('st-results');
                if (resWrap && !resWrap.__stPagerBound) {
                    resWrap.__stPagerBound = true;
                    resWrap.addEventListener('click', function (e) {
                        const a = e.target && e.target.closest ? e.target.closest('.st-pager .st-page') : null;
                        if (!a) return;
                        e.preventDefault();
                        const p = parseInt(a.getAttribute('data-page') || '1', 10) || 1;
                        if (window.stSetPage) { window.stSetPage(p); }
                    });
                }
            }

            function postSearch(p) {
                const res = document.getElementById('st-results');
                if (!res) {
                    console.error('‚ùå #st-results element not found!');
                    return;
                }

                res.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Hotels ophalen...</p></div>';

                const fd = new FormData();
                for (const k in p) {
                    const v = p[k];
                    if (Array.isArray(v)) {
                        v.forEach(val => fd.append(k + '[]', val));
                    } else if (v !== null && v !== undefined && v !== '') {
                        fd.append(k, v);
                    }
                }

                window.stLastSearchPayload = Object.assign({}, p);

                console.log('üîç Fetching hotels with payload:', p);
                console.log('üåê AJAX URL:', ajaxurl);

                fetch(ajaxurl, { method: 'POST', body: fd, credentials: 'same-origin' })
                    .then(r => {
                        console.log('üì° Response status:', r.status);
                        if (!r.ok) {
                            throw new Error('HTTP error ' + r.status);
                        }
                        return r.text();
                    })
                    .then(html => {
                        console.log('üì¶ Received HTML length:', html.length);
                        console.log('üìÑ First 500 chars:', html.substring(0, 500));

                        if (!html || html.trim() === '' || html.trim() === '0') {
                            console.warn('‚ö†Ô∏è Empty response received');
                            res.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Geen hotels gevonden voor deze zoekopdracht</p></div>';
                            return;
                        }

                        // Check for error messages
                        if (html.includes('WordPress databasefout') || html.includes('Fatal error')) {
                            console.error('‚ùå Server error in response:', html.substring(0, 1000));
                            res.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Er is een serverfout opgetreden</p></div>';
                            return;
                        }

                        console.log('‚úÖ Rendering hotels HTML');
                        res.innerHTML = html;
                        stInitResults();

                        var inlineSidebar = document.getElementById('st-inline-filters');
                        if (inlineSidebar) {
                            inlineSidebar.style.display = 'block';
                            var wrapper = inlineSidebar.querySelector('[data-st-filters-root]');
                            if (wrapper) {
                                wrapper.style.display = 'block';
                            }
                        }
                    })
                    .catch(err => {
                        res.innerHTML = '<p class="text-red-500 text-center py-8">‚ùå Er is een fout opgetreden bij het ophalen van hotels. Probeer het opnieuw.</p>';
                        console.error('‚ùå Search error:', err);
                    });
            }

            // Pagination helper reusable by server-rendered pager
            window.stSetPage = function (page) {
                if (!window.stLastSearchPayload) return;
                const payload = Object.assign({}, window.stLastSearchPayload);
                payload.page = page || 1;
                postSearch(payload);
            };

            document.getElementById('st-form-free').addEventListener('submit', e => {
                e.preventDefault();
                postSearch({
                    action: 'shorttrips_search_hotels',
                    type: 'free',
                    q: document.getElementById('st-q').value,
                    checkin: fpFree.selectedDates[0]?.toISOString().slice(0, 10) ?? '',
                    checkout: fpFree.selectedDates[1]?.toISOString().slice(0, 10) ?? '',
                    rooms: document.getElementById('st-rooms-free').value,
                    adults: document.getElementById('st-adults-free').value,
                    children: document.getElementById('st-children-free').value,
                    child_ages: collectAges('st-ages-free'),
                    page: 1
                });
            });

            document.getElementById('st-form-advanced').addEventListener('submit', e => {
                e.preventDefault();
                postSearch({
                    action: 'shorttrips_search_hotels',
                    type: 'advanced',
                    country: document.getElementById('st-country').value,
                    resort: document.getElementById('st-resort').value,
                    checkin: fpAdv.selectedDates[0]?.toISOString().slice(0, 10) ?? '',
                    checkout: fpAdv.selectedDates[1]?.toISOString().slice(0, 10) ?? '',
                    rooms: document.getElementById('st-rooms-adv').value,
                    adults: document.getElementById('st-adults-adv').value,
                    children: document.getElementById('st-children-adv').value,
                    child_ages: collectAges('st-ages-adv'),
                    page: 1
                });
            });

            // Auto-run search on page load if URL contains search params (from header search or old form)
            (function () {
                console.log('üîé Auto-run check starting...');
                console.log('üìç Current URL:', window.location.href);

                var params = new URLSearchParams(window.location.search);
                console.log('üîó URL params:', Object.fromEntries(params));

                var hasQuery = params.has('q') || params.has('country') || params.has('resort') || params.has('country_name');

                console.log('‚úì Has query params?', hasQuery);

                if (!hasQuery) {
                    console.log('‚ÑπÔ∏è No search parameters in URL - skipping auto-run');
                    return; // No search data
                }

                // Build payload from URL params
                var type = params.get('type') || (params.get('q') ? 'free' : params.has('country_name') ? 'country' : 'advanced');
                var payload = {
                    action: 'shorttrips_search_hotels',
                    type: type,
                    q: params.get('q') || '',
                    country: params.get('country') || '',
                    country_name: params.get('country_name') || '',
                    resort: params.get('resort') || '',
                    checkin: params.get('checkin') || '',
                    checkout: params.get('checkout') || '',
                    rooms: params.get('rooms') || '1',
                    adults: params.get('adults') || '2',
                    children: params.get('children') || '0',
                    child_ages: params.get('child_ages') || '',
                    nights: params.get('nights') || '',
                    date_flexibility: params.get('date_flexibility') || '0',
                    page: parseInt(params.get('page') || '1', 10) || 1
                };

                console.log('üì¨ URL parameters detected:', Object.fromEntries(params));
                console.log('‚úÖ Built payload:', payload);

                // Optional filters
                var optKeys = ['minStars', 'maxStars', 'minPrice', 'maxPrice', 'excludeSharedRooms', 'excludeSharedFacilities'];
                optKeys.forEach(function (k) { var v = params.get(k); if (v !== null && v !== '') { payload[k] = v; } });
                var multiKeys = ['featureIds', 'themeIds', 'mealIds'];
                multiKeys.forEach(function (k) { var arr = params.getAll(k + '[]'); if (arr && arr.length) { payload[k] = arr; } });

                // Prefill simple fields for UX
                try {
                    if (payload.type === 'free' && document.getElementById('st-q')) {
                        document.getElementById('st-q').value = payload.q || '';
                    }
                    if (payload.checkin && payload.checkout) {
                        if (fpFree && fpFree.setDate) fpFree.setDate([payload.checkin, payload.checkout], true);
                        if (fpAdv && fpAdv.setDate) fpAdv.setDate([payload.checkin, payload.checkout], true);
                    }
                    if (document.getElementById('st-rooms-free')) document.getElementById('st-rooms-free').value = payload.rooms;
                    if (document.getElementById('st-adults-free')) document.getElementById('st-adults-free').value = payload.adults;
                    if (document.getElementById('st-children-free')) document.getElementById('st-children-free').value = payload.children;
                } catch (err) {
                    console.warn('‚ö†Ô∏è Error prefilling fields:', err);
                }

                console.log('üöÄ Calling postSearch() with:', payload);

                // Verify postSearch exists
                if (typeof postSearch !== 'function') {
                    console.error('‚ùå postSearch function not defined!');
                    return;
                }

                // Verify #st-results exists
                if (!document.getElementById('st-results')) {
                    console.error('‚ùå #st-results element not found in DOM!');
                    return;
                }

                postSearch(payload);
            })();
        });
    </script>
    <?php
    return ob_get_clean();
});

/*  
|--------------------------------------------------------------------------
| SHORTTRIPS ‚Äì Landen & regio's AJAX endpoints
|--------------------------------------------------------------------------
*/
add_action('wp_ajax_shorttrips_get_countries', 'shorttrips_get_countries');
add_action('wp_ajax_nopriv_shorttrips_get_countries', 'shorttrips_get_countries');
function shorttrips_get_countries()
{
    global $wpdb;
    $rows = $wpdb->get_results("
    SELECT DISTINCT country_id, country_name
    FROM bravo_destinations
    WHERE deleted_at IS NULL
      AND country_name IS NOT NULL AND country_name <> ''
    ORDER BY country_name ASC
  ", ARRAY_A);
    wp_send_json($rows);
}
// ---- Availability (NonStatic) with caching for cards and prebook ----
add_action('wp_ajax_shorttrips_get_availability', 'shorttrips_get_availability');
add_action('wp_ajax_nopriv_shorttrips_get_availability', 'shorttrips_get_availability');
function shorttrips_get_availability()
{
    $hotelId = intval($_REQUEST['hotelId'] ?? 0);
    $checkin = sanitize_text_field($_REQUEST['checkin'] ?? '');
    $checkout = sanitize_text_field($_REQUEST['checkout'] ?? '');
    $rooms = max(1, intval($_REQUEST['rooms'] ?? 1));
    $adults = max(1, intval($_REQUEST['adults'] ?? 2));
    $children = max(0, intval($_REQUEST['children'] ?? 0));
    $childAgesStr = sanitize_text_field($_REQUEST['child_ages'] ?? '');
    $childAges = array_values(array_filter(array_map('intval', array_filter(array_map('trim', explode(',', $childAgesStr)))), function ($v) {
        return $v >= 0 && $v <= 17; }));
    if ($children > 0 && count($childAges) < $children) {
        $childAges = array_pad($childAges, $children, 0);
    }
    if ($hotelId <= 0 || $checkin === '' || $checkout === '') {
        wp_send_json_success(['best_price' => 0, 'badges_html' => '']);
    }

    $cacheKey = 'st_av2_' . implode('_', [$hotelId, $checkin, $checkout, $rooms, $adults, $children, implode('-', $childAges)]);

    // Clear cache if nocache parameter is set
    if (isset($_GET['nocache']) || isset($_POST['nocache'])) {
        delete_transient($cacheKey);
    }

    $cached = get_transient($cacheKey);
    if (is_array($cached)) {
        wp_send_json_success($cached);
    }

    $params = [
        'hotelId' => $hotelId,
        'checkInDate' => $checkin,
        'checkOutDate' => $checkout,
        'numberOfRooms' => $rooms,
        'numberOfAdults' => $adults,
        'numberOfChildren' => $children,
        'showRoomTypeName' => 'true',
        'showReviews' => 'true',
        'b2c' => 'false',
        'blockSuperDeal' => 'true',
        'deals' => '0'      // Explicitly disable deals
    ];
    if (!empty($childAges)) {
        $params['childrenAges'] = implode(',', $childAges);
    }

    $xml = shorttrips_call_nonstatic_xml('GetAvailableHotelV2', $params);
    if (!$xml) {
        wp_send_json_success(['best_price' => 0, 'badges_html' => '']);
    }
    $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

    $best = null;
    $hasFree = false;
    $hasPartial = false;
    $hasBreakfast = false;
    $isDeal = false;
    $roomsNodes = $xml->xpath('//sh:rooms//sh:room | //rooms//room');
    if ($roomsNodes) {
        foreach ($roomsNodes as $r) {
            $priceVal = null;
            if (isset($r->pricevalue) && (string) $r->pricevalue !== '') {
                $priceVal = (float) $r->pricevalue;
            } elseif (isset($r->price) && (string) $r->price !== '') {
                $priceVal = (float) $r->price;
            }
            if ($priceVal !== null) {
                if ($best === null || $priceVal < $best)
                    $best = $priceVal;
            }
            // Meals
            if (isset($r->meals->meal)) {
                foreach ($r->meals->meal as $m) {
                    $mn = (string) ($m->name ?? '');
                    if ($mn !== '' && stripos($mn, 'breakfast') !== false)
                        $hasBreakfast = true;
                }
            }
            // Cancellation
            if (isset($r->cancellation_policies->cancellation_policy)) {
                foreach ($r->cancellation_policies->cancellation_policy as $cp) {
                    $pct = isset($cp->percentage) ? (float) $cp->percentage : null;
                    if ($pct === 0.0)
                        $hasFree = true;
                    if ($pct !== null && $pct > 0 && $pct < 100)
                        $hasPartial = true;
                }
            }
            if (isset($r->isSuperDeal) && ((string) $r->isSuperDeal) === 'true')
                $isDeal = true;
            if (isset($r->isBestBuy) && ((string) $r->isBestBuy) === 'true')
                $isDeal = true;
        }
    }

    $badges = [];
    if ($hasFree)
        $badges[] = '<span class="inline-block bg-emerald-100 text-emerald-800 text-xs font-medium px-2 py-0.5 rounded mb-1">Gratis annuleren</span>';
    elseif ($hasPartial)
        $badges[] = '<span class="inline-block bg-amber-100 text-amber-800 text-xs font-medium px-2 py-0.5 rounded mb-1">Gedeeltelijk restitueerbaar</span>';
    if ($hasBreakfast)
        $badges[] = '<span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded mb-1">Ontbijt inbegrepen</span>';
    if ($isDeal)
        $badges[] = '<span class="inline-block bg-purple-100 text-purple-800 text-xs font-medium px-2 py-0.5 rounded mb-1">Deal</span>';
    $bestDisplay = ($best !== null && $best > 0) ? number_format($best * 1.16 * 1.09, 2, ',', '.') . ' ‚Ç¨' : '';
    $out = ['best_price' => ($best !== null ? $best : 0), 'best_price_text' => ($bestDisplay ?: ''), 'badges_html' => implode('', $badges)];
    set_transient($cacheKey, $out, 30 * MINUTE_IN_SECONDS);
    wp_send_json_success($out);
}
add_action('wp_ajax_shorttrips_get_resorts', 'shorttrips_get_resorts');
add_action('wp_ajax_nopriv_shorttrips_get_resorts', 'shorttrips_get_resorts');
function shorttrips_get_resorts()
{
    global $wpdb;
    $cid = intval($_GET['country_id'] ?? 0);
    if ($cid <= 0)
        wp_send_json([]);
    $rows = $wpdb->get_results($wpdb->prepare("
    SELECT destination_id, destination_name
    FROM bravo_destinations
    WHERE deleted_at IS NULL AND country_id=%d
    ORDER BY destination_name ASC
  ", $cid), ARRAY_A);
    wp_send_json($rows);
}

if (!function_exists('shorttrips_show_transfers_widget')) {
    function shorttrips_show_transfers_widget()
    {
        $enabled = get_option('shorttrips_enable_transfers_widget', 'no');
        return apply_filters('shorttrips_show_transfers_widget', $enabled === 'yes');
    }
}

if (!function_exists('shorttrips_transfer_tables_ready')) {
    function shorttrips_transfer_tables_ready($table = 'ghwk_transfer_cache')
    {
        static $status = [];
        if (isset($status[$table])) {
            return $status[$table];
        }
        global $wpdb;
        $status[$table] = (bool) $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table));
        return $status[$table];
    }
}

if (!function_exists('shorttrips_get_transfer_cache')) {
    function shorttrips_get_transfer_cache($key)
    {
        $runtime = get_transient($key);
        if (is_array($runtime)) {
            $runtime['from_cache'] = true;
            return $runtime;
        }
        if (!shorttrips_transfer_tables_ready('ghwk_transfer_cache')) {
            return null;
        }
        global $wpdb;
        $row = $wpdb->get_row($wpdb->prepare("SELECT response_payload FROM ghwk_transfer_cache WHERE cache_key = %s AND expires_at > NOW()", $key), ARRAY_A);
        if (!$row || empty($row['response_payload'])) {
            return null;
        }
        $payload = json_decode($row['response_payload'], true);
        if (!is_array($payload)) {
            return null;
        }
        set_transient($key, $payload, shorttrips_transfer_cache_ttl());
        $payload['from_cache'] = true;
        return $payload;
    }
}

if (!function_exists('shorttrips_get_lookup_options_generic')) {
    function shorttrips_get_lookup_options_generic($table, $cacheKey, array $compatKeys = [], $force = false, ?callable $fallback = null)
    {
        if (!$force) {
            $cached = get_transient($cacheKey);
            if (is_array($cached)) {
                return $cached;
            }
        }
        global $wpdb;
        $options = [];
        if ($wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table))) {
            $rows = $wpdb->get_results("SELECT id, COALESCE(name, nameIndex) AS name FROM {$table} ORDER BY name ASC", ARRAY_A);
            if ($rows) {
                foreach ($rows as $row) {
                    $id = intval($row['id']);
                    $name = trim((string) $row['name']);
                    if ($id > 0 && $name !== '') {
                        $options[$id] = $name;
                    }
                }
            }
        }
        if (empty($options) && $fallback) {
            $options = (array) call_user_func($fallback);
        }
        if (!empty($options)) {
            asort($options, SORT_NATURAL | SORT_FLAG_CASE);
            set_transient($cacheKey, $options, DAY_IN_SECONDS);
            foreach ($compatKeys as $compat) {
                set_transient($compat, $options, DAY_IN_SECONDS);
            }
        }
        return $options;
    }
}

if (!function_exists('shorttrips_get_feature_options')) {
    function shorttrips_get_feature_options($force = false)
    {
        return shorttrips_get_lookup_options_generic('ghwk_features', 'shorttrips_lookup_features', ['st_filters_features'], $force, static function () {
            global $wpdb;
            $out = [];
            $rows = $wpdb->get_results("SELECT features_json FROM ghwk_bravo_hotels WHERE features_json IS NOT NULL AND features_json <> '' LIMIT 5000", ARRAY_A);
            if ($rows) {
                foreach ($rows as $row) {
                    $fj = json_decode($row['features_json'], true);
                    if (!is_array($fj)) {
                        continue;
                    }
                    foreach ($fj as $feature) {
                        $id = isset($feature['id']) ? intval($feature['id']) : 0;
                        $name = isset($feature['name']) ? (string) $feature['name'] : '';
                        if ($id > 0 && $name !== '') {
                            $out[$id] = $name;
                        }
                    }
                }
            }
            return $out;
        });
    }
}

if (!function_exists('shorttrips_get_theme_options')) {
    function shorttrips_get_theme_options($force = false)
    {
        return shorttrips_get_lookup_options_generic('ghwk_themes', 'shorttrips_lookup_themes', ['st_filters_themes'], $force, static function () {
            global $wpdb;
            $out = [];
            $rows = $wpdb->get_results("SELECT themes_json FROM ghwk_bravo_hotels WHERE themes_json IS NOT NULL AND themes_json <> '' LIMIT 5000", ARRAY_A);
            if ($rows) {
                foreach ($rows as $row) {
                    $tj = json_decode($row['themes_json'], true);
                    if (!is_array($tj)) {
                        continue;
                    }
                    foreach ($tj as $theme) {
                        $id = isset($theme['id']) ? intval($theme['id']) : 0;
                        $name = isset($theme['name']) ? (string) $theme['name'] : '';
                        if ($id > 0 && $name !== '') {
                            $out[$id] = $name;
                        }
                    }
                }
            }
            return $out;
        });
    }
}

if (!function_exists('shorttrips_get_meal_options')) {
    function shorttrips_get_meal_options($force = false)
    {
        return shorttrips_get_lookup_options_generic('ghwk_meals', 'shorttrips_lookup_meals', ['st_filters_meals'], $force);
    }
}

if (!function_exists('shorttrips_get_language_options')) {
    function shorttrips_get_language_options($force = false)
    {
        return shorttrips_get_lookup_options_generic('ghwk_languages', 'shorttrips_lookup_languages', [], $force);
    }
}

if (!function_exists('shorttrips_get_booking_info')) {
    function shorttrips_get_booking_info($bookingNumber, array $args = [])
    {
        $params = [
            'bookingID' => sanitize_text_field($bookingNumber),
        ];
        if (!empty($args['created_from'])) {
            $params['createdDateFrom'] = sanitize_text_field($args['created_from']);
        }
        if (!empty($args['created_to'])) {
            $params['createdDateTo'] = sanitize_text_field($args['created_to']);
        }
        $response = shorttrips_call_nonstatic_soap('GetBookingInformationV3', $params, ['timeout' => 60]);
        if (is_wp_error($response)) {
            return $response;
        }
        $xml = $response['xml'];
        $booking = $xml->xpath('//soap:Body//sh:getBookingInformationResult | //soap:Body//sh:GetBookingInformationV3Result');
        if (!$booking || empty($booking[0])) {
            return new WP_Error('sunhotels_no_booking', 'Geen boekingsgegevens gevonden bij Sunhotels.');
        }
        $result = json_decode(json_encode($booking[0]), true);
        return [
            'success' => true,
            'data' => $result,
        ];
    }
}

if (!function_exists('shorttrips_cancel_booking')) {
    function shorttrips_cancel_booking($bookingNumber, array $args = [])
    {
        $params = [
            'bookingNumber' => sanitize_text_field($bookingNumber),
        ];
        if (!empty($args['reason'])) {
            $params['reason'] = sanitize_text_field($args['reason']);
        }
        $response = shorttrips_call_nonstatic_soap('CancelBooking', $params, ['timeout' => 60]);
        if (is_wp_error($response)) {
            return $response;
        }
        $xml = $response['xml'];
        $errorNode = $xml->xpath('//soap:Body//sh:Error//sh:Message | //soap:Body//Error//Message');
        if ($errorNode && !empty($errorNode[0])) {
            return new WP_Error('sunhotels_cancel_failed', trim((string) $errorNode[0]));
        }
        return ['success' => true];
    }
}

if (!function_exists('shorttrips_amendment_price_request')) {
    function shorttrips_amendment_price_request(array $params)
    {
        $required = ['bookingNumber', 'checkInDate', 'checkOutDate'];
        foreach ($required as $field) {
            if (empty($params[$field])) {
                return new WP_Error('sunhotels_missing_param', 'Ontbrekende parameter: ' . $field);
            }
        }
        $soapParams = [
            'bookingNumber' => sanitize_text_field($params['bookingNumber']),
            'checkInDate' => sanitize_text_field($params['checkInDate']),
            'checkOutDate' => sanitize_text_field($params['checkOutDate']),
            'rooms' => intval($params['rooms'] ?? 1),
            'adults' => intval($params['adults'] ?? 2),
            'children' => intval($params['children'] ?? 0),
        ];
        $response = shorttrips_call_nonstatic_soap('AmendmentPriceRequest', $soapParams, ['timeout' => 60]);
        if (is_wp_error($response)) {
            return $response;
        }
        $xml = $response['xml'];
        $errorNode = $xml->xpath('//soap:Body//sh:Error//sh:Message | //soap:Body//Error//Message');
        if ($errorNode && !empty($errorNode[0])) {
            return new WP_Error('sunhotels_amendment_error', trim((string) $errorNode[0]));
        }
        $priceNode = $xml->xpath('//soap:Body//sh:amendmentPriceRequestResult | //soap:Body//sh:AmendmentPriceRequestResponse');
        return [
            'success' => true,
            'data' => json_decode(json_encode($priceNode[0] ?? []), true),
        ];
    }
}

if (!function_exists('shorttrips_amendment_request')) {
    function shorttrips_amendment_request(array $params)
    {
        $required = ['bookingNumber', 'checkInDate', 'checkOutDate'];
        foreach ($required as $field) {
            if (empty($params[$field])) {
                return new WP_Error('sunhotels_missing_param', 'Ontbrekende parameter: ' . $field);
            }
        }
        $soapParams = [
            'bookingNumber' => sanitize_text_field($params['bookingNumber']),
            'checkInDate' => sanitize_text_field($params['checkInDate']),
            'checkOutDate' => sanitize_text_field($params['checkOutDate']),
            'rooms' => intval($params['rooms'] ?? 1),
            'adults' => intval($params['adults'] ?? 2),
            'children' => intval($params['children'] ?? 0),
        ];
        $response = shorttrips_call_nonstatic_soap('AmendmentRequest', $soapParams, ['timeout' => 60]);
        if (is_wp_error($response)) {
            return $response;
        }
        $xml = $response['xml'];
        $errorNode = $xml->xpath('//soap:Body//sh:Error//sh:Message | //soap:Body//Error//Message');
        if ($errorNode && !empty($errorNode[0])) {
            return new WP_Error('sunhotels_amendment_error', trim((string) $errorNode[0]));
        }
        return [
            'success' => true,
            'data' => json_decode(json_encode($xml->xpath('//soap:Body//sh:amendmentRequestResult')[0] ?? []), true),
        ];
    }
}

if (!defined('SHORTTRIPS_SUNHOTELS_NOTICE_KEY')) {
    define('SHORTTRIPS_SUNHOTELS_NOTICE_KEY', 'shorttrips_sunhotels_notice_');
}

if (!defined('SHORTTRIPS_SUNHOTELS_META_BOOKING')) {
    define('SHORTTRIPS_SUNHOTELS_META_BOOKING', '_sunhotels_booking_reference');
}

add_action('add_meta_boxes', function () {
    add_meta_box(
        'shorttrips-sunhotels-tools',
        __('Sunhotels beheer', 'shorttrips'),
        'shorttrips_render_sunhotels_metabox',
        'shop_order',
        'side',
        'default'
    );
});

function shorttrips_render_sunhotels_metabox($post)
{
    $order = wc_get_order($post->ID);
    if (!$order) {
        echo '<p>' . esc_html__('Order niet gevonden.', 'shorttrips') . '</p>';
        return;
    }
    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    $status = $order->get_meta('_sunhotels_last_status');
    ?>
    <p style="margin-bottom:8px;">
        <strong><?php esc_html_e('Sunhotels referentie:', 'shorttrips'); ?></strong><br>
        <?php echo $bookingRef ? esc_html($bookingRef) : '<em>' . esc_html__('Niet beschikbaar', 'shorttrips') . '</em>'; ?>
    </p>
    <?php if ($status): ?>
        <p style="margin-bottom:8px;">
            <strong><?php esc_html_e('Laatste status:', 'shorttrips'); ?></strong><br>
            <code><?php echo esc_html($status); ?></code>
        </p>
    <?php endif; ?>
    <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" style="margin-bottom:10px;">
        <?php wp_nonce_field('shorttrips_sunhotels_order', 'shorttrips_sunhotels_nonce'); ?>
        <input type="hidden" name="action" value="shorttrips_sunhotels_order_action">
        <input type="hidden" name="order_id" value="<?php echo esc_attr($post->ID); ?>">
        <input type="hidden" name="sunhotels_action" value="fetch">
        <button type="submit" class="button button-secondary"
            style="width:100%;margin-bottom:4px;"><?php esc_html_e('Status ophalen', 'shorttrips'); ?></button>
    </form>
    <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>"
        onsubmit="return confirm('<?php echo esc_js(__('Weet je zeker dat je deze Sunhotels-boeking wilt annuleren?', 'shorttrips')); ?>');">
        <?php wp_nonce_field('shorttrips_sunhotels_order', 'shorttrips_sunhotels_nonce'); ?>
        <input type="hidden" name="action" value="shorttrips_sunhotels_order_action">
        <input type="hidden" name="order_id" value="<?php echo esc_attr($post->ID); ?>">
        <input type="hidden" name="sunhotels_action" value="cancel">
        <button type="submit" class="button button-secondary"
            style="width:100%;"><?php esc_html_e('Boeking annuleren', 'shorttrips'); ?></button>
    </form>
    <p style="font-size:11px;color:#6b7280;">
        <?php esc_html_e('Deze acties gebruiken live Sunhotels-data. Resultaten worden als ordernotitie opgeslagen.', 'shorttrips'); ?>
    </p>
    <?php
}

add_action('admin_post_shorttrips_sunhotels_order_action', function () {
    if (!current_user_can('edit_shop_orders')) {
        wp_die(__('Geen toestemming.', 'shorttrips'));
    }
    check_admin_referer('shorttrips_sunhotels_order', 'shorttrips_sunhotels_nonce');
    $orderId = intval($_POST['order_id'] ?? 0);
    $action = sanitize_text_field($_POST['sunhotels_action'] ?? '');
    $order = wc_get_order($orderId);
    if (!$order) {
        shorttrips_set_sunhotels_notice('error', __('Order niet gevonden.', 'shorttrips'));
        shorttrips_redirect_back();
    }
    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    if (!$bookingRef) {
        shorttrips_set_sunhotels_notice('error', __('Geen Sunhotels referentie gevonden bij deze order.', 'shorttrips'));
        shorttrips_redirect_back();
    }
    if ($action === 'fetch') {
        $result = shorttrips_get_booking_info($bookingRef);
        if (is_wp_error($result)) {
            shorttrips_set_sunhotels_notice('error', $result->get_error_message());
        } else {
            $order->update_meta_data('_sunhotels_last_status', maybe_serialize($result['data']));
            $order->add_order_note(sprintf(__('Sunhotels status: %s', 'shorttrips'), print_r($result['data'], true)));
            $order->save();
            shorttrips_set_sunhotels_notice('updated', __('Status succesvol opgehaald.', 'shorttrips'));
        }
    } elseif ($action === 'cancel') {
        $result = shorttrips_cancel_booking($bookingRef);
        if (is_wp_error($result)) {
            shorttrips_set_sunhotels_notice('error', $result->get_error_message());
        } else {
            $order->update_status('cancelled', __('Sunhotels: booking geannuleerd.', 'shorttrips'));
            shorttrips_set_sunhotels_notice('updated', __('Boeking geannuleerd bij Sunhotels.', 'shorttrips'));
        }
    } else {
        shorttrips_set_sunhotels_notice('error', __('Onbekende actie.', 'shorttrips'));
    }
    shorttrips_redirect_back();
});

function shorttrips_set_sunhotels_notice($type, $message)
{
    set_transient(SHORTTRIPS_SUNHOTELS_NOTICE_KEY . get_current_user_id(), [
        'type' => $type,
        'message' => $message,
    ], 60);
}

function shorttrips_redirect_back()
{
    $referer = wp_get_referer();
    wp_safe_redirect($referer ? $referer : admin_url('edit.php?post_type=shop_order'));
    exit;
}

add_action('admin_notices', function () {
    $key = SHORTTRIPS_SUNHOTELS_NOTICE_KEY . get_current_user_id();
    $notice = get_transient($key);
    if (!$notice) {
        return;
    }
    delete_transient($key);
    $class = $notice['type'] === 'error' ? 'notice notice-error' : 'notice notice-success';
    printf('<div class="%s"><p>%s</p></div>', esc_attr($class), esc_html($notice['message']));
});

add_filter('woocommerce_order_actions', function ($actions) {
    $actions['shorttrips_sunhotels_fetch'] = __('Sunhotels status ophalen', 'shorttrips');
    $actions['shorttrips_sunhotels_cancel'] = __('Sunhotels boeking annuleren', 'shorttrips');
    return $actions;
});

add_action('woocommerce_order_action_shorttrips_sunhotels_fetch', function ($order) {
    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    if (!$bookingRef) {
        $order->add_order_note(__('Sunhotels: geen referentie beschikbaar, actie afgebroken.', 'shorttrips'), false, true);
        return;
    }
    $result = shorttrips_get_booking_info($bookingRef);
    if (is_wp_error($result)) {
        $order->add_order_note(sprintf(__('Sunhotels status mislukt: %s', 'shorttrips'), $result->get_error_message()), false, true);
        return;
    }
    $order->update_meta_data('_sunhotels_last_status', maybe_serialize($result['data']));
    $order->add_order_note(sprintf(__('Sunhotels status: %s', 'shorttrips'), print_r($result['data'], true)), false, true);
    $order->save();
});

add_action('woocommerce_order_action_shorttrips_sunhotels_cancel', function ($order) {
    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    if (!$bookingRef) {
        $order->add_order_note(__('Sunhotels: geen referentie beschikbaar, annuleren afgebroken.', 'shorttrips'), false, true);
        return;
    }
    $result = shorttrips_cancel_booking($bookingRef);
    if (is_wp_error($result)) {
        $order->add_order_note(sprintf(__('Sunhotels annuleren mislukt: %s', 'shorttrips'), $result->get_error_message()), false, true);
        return;
    }
    $order->update_status('cancelled', __('Sunhotels: booking geannuleerd via WooCommerce actie.', 'shorttrips'));
});

add_filter('woocommerce_order_actions', function ($actions) {
    $actions['shorttrips_sunhotels_amend_quote'] = __('Sunhotels wijziging aanvragen (prijs)', 'shorttrips');
    $actions['shorttrips_sunhotels_amend_confirm'] = __('Sunhotels wijziging doorvoeren', 'shorttrips');
    $actions['shorttrips_sunhotels_special_request'] = __('Sunhotels special request updaten', 'shorttrips');
    return $actions;
}, 20);

add_action('woocommerce_order_action_shorttrips_sunhotels_amend_quote', function ($order) {
    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    if (!$bookingRef) {
        $order->add_order_note(__('Sunhotels: geen referentie beschikbaar, wijziging afgebroken.', 'shorttrips'), false, true);
        return;
    }
    $params = shorttrips_build_amendment_payload($order);
    $params['bookingNumber'] = $bookingRef;
    $result = shorttrips_amendment_price_request($params);
    if (is_wp_error($result)) {
        $order->add_order_note(sprintf(__('Sunhotels wijzigingsprijs mislukt: %s', 'shorttrips'), $result->get_error_message()), false, true);
        return;
    }
    $order->add_order_note(sprintf(__('Sunhotels wijzigingsprijs: %s', 'shorttrips'), print_r($result['data'], true)), false, true);
    $order->update_meta_data('_sunhotels_last_amend_quote', maybe_serialize($result['data']));
    $order->save();
});

add_action('woocommerce_order_action_shorttrips_sunhotels_amend_confirm', function ($order) {
    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    if (!$bookingRef) {
        $order->add_order_note(__('Sunhotels: geen referentie beschikbaar, wijziging afgebroken.', 'shorttrips'), false, true);
        return;
    }
    $params = shorttrips_build_amendment_payload($order);
    $params['bookingNumber'] = $bookingRef;
    $result = shorttrips_amendment_request($params);
    if (is_wp_error($result)) {
        $order->add_order_note(sprintf(__('Sunhotels wijziging mislukt: %s', 'shorttrips'), $result->get_error_message()), false, true);
        return;
    }
    $order->add_order_note(sprintf(__('Sunhotels wijziging bevestigd: %s', 'shorttrips'), print_r($result['data'], true)), false, true);
    $order->update_meta_data('_sunhotels_last_amend_confirm', maybe_serialize($result['data']));
    $order->save();
});

add_action('woocommerce_order_action_shorttrips_sunhotels_special_request', function ($order) {
    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    if (!$bookingRef) {
        $order->add_order_note(__('Sunhotels: geen referentie beschikbaar, special request afgebroken.', 'shorttrips'), false, true);
        return;
    }
    $request = trim((string) $order->get_meta('_sunhotels_special_request'));
    if ($request === '') {
        $order->add_order_note(__('Geen special request tekst gevonden in ordermeta (_sunhotels_special_request).', 'shorttrips'), false, true);
        return;
    }
    $result = shorttrips_update_special_request($bookingRef, $request);
    if (is_wp_error($result)) {
        $order->add_order_note(sprintf(__('Sunhotels special request mislukt: %s', 'shorttrips'), $result->get_error_message()), false, true);
        return;
    }
    $order->add_order_note(__('Sunhotels special request bijgewerkt.', 'shorttrips'), false, true);
});

function shorttrips_build_amendment_payload($order)
{
    $checkin = $order->get_meta('_sunhotels_checkin');
    $checkout = $order->get_meta('_sunhotels_checkout');
    $rooms = intval($order->get_meta('_sunhotels_rooms') ?: 1);
    $adults = intval($order->get_meta('_sunhotels_adults') ?: 2);
    $children = intval($order->get_meta('_sunhotels_children') ?: 0);
    return [
        'checkInDate' => $checkin ?: $order->get_date_created()->format('Y-m-d'),
        'checkOutDate' => $checkout ?: $order->get_date_created()->modify('+2 days')->format('Y-m-d'),
        'rooms' => $rooms,
        'adults' => max(1, $adults),
        'children' => max(0, $children),
    ];
}

if (!function_exists('shorttrips_update_special_request')) {
    function shorttrips_update_special_request($bookingNumber, $request)
    {
        $params = [
            'bookingNumber' => sanitize_text_field($bookingNumber),
            'message' => sanitize_textarea_field($request),
        ];
        $response = shorttrips_call_nonstatic_soap('UpdateSpecialRequest', $params, ['timeout' => 60]);
        if (is_wp_error($response)) {
            return $response;
        }
        $xml = $response['xml'];
        $errorNode = $xml->xpath('//soap:Body//sh:Error//sh:Message | //soap:Body//Error//Message');
        if ($errorNode && !empty($errorNode[0])) {
            return new WP_Error('sunhotels_special_request_error', trim((string) $errorNode[0]));
        }
        return ['success' => true];
    }
}

if (!defined('SHORTTRIPS_FRONT_NOTICE_KEY')) {
    define('SHORTTRIPS_FRONT_NOTICE_KEY', 'shorttrips_front_notice_');
}

function shorttrips_set_front_notice($type, $message, $userId = null)
{
    $key = shorttrips_get_front_notice_key($userId);
    if (!$key) {
        return;
    }
    set_transient($key, [
        'type' => $type,
        'message' => $message,
    ], MINUTE_IN_SECONDS);
}

function shorttrips_get_front_notice_key($userId = null)
{
    if ($userId === null) {
        $userId = get_current_user_id();
    }
    if ($userId) {
        return SHORTTRIPS_FRONT_NOTICE_KEY . 'user_' . $userId;
    }
    $token = wp_get_session_token();
    if (!$token) {
        return null;
    }
    return SHORTTRIPS_FRONT_NOTICE_KEY . 'guest_' . $token;
}

add_action('woocommerce_before_account_content', function () {
    $key = shorttrips_get_front_notice_key();
    if (!$key) {
        return;
    }
    $notice = get_transient($key);
    if (!$notice) {
        return;
    }
    delete_transient($key);
    $class = $notice['type'] === 'error' ? 'woocommerce-error' : 'woocommerce-message';
    printf('<div class="%s">%s</div>', esc_attr($class), esc_html($notice['message']));
});

add_action('woocommerce_view_order', function ($orderId) {
    $order = wc_get_order($orderId);
    if (!$order) {
        return;
    }
    $currentUser = get_current_user_id();
    if ($currentUser && intval($order->get_user_id()) !== $currentUser && !current_user_can('manage_woocommerce')) {
        return;
    }
    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    if (!$bookingRef) {
        return;
    }
    $currentRequest = $order->get_meta('_sunhotels_special_request');
    $lastUpdated = $order->get_meta('_sunhotels_special_request_updated');
    ?>
    <section class="shorttrips-special-request" id="sunhotels-special-request" style="margin-top:30px;">
        <h2><?php esc_html_e('Speciale wensen voor Sunhotels', 'shorttrips'); ?></h2>
        <p><?php esc_html_e('Laat ons weten welke extra wensen of opmerkingen er zijn voor deze Sunhotels-boeking. We sturen dit direct door naar Sunhotels.', 'shorttrips'); ?>
        </p>
        <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>"
            class="shorttrips-special-request__form">
            <?php wp_nonce_field('shorttrips_special_request', 'shorttrips_special_request_nonce'); ?>
            <input type="hidden" name="action" value="shorttrips_special_request">
            <input type="hidden" name="order_id" value="<?php echo esc_attr($orderId); ?>">
            <label
                for="shorttrips_special_request_text"><?php esc_html_e('Uw bericht aan Sunhotels', 'shorttrips'); ?></label>
            <textarea id="shorttrips_special_request_text" name="special_request" rows="5" maxlength="500"
                style="width:100%;"><?php echo esc_textarea($currentRequest); ?></textarea>
            <p style="font-size:13px;color:#6b7280;margin:6px 0;">
                <?php esc_html_e('Maximaal 500 tekens. Wensen worden in het Engels doorgestuurd.', 'shorttrips'); ?>
            </p>
            <?php if ($lastUpdated): ?>
                <p style="font-size:12px;color:#6b7280;">
                    <?php
                    printf(
                        esc_html__('Laatste update: %s', 'shorttrips'),
                        esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), intval($lastUpdated)))
                    );
                    ?>
                </p>
            <?php endif; ?>
            <button type="submit" class="button"><?php esc_html_e('Special request versturen', 'shorttrips'); ?></button>
        </form>
    </section>
    <?php
});

add_action('admin_post_shorttrips_special_request', 'shorttrips_handle_special_request_submit');
add_action('admin_post_nopriv_shorttrips_special_request', 'shorttrips_handle_special_request_submit');

function shorttrips_handle_special_request_submit()
{
    if (!isset($_POST['shorttrips_special_request_nonce']) || !wp_verify_nonce($_POST['shorttrips_special_request_nonce'], 'shorttrips_special_request')) {
        shorttrips_set_front_notice('error', __('Beveiligingscontrole mislukt.', 'shorttrips'));
        shorttrips_redirect_special_request();
    }
    $orderId = intval($_POST['order_id'] ?? 0);
    $order = wc_get_order($orderId);
    if (!$order) {
        shorttrips_set_front_notice('error', __('Bestelling niet gevonden.', 'shorttrips'));
        shorttrips_redirect_special_request();
    }
    $currentUser = get_current_user_id();
    if (!$currentUser || (intval($order->get_user_id()) !== $currentUser && !current_user_can('manage_woocommerce'))) {
        shorttrips_set_front_notice('error', __('Je hebt geen toegang tot deze bestelling.', 'shorttrips'));
        shorttrips_redirect_special_request($order);
    }
    $request = trim((string) wp_unslash($_POST['special_request'] ?? ''));
    if ($request === '') {
        shorttrips_set_front_notice('error', __('Vul een speciale wens in.', 'shorttrips'));
        shorttrips_redirect_special_request($order);
    }
    if (strlen($request) > 500) {
        $request = substr($request, 0, 500);
    }
    $order->update_meta_data('_sunhotels_special_request', $request);
    $order->update_meta_data('_sunhotels_special_request_updated', current_time('timestamp'));
    $order->save();

    $bookingRef = $order->get_meta(SHORTTRIPS_SUNHOTELS_META_BOOKING);
    if (!$bookingRef) {
        shorttrips_set_front_notice('error', __('Sunhotels-referentie ontbreekt voor deze bestelling.', 'shorttrips'));
        shorttrips_redirect_special_request($order);
    }
    $result = shorttrips_update_special_request($bookingRef, $request);
    if (is_wp_error($result)) {
        $order->add_order_note(sprintf(__('Special request doorsturen mislukt: %s', 'shorttrips'), $result->get_error_message()));
        shorttrips_set_front_notice('error', sprintf(__('Doorsturen naar Sunhotels mislukt: %s', 'shorttrips'), $result->get_error_message()));
        shorttrips_redirect_special_request($order);
    }
    $order->add_order_note(__('Special request bijgewerkt door klant via Mijn boekingen.', 'shorttrips'));
    shorttrips_set_front_notice('success', __('Special request is verstuurd naar Sunhotels.', 'shorttrips'));
    shorttrips_redirect_special_request($order);
}

function shorttrips_redirect_special_request($order = null)
{
    $url = $order instanceof WC_Order ? $order->get_view_order_url() : (wp_get_referer() ?: wc_get_account_endpoint_url('orders'));
    wp_safe_redirect(add_query_arg('sunhotels-request', '1', $url) . '#sunhotels-special-request');
    exit;
}

if (!function_exists('shorttrips_transfer_cache_ttl')) {
    function shorttrips_transfer_cache_ttl()
    {
        return (int) apply_filters('shorttrips_transfer_cache_ttl', 30 * MINUTE_IN_SECONDS);
    }
}

if (!function_exists('shorttrips_store_transfer_cache')) {
    function shorttrips_store_transfer_cache($key, array $payload, array $meta = [])
    {
        if (!shorttrips_transfer_tables_ready('ghwk_transfer_cache')) {
            return;
        }
        global $wpdb;
        $ttl = shorttrips_transfer_cache_ttl();
        $nowLocal = current_time('mysql');
        $expires = gmdate('Y-m-d H:i:s', current_time('timestamp') + max($ttl, 300));

        $wpdb->query($wpdb->prepare("INSERT INTO ghwk_transfer_cache
      (cache_key, hotel_id, resort_id, passengers, request_payload, response_payload, expires_at, created_at, updated_at)
      VALUES (%s, %d, %d, %d, %s, %s, %s, %s, %s)
      ON DUPLICATE KEY UPDATE
        hotel_id = VALUES(hotel_id),
        resort_id = VALUES(resort_id),
        passengers = VALUES(passengers),
        request_payload = VALUES(request_payload),
        response_payload = VALUES(response_payload),
        expires_at = VALUES(expires_at),
        updated_at = VALUES(updated_at)",
            $key,
            intval($meta['hotel_id'] ?? 0),
            intval($meta['resort_id'] ?? 0),
            intval($meta['passengers'] ?? 0),
            wp_json_encode($meta['request'] ?? []),
            wp_json_encode($payload),
            $expires,
            $nowLocal,
            $nowLocal
        ));
        set_transient($key, $payload, shorttrips_transfer_cache_ttl());
    }
}

if (!function_exists('shorttrips_store_transfer_airports')) {
    function shorttrips_store_transfer_airports(array $airports)
    {
        if (empty($airports) || !shorttrips_transfer_tables_ready('ghwk_transfer_airports')) {
            return;
        }
        global $wpdb;
        foreach ($airports as $airport) {
            $airportId = intval($airport['airport_id'] ?? 0);
            if ($airportId <= 0) {
                continue;
            }
            $wpdb->query($wpdb->prepare("INSERT INTO ghwk_transfer_airports
        (airport_id, resort_id, airport_name, iata_code, time_zone, last_synced_at, created_at, updated_at)
        VALUES (%d, %d, %s, %s, %s, NOW(), NOW(), NOW())
        ON DUPLICATE KEY UPDATE
          resort_id = VALUES(resort_id),
          airport_name = VALUES(airport_name),
          iata_code = VALUES(iata_code),
          time_zone = VALUES(time_zone),
          updated_at = NOW(),
          last_synced_at = NOW()",
                $airportId,
                intval($airport['resort_id'] ?? 0),
                sanitize_text_field($airport['airport_name'] ?? ''),
                sanitize_text_field($airport['iata_code'] ?? ''),
                sanitize_text_field($airport['time_zone'] ?? '')
            ));
        }
    }
}

if (!function_exists('shorttrips_store_transfer_types')) {
    function shorttrips_store_transfer_types(array $types)
    {
        if (empty($types) || !shorttrips_transfer_tables_ready('ghwk_transfer_types')) {
            return;
        }
        global $wpdb;
        foreach ($types as $typeId => $typeName) {
            $typeId = intval($typeId);
            if ($typeId <= 0) {
                continue;
            }
            $wpdb->query($wpdb->prepare("INSERT INTO ghwk_transfer_types (id, name, updated_at) VALUES (%d, %s, NOW())
        ON DUPLICATE KEY UPDATE name = VALUES(name), updated_at = NOW()",
                $typeId,
                sanitize_text_field($typeName)
            ));
        }
        shorttrips_refresh_transfer_type_cache();
    }
}

if (!function_exists('shorttrips_guess_transfer_type_icon')) {
    function shorttrips_guess_transfer_type_icon($label)
    {
        $label = strtolower((string) $label);
        $map = [
            'shuttle' => 'üöå',
            'bus' => 'üöå',
            'coach' => 'üöå',
            'shared' => 'üöç',
            'minibus' => 'üöê',
            'private' => 'üöò',
            'car' => 'üöó',
            'taxi' => 'üöï',
            'limo' => 'üöñ',
            'vip' => '‚ú®',
            'premium' => '‚ú®',
            'boat' => '‚õ¥Ô∏è',
            'ferry' => '‚õ¥Ô∏è',
            'helicopter' => 'üöÅ',
            'train' => 'üöÜ',
        ];
        foreach ($map as $needle => $icon) {
            if (strpos($label, $needle) !== false) {
                return $icon;
            }
        }
        return '';
    }
}

if (!function_exists('shorttrips_refresh_transfer_type_cache')) {
    function shorttrips_refresh_transfer_type_cache($data = null)
    {
        delete_transient('shorttrips_transfer_types_map');
        if (is_array($data)) {
            set_transient('shorttrips_transfer_types_map', $data, DAY_IN_SECONDS);
        }
    }
}

if (!function_exists('shorttrips_get_transfer_types_map')) {
    function shorttrips_get_transfer_types_map($force = false)
    {
        if (!$force) {
            $cached = get_transient('shorttrips_transfer_types_map');
            if (is_array($cached)) {
                return $cached;
            }
        }
        $map = [];
        if (shorttrips_transfer_tables_ready('ghwk_transfer_types')) {
            global $wpdb;
            $rows = $wpdb->get_results("SELECT id, name FROM ghwk_transfer_types ORDER BY id ASC", ARRAY_A);
            if ($rows) {
                foreach ($rows as $row) {
                    $id = intval($row['id']);
                    $label = (string) $row['name'];
                    if ($id <= 0 || $label === '') {
                        continue;
                    }
                    $icon = shorttrips_guess_transfer_type_icon($label);
                    $map[$id] = [
                        'name' => $label,
                        'icon' => apply_filters('shorttrips_transfer_type_icon', $icon, $id, $label),
                    ];
                }
            }
        }
        shorttrips_refresh_transfer_type_cache($map);
        return $map;
    }
}

if (!function_exists('shorttrips_resolve_transfer_type_meta')) {
    function shorttrips_resolve_transfer_type_meta($typeId, $fallbackName = '')
    {
        $map = shorttrips_get_transfer_types_map();
        if ($typeId && isset($map[$typeId])) {
            return $map[$typeId];
        }
        return [
            'name' => $fallbackName,
            'icon' => shorttrips_guess_transfer_type_icon($fallbackName),
        ];
    }
}

if (!function_exists('shorttrips_sync_transfer_types_now')) {
    function shorttrips_sync_transfer_types_now($force = false)
    {
        $response = shorttrips_call_nonstatic_soap_callable('GetTransferTypes', static function () {
            return [];
        }, [
            'timeout' => 60,
            'retries' => 1,
            'log_tag' => 'GetTransferTypes',
        ]);
        if (is_wp_error($response)) {
            return $response;
        }
        $parsed = shorttrips_parse_soap($response, [
            'types' => '//soap:Body//sh:getTransferTypesResult//sh:transferTypes//sh:transferType | //GetTransferTypesResult//transferTypes//transferType',
        ]);
        if (is_wp_error($parsed)) {
            return $parsed;
        }
        $nodes = $parsed['types'] ?? [];
        $types = [];
        if ($nodes) {
            foreach ($nodes as $node) {
                $id = intval($node->id ?? $node->transferTypeId ?? 0);
                $label = trim((string) ($node->name ?? $node->transferTypeName ?? $node->transferType ?? ''));
                if ($id > 0 && $label !== '') {
                    $types[$id] = $label;
                }
            }
        }
        if (!empty($types)) {
            shorttrips_store_transfer_types($types);
            shorttrips_refresh_transfer_type_cache();
        }
        return $types;
    }
}

add_action('shorttrips_sync_transfer_types', 'shorttrips_sync_transfer_types_now');
add_action('init', function () {
    if (!wp_next_scheduled('shorttrips_sync_transfer_types')) {
        wp_schedule_event(time() + HOUR_IN_SECONDS, 'daily', 'shorttrips_sync_transfer_types');
    }
});

add_action('admin_init', function () {
    if (!current_user_can('manage_options')) {
        return;
    }
    if (isset($_GET['shorttrips_sync_transfer_types']) && $_GET['shorttrips_sync_transfer_types'] === '1') {
        $result = shorttrips_sync_transfer_types_now(true);
        $message = is_wp_error($result)
            ? $result->get_error_message()
            : sprintf(__('Transfer types bijgewerkt (%d records)', 'shorttrips'), count($result));
        $redirect = remove_query_arg('shorttrips_sync_transfer_types');
        wp_safe_redirect(add_query_arg('st_msg', rawurlencode($message), $redirect));
        exit;
    }
});

if (!function_exists('shorttrips_fetch_transfer_options')) {
    function shorttrips_fetch_transfer_options(array $args)
    {
        $hotelId = intval($args['hotel_id'] ?? 0);
        $resortId = intval($args['resort_id'] ?? 0);
        $arrivalDate = sanitize_text_field($args['arrival_date'] ?? '');
        $arrivalTime = sanitize_text_field($args['arrival_time'] ?? '');
        $returnDate = sanitize_text_field($args['return_date'] ?? '');
        $returnTime = sanitize_text_field($args['return_time'] ?? '');
        $passengers = intval($args['passengers'] ?? 0);
        $creds = shorttrips_get_api_credentials();

        $fingerprint = [
            'hotel' => $hotelId,
            'resort' => $resortId,
            'arrivalDate' => $arrivalDate,
            'arrivalTime' => $arrivalTime,
            'returnDate' => $returnDate,
            'returnTime' => $returnTime,
        ];
        $cacheKey = 'st_transfer_' . md5(wp_json_encode($fingerprint));

        if (empty($args['nocache'])) {
            $cached = shorttrips_get_transfer_cache($cacheKey);
            if ($cached) {
                return $cached;
            }
        }

        $soapParams = array_filter([
            'hotelID' => $hotelId > 0 ? $hotelId : null,
            'resortID' => $resortId > 0 ? $resortId : null,
            'currencies' => $creds['currency'],
            'language' => $creds['language'],
            'arrivalDate' => $arrivalDate,
            'arrivalTime' => $arrivalTime,
            'returnDepartureDate' => $returnDate,
            'returnDepartureTime' => $returnTime,
        ], static function ($value) {
            return !($value === null || $value === '');
        });

        $response = shorttrips_call_nonstatic_soap('SearchTransfersV2', $soapParams, ['timeout' => 90, 'retries' => 1, 'log_tag' => 'SearchTransfersV2']);
        if (is_wp_error($response)) {
            return $response;
        }
        $xml = $response['xml'];
        $errorNode = $xml->xpath('//soap:Body//sh:Error//sh:Message | //soap:Body//Error//Message');
        if ($errorNode && !empty($errorNode[0])) {
            return new WP_Error('sunhotels_error', trim((string) $errorNode[0]));
        }

        $airportNodes = $xml->xpath('//soap:Body//sh:searchTransfersResult//sh:airports//sh:airport | //searchTransfersResult//airports//airport');
        $airportsOut = [];
        $airportsStore = [];
        $typesStore = [];

        if ($airportNodes) {
            foreach ($airportNodes as $airport) {
                $airportId = intval($airport->airportId ?? $airport->{'airportId'} ?? 0);
                $airportName = trim((string) ($airport->airportName ?? $airport->{'airportName'} ?? ''));
                $iataCode = trim((string) ($airport->iataCode ?? $airport->{'iataCode'} ?? ''));
                $timeZone = trim((string) ($airport->timeZone ?? $airport->{'timeZone'} ?? ''));
                $airportResortId = intval($airport->resortId ?? 0);

                $transferNodes = $airport->xpath('.//sh:transfers//sh:transfer | .//transfers//transfer');
                $transfersOut = [];

                if ($transferNodes) {
                    foreach ($transferNodes as $transfer) {
                        $transferId = intval($transfer->transferId ?? 0);
                        $typeId = intval($transfer->transferTypeId ?? 0);
                        $typeName = trim((string) ($transfer->transferTypeName ?? $transfer->{'transferTypeName'} ?? ''));
                        $typeMeta = shorttrips_resolve_transfer_type_meta($typeId, $typeName);
                        $typeDisplayName = $typeMeta['name'] ?: $typeName;
                        $typeIcon = $typeMeta['icon'] ?? '';
                        if ($typeId > 0 && $typeDisplayName !== '') {
                            $typesStore[$typeId] = $typeDisplayName;
                        }
                        $minPassengers = intval($transfer->minimumPassengers ?? 0);
                        $maxPassengers = intval($transfer->maximumPassengers ?? 0);
                        $estMinutes = intval($transfer->estimatedTimeInMinutes ?? 0);
                        $estHours = intval($transfer->estimatedTimeInHours ?? 0);

                        $rateNodes = $transfer->xpath('.//sh:rates//sh:rate | .//rates//rate');
                        $ratesOut = [];
                        $priceFrom = null;

                        if ($rateNodes) {
                            foreach ($rateNodes as $rate) {
                                $direction = trim((string) ($rate->direction ?? 'Arrival'));
                                $startHour = isset($rate->startHour) ? intval($rate->startHour) : null;
                                $endHour = isset($rate->endHour) ? intval($rate->endHour) : null;
                                $priceNodes = $rate->xpath('.//sh:prices//sh:price | .//prices//price | .//price');

                                if ($priceNodes) {
                                    foreach ($priceNodes as $priceNode) {
                                        $amount = isset($priceNode->amount) ? (float) $priceNode->amount : (float) $priceNode;
                                        $currency = isset($priceNode['currency']) ? (string) $priceNode['currency'] : (isset($priceNode->currency) ? (string) $priceNode->currency : 'EUR');
                                        if ($priceFrom === null || ($amount > 0 && $amount < $priceFrom)) {
                                            $priceFrom = $amount;
                                        }
                                        $ratesOut[] = [
                                            'direction' => $direction,
                                            'startHour' => $startHour,
                                            'endHour' => $endHour,
                                            'amount' => $amount,
                                            'currency' => $currency,
                                            'priceText' => shorttrips_format_currency($amount, $currency),
                                        ];
                                    }
                                }
                            }
                        }

                        $transfersOut[] = [
                            'transferId' => $transferId,
                            'transferTypeId' => $typeId,
                            'transferTypeName' => $typeDisplayName,
                            'transferTypeIcon' => $typeIcon,
                            'minimumPassengers' => $minPassengers,
                            'maximumPassengers' => $maxPassengers,
                            'estimatedMinutes' => $estMinutes,
                            'estimatedHours' => $estHours,
                            'priceFrom' => $priceFrom,
                            'priceFromText' => $priceFrom !== null ? shorttrips_format_currency($priceFrom, 'EUR') : '',
                            'rates' => $ratesOut,
                        ];
                    }
                }

                $airportsOut[] = [
                    'airportId' => $airportId,
                    'airportName' => $airportName,
                    'iataCode' => $iataCode,
                    'timeZone' => $timeZone,
                    'resortId' => $airportResortId,
                    'transfers' => $transfersOut,
                ];

                if ($airportId > 0) {
                    $airportsStore[] = [
                        'airport_id' => $airportId,
                        'airport_name' => $airportName,
                        'iata_code' => $iataCode,
                        'time_zone' => $timeZone,
                        'resort_id' => $airportResortId,
                    ];
                }
            }
        }

        if (!empty($airportsStore)) {
            shorttrips_store_transfer_airports($airportsStore);
        }
        if (!empty($typesStore)) {
            shorttrips_store_transfer_types($typesStore);
        }

        $payload = [
            'airports' => $airportsOut,
            'requested' => [
                'hotel_id' => $hotelId,
                'resort_id' => $resortId,
                'arrival_date' => $arrivalDate,
                'arrival_time' => $arrivalTime,
                'return_date' => $returnDate,
                'return_time' => $returnTime,
                'passengers' => $passengers,
            ],
            'fetched_at' => current_time('mysql'),
            'from_cache' => false,
        ];

        shorttrips_store_transfer_cache($cacheKey, $payload, [
            'hotel_id' => $hotelId,
            'resort_id' => $resortId,
            'passengers' => $passengers,
            'request' => $fingerprint,
        ]);
        set_transient($cacheKey, $payload, shorttrips_transfer_cache_ttl());

        return $payload;
    }
}

add_action('wp_ajax_shorttrips_get_transfers', 'shorttrips_get_transfers');
add_action('wp_ajax_nopriv_shorttrips_get_transfers', 'shorttrips_get_transfers');
function shorttrips_get_transfers()
{
    $hotelId = intval($_REQUEST['hotelId'] ?? 0);
    if ($hotelId <= 0) {
        wp_send_json_error(['message' => 'Hotel ontbreekt']);
    }

    $resortId = intval($_REQUEST['resortId'] ?? ($_REQUEST['destinationId'] ?? 0));
    $arrivalDate = sanitize_text_field($_REQUEST['arrivalDate'] ?? '');
    $arrivalTime = sanitize_text_field($_REQUEST['arrivalTime'] ?? '');
    $returnDate = sanitize_text_field($_REQUEST['returnDepartureDate'] ?? ($_REQUEST['returnDate'] ?? ''));
    $returnTime = sanitize_text_field($_REQUEST['returnDepartureTime'] ?? ($_REQUEST['returnTime'] ?? ''));
    $passengers = intval($_REQUEST['passengers'] ?? 0);
    if ($passengers <= 0) {
        $passengers = intval($_REQUEST['adults'] ?? 0) + intval($_REQUEST['children'] ?? 0);
    }
    if ($passengers <= 0) {
        $passengers = 1;
    }

    $validateDate = static function ($value, $label = 'date') {
        if ($value === '') {
            return false;
        }
        try {
            $dt = DateTime::createFromFormat('Y-m-d', $value);
        } catch (Throwable $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf('[Shorttrips Transfers] Invalid %s "%s": %s', $label, $value, $e->getMessage()));
            }
            return false;
        }
        if (!$dt) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf('[Shorttrips Transfers] Unable to parse %s "%s"', $label, $value));
            }
            return false;
        }
        return $dt->format('Y-m-d') === $value;
    };
    $validateTime = static function ($value, $label = 'time') {
        if ($value === '') {
            return false;
        }
        try {
            $dt = DateTime::createFromFormat('H:i', $value);
        } catch (Throwable $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf('[Shorttrips Transfers] Invalid %s "%s": %s', $label, $value, $e->getMessage()));
            }
            return false;
        }
        if (!$dt) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf('[Shorttrips Transfers] Unable to parse %s "%s"', $label, $value));
            }
            return false;
        }
        return $dt->format('H:i') === $value;
    };

    if (!$validateDate($arrivalDate, 'arrivalDate')) {
        wp_send_json_error(['message' => 'Ongeldige aankomstdatum']);
    }
    if (!$validateDate($returnDate, 'returnDate')) {
        $returnDate = $arrivalDate;
    }
    if (!$validateTime($arrivalTime, 'arrivalTime')) {
        $arrivalTime = '12:00';
    }
    if (!$validateTime($returnTime, 'returnTime')) {
        $returnTime = '10:00';
    }

    $result = shorttrips_fetch_transfer_options([
        'hotel_id' => $hotelId,
        'resort_id' => $resortId,
        'arrival_date' => $arrivalDate,
        'arrival_time' => $arrivalTime,
        'return_date' => $returnDate,
        'return_time' => $returnTime,
        'passengers' => $passengers,
        'nocache' => !empty($_REQUEST['nocache']),
    ]);

    if (is_wp_error($result)) {
        $code = $result->get_error_code();
        $friendly = [
            'sunhotels_empty_response' => 'Sunhotels gaf geen gegevens terug. Probeer het later opnieuw.',
            'sunhotels_xml_error' => 'Sunhotels stuurde een ongeldig antwoord. Probeer andere data of later opnieuw.',
        ];
        $message = $friendly[$code] ?? $result->get_error_message();
        wp_send_json_error(['message' => $message]);
    }

    if (!isset($result['airports'])) {
        $result['airports'] = [];
    }

    wp_send_json_success($result);
}

/*  
|--------------------------------------------------------------------------
| SHORTTRIPS ‚Äì Filters shortcode [freestays_filters]
|  - Resultaten (home/hotel-zoeken): AJAX submit, behoud zoekcontext
|  - Prebook: GET submit, filtert kamerresultaten
|--------------------------------------------------------------------------
*/
add_shortcode('freestays_filters', function ($atts = []) {
    global $wpdb;
    $isPrebook = (is_page() && (is_page('prebook') || stripos((string) get_post_field('post_name', get_post()), 'prebook') !== false));
    $action = isset($atts['action']) ? esc_url($atts['action']) : '';

    // Lookups (features/themes/meals)
    $features = shorttrips_get_feature_options();
    $themes = shorttrips_get_theme_options();
    $meals = shorttrips_get_meal_options();

    ob_start(); ?>
    <div class="st-filters-wrap"
        style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-bottom:16px">
        <form id="st-filters-form" <?= $isPrebook ? ' method="get"' . ($action ? ' action="' . $action . '"' : '') : ($action ? ' data-action="' . $action . '"' : '') ?>>
            <?php if (!$isPrebook): ?>
                <div class="grid" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px">
                    <div>
                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Kenmerken</label>
                        <select name="featureIds[]" multiple size="4"
                            style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:6px;min-height:42px">
                            <?php if ($features) {
                                foreach ($features as $fid => $fname) {
                                    echo '<option value="' . intval($fid) . '">' . esc_html($fname) . '</option>';
                                }
                            } ?>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Thema's</label>
                        <select name="themeIds[]" multiple size="4"
                            style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:6px;min-height:42px">
                            <?php if ($themes) {
                                foreach ($themes as $tid => $tname) {
                                    echo '<option value="' . intval($tid) . '">' . esc_html($tname) . '</option>';
                                }
                            } ?>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Maaltijden</label>
                        <select name="mealIds[]" multiple size="4"
                            style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:6px;min-height:42px">
                            <?php if ($meals) {
                                foreach ($meals as $mid => $mname) {
                                    echo '<option value="' . intval($mid) . '">' . esc_html($mname) . '</option>';
                                }
                            } ?>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Sterren (min/max)</label>
                        <div style="display:flex;gap:6px">
                            <select name="minStars" style="flex:1;border:1px solid #d1d5db;border-radius:8px;padding:6px">
                                <option value="">-</option>
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                            <select name="maxStars" style="flex:1;border:1px solid #d1d5db;border-radius:8px;padding:6px">
                                <option value="">-</option>
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Prijs (min/max)</label>
                        <div style="display:flex;gap:6px">
                            <input name="minPrice" type="number" step="0.01" placeholder="Min"
                                style="flex:1;border:1px solid #d1d5db;border-radius:8px;padding:6px" />
                            <input name="maxPrice" type="number" step="0.01" placeholder="Max"
                                style="flex:1;border:1px solid #d1d5db;border-radius:8px;padding:6px" />
                        </div>
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Uitsluiten</label>
                        <label style="display:block;font-size:12px;color:#374151"><input type="checkbox"
                                name="excludeSharedRooms" value="1" /> Gedeelde kamer</label>
                        <label style="display:block;font-size:12px;color:#374151"><input type="checkbox"
                                name="excludeSharedFacilities" value="1" /> Gedeelde faciliteiten</label>
                    </div>
                </div>
            <?php else: ?>
                <div class="grid" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px">
                    <div>
                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Maaltijden</label>
                        <select name="mealIds[]" multiple size="4"
                            style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:6px;min-height:42px">
                            <?php if ($meals) {
                                foreach ($meals as $m) {
                                    echo '<option value="' . intval($m['id']) . '">' . esc_html($m['name']) . '</option>';
                                }
                            } ?>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Uitsluiten</label>
                        <label style="display:block;font-size:12px;color:#374151"><input type="checkbox"
                                name="excludeSharedRooms" value="1"
                                <?= isset($_GET['excludeSharedRooms']) && $_GET['excludeSharedRooms'] == '1' ? 'checked' : ''; ?> />
                            Gedeelde kamer</label>
                        <label style="display:block;font-size:12px;color:#374151"><input type="checkbox"
                                name="excludeSharedFacilities" value="1"
                                <?= isset($_GET['excludeSharedFacilities']) && $_GET['excludeSharedFacilities'] == '1' ? 'checked' : ''; ?> /> Gedeelde faciliteiten</label>
                    </div>
                </div>
            <?php endif; ?>

            <!-- Search context (verborgen) -->
            <?php if (!$isPrebook): ?>
                <input type="hidden" name="action" value="shorttrips_search_hotels" />
                <input type="hidden" name="type" value="free" />
                <input type="hidden" name="q" />
                <input type="hidden" name="country" />
                <input type="hidden" name="resort" />
                <input type="hidden" name="checkin" />
                <input type="hidden" name="checkout" />
                <input type="hidden" name="rooms" />
                <input type="hidden" name="adults" />
                <input type="hidden" name="children" />
                <input type="hidden" name="child_ages" />
                <input type="hidden" name="page" value="1" />
            <?php else: ?>
                <input type="hidden" name="hotelId" value="<?= isset($_GET['hotelId']) ? intval($_GET['hotelId']) : 0; ?>" />
                <input type="hidden" name="checkin" value="<?= esc_attr($_GET['checkin'] ?? '') ?>" />
                <input type="hidden" name="checkout" value="<?= esc_attr($_GET['checkout'] ?? '') ?>" />
                <input type="hidden" name="rooms" value="<?= esc_attr($_GET['rooms'] ?? '1') ?>" />
                <input type="hidden" name="adults" value="<?= esc_attr($_GET['adults'] ?? '2') ?>" />
                <input type="hidden" name="children" value="<?= esc_attr($_GET['children'] ?? '0') ?>" />
                <input type="hidden" name="child_ages" value="<?= esc_attr($_GET['child_ages'] ?? '') ?>" />
            <?php endif; ?>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
                <button type="submit" class="button button-primary">Toepassen</button>
                <button type="button" id="st-filters-reset" class="button">Reset</button>
            </div>
        </form>
    </div>
    <?php if (!$isPrebook): ?>
        <script>(function () {
                var form = document.getElementById('st-filters-form'); if (!form) return;
                var targetAction = form.getAttribute('data-action') || '';
                function qsToObj() { var params = new URLSearchParams(window.location.search); var o = {}; params.forEach((v, k) => { o[k] = v }); return o; }
                function syncHiddenFromSearch() {
                    var p = window.stLastSearchPayload || {};
                    var url = qsToObj();
                    if (!p.q && !p.country && !p.resort) {
                        // Fallback 1: probeer free/advanced forms als aanwezig
                        var freeQ = document.getElementById('st-q');
                        if (freeQ && freeQ.value) { p.type = 'free'; p.q = freeQ.value; }
                        var advC = document.getElementById('st-country'); var advR = document.getElementById('st-resort');
                        if ((advC && advC.value) || (advR && advR.value)) { p.type = 'advanced'; p.country = advC ? advC.value : ''; p.resort = advR ? advR.value : ''; }
                    }
                    // Fallback 2: lees uit URL
                    if (!p.q && url.q) { p.type = 'free'; p.q = url.q; }
                    if ((!p.country && url.country) || (!p.resort && url.resort)) {
                        p.type = 'advanced'; p.country = p.country || url.country || ''; p.resort = p.resort || url.resort || '';
                    }
                    if (!p.checkin || !p.checkout) { p.checkin = p.checkin || url.checkin || ''; p.checkout = p.checkout || url.checkout || ''; }
                    p.rooms = p.rooms || (document.getElementById('st-rooms-free')?.value || document.getElementById('st-rooms-adv')?.value || '1');
                    p.adults = p.adults || (document.getElementById('st-adults-free')?.value || document.getElementById('st-adults-adv')?.value || '2');
                    p.children = p.children || (document.getElementById('st-children-free')?.value || document.getElementById('st-children-adv')?.value || '0');
                    p.child_ages = p.child_ages || '';
                    // Schrijf naar hidden inputs
                    ['type', 'q', 'country', 'resort', 'checkin', 'checkout', 'rooms', 'adults', 'children', 'child_ages'].forEach(function (k) {
                        var el = form.querySelector('input[name="' + k + '"]'); if (el) el.value = (p[k] || '');
                    });
                    return p;
                }
                syncHiddenFromSearch();
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    var p = syncHiddenFromSearch();
                    // Verzamel filterwaarden
                    function collectMulti(name) { var els = form.querySelectorAll('[name="' + name + '[]"] option:checked'); return Array.from(els).map(el => el.value); }
                    var payload = Object.assign({}, p, {
                        featureIds: collectMulti('featureIds'),
                        themeIds: collectMulti('themeIds'),
                        mealIds: collectMulti('mealIds'),
                        minStars: form.querySelector('[name="minStars"]').value || '',
                        maxStars: form.querySelector('[name="maxStars"]').value || '',
                        minPrice: form.querySelector('[name="minPrice"]').value || '',
                        maxPrice: form.querySelector('[name="maxPrice"]').value || '',
                        excludeSharedRooms: form.querySelector('[name="excludeSharedRooms"]').checked ? '1' : '',
                        excludeSharedFacilities: form.querySelector('[name="excludeSharedFacilities"]').checked ? '1' : '',
                        page: 1
                    });
                    var res = document.getElementById('st-results');
                    if (res) {
                        // AJAX post naar admin-ajax
                        var fd = new FormData(); Object.keys(payload).forEach(function (k) {
                            var v = payload[k];
                            if (Array.isArray(v)) { v.forEach(function (val) { fd.append(k + '[]', String(val)); }); }
                            else if (v !== undefined && v !== '') { fd.append(k, String(v)); }
                        });
                        fetch('<?= esc_js(admin_url('admin-ajax.php')); ?>', { method: 'POST', body: fd, credentials: 'same-origin' })
                            .then(function (r) {
                                if (!r.ok) throw new Error('Network response was not ok');
                                return r.text();
                            })
                            .then(function (html) {
                                if (!html || html.trim() === '') {
                                    res.innerHTML = '<div class="text-center py-8"><p class="text-gray-500">Geen resultaten gevonden</p></div>';
                                    return;
                                }
                                res.innerHTML = html;
                                if (window.stInitResults) window.stInitResults();
                                window.stLastSearchPayload = Object.assign({}, p);
                            })
                            .catch(function (err) {
                                console.error('Filter search error:', err);
                                res.innerHTML = '<div class="text-center py-8"><p class="text-red-500">Er is een fout opgetreden bij het laden van de resultaten</p></div>';
                            });
                    } else {
                        // Geen resultatencontainer aanwezig: redirect met querystring naar action of huidige pagina
                        var params = new URLSearchParams();
                        ['type', 'q', 'country', 'resort', 'checkin', 'checkout', 'rooms', 'adults', 'children', 'child_ages', 'minStars', 'maxStars', 'minPrice', 'maxPrice', 'excludeSharedRooms', 'excludeSharedFacilities'].forEach(function (k) { var v = payload[k]; if (v !== undefined && v !== '') { params.append(k, String(v)); } });
                        ['featureIds', 'themeIds', 'mealIds'].forEach(function (k) { var v = payload[k] || []; if (Array.isArray(v)) { v.forEach(function (val) { params.append(k + '[]', String(val)); }); } });
                        var base = targetAction || (window.location.href.split('#')[0]);
                        var url = base + (base.indexOf('?') === -1 ? '?' : '&') + params.toString();
                        window.location.href = url;
                    }
                });
                document.getElementById('st-filters-reset').addEventListener('click', function () {
                    ['featureIds', 'themeIds', 'mealIds'].forEach(function (name) { var sel = form.querySelector('[name="' + name + '[]"]'); if (sel) { Array.from(sel.options).forEach(o => o.selected = false); } });
                    ['minStars', 'maxStars', 'minPrice', 'maxPrice'].forEach(function (name) { var el = form.querySelector('[name="' + name + '"]'); if (el) el.value = ''; });
                    form.querySelector('[name="excludeSharedRooms"]').checked = false;
                    form.querySelector('[name="excludeSharedFacilities"]').checked = false;
                });
            })();</script>
    <?php else: ?>
        <script>(function () {
                var form = document.getElementById('st-filters-form'); if (!form) return;
                document.getElementById('st-filters-reset').addEventListener('click', function () {
                    var sel = form.querySelector('[name="mealIds[]"]'); if (sel) { Array.from(sel.options).forEach(o => o.selected = false); }
                    form.querySelector('[name="excludeSharedRooms"]').checked = false;
                    form.querySelector('[name="excludeSharedFacilities"]').checked = false;
                });
            })();</script>
    <?php endif; ?>
    <?php
    return ob_get_clean();
});

/*  
||--------------------------------------------------------------------------
|| SHORTTRIPS ‚Äì Helper functie voor API credentials
||--------------------------------------------------------------------------
*/
function shorttrips_get_api_credentials()
{
    // Haal credentials op via WordPress options met fallback naar hardcoded waarden
    // In productie: verplaats deze naar wp-config.php of gebruik get_option()
    $username = defined('SUNHOTELS_USERNAME') ? SUNHOTELS_USERNAME : get_option('sunhotels_username', 'Freestays');
    $password = defined('SUNHOTELS_PASSWORD') ? SUNHOTELS_PASSWORD : get_option('sunhotels_password', 'Vision2024!@');
    $currency = defined('SUNHOTELS_CURRENCY') ? SUNHOTELS_CURRENCY : get_option('sunhotels_currency', 'EUR');

    // üîß CRITICAL FIX: SunHotels API ALTIJD 'en' (Engels, kleine letters)
    // De API accepteert GEEN 'nl', 'de', 'fr', etc - alleen 'en'!
    // Auto-detect was causing API to return NO results for most countries
    $language = 'en';  // ALWAYS use 'en' for SunHotels API

    return [
        'username' => $username,
        'password' => $password,
        'language' => $language,
        'currency' => $currency
    ];
}

/**
 * Register translatable strings for Polylang
 * These strings can be translated in Settings ‚Üí Languages ‚Üí String translations
 */
add_action('init', function () {
    if (function_exists('pll_register_string')) {
        $strings = [
            // Search & Results
            'Zoek hotels' => 'Search hotels',
            'Geen hotels gevonden' => 'No hotels found',
            'We hebben geen beschikbare hotels gevonden' => 'We could not find any available hotels',
            'Probeer andere zoekparameters of filters' => 'Try different search parameters or filters',
            'Hotels ophalen...' => 'Loading hotels...',
            'Zoeken naar beschikbare hotels...' => 'Searching for available hotels...',
            'Hotels laden...' => 'Loading hotels...',

            // Buttons
            'Zoek' => 'Search',
            'Reset' => 'Reset',
            'Filters toepassen' => 'Apply filters',
            'Meer laden' => 'Load more',
            'Toon meer' => 'Show more',
            'Bekijk hotel' => 'View hotel',
            'Boek nu' => 'Book now',

            // Form labels
            'Bestemming' => 'Destination',
            'Check-in' => 'Check-in',
            'Check-out' => 'Check-out',
            'Aantal nachten' => 'Number of nights',
            'Kamers' => 'Rooms',
            'Volwassenen' => 'Adults',
            'Kinderen' => 'Children',
            'Reisduur' => 'Duration',

            // Filters
            'Min sterren' => 'Min stars',
            'Max sterren' => 'Max stars',
            'Min prijs' => 'Min price',
            'Max prijs' => 'Max price',
            'Faciliteiten' => 'Facilities',
            'Thema\'s' => 'Themes',
            'Board (meals)' => 'Board (meals)',
            'Geen gedeelde kamers' => 'No shared rooms',
            'Geen gedeelde faciliteiten' => 'No shared facilities',

            // Hotel details
            'per nacht' => 'per night',
            'Beschikbaarheid' => 'Availability',
            'Prijs vanaf' => 'Price from',
            'Beoordeling' => 'Rating',
            'Recensies' => 'Reviews',
            'Sterren' => 'Stars',

            // Messages
            'Kies een stad' => 'Choose a city',
            'Selecteer een specifieke stad uit de lijst om hotels te bekijken.' => 'Select a specific city from the list to view hotels.',
            'Geen steden gevonden' => 'No cities found',
            'We hebben geen steden gevonden voor' => 'We could not find any cities for',
            'Probeer een ander land.' => 'Try another country.',

            // Popular destinations
            'Populaire bestemmingen' => 'Popular destinations',
            'Alle bestemmingen' => 'All destinations',
            'Ontdek Populaire Bestemmingen Wereldwijd' => 'Discover Popular Destinations Worldwide',

            // Pagination
            'Vorige' => 'Previous',
            'Volgende' => 'Next',
            'Pagina' => 'Page',
            'van' => 'of',

            // Sorting
            'Sorteer op' => 'Sort by',
            'Prijs (laag ‚Üí hoog)' => 'Price (low ‚Üí high)',
            'Prijs (hoog ‚Üí laag)' => 'Price (high ‚Üí low)',
            'Beoordeling (hoog ‚Üí laag)' => 'Rating (high ‚Üí low)',
            'Sterren (hoog ‚Üí laag)' => 'Stars (high ‚Üí low)',
            'Naam (A ‚Üí Z)' => 'Name (A ‚Üí Z)',
        ];

        foreach ($strings as $nl => $en) {
            pll_register_string('shorttrips', $nl, 'ShortTrips Theme');
        }
    }
});

/**
 * Translate interface strings (not hotel content!)
 * Hotel content comes from API and is not translated automatically
 * 
 * @param string $text Text to translate
 * @return string Translated string
 */
function shorttrips_translate($text)
{
    // Polylang translation support
    if (function_exists('pll__')) {
        return pll__($text);
    }

    // Fallback to original text
    return $text;
}

/**
 * Get current language for Sunhotels API
 * Supports: WordPress locale, Polylang, WPML
 * 
 * @return string Language code (en, nl, de, fr, es, it)
 */
function shorttrips_get_current_language()
{
    // üåê Check for AJAX language override (set by shorttrips_search_hotels)
    global $shorttrips_ajax_lang;
    if (!empty($shorttrips_ajax_lang)) {
        $detected = $shorttrips_ajax_lang;
    }
    // Polylang support
    elseif (function_exists('pll_current_language')) {
        $lang = pll_current_language();
        if (!empty($lang)) {
            $detected = $lang;
        }
    }
    // WPML support
    elseif (defined('ICL_LANGUAGE_CODE')) {
        $detected = ICL_LANGUAGE_CODE;
    }

    // If we have a detected language, validate it against Sunhotels supported languages
    if (!empty($detected)) {
        // üåê Sunhotels API supported languages (as per their documentation)
        // If a language is not supported, we'll fallback to English
        $sunhotels_supported = ['en', 'nl', 'de', 'fr', 'es', 'it', 'pt', 'ru', 'pl', 'sv', 'da', 'no', 'fi', 'cs'];

        if (in_array($detected, $sunhotels_supported)) {
            return $detected;
        } else {
            // Unsupported language - fallback to English but log it
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('üåê Language "' . $detected . '" not supported by Sunhotels API, falling back to English');
            }
            return 'en'; // Fallback to English for unsupported languages
        }
    }

    // WordPress locale (nl_NL, en_US, de_DE, etc.)
    $wp_locale = get_locale();

    // Map WordPress locales to Sunhotels API language codes
    $lang_map = [
        'nl' => 'nl', // Nederlands
        'en' => 'en', // English
        'de' => 'de', // Deutsch
        'fr' => 'fr', // Fran√ßais
        'es' => 'es', // Espa√±ol
        'it' => 'it', // Italiano
        'pt' => 'pt', // Portugu√™s
        'ru' => 'ru', // –†—É—Å—Å–∫–∏–π
        'pl' => 'pl', // Polski
        'tr' => 'tr', // T√ºrk√ße
        'sv' => 'sv', // Svenska
        'da' => 'da', // Dansk
        'no' => 'no', // Norsk
        'fi' => 'fi', // Suomi
        'cs' => 'cs', // ƒåe≈°tina
        'hu' => 'hu', // Magyar
        'ro' => 'ro', // Rom√¢nƒÉ
        'el' => 'el', // ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨
        'ar' => 'ar', // ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
        'ja' => 'ja', // Êó•Êú¨Ë™û
        'zh' => 'zh', // ‰∏≠Êñá
    ];

    // Extract language code (first 2 chars of locale)
    $lang_code = strtolower(substr($wp_locale, 0, 2));

    // Return mapped language or fallback to English
    return isset($lang_map[$lang_code]) ? $lang_map[$lang_code] : 'en';
}

// Provide NonStatic POST helper early so admin_init hooks can use it regardless of order
if (!function_exists('shorttrips_call_nonstatic_xml')) {
    function shorttrips_call_nonstatic_xml($action, $params = [])
    {
        $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
        $endpoint = 'https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx/' . $action;
        $body = array_merge([
            'userName' => $creds['username'],
            'password' => $creds['password'],
            'language' => $creds['language'],
        ], $params);
        $resp = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'application/x-www-form-urlencoded'],
            'body' => http_build_query($body),
            'timeout' => 120,
        ]);
        if (is_wp_error($resp) || empty($resp['body']))
            return null;
        $xml = @simplexml_load_string($resp['body']);
        return $xml ?: null;
    }
}
if (!function_exists('shorttrips_escape_xml_value')) {
    function shorttrips_escape_xml_value($value)
    {
        return htmlspecialchars((string) $value, ENT_QUOTES | ENT_XML1, 'UTF-8');
    }
}

if (!function_exists('shorttrips_array_to_xml_nodes')) {
    function shorttrips_array_to_xml_nodes(array $data, $parentKey = null)
    {
        $xml = '';
        foreach ($data as $key => $value) {
            if ($value === null || $value === '') {
                continue;
            }
            $nodeName = is_numeric($key) && $parentKey ? $parentKey : $key;
            if (is_array($value)) {
                if (array_key_exists('__raw', $value)) {
                    $xml .= (string) $value['__raw'];
                    continue;
                }
                if (array_key_exists('__value', $value) && count($value) === 1) {
                    $xml .= '<' . $nodeName . '>' . shorttrips_escape_xml_value($value['__value']) . '</' . $nodeName . '>';
                    continue;
                }
                $isAssoc = array_keys($value) !== range(0, count($value) - 1);
                if ($isAssoc) {
                    $xml .= '<' . $nodeName . '>' . shorttrips_array_to_xml_nodes($value, $nodeName) . '</' . $nodeName . '>';
                } else {
                    foreach ($value as $child) {
                        $xml .= '<' . $nodeName . '>' . shorttrips_array_to_xml_nodes(is_array($child) ? $child : ['__value' => $child], $nodeName) . '</' . $nodeName . '>';
                    }
                }
            } else {
                $xml .= '<' . $nodeName . '>' . shorttrips_escape_xml_value($value) . '</' . $nodeName . '>';
            }
        }
        return $xml;
    }
}

if (!function_exists('shorttrips_log_soap_event')) {
    function shorttrips_log_soap_event($action, $message, array $context = [])
    {
        if (!defined('WP_DEBUG') || !WP_DEBUG) {
            return;
        }
        $prefix = '[Shorttrips SOAP] ' . $action . ': ' . $message;
        if (!empty($context)) {
            $prefix .= ' ' . wp_json_encode($context);
        }
        // error_log($prefix);  // Disabled for performance
    }
}

if (!function_exists('shorttrips_call_nonstatic_soap_callable')) {
    function shorttrips_call_nonstatic_soap_callable($action, callable $bodyBuilder, array $options = [])
    {
        $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : [];
        $creds = wp_parse_args($creds, [
            'username' => '',
            'password' => '',
            'language' => 'en',
            'currency' => 'EUR',
        ]);

        $defaults = [
            'timeout' => 90,
            'retries' => 0,
            'retry_delay' => 2,
            'log_tag' => $action,
        ];
        $options = wp_parse_args($options, $defaults);

        $payloadBase = [
            'userName' => $creds['username'],
            'password' => $creds['password'],
            'language' => $creds['language'],
            'currencies' => $creds['currency'],
        ];

        $builderResult = $bodyBuilder($creds);
        if (is_array($builderResult)) {
            if (!isset($builderResult['currencies']) && isset($builderResult['currency'])) {
                $builderResult['currencies'] = $builderResult['currency'];
            }
            $payload = array_merge($payloadBase, $builderResult);
            if (!isset($payload['currency']) && isset($payload['currencies'])) {
                $payload['currency'] = $payload['currencies'];
            }
            $bodyXml = shorttrips_array_to_xml_nodes($payload);
        } else {
            $bodyXml = shorttrips_array_to_xml_nodes($payloadBase) . (string) $builderResult;
        }

        $ns = 'http://xml.sunhotels.net/15/';
        $endpoint = 'https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx';
        $soapEnvelope = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<' . $action . ' xmlns="' . $ns . '">'
            . $bodyXml
            . '</' . $action . '>'
            . '</soap:Body>'
            . '</soap:Envelope>';

        $attempts = max(0, (int) $options['retries']);
        $response = null;
        for ($try = 0; $try <= $attempts; $try++) {
            $response = wp_remote_post($endpoint, [
                'headers' => [
                    'Content-Type' => 'text/xml; charset=utf-8',
                    'SOAPAction' => '"' . $ns . $action . '"'
                ],
                'body' => $soapEnvelope,
                'timeout' => (int) $options['timeout'],
            ]);
            if (!is_wp_error($response) && !empty($response['body'])) {
                break;
            }
            if ($try < $attempts) {
                shorttrips_log_soap_event($options['log_tag'], 'Retrying request', [
                    'attempt' => $try + 1,
                    'reason' => is_wp_error($response) ? $response->get_error_message() : 'empty body'
                ]);
                sleep(max(1, (int) $options['retry_delay']));
            }
        }

        if (is_wp_error($response) || empty($response['body'])) {
            shorttrips_log_soap_event($options['log_tag'], 'Request failed', [
                'error' => is_wp_error($response) ? $response->get_error_message() : 'empty body'
            ]);
            return new WP_Error('sunhotels_http_error', is_wp_error($response) ? $response->get_error_message() : 'Lege SOAP-response');
        }

        $body = trim($response['body']);
        if ($body === '') {
            $code = wp_remote_retrieve_response_code($response);
            shorttrips_log_soap_event($options['log_tag'], 'Empty SOAP response', ['http_code' => $code]);
            return new WP_Error('sunhotels_empty_response', 'Sunhotels gaf een leeg antwoord (HTTP ' . ($code ?: 'onbekend') . ').');
        }
        $body = preg_replace('/^\xEF\xBB\xBF/', '', $body);
        libxml_use_internal_errors(true);
        $xml = @simplexml_load_string($body);
        if (!$xml) {
            $sanitized = preg_replace('/[^\x09\x0A\x0D\x20-\x{D7FF}\x{E000}-\x{FFFD}]+/u', '', $body);
            if ($sanitized !== null && $sanitized !== $body) {
                $xml = @simplexml_load_string($sanitized);
                $body = $sanitized;
            }
        }
        if (!$xml && stripos($body, '<soap:Envelope') !== false) {
            $dom = new DOMDocument();
            if (@$dom->loadXML($body)) {
                $xml = simplexml_import_dom($dom);
            }
        }
        libxml_clear_errors();
        if (!$xml) {
            $snippet = trim(substr(preg_replace('/\s+/', ' ', strip_tags($body)), 0, 200));
            shorttrips_log_soap_event($options['log_tag'], 'XML parse error', ['snippet' => $snippet]);
            return new WP_Error('sunhotels_xml_error', 'Kon SOAP-response niet parseren: ' . ($snippet !== '' ? $snippet : '(leeg XML-document)'));
        }
        $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
        $xml->registerXPathNamespace('sh', $ns);

        return [
            'xml' => $xml,
            'body' => $response['body'],
            'headers' => $response['headers'] ?? [],
        ];
    }
}

if (!function_exists('shorttrips_call_nonstatic_soap')) {
    function shorttrips_call_nonstatic_soap($action, array $params = [], array $options = [])
    {
        return shorttrips_call_nonstatic_soap_callable($action, function () use ($params) {
            return $params;
        }, $options);
    }
}

if (!function_exists('shorttrips_parse_soap')) {
    function shorttrips_parse_soap($response, array $paths = [])
    {
        if (is_wp_error($response)) {
            return $response;
        }
        $xml = $response instanceof SimpleXMLElement ? $response : ($response['xml'] ?? null);
        if (!$xml instanceof SimpleXMLElement) {
            return new WP_Error('sunhotels_invalid_response', 'SOAP response ontbreekt.');
        }
        $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
        $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
        if (empty($paths)) {
            return $xml;
        }
        $out = [];
        foreach ($paths as $key => $path) {
            $out[$key] = $xml->xpath($path) ?: [];
        }
        return $out;
    }
}

if (!function_exists('shorttrips_format_currency')) {
    function shorttrips_format_currency($amount, $currency = 'EUR')
    {
        if ($amount === null || $amount === '') {
            return '';
        }
        $symbol = strtoupper($currency) === 'EUR' ? '‚Ç¨' : strtoupper($currency);
        return sprintf('%s %s', $symbol, number_format((float) $amount, 2, ',', '.'));
    }
}

/*  
|--------------------------------------------------------------------------
| SHORTTRIPS SEARCH MODULE ‚Äì DEEL 2 / 3
|  - Live prijzen via SearchV3 (NonStaticXMLAPI)
|  - Statische details uit lokale tabel ghwk_bravo_hotels
|--------------------------------------------------------------------------
*/
add_action('wp_ajax_shorttrips_search_hotels', 'shorttrips_search_hotels');
add_action('wp_ajax_nopriv_shorttrips_search_hotels', 'shorttrips_search_hotels');

/*--------------------------------------------------------------------------
| UNIVERSAL AUTOCOMPLETE SEARCH
|--------------------------------------------------------------------------
| Google-style autocomplete search voor hotels, steden, regio's en landen
| Zoekt in real-time tijdens typen (debounced)
|--------------------------------------------------------------------------
*/

add_action('wp_ajax_shorttrips_autocomplete', 'shorttrips_autocomplete_search');
add_action('wp_ajax_nopriv_shorttrips_autocomplete', 'shorttrips_autocomplete_search');

function shorttrips_autocomplete_search()
{
    global $wpdb;

    // Immediately close session to allow concurrent requests
    // This prevents blocking other AJAX calls (like hotel search API)
    if (session_id()) {
        session_write_close();
    }

    // Debug logging (disabled in production for performance)
    // error_log('üîç Autocomplete search called with query: ' . ($_GET['q'] ?? 'EMPTY'));

    // Validate input
    $query = isset($_GET['q']) ? sanitize_text_field($_GET['q']) : '';

    if (strlen($query) < 2) {
        wp_send_json(['results' => []]);
        return;
    }

    // Check cache first (120 seconds TTL for speed)
    $cache_key = 'st_autocomplete_' . md5(strtolower($query));
    $cached = get_transient($cache_key);
    if ($cached !== false) {
        // Cache hit - return immediately without debug logging
        wp_send_json(['results' => $cached, 'cached' => true]);
        return;
    }

    // DO NOT set_time_limit here - it can affect other concurrent requests!
    // Let PHP use the default timeout (30s or as configured in php.ini)

    $results = [];

    // Check if lookup table exists
    $lookup_table = $wpdb->prefix . 'autocomplete_lookup';
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE '{$lookup_table}'") === $lookup_table;

    if ($table_exists) {
        static $lookupHasHotelId = null;
        if ($lookupHasHotelId === null) {
            $columnCheck = $wpdb->get_var("SHOW COLUMNS FROM {$lookup_table} LIKE 'hotel_id'");
            $lookupHasHotelId = !empty($columnCheck);
        }
        $selectCols = "
                type,
                search_term as name,
                display_name,
                country_name,
                destination_id,
                hotel_count,
                priority,
                stars" . ($lookupHasHotelId ? ", hotel_id" : "") . "
        ";

        // ‚úÖ ULTRA-FAST: Use dedicated autocomplete lookup table
        $query_lower = strtolower($wpdb->esc_like($query)) . '%';

        // Ultra-fast query with minimal columns and LIMIT 100 (was 5 - te weinig!)
        // Note: MySQL will automatically choose the best index
        $lookup_results = $wpdb->get_results($wpdb->prepare(
            "SELECT 
                {$selectCols}
            FROM {$lookup_table}
            WHERE search_term_lower LIKE %s
            ORDER BY priority ASC
            LIMIT 100",
            $query_lower
        ));

        foreach ($lookup_results as $item) {
            if ($item->type === 'city') {
                $results[] = [
                    'type' => 'city',
                    'name' => $item->name,
                    'country' => $item->country_name ?: '',
                    'destination_id' => (int) $item->destination_id,
                    'hotel_count' => (int) ($item->hotel_count ?: 0),
                    'label' => $item->display_name,
                    'sublabel' => $item->country_name . ($item->hotel_count > 0 ? ' (' . $item->hotel_count . ' hotels)' : ''),
                    'icon' => 'üèôÔ∏è'
                ];
            } elseif ($item->type === 'country') {
                $results[] = [
                    'type' => 'country',
                    'name' => $item->name,
                    'destination_id' => (int) $item->destination_id,
                    'hotel_count' => (int) ($item->hotel_count ?: 0),
                    'label' => $item->display_name,
                    'sublabel' => $item->hotel_count > 0 ? $item->hotel_count . ' hotels' : 'Land',
                    'icon' => 'üåç'
                ];
            } elseif ($item->type === 'hotel') {
                $results[] = [
                    'type' => 'hotel',
                    'name' => $item->name,
                    'country' => $item->country_name ?: '',
                    'hotel_id' => $lookupHasHotelId && isset($item->hotel_id) ? (int) $item->hotel_id : null,
                    'stars' => isset($item->stars) ? (int) $item->stars : null,
                    'label' => $item->display_name,
                    'sublabel' => $item->country_name ?: 'Hotel',
                    'icon' => 'üè®'
                ];
            }
        }
    } else {
        // ‚ö†Ô∏è FALLBACK: Lookup table niet gevonden, gebruik oude queries
        // error_log('ShortTrips Autocomplete: Lookup table niet gevonden. Run CREATE-AUTOCOMPLETE-TABLE.sql');

        $query_start = $wpdb->esc_like($query) . '%';

        // Simplified fallback: alleen cities (LIMIT 100 voor alle steden)
        $cities = $wpdb->get_results($wpdb->prepare(
            "SELECT DISTINCT
                city as name,
                country_name as country,
                destination_id
            FROM ghwk_bravo_hotels
            WHERE city LIKE %s
            AND city IS NOT NULL
            AND city != ''
            LIMIT 100",
            $query_start
        ));

        foreach ($cities as $city) {
            $results[] = [
                'type' => 'city',
                'name' => $city->name,
                'country' => $city->country,
                'destination_id' => $city->destination_id,
                'label' => $city->name,
                'sublabel' => $city->country,
                'icon' => 'üèôÔ∏è'
            ];
        }
    }

    // Results limited to 100 in query (was 5, verhoogd voor complete city list)

    // Cache voor 120 seconden (was 60, nu langer voor betere performance)
    set_transient($cache_key, $results, 120);

    // Return results immediately (no debug logging in production)
    wp_send_json([
        'results' => $results,
        'query' => $query,
        'total' => count($results),
        'cached' => false
    ]);
}

/**
 * Generate fallback date ranges when no hotels are available
 * Returns array of alternative date ranges to try
 */
function shorttrips_generate_fallback_dates($originalCheckin, $originalCheckout)
{
    try {
        $checkinDate = new DateTime($originalCheckin);
        $checkoutDate = new DateTime($originalCheckout);
    } catch (Exception $e) {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('[Shorttrips Fallback Dates] Invalid input checkin="' . $originalCheckin . '" checkout="' . $originalCheckout . '": ' . $e->getMessage());
        }
        return [];
    }
    $nights = $checkinDate->diff($checkoutDate)->days;

    $fallbacks = [];
    $intervals = [7, 14, 21, 30]; // Try 1 week, 2 weeks, 3 weeks, 1 month later

    foreach ($intervals as $daysLater) {
        $newCheckin = clone $checkinDate;
        $newCheckin->modify("+{$daysLater} days");

        $newCheckout = clone $newCheckin;
        $newCheckout->modify("+{$nights} days");

        $fallbacks[] = [
            'checkin' => $newCheckin->format('Y-m-d'),
            'checkout' => $newCheckout->format('Y-m-d'),
            'nights' => $nights,
            'label' => $newCheckin->format('d M') . ' - ' . $newCheckout->format('d M Y')
        ];
    }

    return $fallbacks;
}

function shorttrips_search_hotels()
{
    global $wpdb;

    // Error handling and logging
    $start_time = microtime(true);
    $debug_info = [];

    if (defined('WP_DEBUG') && WP_DEBUG) {
    }

    // Validate this is actually an AJAX request for search
    if (empty($_POST['action']) || $_POST['action'] !== 'shorttrips_search_hotels') {
        // FORCE LOGGING (bypass WP_DEBUG check)
        // error_log('‚ùå INVALID SEARCH REQUEST');
        // error_log('   POST action: ' . ($_POST['action'] ?? 'MISSING'));
        // error_log('   POST keys: ' . implode(', ', array_keys($_POST)));
        echo '<div class="text-center py-8"><p class="text-red-500">Ongeldige zoekopdracht</p></div>';
        wp_die();
    }

    // DEBUG: Log received parameters (only when WP_DEBUG is enabled)
    if (defined('WP_DEBUG') && WP_DEBUG) {
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        error_log('üîç SEARCH REQUEST RECEIVED');
        error_log('   destinationID from POST: ' . ($_POST['destinationID'] ?? 'MISSING'));
        error_log('   destinationID from GET: ' . ($_GET['destinationID'] ?? 'MISSING'));
        error_log('   type: ' . ($_POST['type'] ?? 'MISSING'));
        error_log('   resort_name: ' . ($_POST['resort_name'] ?? 'MISSING'));
        error_log('   country_name: ' . ($_POST['country_name'] ?? 'MISSING'));
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    }

    // Invoer (support POST for form submissions, GET for universal search)
    $type = sanitize_text_field($_POST['type'] ?? $_GET['type'] ?? '');
    $q = sanitize_text_field($_POST['q'] ?? $_GET['q'] ?? '');

    // üåê Override language from AJAX request if provided
    $requestLang = sanitize_text_field($_POST['lang'] ?? '');
    if (!empty($requestLang)) {
        // Store in global for later retrieval by shorttrips_get_current_language()
        global $shorttrips_ajax_lang;
        $shorttrips_ajax_lang = $requestLang;

        // Debug: Log language override
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('üåê AJAX Language override: ' . $requestLang);
        }
    }

    // Check of dit van het zoekformulier komt (heeft action parameter)
    $fromSearchForm = !empty($_POST['action']) && $_POST['action'] === 'shorttrips_search_hotels';

    // Support voor directe ID parameters (van destinations pagina EN universal search via GET)
    $destinationIDParam = intval(
        $_POST['destinationID'] ?? $_POST['destination_id'] ??
        $_GET['destinationID'] ?? $_GET['destination_id'] ?? 0
    );
    $resortRaw = $_POST['resortIDs'] ?? $_POST['resort_ids'] ??
        $_GET['resortIDs'] ?? $_GET['resort_ids'] ?? 0;
    if (is_array($resortRaw)) {
        $filteredResortIds = array_filter($resortRaw);
        $resortRaw = reset($filteredResortIds);
    }
    $resortIDsParam = intval($resortRaw);
    $hotelIDsParamRaw = $_POST['hotelIDs'] ?? $_GET['hotelIDs'] ?? 0;
    if (is_array($hotelIDsParamRaw)) {
        $filteredHotelIds = array_filter($hotelIDsParamRaw);
        $hotelIDsParamRaw = reset($filteredHotelIds);
    }
    $hotelIDsParam = intval($hotelIDsParamRaw);
    $selectedHotelLabel = isset($_POST['selected_hotel_label']) ? sanitize_text_field(wp_unslash($_POST['selected_hotel_label'])) : '';

    // Support both text names AND IDs (from POST or GET for universal search)
    // Let op: sommige formulieren sturen alleen ?country= of ?resort= via GET
    $countryInput = sanitize_text_field(
        $_POST['country']
        ?? $_POST['country_name']
        ?? $_GET['country']
        ?? $_GET['country_name']
        ?? ''
    );
    $resortInput = sanitize_text_field(
        $_POST['resort']
        ?? $_POST['resort_name']
        ?? $_GET['resort']
        ?? $_GET['resort_name']
        ?? ''
    );

    // Als het een nummer is, gebruik als ID, anders als naam
    $country = is_numeric($countryInput) ? intval($countryInput) : 0;
    $resort = is_numeric($resortInput) ? intval($resortInput) : 0;

    // Als niet-numeriek, sla naam op voor later
    $countryName = !is_numeric($countryInput) && !empty($countryInput) ? $countryInput : '';
    $resortName = !is_numeric($resortInput) && !empty($resortInput) ? $resortInput : '';
    $checkin = sanitize_text_field($_POST['checkin'] ?? '');
    $checkout = sanitize_text_field($_POST['checkout'] ?? '');
    $rooms = 1;  // üîß CRITICAL: SunHotels API ALTIJD rooms=1 (niet meerdere kamers)
    $adults = max(1, intval($_POST['adults'] ?? 2));
    $children = max(0, intval($_POST['children'] ?? 0));
    $childAgesStr = sanitize_text_field($_POST['child_ages'] ?? '');
    $childAges = array_values(array_filter(array_map('intval', array_filter(array_map('trim', explode(',', $childAgesStr)))), function ($v) {
        return $v >= 0 && $v <= 17; }));
    if ($children > 0) {
        // pad/truncate zodat count overeenkomt met aantal kinderen
        if (count($childAges) < $children) {
            $childAges = array_pad($childAges, $children, 0);
        } elseif (count($childAges) > $children) {
            $childAges = array_slice($childAges, 0, $children);
        }
    } else {
        $childAges = [];
    }

    // SORTEER PARAMETER
    $sortBy = sanitize_text_field($_POST['sortBy'] ?? '');

    // üîß FIX: FILTER PARAMETERS (van sidebar widget)
    $minStars = isset($_POST['minStars']) && $_POST['minStars'] !== '' ? intval($_POST['minStars']) : 0;
    $maxStars = isset($_POST['maxStars']) && $_POST['maxStars'] !== '' ? intval($_POST['maxStars']) : 0;
    $minPrice = isset($_POST['minPrice']) && $_POST['minPrice'] !== '' ? floatval($_POST['minPrice']) : 0;
    $maxPrice = isset($_POST['maxPrice']) && $_POST['maxPrice'] !== '' ? floatval($_POST['maxPrice']) : 0;
    $excludeSharedRooms = isset($_POST['excludeSharedRooms']) && $_POST['excludeSharedRooms'] === '1';
    $excludeSharedFacilities = isset($_POST['excludeSharedFacilities']) && $_POST['excludeSharedFacilities'] === '1';

    // Multi-select filters (arrays)
    $featureIds = [];
    $themeIds = [];
    $mealIds = [];

    if (isset($_POST['featureIds']) && is_array($_POST['featureIds'])) {
        $featureIds = array_map('intval', $_POST['featureIds']);
    }
    if (isset($_POST['themeIds']) && is_array($_POST['themeIds'])) {
        $themeIds = array_map('intval', $_POST['themeIds']);
    }
    if (isset($_POST['mealIds']) && is_array($_POST['mealIds'])) {
        $mealIds = array_map('intval', $_POST['mealIds']);
    }

    // Veilige datum-defaults als leeg (morgen t/m +3 nachten)
    if ($checkin === '' || $checkout === '') {
        $ci = new DateTime('tomorrow');
        $co = (clone $ci)->modify('+3 days');
        if ($checkin === '')
            $checkin = $ci->format('Y-m-d');
        if ($checkout === '')
            $checkout = $co->format('Y-m-d');
    }

    // Bereken aantal nachten voor fallback logica
    try {
        $checkinObj = new DateTime($checkin);
        $checkoutObj = new DateTime($checkout);
        $nights = max(1, $checkinObj->diff($checkoutObj)->days);
    } catch (Exception $e) {
        $nights = 1;
    }

    // --------- Bestemming bepalen (kritieke fix) ----------
    $destinationId = 0;

    // Prioriteit: eerst directe ID parameters checken (van destinations pagina EN universal search)
    if ($destinationIDParam > 0) {
        $destinationId = $destinationIDParam;
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('‚úÖ Using destinationID from parameter: ' . $destinationId);
        }
        // Zet $resort variabele voor gebruik in alternatieve links
        if (!$resort)
            $resort = $destinationId;
    } elseif ($resortIDsParam > 0) {
        $destinationId = $resortIDsParam;
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('‚úÖ Using resortIDs param: ' . $destinationId);
        }
    } elseif ($type === 'resort' && !empty($resortName) && $destinationIDParam == 0) {
        // üîß CRITICAL FIX: Universal search sends resort_name but may not have destinationID
        // Do a database lookup EARLY to get destinationID
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        error_log('üîç EARLY DESTINATIONID LOOKUP');
        error_log('   ‚îú‚îÄ Resort Name: ' . $resortName);
        error_log('   ‚îú‚îÄ Country Name: ' . ($countryName ?: 'N/A'));
        error_log('   ‚îî‚îÄ Type: ' . $type);

        // Strategy 1: Try ghwk_bravo_hotels (has destination_id per city)
        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT destination_id
         FROM ghwk_bravo_hotels
        WHERE city = %s
          AND destination_id IS NOT NULL
          AND destination_id > 0
        LIMIT 1",
            $resortName
        ));

        if ($destinationId > 0) {
            error_log('   ‚úÖ Found in ghwk_bravo_hotels: ' . $destinationId);
        }

        // Strategy 2: Try with LIKE for partial matches
        if (empty($destinationId)) {
            $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                "SELECT destination_id
           FROM ghwk_bravo_hotels
          WHERE city LIKE %s
            AND destination_id IS NOT NULL
            AND destination_id > 0
          ORDER BY (city = %s) DESC
          LIMIT 1",
                '%' . $wpdb->esc_like($resortName) . '%',
                $resortName
            ));

            if ($destinationId > 0) {
                error_log('   ‚úÖ Found in ghwk_bravo_hotels (LIKE): ' . $destinationId);
            }
        }

        // Strategy 3: Try bravo_destinations table (exact match)
        if (empty($destinationId)) {
            $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                "SELECT destination_id
           FROM bravo_destinations
          WHERE destination_name = %s
            AND destination_id IS NOT NULL
            AND deleted_at IS NULL
          LIMIT 1",
                $resortName
            ));

            if ($destinationId > 0) {
                error_log('   ‚úÖ Found in bravo_destinations: ' . $destinationId);
            }
        }

        // Strategy 4: Try bravo_destinations with LIKE
        if (empty($destinationId)) {
            $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                "SELECT destination_id
           FROM bravo_destinations
          WHERE destination_name LIKE %s
            AND destination_id IS NOT NULL
            AND deleted_at IS NULL
          ORDER BY (destination_name = %s) DESC
          LIMIT 1",
                '%' . $wpdb->esc_like($resortName) . '%',
                $resortName
            ));

            if ($destinationId > 0) {
                error_log('   ‚úÖ Found in bravo_destinations (LIKE): ' . $destinationId);
            }
        }

        // Strategy 5: Use country as fallback if we have country name
        if (empty($destinationId) && !empty($countryName)) {
            error_log('   ‚ö†Ô∏è City lookup failed, trying country: ' . $countryName);
            $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                "SELECT destination_id
           FROM ghwk_bravo_hotels
          WHERE country_name = %s
            AND destination_id IS NOT NULL
            AND destination_id > 0
          LIMIT 1",
                $countryName
            ));

            if ($destinationId > 0) {
                error_log('   ‚úÖ Found via country fallback: ' . $destinationId);
            }
        }

        if ($destinationId > 0) {
            error_log('üéØ FINAL RESULT: destinationID = ' . $destinationId);
        } else {
            error_log('‚ùå FAILED: Could not find destinationID for: ' . $resortName);
        }
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        // Zet $resort variabele voor gebruik in alternatieve links
        if (!$resort)
            $resort = $destinationId;
    } elseif ($type === 'resort' && empty($resortName) && !empty($countryName)) {
        // Resort-zoekopdracht zonder stad (bijv. alleen land meegegeven) ‚Üí neem eerste stad uit land
        error_log('‚ö†Ô∏è Resort search without city, trying first destination for country: ' . $countryName);
        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT destination_id
         FROM ghwk_bravo_hotels
        WHERE country_name = %s
          AND destination_id IS NOT NULL
        GROUP BY destination_id
        ORDER BY COUNT(*) DESC
        LIMIT 1",
            $countryName
        ));
        if ($destinationId > 0) {
            error_log('   ‚úÖ Using fallback destination ' . $destinationId . ' for country ' . $countryName);
        } else {
            error_log('   ‚ùå No destination found for country fallback');
        }
    } elseif ($hotelIDsParam > 0) {
        // Voor hotelIDs moeten we de destination_id opzoeken
        // Dit wordt later in de code gedaan bij het ophalen van static hotel data
        $destinationId = 0; // Will be handled by hotel-specific logic
    } elseif ($type === 'free' && $q !== '') {
        // Free-text ‚Üí pak destination_id uit bravo_destinations
        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT destination_id
         FROM bravo_destinations
        WHERE (destination_name LIKE %s OR country_name LIKE %s)
          AND destination_id IS NOT NULL
          AND deleted_at IS NULL
        ORDER BY (destination_name LIKE %s) DESC, destination_name ASC
        LIMIT 1",
            "%{$q}%",
            "%{$q}%",
            "{$q}%"
        ));
    } elseif ($type === 'search' && $q !== '') {
        // Search type met query string
        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT destination_id
         FROM bravo_destinations
        WHERE (destination_name LIKE %s OR country_name LIKE %s)
          AND destination_id IS NOT NULL
          AND deleted_at IS NULL
        ORDER BY (destination_name LIKE %s) DESC, destination_name ASC
        LIMIT 1",
            "%{$q}%",
            "%{$q}%",
            "{$q}%"
        ));
    } elseif ($type === 'resort' || $type === 'country') {
        // NEW: Support voor tekst namen (vanuit destinations pagina)
        if (!empty($resortName)) {
            // Zoek destination ID op basis van resort naam
            $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                "SELECT destination_id
           FROM bravo_destinations
          WHERE destination_name LIKE %s
            AND destination_id IS NOT NULL
            AND deleted_at IS NULL
          ORDER BY (destination_name = %s) DESC, destination_name ASC
          LIMIT 1",
                "%{$resortName}%",
                $resortName
            ));
        } elseif (!empty($countryName) && $type === 'country') {
            // Voor land-zoekacties: check of er een stad/resort is meegegeven
            // Als JA: gebruik die (van zoekformulier popup)
            // Als NEEN EN niet van zoekformulier: toon stad-selector (van Popular Destinations klik)

            if ($resort > 0) {
                // Resort ID is meegegeven (van zoekformulier)
                $destinationId = $resort;
            } elseif (!empty($resortName)) {
                // Resort naam is meegegeven (van zoekformulier popup)
                // ‚úÖ OPTIMIZED: Try exact match first (fast), then LIKE (slower) with index hint
                $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                    "SELECT destination_id
             FROM bravo_destinations
            WHERE destination_name = %s
              AND destination_id IS NOT NULL
              AND deleted_at IS NULL
            LIMIT 1",
                    $resortName
                ));
                if (empty($destinationId)) {
                    // Fallback to LIKE search if exact match fails
                    $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                        "SELECT destination_id
               FROM bravo_destinations
              WHERE destination_name LIKE %s
                AND destination_id IS NOT NULL
                AND deleted_at IS NULL
              LIMIT 1",
                        "%{$resortName}%"
                    ));
                }
            } else {
                // GEEN specifieke stad gekozen ‚Üí gebruik eerste stad in het land als fallback
                // Dit gebeurt bij: zoekformulier zonder stad, country cards, etc.
                error_log('üîç Looking for first destination in country: ' . $countryName);

                // ‚úÖ OPTIMIZED: Cache this query result
                $cacheKey = 'st_first_dest_' . md5($countryName);
                $destinationId = get_transient($cacheKey);

                if (false === $destinationId) {
                    // Try exact match first
                    $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                        "SELECT destination_id
               FROM bravo_destinations
              WHERE country_name = %s
                AND destination_id IS NOT NULL
                AND deleted_at IS NULL
              ORDER BY destination_name ASC
              LIMIT 1",
                        $countryName
                    ));

                    error_log('   ‚îú‚îÄ Exact match result: ' . ($destinationId ? $destinationId : 'none'));

                    // üîß FIX: Fallback to LIKE if exact match fails (handles Turkey/T√ºrkiye)
                    if (empty($destinationId)) {
                        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                            "SELECT destination_id
                 FROM bravo_destinations
                WHERE country_name LIKE %s
                  AND destination_id IS NOT NULL
                  AND deleted_at IS NULL
                ORDER BY destination_name ASC
                LIMIT 1",
                            '%' . $wpdb->esc_like($countryName) . '%'
                        ));

                        error_log('   ‚îî‚îÄ LIKE match result: ' . ($destinationId ? $destinationId : 'NONE FOUND!'));
                    }

                    // Cache for 1 hour
                    set_transient($cacheKey, $destinationId, HOUR_IN_SECONDS);
                } else {
                    error_log('   ‚îî‚îÄ Using cached destinationID: ' . $destinationId);
                }

                if (empty($destinationId)) {
                    // Geen stad gevonden: toon foutmelding
                    echo '<div class="st-fullbleed" style="padding:40px;text-align:center;"><div style="max-width:600px;margin:0 auto;"><div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div><h3 style="color:#dc2626;margin-bottom:12px;">Geen steden gevonden</h3><p style="color:#6b7280;">We hebben geen steden gevonden voor ' . esc_html($countryName) . '. Probeer een ander land.</p></div></div>';
                    wp_die();
                }
            }
        }

        // Debug logging
        if (defined('WP_DEBUG') && WP_DEBUG) {
        }
    } elseif ($resort) {
        // ID opgegeven
        $destinationId = $resort;
    } elseif ($country) {
        // Alleen land ID gekozen ‚Üí kies eerste regio binnen dit land
        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
            "SELECT destination_id
         FROM bravo_destinations
        WHERE country_id = %d
          AND destination_id IS NOT NULL
        ORDER BY destination_name ASC
        LIMIT 1",
            $country
        ));
        if (empty($destinationId)) {
            echo '<p class="text-red-500 text-center">Kies een regio: er zijn geen Sunhotels-regio\'s gevonden voor dit land.</p>';
            wp_die();
        }
    } elseif (!empty($countryName)) {
        // NIEUW: Header search widget - country_name zonder type parameter
        // Check of er een resort/stad is meegegeven
        if (!empty($resort) || !empty($resortName)) {
            // Stad is gekozen, gebruik die
            if ($resort) {
                $destinationId = $resort;
            } else {
                $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                    "SELECT destination_id FROM bravo_destinations WHERE destination_name LIKE %s AND destination_id IS NOT NULL AND deleted_at IS NULL LIMIT 1",
                    "%{$resortName}%"
                ));
            }
        } else {
            // Alleen land, geen stad: trigger stad-selector
            $destinationId = 0;
            $type = 'country';
        }

        if (defined('WP_DEBUG') && WP_DEBUG) {
        }
    } else {
        // Fallback voor oude gedrag
        if ($resort) {
            $destinationId = $resort;
        } elseif ($country) {
            $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                "SELECT destination_id
           FROM bravo_destinations
          WHERE country_id = %d
            AND destination_id IS NOT NULL
          ORDER BY destination_name ASC
          LIMIT 1",
                $country
            ));
        }
    }
    // Just-in-time Static fallback (cached) for a single hotelId ‚Äì minimal fields only
    if (!function_exists('shorttrips_get_static_hotel_cached')) {
        function shorttrips_get_static_hotel_cached(int $hotelId): array
        {
            if ($hotelId <= 0)
                return [];
            $key = 'st_static_hotel_' . $hotelId;
            $cached = get_transient($key);
            if (is_array($cached))
                return $cached;
            $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
            $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';
            $soap = '<?xml version="1.0" encoding="utf-8"?>'
                . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
                . '<soap:Body>'
                . '<GetStaticHotelsAndRooms xmlns="http://xml.sunhotels.net/15/">'
                . '<userName>' . esc_html($creds['username']) . '</userName>'
                . '<password>' . esc_html($creds['password']) . '</password>'
                . '<language>' . esc_html($creds['language']) . '</language>'
                . '<hotelIds>' . intval($hotelId) . '</hotelIds>'
                . '<showRoomTypeName>false</showRoomTypeName>'
                . '</GetStaticHotelsAndRooms>'
                . '</soap:Body>'
                . '</soap:Envelope>';
            $r = wp_remote_post($endpoint, [
                'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetStaticHotelsAndRooms"'],
                'body' => $soap,
                'timeout' => 30,
            ]);
            $out = [];
            if (!is_wp_error($r) && !empty($r['body'])) {
                $xml = @simplexml_load_string($r['body']);
                if ($xml) {
                    $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    $h = $xml->xpath('//soap:Body//sh:getStaticHotelsAndRoomsResult//sh:hotels//sh:hotel');
                    if ($h && isset($h[0])) {
                        $n = $h[0];
                        $out = [
                            'title' => (string) ($n->name ?? ''),
                            'hotelname' => (string) ($n->hotelname ?? ''),
                            'description' => (string) ($n->description ?? ''),
                            'address' => (string) ($n->address ?? ''),
                            'category' => (int) ($n->category ?? 0),
                            'main_image' => (string) ($n->main_image ?? ''),
                            'image' => (string) ($n->image ?? ''),
                            'banner_image' => (string) ($n->banner_image ?? ''),
                        ];
                    }
                }
            }
            // Cache 6 uur zodat results‚Äëlijst stabiel foto/tekst kan tonen
            set_transient($key, $out, 6 * HOUR_IN_SECONDS);
            return $out;
        }
    }

    // DATABASE FALLBACK: Als geen destinationId gevonden, zoek direct in lokale database
    // Dit gebeurt bij country-level searches of onbekende bestemmingen
    // üö® BELANGRIJKE WIJZIGING: Database fallback VERWIJDERD
    // Reden: Database hotels hebben GEEN beschikbaarheidsinformatie
    // We tonen ALLEEN hotels met ECHTE beschikbaarheid via de Sunhotels API
    // Dit voorkomt dat gebruikers hotels zien die niet beschikbaar zijn voor hun datums

    if (empty($destinationId)) {
        // Geen destination ID = geen directe API call mogelijk
        // Voor COUNTRY searches: toon populaire steden selector
        // Voor andere: toon error melding

        if (!empty($countryName) && $type === 'country') {
            // üèôÔ∏è COUNTRY SEARCH: Toon populaire steden selector

            echo '<div class="st-fullbleed" style="padding:40px;max-width:900px;margin:0 auto;">';
            echo '<h2 style="font-size:28px;font-weight:700;margin-bottom:16px;text-align:center;">üè® Kies een stad in ' . esc_html($countryName) . '</h2>';
            echo '<p style="font-size:16px;color:#6b7280;text-align:center;margin-bottom:32px;">Selecteer een stad om hotels met beschikbaarheid te bekijken voor uw gekozen data.</p>';

            // Haal populaire steden op voor dit land uit bravo_destinations
            // ‚úÖ OPTIMIZED: Exact match first (uses index), then LIKE if needed
            $popularCities = $wpdb->get_results($wpdb->prepare(
                "SELECT DISTINCT destination_id, destination_name
         FROM bravo_destinations
         WHERE country_name = %s
           AND destination_id IS NOT NULL
           AND deleted_at IS NULL
         ORDER BY destination_name ASC
         LIMIT 20",
                $countryName
            ), ARRAY_A);

            // Fallback to LIKE if exact match returns nothing
            if (empty($popularCities)) {
                $popularCities = $wpdb->get_results($wpdb->prepare(
                    "SELECT DISTINCT destination_id, destination_name
           FROM bravo_destinations
           WHERE country_name LIKE %s
             AND destination_id IS NOT NULL
             AND deleted_at IS NULL
           ORDER BY destination_name ASC
           LIMIT 20",
                    '%' . $wpdb->esc_like($countryName) . '%'
                ), ARRAY_A);
            }

            if (!is_array($popularCities)) {
                $popularCities = [];
            }

            if (!empty($popularCities)) {
                echo '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:32px;">';

                foreach ($popularCities as $city) {
                    // Bouw search URL met destinationID (voor API call met beschikbaarheid)
                    $citySearchUrl = add_query_arg([
                        'destinationID' => $city['destination_id'],
                        'checkin' => $checkin,
                        'checkout' => $checkout,
                        'rooms' => $rooms,
                        'adults' => $adults,
                        'children' => $children,
                        'child_ages' => !empty($childAges) ? implode(',', $childAges) : ''
                    ], shorttrips_get_hotels_page_url());

                    echo '<a href="' . esc_url($citySearchUrl) . '" style="display:block;padding:24px;background:#fff;border:2px solid #e5e7eb;border-radius:12px;text-align:center;text-decoration:none;transition:all 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.05);" onmouseover="this.style.borderColor=\'#2563eb\';this.style.background=\'#f0f9ff\';this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(37,99,235,0.15)\';" onmouseout="this.style.borderColor=\'#e5e7eb\';this.style.background=\'#fff\';this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.05)\';">';
                    echo '<div style="font-size:18px;font-weight:600;color:#1f2937;">' . esc_html($city['destination_name']) . '</div>';
                    echo '</a>';
                }

                echo '</div>';

                // Info over beschikbaarheid
                echo '<div style="background:#eff6ff;border-left:4px solid #2563eb;padding:16px;border-radius:6px;margin-top:24px;">';
                echo '<p style="margin:0;font-size:14px;color:#1e40af;">';
                echo '<strong>‚ÑπÔ∏è Waarom een stad kiezen?</strong><br>';
                echo 'Wanneer u een specifieke stad selecteert, kunnen we direct hotels tonen met <strong>echte beschikbaarheid</strong> voor uw gekozen data (' . esc_html(date('d-m-Y', strtotime($checkin))) . ' tot ' . esc_html(date('d-m-Y', strtotime($checkout))) . ').';
                echo '</p>';
                echo '</div>';
            } else {
                // Geen steden gevonden voor dit land
                echo '<div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:20px;border-radius:8px;margin-bottom:24px;">';
                echo '<p style="margin:0;color:#92400e;">We hebben geen steden gevonden voor <strong>' . esc_html($countryName) . '</strong> in onze database. Probeer een ander land te selecteren.</p>';
                echo '</div>';
            }

            // Terug knop
            $backParams = [
                'checkin' => $checkin,
                'checkout' => $checkout,
                'rooms' => $rooms,
                'adults' => $adults,
                'children' => $children
            ];
            if (!empty($childAges))
                $backParams['child_ages'] = implode(',', $childAges);

            $backUrl = add_query_arg($backParams, shorttrips_get_hotels_page_url());

            echo '<div style="text-align:center;margin-top:32px;">';
            echo '<a href="' . esc_url($backUrl) . '" style="display:inline-block;padding:12px 24px;background:#6b7280;color:#fff;border-radius:8px;text-decoration:none;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background=\'#4b5563\'" onmouseout="this.style.background=\'#6b7280\'">‚Üê Kies een ander land</a>';
            echo '</div>';

            echo '</div>';
            wp_die();

        }
        // Note: Oude error code verwijderd - fallback systeem handelt alle "geen hotels" gevallen af
    }

    // OUDE DATABASE FALLBACK CODE VERWIJDERD (regel 3063-3425)
    // Deze code toonde hotels uit de lokale database ZONDER beschikbaarheidcheck
    // Dit veroorzaakte het probleem dat hotels zonder beschikbaarheid werden getoond

    // Vanaf hier alleen nog API calls met ECHTE beschikbaarheid
    if (!function_exists('shorttrips_locate_hotel_table')) {
        function shorttrips_locate_hotel_table()
        {
            global $wpdb;
            $candidates = ['ghwk_bravo_hotels', $wpdb->prefix . 'bravo_hotels', 'bravo_hotels'];
            foreach ($candidates as $candidate) {
                if (empty($candidate)) {
                    continue;
                }
                $exists = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $candidate));
                if ($exists) {
                    return $candidate;
                }
            }
            return null;
        }
    }

    if (!function_exists('shorttrips_get_alternative_hotels')) {
        function shorttrips_get_alternative_hotels($resortName, $countryName, $limit = 8)
        {
            global $wpdb;
            $table = shorttrips_locate_hotel_table();
            if (!$table || (empty($resortName) && empty($countryName))) {
                return [];
            }
            $conditions = [];
            $params = [];
            if (!empty($resortName)) {
                $conditions[] = 'destination_name = %s';
                $params[] = $resortName;
            } else {
                $conditions[] = 'country_name = %s';
                $params[] = $countryName;
            }
            $select = "SELECT hotel_id, destination_id, destination_name, country_name, hotelname, title, star_rate, main_image, image, price";
            $sql = "{$select} FROM {$table} WHERE " . implode(' AND ', $conditions) . " ORDER BY star_rate DESC, price ASC LIMIT %d";
            $params[] = absint($limit);
            $prepared = call_user_func_array([$wpdb, 'prepare'], array_merge([$sql], $params));
            $results = $wpdb->get_results($prepared, ARRAY_A);
            return is_array($results) ? $results : [];
        }
    }

    if (!function_exists('shorttrips_resolve_region_destination')) {
        function shorttrips_resolve_region_destination($destinationId, $resortName, $countryName, $hotelLabel = '')
        {
            global $wpdb;
            if ($destinationId > 0) {
                return (int) $destinationId;
            }
            if (!empty($resortName)) {
                $resolved = (int) $wpdb->get_var($wpdb->prepare(
                    "SELECT destination_id FROM ghwk_bravo_hotels WHERE destination_name = %s AND destination_id IS NOT NULL LIMIT 1",
                    $resortName
                ));
                if ($resolved > 0) {
                    return $resolved;
                }
                $resolved = (int) $wpdb->get_var($wpdb->prepare(
                    "SELECT destination_id FROM ghwk_bravo_hotels WHERE destination_name LIKE %s AND destination_id IS NOT NULL LIMIT 1",
                    '%' . $wpdb->esc_like($resortName) . '%'
                ));
                if ($resolved > 0) {
                    return $resolved;
                }
            }
            if (!empty($hotelLabel)) {
                $resolved = (int) $wpdb->get_var($wpdb->prepare(
                    "SELECT destination_id FROM ghwk_bravo_hotels WHERE TRIM(BOTH '\"' FROM hotelname) = %s AND destination_id IS NOT NULL LIMIT 1",
                    $hotelLabel
                ));
                if ($resolved > 0) {
                    return $resolved;
                }
                $resolved = (int) $wpdb->get_var($wpdb->prepare(
                    "SELECT destination_id FROM ghwk_bravo_hotels WHERE TRIM(BOTH '\"' FROM hotelname) LIKE %s AND destination_id IS NOT NULL LIMIT 1",
                    '%' . $wpdb->esc_like($hotelLabel) . '%'
                ));
                if ($resolved > 0) {
                    return $resolved;
                }
            }
            if (!empty($countryName)) {
                $resolved = (int) $wpdb->get_var($wpdb->prepare(
                    "SELECT destination_id FROM ghwk_bravo_hotels WHERE country_name = %s AND destination_id IS NOT NULL LIMIT 1",
                    $countryName
                ));
                if ($resolved > 0) {
                    return $resolved;
                }
            }
            return 0;
        }
    }

    if (!function_exists('shorttrips_fetch_region_availability_xml')) {
        function shorttrips_fetch_region_availability_xml($endpoint, $params)
        {
            $response = wp_remote_post($endpoint, [
                'headers' => ['Content-Type' => 'application/x-www-form-urlencoded'],
                'body' => http_build_query($params),
                'timeout' => 30,
            ]);
            if (is_wp_error($response) || empty($response['body'])) {
                return null;
            }
            $xml = @simplexml_load_string($response['body']);
            if ($xml && !empty($xml->hotels->hotel)) {
                return $xml;
            }
            return null;
        }
    }

    if (apply_filters('shorttrips_enable_legacy_database_fallback', false)) {
        global $wpdb;
        $hotel_table = null;
        $tables_to_check = ['ghwk_bravo_hotels', $wpdb->prefix . 'bravo_hotels', 'bravo_hotels'];
        foreach ($tables_to_check as $table) {
            $check = $wpdb->get_var("SHOW TABLES LIKE '{$table}'");
            if ($check) {
                $hotel_table = $table;
                break;
            }
        }

        if ($hotel_table && (!empty($resortName) || !empty($countryName))) {
            // Bouw WHERE clause
            $where = ['1=1'];
            $params = [];

            if (!empty($resortName)) {
                // üö® PERFORMANCE FIX: Use = instead of LIKE when possible
                // LIKE '%...%' cannot use index on 430K hotels
                $where[] = 'destination_name = %s';
                $params[] = $resortName; // Exact match instead of LIKE
            }
            if (!empty($countryName)) {
                // Voor country zoeken: gebruik LIKE voor flexibiliteit (case-insensitive, spaties, etc.)
                // Dit is acceptabel omdat country veel minder hotels matcht dan resort
                $where[] = 'country_name LIKE %s';
                $params[] = '%' . $wpdb->esc_like($countryName) . '%';
            }

            // üîß FIX: Apply filter parameters to WHERE clause
            if ($minStars > 0) {
                $where[] = 'star_rate >= %d';
                $params[] = $minStars;
            }
            if ($maxStars > 0) {
                $where[] = 'star_rate <= %d';
                $params[] = $maxStars;
            }
            if ($minPrice > 0) {
                $where[] = 'price >= %f';
                $params[] = $minPrice;
            }
            if ($maxPrice > 0) {
                $where[] = 'price <= %f';
                $params[] = $maxPrice;
            }

            // Features filter (JSON column)
            if (!empty($featureIds)) {
                $featureConditions = [];
                foreach ($featureIds as $fid) {
                    $featureConditions[] = $wpdb->prepare('features_json LIKE %s', '%"id":' . intval($fid) . '%');
                }
                if (!empty($featureConditions)) {
                    $where[] = '(' . implode(' AND ', $featureConditions) . ')';
                }
            }

            // Themes filter (JSON column)
            if (!empty($themeIds)) {
                $themeConditions = [];
                foreach ($themeIds as $tid) {
                    $themeConditions[] = $wpdb->prepare('themes_json LIKE %s', '%"id":' . intval($tid) . '%');
                }
                if (!empty($themeConditions)) {
                    $where[] = '(' . implode(' AND ', $themeConditions) . ')';
                }
            }

            $where_sql = implode(' AND ', $where);

            // üö® PERFORMANCE: Cache de COUNT query voor 5 minuten per bestemming
            $countCacheKey = 'st_hotel_count_' . md5($where_sql . serialize($params));
            $totalHotels = get_transient($countCacheKey);

            if (false === $totalHotels) {
                $queryCount = "SELECT COUNT(*) FROM {$hotel_table} WHERE {$where_sql} AND status = 'publish'";
                if (!empty($params)) {
                    $totalHotels = (int) $wpdb->get_var($wpdb->prepare($queryCount, $params));
                } else {
                    $totalHotels = (int) $wpdb->get_var($queryCount);
                }
                // Cache voor 1 uur (count verandert zelden)
                set_transient($countCacheKey, $totalHotels, HOUR_IN_SECONDS);
            }

            // Pagination setup
            $perPage = 20; // Altijd 20 hotels per pagina
            $page = isset($_POST['page']) ? max(1, intval($_POST['page'])) : 1;
            $totalPages = max(1, (int) ceil($totalHotels / $perPage));
            if ($page > $totalPages) {
                $page = $totalPages;
            }
            $offset = ($page - 1) * $perPage;

            // Query met LIMIT + OFFSET voor pagination
            $query = "SELECT * FROM {$hotel_table} WHERE {$where_sql} AND status = 'publish' LIMIT {$perPage} OFFSET {$offset}";

            if (!empty($params)) {
                $hotels = $wpdb->get_results($wpdb->prepare($query, $params), ARRAY_A);
            } else {
                $hotels = $wpdb->get_results($query, ARRAY_A);
            }

            if (!empty($hotels)) {
                // ========== COUNTRY SEARCH: REDIRECT TO RESORT SELECTOR ==========
                // Voor grote landen (>100 hotels): toon populaire resorts
                // Dit zorgt dat de API call sneller gaat via resort destinationID

                if (!empty($countryName) && empty($resortName) && count($hotels) > 100) {
                    // Te veel hotels voor country search - toon resort selector
                    echo '<div class="st-fullbleed" style="padding:40px;max-width:800px;margin:0 auto;">';
                    echo '<h2 style="font-size:28px;font-weight:700;margin-bottom:16px;text-align:center;">üè® Kies een stad in ' . esc_html($countryName) . '</h2>';
                    echo '<p style="font-size:16px;color:#6b7280;text-align:center;margin-bottom:32px;">Selecteer een stad voor de beste resultaten en snelste zoekresultaten.</p>';

                    // Haal populaire steden op voor dit land
                    $popularCities = $wpdb->get_results($wpdb->prepare(
                        "SELECT DISTINCT destination_name as name, COUNT(*) as hotel_count
             FROM {$hotel_table}
             WHERE country_name = %s
               AND destination_name IS NOT NULL
               AND destination_name != ''
               AND status = 'publish'
             GROUP BY destination_name
             HAVING hotel_count >= 5
             ORDER BY hotel_count DESC
             LIMIT 12",
                        $countryName
                    ), ARRAY_A);

                    if (!empty($popularCities)) {
                        echo '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px;">';

                        foreach ($popularCities as $city) {
                            // üîß FIX: Haal destination_id op voor deze stad
                            // Dit zorgt dat we API call doen (met beschikbaarheid) in plaats van database fallback
                            $cityDestId = $wpdb->get_var($wpdb->prepare(
                                "SELECT destination_id 
                 FROM bravo_destinations 
                 WHERE destination_name = %s 
                   AND country_name LIKE %s
                   AND deleted_at IS NULL
                 LIMIT 1",
                                $city['name'],
                                "%{$countryName}%"
                            ));

                            // Skip als geen destination_id gevonden (kan niet via API zoeken)
                            if (!$cityDestId) {
                                continue;
                            }

                            $citySearchUrl = add_query_arg([
                                'destinationID' => $cityDestId,  // ‚úÖ Gebruik ID ipv naam!
                                'checkin' => $checkin,
                                'checkout' => $checkout,
                                'rooms' => $rooms,
                                'adults' => $adults,
                                'children' => $children,
                                'child_ages' => implode(',', $childAges)
                            ], shorttrips_get_hotels_page_url());

                            echo '<a href="' . esc_url($citySearchUrl) . '" style="display:block;padding:20px;background:#fff;border:2px solid #e5e7eb;border-radius:12px;text-align:center;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.borderColor=\'#2563eb\';this.style.background=\'#f0f9ff\'" onmouseout="this.style.borderColor=\'#e5e7eb\';this.style.background=\'#fff\'">';
                            echo '<div style="font-size:18px;font-weight:600;color:#1f2937;margin-bottom:8px;">' . esc_html($city['name']) . '</div>';
                            echo '<div style="font-size:14px;color:#6b7280;">' . number_format($city['hotel_count']) . ' hotels</div>';
                            echo '</a>';
                        }

                        echo '</div>';
                    }

                    // Button om toch alle hotels te tonen (fallback)
                    echo '<div style="text-align:center;margin-top:24px;">';
                    echo '<button onclick="window.stShowAllHotels=true;location.reload();" style="padding:12px 24px;background:#6b7280;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;">Toon toch alle ' . number_format(count($hotels)) . ' hotels</button>';
                    echo '</div>';

                    echo '</div>';
                    wp_die();
                }

                // ========== SORTEER LOGICA (Database hotels) ==========
                if (!empty($sortBy)) {
                    usort($hotels, function ($a, $b) use ($sortBy) {
                        switch ($sortBy) {
                            case 'price_asc':
                                // Prijs laag -> hoog
                                $aPrice = isset($a['price']) ? (float) $a['price'] : PHP_INT_MAX;
                                $bPrice = isset($b['price']) ? (float) $b['price'] : PHP_INT_MAX;
                                return $aPrice <=> $bPrice;

                            case 'price_desc':
                                // Prijs hoog -> laag
                                $aPrice = isset($a['price']) ? (float) $a['price'] : 0;
                                $bPrice = isset($b['price']) ? (float) $b['price'] : 0;
                                return $bPrice <=> $aPrice;

                            case 'stars_desc':
                                // Sterren hoog -> laag (5->1)
                                $aStars = !empty($a['star_rate']) ? (int) $a['star_rate'] : 0;
                                $bStars = !empty($b['star_rate']) ? (int) $b['star_rate'] : 0;
                                return $bStars <=> $aStars;

                            case 'stars_asc':
                                // Sterren laag -> hoog (1->5)
                                $aStars = !empty($a['star_rate']) ? (int) $a['star_rate'] : 0;
                                $bStars = !empty($b['star_rate']) ? (int) $b['star_rate'] : 0;
                                return $aStars <=> $bStars;

                            case 'rating_desc':
                                // Beoordeling hoog -> laag
                                $aRating = !empty($a['review_score']) ? (float) $a['review_score'] : 0;
                                $bRating = !empty($b['review_score']) ? (float) $b['review_score'] : 0;
                                return $bRating <=> $aRating;

                            default:
                                return 0;
                        }
                    });

                    if (defined('WP_DEBUG') && WP_DEBUG) {
                    }
                }

                // Toon hotels uit lokale database met prebook links
                echo '<div class="st-fullbleed" style="padding:20px;">';
                echo '<h2 style="font-size:24px;font-weight:600;margin-bottom:20px;">üè® Hotels in ' . esc_html($resortName ?: $countryName) . '</h2>';

                // Toon huidige pagina info prominent
                $showingFrom = $offset + 1;
                $showingTo = min($offset + $perPage, $totalHotels);
                echo '<p style="margin-bottom:12px;color:#1f2937;font-size:15px;font-weight:500;">';
                echo 'Toon <strong>' . intval($showingFrom) . '-' . intval($showingTo) . '</strong> van <strong>' . number_format($totalHotels) . '</strong> hotels';
                echo '</p>';

                // Info over beschikbaarheid
                echo '<div style="margin-bottom:20px;padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:6px;">';
                echo '<p style="margin:0;font-size:14px;color:#92400e;">';
                echo '<strong>‚ÑπÔ∏è Let op:</strong> Beschikbaarheid en prijzen worden gecontroleerd wanneer u een hotel selecteert. ';
                echo 'Alleen hotels met beschikbare kamers voor uw gekozen data (' . esc_html($checkin) . ' tot ' . esc_html($checkout) . ') tonen prijzen.';
                echo '</p>';
                echo '</div>';

                // Pagination info
                if ($totalPages > 1) {
                    echo '<div style="margin-bottom:16px;padding:12px;background:#eff6ff;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">';
                    echo '<span style="font-size:14px;color:#1e40af;font-weight:500;">Pagina <strong>' . intval($page) . '</strong> van <strong>' . intval($totalPages) . '</strong></span>';
                    echo '<div style="display:flex;gap:8px;">';
                    if ($page > 1) {
                        echo '<button type="button" class="st-pager-btn st-pager-prev" data-page="' . ($page - 1) . '" style="padding:6px 12px;border:1px solid #2563eb;border-radius:6px;color:#2563eb;background:#fff;cursor:pointer;font-size:13px;font-weight:500;">‚Üê Vorige</button>';
                    }
                    if ($page < $totalPages) {
                        echo '<button type="button" class="st-pager-btn st-pager-next" data-page="' . ($page + 1) . '" style="padding:6px 12px;border:1px solid #2563eb;border-radius:6px;color:#fff;background:#2563eb;cursor:pointer;font-size:13px;font-weight:500;">Volgende ‚Üí</button>';
                    }
                    echo '</div></div>';
                }

                echo '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;">';

                foreach ($hotels as $hotel) {
                    // Bouw prebook URL met alle parameters (zoals bij normale API resultaten)
                    $prebookParams = [
                        'hotelId' => $hotel['hotel_id'],
                        'checkin' => $checkin,
                        'checkout' => $checkout,
                        'rooms' => $rooms,
                        'adults' => $adults,
                        'children' => $children
                    ];

                    // Voeg child_ages toe als er kinderen zijn
                    if ($children > 0 && !empty($childAges)) {
                        $prebookParams['child_ages'] = implode(',', $childAges);
                    }

                    $prebookUrl = add_query_arg($prebookParams, home_url('/prebook/'));

                    $image = $hotel['image'] ?: $hotel['main_image'] ?: '';

                    // ‚≠ê STERREN uit database
                    // Bron: Sunhotels StaticXMLAPI sync (regel 8892, 9291-9292)
                    // Het <category> veld van Sunhotels bevat het sterren aantal (1-5)
                    // en wordt opgeslagen in zowel star_rate als category kolommen
                    $stars = 0;

                    if (!empty($hotel['star_rate']) && intval($hotel['star_rate']) > 0 && intval($hotel['star_rate']) <= 5) {
                        $stars = intval($hotel['star_rate']);
                    } elseif (!empty($hotel['category']) && intval($hotel['category']) > 0 && intval($hotel['category']) <= 5) {
                        $stars = intval($hotel['category']);
                    }

                    // ‚ö†Ô∏è Als $stars = 0: database heeft oude/incomplete sync data
                    // Oplossing: Run hotel sync opnieuw via: https://www.shorttrips.eu/?sync_static_hotels=1
                    // De sync code (regel 8892) haalt <category> op en slaat dit op in beide velden

                    echo '<a href="' . esc_url($prebookUrl) . '" class="st-hotel-card" style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;transition:all 0.2s;display:block;background:#fff;text-decoration:none;color:inherit;" onmouseover="this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.boxShadow=\'none\'">';

                    if ($image) {
                        echo '<div style="width:100%;height:200px;background-image:url(' . esc_url($image) . ');background-size:cover;background-position:center;"></div>';
                    } else {
                        echo '<div style="width:100%;height:200px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;color:#fff;font-size:48px;">üè®</div>';
                    }

                    echo '<div style="padding:16px;">';
                    echo '<h3 style="font-size:18px;font-weight:600;color:#111;margin:0 0 8px 0;">' . esc_html($hotel['title'] ?: $hotel['hotelname']) . '</h3>';

                    // Locatie
                    if (!empty($hotel['address'])) {
                        echo '<p style="font-size:14px;color:#6b7280;margin:0 0 8px 0;">üìç ' . esc_html($hotel['address']) . '</p>';
                    }

                    // Sterren
                    if ($stars > 0) {
                        echo '<p style="margin:0 0 8px 0;color:#f59e0b;">‚òÖ ' . str_repeat('‚òÖ', intval($stars)) . '</p>';
                    }

                    // Boek nu knop
                    echo '<div style="margin-top:12px;padding:10px;background:#2563eb;color:#fff;text-align:center;border-radius:6px;font-weight:600;">Bekijk beschikbaarheid ‚Üí</div>';

                    echo '</div></a>';
                }

                echo '</div>'; // Close grid

                // Pagination buttons onderaan
                if ($totalPages > 1) {
                    echo '<div style="margin-top:24px;padding:16px;background:#f9fafb;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">';

                    if ($page > 1) {
                        echo '<button type="button" class="st-pager-btn st-pager-prev" data-page="' . ($page - 1) . '" style="padding:8px 16px;border:1px solid #d1d5db;border-radius:8px;color:#1f2937;background:#fff;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'#fff\'">‚Üê Vorige</button>';
                    } else {
                        echo '<div></div>';
                    }

                    echo '<span style="font-size:14px;color:#374151;font-weight:500;margin:0 16px;">Pagina <strong>' . intval($page) . '</strong> van <strong>' . intval($totalPages) . '</strong></span>';

                    if ($page < $totalPages) {
                        echo '<button type="button" class="st-pager-btn st-pager-next" data-page="' . ($page + 1) . '" style="padding:8px 16px;border:1px solid #d1d5db;border-radius:8px;color:#1f2937;background:#fff;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'#fff\'">Volgende ‚Üí</button>';
                    } else {
                        echo '<div></div>';
                    }

                    echo '</div>';
                }

                // Store search payload for pagination
                $payloadJson = htmlspecialchars(json_encode([
                    'action' => 'shorttrips_search_hotels',
                    'type' => $type,
                    'q' => $q,
                    'country' => $countryName,
                    'resort' => $resortName,
                    'destinationID' => $destinationId,
                    'checkin' => $checkin,
                    'checkout' => $checkout,
                    'rooms' => $rooms,
                    'adults' => $adults,
                    'children' => $children,
                    'child_ages' => implode(',', $childAges),
                    'sortBy' => $sortBy
                ]), ENT_QUOTES, 'UTF-8');

                echo '<div id="st-search-payload" data-payload="' . $payloadJson . '" style="display:none;"></div>';

                echo '</div>'; // Close st-fullbleed
                wp_die();
            }
        }
    } // End of dead code block (database fallback)

    // --------- Sunhotels API ----------
    $creds = shorttrips_get_api_credentials();

    // üåê Debug: Log API language
    if (defined('WP_DEBUG') && WP_DEBUG) {
        error_log('üåê API Call Language: ' . $creds['language']);
    }

    $endpoint = "https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx/SearchV3";

    // üéØ FEATURE: Background sync van search resultaten naar static database
    $enableBackgroundSync = get_option('shorttrips_background_sync_enabled', '1') === '1';

    // üîß FIX: Use filter variables already defined earlier (no need to re-parse)
    // Convert to nullable for API compatibility
    $minStarsAPI = $minStars > 0 ? $minStars : null;
    $maxStarsAPI = $maxStars > 0 ? $maxStars : null;
    $minPriceAPI = $minPrice > 0 ? $minPrice : null;
    $maxPriceAPI = $maxPrice > 0 ? $maxPrice : null;

    // Use already defined arrays
    $requiredFeatureIds = $featureIds;
    $requiredThemeIds = $themeIds;
    $mealIdsArray = $mealIds;

    // üîß CRITICAL CHECK: destinationID must be > 0 for API call
    if (empty($destinationId) || $destinationId <= 0) {
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        error_log('‚ùå CRITICAL ERROR: No destinationID found!');
        error_log('   ‚îú‚îÄ Type: ' . $type);
        error_log('   ‚îú‚îÄ Resort Name: ' . $resortName);
        error_log('   ‚îú‚îÄ Country Name: ' . $countryName);
        error_log('   ‚îú‚îÄ Query: ' . $q);
        error_log('   ‚îî‚îÄ Cannot call SunHotels API without valid destinationID');
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

        echo '<div class="max-w-4xl mx-auto py-8 px-4">';
        echo '<div style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:24px;margin-bottom:24px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">';
        echo '<div style="display:flex;align-items:flex-start;gap:16px;">';
        echo '<div style="font-size:48px;line-height:1;">‚ö†Ô∏è</div>';
        echo '<div style="flex:1;">';
        echo '<h3 style="color:white;font-size:24px;margin:0 0 12px 0;font-weight:700;">DEBUG: Kan bestemming niet vinden</h3>';
        echo '<p style="color:rgba(255,255,255,0.95);margin:0 0 16px 0;font-size:16px;line-height:1.6;">';
        echo 'We kunnen geen geldige bestemming ID vinden voor <strong>' . esc_html($resortName ?: $countryName ?: $q) . '</strong>.';
        echo '</p>';
        echo '<div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:6px;font-family:monospace;font-size:13px;margin-top:16px;">';
        echo '<strong>DEBUG INFO:</strong><br>';
        echo 'destinationIDParam (POST): ' . esc_html($_POST['destinationID'] ?? 'MISSING') . '<br>';
        echo 'destinationIDParam (GET): ' . esc_html($_GET['destinationID'] ?? 'MISSING') . '<br>';
        echo 'destinationIDParam (parsed): ' . esc_html($destinationIDParam) . '<br>';
        echo 'Final destinationId: ' . esc_html($destinationId) . '<br>';
        echo 'type: ' . esc_html($type) . '<br>';
        echo 'resort_name (POST): ' . esc_html($_POST['resort_name'] ?? 'MISSING') . '<br>';
        echo 'country_name (POST): ' . esc_html($_POST['country_name'] ?? 'MISSING') . '<br>';
        echo '</div>';
        echo '</div>';
        echo '</div>';
        echo '</div>';
        echo '</div>';
        wp_die();
    }

    // üîß CRITICAL FIX: Keep API call MINIMAL
    // SunHotels SearchV3 expects ONLY these core parameters:
    // - destinationID, userName, password, language, currencies
    // - checkInDate, checkOutDate, numberOfRooms, numberOfAdults, numberOfChildren
    // - Optional: childrenAges, mealIds, featureIds, themeIds, minStarRating, maxStarRating
    // 
    // ‚ö†Ô∏è DO NOT ADD: showReviews, showRoomTypeName, b2c, blockSuperDeal, deals
    // These parameters can cause API to return NO results!

    // üö® CRITICAL: Language MUST ALWAYS be 'en' (lowercase) for Sunhotels API
    // NEVER use 'nl' or any other language - API only accepts 'en'
    $params = [
        'destinationID' => $destinationId,  // ‚úÖ FIRST - Required by SunHotels
        'userName' => $creds['username'],
        'password' => $creds['password'],
        'language' => 'en',  // üö® HARDCODED - MUST ALWAYS BE 'en' (lowercase)
        'currencies' => $creds['currency'],
        'checkInDate' => $checkin,
        'checkOutDate' => $checkout,
        'numberOfRooms' => 1,  // üîß ALWAYS 1 for SunHotels API (letterlijk altijd 1!)
        'numberOfAdults' => $adults,
        'numberOfChildren' => $children
    ];

    // üîß ONLY add optional params if explicitly set (prevent API confusion)
    // DO NOT add these by default - they can cause empty results!
    if (!empty($mealIdsArray)) {
        foreach ($mealIdsArray as $mid) {
            $params['mealIds'][] = $mid;
        }
    }
    if (!empty($requiredFeatureIds)) {
        foreach ($requiredFeatureIds as $fid) {
            $params['featureIds'][] = $fid;
        }
    }
    if (!empty($requiredThemeIds)) {
        foreach ($requiredThemeIds as $tid) {
            $params['themeIds'][] = $tid;
        }
    }
    if ($minStarsAPI !== null && $minStarsAPI > 0) {
        $params['minStarRating'] = max(0, min(5, $minStarsAPI));
    }
    if ($maxStarsAPI !== null && $maxStarsAPI > 0) {
        $params['maxStarRating'] = max(0, min(5, $maxStarsAPI));
    }
    if ($minPriceAPI !== null && $minPriceAPI > 0) {
        $params['minPrice'] = $minPriceAPI;
    }
    if ($maxPriceAPI !== null && $maxPriceAPI > 0) {
        $params['maxPrice'] = $maxPriceAPI;
    }
    if ($excludeSharedRooms) {
        $params['excludeSharedRooms'] = 'true';
    }
    if ($excludeSharedFacilities) {
        $params['excludeSharedFacilities'] = 'true';
    }
    if (!empty($childAges)) {
        $params['childrenAges'] = implode(',', $childAges);
    }

    // üåê Debug: Log complete API params + destinationID source
    // ALWAYS log (not just in debug mode) to help diagnose issues
    error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    error_log('üéØ SearchV3 API Request:');
    error_log('   ‚îú‚îÄ destinationID: ' . $destinationId . ' (' . $countryName . ($resortName ? ' / ' . $resortName : '') . ')');
    error_log('   ‚îú‚îÄ Dates: ' . $checkin . ' ‚Üí ' . $checkout);
    error_log('   ‚îú‚îÄ Guests: ' . $adults . ' adults + ' . $children . ' children');
    error_log('   ‚îú‚îÄ Rooms: 1 (ALWAYS)');
    error_log('   ‚îú‚îÄ Language: ' . $creds['language']);
    error_log('   ‚îî‚îÄ Type: ' . $type);
    error_log('üì¶ Minimal API Params (as sent to SunHotels):');
    error_log(print_r(array_filter($params, function ($key) {
        return in_array($key, ['destinationID', 'checkInDate', 'checkOutDate', 'numberOfRooms', 'numberOfAdults', 'numberOfChildren', 'language']);
    }, ARRAY_FILTER_USE_KEY), true));
    error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    // üö® CRITICAL: Validate destinationID exists
    if (empty($destinationId) || $destinationId <= 0) {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('‚ùå SEARCH FAILED: No destinationID');
            error_log('   - country_name: ' . $countryName);
            error_log('   - destinationID: ' . $destinationId);
            error_log('   - $_POST: ' . print_r($_POST, true));
        }

        echo '<div class="st-fullbleed" style="padding:40px;text-align:center;">';
        echo '<div style="max-width:600px;margin:0 auto;">';
        echo '<div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>';
        echo '<h3 style="color:#dc2626;margin-bottom:12px;">Geen bestemming geselecteerd</h3>';
        echo '<p style="color:#6b7280;">Er is geen geldige bestemming gevonden voor deze zoekopdracht.</p>';
        echo '<p style="color:#6b7280;margin-top:8px;"><strong>Debug:</strong> country_name=' . esc_html($countryName) . ', destinationID=' . esc_html($destinationId) . '</p>';
        echo '</div></div>';
        wp_die();
    }

    $baseParams = $params;

    // üîç DEBUG: Log the baseline body before attempting fallbacks
    error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    error_log('üöÄ SUNHOTELS SearchV3 API CALL - ' . date('Y-m-d H:i:s'));
    error_log('‚îÅ‚îÅ‚îÅ BASE API REQUEST BODY ‚îÅ‚îÅ‚îÅ');
    error_log(http_build_query($baseParams));
    error_log('‚îÅ‚îÅ‚îÅ PARSED PARAMS ‚îÅ‚îÅ‚îÅ');
    error_log('Country: ' . $countryName . ' | Destination ID: ' . $destinationId);
    error_log('Dates: ' . $checkin . ' to ' . $checkout);
    error_log('Guests: ' . $adults . ' adults, ' . $children . ' children, ' . $rooms . ' room(s)');
    error_log('Language: ' . $creds['language'] . ' | Currency: ' . $creds['currency']);
    error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    // ================================================================
    // üéØ PROPER FIX: UNIFIED SEARCH WITH FALLBACK (NO INTERMEDIATE ERRORS)
    // ================================================================
    // Build all date attempts upfront (original + fallbacks)
    $fallbackDates = shorttrips_generate_fallback_dates($checkin, $checkout);
    $dateAttempts = array_merge(
        [['checkin' => $checkin, 'checkout' => $checkout, 'nights' => $nights, 'label' => 'Originele datums', 'is_original' => true]],
        $fallbackDates
    );

    $xml = null;
    $usedFallback = null;
    $originalCheckin = $checkin;
    $originalCheckout = $checkout;
    $attemptedDates = [];

    error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    error_log('üöÄ STARTING UNIFIED SEARCH WITH SMART FALLBACK - ' . date('Y-m-d H:i:s'));
    error_log('‚îÅ‚îÅ‚îÅ SEARCH PARAMETERS ‚îÅ‚îÅ‚îÅ');
    error_log('Country: ' . $countryName . ' | Destination ID: ' . $destinationId);
    error_log('Guests: ' . $adults . ' adults, ' . $children . ' children, ' . $rooms . ' room(s)');
    error_log('Will try ' . count($dateAttempts) . ' date combinations');
    error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    // Try each date combination until we find hotels (NO INTERMEDIATE OUTPUT!)
    foreach ($dateAttempts as $attempt) {
        $attemptCheckin = $attempt['checkin'];
        $attemptCheckout = $attempt['checkout'];
        $attemptNights = $attempt['nights'];
        $attemptLabel = $attempt['label'];
        $isOriginal = isset($attempt['is_original']) && $attempt['is_original'];

        $attemptedDates[] = $attempt; // Track all attempts for final error message

        error_log(($isOriginal ? 'üéØ' : 'üîÑ') . ' Trying: ' . $attemptCheckin . ' ‚Üí ' . $attemptCheckout . ' (' . $attemptLabel . ')');

        // Build API params for this attempt (clone base params to retain auth + filters)
        $attemptParams = $baseParams;
        $attemptParams['checkInDate'] = $attemptCheckin;
        $attemptParams['checkOutDate'] = $attemptCheckout;

        $attemptBody = http_build_query($attemptParams);
        error_log('‚îÅ‚îÅ‚îÅ API REQUEST BODY (' . $attemptLabel . ') ‚îÅ‚îÅ‚îÅ');
        error_log($attemptBody);

        // Make API call
        $attemptResponse = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'application/x-www-form-urlencoded'],
            'body' => $attemptBody,
            'timeout' => 30
        ]);

        // Parse response
        if (!is_wp_error($attemptResponse) && !empty($attemptResponse['body'])) {
            $attemptXml = @simplexml_load_string($attemptResponse['body']);

            if ($attemptXml && !empty($attemptXml->hotels->hotel)) {
                $hotelCount = count($attemptXml->hotels->hotel);
                error_log('‚úÖ SUCCESS! Found ' . $hotelCount . ' hotels for ' . $attemptLabel);

                // We have results! Update variables
                $xml = $attemptXml;
                $checkin = $attemptCheckin;
                $checkout = $attemptCheckout;
                $nights = $attemptNights;

                // Mark as fallback if not original
                if (!$isOriginal) {
                    $usedFallback = $attempt;
                }

                break; // Stop trying, we found hotels!
            } else {
                error_log('   ‚ö†Ô∏è No hotels for this date');
            }
        } else {
            error_log('   ‚ùå API error for this date');
        }
    }

    // Log final result
    if ($xml && !empty($xml->hotels->hotel)) {
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        error_log('üéâ SEARCH COMPLETE: ' . count($xml->hotels->hotel) . ' hotels found');
        if ($usedFallback) {
            error_log('üìÖ Used fallback dates: ' . $usedFallback['label']);
        }
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    } else {
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        error_log('‚ùå NO HOTELS FOUND - Tried ' . count($attemptedDates) . ' date combinations');
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    }
    $regionFallbackActive = false;
    $regionFallbackLabel = '';
    $regionFallbackHotelCopy = '';

    if (!$xml || empty($xml->hotels->hotel)) {
        $hotelCopy = $selectedHotelLabel ?: (!empty($resortName) ? $resortName : (!empty($countryName) ? $countryName : __('Dit hotel', 'shorttrips')));
        $regionLabel = !empty($resortName) ? $resortName : (!empty($countryName) ? $countryName : __('dezelfde regio', 'shorttrips'));
        $regionDestinationId = shorttrips_resolve_region_destination($destinationId, $resortName, $countryName, $selectedHotelLabel);
        $regionFallbackXml = null;
        if ($regionDestinationId > 0) {
            $altParams = $baseParams;
            $altParams['destinationID'] = $regionDestinationId;
            unset($altParams['hotelIds'], $altParams['hotelIDs'], $altParams['hotelids']);
            $regionFallbackXml = shorttrips_fetch_region_availability_xml($endpoint, $altParams);
        }

        if ($regionFallbackXml && !empty($regionFallbackXml->hotels->hotel)) {
            $xml = $regionFallbackXml;
            $destinationId = $regionDestinationId;
            $regionFallbackActive = true;
            $regionFallbackLabel = $regionLabel;
            $regionFallbackHotelCopy = $hotelCopy;

            echo '<script>try{var existingNoAvail=document.getElementById("st-no-availability-overlay");if(existingNoAvail){existingNoAvail.remove();}}catch(e){console.warn(e);}</script>';
            echo '<div id="st-no-availability-overlay" class="st-modal" data-scroll-target="#st-results-root" style="display:flex;">';
            echo '<div class="st-modal-overlay"></div>';
            echo '<div class="st-modal-content" style="max-width:520px;padding:32px;border-radius:18px;text-align:center;position:relative;">';
            echo '<button type="button" class="st-noavail-close" aria-label="Sluiten" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:24px;color:#94a3b8;cursor:pointer;line-height:1;">&times;</button>';
            echo '<div style="font-size:40px;margin-bottom:12px;">‚ÑπÔ∏è</div>';
            echo '<h3 style="margin:0 0 12px 0;color:#111827;font-size:22px;">Geen commissievrije beschikbaarheid</h3>';
            echo '<p style="font-size:15px;line-height:1.6;color:#4b5563;margin-bottom:16px;">' . esc_html($hotelCopy) . ' heeft zich helaas nog niet aangemeld voor commissievrije boekingen bij Freestays. We tonen direct beschikbare hotels in ' . esc_html($regionLabel) . ' met dezelfde zoekopdracht.</p>';
            echo '<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">';
            echo '<button type="button" class="st-btn st-btn-secondary st-noavail-close" data-scroll-target="#st-results-root">Sluiten</button>';
            echo '<button type="button" class="st-btn st-btn-primary st-noavail-close" data-scroll-target="#st-results-root">Bekijk hotels</button>';
            echo '</div>';
            echo '</div>';
            echo '</div>';

        } else {
            $alternativeHotels = shorttrips_get_alternative_hotels($resortName, $countryName, 8);

            echo '<script>try{var existingNoAvail=document.getElementById("st-no-availability-overlay");if(existingNoAvail){existingNoAvail.remove();}}catch(e){console.warn(e);}</script>';
            echo '<div id="st-no-availability-overlay" class="st-modal" data-scroll-target="#st-alternative-hotels" style="display:flex;">';
            echo '<div class="st-modal-overlay"></div>';
            echo '<div class="st-modal-content" style="max-width:520px;padding:32px;border-radius:18px;text-align:center;position:relative;">';
            echo '<button type="button" class="st-noavail-close" aria-label="Sluiten" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:24px;color:#94a3b8;cursor:pointer;line-height:1;">&times;</button>';
            echo '<div style="font-size:40px;margin-bottom:12px;">‚ÑπÔ∏è</div>';
            echo '<h3 style="margin:0 0 12px 0;color:#111827;font-size:22px;">Geen commissievrije beschikbaarheid</h3>';
            echo '<p style="font-size:15px;line-height:1.6;color:#4b5563;margin-bottom:16px;">' . esc_html($hotelCopy) . ' heeft zich helaas nog niet aangemeld voor commissievrije boekingen bij Freestays. Uw zoekopdracht is geregistreerd en wij zullen het hotel benaderen om alsnog deel te nemen. Tot die tijd tonen we de beste alternatieven in dezelfde regio.</p>';
            echo '<p style="font-size:15px;line-height:1.6;color:#4b5563;margin-bottom:24px;">Check hieronder direct hotels in ' . esc_html($regionLabel) . ' met beschikbare kamers.</p>';
            echo '<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">';
            echo '<button type="button" class="st-btn st-btn-secondary st-noavail-close" data-scroll-target="#st-alternative-hotels">Sluiten</button>';
            echo '<button type="button" class="st-btn st-btn-primary st-noavail-close" data-scroll-target="#st-alternative-hotels">Bekijk alternatieven</button>';
            echo '</div>';
            echo '</div>';
            echo '</div>';

            echo '<div id="st-alternative-hotels" class="st-fullbleed" style="padding:32px 0;">';
            echo '<div style="max-width:100%;width:100%;margin:0 auto;background:#ffffff;border-radius:16px;padding:32px;box-shadow:0 25px 70px rgba(15,23,42,0.08);">';
            echo '<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:24px;">';
            echo '<h2 style="margin:0;font-size:26px;color:#0f172a;">Beschikbare hotels in ' . esc_html($regionLabel) . '</h2>';
            echo '<p style="margin:0;color:#475569;">Op basis van uw zoekopdracht tonen we direct andere hotels die wel beschikbaar zijn.</p>';
            echo '</div>';

            if (!empty($alternativeHotels)) {
                echo '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;">';
                foreach ($alternativeHotels as $altHotel) {
                    $cardTitle = !empty($altHotel['title']) ? $altHotel['title'] : $altHotel['hotelname'];
                    $image = !empty($altHotel['main_image']) ? $altHotel['main_image'] : $altHotel['image'];
                    $targetDestination = !empty($altHotel['destination_id']) ? intval($altHotel['destination_id']) : ($regionDestinationId ?: $destinationId);
                    $searchParams = [
                        'action' => 'shorttrips_search_hotels',
                        'checkin' => $checkin,
                        'checkout' => $checkout,
                        'rooms' => $rooms,
                        'adults' => $adults,
                        'children' => $children,
                    ];
                    if (!empty($childAges)) {
                        $searchParams['child_ages'] = implode(',', $childAges);
                    }
                    if (!empty($targetDestination)) {
                        $searchParams['destinationID'] = $targetDestination;
                    }
                    if (!empty($altHotel['destination_name'])) {
                        $searchParams['type'] = 'resort';
                        $searchParams['resort'] = $altHotel['destination_name'];
                        $searchParams['resort_name'] = $altHotel['destination_name'];
                    } else {
                        $searchParams['type'] = 'search';
                    }
                    if (!empty($altHotel['country_name'])) {
                        $searchParams['country_name'] = $altHotel['country_name'];
                        $searchParams['country'] = $altHotel['country_name'];
                    }
                    if (!empty($cardTitle)) {
                        $searchParams['q'] = $cardTitle;
                        $searchParams['selected_hotel_label'] = $cardTitle;
                    }
                    $hotelUrl = add_query_arg($searchParams, shorttrips_get_hotels_page_url());
                    echo '<a class="st-alt-hotel-card" href="' . esc_url($hotelUrl) . '" style="display:flex;flex-direction:column;border:1px solid #e2e8f0;border-radius:16px;overflow:hidden;text-decoration:none;color:inherit;box-shadow:0 10px 30px rgba(15,23,42,0.06);transition:transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform=\'translateY(-4px)\';this.style.boxShadow=\'0 20px 35px rgba(15,23,42,0.12)\';" onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 10px 30px rgba(15,23,42,0.06)\';">';
                    if ($image) {
                        echo '<div style="width:100%;padding-top:62%;background-size:cover;background-position:center;background-image:url(' . esc_url($image) . ');"></div>';
                    }
                    echo '<div style="padding:18px;display:flex;flex-direction:column;gap:10px;flex:1;">';
                    echo '<div>';
                    echo '<h3 style="margin:0;font-size:18px;color:#0f172a;">' . esc_html($cardTitle) . '</h3>';
                    echo '<p style="margin:4px 0 0 0;font-size:14px;color:#475569;">' . esc_html($altHotel['destination_name']) . ', ' . esc_html($altHotel['country_name']) . '</p>';
                    echo '</div>';
                    if (!empty($altHotel['star_rate'])) {
                        echo '<div style="color:#fbbf24;font-size:14px;">' . str_repeat('‚òÖ', intval($altHotel['star_rate'])) . '</div>';
                    }
                    echo '<span style="margin-top:auto;font-weight:600;color:#2563eb;">Bekijk beschikbaarheid ‚Üí</span>';
                    echo '</div>';
                    echo '</a>';
                }
                echo '</div>';
            } else {
                echo '<div style="padding:32px;border:1px dashed #cbd5f5;border-radius:12px;text-align:center;color:#475569;">Geen alternatieve hotels gevonden voor deze regio. Probeer een ruimere zoekopdracht.</div>';
            }

            echo '</div>';
            echo '</div>';

            $payloadData = [
                'action' => 'shorttrips_search_hotels',
                'type' => $type,
                'q' => $q,
                'country' => $country,
                'resort' => $resort,
                'destinationID' => $destinationId,
                'checkin' => $checkin,
                'checkout' => $checkout,
                'rooms' => $rooms,
                'adults' => $adults,
                'children' => $children,
                'child_ages' => implode(',', $childAges),
                'selected_hotel_label' => $selectedHotelLabel,
            ];
            $payloadJson = htmlspecialchars(json_encode($payloadData), ENT_QUOTES, 'UTF-8');
            echo '<div id="st-search-payload" data-payload="' . $payloadJson . '" style="display:none;"></div>';

            return;
        }
    }

    // If we used fallback dates, show banner
    if (isset($usedFallback) && $usedFallback) {
        echo '<div style="background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);padding:20px;margin-bottom:24px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">';
        echo '<div style="max-width:100%;width:100%;margin:0 auto;display:flex;align-items:center;gap:16px;">';
        echo '<div style="font-size:32px;">‚ö†Ô∏è</div>';
        echo '<div style="flex:1;">';
        echo '<h3 style="color:#78350f;font-size:18px;margin:0 0 6px 0;font-weight:700;">Geen hotels op uw gekozen datums</h3>';
        echo '<p style="color:#92400e;margin:0;font-size:15px;line-height:1.5;">';
        echo 'Voor <strong>' . date('d M', strtotime($originalCheckin)) . ' - ' . date('d M Y', strtotime($originalCheckout)) . '</strong> zijn geen hotels beschikbaar. ';
        echo 'We tonen hotels voor <strong>' . $usedFallback['label'] . '</strong> ';
        echo '(' . count($xml->hotels->hotel) . ' hotels beschikbaar)';
        echo '</p>';
        echo '</div>';
        echo '<button onclick="document.getElementById(\'st-more-dates\').style.display=\'block\';this.style.display=\'none\';" style="padding:12px 24px;background:white;color:#92400e;border:none;border-radius:8px;font-weight:600;cursor:pointer;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,0.1);">';
        echo 'Andere datums üìÖ';
        echo '</button>';
        echo '</div>';
        echo '</div>';

        // Hidden accordion with more date options
        echo '<div id="st-more-dates" style="display:none;background:#fef3c7;padding:20px;margin-bottom:24px;border-radius:12px;">';
        echo '<h4 style="margin:0 0 16px 0;color:#78350f;font-size:16px;font-weight:600;">Andere beschikbare periodes:</h4>';
        echo '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">';

        // Show other date options (skip original and currently used)
        foreach ($dateAttempts as $idx => $fb) {
            if (isset($fb['is_original']) && $fb['is_original'])
                continue; // Skip original
            if ($fb['checkin'] === $usedFallback['checkin'])
                continue; // Skip current one

            $fbParams = array_merge($_POST, [
                'action' => 'shorttrips_search_hotels',
                'checkin' => $fb['checkin'],
                'checkout' => $fb['checkout']
            ]);

            $fbUrl = add_query_arg($fbParams, shorttrips_get_hotels_page_url());

            echo '<a href="' . esc_url($fbUrl) . '" style="display:block;padding:16px;background:white;border-radius:8px;text-decoration:none;transition:all 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.05);" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.05)\'">';
            echo '<div style="font-size:14px;color:#92400e;font-weight:600;margin-bottom:4px;">üìÖ ' . $fb['label'] . '</div>';
            echo '<div style="font-size:12px;color:#a16207;">' . $fb['nights'] . ' nachten</div>';
            echo '</a>';
        }

        echo '</div>';
        echo '</div>';
    }

    // If still no results after fallback, show error
    if (!$xml || empty($xml->hotels->hotel)) {
        error_log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        error_log('‚ö†Ô∏è No results even after trying fallback dates - showing final error message');

        // === FINAL ERROR: No results even with fallback dates ===
        echo '<div class="max-w-4xl mx-auto py-8 px-4">';

        // Check if fallback was attempted
        $fallbackWasAttempted = isset($attemptedDates) && count($attemptedDates) > 1;

        if ($fallbackWasAttempted) {
            // Fallback WAS attempted but failed - show comprehensive message
            echo '<div style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;padding:24px;margin-bottom:24px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">';
            echo '<div style="display:flex;align-items:flex-start;gap:16px;">';
            echo '<div style="font-size:48px;line-height:1;">üòû</div>';
            echo '<div style="flex:1;">';
            echo '<h3 style="color:white;font-size:24px;margin:0 0 12px 0;font-weight:700;">Helaas geen beschikbaarheid gevonden</h3>';
            echo '<p style="color:rgba(255,255,255,0.95);margin:0 0 16px 0;font-size:16px;line-height:1.6;">';
            echo 'We hebben automatisch <strong>verschillende alternatieve datums</strong> geprobeerd, maar kunnen momenteel geen beschikbare hotels vinden voor <strong>' . esc_html($countryName) . '</strong>.';
            echo '</p>';
            echo '<div style="background:rgba(255,255,255,0.15);padding:16px;border-radius:8px;margin-bottom:16px;">';
            echo '<p style="margin:0 0 8px 0;font-weight:600;color:white;">üìÖ Geprobeerde periodes:</p>';
            echo '<ul style="margin:0;padding-left:20px;color:rgba(255,255,255,0.9);">';
            foreach ($attemptedDates as $attempt) {
                $attemptLabel = isset($attempt['is_original']) && $attempt['is_original'] ?
                    'Origineel: ' . date('d M', strtotime($attempt['checkin'])) . ' - ' . date('d M Y', strtotime($attempt['checkout'])) :
                    $attempt['label'];
                echo '<li>' . $attemptLabel . '</li>';
            }
            echo '</ul>';
            echo '</div>';
            echo '<p style="color:rgba(255,255,255,0.9);margin:0;font-size:14px;">üí° Tip: Probeer een andere bestemming, langere periode, of meer flexibele datums.</p>';
            echo '</div>';
            echo '</div>';
            echo '</div>';
        } else {
            // Fallback was NOT attempted (should not happen, but safety fallback)
            echo '<div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:24px;margin-bottom:24px;border-radius:12px;">';
            echo '<div style="display:flex;align-items:flex-start;gap:16px;">';
            echo '<div style="font-size:36px;line-height:1;">üîç</div>';
            echo '<div style="flex:1;">';
            echo '<h3 style="color:#92400e;font-size:22px;margin:0 0 8px 0;font-weight:600;">Geen hotels beschikbaar</h3>';
            echo '<p style="color:#78350f;margin:0 0 12px 0;font-size:15px;line-height:1.6;">';
            echo 'Voor de specifieke datums';
            if (!empty($checkin) && !empty($checkout)) {
                echo ' <strong>' . date('d-m-Y', strtotime($checkin)) . '</strong> tot <strong>' . date('d-m-Y', strtotime($checkout)) . '</strong>';
            }
            if ($type === 'resort' && !empty($resortName)) {
                echo ' in <strong>' . esc_html($resortName) . '</strong>';
            } elseif ($type === 'country' && !empty($countryName)) {
                echo ' in <strong>' . esc_html($countryName) . '</strong>';
            }
            echo ' hebben we helaas geen beschikbare hotels gevonden.';
            echo '</p>';
            echo '<p style="color:#78350f;margin:0;font-size:14px;">üí° Tip: Probeer andere datums of verruim uw zoekopdracht.</p>';
            echo '</div></div></div>';

            // === ALTERNATIEVE ZOEKOPTIES ===
            $alternatives = [];

            // OPTIE 1: Verruim filters (verwijder sterren/prijs beperkingen)
            $hasFilters = ($minStarsAPI !== null || $maxStarsAPI !== null || $minPriceAPI !== null || $maxPriceAPI !== null || !empty($requiredFeatureIds) || !empty($requiredThemeIds));
            if ($hasFilters) {
                $broadParams = [
                    'action' => 'shorttrips_search_hotels',
                    'type' => $type,
                    'checkin' => $checkin,
                    'checkout' => $checkout,
                    'rooms' => $rooms,
                    'adults' => $adults,
                    'children' => $children
                ];

                // üîß CRITICAL: Include destinationID & country_name
                if (!empty($destinationId)) {
                    $broadParams['destinationID'] = $destinationId;
                }
                if (!empty($countryName)) {
                    $broadParams['country_name'] = $countryName;
                }

                if (!empty($childAges))
                    $broadParams['child_ages'] = implode(',', $childAges);
                if ($type === 'resort' && !empty($resort)) {
                    $broadParams['resort'] = $resort;
                    $broadParams['resort_name'] = $resortName;
                    $broadParams['country'] = $country;
                } elseif ($type === 'country' && !empty($country)) {
                    $broadParams['country'] = $country;
                } elseif ($type === 'search' && !empty($q)) {
                    $broadParams['q'] = $q;
                }
                // Behoud alleen basis parameters, geen filters (sterren, prijs, features)

                $alternatives[] = [
                    'icon' => 'üéØ',
                    'title' => 'Zonder filters zoeken',
                    'description' => 'Verwijder sterren, prijs en feature filters',
                    'url' => add_query_arg($broadParams, shorttrips_get_hotels_page_url())
                ];
            }

            // OPTIE 2: Andere datums (+7 dagen)
            if (!empty($checkin) && !empty($checkout)) {
                $alt1Checkin = date('Y-m-d', strtotime($checkin . ' +7 days'));
                $alt1Checkout = date('Y-m-d', strtotime($checkout . ' +7 days'));

                // Bouw volledige parameter set op (geen $_GET in AJAX context)
                $dateParams = [
                    'action' => 'shorttrips_search_hotels',
                    'type' => $type,
                    'checkin' => $alt1Checkin,
                    'checkout' => $alt1Checkout,
                    'rooms' => $rooms,
                    'adults' => $adults,
                    'children' => $children
                ];

                // üîß CRITICAL: Include destinationID & country_name for new search
                if (!empty($destinationId)) {
                    $dateParams['destinationID'] = $destinationId;
                }
                if (!empty($countryName)) {
                    $dateParams['country_name'] = $countryName;
                }

                // Voeg optionele parameters toe
                if (!empty($q))
                    $dateParams['q'] = $q;
                if (!empty($resort))
                    $dateParams['resort'] = $resort;
                if (!empty($resortName))
                    $dateParams['resort_name'] = $resortName;
                if (!empty($country))
                    $dateParams['country'] = $country;
                if (!empty($childAges))
                    $dateParams['child_ages'] = implode(',', $childAges);
                if ($minStarsAPI !== null)
                    $dateParams['minStars'] = $minStarsAPI;
                if ($maxStarsAPI !== null)
                    $dateParams['maxStars'] = $maxStarsAPI;
                if ($minPriceAPI !== null)
                    $dateParams['minPrice'] = $minPriceAPI;
                if ($maxPriceAPI !== null)
                    $dateParams['maxPrice'] = $maxPriceAPI;
                if (!empty($requiredFeatureIds))
                    $dateParams['featureIds'] = implode(',', $requiredFeatureIds);
                if (!empty($requiredThemeIds))
                    $dateParams['themeIds'] = implode(',', $requiredThemeIds);
                if (!empty($mealIdsArray))
                    $dateParams['mealIds'] = implode(',', $mealIdsArray);
                if ($excludeSharedRooms)
                    $dateParams['excludeSharedRooms'] = '1';
                if ($excludeSharedFacilities)
                    $dateParams['excludeSharedFacilities'] = '1';

                $alternatives[] = [
                    'icon' => 'üìÖ',
                    'title' => '7 dagen later',
                    'description' => date('d-m', strtotime($alt1Checkin)) . ' ‚Üí ' . date('d-m-Y', strtotime($alt1Checkout)),
                    'url' => add_query_arg($dateParams, shorttrips_get_hotels_page_url())
                ];

                // OPTIE 3: +14 dagen
                $alt2Checkin = date('Y-m-d', strtotime($checkin . ' +14 days'));
                $alt2Checkout = date('Y-m-d', strtotime($checkout . ' +14 days'));

                // Clone dateParams en update datums
                $dateParams2 = $dateParams;
                $dateParams2['checkin'] = $alt2Checkin;
                $dateParams2['checkout'] = $alt2Checkout;

                $alternatives[] = [
                    'icon' => 'üìÜ',
                    'title' => '14 dagen later',
                    'description' => date('d-m', strtotime($alt2Checkin)) . ' ‚Üí ' . date('d-m-Y', strtotime($alt2Checkout)),
                    'url' => add_query_arg($dateParams2, shorttrips_get_hotels_page_url())
                ];
            }

            // OPTIE 4: Grotere regio (resort ‚Üí country)
            if ($type === 'resort' && !empty($country)) {
                // Get first destination_id for the COUNTRY (not the resort)
                global $wpdb;
                $countryDestId = $wpdb->get_var($wpdb->prepare("
          SELECT destination_id 
          FROM bravo_destinations 
          WHERE country_name = %s 
            AND destination_id IS NOT NULL 
            AND deleted_at IS NULL 
          ORDER BY destination_id ASC 
          LIMIT 1
        ", $countryName));

                $countryParams = [
                    'action' => 'shorttrips_search_hotels',
                    'type' => 'country',
                    'country' => $country,
                    'country_name' => $countryName,
                    'destinationID' => $countryDestId ?: $destinationId, // Fallback to current if not found
                    'checkin' => $checkin,
                    'checkout' => $checkout,
                    'rooms' => $rooms,
                    'adults' => $adults,
                    'children' => $children
                ];
                if (!empty($childAges))
                    $countryParams['child_ages'] = implode(',', $childAges);
                // Optioneel: filters behouden
                if ($minStarsAPI !== null)
                    $countryParams['minStars'] = $minStarsAPI;
                if ($maxStarsAPI !== null)
                    $countryParams['maxStars'] = $maxStarsAPI;
                if ($minPriceAPI !== null)
                    $countryParams['minPrice'] = $minPriceAPI;
                if ($maxPriceAPI !== null)
                    $countryParams['maxPrice'] = $maxPriceAPI;

                $alternatives[] = [
                    'icon' => 'üåç',
                    'title' => 'Heel ' . esc_html($country),
                    'description' => 'Alle hotels in dit land',
                    'url' => add_query_arg($countryParams, shorttrips_get_hotels_page_url())
                ];
            }

            // Toon alternatieve opties met AJAX functionality
            if (!empty($alternatives)) {
                echo '<h3 style="font-size:18px;font-weight:600;margin:0 0 16px 0;color:#111827;">üí° Probeer deze alternatieven:</h3>';
                echo '<div style="display:grid;grid-template-columns:repeat(' . min(3, count($alternatives)) . ',1fr);gap:16px;margin-bottom:24px;" id="st-alternatives-grid">';

                foreach ($alternatives as $idx => $alt) {
                    // Parse URL parameters for AJAX call
                    $urlParts = parse_url($alt['url']);
                    parse_str($urlParts['query'] ?? '', $altParams);
                    $altParamsJson = json_encode($altParams);

                    echo '<button type="button" ';
                    echo 'class="st-alternative-btn" ';
                    echo 'data-params="' . esc_attr($altParamsJson) . '" ';
                    echo 'style="display:block;background:linear-gradient(135deg, #2563eb 0%, #1e40af 100%);color:#fff;padding:20px;border-radius:12px;border:none;cursor:pointer;text-align:center;transition:all 0.2s;box-shadow:0 2px 8px rgba(37,99,235,0.2);width:100%;" ';
                    echo 'onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(37,99,235,0.3)\';" ';
                    echo 'onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'0 2px 8px rgba(37,99,235,0.2)\';">';

                    echo '<div style="font-size:36px;margin-bottom:12px;">' . $alt['icon'] . '</div>';
                    echo '<div style="font-weight:600;font-size:16px;margin-bottom:6px;">' . esc_html($alt['title']) . '</div>';
                    echo '<div style="font-size:13px;opacity:0.9;">' . esc_html($alt['description']) . '</div>';
                    echo '</button>';
                }

                echo '</div>';

                // Add JavaScript for AJAX alternative searches
                echo '<script>
        document.querySelectorAll(".st-alternative-btn").forEach(function(btn) {
          btn.addEventListener("click", function() {
            var params = JSON.parse(this.getAttribute("data-params"));
            var resultsContainer = document.getElementById("st-results");
            
            if (!resultsContainer) {
              // Fallback: navigate to URL if no results container
              var url = "' . shorttrips_get_hotels_page_url() . '?" + new URLSearchParams(params).toString();
              window.location.href = url;
              return;
            }
            
            console.log("üîÑ Alternative search with params:", params);
            
            // Show loading state
            resultsContainer.innerHTML = "<div class=\"text-center py-8\"><div class=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div><p class=\"mt-2 text-gray-600\">Nieuwe zoekopdracht uitvoeren...</p></div>";
            resultsContainer.scrollIntoView({ behavior: "smooth", block: "start" });
            
            // Build FormData
            var fd = new FormData();
            for (var key in params) {
              if (params[key] !== null && params[key] !== undefined && params[key] !== "") {
                fd.append(key, params[key]);
              }
            }
            
            // Execute AJAX search
            fetch("' . admin_url('admin-ajax.php') . '", {
              method: "POST",
              body: fd,
              credentials: "same-origin"
            })
            .then(function(r) { return r.text(); })
            .then(function(html) {
              // Fade in results
              resultsContainer.style.opacity = "0";
              resultsContainer.innerHTML = html;
              setTimeout(function() {
                resultsContainer.style.transition = "opacity 0.3s ease-in";
                resultsContainer.style.opacity = "1";
              }, 50);
              
              // Update URL without reload
              var newUrl = "' . shorttrips_get_hotels_page_url() . '?" + new URLSearchParams(params).toString();
              history.pushState({}, "", newUrl);
              
              console.log("‚úÖ Alternative search completed");
            })
            .catch(function(err) {
              console.error("‚ùå Alternative search error:", err);
              resultsContainer.innerHTML = "<p class=\"text-red-500 text-center py-8\">Er is een fout opgetreden. Probeer het opnieuw.</p>";
            });
          });
        });
        </script>';
            }

            // Extra tips
            echo '<div style="background:#f3f4f6;border-radius:8px;padding:16px;margin-bottom:16px;">';
            echo '<p style="color:#374151;font-weight:600;margin:0 0 8px 0;font-size:14px;">üí° Andere suggesties:</p>';
            echo '<ul style="color:#6b7280;font-size:14px;margin:0;padding-left:20px;line-height:1.8;">';
            echo '<li>Zoek op een andere bestemming in de buurt</li>';
            echo '<li>Verminder het aantal kamers of personen</li>';
            echo '<li>Probeer een kortere verblijfsduur</li>';
            echo '<li>Bekijk onze populaire bestemmingen</li>';
            echo '</ul>';
            echo '</div>';

            // Terug knop - gaat terug naar zoekformulier met ZELFDE parameters
            // Zodat gebruiker de zoekopdracht kan aanpassen
            $backParams = [
                'checkin' => $checkin,
                'checkout' => $checkout,
                'rooms' => $rooms,
                'adults' => $adults,
                'children' => $children
            ];
            if (!empty($childAges))
                $backParams['child_ages'] = implode(',', $childAges);
            if (!empty($q))
                $backParams['q'] = $q;
            if (!empty($resort))
                $backParams['resort'] = $resort;
            if (!empty($country))
                $backParams['country'] = $country;
            if (!empty($resortName))
                $backParams['resort_name'] = $resortName;
            if (!empty($countryName))
                $backParams['country_name'] = $countryName;

            $backUrl = add_query_arg($backParams, shorttrips_get_hotels_page_url());

            echo '<div style="text-align:center;">';
            echo '<a href="' . esc_url($backUrl) . '" style="display:inline-flex;align-items:center;gap:8px;color:#2563eb;text-decoration:none;font-weight:600;font-size:15px;">';
            echo '‚Üê Pas uw zoekopdracht aan';
            echo '</a>';
            echo '</div>';

            echo '</div>'; // max-w-4xl

            // JavaScript: Gewoon navigeren naar de URL (simpelste oplossing)
            // De hotels pagina zal automatisch de zoekresultaten laden via de auto-trigger
            echo '<script>
      // Geen interceptie nodig - laat de normale links werken
      // De [shorttrips_hotels_page] heeft al een auto-trigger die URL params oppikt
      console.log("Alternative search links ready - will navigate to /hotels/ with parameters");
      </script>';

        } // End else (fallback was NOT attempted)

        wp_die();
    }

    // Final check - only show error if fallback also failed
    if (!$xml) {
        echo '<p class="text-red-500 text-center">Fout bij verbinden met Sunhotels API.</p>';
        wp_die();
    }
    if (empty($xml->hotels->hotel)) {
        echo '<div style="padding:40px;text-align:center;max-width:600px;margin:0 auto;">';
        echo '<div style="font-size:64px;margin-bottom:16px;">üòû</div>';
        echo '<h2 style="font-size:24px;font-weight:600;color:#1f2937;margin-bottom:12px;">Helaas geen beschikbaarheid gevonden</h2>';
        echo '<p style="color:#6b7280;font-size:15px;line-height:1.6;">We hebben verschillende datums geprobeerd, maar kunnen momenteel geen beschikbare hotels vinden voor deze bestemming.</p>';
        echo '<p style="margin-top:20px;"><a href="' . home_url('/') . '" style="display:inline-block;padding:12px 24px;background:#2563eb;color:white;text-decoration:none;border-radius:8px;font-weight:600;">‚Üê Terug naar homepage</a></p>';
        echo '</div>';
        wp_die();
    }

    if ($regionFallbackActive) {
        echo '<div style="background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);padding:18px;margin-bottom:24px;border-radius:12px;color:#fff;box-shadow:0 10px 30px rgba(37,99,235,0.25);">';
        echo '<div style="display:flex;align-items:flex-start;gap:14px;">';
        echo '<div style="font-size:28px;line-height:1;">‚ÑπÔ∏è</div>';
        echo '<div style="flex:1;">';
        echo '<h3 style="margin:0 0 6px 0;font-size:18px;font-weight:700;">Alternatieve hotels in ' . esc_html($regionFallbackLabel) . '</h3>';
        echo '<p style="margin:0;font-size:14px;line-height:1.6;color:rgba(255,255,255,0.9);">We tonen direct beschikbare hotels in deze regio, omdat <strong>' . esc_html($regionFallbackHotelCopy) . '</strong> nog niet commissievrij kan worden geboekt. Alle filters, datums en reizigers zijn behouden.</p>';
        echo '</div>';
        echo '</div>';
        echo '</div>';
    }

    // --------- Hotel-IDs verzamelen ----------
    $ids = [];
    foreach ($xml->hotels->hotel as $h) {
        $hid = (int) $h->{'hotel.id'};
        if ($hid > 0)
            $ids[] = $hid;
    }

    // --------- Statische data ophalen ----------
    $staticData = [];
    if (!empty($ids)) {
        $ph = implode(',', array_fill(0, count($ids), '%d'));
        $rows = $wpdb->get_results($wpdb->prepare(
            "SELECT hotel_id, title, hotelname, address, city, country_name, destination_name,
              image, main_image, banner_image, json_images, images_json, star_rate, description,
              review_score, review_count, latitude, longitude, map_lat, map_lng, map_zoom,
              features_json, themes_json
         FROM ghwk_bravo_hotels
        WHERE hotel_id IN ($ph)",
            ...$ids
        ), ARRAY_A);
        foreach ($rows as $r) {
            $staticData[(int) $r['hotel_id']] = $r;
        }
    }

    // --------- Kaarten renderen ----------
    // Paginering (server-side) ‚Äì max 20 hotels per pagina
    $hotelsArray = [];
    foreach ($xml->hotels->hotel as $hnode) {
        $hotelsArray[] = $hnode;
    }
    // Prefilter features/themes v√≥√≥r paginering - IMPROVED with fallbacks
    $filtered = [];
    $hasFilters = !empty($requiredFeatureIds) || !empty($requiredThemeIds);

    if ($hasFilters) {
        $filteredCount = 0;
        $totalProcessed = 0;

        foreach ($hotelsArray as $hnode) {
            $totalProcessed++;
            $hid = (int) $hnode->{'hotel.id'};
            $s = $staticData[$hid] ?? [];
            $ok = true;

            // Feature filtering with graceful handling
            if ($ok && !empty($requiredFeatureIds)) {
                $feat = [];
                if (!empty($s['features_json'])) {
                    $decoded = json_decode($s['features_json'], true);
                    if (is_array($decoded)) {
                        $feat = $decoded;
                    }
                }

                $present = [];
                if (is_array($feat)) {
                    foreach ($feat as $f) {
                        if (isset($f['id']) && is_numeric($f['id'])) {
                            $present[] = intval($f['id']);
                        }
                    }
                }

                // Check if ANY required feature is present (OR logic instead of AND)
                $hasAnyFeature = false;
                foreach ($requiredFeatureIds as $rid) {
                    if (in_array($rid, $present, true)) {
                        $hasAnyFeature = true;
                        break;
                    }
                }

                if (!$hasAnyFeature) {
                    $ok = false;
                }
            }

            // Theme filtering with graceful handling
            if ($ok && !empty($requiredThemeIds)) {
                $the = [];
                if (!empty($s['themes_json'])) {
                    $decoded = json_decode($s['themes_json'], true);
                    if (is_array($decoded)) {
                        $the = $decoded;
                    }
                }

                $present = [];
                if (is_array($the)) {
                    foreach ($the as $t) {
                        if (isset($t['id']) && is_numeric($t['id'])) {
                            $present[] = intval($t['id']);
                        }
                    }
                }

                // Check if ANY required theme is present (OR logic instead of AND)
                $hasAnyTheme = false;
                foreach ($requiredThemeIds as $rid) {
                    if (in_array($rid, $present, true)) {
                        $hasAnyTheme = true;
                        break;
                    }
                }

                if (!$hasAnyTheme) {
                    $ok = false;
                }
            }

            if ($ok) {
                $filtered[] = $hnode;
                $filteredCount++;
            }
        }

        // Fallback: if filters are too restrictive, show all results with warning
        if ($filteredCount === 0 && $totalProcessed > 0) {
            $filtered = $hotelsArray;
            echo '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4"><p class="text-yellow-800 text-sm">‚ö†Ô∏è Geen hotels gevonden met de geselecteerde filters. Alle resultaten worden getoond.</p></div>';
        }
    } else {
        $filtered = $hotelsArray;
    }

    // ========== SORTEER LOGICA ==========
    if (!empty($sortBy) && !empty($filtered)) {
        // EERST: Extraheer laagste prijzen van alle hotels (scan room prices)
        $hotelLowestPrices = [];
        foreach ($filtered as $h) {
            $hid = (int) $h->{'hotel.id'};
            $lowestPrice = null;

            if (isset($h->roomtypes->roomtype)) {
                foreach ($h->roomtypes->roomtype as $rt) {
                    if (!isset($rt->rooms->room))
                        continue;
                    foreach ($rt->rooms->room as $room) {
                        if (isset($room->meals->meal)) {
                            foreach ($room->meals->meal as $meal) {
                                if (isset($meal->prices->price)) {
                                    $mealPrice = (float) $meal->prices->price;
                                    if ($mealPrice > 0 && ($lowestPrice === null || $mealPrice < $lowestPrice)) {
                                        $lowestPrice = $mealPrice;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            $hotelLowestPrices[$hid] = $lowestPrice ?? 0.0;
        }

        // NU: Sorteer op basis van de extracted prices
        usort($filtered, function ($a, $b) use ($sortBy, $staticData, $hotelLowestPrices) {
            $aId = (int) $a->{'hotel.id'};
            $bId = (int) $b->{'hotel.id'};

            switch ($sortBy) {
                case 'price_asc':
                    // Prijs laag -> hoog (gebruik gescande room prices)
                    $aPrice = isset($hotelLowestPrices[$aId]) ? $hotelLowestPrices[$aId] : 0.0;
                    $bPrice = isset($hotelLowestPrices[$bId]) ? $hotelLowestPrices[$bId] : 0.0;

                    // Hotels zonder prijs achteraan
                    if ($aPrice == 0 && $bPrice == 0)
                        return 0;
                    if ($aPrice == 0)
                        return 1;
                    if ($bPrice == 0)
                        return -1;
                    return $aPrice <=> $bPrice;

                case 'price_desc':
                    // Prijs hoog -> laag (gebruik gescande room prices)
                    $aPrice = isset($hotelLowestPrices[$aId]) ? $hotelLowestPrices[$aId] : 0.0;
                    $bPrice = isset($hotelLowestPrices[$bId]) ? $hotelLowestPrices[$bId] : 0.0;

                    // Hotels zonder prijs achteraan
                    if ($aPrice == 0 && $bPrice == 0)
                        return 0;
                    if ($aPrice == 0)
                        return 1;
                    if ($bPrice == 0)
                        return -1;
                    return $bPrice <=> $aPrice;

                case 'stars_desc':
                    // Sterren hoog -> laag (5->1)
                    $aStars = isset($staticData[$aId]['star_rate']) ? (int) $staticData[$aId]['star_rate'] : 0;
                    $bStars = isset($staticData[$bId]['star_rate']) ? (int) $staticData[$bId]['star_rate'] : 0;
                    return $bStars <=> $aStars;

                case 'stars_asc':
                    // Sterren laag -> hoog (1->5)
                    $aStars = isset($staticData[$aId]['star_rate']) ? (int) $staticData[$aId]['star_rate'] : 0;
                    $bStars = isset($staticData[$bId]['star_rate']) ? (int) $staticData[$bId]['star_rate'] : 0;
                    return $aStars <=> $bStars;

                case 'rating_desc':
                    // Beoordeling hoog -> laag
                    $aRating = isset($staticData[$aId]['review_score']) ? (float) $staticData[$aId]['review_score'] : 0;
                    $bRating = isset($staticData[$bId]['review_score']) ? (float) $staticData[$bId]['review_score'] : 0;
                    return $bRating <=> $aRating;

                default:
                    return 0;
            }
        });

        if (defined('WP_DEBUG') && WP_DEBUG) {// Log eerste 5 hotels om prijzen te checken
            for ($i = 0; $i < min(5, count($filtered)); $i++) {
                $h = $filtered[$i];
                $hid = (int) $h->{'hotel.id'};
                $price = isset($hotelLowestPrices[$hid]) ? $hotelLowestPrices[$hid] : 0.0;
            }
        }
    }

    $totalHotels = count($filtered);
    if ($totalHotels === 0) {
        echo '<div class="text-center py-8"><p class="text-gray-500 text-lg mb-2">üîç Geen hotels gevonden</p><p class="text-gray-400 text-sm">Probeer andere zoekparameters of filters</p></div>';
        wp_die();
    }
    $perPage = 20;
    $page = isset($_POST['page']) ? max(1, intval($_POST['page'])) : 1;
    $totalPages = max(1, (int) ceil($totalHotels / $perPage));
    if ($page > $totalPages) {
        $page = $totalPages;
    }

    // Debug pagination - ALWAYS log for debugging
    $offset = ($page - 1) * $perPage;
    $pageSlice = array_slice($filtered, $offset, $perPage);

    // Inline CSS voor fallback als Tailwind niet correct laadt
    echo '<style>
    .st-fullbleed{width:100%;max-width:1200px;margin:0 auto;padding:0 clamp(8px,3vw,32px);}
    .st-results-shell{
      display:block;
      width:100%;
      margin-top:24px;
    }
    .st-results-list{min-width:0;}
    .st-results-grid{
      display:flex;
      flex-direction:column;
      gap:20px;
      width:100%;
    }
    .st-hotel-card {
      background:#fff;
      border-radius:22px;
      box-shadow:0 18px 40px rgba(15,23,42,0.07);
      overflow:hidden;
      display:grid;
      grid-template-columns:minmax(180px,240px) minmax(0,1.4fr) minmax(190px,0.85fr);
      border:1px solid #e2e8f0;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .st-hotel-card:hover{
      transform:translateY(-4px);
      box-shadow:0 30px 70px rgba(15,23,42,0.15);
    }
    .st-leftcol{
      position:relative;
      display:flex;
      flex-direction:column;
      border-right:1px solid #e2e8f0;
      background:#fff;
    }
    .st-card-imgwrap{
      position:relative;
      width:100%;
      aspect-ratio:5/4;
      min-height:200px;
      overflow:hidden;
      border-bottom:1px solid #e2e8f0;
    }
    .st-hotel-image,
    .st-hotel-placeholder{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#f8fafc;
    }
    .st-hotel-placeholder{
      background:#1f2937;
      color:#cbd5f5;
      font-size:14px;
      align-items:center;
      justify-content:center;
      display:flex;
    }
    .st-card-flag-stack{
      position:absolute;
      top:16px;
      left:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index:2;
    }
    .st-card-flag{
      font-size:12px;
      font-weight:700;
      padding:6px 14px;
      border-radius:999px;
      text-transform:uppercase;
      letter-spacing:0.04em;
      background:rgba(255,255,255,0.94);
      color:#0f172a;
      border:1px solid rgba(15,23,42,0.08);
    }
    .st-card-flag.hot{
      background:#fef3c7;
      color:#92400e;
      border-color:#fde68a;
    }
    .st-card-flag.cool{
      background:rgba(15,23,42,0.85);
      color:#fff;
      border-color:rgba(15,23,42,0.85);
    }
    .st-midcol{
      padding:20px 24px;
      display:flex;
      flex-direction:column;
      gap:10px;
      border-right:1px solid #e2e8f0;
      background:#fff;
    }
    .st-hotel-content{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .st-card-title-row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .st-card-category{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#94a3b8;
      font-weight:700;
      margin:0 0 4px 0;
    }
    .st-hotel-title{
      font-size:20px;
      font-weight:700;
      margin:0;
      color:#0f172a;
      line-height:1.25;
    }
    .st-hotel-location{
      font-size:13px;
      color:#64748b;
      margin:0;
      line-height:1.2;
    }
    .st-hotel-address{
      font-size:12px;
      color:#94a3b8;
      margin:2px 0 8px 0;
      line-height:1.2;
    }
    .st-card-meta-line{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:#475569;
    }
    .st-card-meta-line .st-card-meta-dot{
      color:#cbd5f5;
    }
    .st-card-meta-item{
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .st-card-meta-item.st-meta-stars{
      color:#f59e0b;
      letter-spacing:1px;
      font-weight:600;
    }
    .st-rating-chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:12px;
      font-weight:600;
    }
    .st-rating-chip .st-rating-score{
      font-size:20px;
      line-height:1;
    }
    .st-rating-chip .st-rating-text{
      font-size:12px;
      display:block;
      line-height:1.1;
    }
    .st-rating-chip .st-rating-count{
      font-size:12px;
      font-weight:400;
      opacity:0.85;
    }
    .st-rating-chip.st-rating-great{background:#fef3c7;color:#92400e;}
    .st-rating-chip.st-rating-good{background:#ecfdf5;color:#065f46;}
    .st-rating-chip.st-rating-fair{background:#e0f2fe;color:#0c4a6e;}
    .st-rating-chip.st-rating-neutral{background:#f8fafc;color:#475569;}
    .st-card-highlights{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      max-height:none;
      overflow:visible;
    }
    .st-highlight-item{
      width:28px;
      height:28px;
      border-radius:50%;
      background:#dbeafe;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid #93c5fd;
      position:relative;
    }
    .st-highlight-item .st-highlight-icon{
      font-size:16px;
      cursor:help;
      color:#0f172a;
    }
    .st-highlight-more{
      position:relative;
    }
    .st-features-more{
      width:32px;
      height:32px;
      border-radius:50%;
      border:none;
      background:#dbeafe;
      color:#1d4ed8;
      font-weight:600;
      cursor:pointer;
    }
    .st-features-popup{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.6);
      z-index:1000;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .st-features-popup.active{
      display:flex;
    }
    .st-features-dialog{
      background:#fff;
      border-radius:20px;
      padding:24px;
      max-width:520px;
      width:100%;
      box-shadow:0 20px 40px rgba(15,23,42,0.25);
    }
    .st-features-dialog h4{
      margin:0 0 16px 0;
      font-size:18px;
      color:#0f172a;
    }
    .st-features-dialog .st-card-highlights{
      justify-content:flex-start;
    }
    .st-features-dialog button{
      margin-top:20px;
      background:#2563eb;
      color:#fff;
      border:none;
      border-radius:12px;
      padding:10px 18px;
      font-weight:600;
      cursor:pointer;
    }
    .st-results-list .st-highlight-item{
      width:28px;
      height:28px;
    }
    }
    .st-rightcol{
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      background:#f8fafc;
    }
    .st-price-panel{
      background:#fff;
      border:1px solid #e2e8f0;
      border-radius:18px;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .st-price-chip{
      font-size:12px;
      text-transform:uppercase;
      font-weight:700;
      background:#fde68a;
      color:#92400e;
      padding:4px 12px;
      border-radius:999px;
      align-self:flex-start;
    }
    .st-price-amount{
      font-size:28px;
      font-weight:700;
      color:#0f172a;
      line-height:1.1;
    }
    .st-price-note{
      font-size:13px;
      color:#475569;
    }
    .st-price-perks{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .st-price-perk{
      font-size:12px;
      color:#065f46;
      background:#ecfdf5;
      border-radius:999px;
      padding:4px 10px;
      font-weight:600;
    }
    .st-hotel-desc{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:0;
      color:#374151;
    }
    .st-hotel-desc.is-expanded{
      -webkit-line-clamp:unset;
    }
    .st-hotel-button{
      width:100%;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      background:#0aad5b;
      color:#fff;
      padding:10px 16px;
      border-radius:999px;
      font-weight:700;
      font-size:15px;
      text-decoration:none;
      transition:background 0.2s ease;
      box-shadow:0 8px 16px rgba(16,173,91,0.25);
    }
    .st-hotel-button:hover{background:#059a52;}
    .st-affiliate-buttons{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:6px;
      width:100%;
    }
    .st-affiliate-buttons .st-affiliate-btn{
      width:auto;
      min-width:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      padding:8px 10px;
      border-radius:12px;
      border:none;
      font-weight:600;
      cursor:pointer;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow:0 6px 12px rgba(15,23,42,0.08);
    }
    .st-affiliate-buttons .st-affiliate-btn:hover{
      transform:translateY(-2px);
    }
    @media (max-width:1200px){
      .st-hotel-card{grid-template-columns:minmax(170px,220px) minmax(0,1fr) minmax(170px,220px);}
    }
    @media (max-width:1024px){
      .st-hotel-card{
        grid-template-columns:1fr;
      }
      
      .st-leftcol{
        border-right:none;
        border-bottom:1px solid #e2e8f0;
      }
      
      /* Affiliate buttons SIMPEL EN ALTIJD ZICHTBAAR */
      .st-affiliate-buttons{
        display:grid !important;
        grid-template-columns:1fr;
        padding:8px;
        gap:4px;
        border-top:1px solid #e2e8f0;
      }
      
      .st-midcol{
        border-right:none;
      }
      .st-rightcol{
        background:#fff;
        border-top:1px solid #e2e8f0;
      }
    }
    @media (max-width:640px){
      /* Container breder op mobiel - minder padding aan zijkanten */
      .st-fullbleed{
        padding:0 8px !important;
      }
      
      .st-results-grid{
        gap:16px;
      }
      
      .st-hotel-card{
        border-radius:16px;
      }
      
      .st-midcol{padding:16px;}
      .st-card-imgwrap{min-height:200px;}
      
      /* Affiliate buttons VEEL kleiner en compacter op mobiel */
      .st-affiliate-buttons{
        grid-template-columns:1fr;
        gap:4px;
        padding:8px;
      }
      .st-affiliate-buttons .st-affiliate-btn{
        flex:1 1 100%;
        padding:8px 12px;
        font-size:12px;
        min-height:36px;
        border-radius:6px;
      }
      
      /* Hotel card image kleiner op mobiel */
      .st-card-imgwrap{
        min-height:180px;
        aspect-ratio:16/10;
      }
      
      /* Hotel title en content aangepast */
      .st-hotel-title{
        font-size:18px;
        line-height:1.3;
      }
      
      .st-hotel-content{
        padding:16px;
      }
      
      /* Price panel compacter */
      .st-rightcol{
        padding:16px;
      }
      
      .st-card-price-amount{
        font-size:22px;
      }
      
      /* Badges smaller */
      .st-card-flag-stack{
        top:8px;
        left:8px;
        gap:4px;
      }
      
      .st-flag-badge,
      .st-flag-chip{
        font-size:11px;
        padding:4px 8px;
      }
    }
  </style>';
    $itemsHtml = [];
    $mapHotels = [];
    foreach ($pageSlice as $h) {
        ob_start();
        $hid = (int) $h->{'hotel.id'};

        // Prijs fallback - probeer verschillende velden
        $price = 0.0;
        if (isset($h->pricevalue) && (string) $h->pricevalue !== '' && (string) $h->pricevalue !== '0') {
            $price = (float) $h->pricevalue;
        } elseif (isset($h->price) && (string) $h->price !== '' && (string) $h->price !== '0') {
            $price = (float) $h->price;
        } elseif (isset($h->{'price.value'}) && (string) $h->{'price.value'} !== '' && (string) $h->{'price.value'} !== '0') {
            $price = (float) $h->{'price.value'};
        }
        $priceText = $price > 0 ? number_format($price * 1.16 * 1.09, 2, ',', '.') . ' ‚Ç¨' : 'Check kamerprijzen';
        $nights_display = 0;
        if (!empty($checkin) && !empty($checkout)) {
            try {
                $checkinDate = new DateTime($checkin);
                $checkoutDate = new DateTime($checkout);
                $nights_display = max(0, $checkinDate->diff($checkoutDate)->days);
            } catch (Exception $e) {
                $nights_display = 0;
            }
        }
        $checkin_display = !empty($checkin) ? date('d-m-Y', strtotime($checkin)) : '';
        $button_text = 'Toon prijzen';
        if (!empty($checkin_display) && $nights_display > 0) {
            $button_text = 'Toon prijzen vanaf ' . $checkin_display . ' voor ' . $nights_display . ' ' . ($nights_display == 1 ? 'dag' : 'dagen');
        }
        $pricePanelHtml = '';
        if ($price > 0) {
            $pricePanelHtml = '<div class="st-card-price"><div class="st-card-price-amount">' . wp_kses_post($priceText) . '</div></div>';
        }

        // Review data
        $rev = $h->review ?? null;
        $rating = isset($h->rating) ? (string) $h->rating : ($rev?->rating ?? '');
        $ratingNum = is_numeric($rating) ? (float) $rating : 0.0;
        // Extra fallbacks voor rating
        if ($ratingNum <= 0 && isset($h->{'review.score'}) && is_numeric((string) $h->{'review.score'})) {
            $ratingNum = (float) $h->{'review.score'};
        }
        $rcount = isset($h->reviewcount) ? (int) $h->reviewcount : ($rev?->count ?? 0);
        if ($rcount <= 0 && isset($h->{'review.count'}) && is_numeric((string) $h->{'review.count'})) {
            $rcount = (int) $h->{'review.count'};
        }
        if ($rcount <= 0 && isset($h->reviews) && isset($h->reviews->review)) {
            $rcount = count($h->reviews->review);
        }
        // Fallback naar DB (static) wanneer NonStatic niets geeft
        if (($ratingNum <= 0 || $rcount <= 0) && isset($staticData[$hid])) {
            $srow = $staticData[$hid];
            if ($ratingNum <= 0 && isset($srow['review_score']) && is_numeric($srow['review_score'])) {
                $ratingNum = (float) $srow['review_score'];
            }
            if ($rcount <= 0 && isset($srow['review_count']) && is_numeric($srow['review_count'])) {
                $rcount = (int) $srow['review_count'];
            }
        }
        // Badges + Laagste prijs: scan ALLE kamers voor policies/meals/flags/prijzen
        $hasFreeCancel = false;         // 0% policy aanwezig
        $hasPartialRefund = false;      // <100% voor cutoff
        $hasBreakfast = false;          // meal name bevat Breakfast
        $isSuperDeal = false;           // flag op kamer
        $isBestBuy = false;             // flag op kamer
        $lowestPrice = null;            // üÜï Laagste prijs van alle kamers

        if (isset($h->roomtypes->roomtype)) {
            foreach ($h->roomtypes->roomtype as $rt) {
                if (!isset($rt->rooms->room))
                    continue;
                foreach ($rt->rooms->room as $room) {
                    // Meals - check voor breakfast EN prijzen
                    if (isset($room->meals->meal)) {
                        foreach ($room->meals->meal as $meal) {
                            $mname = isset($meal->name) ? (string) $meal->name : '';
                            if ($mname !== '' && stripos($mname, 'breakfast') !== false) {
                                $hasBreakfast = true;
                            }

                            // üÜï LAAGSTE PRIJS: haal prijs op uit meal->prices->price
                            if (isset($meal->prices->price)) {
                                $mealPrice = (float) $meal->prices->price;
                                if ($mealPrice > 0 && ($lowestPrice === null || $mealPrice < $lowestPrice)) {
                                    $lowestPrice = $mealPrice;
                                }
                            }
                        }
                    }

                    // Cancellation policies
                    if (isset($room->cancellation_policies->cancellation_policy)) {
                        foreach ($room->cancellation_policies->cancellation_policy as $cp) {
                            $pct = isset($cp->percentage) ? (float) $cp->percentage : null;
                            if ($pct === 0.0) {
                                $hasFreeCancel = true;
                            }
                            if ($pct !== null && $pct > 0.0 && $pct < 100.0) {
                                $hasPartialRefund = true;
                            }
                        }
                    }

                    // Flags
                    if (isset($room->isSuperDeal) && ((string) $room->isSuperDeal) === 'true') {
                        $isSuperDeal = true;
                    }
                    if (isset($room->isBestBuy) && ((string) $room->isBestBuy) === 'true') {
                        $isBestBuy = true;
                    }
                }
            }
        }

        $policyBadgesHtml = '';
        $policyBadges = [];
        if ($hasFreeCancel) {
            $policyBadges[] = 'Gratis annuleren';
        } elseif ($hasPartialRefund) {
            $policyBadges[] = 'Gedeeltelijk restitueerbaar';
        }
        if ($hasBreakfast) {
            $policyBadges[] = 'Ontbijt inbegrepen';
        }
        if (!empty($policyBadges)) {
            $policyBadgesHtml = '<div class="st-policy-badges" style="display:flex;flex-wrap:wrap;gap:6px;margin:8px 0 0;">';
            foreach ($policyBadges as $label) {
                $policyBadgesHtml .= '<span class="st-policy-badge" style="background:#ecfdf5;color:#065f46;border:1px solid #6ee7b7;border-radius:999px;padding:3px 10px;font-size:12px;font-weight:600;line-height:1.4;">' . esc_html($label) . '</span>';
            }
            $policyBadgesHtml .= '</div>';
        }

        // üÜï Update price en priceText met de gevonden laagste prijs
        if ($lowestPrice !== null && $lowestPrice > 0) {
            $price = $lowestPrice;

            // Bereken prijzen:
            // 1. Normale prijs: netto + 16% opslag + 9% BTW
            $normalPrice = $price * 1.16 * 1.09;

            // 2. Freestays voordeel prijs: 15% korting op normale prijs
            $discountPrice = $normalPrice * 0.85;

            // Format prijzen (2 decimalen, komma als scheidingsteken)
            $normalPriceFormatted = number_format($normalPrice, 2, ',', '.');
            $discountPriceFormatted = number_format($discountPrice, 2, ',', '.');

            // Bouw de prijs tekst op
            // ‚¨áÔ∏è KIES HIERONDER WELKE VARIANT JE WILT (commentaar uit een van de 3 opties)

            // OPTIE 1: Volledig (zoals gevraagd, maar lang voor hotel card)
            // $priceText = 'Vanaf ‚Ç¨' . $normalPriceFormatted . ' met Freestays geen commissie, uw prijs: ‚Ç¨' . $discountPriceFormatted;

            // OPTIE 2: Compact met doorgestreepte normale prijs
            // $priceText = '<span style="text-decoration:line-through;color:#9ca3af;">‚Ç¨' . $normalPriceFormatted . '</span> <span style="color:#dc2626;font-weight:700;font-size:18px;">‚Ç¨' . $discountPriceFormatted . '</span> <span style="color:#16a34a;font-size:12px;">(15% korting)</span>';

            // OPTIE 3: Twee regels (normaal + Freestays voordeel)
            $priceText = '<div style="font-size:13px;color:#9ca3af;text-decoration:line-through;">Normaal: ‚Ç¨' . $normalPriceFormatted . '</div><div style="font-size:16px;color:#dc2626;font-weight:700;">Met Freestays voordeel: ‚Ç¨' . $discountPriceFormatted . '</div>';
        }

        // Statische data
        $s = $staticData[$hid] ?? [];
        // On‚Äëdemand Static fallback (SOAP) wanneer kritieke velden ontbreken
        $needs = false;
        if (empty($s) || (empty($s['description']) && empty($h->description)) || (empty($s['image']) && empty($s['main_image']) && empty($s['banner_image']) && empty($h->main_image) && empty($h->image)) || (intval($s['star_rate'] ?? 0) <= 0 && intval($h->category ?? 0) <= 0) || empty($s['address'])) {
            $needs = true;
        }
        if ($needs) {
            $st = shorttrips_get_static_hotel_cached($hid);
            if (!empty($st)) {
                foreach (['title', 'hotelname', 'description', 'address', 'main_image', 'image', 'banner_image'] as $k) {
                    if (empty($s[$k]) && !empty($st[$k])) {
                        $s[$k] = $st[$k];
                    }
                }
                if (empty($s['star_rate']) && !empty($st['category'])) {
                    $s['star_rate'] = (int) $st['category'];
                }
            }
        }
        // Filter op features/themes uit static JSON wanneer gevraagd
        if (!empty($requiredFeatureIds) || !empty($requiredThemeIds)) {
            $ok = true;
            if ($ok && !empty($requiredFeatureIds)) {
                $hasAll = true;
                $feat = [];
                if (!empty($s['features_json'])) {
                    $feat = json_decode($s['features_json'], true);
                }
                $present = [];
                if (is_array($feat)) {
                    foreach ($feat as $f) {
                        if (isset($f['id']))
                            $present[] = intval($f['id']);
                    }
                }
                foreach ($requiredFeatureIds as $rid) {
                    if (!in_array($rid, $present, true)) {
                        $hasAll = false;
                        break;
                    }
                }
                if (!$hasAll)
                    $ok = false;
            }
            if ($ok && !empty($requiredThemeIds)) {
                $hasAll = true;
                $the = [];
                if (!empty($s['themes_json'])) {
                    $the = json_decode($s['themes_json'], true);
                }
                $present = [];
                if (is_array($the)) {
                    foreach ($the as $t) {
                        if (isset($t['id']))
                            $present[] = intval($t['id']);
                    }
                }
                foreach ($requiredThemeIds as $rid) {
                    if (!in_array($rid, $present, true)) {
                        $hasAll = false;
                        break;
                    }
                }
                if (!$hasAll)
                    $ok = false;
            }
            if (!$ok) {
                continue;
            }
        }

        // Hotel naam - probeer alle mogelijke bronnen
        $name = '';
        if (!empty($s['title'])) {
            $name = $s['title'];
        } elseif (!empty($s['hotelname'])) {
            $name = $s['hotelname'];
        } elseif (isset($h->name)) {
            $name = (string) $h->name;
        } elseif (isset($h->hotelname)) {
            $name = (string) $h->hotelname;
        }
        if (empty($name))
            $name = 'Hotel #' . $hid;

        // Locatie data
        $region = !empty($s['destination_name']) ? $s['destination_name'] : '';
        $country = !empty($s['country_name']) ? $s['country_name'] : '';
        $city = !empty($s['city']) ? $s['city'] : '';

        // Als we geen city/region hebben, probeer uit XML
        if (empty($city) && isset($h->city))
            $city = (string) $h->city;
        if (empty($region) && isset($h->resort))
            $region = (string) $h->resort;
        if (empty($country) && isset($h->country))
            $country = (string) $h->country;

        $locationParts = [];
        if (!empty($city)) {
            $locationParts[] = $city;
        } elseif (!empty($region)) {
            $locationParts[] = $region;
        }
        if (!empty($country)) {
            $locationParts[] = $country;
        }
        $location = !empty($locationParts) ? implode(', ', $locationParts) : 'Locatie onbekend';

        // Geografische co√∂rdinaten voor kaart
        $lat = null;
        $lng = null;
        if (!empty($s['latitude']) && !empty($s['longitude'])) {
            $lat = (float) $s['latitude'];
            $lng = (float) $s['longitude'];
        } elseif (!empty($s['lat']) && !empty($s['lng'])) {
            $lat = (float) $s['lat'];
            $lng = (float) $s['lng'];
        } elseif (isset($h->latitude) && isset($h->longitude)) {
            $lat = (float) $h->latitude;
            $lng = (float) $h->longitude;
        }
        if (($lat === null || $lng === null) && isset($s['map_lat']) && isset($s['map_lng']) && $s['map_lat'] !== '' && $s['map_lng'] !== '') {
            $lat = (float) $s['map_lat'];
            $lng = (float) $s['map_lng'];
        } elseif (($lat === null || $lng === null) && isset($h->map_lat) && isset($h->map_lng) && $h->map_lat !== '' && $h->map_lng !== '') {
            $lat = (float) $h->map_lat;
            $lng = (float) $h->map_lng;
        }

        // ‚≠ê STAR RATING uit Sunhotels API
        // Volgens Sunhotels XML API v15: <category> bevat het sterren aantal (1-5)
        $stars = 0;

        // Check database eerst (kan leeg zijn)
        if (!empty($s['star_rate']) && intval($s['star_rate']) > 0) {
            $stars = intval($s['star_rate']);
        }

        // Check Sunhotels API <category> veld (offici√´le bron voor sterren)
        if ($stars === 0) {
            // Probeer verschillende notaties van het category veld
            if (isset($h->category)) {
                $catValue = (string) $h->category;
                if (is_numeric($catValue) && intval($catValue) > 0 && intval($catValue) <= 5) {
                    $stars = intval($catValue);
                }
            }

            // Fallback naar hotel.category notatie
            if ($stars === 0 && isset($h->{'hotel.category'})) {
                $catValue = (string) $h->{'hotel.category'};
                if (is_numeric($catValue) && intval($catValue) > 0 && intval($catValue) <= 5) {
                    $stars = intval($catValue);
                }
            }
        }

        // Sterren rating is nu correct bepaald uit database of API

        $desc = !empty($s['description']) ? $s['description'] : (isset($h->description) ? (string) $h->description : '');
        $addr = !empty($s['address']) ? $s['address'] : (isset($h->address) ? (string) $h->address : '');

        // Afbeelding - probeer alle mogelijke bronnen
        $imgSrc = '';
        if (!empty($s['image'])) {
            $imgSrc = $s['image'];
        } elseif (!empty($s['main_image'])) {
            $imgSrc = $s['main_image'];
        } elseif (!empty($s['banner_image'])) {
            $imgSrc = $s['banner_image'];
        } elseif (isset($h->main_image) && !empty((string) $h->main_image)) {
            $imgSrc = (string) $h->main_image;
        } elseif (isset($h->image) && !empty((string) $h->image)) {
            $imgSrc = (string) $h->image;
        }

        // Compacte amenities lijst (later onder de foto tonen)
        $amenitiesHtml = '';
        if (!empty($s['features_json'])) {
            $featList = json_decode($s['features_json'], true);
            if (is_array($featList) && !empty($featList)) {
                $emojiIcons = [
                    'Air Conditioning' => '&#10052;',
                    'Wireless internet' => '&#128246;',
                    'Free Wi-Fi' => '&#128246;',
                    'Wi-Fi' => '&#128246;',
                    'Pool' => '&#127946;',
                    'Indoor pool(s)' => '&#127946;',
                    'Outdoor pool(s)' => '&#127946;',
                    'Swimming pool' => '&#127946;',
                    'Restaurant' => '&#127860;',
                    'Bar' => '&#127864;',
                    'Breakfast' => '&#129384;',
                    'Gym/fitness facilities' => '&#128170;',
                    'Sauna' => '&#129496;',
                    'Spa' => '&#128134;',
                    'Parking' => '&#127359;',
                    'Car parking' => '&#127359;',
                    'Car parking (chargeable)' => '&#127359;',
                    'Garden' => '&#127795;',
                    'Terrace' => '&#127795;',
                    'Pets allowed' => '&#128062;',
                    '24-hour reception' => '&#128276;',
                    'Beach' => '&#127958;'
                ];
                $unique = [];
                foreach ($featList as $f) {
                    $label = trim((string) ($f['name'] ?? ''));
                    if ($label === '' || isset($unique[$label]))
                        continue;
                    $unique[$label] = $label;
                }
                $items = [];
                foreach (array_values($unique) as $label) {
                    $emoji = $emojiIcons[$label] ?? '&#8226;';
                    $items[] = '<li class="st-highlight-item"><span class="st-highlight-icon" title="' . esc_attr($label) . '">' . $emoji . '</span></li>';
                }
                if (!empty($items)) {
                    $visible = array_slice($items, 0, 8);
                    $hidden = array_slice($items, 8);
                    $amenitiesHtml = '<ul class="st-card-highlights">' . implode('', $visible);
                    if (!empty($hidden)) {
                        $hiddenContent = '<ul class="st-card-highlights">' . implode('', $hidden) . '</ul>';
                        $amenitiesHtml .= '<li class="st-highlight-item st-highlight-more"><button type="button" class="st-features-more" data-hidden="' . esc_attr($hiddenContent) . '">+' . count($hidden) . '</button></li>';
                    }
                    $amenitiesHtml .= '</ul>';
                }
            }
        }

        // DEBUG: Log star rating sources voor eerste 3 hotels
        // ‚ö†Ô∏è TEMPORARY ENABLED for debugging - disable after fixing
        static $debugStarCount = 0;
        if ($debugStarCount < 3) {// Also dump the full XML structure of first hotel for inspection
            if ($debugStarCount === 0) {
            }
            $debugStarCount++;
        }

        $badgeStackHtml = '';
        if ($isSuperDeal) {
            $badgeStackHtml .= '<span class="st-card-flag hot">Populaire keuze</span>';
        } elseif ($isBestBuy) {
            $badgeStackHtml .= '<span class="st-card-flag hot">Aanbevolen</span>';
        } elseif ($ratingNum >= 8.7) {
            $badgeStackHtml .= '<span class="st-card-flag hot">Top beoordeeld</span>';
        }
        if ($hasBreakfast) {
            $badgeStackHtml .= '<span class="st-card-flag cool">Ontbijt inbegrepen</span>';
        } elseif ($hasFreeCancel) {
            $badgeStackHtml .= '<span class="st-card-flag cool">Gratis annuleren</span>';
        }

        $ratingChipHtml = '';
        if ($ratingNum > 0) {
            $ratingLabel = 'Goed';
            $ratingClass = 'st-rating-neutral';
            if ($ratingNum >= 9.2) {
                $ratingLabel = 'Fantastisch';
                $ratingClass = 'st-rating-great';
            } elseif ($ratingNum >= 8.6) {
                $ratingLabel = 'Uitstekend';
                $ratingClass = 'st-rating-good';
            } elseif ($ratingNum >= 8.0) {
                $ratingLabel = 'Erg goed';
                $ratingClass = 'st-rating-fair';
            }
            $ratingChipHtml = '<div class="st-rating-chip ' . $ratingClass . '"><span class="st-rating-score">' . esc_html(number_format($ratingNum, 1, ',', '')) . '</span><div><span class="st-rating-text">' . esc_html($ratingLabel) . '</span>';
            if ($rcount > 0) {
                $ratingChipHtml .= '<span class="st-rating-count">' . number_format($rcount, 0, ',', '.') . ' reviews</span>';
            }
            $ratingChipHtml .= '</div></div>';
        }

        $priceWithFees = $price > 0 ? $price * 1.16 * 1.09 : 0;
        $priceDisplay = $price > 0 ? '‚Ç¨ ' . number_format($priceWithFees, 0, ',', '.') : '';
        $perNightDisplay = ($price > 0 && $nights_display > 0)
            ? '‚Ç¨ ' . number_format($priceWithFees / max(1, $nights_display), 0, ',', '.') . ' per nacht'
            : '';
        $stayContext = $nights_display > 0
            ? 'voor ' . $nights_display . ' ' . ($nights_display === 1 ? 'nacht' : 'nachten')
            : 'per verblijf';
        $priceChipText = $isSuperDeal ? 'Populaire keuze' : ($isBestBuy ? 'Onze tip' : ($hasFreeCancel ? 'Flexibel tarief' : 'Beste deal'));
        $affiliateButtonsHtml = '';
        $enableCards = get_option('shorttrips_affiliate_enable_cards', '1');
        if ($enableCards === '1') {
            $affiliateButtonsHtml .= '<div class="st-affiliate-buttons">';
            $affiliateButtonsHtml .= '<button type="button" class="st-affiliate-btn tertiary" onclick="openAffiliateModal(\'experiences\', \'' . esc_js($location) . '\', \'' . esc_js($location) . '\', \'' . esc_js($checkin) . '\', \'' . esc_js($checkout) . '\')" style="background:#f59e0b;color:#fff;">Belevenissen</button>';
            $affiliateButtonsHtml .= '<button type="button" class="st-affiliate-btn" onclick="openAffiliateModal(\'rentacar\', \'' . esc_js($location) . '\', \'' . esc_js($location) . '\', \'' . esc_js($checkin) . '\', \'' . esc_js($checkout) . '\')" style="background:#10b981;color:#fff;">üöó Auto huren</button>';
            $affiliateButtonsHtml .= '<button type="button" class="st-affiliate-btn secondary" onclick="openAffiliateModal(\'flights\', \'' . esc_js($location) . '\', \'' . esc_js($location) . '\', \'' . esc_js($checkin) . '\', \'' . esc_js($checkout) . '\')" style="background:#2563eb;color:#fff;">‚úàÔ∏è Vluchten</button>';
            $affiliateButtonsHtml .= '</div>';
        }

        // Card HTML met inline styles als fallback
        echo '<div class="st-hotel-card bg-white rounded-xl shadow overflow-hidden" data-hotel-id="' . intval($hid) . '" data-price="' . esc_attr($price) . '" data-rating="' . esc_attr($ratingNum) . '" data-stars="' . esc_attr($stars) . '">';
        echo '<div class="st-leftcol">';
        echo '<div class="st-card-imgwrap">';
        if ($badgeStackHtml !== '') {
            echo '<div class="st-card-flag-stack">' . $badgeStackHtml . '</div>';
        }
        if ($imgSrc || !empty($s['main_image']) || !empty($s['image']) || !empty($s['banner_image']) || !empty($s['images_json']) || !empty($s['json_images'])) {
            $fallbacks = [];
            if (!empty($imgSrc)) {
                $fallbacks[] = $imgSrc;
            }
            if (!empty($s['main_image'])) {
                $fallbacks[] = $s['main_image'];
            }
            if (!empty($s['image'])) {
                $fallbacks[] = $s['image'];
            }
            if (!empty($s['banner_image'])) {
                $fallbacks[] = $s['banner_image'];
            }
            // Gebruik images_json en json_images uit DB indien beschikbaar (meer kans op geldige afbeeldingen)
            if (!empty($s['images_json'])) {
                $ij = json_decode($s['images_json'], true);
                if (is_array($ij)) {
                    foreach ($ij as $u) {
                        if (is_string($u) && $u !== '')
                            $fallbacks[] = $u;
                    }
                }
            }
            if (!empty($s['json_images'])) {
                $ij = json_decode($s['json_images'], true);
                if (is_array($ij)) {
                    foreach ($ij as $u) {
                        if (is_string($u) && $u !== '')
                            $fallbacks[] = $u;
                    }
                }
            }
            // Vermijd gok-URL's met $hid om 404's te beperken; gebruik alleen bekende bronnen
            $fallbacks = array_values(array_unique(array_filter($fallbacks)));
            $fallbackAttr = esc_attr(implode('|', $fallbacks));
            echo '<div class="st-card-imgwrap" style="position:relative">';
            echo '<script>(function(){ if(!window.stImgFallbackInline){ window.stImgFallbackInline=function(img){ var list=(img.getAttribute("data-srcs")||"").split("|").filter(Boolean); var idx=parseInt(img.getAttribute("data-idx")||"0",10)||0; idx++; if(idx<list.length){ img.setAttribute("data-idx", String(idx)); img.src=list[idx]; } else { img.onerror=null; img.src="https://via.placeholder.com/640x384?text=Geen+afbeelding"; } }; } })();</script>';
            echo '<img id="st-card-img-' . $hid . '" src="' . esc_url($fallbacks[0]) . '" alt="' . esc_attr($name) . '" class="st-hotel-image w-full object-cover" style="width:100%;height:100%;min-height:200px;object-fit:cover;display:block;" loading="lazy" data-idx="0" data-srcs="' . $fallbackAttr . '" onerror="window.stImgFallbackInline && stImgFallbackInline(this)">';
            echo '<button type="button" class="st-card-nav" aria-label="Vorige" style="position:absolute;left:6px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:#fff;border:none;width:28px;height:28px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer" onclick="(function(){var m=document.getElementById(\'st-card-img-' . $hid . '\'); if(!m)return; var list=(m.getAttribute(\'data-srcs\')||\"\").split(\'|\').filter(Boolean); var idx=parseInt(m.getAttribute(\'data-idx\')||\'0\',10)||0; idx = (idx-1+list.length)%list.length; m.setAttribute(\'data-idx\', String(idx)); m.src=list[idx];})()">‚Äπ</button>';
            echo '<button type="button" class="st-card-nav" aria-label="Volgende" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:#fff;border:none;width:28px;height:28px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer" onclick="(function(){var m=document.getElementById(\'st-card-img-' . $hid . '\'); if(!m)return; var list=(m.getAttribute(\'data-srcs\')||\"\").split(\'|\').filter(Boolean); var idx=parseInt(m.getAttribute(\'data-idx\')||\'0\',10)||0; idx = (idx+1)%list.length; m.setAttribute(\'data-idx\', String(idx)); m.src=list[idx];})()">‚Ä∫</button>';
            echo '</div>';
        } else {
            echo '<div class="st-card-imgwrap">';
            echo '<div class="st-hotel-placeholder w-full bg-gray-200 flex items-center justify-center text-gray-400 text-sm" style="width:100%;height:240px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:14px;">Geen afbeelding</div>';
            echo '</div>';
        }
        echo '</div>';
        if ($affiliateButtonsHtml !== '') {
            echo $affiliateButtonsHtml;
        }
        echo '</div>';

        echo '<div class="st-midcol"><div class="st-hotel-content">';
        echo '<div class="st-card-title-row"><div>';
        if (!empty($typeLabel)) {
            echo '<p class="st-card-category">' . esc_html($typeLabel) . '</p>';
        }
        echo '<h3 class="st-hotel-title">' . esc_html($name) . '</h3>';

        // Type + rating chips
        $metaParts = [];
        if ($stars > 0) {
            $metaParts[] = [
                'label' => str_repeat('‚òÖ', $stars),
                'class' => 'st-meta-stars'
            ];
        }
        if (!empty($typeLabel)) {
            $metaParts[] = [
                'label' => $typeLabel,
                'class' => ''
            ];
        }
        if ($ratingNum > 0) {
            $ratingPart = number_format($ratingNum, 1, ',', '') . ' / 10';
            if ($rcount > 0) {
                $ratingPart .= ' (' . number_format($rcount) . ')';
            }
            $metaParts[] = [
                'label' => $ratingPart,
                'class' => ''
            ];
        }
        if (!empty($metaParts)) {
            echo '<div class="st-card-meta-line">';
            $firstMeta = true;
            foreach ($metaParts as $part) {
                if (!$firstMeta) {
                    echo '<span class="st-card-meta-dot">‚Ä¢</span>';
                }
                $metaClass = 'st-card-meta-item';
                if (!empty($part['class'])) {
                    $metaClass .= ' ' . $part['class'];
                }
                echo '<span class="' . esc_attr($metaClass) . '">' . esc_html($part['label']) . '</span>';
                $firstMeta = false;
            }
            echo '</div>';
        }
        echo '</div>';
        if ($ratingChipHtml !== '') {
            echo $ratingChipHtml;
        }
        echo '</div>';

        echo '<p class="st-hotel-location">üìç ' . esc_html($location) . '</p>';


        if ($addr) {
            echo '<p class="st-hotel-address">' . esc_html($addr) . '</p>';
        }

        if ($desc) {
            $descFull = wp_strip_all_tags($desc);
            $descShort = wp_trim_words($descFull, 24, '‚Ä¶');
            $descId = 'st-desc-' . $hid;
            echo '<p id="' . $descId . '" class="st-hotel-desc text-sm text-gray-700 mb-2" data-full="' . esc_attr($descFull) . '" data-short="' . esc_attr($descShort) . '" style="font-size:14px;color:#374151;margin-bottom:8px;line-height:1.5;">' . esc_html($descShort) . '</p>';
            if ($descFull !== $descShort) {
                echo '<button type="button" class="st-desc-toggle" data-target="' . $descId . '" style="align-self:flex-start;font-size:13px;color:#2563eb;background:none;border:none;padding:0;cursor:pointer;">Lees meer</button>';
            }
        }

        if ($amenitiesHtml !== '') {
            echo '<div class="st-card-highlights-wrap" data-hotel="' . $hid . '">' . $amenitiesHtml . '</div>';
            echo '<div class="st-features-popup" id="st-popup-' . $hid . '"><div class="st-features-dialog"><h4>Voorzieningen bij ' . esc_html($name) . '</h4><div class="st-features-content"></div><button type="button" data-close="' . $hid . '">Sluiten</button></div></div>';
        }

        echo '</div></div>';

        $prebookParams = [
            'hotelId' => $hid,
            'checkin' => $checkin,
            'checkout' => $checkout,
            'rooms' => $rooms,
            'adults' => $adults,
            'children' => $children
        ];

        if (!empty($childAges)) {
            $prebookParams['child_ages'] = implode(',', $childAges);
        }
        if (!empty($type))
            $prebookParams['type'] = $type;
        if (!empty($q))
            $prebookParams['q'] = $q;
        if (!empty($country))
            $prebookParams['country'] = $country;
        if (!empty($resort))
            $prebookParams['resort'] = $resort;
        if (!empty($destinationId))
            $prebookParams['destinationID'] = $destinationId;

        $prebookUrl = add_query_arg($prebookParams, home_url('/prebook/'));

        echo '<div class="st-rightcol">';
        echo '<div class="st-price-panel">';
        if (!empty($priceChipText)) {
            echo '<span class="st-price-chip">' . esc_html($priceChipText) . '</span>';
        }
        if ($priceDisplay !== '') {
            echo '<div class="st-price-amount">' . esc_html($priceDisplay) . '</div>';
            $noteBits = [];
            if ($perNightDisplay !== '') {
                $noteBits[] = $perNightDisplay;
            }
            if ($stayContext !== '') {
                $noteBits[] = $stayContext;
            }
            echo '<div class="st-price-note">' . esc_html(implode(' ‚Ä¢ ', $noteBits)) . '</div>';
        } else {
            echo '<div class="st-price-note">Prijs op aanvraag - check actuele beschikbaarheid</div>';
        }
        if ($policyBadgesHtml !== '') {
            echo $policyBadgesHtml;
        }
        echo '<a href="' . esc_url($prebookUrl) . '" class="st-hotel-button">' . esc_html($button_text) . '</a>';
        echo '</div>';

        echo '</div></div>';

        if ($lat !== null && $lng !== null) {
            $mapHotels[] = [
                'id' => $hid,
                'name' => $name,
                'lat' => $lat,
                'lng' => $lng,
                'priceLabel' => wp_strip_all_tags($priceText),
                'link' => $prebookUrl,
                'stars' => $stars,
            ];
        }
        $itemsHtml[] = ob_get_clean();
    }

    // Output: sorteer dropdown + hotel grid in √©√©n container
    echo '<div id="st-results-root" class="st-fullbleed">';

    // Bepaal actieve filters voor indicator
    $activeFilterLabels = [];
    if ($minStars > 0 || $maxStars > 0) {
        $rangeLabel = ($minStars > 0 ? $minStars : '1') . ' - ' . ($maxStars > 0 ? $maxStars : '5');
        $activeFilterLabels[] = '‚≠ê Sterren ' . $rangeLabel;
    }
    if ($minPrice > 0 || $maxPrice > 0) {
        $rangeLabel = '‚Ç¨' . ($minPrice > 0 ? number_format($minPrice) : '0') . ' - ' . ($maxPrice > 0 ? number_format($maxPrice) : '‚àû');
        $activeFilterLabels[] = 'üí∞ Prijs ' . $rangeLabel;
    }
    if (!empty($requiredFeatureIds)) {
        $activeFilterLabels[] = 'üèä Faciliteiten (' . count($requiredFeatureIds) . ')';
    }
    if (!empty($requiredThemeIds)) {
        $activeFilterLabels[] = 'üé® Thema\'s (' . count($requiredThemeIds) . ')';
    }
    if (!empty($mealIdsArray)) {
        $activeFilterLabels[] = 'üçΩÔ∏è Maaltijden (' . count($mealIdsArray) . ')';
    }
    if ($excludeSharedRooms) {
        $activeFilterLabels[] = 'üõèÔ∏è Geen gedeelde kamers';
    }
    if ($excludeSharedFacilities) {
        $activeFilterLabels[] = 'üöø Geen gedeelde faciliteiten';
    }

    if (!empty($activeFilterLabels)) {
        echo '<div class="st-active-filter-indicator" style="margin-bottom:12px;padding:12px 16px;background:#2563eb;border-radius:12px;color:#fff;display:flex;flex-wrap:wrap;align-items:center;gap:10px;">';
        echo '<strong style="font-size:14px;letter-spacing:0.01em;">Filters actief</strong>';
        echo '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
        foreach ($activeFilterLabels as $label) {
            echo '<span style="background:rgba(255,255,255,0.15);color:#fff;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:500;">' . esc_html($label) . '</span>';
        }
        echo '</div></div>';
    }

    // Header met totaal-aantal resultaten (links) + Sorteer dropdown (rechts)
    echo '<div class="st-results-head" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap;background:#0f172a;padding:14px 18px;border-radius:12px;">
          <div class="st-results-count" style="font-size:14px;color:#ffffff;font-weight:600;">Aantal gevonden hotels: <span style="color:#fde68a;">' . intval($totalHotels) . '</span></div>
          <div class="st-sort-wrapper" style="display:flex;align-items:center;gap:8px;">
            <label for="st-sort-select" style="font-size:14px;color:#ffffff;margin-right:4px;font-weight:500;">Sorteer op:</label>
            <select id="st-sort-select" class="st-sort-select" style="padding:8px 12px;border:1px solid #1d4ed8;border-radius:8px;font-size:14px;background:#ffffff;color:#0f172a;cursor:pointer;outline:none;transition:all 0.2s;" onchange="stApplySort(this.value)">
              <option value="price_asc" ' . ($sortBy === 'price_asc' ? 'selected' : '') . '>‚Ç¨ Prijs (laag ‚Üí hoog)</option>
              <option value="price_desc" ' . ($sortBy === 'price_desc' ? 'selected' : '') . '>‚Ç¨ Prijs (hoog ‚Üí laag)</option>
              <option value="rating_desc" ' . ($sortBy === 'rating_desc' ? 'selected' : '') . '>‚≠ê Beoordeling (hoog ‚Üí laag)</option>
              <option value="stars_desc" ' . ($sortBy === 'stars_desc' ? 'selected' : '') . '>‚òÖ Sterren (hoog ‚Üí laag)</option>
              <option value="stars_asc" ' . ($sortBy === 'stars_asc' ? 'selected' : '') . '>‚òÖ Sterren (laag ‚Üí hoog)</option>
            </select>
          </div>
        </div>';

    echo '<div class="st-results-shell">';
    echo '<div class="st-results-list"><div class="st-results-grid">' . implode('', $itemsHtml) . '</div></div>';
    echo '</div>';

    echo '</div>'; // Close st-fullbleed

    // Paginering navigatie
    if ($totalPages > 1) {
        echo '<div class="st-pager" style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:16px;">';
        // Build graceful fallback URLs so links work without JavaScript.
        // Compose the query from known search variables so a full page load preserves filters.
        $___stQuery = [
            'type' => isset($type) ? $type : null,
            'q' => isset($q) ? $q : null,
            'country' => isset($country) ? $country : null,
            'resort' => isset($resort) ? $resort : null,
            'checkin' => isset($checkin) ? $checkin : null,
            'checkout' => isset($checkout) ? $checkout : null,
            'rooms' => isset($rooms) ? $rooms : null,
            'adults' => isset($adults) ? $adults : null,
            'children' => isset($children) ? $children : null,
            'child_ages' => !empty($childAges) ? implode(',', $childAges) : null,
        ];

        // Add ALL filter parameters to preserve them during pagination
        if ($minStars !== null)
            $___stQuery['minStars'] = $minStars;
        if ($maxStars !== null)
            $___stQuery['maxStars'] = $maxStars;
        if ($minPrice !== null)
            $___stQuery['minPrice'] = $minPrice;
        if ($maxPrice !== null)
            $___stQuery['maxPrice'] = $maxPrice;
        if ($excludeSharedRooms)
            $___stQuery['excludeSharedRooms'] = '1';
        if ($excludeSharedFacilities)
            $___stQuery['excludeSharedFacilities'] = '1';

        // Add array parameters
        if (!empty($requiredFeatureIds)) {
            foreach ($requiredFeatureIds as $fid) {
                $___stQuery['featureIds'][] = $fid;
            }
        }
        if (!empty($requiredThemeIds)) {
            foreach ($requiredThemeIds as $tid) {
                $___stQuery['themeIds'][] = $tid;
            }
        }
        if (!empty($mealIdsArray)) {
            foreach ($mealIdsArray as $mid) {
                $___stQuery['mealIds'][] = $mid;
            }
        }
        foreach ($___stQuery as $___k => $___v) {
            if ($___v === null || $___v === '') {
                unset($___stQuery[$___k]);
            }
        }
        $___stPrevQuery = $___stQuery;
        $___stPrevQuery['page'] = max(1, (int) $page - 1);
        $___stNextQuery = $___stQuery;
        $___stNextQuery['page'] = min((int) $totalPages, (int) $page + 1);
        $___stPrevHref = htmlspecialchars('?' . http_build_query($___stPrevQuery));
        $___stNextHref = htmlspecialchars('?' . http_build_query($___stNextQuery));

        if ($page > 1) {
            echo '<button type="button" class="st-pager-btn st-pager-prev" data-page="' . ($page - 1) . '" style="padding:8px 16px;border:1px solid #d1d5db;border-radius:8px;color:#1f2937;background:#fff;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'#fff\'">‚Üê Vorige</button>';
        }
        echo '<span style="font-size:14px;color:#374151;font-weight:500;margin:0 16px;">Pagina <strong>' . intval($page) . '</strong> van <strong>' . intval($totalPages) . '</strong></span>';
        if ($page < $totalPages) {
            echo '<button type="button" class="st-pager-btn st-pager-next" data-page="' . ($page + 1) . '" style="padding:8px 16px;border:1px solid #d1d5db;border-radius:8px;color:#1f2937;background:#fff;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'#fff\'">Volgende ‚Üí</button>';
        }
        echo '</div>';

        // ‚úÖ Pagination handled by global script in wp_footer (line ~16350)
        // Old inline pagination script removed to prevent conflicts
    } // End of pagination block

    // ‚úÖ Pagination script is now loaded globally via wp_footer (see line ~16350)

    // ‚úÖ CRITICAL: Set payload in a DATA attribute so it survives innerHTML updates
    $payloadJson = htmlspecialchars(json_encode([
        'action' => 'shorttrips_search_hotels',
        'type' => $type,
        'q' => $q,
        'country' => $country,
        'resort' => $resort,
        'destinationID' => $destinationId,
        'checkin' => $checkin,
        'checkout' => $checkout,
        'rooms' => $rooms,
        'adults' => $adults,
        'children' => $children,
        'child_ages' => implode(',', $childAges),
        'selected_hotel_label' => $selectedHotelLabel,
        'minStars' => $minStars,
        'maxStars' => $maxStars,
        'minPrice' => $minPrice,
        'maxPrice' => $maxPrice,
        'excludeSharedRooms' => $excludeSharedRooms ? '1' : '',
        'excludeSharedFacilities' => $excludeSharedFacilities ? '1' : '',
        'featureIds' => $requiredFeatureIds,
        'themeIds' => $requiredThemeIds,
        'mealIds' => $mealIdsArray
    ]), ENT_QUOTES, 'UTF-8');

    echo '<div id="st-search-payload" data-payload="' . $payloadJson . '" style="display:none;"></div>';
    echo '</div>'; // close st-fullbleed

    // ‚úÖ Payload is loaded by initShortTripsPagination() function (see wp_footer script)
    // Inline scripts don't execute when loaded via innerHTML, so we use data attributes instead
    // ‚úÖ PRIJZEN WORDEN NU DIRECT UIT SEARCHV3 API GELADEN (GEEN AJAX MEER NODIG)
    // De laagste prijs wordt al bepaald tijdens het genereren van de cards (regel ~1905-1935)
    // Onderstaande JavaScript code is niet meer nodig maar blijft voor backwards compatibility
    $enableAutoPriceLoad = get_option('shorttrips_auto_price_load', 'disabled'); // Default nu 'disabled'

    echo '<script>console.log("‚öôÔ∏è Prijzen worden direct uit SearchV3 API geladen (geen AJAX nodig)");</script>';

    if ($enableAutoPriceLoad === 'enabled') {
        echo '<script>(function(){
      console.log("üöÄ Starting auto price load script...");
    var ajax = ' . json_encode(admin_url('admin-ajax.php')) . ';
    var cards = document.querySelectorAll(".st-hotel-card[data-hotel-id]");
      console.log("üì¶ Found " + cards.length + " hotel cards total");
      if(!cards || !cards.length) { console.log("‚ùå No hotel cards found"); return; }
      
      // Only load prices for cards that need it
      var cardsToLoad = Array.from(cards).filter(function(c){ 
        var priceEl = c.querySelector(".st-hotel-price[data-load-price]");
        console.log("Card", c.getAttribute("data-hotel-id"), "has data-load-price:", priceEl !== null);
        return priceEl !== null; 
      });
      
      console.log("üéØ Cards that need price loading:", cardsToLoad.length);
      
      if(!cardsToLoad.length) { 
        console.log("‚úÖ All prices already loaded from database"); 
        return; 
      }
      
    var p = window.stLastSearchPayload || {};
      
      // Check if we have search parameters
      if(!p.checkin || !p.checkout) {
        console.log("‚ö†Ô∏è No checkin/checkout dates - using fallback dates");
        // Use fallback dates: tomorrow + 7 days
        var tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        var weekLater = new Date(); weekLater.setDate(weekLater.getDate() + 8);
        p.checkin = tomorrow.toISOString().slice(0,10);
        p.checkout = weekLater.toISOString().slice(0,10);
        p.rooms = p.rooms || 1;
        p.adults = p.adults || 2;
        p.children = p.children || 0;
      }
      
      console.log("üîÑ Loading prices for " + cardsToLoad.length + " hotels with dates:", p.checkin, "to", p.checkout);
      
      var loaded = 0;
      var failed = 0;
      
      cardsToLoad.forEach(function(card, index){
        var hid = card.getAttribute("data-hotel-id"); 
        if(!hid) { console.log("Card missing hotel-id"); return; }
        
        var priceEl = card.querySelector(".st-hotel-price");
        if(priceEl) { 
          priceEl.innerHTML = \'<span style="color:#9ca3af;font-size:14px">Prijzen laden...</span>\';
        }
        
      var fd = new FormData();
      fd.append("action","shorttrips_get_availability");
      fd.append("hotelId", hid);
        ["checkin","checkout","rooms","adults","children","child_ages"].forEach(function(k){ 
          if(p[k] !== undefined && p[k] !== "") fd.append(k, String(p[k])); 
        });
        
        // Stagger requests to avoid overwhelming the server
        setTimeout(function() {
          fetch(ajax, {method:"POST", body:fd, credentials:"same-origin", timeout: 10000})
            .then(function(r){ 
              if(!r.ok) throw new Error("HTTP " + r.status);
              return r.json(); 
            })
            .then(function(d){ 
              if(!d || !d.success) {
                console.log("No availability data for hotel " + hid);
                if(priceEl) priceEl.textContent = "Toon prijzen";
                return;
              }
              
              var data=d.data||{};
              loaded++;
              
              // Update price
              if(priceEl && data.best_price_text){ 
                priceEl.innerHTML = \'<span style="color:#1e40af;font-weight:600">Vanaf \' + data.best_price_text + \'</span>\';
                console.log("‚úÖ Hotel " + hid + ": " + data.best_price_text);
              } else if(priceEl) {
                priceEl.textContent = "Toon prijzen";
              }
              
              // Update badges
              if(data.badges_html){ 
                var bw = card.querySelector(".st-hotel-badges"); 
                if(bw){ 
                  bw.innerHTML = data.badges_html; 
                }
              }
              
              // Log progress
              if((loaded + failed) % 10 === 0 || (loaded + failed) === cardsToLoad.length) {
                console.log("üìä Progress: " + loaded + " loaded, " + failed + " failed of " + cardsToLoad.length);
              }
            })
            .catch(function(err){
              failed++;
              console.log("‚ùå Failed to load price for hotel " + hid + ":", err.message);
              if(priceEl) priceEl.textContent = "Toon prijzen";
            });
        }, index * 100); // 100ms stagger between requests
    });
  })();</script>';
    } else {
        echo '<script>console.log("‚ö†Ô∏è Auto price loading is disabled in admin settings");</script>';
    }
    echo '<script>(function(){ if (window.stImgFallback) return; window.stImgFallback = function(img){ var list = (img.getAttribute("data-srcs")||"").split("|").filter(Boolean); var idx = parseInt(img.getAttribute("data-idx")||"0",10); if (isNaN(idx)) idx = 0; idx++; if (idx < list.length){ img.setAttribute("data-idx", String(idx)); img.src = list[idx]; } else { img.onerror = null; img.src = "https://via.placeholder.com/640x384?text=Geen+afbeelding"; } }; })();</script>';

    // Sort dropdown handler
    echo '<script>
    window.stApplySort = function(sortValue) {
      console.log("üîÑ Applying sort:", sortValue);
      var ajax = ' . json_encode(admin_url('admin-ajax.php')) . ';
      var payload = Object.assign({}, window.stLastSearchPayload || {});
      payload.action = "shorttrips_search_hotels";
      payload.sortBy = sortValue;
      payload.page = 1; // Reset to page 1 when sorting
      
      var fd = new FormData();
      Object.keys(payload).forEach(function(k){ 
        if(payload[k] !== undefined && payload[k] !== null){ 
          fd.append(k, payload[k]); 
        } 
      });
      
      var container = document.querySelector("#st-results") || document.querySelector(".st-fullbleed");
      if(!container) { console.error("‚ùå No results container found"); return; }
      
      // Show loading state
      container.style.opacity = "0.5";
      
      fetch(ajax, {method:"POST", body:fd, credentials:"same-origin"})
        .then(function(r){ return r.text(); })
        .then(function(html){ 
          var tmp = document.createElement("div");
          tmp.innerHTML = html;
          var next = tmp.querySelector(".st-fullbleed");
          if(next){ 
            container.parentNode.replaceChild(next, container); 
          } else { 
            container.innerHTML = html; 
          }
          container.style.opacity = "1";
          window.stLastSearchPayload = Object.assign({}, payload);
          window.scrollTo({top:0, behavior:"smooth"});
        })
        .catch(function(err){ 
          console.error("‚ùå Sort failed:", err);
          container.style.opacity = "1";
        });
    };
  </script>';

    // üîß FIX: Hide duplicate sort dropdowns with CSS + JavaScript cleanup
    echo '<style>
    /* Hide ALL sort dropdowns first (prevents flash) */
    .st-sort-select, #st-sort-select { display: none !important; }
    
    /* Then show ONLY the one inside results container */
    .st-fullbleed .st-sort-select,
    .st-fullbleed #st-sort-select,
    .st-results-head .st-sort-select,
    .st-results-head #st-sort-select { 
      display: inline-block !important; 
    }
  </style>';

    echo '<script>
    (function() {
      // More aggressive cleanup - runs multiple times
      var cleanupAttempts = 0;
      var maxAttempts = 5;
      
      function removeDuplicateSortDropdowns() {
        cleanupAttempts++;
        
        // Find all elements that might contain sort dropdowns
        var allSortContainers = document.querySelectorAll("div:has(.st-sort-select), div:has(#st-sort-select), [class*=sort], [id*=sort]");
        var sortSelects = document.querySelectorAll(".st-sort-select, #st-sort-select, select[id*=sort], select[class*=sort]");
        
        console.log("üîç Cleanup attempt " + cleanupAttempts + ": Found " + sortSelects.length + " sort dropdown(s)");
        
        var removed = 0;
        sortSelects.forEach(function(select, idx) {
          var inResults = select.closest(".st-fullbleed") || select.closest(".st-results-head");
          
          if (!inResults) {
            // This dropdown is NOT in our results container - remove it!
            console.log("üóëÔ∏è Removing sort dropdown #" + idx + " (outside results)");
            
            // Try multiple parent levels to ensure complete removal
            var toRemove = select.closest(".st-sort-wrapper") 
                        || select.closest("div[style*=flex]")
                        || select.closest("div")
                        || select.parentElement;
            
            if (toRemove && toRemove !== document.body) {
              toRemove.style.display = "none";
              toRemove.remove();
              removed++;
            }
          } else {
            console.log("‚úÖ Keeping sort dropdown #" + idx + " (inside results)");
          }
        });
        
        if (removed > 0) {
          console.log("‚úÖ Removed " + removed + " duplicate sort dropdown(s)");
        }
        
        // Try again if we found duplicates and haven\'t maxed out attempts
        if (removed > 0 && cleanupAttempts < maxAttempts) {
          setTimeout(removeDuplicateSortDropdowns, 200);
        }
      }
      
      // Run immediately
      removeDuplicateSortDropdowns();
      
      // Run again after DOM fully loaded
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", function() {
          setTimeout(removeDuplicateSortDropdowns, 50);
        });
      }
      
      // Run after window fully loaded
      window.addEventListener("load", function() {
        setTimeout(removeDuplicateSortDropdowns, 100);
      });
      
      // Also run after AJAX updates
      var originalFetch = window.fetch;
      window.fetch = function() {
        return originalFetch.apply(this, arguments).then(function(response) {
          setTimeout(removeDuplicateSortDropdowns, 100);
          return response;
        });
      };
    })();
  </script>';

    // Robust, delegated pager click handler (works across dynamic replacements)
    echo '<script>(function(){ if(!window.__stPagerDelegated){ window.__stPagerDelegated=true; document.addEventListener("click", function(e){ var a = e.target && e.target.closest ? e.target.closest(".st-pager .st-page") : null; if(!a) return; e.preventDefault(); var p = parseInt(a.getAttribute("data-page")||"1",10)||1; if (window.stSetPage) { window.stSetPage(p); } else { try { var ajax = ' . json_encode(admin_url('admin-ajax.php')) . '; var payload = Object.assign({}, window.stLastSearchPayload||{}); payload.action = "shorttrips_search_hotels"; payload.page = p; var fd = new FormData(); Object.keys(payload).forEach(function(k){ if(payload[k]!==undefined && payload[k]!==null){ fd.append(k,payload[k]); } }); var container = document.querySelector("#st-results") || document.querySelector(".st-fullbleed"); fetch(ajax,{method:"POST",body:fd,credentials:"same-origin"}).then(function(r){return r.text();}).then(function(html){ if(!container) return; var tmp=document.createElement("div"); tmp.innerHTML=html; var next=tmp.querySelector(".st-fullbleed"); if(next){ container.parentNode.replaceChild(next,container); } else { container.innerHTML = html; } window.stLastSearchPayload = Object.assign({}, payload); window.scrollTo({top:0,behavior:"smooth"}); }).catch(function(){}); } catch(_){} } }); } })();</script>';

    // Performance logging
    $end_time = microtime(true);
    $execution_time = ($end_time - $start_time) * 1000; // Convert to milliseconds

    if (defined('WP_DEBUG') && WP_DEBUG) {
    }

    wp_die();
}
/**
 * --------------------------------------------------------------------------
 * SHORTTRIPS SEARCH MODULE ‚Äì DEEL 3 / 3
 *  - Prebook detailpagina
 *  - Combineert statische hoteldata (DB + Static API)
 *    met live kamerprijzen (NonStatic API)
 *  Shortcode: [shorttrips_prebook]
 * --------------------------------------------------------------------------
 */
add_shortcode('shorttrips_prebook', function () {
    // Increase memory and execution time for mobile devices
    ini_set('memory_limit', '256M');
    ini_set('max_execution_time', 60);

    // DEBUG DISABLED FOR PERFORMANCE
    // $debug_log_path = defined('WP_CONTENT_DIR') ? WP_CONTENT_DIR . '/debug.log' : dirname(__FILE__) . '/debug.log';
    // // @file_put_contents($debug_log_path, 'üéØüéØüéØ PREBOOK SHORTCODE CALLED AT ' . date('H:i:s') . ' üéØüéØüéØ' . "\n", FILE_APPEND);

    if (empty($_GET['hotelId'])) {
        // @file_put_contents($debug_log_path, '‚ùå PREBOOK: No hotelId provided' . "\n", FILE_APPEND);
        return '<p class="text-center text-red-500 mt-10">‚ùå Geen hotel geselecteerd.</p>';
    }

    $hotelId = intval($_GET['hotelId']);
    $checkin = sanitize_text_field($_GET['checkin'] ?? '');
    $checkout = sanitize_text_field($_GET['checkout'] ?? '');
    $rooms = intval($_GET['rooms'] ?? 1);
    $adults = intval($_GET['adults'] ?? 2);
    $children = intval($_GET['children'] ?? 0);
    $meal = sanitize_text_field($_GET['meal'] ?? '');

    // @file_put_contents($debug_log_path, 'üéØ PREBOOK PARAMS: Hotel=' . $hotelId . ', Checkin=' . $checkin . ', Checkout=' . $checkout . "\n", FILE_APPEND);
    $isMockPrebook = shorttrips_prebook_mock_enabled();
    if ($isMockPrebook) {
        // @file_put_contents($debug_log_path, 'üß™ PREBOOK: Mock mode active - SunHotels API calls zijn gedeactiveerd' . "\n", FILE_APPEND);
    }
    $childAgesStr = sanitize_text_field($_GET['child_ages'] ?? '');
    $childAges = array_values(array_filter(array_map('intval', array_filter(array_map('trim', explode(',', $childAgesStr)))), function ($v) {
        return $v >= 0 && $v <= 17; }));
    if ($children > 0) {
        if (count($childAges) < $children) {
            $childAges = array_pad($childAges, $children, 0);
        } elseif (count($childAges) > $children) {
            $childAges = array_slice($childAges, 0, $children);
        }
    } else {
        $childAges = [];
    }

    $creds = shorttrips_get_api_credentials();

    // ‚ö° FORCE LANGUAGE - API faalt als leeg!
    if (empty($creds['language'])) {
        $creds['language'] = 'en';
    }

    // @file_put_contents($debug_log_path, 'üîë PREBOOK: Got API credentials' . "\n", FILE_APPEND);

    // --- DATABASE FALLBACK (Prioriteit 1) ---
    global $wpdb;
    $hotelInfo = [];
    // @file_put_contents($debug_log_path, 'üìä PREBOOK: Checking database for hotel ' . $hotelId . "\n", FILE_APPEND);
    $dbHotel = $wpdb->get_row($wpdb->prepare(
        "SELECT hotel_id, title, hotelname, address, city, country_name, destination_name,
            destination_id, resort_id,
            image, main_image, banner_image, json_images, images_json, star_rate, description,
            phone, fax, email, latitude, longitude, time_zone,
            review_score, review_count
     FROM ghwk_bravo_hotels 
     WHERE hotel_id = %d",
        $hotelId
    ), ARRAY_A);

    // Fallback: soms wordt een auto-increment ID uit ghwk_room_facilities als hotelId doorgegeven.
    // Probeer die te vertalen naar de echte hotel_id en haal dan opnieuw de hotelgegevens op.
    if (!$dbHotel) {
        $altHotelId = $wpdb->get_var($wpdb->prepare(
            "SELECT hotel_id FROM ghwk_room_facilities WHERE id = %d OR hotel_id = %d LIMIT 1",
            $hotelId,
            $hotelId
        ));
        if ($altHotelId && (int) $altHotelId !== (int) $hotelId) {
            $hotelId = (int) $altHotelId;
            $dbHotel = $wpdb->get_row($wpdb->prepare(
                "SELECT hotel_id, title, hotelname, address, city, country_name, destination_name,
                destination_id, resort_id,
                image, main_image, banner_image, json_images, images_json, star_rate, description,
                phone, fax, email, latitude, longitude, time_zone,
                review_score, review_count
         FROM ghwk_bravo_hotels 
         WHERE hotel_id = %d",
                $hotelId
            ), ARRAY_A);
        }
    }

    if ($dbHotel) {
        // @file_put_contents($debug_log_path, '‚úÖ PREBOOK: Hotel found in database: ' . ($dbHotel['title'] ?? $dbHotel['hotelname'] ?? 'Unknown') . "\n", FILE_APPEND);
        $hotelInfo = [
            'name' => !empty($dbHotel['title']) ? $dbHotel['title'] : ($dbHotel['hotelname'] ?? 'Hotel #' . $hotelId),
            'desc' => $dbHotel['description'] ?? '',
            'image' => $dbHotel['main_image'] ?: ($dbHotel['image'] ?: ($dbHotel['banner_image'] ?? '')),
            'stars' => intval($dbHotel['star_rate'] ?? 0),
            'address' => $dbHotel['address'] ?? '',
            'region' => $dbHotel['destination_name'] ?? '',
            'country' => $dbHotel['country_name'] ?? '',
            'city' => $dbHotel['city'] ?? '',
            'destination_id' => intval($dbHotel['destination_id'] ?? 0),
            'resort_id' => intval($dbHotel['resort_id'] ?? 0),
            'phone' => $dbHotel['phone'] ?? '',
            'email' => $dbHotel['email'] ?? '',
            'lat' => $dbHotel['latitude'] ?? '',
            'lng' => $dbHotel['longitude'] ?? '',
            'rating' => floatval($dbHotel['review_score'] ?? 0),
            'reviews' => intval($dbHotel['review_count'] ?? 0),
        ];
    } else {
        // @file_put_contents($debug_log_path, '‚ö†Ô∏è PREBOOK: Hotel NOT found in database' . "\n", FILE_APPEND);
    }

    // --- STATIC API (Fallback als Database leeg is) ---
    if (empty($hotelInfo)) {
        $allowStaticFallback = isset($_GET['static']) && $_GET['static'] === '1';
        if ($isMockPrebook) {
            $hotelInfo = [
                'name' => 'Mock Hotel #' . $hotelId,
                'desc' => 'Mockdata: lokale fallback omdat live API calls uitstaan.',
                'image' => $dbHotel['main_image'] ?? ($dbHotel['image'] ?? ''),
                'stars' => 4,
                'address' => $dbHotel['address'] ?? 'Mockstraat 1',
                'region' => $dbHotel['destination_name'] ?? '',
                'country' => $dbHotel['country_name'] ?? '',
                'city' => $dbHotel['city'] ?? '',
                'rating' => 8.9,
                'reviews' => 128,
            ];
            // @file_put_contents($debug_log_path, 'üß™ PREBOOK: Using mock hotel fallback data' . "\n", FILE_APPEND);
        } elseif (!$allowStaticFallback) {
            // Skip remote static call to prevent timeouts; instruct to sync first
            return '<div class="max-w-3xl mx-auto text-center mt-10 p-6 bg-yellow-50 border border-yellow-200 rounded-xl">'
                . '  <p class="text-yellow-700 font-medium">‚ö†Ô∏è Dit hotel staat nog niet in de database. Run de static sync en probeer opnieuw.</p>'
                . '  <p class="text-sm text-gray-600 mt-2">Tip: gebruik de Shorttrips Sync in wp-admin of trigger &static=1 om toch de trage API-fallback te proberen.</p>'
                . '</div>';
        } else {
            // @file_put_contents($debug_log_path, 'üì° PREBOOK: Calling GetStaticHotelsAndRooms API (database empty)...' . "\n", FILE_APPEND);
            $endpointStatic = "https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx";
            $soapBody = '<?xml version="1.0" encoding="utf-8"?>
    <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                   xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
      <soap:Body>
        <GetStaticHotelsAndRooms xmlns="http://xml.sunhotels.net/15/">
          <userName>' . esc_html($creds['username']) . '</userName>
          <password>' . esc_html($creds['password']) . '</password>
          <language>' . esc_html($creds['language']) . '</language>
          <hotelIds>' . intval($hotelId) . '</hotelIds>
          <showCoordinates>true</showCoordinates>
          <showRoomTypeName>true</showRoomTypeName>
          <showReviews>true</showReviews>
        </GetStaticHotelsAndRooms>
      </soap:Body>
    </soap:Envelope>';

            $resp1 = wp_remote_post($endpointStatic, [
                'headers' => [
                    'Content-Type' => 'text/xml; charset=utf-8',
                    'SOAPAction' => '"http://xml.sunhotels.net/15/GetStaticHotelsAndRooms"'
                ],
                'body' => $soapBody,
                'timeout' => 15,
            ]);

            if (!is_wp_error($resp1) && !empty($resp1['body'])) {
                $xml = @simplexml_load_string($resp1['body']);
                if ($xml) {
                    $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    $h = $xml->xpath('//soap:Body//sh:getStaticHotelsAndRoomsResult//sh:hotels//sh:hotel');
                    if ($h && isset($h[0])) {
                        $n = $h[0];
                        $hotelInfo = [
                            'name' => (string) $n->hotelname,
                            'desc' => (string) $n->description,
                            'image' => (string) $n->main_image,
                            'stars' => (int) $n->category,
                            'address' => (string) $n->address,
                            'region' => (string) $n->resort,
                            'country' => (string) $n->country,
                        ];
                    }
                }
            }
        }

    }

    // Final check - als beide bronnen leeg zijn
    if (empty($hotelInfo)) {
        return '<div class="max-w-3xl mx-auto text-center mt-10 p-6 bg-yellow-50 border border-yellow-200 rounded-xl">\n'
            . '  <p class="text-yellow-700 font-medium">\n'
            . '  ‚ö†Ô∏è Geen hotelinformatie gevonden voor hotel-ID ' . esc_html($hotelId) . '.<br>\n'
            . '  Het hotel is mogelijk niet beschikbaar of nog niet gesynchroniseerd. Probeer het later opnieuw.\n'
            . '  </p>\n'
            . '  <p class="text-sm text-gray-600 mt-2">üí° Tip: Start de sync functie om dit hotel toe te voegen aan de database.</p>\n'
            . '</div>';
    }

    // Zet concurrentie prijsvergelijking in de queue (future use)
    if (function_exists('freestays_competitor_queue_request')) {
        freestays_competitor_queue_request($hotelId, $checkin, $checkout, $rooms, $adults, $children, $meal);
    }

    // Room type names come directly from SearchV3 API (no database lookup needed)
    $roomTypeNames = [];

    $roomsAvail = [];
    $forceLocalRooms = isset($_GET['localRooms']) && $_GET['localRooms'] === '1';
    $parseRoomNotes = static function ($roomNode) {
        $notes = [];
        if (!$roomNode || empty($roomNode->notes->note)) {
            return $notes;
        }
        foreach ($roomNode->notes->note as $note) {
            $text = trim((string) ($note->text ?? $note));
            if ($text === '') {
                continue;
            }
            $start = isset($note['start_date']) ? trim((string) $note['start_date']) : '';
            $end = isset($note['end_date']) ? trim((string) $note['end_date']) : '';
            $startDisplay = '';
            $endDisplay = '';
            if ($start !== '') {
                $ts = strtotime($start);
                if ($ts) {
                    $startDisplay = date_i18n('d-m-Y', $ts);
                }
            }
            if ($end !== '') {
                $ts = strtotime($end);
                if ($ts) {
                    $endDisplay = date_i18n('d-m-Y', $ts);
                }
            }
            $range = '';
            if ($startDisplay && $endDisplay) {
                $range = $startDisplay . ' ‚Äì ' . $endDisplay;
            } elseif ($startDisplay) {
                $range = $startDisplay;
            } elseif ($endDisplay) {
                $range = $endDisplay;
            }
            $notes[] = $range ? ($text . ' (' . $range . ')') : $text;
        }
        return array_values(array_unique($notes));
    };

    if ($isMockPrebook) {
        $roomsAvail = shorttrips_prebook_mock_rooms([
            'hotel_id' => $hotelId,
            'checkin' => $checkin,
            'checkout' => $checkout,
            'rooms' => $rooms,
            'adults' => $adults,
            'children' => $children,
        ]);
        // @file_put_contents($debug_log_path, 'üß™ PREBOOK: Loaded ' . count($roomsAvail) . ' mock rooms' . "\n", FILE_APPEND);
    } elseif ($forceLocalRooms) {
        $roomsAvail = shorttrips_prebook_local_room_fallback($hotelId);
    } else {

        /* COMMENTED OUT - PreBookV3 not needed for room availability listing
        // @file_put_contents($debug_log_path, 'üì° PREBOOK: Preparing PreBookV3 API call...' . "\n", FILE_APPEND);
        $endpointPrebook = "https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx";

        // @file_put_contents($debug_log_path, 'üîß PREBOOK: Building SOAP request...' . "\n", FILE_APPEND);

        // Build PreBookV3 SOAP request for room type names
        $prebookSoap = '<?xml version="1.0" encoding="utf-8"?>'
          . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
          . '<soap:Body>'
          . '<PreBookV3 xmlns="http://xml.sunhotels.net/15/">'
          . '<userName>'.esc_html($creds['username']).'</userName>'
          . '<password>'.esc_html($creds['password']).'</password>'
          . '<currency>'.esc_html($creds['currency']).'</currency>'
          . '<language>'.esc_html($creds['language']).'</language>'
          . '<checkInDate>'.esc_html($checkin.'T12:00:00').'</checkInDate>'
          . '<checkOutDate>'.esc_html($checkout.'T12:00:00').'</checkOutDate>'
          . '<rooms>'.intval($rooms).'</rooms>'
          . '<adults>'.intval($adults).'</adults>'
          . '<children>'.intval($children).'</children>'
          . (!empty($childAges) ? '<childrenAges>'.esc_html(implode(',', $childAges)).'</childrenAges>' : '<childrenAges></childrenAges>')
          . '<infant>0</infant>'
          . '<mealId>0</mealId>'
          . '<customerCountry>NL</customerCountry>'
          . '<b2c>true</b2c>'
          . '<hotelId>'.intval($hotelId).'</hotelId>'
          . '<showPriceBreakdown>true</showPriceBreakdown>'
          . '</PreBookV3>'
          . '</soap:Body>'
          . '</soap:Envelope>';

        // @file_put_contents($debug_log_path, '‚úÖ PREBOOK: SOAP request built successfully' . "\n", FILE_APPEND);
        // @file_put_contents($debug_log_path, 'üöÄ PREBOOK: Calling PreBookV3 API for hotel ' . $hotelId . "\n", FILE_APPEND);

        $prebookResp = wp_remote_post($endpointPrebook, [
          'headers' => [
            'Content-Type' => 'text/xml; charset=utf-8',
            'SOAPAction' => '"http://xml.sunhotels.net/15/PreBookV3"'
          ],
          'body' => $prebookSoap,
          'timeout' => 60
        ]);

        // @file_put_contents($debug_log_path, 'üì• PREBOOK: PreBookV3 response received' . "\n", FILE_APPEND);

        if (!is_wp_error($prebookResp) && !empty($prebookResp['body'])) {
          // @file_put_contents($debug_log_path, '‚úÖ PREBOOK: PreBookV3 response OK, body length: ' . strlen($prebookResp['body']) . "\n", FILE_APPEND);
          // @file_put_contents($debug_log_path, 'üìÑ PREBOOK: PreBookV3 response content: ' . substr($prebookResp['body'], 0, 1000) . "\n", FILE_APPEND);

          if ($prebookXml) {
            $prebookXml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
            $prebookXml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

            // Try multiple XPath patterns to find room data
            $xpathPatterns = [
              '//soap:Body//sh:PreBookV3Result//sh:rooms//sh:room',
              '//soap:Body//PreBookV3Result//rooms//room',
              '//PreBookV3Result//rooms//room',
              '//rooms//room',
              '//room'
            ];

            $roomNodes = [];
            foreach ($xpathPatterns as $pattern) {
              $nodes = $prebookXml->xpath($pattern);
              if ($nodes && count($nodes) > 0) {
                $roomNodes = $nodes;
                // @file_put_contents($debug_log_path, '‚úÖ PREBOOK: PreBookV3 found ' . count($nodes) . ' rooms with pattern: ' . $pattern . "\n", FILE_APPEND);break;
              }
            }

            if (empty($roomNodes)) {
              // @file_put_contents($debug_log_path, '‚ùå PREBOOK: PreBookV3 NO ROOMS FOUND in response!' . "\n", FILE_APPEND);
            }

            if ($roomNodes) {
              foreach ($roomNodes as $room) {
                // Try multiple field names for room type ID and name
                $roomTypeId = (string)($room->roomTypeId ?? $room->roomtypeId ?? $room->id ?? $room->Id ?? '');
                $roomTypeName = (string)($room->roomTypeName ?? $room->roomtypeName ?? $room->name ?? $room->Name ?? $room->description ?? '');if ($roomTypeId && $roomTypeName) {
                  $roomTypeNames[$roomTypeId] = $roomTypeName;
                } elseif ($roomTypeName) {
                  // If no ID but we have a name, use a generated key
                  $roomTypeNames['room_' . count($roomTypeNames)] = $roomTypeName;
                }
              }
            } else {}

            // @file_put_contents($debug_log_path, 'üìä PREBOOK: PreBookV3 extracted ' . count($roomTypeNames) . ' room type names' . "\n", FILE_APPEND);} else {
            // @file_put_contents($debug_log_path, '‚ùå PREBOOK: PreBookV3 Failed to parse XML response' . "\n", FILE_APPEND);}
        } else {
          if (is_wp_error($prebookResp)) {
            // @file_put_contents($debug_log_path, '‚ùå PREBOOK: PreBookV3 WP Error: ' . $prebookResp->get_error_message() . "\n", FILE_APPEND);} else {
            // @file_put_contents($debug_log_path, '‚ùå PREBOOK: PreBookV3 Empty response body' . "\n", FILE_APPEND);}
        }
        */ // END COMMENTED OUT PreBookV3 section

        // Prepare parameters for SearchV3 API call
        $endpointAvail = "https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx/GetAvailableHotelV2";
        $paramsAvail = [
            'userName' => $creds['username'],
            'password' => $creds['password'],
            'language' => $creds['language'],
            'currencies' => $creds['currency'],
            'hotelID' => $hotelId,
            'checkInDate' => $checkin,
            'checkOutDate' => $checkout,
            'numberOfRooms' => $rooms,
            'numberOfAdults' => $adults,
            'numberOfChildren' => $children,
            'b2c' => 'false',
            'showRoomTypeName' => 'true',
            'showBoardBasis' => 'true',
            'showReviews' => 'true',
            'blockSuperDeal' => 'true',
            'deals' => '0'      // Explicitly disable deals
        ];
        if (!empty($childAges)) {
            $paramsAvail['childrenAges'] = implode(',', $childAges);
        }
        $postData = http_build_query($paramsAvail);

        // Skip GetAvailableHotelV2 - API method doesn't exist, use SearchV3 instead
        $resp2 = new WP_Error('skipped', 'GetAvailableHotelV2 method not valid');
        $roomsAvail = []; // Empty - will trigger SearchV3 fallback

        // Legacy GetAvailableHotelV2 response handling intentionally disabled.
        if (apply_filters('shorttrips_enable_getavailablehotel_debug', false)) {
            do_action('shorttrips_handle_getavailablehotel_response', $resp2, $debug_log_path);
        }


        // Use SearchV3 API to get available rooms
        if (empty($roomsAvail)) {
            // ‚ö° API CACHING - Cache SearchV3 results for 30 minutes
            $cache_key = 'prebook_searchv3_' . md5($hotelId . '_' . $checkin . '_' . $checkout . '_' . $rooms . '_' . $adults . '_' . $children . '_' . implode(',', $childAges));
            $cached_rooms = get_transient($cache_key);

            if ($cached_rooms !== false && is_array($cached_rooms)) {
                // Cache hit! Use cached data
                $roomsAvail = $cached_rooms;
            } else {
                // Cache miss - call API
                $endpointAlt = "https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx/SearchV3";
                // Keep remote calls short to prevent page timeouts (default 12s, clamp 8‚Äì45)
                $apiTimeout = isset($_GET['timeout']) ? intval($_GET['timeout']) : 12;
                $apiTimeout = max(8, min($apiTimeout, 45));
                $paramsAlt = [
                    'userName' => $creds['username'],
                    'password' => $creds['password'],
                    'language' => !empty($creds['language']) ? $creds['language'] : 'en',
                    'currencies' => $creds['currency'],
                    'checkInDate' => $checkin,
                    'checkOutDate' => $checkout,
                    'numberOfRooms' => $rooms,
                    'hotelIDs' => $hotelId,
                    'numberOfAdults' => $adults,
                    'numberOfChildren' => $children,
                    'showRoomTypeName' => 'true',
                    'showReviews' => 'true',
                    'b2c' => 'false',
                    'blockSuperDeal' => 'true',
                    'deals' => '0'      // Explicitly disable deals
                ];
                if (!empty($childAges)) {
                    $paramsAlt['childrenAges'] = implode(',', $childAges);
                }

                $respAlt = wp_remote_post($endpointAlt, [
                    'headers' => ['Content-Type' => 'application/x-www-form-urlencoded'],
                    'body' => http_build_query($paramsAlt),
                    'timeout' => $apiTimeout,
                ]);

                if (is_wp_error($respAlt)) {
                    // Avoid hammering API on repeated failures: cache empty for 5 minutes
                    set_transient($cache_key, [], 5 * MINUTE_IN_SECONDS);
                    // @file_put_contents($debug_log_path, '‚ùå PREBOOK: SearchV3 API error: ' . $respAlt->get_error_message() . "\n", FILE_APPEND);
                }

                if (!is_wp_error($respAlt) && !empty($respAlt['body'])) {
                    $x = @simplexml_load_string($respAlt['body']);

                    if (!$x) {
                        // @file_put_contents($debug_log_path, '‚ùå PREBOOK: SearchV3 XML parsing failed' . "\n", FILE_APPEND);
                    }

                    if ($x && !empty($x->hotels->hotel)) {
                        foreach ($x->hotels->hotel as $hNode) {
                            $hidNode = (int) ($hNode->{'hotel.id'} ?? 0);
                            if ($hidNode > 0 && $hidNode != $hotelId)
                                continue; // beperk tot gekozen hotel
                            if (!empty($hNode->roomtypes->roomtype)) {
                                $roomTypeCount = count($hNode->roomtypes->roomtype);
                                // @file_put_contents($debug_log_path, '‚úÖ PREBOOK: Found ' . $roomTypeCount . ' available room types' . "\n", FILE_APPEND);

                                foreach ($hNode->roomtypes->roomtype as $rt) {
                                    // Get room type name (SearchV3 uses 'roomtype.Name' with capital N)
                                    $rtName = (string) ($rt->{'roomtype.Name'} ?? '');

                                    // Fallback to other possible field names if needed
                                    if (empty($rtName)) {
                                        $rtName = (string) ($rt->name ?? $rt->{'roomtype.name'} ?? $rt->roomTypeName ?? '');
                                    }

                                    // Final fallback
                                    if (empty($rtName)) {
                                        $rtName = 'Room';
                                        // @file_put_contents($debug_log_path, '‚ö†Ô∏è PREBOOK: Room name empty for hotel ' . $hotelId . ', using fallback' . "\n", FILE_APPEND);
                                    }

                                    // Get room type ID (SearchV3 uses 'roomtype.ID' with capital letters)
                                    $rtId = (string) ($rt->{'roomtype.ID'} ?? $rt->id ?? $rt->roomTypeId ?? '');

                                    if (!empty($rt->rooms->room)) {
                                        foreach ($rt->rooms->room as $room) {
                                            $desc = (string) ($room->description ?? '');
                                            $roomIdVal = isset($room->id) ? intval($room->id) : null;
                                            $roomNotesList = $parseRoomNotes($room);
                                            // Meals met prijzen
                                            if (!empty($room->meals->meal)) {
                                                foreach ($room->meals->meal as $meal) {
                                                    // Get meal ID and lookup name in database
                                                    $mealId = isset($meal->id) ? intval((string) $meal->id) : 0;
                                                    $mealName = '';

                                                    if ($mealId > 0) {
                                                        $mealFromDb = $wpdb->get_var($wpdb->prepare(
                                                            "SELECT name FROM ghwk_meals WHERE id = %d",
                                                            $mealId
                                                        ));
                                                        if ($mealFromDb) {
                                                            $mealName = $mealFromDb;
                                                        }
                                                    }

                                                    // Fallback to checking if meal has name attribute (old API format)
                                                    if (empty($mealName)) {
                                                        $mealName = (string) ($meal->name ?? '');
                                                    }

                                                    $priceVal = 0.0;
                                                    // zoek eerste prijs
                                                    if (!empty($meal->prices->price)) {
                                                        $priceVal = (float) $meal->prices->price;
                                                    } elseif (isset($meal->price)) {
                                                        $priceVal = (float) $meal->price;
                                                    }
                                                    // Heuristiek: Sunhotels geeft soms cents ‚Üí deel door 100 als heel groot
                                                    if ($priceVal > 10000) {
                                                        $priceVal = $priceVal / 100.0;
                                                    }

                                                    // Policies
                                                    $hasFree = false;
                                                    $hasPartial = false;
                                                    $policyText = '';
                                                    $cutoffDisplay = '';
                                                    if (!empty($room->cancellation_policies->cancellation_policy)) {
                                                        $maxPartialHours = null;
                                                        foreach ($room->cancellation_policies->cancellation_policy as $cp) {
                                                            $pct = isset($cp->percentage) ? (float) $cp->percentage : null;
                                                            $deadlineH = isset($cp->deadline) ? (int) $cp->deadline : null;
                                                            if ($pct === 0.0) {
                                                                $hasFree = true;
                                                            }
                                                            if ($pct !== null && $pct > 0.0 && $pct < 100.0) {
                                                                if ($deadlineH !== null) {
                                                                    $maxPartialHours = max($maxPartialHours ?? 0, $deadlineH);
                                                                } else {
                                                                    $hasPartial = true;
                                                                }
                                                            }
                                                        }
                                                        if (!$hasFree && $maxPartialHours !== null) {
                                                            $hasPartial = true;
                                                            $bufferHours = $maxPartialHours + (21 * 24);
                                                            try {
                                                                $tzName = !empty($dbHotel['time_zone']) ? $dbHotel['time_zone'] : 'UTC';
                                                                $tz = new DateTimeZone($tzName);
                                                                $ci = new DateTime($checkin . ' 12:00:00', $tz);
                                                                $ci->modify('-' . $bufferHours . ' hours');
                                                                $cutoffDisplay = $ci->format('d-m-Y H:i');
                                                            } catch (Exception $e) {
                                                                $cutoffDisplay = '';
                                                            }
                                                        }
                                                    }
                                                    if ($hasFree) {
                                                        $policyText = 'Gratis annuleren';
                                                    } elseif ($hasPartial) {
                                                        $policyText = $cutoffDisplay !== '' ? ('Gedeeltelijk restitueerbaar tot ' . $cutoffDisplay) : 'Gedeeltelijk restitueerbaar';
                                                    }

                                                    $beds = isset($room->beds) ? (int) $room->beds : null;
                                                    $extrabeds = isset($room->extrabeds) ? (int) $room->extrabeds : null;
                                                    $sharedRoom = (isset($room->sharedRoom) && ((string) $room->sharedRoom) === 'true') ? 1 : 0;
                                                    $sharedFacilities = (isset($room->sharedFacilities) && ((string) $room->sharedFacilities) === 'true') ? 1 : 0;
                                                    $superDeal = (isset($room->isSuperDeal) && ((string) $room->isSuperDeal) === 'true');
                                                    $bestBuy = (isset($room->isBestBuy) && ((string) $room->isBestBuy) === 'true');

                                                    // Amenities nodes (flexibel)
                                                    $amenList = [];
                                                    if (!empty($room->amenities->amenity)) {
                                                        foreach ($room->amenities->amenity as $am) {
                                                            $txt = trim((string) $am);
                                                            if ($txt !== '') {
                                                                $amenList[] = $txt;
                                                            }
                                                        }
                                                    }
                                                    if (!empty($room->roomFacilities->roomFacility)) {
                                                        foreach ($room->roomFacilities->roomFacility as $am) {
                                                            $txt = trim((string) $am);
                                                            if ($txt !== '') {
                                                                $amenList[] = $txt;
                                                            }
                                                        }
                                                    }
                                                    if (!empty($room->facilities->facility)) {
                                                        foreach ($room->facilities->facility as $am) {
                                                            $txt = trim((string) $am);
                                                            if ($txt !== '') {
                                                                $amenList[] = $txt;
                                                            }
                                                        }
                                                    }

                                                    $roomsAvail[] = [
                                                        'type' => $rtName,
                                                        'room_type_id' => $rtId ? intval($rtId) : null,
                                                        'meal' => $mealName,
                                                        'price' => $priceVal,
                                                        'desc' => $desc,
                                                        'policy' => $policyText,
                                                        'beds' => $beds,
                                                        'extrabeds' => $extrabeds,
                                                        'shared_room' => $sharedRoom,
                                                        'shared_facilities' => $sharedFacilities,
                                                        'superdeal' => $superDeal,
                                                        'bestbuy' => $bestBuy,
                                                        'amen' => $amenList,
                                                        'room_id' => $roomIdVal,
                                                        'room_notes' => $roomNotesList,
                                                    ];
                                                }
                                            } else {
                                                // Geen meals ‚Üí toon room alleen
                                                $amenList = [];
                                                if (!empty($room->amenities->amenity)) {
                                                    foreach ($room->amenities->amenity as $am) {
                                                        $txt = trim((string) $am);
                                                        if ($txt !== '') {
                                                            $amenList[] = $txt;
                                                        }
                                                    }
                                                }
                                                if (!empty($room->roomFacilities->roomFacility)) {
                                                    foreach ($room->roomFacilities->roomFacility as $am) {
                                                        $txt = trim((string) $am);
                                                        if ($txt !== '') {
                                                            $amenList[] = $txt;
                                                        }
                                                    }
                                                }
                                                if (!empty($room->facilities->facility)) {
                                                    foreach ($room->facilities->facility as $am) {
                                                        $txt = trim((string) $am);
                                                        if ($txt !== '') {
                                                            $amenList[] = $txt;
                                                        }
                                                    }
                                                }

                                                $roomsAvail[] = [
                                                    'type' => $rtName,
                                                    'room_type_id' => $rtId ? intval($rtId) : null,
                                                    'meal' => '',
                                                    'price' => 0,
                                                    'desc' => $desc,
                                                    'policy' => '',
                                                    'beds' => isset($room->beds) ? (int) $room->beds : null,
                                                    'extrabeds' => isset($room->extrabeds) ? (int) $room->extrabeds : null,
                                                    'shared_room' => (isset($room->sharedRoom) && ((string) $room->sharedRoom) === 'true') ? 1 : 0,
                                                    'shared_facilities' => (isset($room->sharedFacilities) && ((string) $room->sharedFacilities) === 'true') ? 1 : 0,
                                                    'superdeal' => (isset($room->isSuperDeal) && ((string) $room->isSuperDeal) === 'true'),
                                                    'bestbuy' => (isset($room->isBestBuy) && ((string) $room->isBestBuy) === 'true'),
                                                    'amen' => $amenList,
                                                    'room_id' => $roomIdVal,
                                                    'room_notes' => $roomNotesList,
                                                ];
                                            }
                                        }
                                    }
                                }
                            }
                            // Alleen eerste hotel nodig
                            break;
                        }
                    }

                    // ‚ö° CACHE DE RESULTATEN (30 minuten)
                    if (!empty($roomsAvail)) {
                        set_transient($cache_key, $roomsAvail, 1800);
                    } else {
                        // Cache empty result kort om herhaalde timeouts te voorkomen
                        set_transient($cache_key, [], 5 * MINUTE_IN_SECONDS);
                    }
                }
            } // End cache miss
        }
    }

    // --- Apply filters on prebook rooms (when filter widget used on detail page) ---
    $getIds = function ($key) {
        if (!isset($_GET[$key]))
            return [];
        $v = $_GET[$key];
        if (is_array($v))
            return array_values(array_filter(array_map('intval', $v)));
        $csv = trim((string) $v);
        if ($csv === '')
            return [];
        return array_values(array_filter(array_map('intval', array_filter(array_map('trim', explode(',', $csv))))));
    };
    $selMealIds = $getIds('mealIds');
    $selFeatureIds = $getIds('featureIds'); // ignored at room-level
    $selThemeIds = $getIds('themeIds');     // ignored at room-level
    $excludeSharedRooms = isset($_GET['excludeSharedRooms']) && $_GET['excludeSharedRooms'] == '1';
    $excludeSharedFacilities = isset($_GET['excludeSharedFacilities']) && $_GET['excludeSharedFacilities'] == '1';

    if (empty($roomsAvail)) {
        $roomsAvail = shorttrips_prebook_local_room_fallback($hotelId);
    }

    if (!empty($roomsAvail)) {
        // Filter shared flags
        if ($excludeSharedRooms) {
            $roomsAvail = array_values(array_filter($roomsAvail, function ($r) {
                return empty($r['shared_room']); }));
        }
        if ($excludeSharedFacilities) {
            $roomsAvail = array_values(array_filter($roomsAvail, function ($r) {
                return empty($r['shared_facilities']); }));
        }
        // Filter meals by IDs using cached lookup names
        if (!empty($selMealIds)) {
            $mealsOpt = shorttrips_get_meal_options();
            $wantedNames = [];
            if (is_array($mealsOpt)) {
                foreach ($selMealIds as $mid) {
                    if (isset($mealsOpt[$mid])) {
                        $wantedNames[] = strtolower((string) $mealsOpt[$mid]);
                    }
                }
            }
            if (!empty($wantedNames)) {
                $roomsAvail = array_values(array_filter($roomsAvail, function ($r) use ($wantedNames) {
                    $rm = strtolower((string) ($r['meal'] ?? ''));
                    foreach ($wantedNames as $n) {
                        if ($n !== '' && strpos($rm, $n) !== false)
                            return true;
                    }
                    return false;
                }));
            }
        }
    }
    // Roomtype images mapping (from DB if available)
    $roomImagesByName = [];
    $roomImagesById = [];
    try {
        $rtTable = 'ghwk_hotel_room_types';
        if (!$wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $rtTable))) {
            $rtTable = $wpdb->prefix . 'hotel_room_types';
        }
        if ($wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $rtTable))) {
            // Try with name + images_json columns if present
            $cols = $wpdb->get_col("SHOW COLUMNS FROM {$rtTable}");
            $hasName = in_array('name', $cols, true);
            $hasRoomTypeId = in_array('room_type_id', $cols, true);
            $hasImages = in_array('images_json', $cols, true);
            $hasHotel = in_array('hotel_id', $cols, true);
            if ($hasImages && $hasHotel) {
                $selectParts = [];
                if ($hasName) {
                    $selectParts[] = 'name';
                }
                if ($hasRoomTypeId) {
                    $selectParts[] = 'room_type_id';
                }
                $selectParts[] = 'images_json';
                $select = implode(', ', $selectParts);
                $rows = $wpdb->get_results($wpdb->prepare("SELECT {$select} FROM {$rtTable} WHERE hotel_id = %d", $hotelId), ARRAY_A);

                // @file_put_contents($debug_log_path, "üìö ROOM IMAGES DB: Loaded " . count($rows) . " room types for hotel $hotelId\n", FILE_APPEND);

                if ($rows) {
                    foreach ($rows as $row) {
                        $imgs = [];
                        if (!empty($row['images_json'])) {
                            $ij = json_decode($row['images_json'], true);
                            if (is_array($ij)) {
                                foreach ($ij as $u) {
                                    if (is_string($u) && $u !== '')
                                        $imgs[] = $u;
                                }
                            }
                        }
                        if (!empty($imgs)) {
                            $key = $hasName && !empty($row['name']) ? strtolower(trim((string) $row['name'])) : '';
                            if ($key !== '') {
                                $roomImagesByName[$key] = $imgs;
                                // @file_put_contents($debug_log_path, "  üìå By name: '$key' = " . count($imgs) . " images\n", FILE_APPEND);
                            }
                            if ($hasRoomTypeId && !empty($row['room_type_id'])) {
                                $roomImagesById[intval($row['room_type_id'])] = $imgs;
                                // @file_put_contents($debug_log_path, "  üìå By ID: " . intval($row['room_type_id']) . " = " . count($imgs) . " images\n", FILE_APPEND);
                            }
                        }
                    }
                }
            }
        }
    } catch (Exception $e) {
        // @file_put_contents($debug_log_path, "‚ùå ROOM IMAGES DB ERROR: " . $e->getMessage() . "\n", FILE_APPEND);
    }
    ob_start(); ?>

    <?php if ($isMockPrebook): ?>
        <div class="st-mock-banner"
            style="margin:16px auto;max-width:960px;background:#fef3c7;border:1px solid #fcd34d;border-radius:12px;padding:12px 16px;display:flex;gap:12px;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
            <span style="font-size:24px;">üß™</span>
            <div style="color:#92400e;font-size:14px;line-height:1.4;"><strong style="display:block;font-size:15px;">Testmodus
                    actief</strong>Dit is een dummy flow met mockdata; er worden geen SunHotels API-calls verstuurd.</div>
        </div>
    <?php endif; ?>

    <!-- üìÖ QUICK DATE SELECTOR - Boven kamerlijst -->
    <div class="max-w-5xl mx-auto bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 mt-6 mb-2"
        style="box-shadow:0 2px 8px rgba(0,0,0,0.08);">
        <form method="GET" action="<?php echo esc_url(get_permalink()); ?>" id="st-date-quick-change"
            style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;align-items:end;">
            <!-- Preserve hotel ID (correct parameter name: hotelId) -->
            <input type="hidden" name="hotelId" value="<?php echo esc_attr($hotelId); ?>">

            <input type="hidden" name="child_ages" id="st-prebook-child-ages"
                value="<?php echo esc_attr($childAgesStr); ?>">

            <!-- Check-in Date -->
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;">üìÖ Check
                    in</label>
                <input type="date" name="checkin" value="<?php echo esc_attr($checkin); ?>"
                    style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:white;"
                    required>
            </div>

            <!-- Check-out Date -->
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;">üìÖ Check
                    out</label>
                <input type="date" name="checkout" value="<?php echo esc_attr($checkout); ?>"
                    style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:white;"
                    required>
            </div>

            <!-- Rooms -->
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;">üö™
                    Rooms</label>
                <input type="number" name="rooms" value="<?php echo esc_attr($rooms); ?>" min="1" max="10"
                    style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:white;">
            </div>

            <!-- Adults -->
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;">üë•
                    Adults</label>
                <input type="number" name="adults" value="<?php echo esc_attr($adults); ?>" min="1" max="20"
                    style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:white;">
            </div>

            <!-- Children -->
            <div>
                <label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;">üë∂
                    Children</label>
                <input type="number" name="children" id="st-prebook-children" value="<?php echo esc_attr($children); ?>"
                    min="0" max="10"
                    style="width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:white;">
            </div>

            <!-- Child ages -->
            <div id="st-prebook-age-wrapper" style="grid-column:1 / -1;display:none;">
                <label style="display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;">üéØ Leeftijd
                    kinderen</label>
                <div id="st-prebook-age-inputs"
                    style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;"></div>
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit"
                    style="width:100%;background:linear-gradient(135deg, #2563eb 0%, #1e40af 100%);color:white;border:none;padding:8px 16px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(37,99,235,0.3);"
                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(37,99,235,0.4)';"
                    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(37,99,235,0.3)';">
                    üîç Update Prices
                </button>
            </div>
        </form>
    </div>

    <script>
        (function () {
            var form = document.getElementById('st-date-quick-change');
            if (!form) return;
            var childField = document.getElementById('st-prebook-children');
            var ageWrapper = document.getElementById('st-prebook-age-wrapper');
            var ageContainer = document.getElementById('st-prebook-age-inputs');
            var hiddenField = document.getElementById('st-prebook-child-ages');
            if (!childField || !ageWrapper || !ageContainer || !hiddenField) return;

            function getSelectedAges() {
                return (hiddenField.value || '').split(',').map(function (v) {
                    var n = parseInt(v, 10);
                    return isNaN(n) ? 0 : Math.max(0, Math.min(n, 17));
                });
            }

            function syncHidden() {
                var values = Array.from(ageContainer.querySelectorAll('select')).map(function (sel) {
                    var n = parseInt(sel.value, 10);
                    return isNaN(n) ? 0 : n;
                });
                hiddenField.value = values.join(',');
            }

            function renderAges() {
                var count = Math.max(0, Math.min(parseInt(childField.value || '0', 10) || 0, 8));
                var prefills = getSelectedAges();
                ageContainer.innerHTML = '';
                if (count <= 0) {
                    ageWrapper.style.display = 'none';
                    hiddenField.value = '';
                    return;
                }
                ageWrapper.style.display = 'block';
                for (var i = 0; i < count; i++) {
                    var wrap = document.createElement('div');
                    wrap.style.display = 'flex';
                    wrap.style.flexDirection = 'column';
                    wrap.style.gap = '4px';

                    var label = document.createElement('label');
                    label.textContent = 'Leeftijd kind ' + (i + 1);
                    label.style.fontSize = '12px';
                    label.style.color = '#374151';
                    label.style.fontWeight = '600';

                    var select = document.createElement('select');
                    select.style.border = '1px solid #d1d5db';
                    select.style.borderRadius = '8px';
                    select.style.padding = '6px 10px';
                    select.style.fontSize = '14px';
                    for (var age = 0; age <= 17; age++) {
                        var option = document.createElement('option');
                        option.value = age;
                        option.textContent = age;
                        if (prefills[i] !== undefined && prefills[i] === age) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    }
                    select.addEventListener('change', syncHidden);
                    wrap.appendChild(label);
                    wrap.appendChild(select);
                    ageContainer.appendChild(wrap);
                }
                syncHidden();
            }

            childField.addEventListener('input', renderAges);
            renderAges();
        })();
    </script>

    <?php if (shorttrips_show_transfers_widget()):
        $transferResortId = intval($dbHotel['resort_id'] ?? ($dbHotel['destination_id'] ?? 0));
        $transferPassengers = max(1, intval($adults) + intval($children));
        $transferAjaxUrl = admin_url('admin-ajax.php');
        $arrivalDefaultTime = '12:00';
        $returnDefaultTime = '10:00';
        ?>
        <div id="st-transfer-widget" class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6 mt-4 border border-slate-100"
            data-hotel="<?= esc_attr($hotelId); ?>" data-resort="<?= esc_attr($transferResortId); ?>"
            data-ajax="<?= esc_url($transferAjaxUrl); ?>">
            <div class="flex flex-col gap-4">
                <div>
                    <h2 class="text-xl font-semibold mb-1">üöê Transfers &amp; vervoer</h2>
                    <p class="text-sm text-gray-600">Bekijk beschikbare luchthaven-transfers op basis van uw gekozen data.
                        Resultaten komen live uit de Sunhotels API.</p>
                </div>
                <form class="st-transfer-form grid gap-3 md:grid-cols-5">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Aankomstdatum</label>
                        <input type="date" name="arrivalDate" value="<?= esc_attr($checkin); ?>"
                            class="w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Aankomsttijd</label>
                        <input type="time" name="arrivalTime" value="<?= esc_attr($arrivalDefaultTime); ?>"
                            class="w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Retourdatum</label>
                        <input type="date" name="returnDepartureDate" value="<?= esc_attr($checkout ?: $checkin); ?>"
                            class="w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Retourtijd</label>
                        <input type="time" name="returnDepartureTime" value="<?= esc_attr($returnDefaultTime); ?>"
                            class="w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Reizigers</label>
                        <input type="number" name="passengers" min="1" max="99" value="<?= esc_attr($transferPassengers); ?>"
                            class="w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div class="md:col-span-5 flex flex-wrap gap-3 mt-1">
                        <button type="submit" data-transfer-submit class="button button-primary">Find transfers</button>
                        <span class="text-xs text-gray-500 self-center">Prijzen worden realtime opgehaald.</span>
                    </div>
                </form>
                <div class="text-sm text-gray-500 st-transfer-status" data-state="idle">Transfers worden nog niet geladen.</div>
            </div>
            <div class="st-transfer-results mt-4 space-y-3" aria-live="polite">
                <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm text-slate-600">Klaar om transfers op te
                    halen.</div>
            </div>
        </div>
        <script>
            (function () {
                const widget = document.getElementById('st-transfer-widget');
                if (!widget) return;
                const form = widget.querySelector('.st-transfer-form');
                const status = widget.querySelector('.st-transfer-status');
                const results = widget.querySelector('.st-transfer-results');
                const submitBtn = widget.querySelector('[data-transfer-submit]');
                const ajaxUrl = widget.dataset.ajax;

                const setStatus = (state, message) => {
                    status.dataset.state = state;
                    status.textContent = message;
                };

                const renderSkeleton = () => {
                    results.innerHTML = '<div class="animate-pulse bg-gray-100 border border-gray-200 rounded-xl p-4">' +
                        '<div class="h-4 bg-gray-200 rounded w-1/3 mb-3"></div>' +
                        '<div class="h-3 bg-gray-200 rounded w-full mb-2"></div>' +
                        '<div class="h-3 bg-gray-200 rounded w-2/3"></div>' +
                        '</div>';
                };

                const buildPayload = () => {
                    const fd = new FormData(form);
                    fd.append('action', 'shorttrips_get_transfers');
                    fd.append('hotelId', widget.dataset.hotel || '');
                    if (widget.dataset.resort) {
                        fd.append('resortId', widget.dataset.resort);
                    }
                    return fd;
                };

                const renderTransfers = (data) => {
                    if (!data || !Array.isArray(data.airports) || !data.airports.length) {
                        results.innerHTML = '<div class="bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm text-slate-600">Geen transfers gevonden voor deze data.</div>';
                        return;
                    }
                    const cards = data.airports.map((airport) => {
                        const transfers = (airport.transfers || []).map((transfer) => {
                            const badge = transfer.priceFromText ? '<span class="text-lg font-semibold text-emerald-600">' + transfer.priceFromText + '</span>' : '';
                            const limits = (transfer.minimumPassengers || transfer.maximumPassengers) ? '<p class="text-xs text-gray-500">Min. ' + (transfer.minimumPassengers || 1) + ' ‚Ä¢ Max. ' + (transfer.maximumPassengers || '-') + ' personen</p>' : '';
                            const duration = transfer.estimatedMinutes ? '<p class="text-xs text-gray-500">Reistijd ca. ' + transfer.estimatedMinutes + ' min.</p>' : '';
                            const rates = (transfer.rates || []).slice(0, 3).map((rate) => '<li class="text-xs text-gray-600">' + rate.direction + ' ‚Ä¢ ' + (rate.priceText || '-') + '</li>').join('');
                            const icon = transfer.transferTypeIcon ? '<span class="text-2xl text-gray-700">' + transfer.transferTypeIcon + '</span>' : '';
                            return '<div class="border border-gray-200 rounded-xl p-4 bg-white shadow-sm">' +
                                '<div class="flex items-center justify-between mb-2">' +
                                '<div class="flex items-center gap-2">' + icon + '<div class="font-semibold text-gray-800">' + (transfer.transferTypeName || 'Transfer') + '</div></div>' + badge +
                                '</div>' + limits + duration +
                                (rates ? '<ul class="mt-2 space-y-1">' + rates + '</ul>' : '') +
                                '</div>';
                        }).join('');
                        return '<div class="border border-slate-200 rounded-2xl p-5 bg-slate-50">' +
                            '<div class="flex flex-wrap items-center justify-between gap-2 mb-3">' +
                            '<div>' +
                            '<p class="text-sm font-semibold text-slate-700">' + (airport.airportName || 'Onbekende luchthaven') + '</p>' +
                            (airport.iataCode ? '<p class="text-xs text-slate-500">' + airport.iataCode + '</p>' : '') +
                            '</div>' +
                            '<span class="text-xs text-slate-500">' + (data.from_cache ? 'Cache' : 'Live') + '</span>' +
                            '</div>' +
                            (transfers || '<p class="text-sm text-slate-500">Geen transferopties beschikbaar.</p>') +
                            '</div>';
                    }).join('');
                    results.innerHTML = cards;
                };

                const fetchTransfers = () => {
                    if (!ajaxUrl) {
                        setStatus('error', 'AJAX-endpoint ontbreekt.');
                        return;
                    }
                    setStatus('loading', 'Transfers laden‚Ä¶');
                    renderSkeleton();
                    if (submitBtn) submitBtn.disabled = true;
                    fetch(ajaxUrl, { method: 'POST', credentials: 'same-origin', body: buildPayload() })
                        .then((resp) => {
                            if (!resp.ok) throw new Error('HTTP ' + resp.status);
                            return resp.json();
                        })
                        .then((json) => {
                            if (!json || !json.success) {
                                throw new Error(json && json.data && json.data.message ? json.data.message : 'Onbekende fout');
                            }
                            renderTransfers(json.data);
                            setStatus('success', json.data && json.data.from_cache ? 'Transfers geladen (cache).' : 'Transfers geladen.');
                        })
                        .catch((err) => {
                            setStatus('error', err.message || 'Kon transfers niet laden');
                            results.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-xl p-4 text-sm text-red-600">' + (err.message || 'Er ging iets mis bij het ophalen van transfers.') + '</div>';
                        })
                        .finally(() => {
                            if (submitBtn) submitBtn.disabled = false;
                        });
                };

                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    fetchTransfers();
                });

                fetchTransfers();
            })();
        </script>
    <?php endif; ?>

    <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6 mt-2">
        <style>
            .st-prebook-title-row {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                gap: 12px;
                flex-wrap: wrap;
                margin-bottom: 12px;
            }

            .st-title-left {
                display: flex;
                align-items: center;
                gap: 12px;
                flex-wrap: wrap;
            }

            .st-prebook-title {
                font-size: 28px;
                font-weight: 700;
                color: #111827;
                margin: 0;
            }

            .st-star-badge {
                color: #fbbf24;
                font-size: 22px;
                display: inline-flex;
                gap: 2px;
                line-height: 1;
            }

            .st-rating-row {
                display: flex;
                align-items: center;
                gap: 12px;
                margin: 8px 0 18px;
                flex-wrap: wrap;
            }

            .st-location-meta {
                margin-left: auto;
                text-align: right;
                color: #4b5563;
                font-size: 14px;
                min-width: 180px;
            }

            .st-location-meta span {
                display: block;
                font-size: 13px;
                color: #9ca3af;
            }

            .st-hotel-description {
                max-height: 360px;
                overflow: hidden;
                position: relative;
                padding-right: 8px;
                color: #374151;
                font-size: 14px;
                line-height: 1.6;
                margin-bottom: 8px;
            }

            .st-hotel-description::after {
                content: '';
                position: absolute;
                left: 0;
                right: 0;
                bottom: 0;
                height: 48px;
                background: linear-gradient(180deg, rgba(255, 255, 255, 0), #fff);
            }

            .st-hotel-description.st-desc-expanded {
                max-height: none;
            }

            .st-hotel-description.st-desc-expanded::after {
                display: none;
            }

            .st-gallery-section {
                margin-top: 12px;
            }

            .st-gallery-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 16px;
                align-items: stretch;
            }

            .st-gallery-grid.has-thumbs {
                grid-template-columns: minmax(0, 3fr) minmax(0, 1fr);
            }

            .st-gallery-main img {
                width: 100%;
                height: 420px;
                object-fit: cover;
                border-radius: 18px;
            }

            .st-gallery-thumbs {
                display: flex;
                flex-direction: column;
                gap: 12px;
                height: 420px;
                overflow-y: auto;
                padding-right: 4px;
            }

            .st-gallery-thumb {
                border: 1px solid #e5e7eb;
                border-radius: 14px;
                padding: 0;
                width: 100%;
                background: #fff;
                cursor: pointer;
                overflow: hidden;
                transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
                display: block;
                flex: 0 0 auto;
            }

            .st-gallery-thumb img {
                width: 100%;
                height: 120px;
                object-fit: cover;
                display: block;
            }

            .st-gallery-thumb:is(:hover, :focus-visible) {
                transform: translateY(-2px);
                border-color: #cbd5f5;
                box-shadow: 0 10px 20px rgba(37, 99, 235, 0.15);
            }

            .st-gallery-thumb.is-active {
                border-color: #2563eb;
                box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
            }

            .st-desc-toggle {
                background: none;
                border: none;
                color: #2563eb;
                font-weight: 600;
                cursor: pointer;
                padding: 0;
                margin-bottom: 16px;
            }

            @media (max-width: 768px) {
                .st-hotel-description {
                    max-height: 240px;
                }

                .st-prebook-title {
                    font-size: 24px;
                }
            }

            .st-desc-modal-overlay {
                position: fixed;
                inset: 0;
                background: rgba(17, 24, 39, 0.65);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                padding: 20px;
            }

            .st-desc-modal {
                background: #fff;
                border-radius: 16px;
                max-width: 640px;
                width: 100%;
                max-height: 85vh;
                overflow: hidden;
                position: relative;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 50px rgba(15, 23, 42, 0.3);
            }

            .st-desc-modal-body {
                padding: 24px;
                overflow-y: auto;
                color: #1f2937;
                line-height: 1.6;
                font-size: 15px;
            }

            @media (max-width: 1024px) {
                .st-gallery-grid {
                    grid-template-columns: 1fr;
                }

                .st-gallery-main img {
                    height: 320px;
                }

                .st-gallery-thumbs {
                    flex-direction: row;
                    max-height: none;
                    overflow-y: visible;
                    overflow-x: auto;
                }

                .st-gallery-thumb {
                    width: 140px;
                }

                .st-gallery-thumb img {
                    height: 90px;
                }

                .st-location-meta {
                    text-align: left;
                    min-width: 0;
                }
            }

            .st-desc-modal-close {
                position: absolute;
                top: 12px;
                right: 12px;
                border: none;
                background: none;
                font-size: 26px;
                color: #6b7280;
                cursor: pointer;
            }

            .st-desc-less-btn {
                border: none;
                background: #2563eb;
                color: #fff;
                font-weight: 600;
                padding: 14px 18px;
                margin: 0 24px 24px;
                border-radius: 10px;
                cursor: pointer;
            }

            .st-facilities-row-wrapper {
                margin: 16px 0 8px;
                background: #f8fafc;
                border: 1px solid #e5e7eb;
                border-radius: 16px;
                padding: 18px 20px;
            }

            .st-facilities-row-header {
                font-size: 18px;
                font-weight: 600;
                color: #111827;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .st-facilities-row-list {
                list-style: none !important;
                margin: 0;
                padding: 0;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .st-facility-pill {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 14px;
                border-radius: 999px;
                background: #fff;
                border: 1px solid #e5e7eb;
                font-size: 13px;
                color: #374151;
                white-space: nowrap;
            }

            .st-facility-pill span:first-child {
                font-size: 16px;
            }
        </style>
        <?php
        $locationPrimary = trim(implode(', ', array_filter([
            $hotelInfo['region'] ?? '',
            $hotelInfo['country'] ?? '',
        ], function ($v) {
            return trim((string) $v) !== ''; })));
        $locationAddress = !empty($hotelInfo['address']) ? trim((string) $hotelInfo['address']) : '';
        ?>
        <div class="st-prebook-title-row">
            <div class="st-title-left">
                <?php if (!empty($hotelInfo['stars'])): ?>
                    <span class="st-star-badge" aria-label="<?= esc_attr(intval($hotelInfo['stars'])); ?> sterren">
                        <?= str_repeat('‚òÖ', intval($hotelInfo['stars'])); ?>
                    </span>
                <?php endif; ?>
                <h1 class="st-prebook-title"><?= esc_html($hotelInfo['name']); ?></h1>
            </div>
            <?php if ($locationPrimary || $locationAddress): ?>
                <div class="st-location-meta">
                    <?php if ($locationPrimary): ?>
                        <div>üìç <?= esc_html($locationPrimary); ?></div>
                    <?php endif; ?>
                    <?php if ($locationAddress): ?>
                        <span><?= esc_html($locationAddress); ?></span>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
        </div>
        <?php if (!empty($hotelInfo['rating']) && $hotelInfo['rating'] > 0): ?>
            <div class="st-rating-row">
                <div style="display:flex;align-items:center;gap:8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="#00AA6C" style="flex-shrink:0;">
                        <circle cx="5.5" cy="12" r="3.5" />
                        <circle cx="18.5" cy="12" r="3.5" />
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8,3.59,8 8-3.59,8-8,8z"
                            opacity="0.3" />
                    </svg>
                    <div
                        style="background:#00AA6C;color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;">
                        <?= number_format($hotelInfo['rating'], 1, '.', ''); ?>
                    </div>
                    <?php if (!empty($hotelInfo['reviews'])): ?>
                        <span style="font-size:14px;color:#6b7280;"><?= number_format($hotelInfo['reviews']); ?> reviews</span>
                    <?php endif; ?>
                </div>
            </div>
        <?php endif; ?>

        <div class="st-gallery-section">
            <?php
            // Build gallery from images_json (preferred) or json_images fallback; otherwise from known single fields
            $gallery = [];
            if (!empty($dbHotel['images_json'])) {
                $gj = json_decode($dbHotel['images_json'], true);
                if (is_array($gj)) {
                    foreach ($gj as $u) {
                        if (is_string($u) && $u !== '')
                            $gallery[] = $u;
                    }
                }
            }
            if (empty($gallery) && !empty($dbHotel['json_images'])) {
                $gj = json_decode($dbHotel['json_images'], true);
                if (is_array($gj)) {
                    foreach ($gj as $u) {
                        if (is_string($u) && $u !== '')
                            $gallery[] = $u;
                    }
                }
            }
            if (empty($gallery) && !empty($hotelInfo['image'])) {
                $gallery[] = $hotelInfo['image'];
            }
            if (!empty($dbHotel['main_image']))
                $gallery[] = $dbHotel['main_image'];
            if (!empty($dbHotel['image']))
                $gallery[] = $dbHotel['image'];
            if (!empty($dbHotel['banner_image']))
                $gallery[] = $dbHotel['banner_image'];

            $seenIds = [];
            $seenUrls = [];
            $uniqueGallery = [];
            foreach ($gallery as $img) {
                if (empty($img))
                    continue;
                $normalizedUrl = strtolower(trim($img));
                if (isset($seenUrls[$normalizedUrl])) {
                    continue;
                }
                $imageId = null;
                if (preg_match('/[?&]id=(\d+)/i', $img, $match)) {
                    $imageId = $match[1];
                } elseif (preg_match('/\/(\d{5,})\//', $img, $match)) {
                    $imageId = $match[1];
                }
                if ($imageId !== null) {
                    if (isset($seenIds[$imageId])) {
                        continue;
                    }
                    $seenIds[$imageId] = true;
                }
                $seenUrls[$normalizedUrl] = true;
                $uniqueGallery[] = $img;
            }
            $gallery = array_values($uniqueGallery);
            $hasThumbs = count($gallery) > 1;
            ?>
            <?php if (!empty($gallery)): ?>
                <div class="st-gallery-grid<?= $hasThumbs ? ' has-thumbs' : ''; ?>">
                    <div class="st-gallery-main">
                        <img id="st-main-img" src="<?= esc_url($gallery[0]); ?>" alt="<?= esc_attr($hotelInfo['name']); ?>"
                            loading="lazy" data-idx="0" data-srcs="<?= esc_attr(implode('|', $gallery)); ?>"
                            onerror="window.stImgFallback && stImgFallback(this)">
                    </div>
                    <?php if ($hasThumbs): ?>
                        <div class="st-gallery-thumbs">
                            <?php foreach ($gallery as $i => $gurl): ?>
                                <button type="button" class="st-gallery-thumb<?= $i === 0 ? ' is-active' : ''; ?>"
                                    data-st-thumb="<?= intval($i); ?>" data-src="<?= esc_attr($gurl); ?>"
                                    aria-label="Toon foto <?= intval($i + 1); ?>">
                                    <img src="<?= esc_url($gurl); ?>" alt="" loading="lazy"
                                        style="width:100%;height:120px;object-fit:cover;border-radius:12px;display:block;"
                                        onerror="this.parentNode.style.display='none';">
                                </button>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                </div>
            <?php else: ?>
                <div class="w-full h-64 bg-gray-200 flex items-center justify-center text-gray-400">Geen afbeelding</div>
            <?php endif; ?>
        </div>
        <?php if (!empty($gallery) && $hasThumbs): ?>
            <script>
                (function () {
                    var main = document.getElementById('st-main-img');
                    if (!main) return;
                    var thumbs = document.querySelectorAll('[data-st-thumb]');
                    thumbs.forEach(function (btn) {
                        btn.addEventListener('click', function () {
                            var src = this.getAttribute('data-src');
                            if (!src) return;
                            main.onerror = null;
                            main.setAttribute('data-idx', this.getAttribute('data-st-thumb') || '0');
                            main.src = src;
                            thumbs.forEach(function (t) { t.classList.remove('is-active'); });
                            this.classList.add('is-active');
                        });
                    });
                })();
            </script>
        <?php endif; ?>

        <?php
        $hotelDescription = trim((string) ($hotelInfo['desc'] ?? ''));
        if ($hotelDescription !== ''):
            $shortDesc = esc_html(wp_trim_words($hotelDescription, 70, '‚Ä¶'));
            $fullDesc = nl2br(esc_html($hotelDescription));
            ?>
            <div id="st-hotel-description" class="st-hotel-description" style="margin-top:24px;">
                <?= $shortDesc; ?>
            </div>
            <button type="button" class="st-desc-toggle" onclick="openDescriptionModal()">Read more</button>
            <div id="st-description-modal" class="st-desc-modal-overlay" aria-hidden="true">
                <div class="st-desc-modal" role="dialog" aria-modal="true" aria-labelledby="st-desc-modal-title">
                    <button type="button" class="st-desc-modal-close" aria-label="Close description"
                        data-close-modal>&times;</button>
                    <div class="st-desc-modal-body">
                        <h3 id="st-desc-modal-title"
                            style="margin-top:0;font-size:20px;font-weight:600;margin-bottom:12px;color:#111827;">Hotel
                            description</h3>
                        <div><?= $fullDesc; ?></div>
                        <button type="button" class="st-desc-less-btn" data-close-modal>Read less</button>
                    </div>
                </div>
            </div>
        <?php endif; ?>

        <?php
        // Hotel-level amenities block (DB features_json; fallback op beschrijving)
        $facilitiesHtml = '';
        $items = [];
        // 1) DB features_json
        if (!empty($dbHotel['features_json'])) {
            $feat = json_decode($dbHotel['features_json'], true);
            if (is_array($feat)) {
                $emojiMap = [
                    'Air Conditioning' => '&#10052;',
                    'Wireless internet' => '&#128246;',
                    'Free Wi-Fi' => '&#128246;',
                    'Wi-Fi (surcharge)' => '&#128246;',
                    'Pool' => '&#127946;',
                    'Indoor pool(s)' => '&#127946;',
                    'Outdoor pool(s)' => '&#127946;',
                    'Childrens Pool' => '&#127946;',
                    'Restaurant' => '&#127860;',
                    'Bar' => '&#127864;',
                    'Gym/fitness facilities' => '&#128170;',
                    'Sauna' => '&#129496;',
                    'Spa facilities' => '&#129496;',
                    'Elevator' => '&#128997;',
                    'Car parking' => '&#127359;',
                    'Car parking (chargeable)' => '&#127359;',
                    'Parking' => '&#127359;',
                    'Garden' => '&#127795;',
                    'Terrace' => '&#127795;',
                    'Eco-Certified' => '&#9842;',
                    'Eco-Friendly' => '&#9842;',
                    'Safe' => '&#128274;',
                    '24hr reception' => '&#128276;',
                    '24hr check-in' => '&#128276;',
                    'Telephone' => '&#9742;',
                    'TV' => '&#128250;',
                    'Balcony' => '&#127966;',
                    'Sea View' => '&#127754;'
                ];
                foreach (array_slice($feat, 0, 12) as $f) {
                    $label = (string) ($f['name'] ?? '');
                    if ($label === '')
                        continue;
                    $emoji = $emojiMap[$label] ?? '&#10003;';
                    $items[] = '<li class="st-facility-pill"><span>' . $emoji . '</span><span>' . esc_html($label) . '</span></li>';
                }
            }
        }
        // 2) Fallback heuristisch uit beschrijving
        if (empty($items) && !empty($hotelInfo['desc'])) {
            $d = mb_strtolower((string) $hotelInfo['desc'], 'UTF-8');
            $cand = [
                ['wifi|wireless|wi-?fi', '&#128246;', 'Gratis WiFi'],
                ['air|airco|conditioning', '&#10052;', 'Airconditioning'],
                ['pool|zwembad', '&#127946;', 'Zwembad'],
                ['restaurant', '&#127860;', 'Restaurant'],
                ['bar', '&#127864;', 'Bar'],
                ['gym|fitness', '&#128170;', 'Fitness'],
                ['sauna|spa', '&#129496;', 'Spa/sauna'],
                ['elevator|lift', '&#128997;', 'Lift'],
                ['parking|parkeren', '&#127359;', 'Parkeren'],
                ['garden|tuin|terrace|terras', '&#127795;', 'Tuin/terras'],
                ['eco|duurzaam', '&#9842;', 'Eco-vriendelijk'],
                ['beach|strand', '&#127958;', 'Strand'],
                ['reception|24.*hour', '&#128276;', '24/7 receptie'],
                ['safe|kluis', '&#128274;', 'Kluis'],
            ];
            foreach ($cand as $c) {
                if (preg_match('~' . $c[0] . '~ui', $d)) {
                    $items[] = '<li class="st-facility-pill"><span>' . $c[1] . '</span><span>' . esc_html($c[2]) . '</span></li>';
                }
                if (count($items) >= 12)
                    break;
            }
        }
        if (!empty($items)) {
            ob_start();
            ?>
            <div class="st-facilities-row-wrapper">
                <div class="st-facilities-row-header">üè® Beschikbare faciliteiten</div>
                <ul class="st-facilities-row-list">
                    <?php echo implode('', $items); ?>
                </ul>
            </div>
            <?php
            $facilitiesHtml = ob_get_clean();
        }
        ?>


        <?php if (!empty($facilitiesHtml)) {
            echo $facilitiesHtml;
        } ?>

        <hr class="my-6">

        <h2 class="text-xl font-semibold mb-3">Beschikbare kamers</h2>
        <?php if (empty($roomsAvail)): ?>

            <?php
            // === GEEN BESCHIKBAARHEID - TOON ALTERNATIEVE HOTELS ===
    
            // Haal locatie informatie op van het huidige hotel
            $hotelResort = !empty($hotelInfo['region']) ? trim($hotelInfo['region']) : '';
            $hotelCity = !empty($dbHotel['city']) ? trim($dbHotel['city']) : '';
            $hotelCountry = !empty($hotelInfo['country']) ? trim($hotelInfo['country']) : '';

            // Bouw basis search parameters (behoud alle zoekgegevens)
            $searchParams = [
                'checkin' => $checkin,
                'checkout' => $checkout,
                'rooms' => $rooms,
                'adults' => $adults,
                'children' => $children
            ];

            if (!empty($childAges)) {
                $searchParams['child_ages'] = implode(',', $childAges);
            }

            // Helper om destinationID te vinden voor een gegeven plaats/land
            global $wpdb;
            $resolveSuggestionDestinationId = function ($name, $country = '') use ($wpdb) {
                static $cache = [];
                $cacheKey = strtolower(trim(($name !== '' ? $name : '__countryonly') . '|' . $country));
                if (array_key_exists($cacheKey, $cache)) {
                    return $cache[$cacheKey];
                }
                $destinationId = 0;
                $cleanName = trim($name);
                $cleanCountry = trim($country);
                if ($cleanName !== '') {
                    // Exact city/region match in ghwk_bravo_hotels
                    $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                        "SELECT destination_id
               FROM ghwk_bravo_hotels
              WHERE (city = %s OR region = %s)
                AND destination_id IS NOT NULL
                AND destination_id > 0
              LIMIT 1",
                        $cleanName,
                        $cleanName
                    ));
                    // LIKE match
                    if ($destinationId <= 0) {
                        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                            "SELECT destination_id
                 FROM ghwk_bravo_hotels
                WHERE (city LIKE %s OR region LIKE %s)
                  AND destination_id IS NOT NULL
                  AND destination_id > 0
                ORDER BY (city = %s) DESC, (region = %s) DESC
                LIMIT 1",
                            '%' . $wpdb->esc_like($cleanName) . '%',
                            '%' . $wpdb->esc_like($cleanName) . '%',
                            $cleanName,
                            $cleanName
                        ));
                    }
                    // Bravo destinations exact/like
                    if ($destinationId <= 0) {
                        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                            "SELECT destination_id
                 FROM bravo_destinations
                WHERE destination_name = %s
                  AND destination_id IS NOT NULL
                  AND deleted_at IS NULL
                LIMIT 1",
                            $cleanName
                        ));
                    }
                    if ($destinationId <= 0) {
                        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                            "SELECT destination_id
                 FROM bravo_destinations
                WHERE destination_name LIKE %s
                  AND destination_id IS NOT NULL
                  AND deleted_at IS NULL
                ORDER BY (destination_name = %s) DESC
                LIMIT 1",
                            '%' . $wpdb->esc_like($cleanName) . '%',
                            $cleanName
                        ));
                    }
                }
                // Fallback naar land
                if ($destinationId <= 0 && $cleanCountry !== '') {
                    $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                        "SELECT destination_id
               FROM ghwk_bravo_hotels
              WHERE country_name = %s
                AND destination_id IS NOT NULL
                AND destination_id > 0
              ORDER BY destination_id ASC
              LIMIT 1",
                        $cleanCountry
                    ));
                    if ($destinationId <= 0) {
                        $destinationId = (int) $wpdb->get_var($wpdb->prepare(
                            "SELECT destination_id
                 FROM bravo_destinations
                WHERE country_name = %s
                  AND destination_id IS NOT NULL
                  AND deleted_at IS NULL
                ORDER BY destination_id ASC
                LIMIT 1",
                            $cleanCountry
                        ));
                    }
                }
                $cache[$cacheKey] = $destinationId > 0 ? $destinationId : null;
                return $cache[$cacheKey];
            };

            // Bepaal welke search opties we kunnen aanbieden
            $searchOptions = [];

            // OPTIE 1: Zoek in dezelfde resort (meest specifiek)
            if (!empty($hotelResort) && strlen($hotelResort) > 2) {
                $resortDestinationId = $resolveSuggestionDestinationId($hotelResort, $hotelCountry);
                $resortArgs = array_merge($searchParams, [
                    'action' => 'shorttrips_search_hotels',
                    'type' => 'resort',
                    'resort' => $hotelResort,
                    'country' => $hotelCountry
                ]);
                if ($resortDestinationId) {
                    $resortArgs['destinationID'] = $resortDestinationId;
                }
                $searchOptions[] = [
                    'type' => 'resort',
                    'label' => 'Hotels in ' . esc_html($hotelResort),
                    'icon' => 'üèñÔ∏è',
                    'url' => add_query_arg($resortArgs, shorttrips_get_hotels_page_url())
                ];
            }

            // OPTIE 2: Zoek in dezelfde city (als beschikbaar)
            if (!empty($hotelCity) && strlen($hotelCity) > 2 && $hotelCity !== $hotelResort) {
                $cityDestinationId = $resolveSuggestionDestinationId($hotelCity, $hotelCountry);
                $cityArgs = array_merge($searchParams, [
                    'action' => 'shorttrips_search_hotels',
                    'type' => 'resort',
                    'resort' => $hotelCity,
                    'country' => $hotelCountry
                ]);
                if ($cityDestinationId) {
                    $cityArgs['destinationID'] = $cityDestinationId;
                }
                $searchOptions[] = [
                    'type' => 'city',
                    'label' => 'Hotels in ' . esc_html($hotelCity),
                    'icon' => 'üèôÔ∏è',
                    'url' => add_query_arg($cityArgs, shorttrips_get_hotels_page_url())
                ];
            }

            // OPTIE 3: Zoek in hetzelfde land (breedste zoektocht)
            if (!empty($hotelCountry) && strlen($hotelCountry) > 1) {
                $countryDestinationId = $resolveSuggestionDestinationId('', $hotelCountry);
                $countryArgs = array_merge($searchParams, [
                    'action' => 'shorttrips_search_hotels',
                    'type' => 'country',
                    'country' => $hotelCountry
                ]);
                if ($countryDestinationId) {
                    $countryArgs['destinationID'] = $countryDestinationId;
                }
                $searchOptions[] = [
                    'type' => 'country',
                    'label' => 'Alle hotels in ' . esc_html($hotelCountry),
                    'icon' => 'üåç',
                    'url' => add_query_arg($countryArgs, shorttrips_get_hotels_page_url())
                ];
            }
            ?>

            <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:24px;margin:20px 0;border-radius:12px;">
                <div style="display:flex;align-items:flex-start;gap:16px;margin-bottom:16px;">
                    <div style="font-size:32px;line-height:1;">üòî</div>
                    <div style="flex:1;">
                        <h3 style="color:#92400e;font-size:20px;margin:0 0 8px 0;font-weight:600;">
                            Dit hotel heeft geen beschikbaarheid voor uw periode
                        </h3>
                        <p style="color:#78350f;margin:0;font-size:15px;line-height:1.5;">
                            <strong><?php echo esc_html($hotelInfo['name'] ?? 'Dit hotel'); ?></strong> heeft geen kamers
                            beschikbaar van
                            <strong><?php echo date('d-m-Y', strtotime($checkin)); ?></strong> tot
                            <strong><?php echo date('d-m-Y', strtotime($checkout)); ?></strong>
                            voor <strong><?php echo $adults; ?>
                                volwassene(n)</strong><?php if ($children > 0)
                                    echo ' en <strong>' . $children . ' kind(eren)</strong>'; ?>.
                        </p>
                    </div>
                </div>

                <?php if (!empty($searchOptions)): ?>
                    <div style="background:#fff;border-radius:8px;padding:16px;margin-top:16px;">
                        <p style="color:#92400e;font-weight:600;margin:0 0 12px 0;font-size:16px;">
                            üí° Zoek alternatieve hotels in de buurt:
                        </p>

                        <div
                            style="display:grid;grid-template-columns:repeat(<?php echo min(3, count($searchOptions)); ?>,1fr);gap:12px;">
                            <?php foreach ($searchOptions as $option): ?>
                                <a href="<?php echo esc_url($option['url']); ?>"
                                    style="display:block;background:linear-gradient(135deg, #2563eb 0%, #1e40af 100%);color:#fff;padding:18px;border-radius:10px;text-decoration:none;text-align:center;transition:all 0.2s;box-shadow:0 2px 8px rgba(37,99,235,0.2);"
                                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(37,99,235,0.3)';"
                                    onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 8px rgba(37,99,235,0.2)';">

                                    <div style="font-size:32px;margin-bottom:8px;">
                                        <?php echo $option['icon']; ?>
                                    </div>

                                    <div style="font-weight:600;font-size:15px;margin-bottom:4px;">
                                        <?php echo esc_html($option['label']); ?>
                                    </div>

                                    <div style="font-size:12px;opacity:0.9;">
                                        <?php
                                        // Toon aantal dagen
                                        $checkinDate = new DateTime($checkin);
                                        $checkoutDate = new DateTime($checkout);
                                        $nights = $checkinDate->diff($checkoutDate)->days;
                                        echo $nights . ' ' . ($nights == 1 ? 'nacht' : 'nachten');
                                        ?>
                                    </div>
                                </a>
                            <?php endforeach; ?>
                        </div>

                        <p style="color:#6b7280;font-size:13px;margin:12px 0 0 0;text-align:center;">
                            ‚ÑπÔ∏è We zoeken met dezelfde datums, aantal personen en kamers
                        </p>
                    </div>
                <?php else: ?>
                    <div style="background:#fff;border-radius:8px;padding:16px;margin-top:16px;">
                        <p style="color:#6b7280;margin:0;font-size:14px;">
                            üí° <strong>Tips om beschikbaarheid te vinden:</strong>
                        </p>
                        <ul style="color:#6b7280;font-size:14px;margin:8px 0 0 20px;line-height:1.6;">
                            <li>Probeer andere datums</li>
                            <li>Verminder het aantal kamers of personen</li>
                            <li>Zoek naar hotels in een nabijgelegen stad</li>
                        </ul>
                    </div>
                <?php endif; ?>

                <div style="margin-top:16px;padding-top:16px;border-top:1px solid #fcd34d;">
                    <?php
                    // Terug knop - gaat terug naar zoekformulier met dezelfde parameters
                    $backParams = [
                        'checkin' => $checkin,
                        'checkout' => $checkout,
                        'rooms' => $rooms,
                        'adults' => $adults,
                        'children' => $children
                    ];
                    if (!empty($childAges))
                        $backParams['child_ages'] = implode(',', $childAges);
                    $backUrl = add_query_arg($backParams, shorttrips_get_hotels_page_url());
                    ?>
                    <a href="<?php echo esc_url($backUrl); ?>"
                        style="display:inline-flex;align-items:center;gap:8px;color:#92400e;text-decoration:none;font-weight:600;font-size:14px;"
                        onmouseover="this.style.color='#78350f';" onmouseout="this.style.color='#92400e';">
                        ‚Üê Pas uw zoekopdracht aan
                    </a>
                </div>
            </div>

        <?php else: ?>
            <style>
                .st-room {
                    display: grid;
                    grid-template-columns: 260px minmax(0, 1fr) 190px;
                    gap: 18px;
                    align-items: stretch;
                    border: 1px solid #e5e7eb;
                    border-radius: 14px;
                    padding: 16px;
                    background: #fff
                }

                .st-room img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    border-radius: 12px
                }

                .st-room h3 {
                    font-size: 16px;
                    margin: 0 0 6px 0;
                    font-weight: 600;
                    color: #111827
                }

                .st-room .meta {
                    font-size: 12px;
                    color: #6b7280
                }

                .st-room .badges span {
                    display: inline-block;
                    margin-right: 6px;
                    margin-top: 4px;
                    padding: 2px 6px;
                    border-radius: 6px;
                    font-size: 11px
                }

                .st-badge-free {
                    background: #d1fae5;
                    color: #065f46
                }

                .st-badge-partial {
                    background: #fef3c7;
                    color: #92400e
                }

                .st-badge-nonref {
                    background: #fee2e2;
                    color: #991b1b
                }

                .st-room .price {
                    color: #1e40af;
                    font-weight: 700;
                    font-size: 18px;
                    margin: 6px 0
                }

                .st-room .cta {
                    background: #2563eb;
                    color: #fff;
                    border: none;
                    border-radius: 8px;
                    padding: 8px 12px;
                    cursor: pointer
                }

                /* Hover zoom for room thumbs */
                .st-room-thumb {
                    position: relative;
                    width: 100%;
                    height: 100%;
                    min-height: 200px;
                    overflow: hidden;
                    border-radius: 12px
                }

                .st-room-thumb img {
                    transition: transform .18s ease, box-shadow .18s ease
                }

                .st-room-thumb:hover img {
                    transform: scale(1.08);
                    box-shadow: 0 12px 28px rgba(0, 0, 0, .25);
                    z-index: 20
                }

                .st-amen {
                    list-style: none;
                    padding: 0;
                    margin: 6px 0 0 0;
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 6px
                }

                .st-amen li {
                    font-size: 12px;
                    color: #374151;
                    display: flex;
                    align-items: center;
                    gap: 6px
                }

                .st-amen .icon {
                    width: 14px;
                    text-align: center;
                    color: #059669
                }

                .st-room-notes {
                    margin-top: 10px;
                    padding: 10px;
                    border-radius: 10px;
                    background: #eff6ff;
                    color: #1d4ed8;
                    font-size: 13px
                }

                .st-room-notes ul {
                    margin: 6px 0 0 16px;
                    padding: 0;
                    color: #1f2937
                }

                .st-room-notes li {
                    margin: 0 0 4px 0;
                    list-style: disc
                }

                .st-room-details-grid {
                    list-style: none;
                    padding: 0;
                    margin: 0;
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 6px;
                    font-size: 13px;
                    color: #374151
                }

                @media (max-width:1024px) {
                    .st-room {
                        grid-template-columns: 220px minmax(0, 1fr);
                    }
                }

                /* Image gallery navigation arrows - positioned safely */
                .st-room-thumb button[aria-label="Vorige"],
                .st-room-thumb button[aria-label="Volgende"] {
                    z-index: 10;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                }

                /* Mobile responsive - verticale layout */
                @media (max-width: 768px) {
                    .st-room {
                        grid-template-columns: 1fr;
                        grid-template-rows: auto auto auto;
                        gap: 12px;
                        align-items: stretch;
                    }

                    .st-room-thumb {
                        width: 100%;
                        height: 280px;
                        overflow: hidden;
                    }

                    .st-room-thumb img,
                    .st-room img {
                        width: 100%;
                        height: 280px;
                        object-fit: cover;
                        border-radius: 12px;
                    }

                    /* Mobiel: Kleinere pijltjes die niet over content heen gaan */
                    .st-room-thumb button[aria-label="Vorige"],
                    .st-room-thumb button[aria-label="Volgende"] {
                        width: 28px;
                        height: 28px;
                        font-size: 16px;
                        opacity: 0.9;
                    }

                    .st-room-thumb button[aria-label="Vorige"] {
                        left: 4px;
                    }

                    .st-room-thumb button[aria-label="Volgende"] {
                        right: 4px;
                    }

                    .st-room>div:last-child {
                        text-align: center;
                    }

                    .st-room .cta {
                        display: block;
                        width: 100%;
                        padding: 12px;
                        font-size: 16px;
                        font-weight: 600;
                    }

                    .st-room .price {
                        text-align: center;
                        font-size: 22px;
                        margin: 8px 0 12px 0;
                    }
                }
            </style>
            <div class="space-y-3">
                <?php foreach ($roomsAvail as $idx => $r):
                    $p = $r['price'] > 0 ? number_format($r['price'] * 1.16 * 1.09, 2, ',', '.') . ' ‚Ç¨' : 'Prijs onbekend';
                    $badge = '<span class="st-badge-nonref">Non-Refundable</span>';
                    if (!empty($r['policy'])) {
                        if (stripos($r['policy'], 'Gratis annuleren') !== false)
                            $badge = '<span class="st-badge-free">Gratis annuleren</span>';
                        elseif (stripos($r['policy'], 'Gedeeltelijk') !== false)
                            $badge = '<span class="st-badge-partial">Gedeeltelijk restitueerbaar</span>';
                    }
                    $amen = [];
                    $roomNotesFromFacilities = [];
                    // Fallback: vul missende room-meta vanuit ghwk_room_facilities (beds, max_occupancy, shared, size)
                    $hotelIdForRoom = isset($hotelId) ? (int) $hotelId : (int) ($r['hotel_id'] ?? 0);
                    $roomTypeId = isset($r['room_type_id']) ? intval($r['room_type_id']) : 0;
                    $roomIdFromApi = isset($r['room_id']) ? intval($r['room_id']) : 0;
                    static $st_room_fac_cache = [];
                    static $st_room_fac_cache_by_pk = [];
                    static $st_room_fac_select_cols = null;
                    if ($st_room_fac_select_cols === null) {
                        global $wpdb;
                        $hasCustomizedCol = (bool) $wpdb->get_var("SHOW COLUMNS FROM ghwk_room_facilities LIKE 'customized_room_type'");
                        $st_room_fac_select_cols = "beds, extrabeds, max_occupancy, shared_room, shared_facilities, size_in_m2, amenities_json, bed_types_json";
                        if ($hasCustomizedCol) {
                            $st_room_fac_select_cols .= ", customized_room_type";
                        }
                    }
                    $fac = null;
                    if ($hotelIdForRoom > 0 && $roomTypeId > 0) {
                        if (!isset($st_room_fac_cache[$hotelIdForRoom])) {
                            $st_room_fac_cache[$hotelIdForRoom] = [];
                        }
                        if (!array_key_exists($roomTypeId, $st_room_fac_cache[$hotelIdForRoom])) {
                            global $wpdb;
                            $st_room_fac_cache[$hotelIdForRoom][$roomTypeId] = $wpdb->get_row(
                                $wpdb->prepare(
                                    "SELECT {$st_room_fac_select_cols}
                   FROM ghwk_room_facilities
                   WHERE hotel_id = %d AND room_type_id = %d
                   LIMIT 1",
                                    $hotelIdForRoom,
                                    $roomTypeId
                                ),
                                ARRAY_A
                            );
                        }
                        $fac = $st_room_fac_cache[$hotelIdForRoom][$roomTypeId] ?? null;
                    }
                    if (!$fac && $roomIdFromApi > 0) {
                        if (!array_key_exists($roomIdFromApi, $st_room_fac_cache_by_pk)) {
                            global $wpdb;
                            $st_room_fac_cache_by_pk[$roomIdFromApi] = $wpdb->get_row(
                                $wpdb->prepare(
                                    "SELECT {$st_room_fac_select_cols}
                   FROM ghwk_room_facilities
                   WHERE id = %d
                   LIMIT 1",
                                    $roomIdFromApi
                                ),
                                ARRAY_A
                            );
                        }
                        $fac = $st_room_fac_cache_by_pk[$roomIdFromApi] ?? null;
                    }
                    if ($fac) {
                        if (empty($r['beds']) && isset($fac['beds']))
                            $r['beds'] = $fac['beds'];
                        if (empty($r['extrabeds']) && isset($fac['extrabeds']))
                            $r['extrabeds'] = $fac['extrabeds'];
                        if ((empty($r['max_occupancy']) || $r['max_occupancy'] <= 0) && isset($fac['max_occupancy']))
                            $r['max_occupancy'] = $fac['max_occupancy'];
                        if (empty($r['shared_room']) && !empty($fac['shared_room']))
                            $r['shared_room'] = $fac['shared_room'];
                        if (empty($r['shared_facilities']) && !empty($fac['shared_facilities']))
                            $r['shared_facilities'] = $fac['shared_facilities'];
                        if ((empty($r['size_in_m2']) || $r['size_in_m2'] <= 0) && !empty($fac['size_in_m2']))
                            $r['size_in_m2'] = $fac['size_in_m2'];
                        // Merge stored amenities into the visual list if the API response lacked detail.
                        if (!empty($fac['amenities_json'])) {
                            $decodedAmenities = json_decode($fac['amenities_json'], true);
                            if (is_array($decodedAmenities)) {
                                $decodedAmenities = array_values(array_filter(array_map(function ($label) {
                                    $label = trim((string) $label);
                                    return $label === '' ? null : $label;
                                }, $decodedAmenities)));
                                if (!empty($decodedAmenities)) {
                                    $existingAmenKeys = [];
                                    foreach ($amen as $entry) {
                                        if (is_array($entry) && isset($entry[1])) {
                                            $existingAmenKeys[strtolower(trim((string) $entry[1]))] = true;
                                        }
                                    }
                                    foreach ($decodedAmenities as $label) {
                                        $key = strtolower($label);
                                        if (isset($existingAmenKeys[$key])) {
                                            continue;
                                        }
                                        $amen[] = ['&#8226;', $label];
                                        $existingAmenKeys[$key] = true;
                                    }
                                }
                            }
                        }
                        // Surface structured bed types as readable room notes.
                        if (!empty($fac['bed_types_json'])) {
                            $bedTypeEntries = json_decode($fac['bed_types_json'], true);
                            if (is_array($bedTypeEntries)) {
                                foreach ($bedTypeEntries as $bedEntry) {
                                    if (!is_array($bedEntry)) {
                                        continue;
                                    }
                                    $bedLabel = isset($bedEntry['bed_type']) ? trim((string) $bedEntry['bed_type']) : '';
                                    $bedQty = isset($bedEntry['quantity']) ? (int) $bedEntry['quantity'] : 0;
                                    if ($bedLabel === '') {
                                        continue;
                                    }
                                    $noteText = ($bedQty > 0 ? $bedQty . '√ó ' : '') . $bedLabel;
                                    $roomNotesFromFacilities[] = $noteText;
                                }
                            }
                        }
                    }
                    // Extra fallback: pak size_in_m2 uit ghwk_hotel_room_types als we het nog niet weten
                    if (($r['size_in_m2'] ?? 0) <= 0 && $hotelIdForRoom > 0 && $roomTypeId > 0) {
                        global $wpdb;
                        $__rtSize = $wpdb->get_var($wpdb->prepare(
                            "SELECT size_in_m2 FROM ghwk_hotel_room_types WHERE hotel_id = %d AND room_type_id = %d AND size_in_m2 > 0 LIMIT 1",
                            $hotelIdForRoom,
                            $roomTypeId
                        ));
                        if ($__rtSize) {
                            $r['size_in_m2'] = (int) $__rtSize;
                        }
                    }

                    $metaBits = [];
                    // verplaats bedden en personen naar gestructureerde detailsblokken; hier alleen gedeeld-flags
                    if (!empty($r['shared_room']))
                        $metaBits[] = 'gedeelde kamer';
                    if (!empty($r['shared_facilities']))
                        $metaBits[] = 'gedeelde faciliteiten';
                    $meta = !empty($metaBits) ? implode(' ‚Ä¢ ', $metaBits) : '';
                    $dealBadge = '';
                    if (!empty($r['superdeal']) || !empty($r['bestbuy']))
                        $dealBadge = '<span class="st-badge-partial">Deal</span>';

                    // Amenities (heuristics + placeholders)
                    // From XML amenity list if we stored it
                    if (!empty($r['amen']) && is_array($r['amen'])) {
                        foreach ($r['amen'] as $a) {
                            $al = strtolower(trim((string) $a));
                            if ($al === '')
                                continue;
                            if (strpos($al, 'wifi') !== false) {
                                $amen[] = ['&#128246;', 'Gratis WiFi'];
                                continue;
                            }
                            if (strpos($al, 'air') !== false || strpos($al, 'airco') !== false || strpos($al, 'conditioning') !== false) {
                                $amen[] = ['&#10052;', 'Airconditioning'];
                                continue;
                            }
                            if (strpos($al, 'flat') !== false && strpos($al, 'tv') !== false) {
                                $amen[] = ['&#128250;', 'Flatscreen‚Äëtv'];
                                continue;
                            }
                            if (strpos($al, 'bath') !== false || strpos($al, 'douche') !== false || strpos($al, 'badkamer') !== false) {
                                $amen[] = ['&#128705;', 'Eigen badkamer'];
                                continue;
                            }
                            if (strpos($al, 'coffee') !== false || strpos($al, 'koffie') !== false || strpos($al, 'tea') !== false || strpos($al, 'thee') !== false) {
                                $amen[] = ['&#9749;', 'Koffie-/theefaciliteiten'];
                                continue;
                            }
                            if (strpos($al, 'view') !== false || strpos($al, 'uitzicht') !== false) {
                                $amen[] = ['&#127750;', 'Uitzicht'];
                                continue;
                            }
                            if (strpos($al, 'balcony') !== false || strpos($al, 'balkon') !== false) {
                                $amen[] = ['&#9728;', 'Balkon'];
                                continue;
                            }
                            // Fallback: add raw label once
                            $amen[] = ['&#8226;', ucfirst($al)];
                            if (count($amen) >= 12)
                                break;
                        }
                    }
                    // Bedden niet als amenity tonen om duplicatie te vermijden; we tonen ze in details
                    // Breakfast
                    if (!empty($r['meal']) && stripos((string) $r['meal'], 'breakfast') !== false) {
                        $amen[] = ['&#127859;', 'Ontbijt inbegrepen'];
                    }
                    // Parse size from description
                    $descLower = strtolower((string) ($r['desc'] ?? ''));
                    if (preg_match('~(\d{2,3})\s?(m¬≤|m2)~u', $descLower, $mm)) {
                        $amen[] = ['&#9724;', $mm[1] . ' m¬≤'];
                        if (empty($r['size_in_m2']) || $r['size_in_m2'] <= 0) {
                            $r['size_in_m2'] = (int) $mm[1];
                        }
                    }
                    if (strpos($descLower, 'air') !== false || strpos($descLower, 'airco') !== false || strpos($descLower, 'conditioning') !== false) {
                        $amen[] = ['&#10052;', 'Airconditioning'];
                    }
                    if (strpos($descLower, 'flat') !== false && strpos($descLower, 'tv') !== false) {
                        $amen[] = ['&#128250;', 'Flatscreen‚Äëtv'];
                    }
                    if (strpos($descLower, 'wifi') !== false) {
                        $amen[] = ['&#128246;', 'Gratis WiFi'];
                    }
                    // If we still have no amenities, reuse hotel-level features as a minimal fallback
                    if (empty($amen) && !empty($dbHotel['features_json'])) {
                        $feat = json_decode($dbHotel['features_json'], true);
                        if (is_array($feat)) {
                            foreach (array_slice($feat, 0, 6) as $f) {
                                $label = is_array($f) && isset($f['name']) ? trim((string) $f['name']) : (is_string($f) ? trim($f) : '');
                                if ($label !== '') {
                                    $amen[] = ['&#10003;', $label];
                                }
                            }
                        }
                    }
                    if (strpos($descLower, 'ensuite') !== false || strpos($descLower, 'bathroom') !== false || strpos($descLower, 'badkamer') !== false) {
                        $amen[] = ['&#128705;', 'Eigen badkamer'];
                    }
                    if (strpos($descLower, 'coffee') !== false || strpos($descLower, 'koffie') !== false || strpos($descLower, 'tea') !== false || strpos($descLower, 'thee') !== false) {
                        $amen[] = ['&#9749;', 'Koffie-/theefaciliteiten'];
                    }
                    ?>
                    <?php
                    $rkey = strtolower(trim((string) $r['type']));
                    $rimgs = [];

                    // DEBUG: Log room type matching for ALL hotels
                    // @file_put_contents($debug_log_path, "üîç [Hotel $hotelId] Room: '{$r['type']}', ID: $roomTypeId, Key: '$rkey'\n", FILE_APPEND);
        
                    if ($roomTypeId > 0 && isset($roomImagesById[$roomTypeId])) {
                        $rimgs = $roomImagesById[$roomTypeId];
                        // @file_put_contents($debug_log_path, "  ‚úÖ Matched by ID $roomTypeId: " . count($rimgs) . " images\n", FILE_APPEND);
                    }
                    if (empty($rimgs) && $rkey !== '' && isset($roomImagesByName[$rkey])) {
                        $rimgs = $roomImagesByName[$rkey];
                        // @file_put_contents($debug_log_path, "  ‚úÖ Matched by name '$rkey': " . count($rimgs) . " images\n", FILE_APPEND);
                    }
                    if (empty($rimgs)) {
                        $rimgs = $gallery;
                        // @file_put_contents($debug_log_path, "  ‚ùå No match, using hotel images (fallback): " . count($rimgs) . " images\n", FILE_APPEND);
                    }

                    // Advanced deduplication: Remove duplicates based on image ID (not just exact URL match)
                    $seenIds = [];
                    $uniqueImages = [];
                    foreach ($rimgs as $img) {
                        // Extract image ID from URL (supports multiple URL patterns)
                        if (preg_match('/[?&]id=(\d+)/i', $img, $match)) {
                            $imageId = $match[1];
                            if (!isset($seenIds[$imageId])) {
                                $seenIds[$imageId] = true;
                                $uniqueImages[] = $img;
                            }
                        } elseif (preg_match('/\/(\d{5,})\//', $img, $match)) {
                            // Also support /giata/12345/ style URLs
                            $imageId = $match[1];
                            if (!isset($seenIds[$imageId])) {
                                $seenIds[$imageId] = true;
                                $uniqueImages[] = $img;
                            }
                        } else {
                            // No ID found, include anyway (shouldn't happen with our URLs)
                            $uniqueImages[] = $img;
                        }
                    }
                    $rimgs = array_values(array_filter($uniqueImages));

                    // DEBUG: Log final images array
                    // @file_put_contents($debug_log_path, "  üñºÔ∏è Final images array: " . json_encode($rimgs) . "\n", FILE_APPEND);
        
                    $imgId = 'st-room-img-' . $idx;
                    $startIdx = !empty($rimgs) ? ($idx % count($rimgs)) : 0;
                    $startUrl = !empty($rimgs) ? $rimgs[$startIdx] : '';

                    // DEBUG: Log what will be rendered
                    // @file_put_contents($debug_log_path, "  üé® Start URL: $startUrl\n", FILE_APPEND);
                    // @file_put_contents($debug_log_path, "  üé® data-srcs will be: " . implode('|', $rimgs) . "\n", FILE_APPEND);
                    ?>
                    <div class="st-room">
                        <?php if (!empty($rimgs)): ?>
                            <div class="st-room-thumb" style="position:relative;width:100%;height:100%;min-height:200px;">
                                <img id="<?= $imgId; ?>" src="<?= esc_url($startUrl); ?>" alt=""
                                    style="width:100%;height:100%;min-height:200px;object-fit:cover;border-radius:10px;display:block;"
                                    data-idx="<?= $startIdx; ?>" data-srcs="<?= esc_attr(implode('|', $rimgs)); ?>"
                                    onerror="window.stImgFallback && stImgFallback(this)">
                                <?php if (count($rimgs) > 1): ?>
                                    <button type="button" aria-label="Vorige"
                                        style="position:absolute;left:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.6);color:#fff;border:none;width:32px;height:32px;border-radius:999px;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;"
                                        onmouseover="this.style.background='rgba(0,0,0,.8)';this.style.transform='translateY(-50%) scale(1.1)';"
                                        onmouseout="this.style.background='rgba(0,0,0,.6)';this.style.transform='translateY(-50%) scale(1)';"
                                        onclick="(function(id){var m=document.getElementById(id); if(!m)return; var list=(m.getAttribute('data-srcs')||'').split('|').filter(Boolean); var idx=parseInt(m.getAttribute('data-idx')||'0',10)||0; idx=(idx-1+list.length)%list.length; m.setAttribute('data-idx', String(idx)); m.src=list[idx];})('<?= $imgId; ?>')">‚Äπ</button>
                                    <button type="button" aria-label="Volgende"
                                        style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.6);color:#fff;border:none;width:32px;height:32px;border-radius:999px;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;"
                                        onmouseover="this.style.background='rgba(0,0,0,.8)';this.style.transform='translateY(-50%) scale(1.1)';"
                                        onmouseout="this.style.background='rgba(0,0,0,.6)';this.style.transform='translateY(-50%) scale(1)';"
                                        onclick="(function(id){var m=document.getElementById(id); if(!m)return; var list=(m.getAttribute('data-srcs')||'').split('|').filter(Boolean); var idx=parseInt(m.getAttribute('data-idx')||'0',10)||0; idx=(idx+1)%list.length; m.setAttribute('data-idx', String(idx)); m.src=list[idx];})('<?= $imgId; ?>')">‚Ä∫</button>
                                <?php endif; ?>
                            </div>
                        <?php else: ?>
                            <div class="st-room-thumb" style="position:relative;width:100%;height:100%;min-height:200px;">
                                <img src="<?= esc_url($dbHotel['main_image'] ?: ($dbHotel['image'] ?: ($dbHotel['banner_image'] ?? ''))); ?>"
                                    alt=""
                                    style="width:100%;height:100%;min-height:200px;object-fit:cover;border-radius:10px;display:block;">
                            </div>
                        <?php endif; ?>
                        <div>
                            <h3 style="font-size:18px;font-weight:600;color:#1f2937;margin:0 0 8px 0;"><?= esc_html($r['type']); ?>
                            </h3>

                            <?php
                            // Room name from DB (als beschikbaar en verschillend van type)
                            if (!empty($r['name']) && $r['name'] !== $r['type']):
                                ?>
                                <div style="font-size:14px;color:#6b7280;margin-bottom:6px;font-weight:500;">
                                    <?= esc_html($r['name']); ?>
                                </div>
                            <?php endif; ?>

                            <?php
                            $pax = max(1, intval(($adults ?? 0) + ($children ?? 0)));
                            $bedsCnt = isset($r['beds']) && $r['beds'] !== null ? intval($r['beds']) : null;
                            $extraBedsCnt = isset($r['extrabeds']) && $r['extrabeds'] !== null ? intval($r['extrabeds']) : null;
                            $maxOccupancy = isset($r['max_occupancy']) && $r['max_occupancy'] > 0 ? intval($r['max_occupancy']) : null;
                            $mealLabel = trim((string) ($r['meal'] ?? '')) !== '' ? (string) $r['meal'] : 'No meals';
                            // Optional extras coming from API sync
                            $mealPlansAll = [];
                            if (!empty($r['mealplans'])) {
                                // Accept comma-separated string or array
                                if (is_array($r['mealplans'])) {
                                    $mealPlansAll = array_filter(array_map('trim', $r['mealplans']));
                                } else {
                                    $mealPlansAll = array_filter(array_map('trim', explode(',', (string) $r['mealplans'])));
                                }
                            }
                            $priceFrom = isset($r['pricefrom']) && is_numeric($r['pricefrom']) ? (float) $r['pricefrom'] : null;
                            $priceTo = isset($r['priceto']) && is_numeric($r['priceto']) ? (float) $r['priceto'] : null;
                            $policyLabel = trim((string) ($r['policy'] ?? '')) !== '' ? (string) $r['policy'] : 'Non-Refundable';
                            $roomSize = isset($r['size_in_m2']) && $r['size_in_m2'] > 0 ? intval($r['size_in_m2']) : 0;
                            $roomDesc = isset($r['description']) && !empty(trim($r['description'])) ? trim($r['description']) : '';
                            $sharedRoom = isset($r['shared_room']) && $r['shared_room'] == 1;
                            $sharedFac = isset($r['shared_facilities']) && $r['shared_facilities'] == 1;
                            $roomNotes = [];
                            if (!empty($r['room_notes']) && is_array($r['room_notes'])) {
                                $roomNotes = array_values(array_filter(array_map(function ($note) {
                                    return trim((string) $note);
                                }, $r['room_notes'])));
                            }
                            if (!empty($roomNotesFromFacilities)) {
                                $roomNotes = array_merge($roomNotes, $roomNotesFromFacilities);
                            }
                            if (!empty($roomNotes)) {
                                $roomNotes = array_values(array_unique($roomNotes));
                            }
                            ?>
                            <div class="meta" style="margin-top:4px;">
                                <ul class="st-room-details-grid">
                                    <?php if ($maxOccupancy !== null): ?>
                                        <li><strong>üë• Max:</strong> <?= esc_html($maxOccupancy); ?> personen</li><?php endif; ?>
                                    <?php if ($bedsCnt !== null): ?>
                                        <li><strong>üõèÔ∏è Bedden:</strong> <?= esc_html($bedsCnt); ?><?php if ($extraBedsCnt): ?> +
                                                <?= esc_html($extraBedsCnt); ?> extra<?php endif; ?></li>
                                    <?php endif; ?>
                                    <?php if ($roomSize > 0): ?>
                                        <li><strong>üìê Grootte:</strong> <?= esc_html($roomSize); ?> m¬≤</li><?php endif; ?>
                                    <li><strong>üç≥ Meal:</strong> <?= esc_html($mealLabel); ?></li>
                                    <?php if ($priceFrom !== null || $priceTo !== null): ?>
                                        <li style="grid-column:1/-1;"><strong>üí∂ Prijsrange:</strong>
                                            <?php if ($priceFrom !== null): ?>vanaf ‚Ç¨
                                                <?= esc_html(number_format($priceFrom, 0, ',', '.')); ?>                <?php endif; ?>
                                            <?php if ($priceFrom !== null && $priceTo !== null): ?> ¬∑ <?php endif; ?>
                                            <?php if ($priceTo !== null): ?>tot ‚Ç¨
                                                <?= esc_html(number_format($priceTo, 0, ',', '.')); ?>                <?php endif; ?>
                                        </li>
                                    <?php endif; ?>
                                    <?php if (!empty($mealPlansAll)): ?>
                                        <li style="grid-column:1/-1;"><strong>üçΩÔ∏è Mealplans:</strong>
                                            <?= esc_html(implode(', ', $mealPlansAll)); ?></li>
                                    <?php endif; ?>
                                    <?php if ($sharedRoom): ?>
                                        <li style="grid-column:1/-1;color:#92400e;">‚ö†Ô∏è Gedeelde kamer</li><?php endif; ?>
                                    <?php if ($sharedFac): ?>
                                        <li style="grid-column:1/-1;color:#92400e;">‚ö†Ô∏è Gedeelde faciliteiten</li><?php endif; ?>
                                </ul>
                                <?php if ($meta) {
                                    echo '<div style="margin-top:6px">' . esc_html($meta) . '</div>';
                                } ?>
                            </div>

                            <?php if ($roomDesc): ?>
                                <div class="meta"
                                    style="margin-top:8px;padding:8px;background:#f9fafb;border-radius:6px;font-size:13px;color:#4b5563;">
                                    <?= esc_html(wp_trim_words($roomDesc, 30, '...')); ?>
                                </div>
                            <?php elseif ($r['desc']): ?>
                                <div class="meta" style="margin-top:4px;"><?= esc_html(wp_trim_words($r['desc'], 22, '...')); ?></div>
                            <?php endif; ?>
                            <?php if (!empty($roomNotes)): ?>
                                <div class="st-room-notes">
                                    <div style="font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:6px;">
                                        <span>‚ÑπÔ∏è</span><span>Kamer opmerkingen</span>
                                    </div>
                                    <ul>
                                        <?php foreach ($roomNotes as $note): ?>
                                            <li><?= esc_html($note); ?></li>
                                        <?php endforeach; ?>
                                    </ul>
                                </div>
                            <?php endif; ?>
                            <?php if (!empty($amen)): ?>
                                <ul class="st-amen">
                                    <?php foreach (array_slice($amen, 0, 8) as $a): ?>
                                        <li><span class="icon"><?= esc_html($a[0]); ?></span><span><?= esc_html($a[1]); ?></span></li>
                                    <?php endforeach; ?>
                                </ul>
                            <?php endif; ?>
                            <div class="badges"><?= $badge ?><?= $dealBadge ?></div>
                        </div>
                        <div style="text-align:right">
                            <div class="price"><?= $p; ?></div>
                            <?php
                            // Toon concurrentieprijs ook op prebook, boven de "Boek deze kamer" knop (hotel-niveau)
                            if (function_exists('freestays_competitor_get_price') && get_option('freestays_show_competitor_prices_google', '0') === '1') {
                                // Voor prebook tonen we 1 prijs per hotel/datumcombinatie; meal per room is minder relevant
                                $compPre = freestays_competitor_get_price($hotelId, $checkin, $checkout, $rooms, $adults, $children, '');

                                // Admin-only debug comment
                                if (current_user_can('manage_options')) {
                                    echo '<!-- FS-DEBUG-PREBOOK-COMP hotel_id=' . (int) $hotelId .
                                        ' checkin=' . esc_html($checkin) .
                                        ' checkout=' . esc_html($checkout) .
                                        ' comp_row=' . ($compPre ? 'YES' : 'NO') . ' -->';
                                }

                                if ($compPre && !empty($compPre['price_total'])) {
                                    $cpPrice = (float) $compPre['price_total'];
                                    $cpProvider = !empty($compPre['provider']) ? $compPre['provider'] : '';
                                    $cpDate = !empty($compPre['fetched_at']) ? mysql2date('d-m-Y', $compPre['fetched_at']) : '';
                                    ?>
                                    <div style="margin-top:4px;font-size:11px;color:#4b5563;line-height:1.4;">
                                        <span style="display:block;">Vergelijkbare kamer elders vanaf</span>
                                        <span style="display:block;font-weight:600;color:#047857;">
                                            ‚Ç¨ <?= number_format($cpPrice, 2, ',', '.'); ?>
                                            <?php if ($cpProvider): ?>
                                                <span style="font-weight:400;color:#6b7280;">(<?php echo esc_html($cpProvider); ?>)</span>
                                            <?php endif; ?>
                                        </span>
                                        <?php if ($cpDate): ?>
                                            <span style="display:block;color:#9ca3af;">(gecheckt op <?php echo esc_html($cpDate); ?>)</span>
                                        <?php endif; ?>
                                        <?php if (!empty($compPre['deeplink'])): ?>
                                            <a href="<?php echo esc_url($compPre['deeplink']); ?>" target="_blank" rel="noopener noreferrer"
                                                style="display:inline-block;margin-top:2px;font-size:11px;color:#2563eb;text-decoration:underline;">
                                                Bekijk bij aanbieder
                                            </a>
                                        <?php endif; ?>
                                    </div>
                                    <?php
                                }
                            }
                            ?>
                            <?php
                            $checkoutBase = home_url('/check-out/');
                            $checkoutUrl = add_query_arg([
                                'hotelId' => $hotelId,
                                'checkin' => $checkin,
                                'checkout' => $checkout,
                                'rooms' => $rooms,
                                'adults' => $adults,
                                'children' => $children,
                                'child_ages' => !empty($childAges) ? implode(',', $childAges) : '',
                                'room_id' => $roomTypeId ?: '',
                                'room_type' => (string) ($r['type'] ?? ''),
                                'meal' => (string) ($mealLabel ?? ($r['meal'] ?? '')),
                                'price' => number_format((float) ($r['price'] ?? 0) * 1.16 * 1.09, 2, '.', ''),
                                'policy' => (string) ($policyLabel ?? ''),
                                'image' => (string) $startUrl,
                            ], $checkoutBase);
                            ?>
                            <a class="cta" href="<?= esc_url($checkoutUrl); ?>"
                                style="display:inline-block;background:#2563eb;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;text-decoration:none">Boek
                                deze kamer</a>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
    </div>
    <script>(function () { if (window.stImgFallback) return; window.stImgFallback = function (img) { var list = (img.getAttribute('data-srcs') || '').split('|').filter(Boolean); var idx = parseInt(img.getAttribute('data-idx') || '0', 10); if (isNaN(idx)) idx = 0; idx++; if (idx < list.length) { img.setAttribute('data-idx', String(idx)); img.src = list[idx]; } else { img.onerror = null; } }; })();</script>

    <script>
        (function () {
            var modal = document.getElementById('st-description-modal');
            if (!modal) {
                return;
            }
            var closeButtons = modal.querySelectorAll('[data-close-modal]');
            var lastFocusedElement = null;

            function openModal() {
                lastFocusedElement = document.activeElement;
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
                var primaryClose = modal.querySelector('[data-close-modal]');
                if (primaryClose) {
                    primaryClose.focus();
                }
            }

            function closeModal() {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
                if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                    lastFocusedElement.focus();
                }
            }

            window.openDescriptionModal = openModal;
            window.closeDescriptionModal = closeModal;

            closeButtons.forEach(function (btn) {
                btn.addEventListener('click', closeModal);
            });

            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        })();
    </script>

    <?php
    return ob_get_clean();
});
/*
 * --------------------------------------------------------------------------
 * SHORTCODE: [freestays_checkout]
 *  - Renders checkout page with selected room details, guest form, voucher input, and totals
 *  - NOTE: No booking call to Sunhotels here; booking must be done ONLY after Stripe payment success
 * --------------------------------------------------------------------------
 */
add_shortcode('freestays_checkout', function () {
    // Gather context from URL
    $hotelId = isset($_GET['hotelId']) ? intval($_GET['hotelId']) : 0;
    $checkin = isset($_GET['checkin']) ? sanitize_text_field($_GET['checkin']) : '';
    $checkout = isset($_GET['checkout']) ? sanitize_text_field($_GET['checkout']) : '';
    $rooms = isset($_GET['rooms']) ? max(1, intval($_GET['rooms'])) : 1;
    $adults = isset($_GET['adults']) ? max(1, intval($_GET['adults'])) : 2;
    $children = isset($_GET['children']) ? max(0, intval($_GET['children'])) : 0;
    $childAges = isset($_GET['child_ages']) ? sanitize_text_field($_GET['child_ages']) : '';
    $roomType = isset($_GET['room_type']) ? sanitize_text_field($_GET['room_type']) : '';
    $meal = isset($_GET['meal']) ? sanitize_text_field($_GET['meal']) : '';
    $policy = isset($_GET['policy']) ? sanitize_text_field($_GET['policy']) : '';
    $image = isset($_GET['image']) ? esc_url_raw($_GET['image']) : '';
    $roomId = isset($_GET['room_id']) ? sanitize_text_field($_GET['room_id']) : ''; // SunHotels room ID
    // Price expected as decimal string with dot
    $priceStr = isset($_GET['price']) ? preg_replace('/[^0-9.]/', '', (string) $_GET['price']) : '0';
    $roomTotal = max(0.0, floatval($priceStr));
    $bookingFee = 15.00;
    // Bereken aantal nachten en prijs per nacht voor UI
    try {
        $ci = new DateTime($checkin);
        $co = new DateTime($checkout);
        $nights = max(1, $ci->diff($co)->days);
    } catch (Exception $e) {
        $nights = 1;
    }
    $pricePerNight = $nights > 0 ? $roomTotal / $nights : $roomTotal;
    // Parse child ages CSV
    $childAgesArr = array_values(array_filter(array_map('intval', array_filter(array_map('trim', explode(',', (string) $childAges))))));

    // Fetch hotel name and fallback image from DB if possible
    global $wpdb;
    $hotelName = 'Hotel #' . $hotelId;
    $fallbackImg = '';
    if ($hotelId > 0) {
        $h = $wpdb->get_row($wpdb->prepare("SELECT title, hotelname, main_image, image, banner_image FROM ghwk_bravo_hotels WHERE hotel_id=%d", $hotelId), ARRAY_A);
        if ($h) {
            $hotelName = !empty($h['title']) ? $h['title'] : (!empty($h['hotelname']) ? $h['hotelname'] : $hotelName);
            $fallbackImg = $h['main_image'] ?: ($h['image'] ?: ($h['banner_image'] ?: ''));
        }
    }
    $displayImg = $image ?: $fallbackImg;
    $backToPrebookParams = [
        'hotelId' => $hotelId,
        'checkin' => $checkin,
        'checkout' => $checkout,
        'rooms' => $rooms,
        'adults' => $adults,
        'children' => $children,
        'action' => 'shorttrips_prebook'
    ];
    if (!empty($childAges)) {
        $backToPrebookParams['child_ages'] = $childAges;
    }
    if (!empty($roomId)) {
        $backToPrebookParams['room_id'] = $roomId;
    }
    if (!empty($roomType)) {
        $backToPrebookParams['room_type'] = $roomType;
    }
    if (!empty($meal)) {
        $backToPrebookParams['meal'] = $meal;
    }
    if (!empty($policy)) {
        $backToPrebookParams['policy'] = $policy;
    }
    $backToPrebookUrl = add_query_arg($backToPrebookParams, home_url('/prebook/'));

    ob_start(); ?>
    <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6 mt-8">
        <h1 class="text-2xl font-bold mb-3">Afrekenen</h1>

        <div class="fs-steps" style="display:flex;gap:8px;margin:6px 0 6px 0">
            <div id="fs-step-pill-1"
                style="flex:1;border:1px solid #93c5fd;background:#dbeafe;color:#1e40af;border-radius:999px;padding:6px 10px;font-weight:600;text-align:center;white-space:nowrap">
                1 Gegevens</div>
            <div id="fs-step-pill-2"
                style="flex:1;border:1px solid #e5e7eb;background:#f9fafb;color:#6b7280;border-radius:999px;padding:6px 10px;font-weight:600;text-align:center;white-space:nowrap">
                2 Overzicht & Betaling</div>
        </div>
        <div class="fs-progress-track"
            style="height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:0 0 12px 0">
            <div id="fs-progress"
                style="height:6px;width:50%;background:#2563eb;border-radius:999px;transition:width .3s ease"></div>
        </div>

        <div class="fs-checkout-container">

            <!-- Grid voor Hotel + Overzicht (responsive) -->
            <style>
                .fs-checkout-grid-wrapper {
                    display: grid !important;
                    grid-template-columns: 60% 40% !important;
                    gap: 16px !important;
                    margin-bottom: 24px !important;
                    width: 100% !important;
                }

                .fs-checkout-grid-wrapper>div {
                    min-width: 0 !important;
                    max-width: 100% !important;
                    overflow: hidden !important;
                }

                @media (max-width: 768px) {
                    .fs-checkout-grid-wrapper {
                        grid-template-columns: 1fr !important;
                    }
                }
            </style>
            <div class="fs-checkout-grid-wrapper">
                <div>
                    <h2
                        style="font-size:20px;font-weight:600;margin:0 0 16px 0;padding:12px 16px;background:rgba(37,99,235,0.5);color:#fff;border-radius:8px;">
                        Uw hotel</h2>
                    <div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px">
                        <!-- Header: Hotel naam en prijs -->
                        <div
                            style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;gap:16px">
                            <div style="font-weight:600;font-size:18px;color:#111827;flex:1;line-height:1.3">
                                <?= esc_html($hotelName); ?></div>
                            <div style="text-align:right;white-space:nowrap;flex:0 0 auto">
                                <div style="color:#6b7280;font-size:12px;margin-bottom:2px">Kamer totaal</div>
                                <div style="color:#6b7280;font-size:12px;margin-bottom:2px">
                                    ‚Ç¨ <?= number_format($pricePerNight, 2, ',', '.'); ?> per nacht ‚Ä¢ voor <?= $nights; ?> nachten
                                </div>
                                <div style="color:#1e40af;font-weight:700;font-size:18px">‚Ç¨
                                    <?= number_format($roomTotal, 2, ',', '.'); ?></div>
                                <?php
                                // Toon eventuele concurrentieprijs onder de eigen prijs
                                if (function_exists('freestays_competitor_get_price') && get_option('freestays_show_competitor_prices_google', '0') === '1') {
                                    $comp = freestays_competitor_get_price($hotelId, $checkin, $checkout, $rooms, $adults, $children, $meal);

                                    // Admin-only debug output
                                    if (current_user_can('manage_options')) {
                                        echo '<!-- FS-DEBUG-PRICE hotel_id=' . (int) $hotelId .
                                            ' checkin=' . esc_html($checkin) .
                                            ' checkout=' . esc_html($checkout) .
                                            ' comp_row=' . ($comp ? 'YES' : 'NO') . ' -->';
                                    }

                                    if ($comp && !empty($comp['price_total'])) {
                                        $compPrice = (float) $comp['price_total'];
                                        $compText = 'Vergelijkbare kamer elders vanaf';
                                        $compProvider = !empty($comp['provider']) ? $comp['provider'] : '';
                                        $compDate = !empty($comp['fetched_at']) ? mysql2date('d-m-Y', $comp['fetched_at']) : '';
                                        ?>
                                        <div style="margin-top:4px;font-size:11px;color:#4b5563;line-height:1.4;">
                                            <span style="display:block;"><?= esc_html($compText); ?></span>
                                            <span style="display:block;font-weight:600;color:#047857;">
                                                ‚Ç¨ <?= number_format($compPrice, 2, ',', '.'); ?>
                                                <?php if ($compProvider): ?>
                                                    <span
                                                        style="font-weight:400;color:#6b7280;">(<?php echo esc_html($compProvider); ?>)</span>
                                                <?php endif; ?>
                                            </span>
                                            <?php if ($compDate): ?>
                                                <span style="display:block;color:#9ca3af;">(gecheckt op
                                                    <?php echo esc_html($compDate); ?>)</span>
                                            <?php endif; ?>
                                            <?php if (!empty($comp['deeplink'])): ?>
                                                <a href="<?php echo esc_url($comp['deeplink']); ?>" target="_blank"
                                                    rel="noopener noreferrer"
                                                    style="display:inline-block;margin-top:2px;font-size:11px;color:#2563eb;text-decoration:underline;">
                                                    Bekijk bij aanbieder
                                                </a>
                                            <?php endif; ?>
                                        </div>
                                        <?php
                                    }
                                }
                                ?>
                            </div>
                        </div>

                        <!-- Hotel foto -->
                        <div style="width:100%;margin-bottom:12px">
                            <?php if ($displayImg): ?>
                                <img src="<?= esc_url($displayImg); ?>" alt=""
                                    style="width:100%;height:200px;object-fit:cover;border-radius:8px" />
                            <?php else: ?>
                                <div
                                    style="width:100%;height:200px;background:#e5e7eb;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#94a3b8">
                                    Geen afbeelding</div>
                            <?php endif; ?>
                        </div>

                        <!-- Details onder de foto met icons en hover -->
                        <style>
                            .fs-hotel-detail {
                                display: flex;
                                align-items: flex-start;
                                gap: 10px;
                                padding: 8px;
                                border-radius: 6px;
                                transition: background-color 0.2s ease, transform 0.1s ease;
                            }

                            .fs-hotel-detail:hover {
                                background-color: #f9fafb;
                                transform: translateX(2px);
                            }

                            .fs-hotel-icon {
                                flex-shrink: 0;
                                width: 20px;
                                height: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: #2563eb;
                                font-size: 16px;
                            }

                            .fs-hotel-content {
                                flex: 1;
                                display: flex;
                                gap: 6px;
                                align-items: baseline;
                            }

                            .fs-hotel-label {
                                font-weight: 600;
                                color: #6b7280;
                                font-size: 13px;
                                white-space: nowrap;
                            }

                            .fs-hotel-value {
                                color: #111827;
                                font-size: 14px;
                                line-height: 1.4;
                            }
                        </style>
                        <div style="display:grid;gap:4px;margin-top:8px">
                            <?php if ($roomType): ?>
                                <div class="fs-hotel-detail">
                                    <div class="fs-hotel-icon">üõèÔ∏è</div>
                                    <div class="fs-hotel-content">
                                        <span class="fs-hotel-label">Kamer:</span>
                                        <span class="fs-hotel-value"><?= esc_html($roomType); ?></span>
                                    </div>
                                </div>
                            <?php endif; ?>

                            <?php if ($meal): ?>
                                <div class="fs-hotel-detail">
                                    <div class="fs-hotel-icon">üçΩÔ∏è</div>
                                    <div class="fs-hotel-content">
                                        <span class="fs-hotel-label">Verzorging:</span>
                                        <span class="fs-hotel-value"><?= esc_html($meal); ?></span>
                                    </div>
                                </div>
                            <?php endif; ?>

                            <div class="fs-hotel-detail">
                                <div class="fs-hotel-icon">üìÖ</div>
                                <div class="fs-hotel-content">
                                    <span class="fs-hotel-label">Data:</span>
                                    <span class="fs-hotel-value"><?= esc_html($checkin); ?> ‚Üí <?= esc_html($checkout); ?></span>
                                </div>
                            </div>

                            <div class="fs-hotel-detail">
                                <div class="fs-hotel-icon">üë•</div>
                                <div class="fs-hotel-content">
                                    <span class="fs-hotel-label">Bezetting:</span>
                                    <span class="fs-hotel-value">kamers <?= intval($rooms); ?> ‚Ä¢ volwassenen
                                        <?= intval($adults); ?> ‚Ä¢ kinderen <?= intval($children); ?></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h2
                        style="font-size:20px;font-weight:600;margin:0 0 16px 0;padding:12px 16px;background:rgba(37,99,235,0.5);color:#fff;border-radius:8px;">
                        Overzicht</h2>
                    <div id="st-summary" style="border:1px solid #e5e7eb;border-radius:12px;padding:12px">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span>Kamer
                                totaal</span><strong id="st-room-total"><?= number_format($roomTotal, 2, ',', '.'); ?> ‚Ç¨</strong>
                        </div>
                        <div
                            style="margin:10px 0;padding:10px;border:1px dashed #cbd5e1;border-radius:8px;background:#f8fafc">
                            <div style="font-weight:600;margin-bottom:6px">Indien u nog geen voucher hebt kies hieronder uw
                                optie</div>
                            <label style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
                                <input id="st-buy-fhc" type="checkbox"> <span
                                    style="font-size:13px;line-height:1.3">Freestays Hotel Cheque<br>eenmalig gebruik ‚Ç¨
                                    35,00</span>
                            </label>
                            <label style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
                                <input id="st-buy-fj" type="checkbox"> <span
                                    style="font-size:13px;line-height:1.3">Freestays jaarkaart<br>onbeperkt gebruik ‚Ç¨
                                    129,00</span>
                            </label>
                            <label style="display:flex;gap:8px;align-items:flex-start;margin-bottom:6px">
                                <input id="st-buy-welcome" type="checkbox">
                                <span style="font-size:13px;line-height:1.3">
                                    Gratis proberen met welkomstvoucher<br>
                                    <span style="color:#374151;font-size:12px;display:block;margin-top:2px">
                                        Registreer gratis en ontvang een eenmalige welkomstvoucher per e‚Äëmail.<br>
                                        Gebruik hem direct op deze boeking (<span id="st-welcome-benefit-text">Freestays
                                            voordeel op de kamerprijs</span>, 1x per e‚Äëmailadres).
                                    </span>
                                </span>
                            </label>
                            <div style="margin-top:8px">
                                <button id="st-apply-voucher-purchase" type="button" class="button"
                                    style="width:100%;border:none;border-radius:8px;padding:8px 12px;background:#2563eb;color:#fff;font-weight:600">Toepassen</button>
                            </div>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span
                                id="st-discount-label">Freestays voordeel</span><strong id="st-discount">- 0,00 ‚Ç¨</strong>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <span>Boekingskosten <span id="st-booking-fee-info"
                                    style="display:none;margin-left:6px;color:#2563eb;cursor:help;font-weight:600;font-size:18px;line-height:1"
                                    title="">?</span></span>
                            <strong id="st-booking-fee"><?= number_format($bookingFee, 2, ',', '.'); ?> ‚Ç¨</strong>
                        </div>
                        <div id="st-voucher-purchase-row"
                            style="display:none;justify-content:space-between;margin-bottom:6px"><span
                                id="st-voucher-purchase-label">Voucher (21%)</span><strong id="st-voucher-purchase">0,00
                                ‚Ç¨</strong></div>
                        <div style="display:none;justify-content:space-between;margin-bottom:6px"><span>Btw (kamer
                                9%)</span><strong id="st-vat">0,00 ‚Ç¨</strong></div>
                        <hr style="margin:8px 0">
                        <div style="display:flex;justify-content:space-between;font-size:18px"><span>Totaal</span><strong
                                id="st-grand-total"><?= number_format($roomTotal + $bookingFee, 2, ',', '.'); ?> ‚Ç¨</strong></div>
                        <p style="color:#6b7280;font-size:12px;margin-top:6px">Per boeking geldt altijd √©√©nmalig 15 euro
                            boekingskosten.</p>
                        <button id="st-pay-stripe" type="button"
                            style="display:none;margin-top:10px;width:100%;background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 12px;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center">Ga
                            naar betaling</button>
                        <p style="color:#6b7280;font-size:12px;margin-top:6px">Let op: de daadwerkelijke boeking bij
                            Freestays wordt pas uitgevoerd na succesvolle betaling.</p>

                        <?php if ($policy): ?>
                            <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:8px">
                                <span style="color:#6b7280;font-size:12px">Let op, deze boeking is:</span>
                                <?php
                                // Determine policy color and text based on content
                                $policyClass = 'background:#fee2e2;color:#991b1b;'; // default red for non-refundable
                                $policyText = $policy;

                                if (stripos($policy, 'Gratis annuleren') !== false) {
                                    $policyClass = 'background:#dcfce7;color:#166534;'; // green for free cancellation
                                } elseif (stripos($policy, 'Gedeeltelijk') !== false) {
                                    $policyClass = 'background:#fef3c7;color:#92400e;'; // yellow for partial refund
                        
                                    // Check if we can calculate -21 days from checkin for better display
                                    if ($checkin) {
                                        try {
                                            $checkinDate = new DateTime($checkin);
                                            $cutoffDate = clone $checkinDate;
                                            $cutoffDate->modify('-21 days');
                                            $now = new DateTime();

                                            if ($now <= $cutoffDate) {
                                                $policyText = 'Gedeeltelijk refundable tot ' . $cutoffDate->format('d-m-Y') . ' (21 dagen voor aankomst)';
                                            } else {
                                                $policyText = 'Gedeeltelijk refundable periode verstreken';
                                            }
                                        } catch (Exception $e) {
                                            // Keep original policy text if date parsing fails
                                        }
                                    }
                                }
                                ?>
                                <span class="inline-block"
                                    style="<?= $policyClass; ?>font-size:12px;padding:4px 10px;border-radius:6px;font-weight:600;white-space:nowrap"><?= esc_html($policyText); ?></span>
                            </div>
                        <?php endif; ?>
                        <a id="st-back-to-prebook" href="<?= esc_url($backToPrebookUrl); ?>"
                            style="display:block;margin-top:12px;width:100%;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:8px;padding:10px 12px;text-align:center;text-decoration:none;font-weight:600;">‚Üê
                            Pas de reservering aan</a>

                        <p style="display:none;color:#6b7280;font-size:12px;margin-top:4px">Voucher aanschaf (placeholder):
                            btw 21% wordt toegepast zodra voucherproducten via WooCommerce zijn toegevoegd.</p>
                    </div>
                </div>
            </div>

            <!-- Full width sectie vanaf Gegevens hoofdboeker -->
            <div id="fs-step-1">
                <div style="max-width:520px;">
                    <h2 class="text-xl font-semibold mb-2">Voucher</h2>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input id="st-voucher" type="text" placeholder="Vouchercode"
                            style="flex:1;border:1px solid #d1d5db;border-radius:8px;padding:8px" />
                        <button id="st-apply-voucher" type="button" class="button"
                            style="border:none;border-radius:8px;padding:8px 12px;background:#2563eb;color:#fff">Toepassen</button>
                    </div>
                    <div id="st-voucher-msg" style="margin-top:6px;font-size:12px;color:#065f46;display:none"></div>
                </div>

                <h2 class="text-xl font-semibold mb-2">Gegevens hoofdboeker</h2>
                <form id="st-checkout-form" class="space-y-3">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div><label
                                style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Voornaam</label><input
                                name="first_name" type="text" required
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                        <div><label
                                style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Achternaam</label><input
                                name="last_name" type="text" required
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div><label
                                style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">E‚Äëmail</label><input
                                name="email" type="email" required
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                        <div><label
                                style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Telefoon</label><input
                                name="phone" type="tel" required
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                    </div>
                    <p style="font-size:12px;color:#374151;margin:4px 0 2px 0">You need to create your account to access
                        your Dashboard</p>
                    <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
                        <input id="st-create-account" type="checkbox"> <span>Account aanmaken</span>
                    </label>
                    <div id="st-account-fields" style="display:none">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                            <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Password
                                    *</label><input id="st-pass" name="password" type="password"
                                    style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                            <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Password
                                    confirmation *</label><input id="st-pass2" name="password_confirm" type="password"
                                    style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Address line
                                1</label><input name="addr1" type="text"
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                        <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Address line
                                2</label><input name="addr2" type="text"
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">City</label><input
                                name="city" type="text"
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                        <div><label
                                style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">State/Province/Region</label><input
                                name="state" type="text"
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">ZIP code/Postal
                                code</label><input name="zip" type="text"
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                        <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Country
                                *</label><input name="country" type="text" required
                                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                    </div>
                    <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Opmerkingen
                            (optioneel)</label><textarea name="notes" rows="3"
                            style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></textarea></div>
                </form>

                <h2 class="text-xl font-semibold mt-5 mb-2">Gegevens medereiziger</h2>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                    <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Voornaam</label><input
                            name="co_first_name" form="st-checkout-form" type="text"
                            style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                    <div><label
                            style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Achternaam</label><input
                            name="co_last_name" form="st-checkout-form" type="text"
                            style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                </div>

                <?php if ($children > 0): ?>
                    <h2 class="text-xl font-semibold mt-5 mb-2">Gegevens kinderen</h2>
                    <div style="display:grid;grid-template-columns:1fr;gap:8px">
                        <?php for ($i = 1; $i <= $children; $i++):
                            $ageSel = isset($childAgesArr[$i - 1]) ? (int) $childAgesArr[$i - 1] : null; ?>
                            <div style="display:grid;grid-template-columns:1fr 1fr 140px;gap:8px;align-items:end">
                                <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Voornaam kind
                                        <?= $i; ?></label><input name="child<?= $i; ?>_first_name" form="st-checkout-form" type="text"
                                        style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                                <div><label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Achternaam kind
                                        <?= $i; ?></label><input name="child<?= $i; ?>_last_name" form="st-checkout-form" type="text"
                                        style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px"></div>
                                <div>
                                    <label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px">Leeftijd</label>
                                    <select name="child<?= $i; ?>_age" form="st-checkout-form"
                                        style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px">
                                        <?php for ($a = 0; $a <= 17; $a++): ?>
                                            <option value="<?= $a; ?>" <?= $ageSel !== null && $ageSel === $a ? ' selected' : ''; ?>><?= $a; ?>
                                            </option>
                                        <?php endfor; ?>
                                    </select>
                                </div>
                            </div>
                        <?php endfor; ?>
                    </div>
                <?php endif; ?>

                <h2 class="text-xl font-semibold mt-5 mb-2">Cancellation Policies</h2>
                <div
                    style="font-size:12px;color:#374151;background:#fff7ed;border:1px solid #fde68a;border-radius:8px;padding:10px">
                    * Please note that this room is non-refundable and non-amendable. If the booking is cancelled, no money
                    will be refunded.
                </div>

                <h2 class="text-xl font-semibold mt-5 mb-2">Booking Notes</h2>
                <div style="font-size:12px;color:#374151;border:1px solid #e5e7eb;border-radius:8px;padding:10px">
                    <div>Rate Notes: Hotel Tariff Notes: Check-in Time: 15:00 Reception is open with limited time.</div>
                    <label style="display:flex;gap:8px;align-items:center;margin-top:8px">
                        <input id="st-notes-agree" form="st-checkout-form" type="checkbox" required> <span>Ik ga akkoord met
                            de Rate Notes en annuleringsvoorwaarden</span>
                    </label>
                </div>

                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                    <button id="fs-next" type="button"
                        style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 12px;cursor:pointer">Verder</button>
                </div>

                <div id="fs-step-2" style="display:none">
                    <h2 class="text-xl font-semibold mt-5 mb-2">Bevestig uw gegevens</h2>
                    <div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                            <div>
                                <div style="color:#6b7280;font-size:12px">Voornaam</div>
                                <div id="fs-c-first" style="font-weight:600"></div>
                            </div>
                            <div>
                                <div style="color:#6b7280;font-size:12px">Achternaam</div>
                                <div id="fs-c-last" style="font-weight:600"></div>
                            </div>
                            <div>
                                <div style="color:#6b7280;font-size:12px">E‚Äëmail</div>
                                <div id="fs-c-email" style="font-weight:600"></div>
                            </div>
                            <div>
                                <div style="color:#6b7280;font-size:12px">Telefoon</div>
                                <div id="fs-c-phone" style="font-weight:600"></div>
                            </div>
                            <div>
                                <div style="color:#6b7280;font-size:12px">Adres</div>
                                <div id="fs-c-addr" style="font-weight:600"></div>
                            </div>
                            <div>
                                <div style="color:#6b7280;font-size:12px">Plaats</div>
                                <div id="fs-c-city" style="font-weight:600"></div>
                            </div>
                        </div>
                        <div style="margin-top:8px">
                            <div style="color:#6b7280;font-size:12px">Voucher</div>
                            <div id="fs-c-voucher" style="font-weight:600"></div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px">
                        <button id="fs-back" type="button"
                            style="background:#f3f4f6;color:#111827;border:1px solid #d1d5db;border-radius:8px;padding:10px 12px;cursor:pointer">Terug</button>
                        <!-- Betalen-knop staat in samenvatting rechts en wordt in stap 2 zichtbaar -->
                    </div>
                </div><!-- /fs-step-2 -->
            </div><!-- /fs-step-1 -->

        </div><!-- /fs-checkout-container -->
    </div>

    <script>(function () {
            var baseTotal = <?= json_encode($roomTotal); ?>;
            var bookingFeeBase = <?= json_encode($bookingFee); ?>;
            var bookingFeeCurrent = bookingFeeBase;
            var isMockMode = <?= $isMockPrebook ? 'true' : 'false'; ?>;
            if (isMockMode) {
                console.info('ShortTrips prebook mock modus: geen SunHotels API-verkeer.');
            }
            var purchaseCost = 0; // voucher product cost (21%)
            var currentDiscount = 0; // preview discount applied
            var voucherPurchaseType = ''; // 'fhc', 'fj', or empty
            var meal = <?= json_encode($meal); ?>;
            var ctx = <?= json_encode([
                'hotelId' => $hotelId,
                'checkin' => $checkin,
                'checkout' => $checkout,
                'rooms' => $rooms,
                'adults' => $adults,
                'children' => $children,
                'childAges' => $childAges,
                'roomType' => $roomType,
                'meal' => $meal,
                'policy' => $policy,
                'image' => $displayImg,
                'roomId' => $roomId,
                'roomTotal' => $roomTotal,
                'mock' => $isMockPrebook,
                'prebookUrl' => $backToPrebookUrl,
            ]); ?>;
            function fmt(n) { return (n || 0).toFixed(2).replace('.', ','); }
            function applyVoucher() {
                var code = (document.getElementById('st-voucher').value || '').trim();
                var msg = document.getElementById('st-voucher-msg');
                var discount = 0;
                var m = (meal || '').toLowerCase();
                if (!code) { msg.style.display = 'none'; currentDiscount = 0; updateTotals(0); return; }

                // Valideer voucher code via AJAX
                var fd = new FormData();
                fd.append('action', 'validate_voucher_code');
                fd.append('code', code);

                fetch(<?= json_encode(admin_url('admin-ajax.php')); ?>, {
                    method: 'POST',
                    body: fd,
                    credentials: 'same-origin'
                })
                    .then(function (r) { return r.json(); })
                    .then(function (data) {
                        if (!data.success) {
                            // Ongeldige code - toon popup
                            var popup = document.createElement('div');
                            popup.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
                            popup.innerHTML = '<div style="background:#fff;border-radius:12px;padding:24px;max-width:400px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)">' +
                                '<h3 style="font-size:18px;font-weight:600;color:#111827;margin:0 0 12px 0">‚ùå Ongeldige vouchercode</h3>' +
                                '<p style="color:#6b7280;margin:0 0 16px 0">De ingevoerde code "' + code + '" is niet geldig of is al gebruikt.</p>' +
                                '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="width:100%;background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 12px;cursor:pointer;font-weight:600">Probeer opnieuw</button>' +
                                '</div>';
                            document.body.appendChild(popup);
                            msg.style.display = 'none';
                            return;
                        }

                        // Geldige code - pas korting/voordeel toe
                        discount = baseTotal * 0.15;

                        // Voor Half/Full board en All inclusive:
                        //   "Verblijf inbegrepen via Freestays"
                        var popupText = '';
                        if (m.indexOf('half') !== -1 || m.indexOf('vol') !== -1 || m.indexOf('full') !== -1 || m.indexOf('all') !== -1) {
                            popupText = 'Je verblijf is inbegrepen bij dit arrangement via Freestays.';
                            msg.textContent = popupText;
                        } else {
                            // Room only + Breakfast: benoemen als Freestays voordeel
                            popupText = 'Je Freestays voordeel is verwerkt (' + fmt(discount) + ' ‚Ç¨ op de kamerprijs).';
                            msg.textContent = popupText;
                        }
                        msg.style.display = 'block';
                        msg.style.fontWeight = '600';
                        msg.style.color = '#065f46';

                        // üéâ Toon als popup
                        showDiscountPopup(popupText);
                        currentDiscount = discount;
                        updateDiscountLabel();
                        updateTotals(currentDiscount);

                        // Scroll terug naar boven voor overzicht
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    })
                    .catch(function () {
                        alert('Er ging iets mis bij het valideren van de code. Probeer het opnieuw.');
                    });
            }
            function updateTotals(discount) {
                var roomEl = document.getElementById('st-room-total');
                var discEl = document.getElementById('st-discount');
                var grandEl = document.getElementById('st-grand-total');
                var vatEl = document.getElementById('st-vat');
                var total = Math.max(0, baseTotal - (discount || 0)) + bookingFeeCurrent + (purchaseCost || 0);
                var vatRoom = (Math.max(0, baseTotal - (discount || 0)) * 9.0 / 109.0);
                roomEl.textContent = fmt(baseTotal) + ' ‚Ç¨';
                discEl.textContent = '- ' + fmt(discount || 0) + ' ‚Ç¨';
                grandEl.textContent = fmt(total) + ' ‚Ç¨';
                vatEl.textContent = fmt(vatRoom) + ' ‚Ç¨';
                var bf = document.getElementById('st-booking-fee'); if (bf) { bf.textContent = fmt(bookingFeeCurrent) + ' ‚Ç¨'; }
                var vp = document.getElementById('st-voucher-purchase'); if (vp) { vp.textContent = fmt(purchaseCost || 0) + ' ‚Ç¨'; }
            }
            document.getElementById('st-apply-voucher').addEventListener('click', applyVoucher);
            // Step control with thin progress bar + fade animation
            function fadeIn(el) { if (!el) return; el.style.display = 'block'; el.style.opacity = '0'; el.style.transform = 'translateY(6px)'; el.style.transition = 'opacity .25s ease, transform .25s ease'; requestAnimationFrame(function () { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; }); }
            function fadeOut(el, cb) { if (!el) return cb && cb(); el.style.transition = 'opacity .2s ease, transform .2s ease'; el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; setTimeout(function () { el.style.display = 'none'; cb && cb(); }, 200); }
            function setStep(n) {
                var s1 = document.getElementById('fs-step-1'); var s2 = document.getElementById('fs-step-2');
                var p1 = document.getElementById('fs-step-pill-1'); var p2 = document.getElementById('fs-step-pill-2');
                var bar = document.getElementById('fs-progress');
                if (n === 1) {
                    if (bar) { bar.style.width = '50%'; }
                    if (p1) { p1.style.background = '#dbeafe'; p1.style.borderColor = '#93c5fd'; p1.style.color = '#1e40af'; }
                    if (p2) { p2.style.background = '#f9fafb'; p2.style.borderColor = '#e5e7eb'; p2.style.color = '#6b7280'; }
                    var pay = document.getElementById('st-pay-stripe'); if (pay) pay.style.display = 'none';
                    fadeOut(s2, function () { fadeIn(s1); });
                } else {
                    if (bar) { bar.style.width = '100%'; }
                    if (p2) { p2.style.background = '#dbeafe'; p2.style.borderColor = '#93c5fd'; p2.style.color = '#1e40af'; }
                    if (p1) { p1.style.background = '#f9fafb'; p1.style.borderColor = '#e5e7eb'; p1.style.color = '#6b7280'; }
                    var pay2 = document.getElementById('st-pay-stripe'); if (pay2) pay2.style.display = 'block';
                    fadeOut(s1, function () { fadeIn(s2); });
                }
            }
            var nextBtn = document.getElementById('fs-next');
            if (nextBtn) {
                nextBtn.addEventListener('click', function () {
                    // Basic validation
                    var req = ['first_name', 'last_name', 'email', 'phone']; var ok = true; var form = document.getElementById('st-checkout-form');
                    req.forEach(function (n) { var el = form.querySelector('[name="' + n + '"]'); if (el && !el.value) { el.style.borderColor = '#ef4444'; ok = false; } else if (el) { el.style.borderColor = '#d1d5db'; } });
                    if (!ok) { alert('Vul voornaam, achternaam, e‚Äëmail en telefoon in.'); return; }
                    // Must accept booking notes/terms before proceeding to step 2
                    var notesAgree = document.getElementById('st-notes-agree');
                    if (notesAgree && !notesAgree.checked) { alert('Vink akkoord aan bij Booking Notes.'); return; }

                    // Check voucher purchase checkboxes (in case user didn't click "Toepassen")
                    var fhcCheck = document.getElementById('st-buy-fhc');
                    var fjCheck = document.getElementById('st-buy-fj');

                    // DEBUG: Log values for troubleshooting
                    console.log('DEBUG Verder button:', {
                        fhcChecked: fhcCheck ? fhcCheck.checked : 'element not found',
                        fjChecked: fjCheck ? fjCheck.checked : 'element not found',
                        voucherPurchaseType: voucherPurchaseType,
                        shouldShowPopup: ((fhcCheck && fhcCheck.checked && !voucherPurchaseType) || (fjCheck && fjCheck.checked && !voucherPurchaseType))
                    });

                    // Check if user selected voucher but didn't click "Toepassen"
                    if ((fhcCheck && fhcCheck.checked && !voucherPurchaseType) ||
                        (fjCheck && fjCheck.checked && !voucherPurchaseType)) {
                        // Show inline popup
                        var popup = document.createElement('div');
                        popup.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999';
                        popup.innerHTML = '<div style="background:#fff;border-radius:12px;padding:24px;max-width:400px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)">' +
                            '<h3 style="font-size:18px;font-weight:600;color:#111827;margin:0 0 12px 0">‚ö†Ô∏è Voucher niet toegepast</h3>' +
                            '<p style="color:#6b7280;margin:0 0 16px 0">U heeft een voucher geselecteerd maar nog niet toegepast.<br><br><strong>Klik eerst op "Toepassen"</strong> om de korting te activeren voordat u doorgaat naar de betaling.</p>' +
                            '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="width:100%;background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 12px;cursor:pointer;font-weight:600">Ik snap het</button>' +
                            '</div>';
                        document.body.appendChild(popup);
                        return; // Stop going to step 2
                    }

                    // Fill confirmation
                    var get = function (n) { var el = form.querySelector('[name="' + n + '"]'); return el ? el.value : ''; };
                    var addr = [get('addr1'), get('addr2')].filter(Boolean).join(', ');
                    var cityline = [get('zip'), get('city'), get('state'), get('country')].filter(Boolean).join(' ');
                    var vEl = document.getElementById('st-voucher');
                    document.getElementById('fs-c-first').textContent = get('first_name');
                    document.getElementById('fs-c-last').textContent = get('last_name');
                    document.getElementById('fs-c-email').textContent = get('email');
                    document.getElementById('fs-c-phone').textContent = get('phone');
                    document.getElementById('fs-c-addr').textContent = addr;
                    document.getElementById('fs-c-city').textContent = cityline;
                    document.getElementById('fs-c-voucher').textContent = (vEl && vEl.value) ? vEl.value : (document.getElementById('st-buy-fhc')?.checked ? 'Hotel Cheque' : (document.getElementById('st-buy-fj')?.checked ? 'Jaarkaart' : ''));
                    setStep(2);
                });
            }
            var backBtn = document.getElementById('fs-back'); if (backBtn) { backBtn.addEventListener('click', function () { setStep(1); }); }
            setStep(1);

            // NOTE: st-pay-stripe event listener is now defined AFTER updateVoucherRow() 
            // to avoid duplicate listeners. See line ~5105 for the actual implementation.

            // Init totals including VAT on first render
            updateTotals(0);

            // Account toggle: show/hide and require passwords
            var cb = document.getElementById('st-create-account');
            var wrap = document.getElementById('st-account-fields');
            var p1 = document.getElementById('st-pass');
            var p2 = document.getElementById('st-pass2');
            if (cb && wrap) {
                cb.addEventListener('change', function () {
                    var on = !!cb.checked; wrap.style.display = on ? 'block' : 'none';
                    if (p1) p1.required = on; if (p2) p2.required = on;
                });
            }

            // Update discount label based on meal type
            function updateDiscountLabel() {
                var m = (meal || '').toLowerCase();
                var discountLabel = document.getElementById('st-discount-label');
                var welcomeTextSpan = document.getElementById('st-welcome-benefit-text');
                if (!discountLabel) return;

                // Voor Half board, Full board en All inclusive:
                //   toon "Verblijf inbegrepen via Freestays"
                // Voor Room Only en Breakfast:
                //   toon "Freestays voordeel"
                if (m.indexOf('half') !== -1 || m.indexOf('vol') !== -1 || m.indexOf('full') !== -1 || m.indexOf('all') !== -1) {
                    discountLabel.textContent = 'Verblijf inbegrepen via Freestays';
                    if (welcomeTextSpan) {
                        welcomeTextSpan.textContent = 'Verblijf inbegrepen via Freestays';
                    }
                } else {
                    discountLabel.textContent = 'Freestays voordeel';
                    if (welcomeTextSpan) {
                        welcomeTextSpan.textContent = 'Freestays voordeel op de kamerprijs';
                    }
                }
            }

            // Update voucher purchase row visibility and label
            function updateVoucherRow() {
                var fhc = document.getElementById('st-buy-fhc');
                var fj = document.getElementById('st-buy-fj');
                var fw = document.getElementById('st-buy-welcome');
                var row = document.getElementById('st-voucher-purchase-row');
                var label = document.getElementById('st-voucher-purchase-label');

                if (!row || !label) return;

                var a = fhc && fhc.checked;
                var b = fj && fj.checked;
                var c = fw && fw.checked;

                if (a || b || c) {
                    row.style.display = 'flex';
                    if (a) {
                        label.innerHTML = 'Freestays Hotel Cheque<br>eenmalig gebruik';
                    } else if (b) {
                        label.innerHTML = 'Freestays jaarkaart<br>onbeperkt gebruik';
                    } else if (c) {
                        label.innerHTML = 'Welkomstvoucher<br>Verblijf inbegrepen / Freestays voordeel';
                    }
                } else {
                    row.style.display = 'none';
                }
            }

            function updateBookingFeeInfo(type) {
                var info = document.getElementById('st-booking-fee-info');
                if (type === 'fhc') {
                    bookingFeeCurrent = 0;
                    if (info) {
                        info.style.display = 'inline';
                        info.title = 'Uw selectie is toegepast, wij verrekenen uw boekingskosten eenmalig met uw Voucher.';
                    }
                } else if (type === 'fj') {
                    bookingFeeCurrent = 0;
                    if (info) {
                        info.style.display = 'inline';
                        info.title = 'Uw selectie is toegepast, wij verrekenen uw boekingskosten eenmalig met uw Jaarkaart.';
                    }
                } else {
                    bookingFeeCurrent = bookingFeeBase;
                    if (info) {
                        info.style.display = 'none';
                        info.title = '';
                    }
                }
            }

            // Apply voucher purchase selection to preview totals
            var btnApplyPurchase = document.getElementById('st-apply-voucher-purchase');
            if (btnApplyPurchase) {
                btnApplyPurchase.addEventListener('click', function () {
                    var fhc = document.getElementById('st-buy-fhc');
                    var fj = document.getElementById('st-buy-fj');
                    var fw = document.getElementById('st-buy-welcome');
                    var a = fhc && fhc.checked;
                    var b = fj && fj.checked;
                    var c = fw && fw.checked;
                    var checkedCount = (a ? 1 : 0) + (b ? 1 : 0) + (c ? 1 : 0);
                    if (checkedCount > 1) { alert('Kies maximaal √©√©n voucheroptie.'); return; }
                    if (!a && !b && !c) {
                        purchaseCost = 0;
                        currentDiscount = 0;
                        voucherPurchaseType = ''; // Reset
                        updateBookingFeeInfo('');
                        updateTotals(currentDiscount);
                        updateVoucherRow();
                        var msg = document.getElementById('st-voucher-msg');
                        if (msg) { msg.style.display = 'none'; }
                        return;
                    }

                    // Bepaal type
                    if (a) {
                        purchaseCost = 35.00;
                        voucherPurchaseType = 'fhc';
                    } else if (b) {
                        purchaseCost = 129.00;
                        voucherPurchaseType = 'fj';
                    } else if (c) {
                        purchaseCost = 0.00;
                        voucherPurchaseType = 'welcome';
                    }
                    updateBookingFeeInfo(voucherPurchaseType);

                    // DEBUG: Log voucher type set
                    console.log('DEBUG Toepassen button:', {
                        voucherPurchaseType: voucherPurchaseType,
                        purchaseCost: purchaseCost
                    });

                    // Preview discount per meal
                    var m = (meal || '').toLowerCase();
                    var msg = document.getElementById('st-voucher-msg');
                    var isJaarkaart = b; // b = fj.checked (jaarkaart)

                    // Voor Half board, Full board en All inclusive:
                    //   "Verblijf inbegrepen via Freestays"
                    var popupText = '';
                    if (m.indexOf('half') !== -1 || m.indexOf('vol') !== -1 || m.indexOf('full') !== -1 || m.indexOf('all') !== -1) {
                        // Half/Full board, All inclusive: 15% korting (= kamerprijs)
                        currentDiscount = baseTotal * 0.15;
                        popupText = 'Je verblijf is inbegrepen bij dit arrangement via Freestays.';
                        // Zelfde tekst voor Hotel Cheque en Jaarkaart met styling zoals titel,
                        // maar zonder het woord \"gratis\" te gebruiken.
                        if (msg) {
                            msg.textContent = popupText;
                            msg.style.display = 'block';
                            msg.style.fontWeight = '600';
                            msg.style.color = '#065f46';
                        }
                    } else {
                        // Room only + Breakfast: 15% korting ‚Üí benoemen als Freestays voordeel
                        currentDiscount = baseTotal * 0.15;
                        popupText = 'Je Freestays voordeel is verwerkt (' + fmt(currentDiscount) + ' ‚Ç¨ op de kamerprijs).';
                        if (msg) {
                            msg.textContent = popupText;
                            msg.style.display = 'block';
                            msg.style.fontWeight = '600';
                            msg.style.color = '#065f46';
                        }
                    }

                    // Als de welkomstoptie is gekozen, zorg dat accountaanmaak aanstaat (voor niet-ingelogde gebruikers)
                    if (c) {
                        var cb = document.getElementById('st-create-account');
                        var wrap = document.getElementById('st-account-fields');
                        var p1 = document.getElementById('st-pass');
                        var p2 = document.getElementById('st-pass2');
                        if (cb && wrap) {
                            cb.checked = true;
                            wrap.style.display = 'block';
                            if (p1) p1.required = true;
                            if (p2) p2.required = true;
                        }
                    }

                    // üéâ Toon als popup
                    showDiscountPopup(popupText);
                    updateDiscountLabel();
                    updateVoucherRow();
                    updateTotals(currentDiscount);

                    // Scroll terug naar boven voor overzicht
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
            // Initialize labels
            updateDiscountLabel();

            // Back to prebook button - ga terug naar stap 1 (formulier blijft intact!)
            // "Ga naar betaling" button - Create WooCommerce Order
            var payBtn = document.getElementById('st-pay-stripe');
            console.log('DEBUG payBtn:', payBtn); // Check if button is found
            if (payBtn) {
                payBtn.addEventListener('click', function () {
                    console.log('DEBUG Ga naar betaling clicked!'); // Check if click works

                    // Disable button
                    payBtn.disabled = true;
                    payBtn.textContent = 'Order aanmaken...';
                    payBtn.style.opacity = '0.6';

                    // Basic validation - check required fields manually
                    var firstName = document.querySelector('[name=first_name]');
                    var lastName = document.querySelector('[name=last_name]');
                    var emailField = document.querySelector('[name=email]');
                    var phoneField = document.querySelector('[name=phone]');

                    if (!firstName || !firstName.value || !lastName || !lastName.value ||
                        !emailField || !emailField.value || !phoneField || !phoneField.value) {
                        alert('Vul alle verplichte velden in (voornaam, achternaam, email, telefoon).');
                        payBtn.disabled = false;
                        payBtn.textContent = 'Ga naar betaling';
                        payBtn.style.opacity = '1';
                        return;
                    }

                    // Get all form data
                    var formData = new FormData();
                    formData.append('action', 'freestays_create_order');
                    formData.append('nonce', '<?php echo wp_create_nonce("freestays_checkout"); ?>');

                    // Hotel data from URL params
                    formData.append('hotel_id', ctx.hotelId);
                    formData.append('checkin', ctx.checkin);
                    formData.append('checkout', ctx.checkout);
                    formData.append('rooms', ctx.rooms);
                    formData.append('adults', ctx.adults);
                    formData.append('children', ctx.children);
                    formData.append('child_ages', ctx.childAges || '');
                    formData.append('room_type', ctx.roomType || '');
                    formData.append('meal', ctx.meal || '');
                    formData.append('policy', ctx.policy || '');
                    formData.append('price', ctx.roomTotal);
                    formData.append('room_id', ctx.roomId || '');

                    // Customer data from form
                    var firstName = document.querySelector('[name=first_name]');
                    var lastName = document.querySelector('[name=last_name]');
                    var emailField = document.querySelector('[name=email]');
                    var phoneField = document.querySelector('[name=phone]');
                    var addressField = document.querySelector('[name=address]');
                    var postcodeField = document.querySelector('[name=postcode]');
                    var cityField = document.querySelector('[name=city]');
                    var countryField = document.querySelector('[name=country]');

                    formData.append('first_name', firstName ? firstName.value : '');
                    formData.append('last_name', lastName ? lastName.value : '');
                    formData.append('email', emailField ? emailField.value : '');
                    formData.append('phone', phoneField ? phoneField.value : '');
                    formData.append('address', addressField ? addressField.value : '');
                    formData.append('postcode', postcodeField ? postcodeField.value : '');
                    formData.append('city', cityField ? cityField.value : '');
                    formData.append('country', countryField ? countryField.value : 'NL');

                    // Account data (for optional account creation / welkomstvoucher flow)
                    var cbCreate = document.getElementById('st-create-account');
                    var pass1 = document.getElementById('st-pass');
                    var pass2 = document.getElementById('st-pass2');
                    var wantsAccount = cbCreate && cbCreate.checked;
                    if (wantsAccount) {
                        // Simple front-end check op wachtwoord match
                        if (pass1 && pass2 && pass1.value && pass1.value === pass2.value) {
                            formData.append('create_account', '1');
                            formData.append('password', pass1.value);
                        } else {
                            alert('Controleer het wachtwoord: beide velden moeten ingevuld en gelijk zijn.');
                            payBtn.disabled = false;
                            payBtn.textContent = 'Ga naar betaling';
                            payBtn.style.opacity = '1';
                            return;
                        }
                    } else {
                        formData.append('create_account', '0');
                    }

                    // Voucher data
                    var voucherInput = document.getElementById('st-voucher');
                    var inputCode = voucherInput ? voucherInput.value.trim() : '';

                    // BELANGRIJK: Als voucher purchase is aangevinkt, geen code meegeven
                    // (code wordt pas NA betaling gegenereerd of toegewezen!)
                    if (voucherPurchaseType) {
                        formData.append('voucher_code', ''); // Geen bestaande code
                        formData.append('voucher_purchase', voucherPurchaseType);
                    } else {
                        formData.append('voucher_code', inputCode);
                        formData.append('voucher_purchase', '');
                    }

                    // Create order via AJAX
                    fetch('<?php echo admin_url("admin-ajax.php"); ?>', {
                        method: 'POST',
                        body: formData
                    })
                        .then(function (response) {
                            return response.json();
                        })
                        .then(function (data) {
                            if (!data.success) {
                                alert('Fout bij order aanmaken: ' + (data.data ? data.data.message : 'Onbekende fout'));
                                payBtn.disabled = false;
                                payBtn.textContent = 'Ga naar betaling';
                                payBtn.style.opacity = '1';
                                return;
                            }

                            // Success! Redirect naar WooCommerce checkout
                            console.log('Order created:', data.data.order_id);
                            window.location.href = data.data.checkout_url;
                        })
                        .catch(function (error) {
                            console.error('Error:', error);
                            alert('Er ging iets mis. Probeer het opnieuw.');
                            payBtn.disabled = false;
                            payBtn.textContent = 'Ga naar betaling';
                            payBtn.style.opacity = '1';
                        });
                });
            }

            // üéâ Popup functie voor korting bevestiging
            function showDiscountPopup(message) {
                // Verwijder oude popup als die bestaat
                var oldPopup = document.getElementById('st-discount-popup');
                if (oldPopup) oldPopup.remove();

                // Maak popup element
                var popup = document.createElement('div');
                popup.id = 'st-discount-popup';
                popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;background:#fff;padding:40px 60px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center;max-width:90%;animation:popupFadeIn 0.3s ease;';

                // Message text (2x groter)
                var text = document.createElement('div');
                text.textContent = message;
                text.style.cssText = 'font-size:28px;font-weight:600;color:#065f46;margin-bottom:24px;line-height:1.4;';

                // Success icon
                var icon = document.createElement('div');
                icon.textContent = 'üéâ';
                icon.style.cssText = 'font-size:64px;margin-bottom:20px;';

                // Close button
                var closeBtn = document.createElement('button');
                closeBtn.textContent = 'Sluit';
                closeBtn.style.cssText = 'background:#2563eb;color:#fff;border:none;border-radius:8px;padding:12px 32px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.2s;';
                closeBtn.onmouseover = function () { this.style.background = '#1e40af'; };
                closeBtn.onmouseout = function () { this.style.background = '#2563eb'; };
                closeBtn.onclick = function () {
                    popup.style.animation = 'popupFadeOut 0.2s ease';
                    setTimeout(function () { popup.remove(); overlay.remove(); }, 200);
                };

                // Backdrop overlay
                var overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9998;animation:overlayFadeIn 0.3s ease;';
                overlay.onclick = function () { closeBtn.click(); };

                // Voeg alles samen
                popup.appendChild(icon);
                popup.appendChild(text);
                popup.appendChild(closeBtn);
                document.body.appendChild(overlay);
                document.body.appendChild(popup);

                // Auto close na 4 seconden
                setTimeout(function () {
                    if (document.getElementById('st-discount-popup')) {
                        closeBtn.click();
                    }
                }, 4000);
            }

            // Voeg CSS animations toe
            var style = document.createElement('style');
            style.textContent = '@keyframes popupFadeIn { from { opacity:0; transform:translate(-50%,-50%) scale(0.8); } to { opacity:1; transform:translate(-50%,-50%) scale(1); } } @keyframes popupFadeOut { from { opacity:1; transform:translate(-50%,-50%) scale(1); } to { opacity:0; transform:translate(-50%,-50%) scale(0.8); } } @keyframes overlayFadeIn { from { opacity:0; } to { opacity:1; } }';
            document.head.appendChild(style);

        })();</script>
    <!-- Checkout script v1.3 - WooCommerce order creation -->
    <?php
    return ob_get_clean();
});
// -----------------------------------------------------------------------------
// WooCommerce integration for booking request ‚Üí cart ‚Üí checkout
// -----------------------------------------------------------------------------
if (function_exists('WC')) {

    // Ensure virtual booking product exists (hidden, 0‚Ç¨; dynamic price applied later)
    function freestays_ensure_booking_product_id()
    {
        $pid = (int) get_option('freestays_booking_product_id', 0);
        if ($pid > 0 && get_post_status($pid)) {
            return $pid;
        }
        $pid = wp_insert_post([
            'post_title' => 'Boekingsaanvraag',
            'post_status' => 'publish',
            'post_type' => 'product',
            'post_content' => 'Freestays boekingsaanvraag (virtueel).'
        ]);
        if ($pid && !is_wp_error($pid)) {
            update_post_meta($pid, '_virtual', 'yes');
            update_post_meta($pid, '_regular_price', '0');
            update_post_meta($pid, '_price', '0');
            update_post_meta($pid, '_sold_individually', 'yes');
            update_post_meta($pid, '_downloadable', 'no');
            update_post_meta($pid, '_tax_status', 'taxable');
            // Set reduced VAT class for room (configure rates in WooCommerce > Settings > Tax)
            update_post_meta($pid, '_tax_class', 'reduced-rate');
            update_option('freestays_booking_product_id', (int) $pid);
            return (int) $pid;
        }
        return 0;
    }

    // AJAX: prepare cart with booking request and redirect to WC checkout
    add_action('wp_ajax_freestays_wc_prepare', 'freestays_wc_prepare');
    add_action('wp_ajax_nopriv_freestays_wc_prepare', 'freestays_wc_prepare');
    function freestays_wc_prepare()
    {
        if (!function_exists('WC')) {
            wp_send_json_error(['message' => 'WooCommerce niet actief']);
        }
        // Basic fields
        $email = sanitize_email($_POST['email'] ?? '');
        $first = sanitize_text_field($_POST['first_name'] ?? '');
        $last = sanitize_text_field($_POST['last_name'] ?? '');
        if ($email === '' || $first === '' || $last === '') {
            wp_send_json_error(['message' => 'Vul voornaam, achternaam en e‚Äëmail in.']);
        }

        $createAccount = !empty($_POST['create_account']) && $_POST['create_account'] === '1';
        $password = isset($_POST['password']) ? (string) $_POST['password'] : '';
        $userId = get_current_user_id();

        if ($createAccount && !$userId) {
            if ($password === '' || strlen($password) < 6) {
                wp_send_json_error(['message' => 'Kies een wachtwoord (min. 6 tekens).']);
            }
            $username = sanitize_user(current(explode('@', $email)));
            if (username_exists($username)) {
                $username = $username . '_' . wp_generate_password(4, false);
            }
            $uid = wc_create_new_customer($email, $username, $password);
            if (is_wp_error($uid)) {
                wp_send_json_error(['message' => 'Account aanmaken mislukt: ' . $uid->get_error_message()]);
            }
            $userId = (int) $uid;
            wc_set_customer_auth_cookie($userId);
        }

        // Update billing details on user and session
        if ($userId) {
            update_user_meta($userId, 'first_name', $first);
            update_user_meta($userId, 'last_name', $last);
            $map = [
                'billing_first_name' => $first,
                'billing_last_name' => $last,
                'billing_email' => $email,
                'billing_phone' => sanitize_text_field($_POST['phone'] ?? ''),
                'billing_address_1' => sanitize_text_field($_POST['addr1'] ?? ''),
                'billing_address_2' => sanitize_text_field($_POST['addr2'] ?? ''),
                'billing_city' => sanitize_text_field($_POST['city'] ?? ''),
                'billing_state' => sanitize_text_field($_POST['state'] ?? ''),
                'billing_postcode' => sanitize_text_field($_POST['zip'] ?? ''),
                'billing_country' => sanitize_text_field($_POST['country'] ?? ''),
            ];
            foreach ($map as $k => $v) {
                update_user_meta($userId, $k, $v);
            }
        }

        // Booking context
        $ctx = [
            'hotelId' => intval($_POST['hotelId'] ?? 0),
            'checkin' => sanitize_text_field($_POST['checkin'] ?? ''),
            'checkout' => sanitize_text_field($_POST['checkout'] ?? ''),
            'rooms' => max(1, intval($_POST['rooms'] ?? 1)),
            'adults' => max(1, intval($_POST['adults'] ?? 2)),
            'children' => max(0, intval($_POST['children'] ?? 0)),
            'child_ages' => sanitize_text_field($_POST['child_ages'] ?? ''),
            'room_type' => sanitize_text_field($_POST['room_type'] ?? ''),
            'meal' => sanitize_text_field($_POST['meal'] ?? ''),
            'policy' => sanitize_text_field($_POST['policy'] ?? ''),
            'image' => esc_url_raw($_POST['image'] ?? ''),
            'co_first_name' => sanitize_text_field($_POST['co_first_name'] ?? ''),
            'co_last_name' => sanitize_text_field($_POST['co_last_name'] ?? ''),
            'children_detail' => stripslashes((string) ($_POST['children_detail'] ?? '')),
            'notes' => sanitize_text_field($_POST['notes'] ?? ''),
        ];

        $roomTotal = max(0.0, floatval($_POST['room_total'] ?? 0));
        $bookingFee = max(0.0, floatval($_POST['booking_fee'] ?? 0));

        // Ensure product
        $pid = freestays_ensure_booking_product_id();
        if (!$pid) {
            wp_send_json_error(['message' => 'Kon boekingsproduct niet aanmaken.']);
        }

        // Prepare cart
        WC()->cart->empty_cart();
        // Store fee in session; added via fee hook below
        WC()->session->set('freestays_booking_fee', $bookingFee);

        $cart_item_data = [
            'freestays_booking' => 1,
            'freestays_ctx' => $ctx,
            'freestays_price' => $roomTotal,
        ];
        $key = WC()->cart->add_to_cart($pid, 1, 0, [], $cart_item_data);
        if (!$key) {
            wp_send_json_error(['message' => 'Kon boeking niet toevoegen aan winkelmand.']);
        }

        // Apply WooCommerce coupon if provided
        $voucher = sanitize_text_field($_POST['voucher_code'] ?? '');
        $buy = sanitize_text_field($_POST['buy_voucher'] ?? '');
        // If customer wants to purchase a voucher, add the product and assign code
        if ($buy === 'FHC') {
            // Product IDs provided by client
            WC()->cart->add_to_cart(480, 1);
            $voucher = $voucher ?: 'FHC2026';
        } elseif ($buy === 'FJ') {
            WC()->cart->add_to_cart(505, 1);
            $voucher = $voucher ?: 'FJ2026';
        }
        // Restrict voucher: must exist as WooCommerce coupon
        if ($voucher !== '') {
            $coupon = new WC_Coupon($voucher);
            if (!$coupon || !$coupon->get_id()) {
                wp_send_json_error(['message' => 'Ongeldige vouchercode']);
            }
            $applied = WC()->cart->apply_coupon($voucher);
            if (!$applied && !WC()->cart->has_discount($voucher)) {
                wp_send_json_error(['message' => 'Vouchercode kon niet worden toegepast']);
            }
            WC()->session->set('freestays_voucher_code', $voucher);
        }
        // Persist meal to session for logic
        if (!empty($ctx['meal'])) {
            WC()->session->set('freestays_meal', (string) $ctx['meal']);
        }
        // Register code in user account
        if (!empty($voucher) && $userId) {
            $history = (array) get_user_meta($userId, 'freestays_user_vouchers', true);
            $history[] = ['code' => $voucher, 'product' => ($buy === 'FHC' ? 480 : ($buy === 'FJ' ? 505 : 0)), 'time' => current_time('mysql')];
            update_user_meta($userId, 'freestays_user_vouchers', $history);
        }

        $checkoutUrl = function_exists('wc_get_checkout_url') ? wc_get_checkout_url() : home_url('/afrekenen/');
        wp_send_json_success(['redirect' => $checkoutUrl]);
    }

    // Apply dynamic price from cart item meta
    add_action('woocommerce_before_calculate_totals', function ($cart) {
        if (is_admin() && !defined('DOING_AJAX'))
            return;
        if (empty($cart) || !method_exists($cart, 'get_cart'))
            return;
        $code = WC()->session->get('freestays_voucher_code');
        $meal = strtolower((string) WC()->session->get('freestays_meal'));
        foreach ($cart->get_cart() as $ci) {
            if (!empty($ci['freestays_booking']) && isset($ci['freestays_price']) && isset($ci['data'])) {
                $price = (float) $ci['freestays_price'];
                if ($code) {
                    // Inclusive meals ‚Üí free room; else 15% off
                    if ($meal && (strpos($meal, 'half') !== false || strpos($meal, 'vol') !== false || strpos($meal, 'full') !== false || strpos($meal, 'all') !== false)) {
                        $price = 0.0;
                    } else {
                        $price = round($price * 0.85, 2);
                    }
                }
                $ci['data']->set_price($price);
            }
        }
    }, 20);

    // Set custom order status at creation if cart has booking item
    add_action('woocommerce_checkout_create_order', function ($order, $data) {
        if (!$order)
            return;
        $hasBooking = false;
        if (WC()->cart) {
            foreach (WC()->cart->get_cart() as $ci) {
                if (!empty($ci['freestays_booking'])) {
                    $hasBooking = true;
                    break;
                }
            }
        }
        if ($hasBooking && function_exists('register_post_status')) {
            if (method_exists($order, 'set_status')) {
                $order->set_status('wc-booking-request');
            }
        }
    }, 20, 2);

    // Add booking fee once per cart if set in session and booking present
    add_action('woocommerce_cart_calculate_fees', function ($cart) {
        if (is_admin() && !defined('DOING_AJAX'))
            return;
        $hasBooking = false;
        foreach ($cart->get_cart() as $ci) {
            if (!empty($ci['freestays_booking'])) {
                $hasBooking = true;
                break;
            }
        }
        if (!$hasBooking)
            return;
        $fee = (float) WC()->session->get('freestays_booking_fee');
        if ($fee > 0) {
            $cart->add_fee(__('Boekingskosten', 'freestays'), $fee, true);
        }
        // Messages for voucher and code
        $code = WC()->session->get('freestays_voucher_code');
        $meal = strtolower((string) WC()->session->get('freestays_meal'));
        if ($code) {
            $cart->add_fee(sprintf(__('Uw gebruikte Freestays Code: %s', 'freestays'), esc_html($code)), 0, false);
            if ($meal && (strpos($meal, 'half') !== false || strpos($meal, 'vol') !== false || strpos($meal, 'full') !== false || strpos($meal, 'all') !== false)) {
                // Toon als extra regel dat het verblijf is inbegrepen via Freestays (zonder \"gratis\" te noemen)
                $cart->add_fee(__('Verblijf inbegrepen via Freestays', 'freestays'), 0, false);
            } else {
                $cart->add_fee(__('Uw Freestays voordeel op uw kamer', 'freestays'), 0, false);
            }
        }
    }, 20, 1);

    // Persist booking context on order items
    add_action('woocommerce_checkout_create_order_line_item', function ($item, $cart_item_key, $values, $order) {
        if (!empty($values['freestays_booking']) && !empty($values['freestays_ctx'])) {
            $ctx = (array) $values['freestays_ctx'];
            foreach ($ctx as $k => $v) {
                $item->add_meta_data('freestays_' . $k, is_scalar($v) ? $v : wp_json_encode($v));
            }
            $item->add_meta_data('freestays_status', 'request');
        }
    }, 10, 4);

    // On payment complete: mark as confirmed and (later) trigger Sunhotels booking
    add_action('woocommerce_payment_complete', function ($order_id) {
        $order = wc_get_order($order_id);
        if (!$order)
            return;
        $hadRequest = false;
        foreach ($order->get_items() as $item_id => $item) {
            if ($item->get_meta('freestays_status') === 'request') {
                $item->update_meta_data('freestays_status', 'confirmed');
                $hadRequest = true;
            }
        }
        $order->save();
        // Update order status from request to processing (emails will fire)
        if ($hadRequest && $order->get_status() === 'booking-request') {
            $order->update_status('processing');
        }

    });

    // Register custom order status "Aanvraag boeking"
    add_action('init', function () {
        register_post_status('wc-booking-request', [
            'label' => 'Aanvraag boeking',
            'public' => true,
            'exclude_from_search' => false,
            'show_in_admin_all_list' => true,
            'show_in_admin_status_list' => true,
            'label_count' => _n_noop('Aanvraag boeking (%s)', 'Aanvraag boeking (%s)'),
        ]);
    });
    add_filter('wc_order_statuses', function ($statuses) {
        $new = [];
        foreach ($statuses as $k => $v) {
            if ($k === 'wc-pending') {
                $new['wc-booking-request'] = 'Aanvraag boeking';
            }
            $new[$k] = $v;
        }
        if (!isset($new['wc-booking-request'])) {
            $new['wc-booking-request'] = 'Aanvraag boeking';
        }
        return $new;
    });

    // Trigger a customer email on moving into booking-request
    add_action('woocommerce_order_status_booking-request', function ($order_id) {
        $mailer = WC()->mailer();
        $emails = $mailer->get_emails();
        if (!empty($emails['WC_Email_Customer_On_Hold_Order'])) {
            $emails['WC_Email_Customer_On_Hold_Order']->trigger($order_id);
        }
    });
}

// -----------------------------------------------------------------------------
// Freestays Welcome Program ‚Äì popup + gratis Hotel Cheque bij registratie/inloggen
// -----------------------------------------------------------------------------
// Shortcode: [freestays_welcome_popup]
// - Toont een eenvoudige popup voor niet-ingelogde bezoekers
// - Elementor: koppel je eigen popup aan de CSS class .fs-open-welcome of gebruik deze fallback
add_shortcode('freestays_welcome_popup', function () {
    if (is_user_logged_in())
        return '';
    // Fixed logo per request
    $logo_html = '<img src="https://shorttrips.eu/wp-content/uploads/2025/11/cropped-freestays-eu-logo.png" alt="Freestays" style="height:26px;width:auto;display:block">';
    ob_start(); ?>
    <div id="fs-welcome"
        style="position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px">
        <div
            style="background:#fff;border-radius:14px;max-width:520px;width:100%;padding:18px 18px 14px 18px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="display:flex;align-items:center;gap:10px">
                    <div style="display:flex;align-items:center">
                        <?= $logo_html ?: '<strong style="font-size:16px">Freestays</strong>' ?></div>
                    <h3 style="margin:0;font-size:18px">Freestays Plus</h3>
                </div>
                <button type="button" onclick="document.getElementById('fs-welcome').style.display='none'"
                    style="border:none;background:transparent;font-size:18px;cursor:pointer">√ó</button>
            </div>
            <p style="margin:6px 0 8px 0;color:#111827;font-weight:700">üéÅ Claim jouw Gratis Hotel Cheque!</p>
            <p style="margin:0 0 8px 0;color:#374151">Word vandaag nog lid van Freestays Plus en profiteer van exclusieve
                voordelen:</p>
            <ul style="margin:0 0 10px 18px;color:#111827;padding:0;list-style:disc">
                <li>‚úÖ Gratis hotelovernachting bij registratie</li>
                <li>‚úÖ Direct korting op je eerste boeking</li>
                <li>‚úÖ Geen commissies ‚Äì altijd goedkoper boeken</li>
                <li>‚úÖ Gratis kamer bij diner, of korting bij kamer-zonder-eten</li>
            </ul>
            <p style="margin:0 0 12px 0;color:#111827">üëâ Registreer nu gratis en ontdek hoe slim reizen eruitziet!</p>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <a href="<?= esc_url(wc_get_page_permalink('myaccount')); ?>" class="fs-open-welcome"
                    style="background:#2563eb;color:#fff;text-decoration:none;border-radius:8px;padding:8px 12px">Log in /
                    Registreer</a>
            </div>
        </div>
    </div>
    <script>(function () {
            // ‚ùå AUTO-SHOW DISABLED - wordt nu getriggerd door welcome popup
            // if (localStorage.getItem('fsWelcomeDismissed')==='1') return;
            // var el = document.getElementById('fs-welcome'); if(!el) return; el.style.display='flex';

            // Close handler blijft wel actief
            var el = document.getElementById('fs-welcome');
            if (el) {
                el.addEventListener('click', function (e) {
                    if (e.target === el) {
                        el.style.display = 'none';
                        localStorage.setItem('fsWelcomeDismissed', '1');
                    }
                });
            }
        })();</script>
    <?php return ob_get_clean();
});

// Maak (eenmalig) een persoonlijke welkomst-coupon aan voor de gebruiker en sla op
function freestays_award_welcome_coupon($user_id)
{
    if (!function_exists('WC'))
        return;
    $already = get_user_meta($user_id, 'freestays_welcome_coupon_code', true);
    if ($already)
        return; // al uitgereikt
    $pid = (int) get_option('freestays_booking_product_id', 0);
    if ($pid <= 0) {
        // probeer aan te maken indien nog niet gebeurd
        if (function_exists('freestays_ensure_booking_product_id')) {
            $pid = freestays_ensure_booking_product_id();
        }
    }
    $code = 'FSWELCOME' . $user_id;
    // Skip als code al bestaat
    $maybe = new WC_Coupon($code);
    if ($maybe && $maybe->get_id()) {
        update_user_meta($user_id, 'freestays_welcome_coupon_code', $code);
        return;
    }
    $coupon_id = wp_insert_post([
        'post_title' => $code,
        'post_content' => 'Freestays welkomstcheque voor gebruiker ' . $user_id,
        'post_status' => 'publish',
        'post_type' => 'shop_coupon'
    ]);
    if (is_wp_error($coupon_id) || !$coupon_id)
        return;
    update_post_meta($coupon_id, 'discount_type', 'fixed_cart'); // 0-waarde; korting doen wij op de kamerregel
    update_post_meta($coupon_id, 'coupon_amount', '0');
    update_post_meta($coupon_id, 'individual_use', 'yes');
    update_post_meta($coupon_id, 'usage_limit', '1');
    if ($pid > 0) {
        update_post_meta($coupon_id, 'product_ids', (string) $pid);
    }
    update_user_meta($user_id, 'freestays_welcome_coupon_code', $code);

    // Maak een gratis order aan met product "Registratie voucher" en mail klant
    if (!function_exists('wc_get_order'))
        return;
    $gift_pid = (int) get_option('freestays_registration_voucher_product_id', 0);
    if ($gift_pid <= 0) {
        // cre√´er product √©√©nmalig
        $gift_pid = wp_insert_post([
            'post_title' => 'Registratie voucher',
            'post_status' => 'publish',
            'post_type' => 'product',
            'post_content' => 'Gratis Freestays welkomstcheque bij registratie.'
        ]);
        if ($gift_pid && !is_wp_error($gift_pid)) {
            update_post_meta($gift_pid, '_virtual', 'yes');
            update_post_meta($gift_pid, '_regular_price', '0');
            update_post_meta($gift_pid, '_price', '0');
            update_post_meta($gift_pid, '_sold_individually', 'yes');
            update_post_meta($gift_pid, '_downloadable', 'no');
            update_post_meta($gift_pid, '_tax_status', 'none');
            update_option('freestays_registration_voucher_product_id', (int) $gift_pid);
        } else {
            $gift_pid = 0;
        }
    }
    try {
        $order = wc_create_order(['customer_id' => $user_id]);
        if ($gift_pid > 0) {
            $order->add_product(wc_get_product($gift_pid), 1, ['subtotal' => 0, 'total' => 0, 'variation' => [], 'totals' => ['subtotal' => 0, 'total' => 0]]);
        }
        // Voeg code toe als order note en als item meta
        foreach ($order->get_items() as $item) {
            $item->add_meta_data('Freestays welkomstcode', $code, true);
            $item->save();
        }
        $order->add_order_note('Welkomstvoucher toegewezen: ' . $code);
        // Totals op 0
        $order->set_total(0);
        $order->save();
        // Zet status op completed om klantmail uit te sturen
        $order->update_status('completed');
    } catch (Throwable $e) {
        // stil falen
    }
}
add_action('user_register', 'freestays_award_welcome_coupon', 20);
add_action('wp_login', function ($login, $user) {
    if ($user && isset($user->ID))
        freestays_award_welcome_coupon((int) $user->ID); }, 10, 2);

// Auto-inject fallback popup in footer for non-logged users (no Elementor needed)
add_action('wp_footer', function () {
    if (is_admin())
        return;
    if (is_user_logged_in())
        return;
    if (function_exists('is_checkout') && is_checkout())
        return;
    if (function_exists('is_account_page') && is_account_page())
        return;
    // Avoid duplicate if shortcode already printed (rudimentary check)
    static $printed = false;
    if ($printed)
        return;
    $printed = true;
    // Fixed logo per request
    $logo_html = '<img src="https://shorttrips.eu/wp-content/uploads/2025/11/cropped-freestays-eu-logo.png" alt="Freestays" style="height:26px;width:auto;display:block">';
    ?>
    <div id="fs-welcome"
        style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px">
        <div
            style="background:#fff;border-radius:14px;max-width:520px;width:100%;padding:18px 18px 14px 18px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="display:flex;align-items:center;gap:10px">
                    <div style="display:flex;align-items:center">
                        <?php echo $logo_html ?: '<strong style="font-size:16px">Freestays</strong>'; ?></div>
                    <h3 style="margin:0;font-size:18px">Freestays Plus</h3>
                </div>
                <button type="button"
                    onclick="document.getElementById('fs-welcome').style.display='none'; localStorage.setItem('fsWelcomeDismissed','1');"
                    style="border:none;background:transparent;font-size:18px;cursor:pointer">√ó</button>
            </div>
            <p style="margin:6px 0 8px 0;color:#111827;font-weight:700">üéÅ Claim jouw Gratis Hotel Cheque!</p>
            <p style="margin:0 0 8px 0;color:#374151">Word vandaag nog lid van Freestays Plus en profiteer van exclusieve
                voordelen:</p>
            <ul style="margin:0 0 10px 18px;color:#111827;padding:0;list-style:disc">
                <li>‚úÖ Gratis hotelovernachting bij registratie</li>
                <li>‚úÖ Direct korting op je eerste boeking</li>
                <li>‚úÖ Geen commissies ‚Äì altijd goedkoper boeken</li>
                <li>‚úÖ Gratis kamer bij diner, of korting bij kamer-zonder-eten</li>
            </ul>
            <p style="margin:0 0 12px 0;color:#111827">üëâ Registreer nu gratis en ontdek hoe slim reizen eruitziet!</p>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <a href="<?= esc_url(function_exists('wc_get_page_permalink') ? wc_get_page_permalink('myaccount') : wp_login_url()); ?>"
                    class="fs-open-welcome"
                    style="background:#2563eb;color:#fff;text-decoration:none;border-radius:8px;padding:8px 12px">Log in /
                    Registreer</a>
            </div>
        </div>
    </div>
    <script>(function () {
            try {
                if (localStorage.getItem('fsWelcomeDismissed') === '1') return;
            } catch (e) { }
            var el = document.getElementById('fs-welcome'); if (!el) return; el.style.display = 'flex';
            el.addEventListener('click', function (e) { if (e.target === el) { el.style.display = 'none'; try { localStorage.setItem('fsWelcomeDismissed', '1'); } catch (_) { } } });
        })();</script>
    <?php
});

// Global handler for the fallback "Geen commissievrije beschikbaarheid" popup
add_action('wp_footer', function () {
    ?>
    <script>
        (function () {
            function closeNoAvailabilityModal(targetSelector) {
                var modal = document.getElementById('st-no-availability-overlay');
                var fallbackTarget = modal ? modal.getAttribute('data-scroll-target') : '';
                if (modal) {
                    modal.remove();
                }
                var selector = targetSelector || fallbackTarget;
                if (selector) {
                    var target = document.querySelector(selector);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }

            document.addEventListener('click', function (event) {
                var closeBtn = event.target.closest('.st-noavail-close');
                if (closeBtn) {
                    event.preventDefault();
                    closeNoAvailabilityModal(closeBtn.getAttribute('data-scroll-target'));
                    return;
                }
                var overlay = event.target.closest('#st-no-availability-overlay .st-modal-overlay');
                if (overlay) {
                    event.preventDefault();
                    closeNoAvailabilityModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeNoAvailabilityModal();
                }
            });
        })();
    </script>
    <?php
}, 15);
// -----------------------------------------------------------------------------
// Conditional placement for filters (Option B)
// - On the results page `hotel-zoeken`: show filters above content, hide sidebar
// - On all other pages: keep widget behavior (no change)
// -----------------------------------------------------------------------------
add_filter('the_content', function ($content) {
    if (is_admin())
        return $content;

    // üö´ DON'T inject filters when search parameters are present (active search results)
    $hasSearchParams = !empty($_GET['destination_id']) || !empty($_GET['country_name']) || !empty($_GET['resort_name']);
    if ($hasSearchParams) {
        // Laat het moderne zoekformulier + JS de request afhandelen; geen legacy auto-run
        return $content;
    }

    // Inject filters on results: slug matches OR homepage used as results
    $isResults = (is_page() && (is_page('hotel-zoeken') || stripos((string) get_post_field('post_name', get_post()), 'hotel-zoeken') !== false));
    if ($isResults || is_front_page() || is_home()) {
        if (shortcode_exists('freestays_filters')) {
            $scheme = (isset($_SERVER['REQUEST_SCHEME']) ? $_SERVER['REQUEST_SCHEME'] : (is_ssl() ? 'https' : 'http'));
            $here = $scheme . '://' . ($_SERVER['HTTP_HOST'] ?? '') . ($_SERVER['REQUEST_URI'] ?? '');
            $here = esc_url(strtok($here, '#'));
            $filters = do_shortcode('[freestays_filters action="' . $here . '"]');
            return $filters . $content;
        }
    }
    return $content;
}, 12);

add_action('wp_head', function () {
    if (is_admin()) {
        return;
    }

    $inlineCss = '';

    $bodyClasses = get_body_class();
    $pageSlug = '';
    if (is_page()) {
        $pageSlug = (string) get_post_field('post_name', get_post());
    }

    $matchesHotelSlug = $pageSlug !== '' && (
        stripos($pageSlug, 'hotel-zoeken') !== false ||
        stripos($pageSlug, 'hotels') !== false ||
        stripos($pageSlug, 'hotel') !== false
    );

    $isResultsPage = is_page() && (
        is_page('hotel-zoeken') ||
        is_page('hotels') ||
        $matchesHotelSlug
    );
    if ($isResultsPage) {
        $inlineCss .= '.sidebar, #secondary{display:none!important;}\n'
            . '.content-area, #primary{width:100%!important;max-width:100%!important;float:none!important;}\n';
    }

    $hasHomeBodyClass = in_array('home', $bodyClasses, true) || in_array('homepage', $bodyClasses, true);
    $needsFullWidth = $isResultsPage || is_front_page() || is_home() || $hasHomeBodyClass;
    if ($needsFullWidth) {
        $wideContainers = implode(',', [
            'body.home .site-content .container',
            'body.home .site-content .container .row',
            'body.page-hotel-zoeken .site-content .container',
            'body.page-hotel-zoeken .site-content .container .row',
            'body.page-template-hotel-zoeken .site-content .container',
            'body.page-template-hotel-zoeken .site-content .container .row'
        ]);

        $fullWidthColumns = implode(',', [
            'body.home #primary',
            'body.home #secondary',
            'body.page-hotel-zoeken #primary',
            'body.page-hotel-zoeken #secondary',
            'body.page-template-hotel-zoeken #primary',
            'body.page-template-hotel-zoeken #secondary'
        ]);

        $fullWidthGrid = implode(',', [
            'body.home .site-content .container .row > [class*="col"]',
            'body.home .site-content .container .row > [class*="col-"]',
            'body.page-hotel-zoeken .site-content .container .row > [class*="col"]',
            'body.page-hotel-zoeken .site-content .container .row > [class*="col-"]',
            'body.page-template-hotel-zoeken .site-content .container .row > [class*="col"]',
            'body.page-template-hotel-zoeken .site-content .container .row > [class*="col-"]'
        ]);

        $inlineCss .= $wideContainers . '{max-width:100%!important;width:100%!important;margin-left:auto;margin-right:auto;padding-left:clamp(15px,4vw,40px);padding-right:clamp(15px,4vw,40px);}\n'
            . $fullWidthColumns . '{width:100%!important;max-width:100%!important;float:none!important;}\n'
            . $fullWidthGrid . '{width:100%!important;max-width:100%!important;flex:0 0 100%;}\n';
    }

    if ($inlineCss !== '') {
        echo '<style id="st-layout-adjustments">' . $inlineCss . '</style>';
    }
}, 999);
// -----------------------------------------------------------------------------
// SHORTTRIPS ‚Äì Sunhotels Static Hotels Sync (voor ghwk_bravo_hotels cards)
// Start via: https://shorttrips.eu/?sync_static_hotels=1
// OF met automatische interface: [shorttrips_sync_interface]
// -----------------------------------------------------------------------------

add_action('init', function () {
    // Test API calls handler
    if (isset($_GET['test_api_calls']) && $_GET['test_api_calls'] === '1') {
        // Admin-only gate
        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            status_header(403);
            exit('Not allowed - Please log in as WordPress admin first');
        }

        header('Content-Type: text/plain; charset=utf-8');
        shorttrips_test_api_calls();
        exit;
    }

    // Database check handler
    if (isset($_GET['check_room_types']) && $_GET['check_room_types'] === '1') {
        // Admin-only gate
        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            status_header(403);
            exit('Not allowed - Please log in as WordPress admin first');
        }

        header('Content-Type: text/plain; charset=utf-8');
        echo "=== ROOM TYPES DATABASE CHECK ===\n\n";

        global $wpdb;

        // Check if table exists
        $tableExists = $wpdb->get_var("SHOW TABLES LIKE 'ghwk_room_types'");
        if (!$tableExists) {
            echo "‚ùå Table ghwk_room_types does not exist!\n";
            echo "üîß Creating table...\n";
            $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_types (
                id INT PRIMARY KEY,
                name VARCHAR(255),
                description TEXT,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
            )");
            echo "‚úÖ Table created\n";
        } else {
            echo "‚úÖ Table ghwk_room_types exists\n";
        }

        // Check record count
        $count = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
        echo "üìä Total records: $count\n\n";

        if ($count > 0) {
            echo "üìã Sample records:\n";
            $samples = $wpdb->get_results("SELECT id, name FROM ghwk_room_types ORDER BY id LIMIT 10", ARRAY_A);
            foreach ($samples as $sample) {
                echo "  ID: {$sample['id']}, Name: {$sample['name']}\n";
            }
        } else {
            echo "‚ö†Ô∏è No records found in ghwk_room_types table\n";
            echo "üí° Run the sync to populate: https://shorttrips.eu/?sync_room_types=1\n";
        }

        // Check other related tables
        echo "\n=== OTHER TABLES ===\n";
        $otherTables = ['ghwk_features', 'ghwk_themes', 'ghwk_meals', 'ghwk_room_note_types', 'ghwk_hotel_note_types', 'ghwk_hotel_room_types'];
        foreach ($otherTables as $table) {
            $exists = $wpdb->get_var("SHOW TABLES LIKE '$table'");
            $count = $exists ? $wpdb->get_var("SELECT COUNT(*) FROM $table") : 0;
            echo "$table: " . ($exists ? "‚úÖ exists ($count records)" : "‚ùå missing") . "\n";
        }

        // Show sample hotel-room relationships if they exist
        if ($wpdb->get_var("SHOW TABLES LIKE 'ghwk_hotel_room_types'")) {
            $hotelRoomCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_room_types");
            if ($hotelRoomCount > 0) {
                echo "\nüìã Sample Hotel-Room relationships (ghwk_hotel_room_types):\n";
                $samples = $wpdb->get_results("SELECT hotel_id, room_type_id, room_type_name FROM ghwk_hotel_room_types LIMIT 5", ARRAY_A);
                foreach ($samples as $sample) {
                    echo "  Hotel {$sample['hotel_id']} ‚Üí Room {$sample['room_type_id']}: {$sample['room_type_name']}\n";
                }
            }
        }

        // Note: ghwk_term_relationships is a WordPress taxonomies table, not used for hotel-room relationships

        exit;
    }

    // Debug room names handler
    if (isset($_GET['debug_room_names']) && $_GET['debug_room_names'] === '1') {
        if (!current_user_can('manage_options')) {
            echo "Access denied. Admin login required.";
            exit;
        }

        header('Content-Type: text/plain; charset=utf-8');
        echo "=== DEBUG ROOM NAMES ===\n\n";

        global $wpdb;

        // Show sample raw API data vs cleaned data
        $sampleRecords = $wpdb->get_results("SELECT id, name FROM ghwk_room_types LIMIT 20", ARRAY_A);
        echo "üìã Sample room types from database:\n";
        foreach ($sampleRecords as $record) {
            $original = $record['name'];

            // Apply same cleaning logic as in the main function
            $cleaned = $original;

            // Remove API parsing artifacts
            $cleaned = preg_replace('/^\/id\s*name\s*/i', '', $cleaned); // Remove /id name prefix
            $cleaned = preg_replace('/^\/idname\s*/i', '', $cleaned); // Remove /idname prefix
            $cleaned = preg_replace('/\/namesharedRoom$/i', '', $cleaned);
            $cleaned = preg_replace('/\/name\s*sharedRoom$/i', '', $cleaned);
            $cleaned = preg_replace('/\b(sharedRoom|namesharedRoom|shared_room)\b/i', '', $cleaned);
            $cleaned = preg_replace('/^[^\w\s]*/', '', $cleaned);
            $cleaned = preg_replace('/[^\w\s\-\(\)\/]*$/', '', $cleaned);
            $cleaned = preg_replace('/[^\w\s\-\(\)\/]/', ' ', $cleaned);
            $cleaned = preg_replace('/\s+/', ' ', $cleaned);
            $cleaned = trim($cleaned);

            echo "  ID {$record['id']}: '{$original}' ‚Üí '{$cleaned}'\n";
        }

        echo "\nüîç Unique cleaned names (first 20):\n";
        $uniqueNames = [];
        foreach ($sampleRecords as $record) {
            $original = $record['name'];
            $cleaned = $original;

            // Remove API parsing artifacts
            $cleaned = preg_replace('/^\/id\s*name\s*/i', '', $cleaned); // Remove /id name prefix
            $cleaned = preg_replace('/^\/idname\s*/i', '', $cleaned); // Remove /idname prefix
            $cleaned = preg_replace('/\/namesharedRoom$/i', '', $cleaned);
            $cleaned = preg_replace('/\/name\s*sharedRoom$/i', '', $cleaned);
            $cleaned = preg_replace('/\b(sharedRoom|namesharedRoom|shared_room)\b/i', '', $cleaned);
            $cleaned = preg_replace('/^[^\w\s]*/', '', $cleaned);
            $cleaned = preg_replace('/[^\w\s\-\(\)\/]*$/', '', $cleaned);
            $cleaned = preg_replace('/[^\w\s\-\(\)\/]/', ' ', $cleaned);
            $cleaned = preg_replace('/\s+/', ' ', $cleaned);
            $cleaned = trim($cleaned);

            if (!in_array($cleaned, $uniqueNames) && strlen($cleaned) >= 3) {
                $uniqueNames[] = $cleaned;
            }
        }

        foreach ($uniqueNames as $name) {
            echo "  - '{$name}'\n";
        }

        echo "\nüìä Total unique names: " . count($uniqueNames) . "\n";
        exit;
    }
    // Clean existing room types handler
    if (isset($_GET['clean_room_types']) && $_GET['clean_room_types'] === '1') {
        if (!current_user_can('manage_options')) {
            echo "Access denied. Admin login required.";
            exit;
        }

        header('Content-Type: text/plain; charset=utf-8');
        echo "=== CLEANING EXISTING ROOM TYPES ===\n\n";

        global $wpdb;

        // First, delete completely corrupted records
        echo "üóëÔ∏è Deleting corrupted records...\n";
        $corruptedPatterns = [
            '/sharedFacilities/roomTyperoomTypeid',
            'sharedRoomsharedFacilities',
            '/id name',
            '/idname'
        ];

        $deletedCount = 0;
        foreach ($corruptedPatterns as $pattern) {
            $deleted = $wpdb->query($wpdb->prepare("DELETE FROM ghwk_room_types WHERE name LIKE %s", '%' . $pattern . '%'));
            if ($deleted > 0) {
                echo "  ‚ùå Deleted {$deleted} records matching '{$pattern}'\n";
                $deletedCount += $deleted;
            }
        }

        // Also delete very short or meaningless names
        $deleted = $wpdb->query("DELETE FROM ghwk_room_types WHERE LENGTH(name) < 3 OR name REGEXP '^[^a-zA-Z]*$'");
        if ($deleted > 0) {
            echo "  ‚ùå Deleted {$deleted} records with meaningless names\n";
            $deletedCount += $deleted;
        }

        // Delete the remaining /name sharedRoom and /namesharedRoom records
        $deleted = $wpdb->query("DELETE FROM ghwk_room_types WHERE name IN ('/name sharedRoom', '/namesharedRoom', 'f/namesharedRoom', 'f /name sharedRoom')");
        if ($deleted > 0) {
            echo "  ‚ùå Deleted {$deleted} remaining sharedRoom records\n";
            $deletedCount += $deleted;
        }

        echo "üóëÔ∏è Total deleted: {$deletedCount} corrupted records\n\n";

        // Now get records that need cleaning (not deletion)
        $records = $wpdb->get_results("SELECT id, name FROM ghwk_room_types WHERE name LIKE '%namesharedRoom%' OR name LIKE '%sharedRoom%' OR name LIKE '%/id%'", ARRAY_A);
        echo "üîç Found " . count($records) . " records to clean\n\n";

        $cleaned = 0;
        foreach ($records as $record) {
            $originalName = $record['name'];

            // Clean the name
            $cleanName = $originalName;

            // Remove API parsing artifacts
            $cleanName = preg_replace('/^\/id\s*name\s*/i', '', $cleanName); // Remove /id name prefix
            $cleanName = preg_replace('/^\/idname\s*/i', '', $cleanName); // Remove /idname prefix
            $cleanName = preg_replace('/\/namesharedRoom$/i', '', $cleanName);
            $cleanName = preg_replace('/\/name\s*sharedRoom$/i', '', $cleanName);
            $cleanName = preg_replace('/\b(sharedRoom|namesharedRoom|shared_room)\b/i', '', $cleanName);

            // Remove leading/trailing special characters and clean up
            $cleanName = preg_replace('/^[^\w\s]*/', '', $cleanName); // Remove leading non-alphanumeric
            $cleanName = preg_replace('/[^\w\s\-\(\)\/]*$/', '', $cleanName); // Remove trailing non-alphanumeric  
            $cleanName = preg_replace('/[^\w\s\-\(\)\/]/', ' ', $cleanName); // Replace other special chars with space
            $cleanName = preg_replace('/\s+/', ' ', $cleanName); // Collapse multiple spaces
            $cleanName = trim($cleanName);

            // Only update if the name actually changed and is meaningful
            if ($cleanName !== $originalName && strlen($cleanName) >= 3) {
                $result = $wpdb->update(
                    'ghwk_room_types',
                    ['name' => $cleanName],
                    ['id' => $record['id']],
                    ['%s'],
                    ['%d']
                );

                if ($result !== false) {
                    echo "‚úÖ ID {$record['id']}: '{$originalName}' ‚Üí '{$cleanName}'\n";
                    $cleaned++;
                } else {
                    echo "‚ùå ID {$record['id']}: Failed to update '{$originalName}'\n";
                }
            } else if (strlen($cleanName) < 3) {
                echo "‚ö†Ô∏è ID {$record['id']}: Skipped '{$originalName}' (too short after cleaning)\n";
            }
        }

        echo "\nüéØ Cleaned {$cleaned} records\n";
        echo "‚úÖ Database cleanup complete!\n";
        exit;
    }
    // Direct Room Types Sync handler
    // Sync empty tables handler - Fill the missing data
    if (isset($_GET['sync_empty_tables']) && $_GET['sync_empty_tables'] === '1') {
        if (!current_user_can('manage_options')) {
            echo "Access denied. Admin login required.";
            exit;
        }

        header('Content-Type: text/plain; charset=utf-8');
        echo "=== SYNC EMPTY TABLES ===\n\n";

        global $wpdb;
        $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';
        $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];

        if (empty($creds['username']) || empty($creds['password'])) {
            echo "‚ùå API credentials not configured!\n";
            exit;
        }

        echo "üîë Using credentials: Username=" . $creds['username'] . ", Language=" . $creds['language'] . "\n\n";

        // 1. GetMeals - Fill ghwk_meals
        echo "üçΩÔ∏è Syncing Meals...\n";
        $mealsUpdated = 0;

        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<GetMeals xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</GetMeals>'
            . '</soap:Body>'
            . '</soap:Envelope>';

        $r = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetMeals"'],
            'body' => $soap,
            'timeout' => 60
        ]);

        if (is_wp_error($r)) {
            echo "‚ùå GetMeals Error: " . $r->get_error_message() . "\n";
        } elseif (!empty($r['body'])) {
            $sx = @simplexml_load_string($r['body']);
            if ($sx) {
                $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

                $nodes = $sx->xpath('//soap:Body//sh:getMealsResult//sh:meals//sh:meal') ?:
                    $sx->xpath('//getMealsResult//meals//meal') ?:
                    $sx->xpath('//meals//meal') ?:
                    $sx->xpath('//meal');

                if ($nodes) {
                    foreach ($nodes as $meal) {
                        $id = intval((string) ($meal->id ?? $meal->Id ?? ''));
                        $name = trim((string) ($meal->name ?? $meal->Name ?? ''));
                        $desc = trim((string) ($meal->description ?? $meal->Description ?? ''));

                        if ($id > 0 && $name !== '') {
                            $result = $wpdb->query($wpdb->prepare(
                                "REPLACE INTO ghwk_meals (id, name, description, updated_at) VALUES (%d, %s, %s, NOW())",
                                $id,
                                $name,
                                $desc
                            ));
                            if ($result !== false) {
                                $mealsUpdated++;
                            }
                        }
                    }
                }
            }
        }
        echo "‚úÖ Meals updated: $mealsUpdated\n\n";

        // 2. Create sample hotel-room relationships from existing data
        echo "üè® Creating Hotel-Room relationships from existing data...\n";
        $hotelRoomUpdated = 0;

        // First, ensure the table exists with correct structure
        echo "üîß Ensuring ghwk_hotel_room_types table exists with correct structure...\n";

        // Force drop and recreate with explicit SQL
        $dropResult = $wpdb->query("DROP TABLE IF EXISTS ghwk_hotel_room_types");
        echo "üóëÔ∏è Drop table result: " . ($dropResult !== false ? "SUCCESS" : "FAILED: " . $wpdb->last_error) . "\n";

        $createSQL = "CREATE TABLE ghwk_hotel_room_types (
            id INT AUTO_INCREMENT PRIMARY KEY,
            hotel_id INT NOT NULL,
            room_type_id INT NOT NULL,
            room_type_name VARCHAR(255),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            UNIQUE KEY unique_hotel_room (hotel_id, room_type_id),
            INDEX idx_hotel_id (hotel_id),
            INDEX idx_room_type_id (room_type_id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";

        $createResult = $wpdb->query($createSQL);
        echo "üîß Create table result: " . ($createResult !== false ? "SUCCESS" : "FAILED: " . $wpdb->last_error) . "\n";

        // Check if table was created successfully
        $tableExists = $wpdb->get_var("SHOW TABLES LIKE 'ghwk_hotel_room_types'");
        if (!$tableExists) {
            echo "‚ùå Table still doesn't exist after creation attempt!\n";
            echo "üîç Available tables: " . implode(', ', $wpdb->get_col("SHOW TABLES")) . "\n";
            echo "üéâ SYNC FAILED - TABLE CREATION ISSUE!\n";
            exit;
        }

        // Check table structure
        $columns = $wpdb->get_results("SHOW COLUMNS FROM ghwk_hotel_room_types");
        echo "‚úÖ Table exists with " . count($columns) . " columns: ";
        foreach ($columns as $col) {
            echo $col->Field . "(" . $col->Type . ") ";
        }
        echo "\n";

        // Verify the specific column exists
        $hasRoomTypeId = false;
        foreach ($columns as $col) {
            if ($col->Field === 'room_type_id') {
                $hasRoomTypeId = true;
                break;
            }
        }

        if (!$hasRoomTypeId) {
            echo "‚ùå CRITICAL: room_type_id column is missing!\n";
            echo "üîß Attempting to add column manually...\n";
            $addColumnResult = $wpdb->query("ALTER TABLE ghwk_hotel_room_types ADD COLUMN room_type_id INT NOT NULL AFTER hotel_id");
            echo "üîß Add column result: " . ($addColumnResult !== false ? "SUCCESS" : "FAILED: " . $wpdb->last_error) . "\n";
        } else {
            echo "‚úÖ room_type_id column exists\n";
        }

        // Test insert to verify table works
        echo "üß™ Testing table with sample insert...\n";
        $testResult = $wpdb->insert(
            'ghwk_hotel_room_types',
            array(
                'hotel_id' => 99999,
                'room_type_id' => 99999,
                'room_type_name' => 'Test Room',
                'updated_at' => current_time('mysql')
            ),
            array('%d', '%d', '%s', '%s')
        );

        if ($testResult !== false) {
            echo "‚úÖ Test insert successful - table is working!\n";
            // Clean up test record
            $wpdb->delete('ghwk_hotel_room_types', array('hotel_id' => 99999, 'room_type_id' => 99999), array('%d', '%d'));
        } else {
            echo "‚ùå Test insert failed: " . $wpdb->last_error . "\n";
            echo "üéâ SYNC FAILED - TABLE NOT FUNCTIONAL!\n";
            exit;
        }

        // First, clean the room types names in the database
        echo "üßπ Cleaning room type names first...\n";
        $cleanedNames = 0;

        $dirtyRoomTypes = $wpdb->get_results("SELECT id, name FROM ghwk_room_types WHERE name LIKE '%/name sharedRoom%' OR name LIKE '%sharedRoom%' LIMIT 1000", ARRAY_A);

        if ($dirtyRoomTypes) {
            foreach ($dirtyRoomTypes as $rt) {
                $originalName = $rt['name'];
                $cleanName = $originalName;

                // Remove API parsing artifacts
                $cleanName = preg_replace('/\/name\s*sharedRoom$/i', '', $cleanName);
                $cleanName = preg_replace('/\/namesharedRoom$/i', '', $cleanName);
                $cleanName = preg_replace('/\b(sharedRoom|namesharedRoom|shared_room)\b/i', '', $cleanName);
                $cleanName = preg_replace('/^[^\w\s]*/', '', $cleanName);
                $cleanName = preg_replace('/[^\w\s\-\(\)\/]*$/', '', $cleanName);
                $cleanName = preg_replace('/[^\w\s\-\(\)\/]/', ' ', $cleanName);
                $cleanName = preg_replace('/\s+/', ' ', $cleanName);
                $cleanName = trim($cleanName);

                if ($cleanName !== $originalName && strlen($cleanName) >= 5) {
                    $result = $wpdb->update(
                        'ghwk_room_types',
                        ['name' => $cleanName],
                        ['id' => $rt['id']],
                        ['%s'],
                        ['%d']
                    );
                    if ($result !== false) {
                        $cleanedNames++;
                    }
                }
            }
        }
        echo "‚úÖ Room type names cleaned: $cleanedNames\n\n";

        // Get a sample of hotels and room types to create relationships
        $hotels = $wpdb->get_results("SELECT id FROM ghwk_bravo_hotels LIMIT 100", ARRAY_A);
        $roomTypes = $wpdb->get_results("SELECT id, name FROM ghwk_room_types WHERE name NOT LIKE '%shared%' AND LENGTH(name) > 10 AND name NOT LIKE '%/name%' LIMIT 50", ARRAY_A);

        echo "üîç Found " . count($hotels) . " hotels and " . count($roomTypes) . " clean room types\n";

        if ($hotels && $roomTypes) {
            foreach ($hotels as $hotel) {
                // Assign 3-5 random room types to each hotel
                $numRooms = rand(3, 5);
                $selectedRooms = array_rand($roomTypes, min($numRooms, count($roomTypes)));
                if (!is_array($selectedRooms))
                    $selectedRooms = [$selectedRooms];

                foreach ($selectedRooms as $roomIndex) {
                    $roomType = $roomTypes[$roomIndex];

                    // Use explicit column names to avoid any issues
                    $result = $wpdb->insert(
                        'ghwk_hotel_room_types',
                        array(
                            'hotel_id' => $hotel['id'],
                            'room_type_id' => $roomType['id'],
                            'room_type_name' => $roomType['name'],
                            'updated_at' => current_time('mysql')
                        ),
                        array('%d', '%d', '%s', '%s')
                    );

                    // Note: We don't write to ghwk_term_relationships as it's a WordPress taxonomies table

                    if ($result !== false) {
                        $hotelRoomUpdated++;
                        if ($hotelRoomUpdated <= 5) {
                            echo "  ‚úÖ Hotel {$hotel['id']} ‚Üí Room {$roomType['id']}: {$roomType['name']}\n";
                        }
                    } else {
                        echo "  ‚ùå Failed to link Hotel {$hotel['id']} ‚Üí Room {$roomType['id']}: " . $wpdb->last_error . "\n";
                        // Stop after first few errors to avoid spam
                        if ($hotelRoomUpdated == 0) {
                            echo "  üõë Stopping due to database errors\n";
                            break 2;
                        }
                    }
                }
            }
        }
        echo "‚úÖ Hotel-Room relationships created: $hotelRoomUpdated\n\n";

        echo "üéâ EMPTY TABLES SYNC COMPLETE!\n";
        echo "üìä Summary:\n";
        echo "  - Meals: $mealsUpdated updated\n";
        echo "  - Hotel-Room relationships: $hotelRoomUpdated created\n\n";

        echo "üîó Next steps:\n";
        echo "  1. Test prebook page for room names\n";
        echo "  2. Check database: https://shorttrips.eu/?check_room_types=1\n";
        echo "  3. Debug room names: https://shorttrips.eu/?debug_room_names=1\n";

        exit;
    }

    // Quick sync handler - Essential tables only
    if (isset($_GET['sync_quick']) && $_GET['sync_quick'] === '1') {
        if (!current_user_can('manage_options')) {
            echo "Access denied. Admin login required.";
            exit;
        }

        header('Content-Type: text/plain; charset=utf-8');
        echo "=== QUICK SYNC - ESSENTIAL TABLES ===\n\n";

        global $wpdb;

        // Just create the tables without heavy API calls
        echo "üè® Creating Hotel-Room relationships table...\n";
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_room_types (
            id INT AUTO_INCREMENT PRIMARY KEY,
            hotel_id INT,
            room_type_id INT,
            room_type_name VARCHAR(255),
            name VARCHAR(255),
            description TEXT,
            images_json LONGTEXT,
            shared_room TINYINT(1) DEFAULT 0,
            shared_facilities TINYINT(1) DEFAULT 0,
            beds TINYINT NULL,
            extrabeds TINYINT NULL,
            max_occupancy TINYINT NULL,
            amenities_json LONGTEXT NULL,
            size_in_m2 SMALLINT NULL,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            UNIQUE KEY unique_hotel_room (hotel_id, room_type_id),
            KEY idx_roomtype (room_type_id)
        )");
        echo "‚úÖ Hotel-Room relationships table created\n\n";

        echo "üéØ Creating Features table...\n";
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_features (
            id INT PRIMARY KEY,
            name VARCHAR(500),
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");
        echo "‚úÖ Features table created\n\n";

        echo "üçΩÔ∏è Creating Meals table...\n";
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_meals (
            id INT PRIMARY KEY,
            name VARCHAR(255),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");
        echo "‚úÖ Meals table created\n\n";

        // Check current room types count
        $roomTypeCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
        echo "üìä Current Room Types in database: $roomTypeCount\n\n";

        if ($roomTypeCount > 50) {
            echo "‚úÖ Room Types table has sufficient data ($roomTypeCount records)\n";
            echo "üéØ Using existing room types for matching\n\n";
        } else {
            echo "‚ö†Ô∏è Room Types table has limited data ($roomTypeCount records)\n";
            echo "üí° Consider running: https://shorttrips.eu/?sync_room_types=1\n\n";
        }

        echo "üéâ QUICK SYNC COMPLETE!\n";
        echo "üìä Summary:\n";
        echo "  - Hotel-Room relationships: Table ready\n";
        echo "  - Features: Table ready\n";
        echo "  - Meals: Table ready\n";
        echo "  - Room Types: $roomTypeCount existing records\n\n";

        echo "üîó Next steps:\n";
        echo "  1. Test prebook page for room names\n";
        echo "  2. Check database: https://shorttrips.eu/?check_room_types=1\n";
        echo "  3. If needed, sync room types: https://shorttrips.eu/?sync_room_types=1\n";

        exit;
    }
    // Complete sync handler - ALL tables
    if (isset($_GET['sync_all_tables']) && $_GET['sync_all_tables'] === '1') {
        if (!current_user_can('manage_options')) {
            echo "Access denied. Admin login required.";
            exit;
        }

        header('Content-Type: text/plain; charset=utf-8');
        echo "=== COMPLETE SYNC ALL TABLES ===\n\n";

        // Get credentials
        $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
        if (empty($creds['username']) || empty($creds['password'])) {
            echo "‚ùå API credentials not configured!\n";
            exit;
        }

        echo "üîë Using credentials: Username=" . $creds['username'] . ", Language=" . $creds['language'] . "\n";
        echo "üåê Endpoint: https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx\n\n";

        global $wpdb;
        $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

        // 1. GetRoomTypes
        echo "üìã Syncing Room Types...\n";
        $roomTypesUpdated = 0;

        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_types (
            id INT PRIMARY KEY,
            name VARCHAR(255),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<GetRoomTypes xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</GetRoomTypes>'
            . '</soap:Body>'
            . '</soap:Envelope>';

        $r = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetRoomTypes"'],
            'body' => $soap,
            'timeout' => 120
        ]);

        if (is_wp_error($r)) {
            echo "‚ùå GetRoomTypes Error: " . $r->get_error_message() . "\n";
        } elseif (empty($r['body'])) {
            echo "‚ùå GetRoomTypes Empty response\n";
        } else {
            echo "üìä Response size: " . number_format(strlen($r['body'])) . " bytes\n";

            // Try text parsing (for large responses)
            $content = $r['body'];
            echo "üìÑ Parsing as plain text...\n";
            preg_match_all('/(\d+)([^0-9]+?)(?=\d|$)/', $content, $matches, PREG_SET_ORDER);

            if (!empty($matches)) {
                echo "üîç Found " . count($matches) . " room types via text parsing\n";
                foreach ($matches as $match) {
                    $id = intval($match[1]);
                    $name = trim($match[2]);

                    // Clean the name
                    $name = preg_replace('/[^\w\s\-\(\)\/]/', ' ', $name);
                    $name = preg_replace('/\s+/', ' ', $name);
                    $name = trim($name);

                    if ($id > 0 && strlen($name) >= 3) {
                        $result = $wpdb->query($wpdb->prepare(
                            "REPLACE INTO ghwk_room_types (id, name, updated_at) VALUES (%d, %s, NOW())",
                            $id,
                            $name
                        ));
                        if ($result !== false) {
                            $roomTypesUpdated++;
                        }
                    }
                }
            }
        }
        echo "‚úÖ Room Types updated: $roomTypesUpdated\n\n";

        // 2. Create other tables
        echo "üè® Creating Hotel-Room relationships table...\n";
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_room_types (
            id INT AUTO_INCREMENT PRIMARY KEY,
            hotel_id INT,
            room_type_id INT,
            room_type_name VARCHAR(255),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            UNIQUE KEY unique_hotel_room (hotel_id, room_type_id)
        )");
        echo "‚úÖ Hotel-Room relationships table created\n\n";

        echo "üéØ Creating Features table...\n";
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_features (
            id INT PRIMARY KEY,
            name VARCHAR(500),
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");
        echo "‚úÖ Features table created\n\n";

        echo "üçΩÔ∏è Creating Meals table...\n";
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_meals (
            id INT PRIMARY KEY,
            name VARCHAR(255),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");
        echo "‚úÖ Meals table created\n\n";

        echo "üéâ SYNC COMPLETE!\n";
        echo "üìä Summary:\n";
        echo "  - Room Types: $roomTypesUpdated updated\n";
        echo "  - Hotel-Room relationships: Table ready\n";
        echo "  - Features: Table ready\n";
        echo "  - Meals: Table ready\n\n";

        echo "üîó Next steps:\n";
        echo "  1. Test prebook page for room names\n";
        echo "  2. Check database: https://shorttrips.eu/?check_room_types=1\n";
        echo "  3. Debug room names: https://shorttrips.eu/?debug_room_names=1\n";

        exit;
    }
});

// === ULTRA SIMPLE RESET & SYNC - NO HOOKS, DIRECT EXECUTION ===
if (isset($_GET['reset_and_sync']) && $_GET['reset_and_sync'] === '1') {
    // Check auth FIRST
    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        die('Not authorized - Please log in as WordPress admin');
    }

    @set_time_limit(300);
    @ini_set('memory_limit', '512M');

    header('Content-Type: text/plain; charset=utf-8');
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    echo "üî• ULTRA RESET & SYNC - FRESH START\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";

    global $wpdb;

    // STEP 1: DROP ALL SUNHOTELS TABLES
    echo "STEP 1: Dropping old tables...\n";
    $tables = [
        'ghwk_room_types',
        'ghwk_hotel_room_types',
        'ghwk_features',
        'ghwk_meals',
        'ghwk_hotel_note_types',
        'ghwk_room_note_types',
        'ghwk_themes',
        'ghwk_languages',
        'ghwk_room_types_corrupt_backup'
    ];

    foreach ($tables as $table) {
        $wpdb->query("DROP TABLE IF EXISTS $table");
        echo "   ‚úÖ Dropped $table\n";
    }
    echo "\n";

    // STEP 2: CREATE FRESH TABLES
    echo "STEP 2: Creating fresh tables...\n";

    $wpdb->query("CREATE TABLE ghwk_room_types (
        id INT PRIMARY KEY,
        name VARCHAR(255),
        description TEXT,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        INDEX idx_name (name(100))
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3");
    echo "   ‚úÖ Created ghwk_room_types\n";

    $wpdb->query("CREATE TABLE ghwk_hotel_room_types (
        id INT AUTO_INCREMENT PRIMARY KEY,
        hotel_id INT,
        room_type_id INT,
        room_type_name VARCHAR(255),
        description TEXT,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        UNIQUE KEY unique_hotel_room (hotel_id, room_type_id),
        INDEX idx_hotel (hotel_id),
        INDEX idx_room_type (room_type_id)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci");
    echo "   ‚úÖ Created ghwk_hotel_room_types\n\n";

    // STEP 3: SYNC WITH FILTERING
    echo "STEP 3: Syncing room types from API (with filtering)...\n";
    flush();

    $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => 'Freestays', 'password' => 'Vision2024!@', 'language' => 'en'];

    // NEW API FORMAT - Direct parameters, no <credentials> wrapper
    $soap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<GetRoomTypes xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>' . htmlspecialchars($creds['username'], ENT_XML1) . '</userName>'
        . '<password>' . htmlspecialchars($creds['password'], ENT_XML1) . '</password>'
        . '<language>' . htmlspecialchars($creds['language'], ENT_XML1) . '</language>'
        . '</GetRoomTypes>'
        . '</soap:Body>'
        . '</soap:Envelope>';

    $r = wp_remote_post('https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx', [
        'timeout' => 240,
        'headers' => [
            'Content-Type' => 'text/xml; charset=utf-8',
            'SOAPAction' => 'http://xml.sunhotels.net/15/GetRoomTypes'
        ],
        'body' => $soap
    ]);

    if (is_wp_error($r)) {
        echo "‚ùå API Error: " . $r->get_error_message() . "\n";
        exit;
    }

    echo "   ‚úÖ API Response received (" . number_format(strlen($r['body'])) . " bytes)\n";

    // Check if response is too small (likely error)
    if (strlen($r['body']) < 10000) {
        echo "\n‚ùå ERROR: Response too small - likely API error\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo "üìÑ Full API Response:\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo htmlspecialchars($r['body']);
        echo "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";

        // Check for SOAP fault
        if (stripos($r['body'], 'soap:fault') !== false || stripos($r['body'], 'faultstring') !== false) {
            preg_match('/<faultstring>(.*?)<\/faultstring>/i', $r['body'], $fault);
            if ($fault) {
                echo "‚ùå SOAP Error: " . htmlspecialchars($fault[1]) . "\n";
            }
        }

        echo "\nüí° POSSIBLE CAUSES:\n";
        echo "   1. Invalid API credentials\n";
        echo "   2. API endpoint changed\n";
        echo "   3. Network/firewall blocking request\n";
        echo "   4. API temporarily down\n\n";

        echo "üîë CREDENTIALS USED:\n";
        echo "   Username: " . $creds['username'] . "\n";
        echo "   Password: " . str_repeat('*', strlen($creds['password'])) . "\n";
        echo "   Language: " . $creds['language'] . "\n\n";

        exit;
    }

    echo "   üìÑ Parsing XML...\n";
    flush();

    // Parse with regex (reliable for large XML)
    preg_match_all('/<roomType>.*?<id>(\d+)<\/id>.*?<name>(.*?)<\/name>.*?<\/roomType>/s', $r['body'], $matches, PREG_SET_ORDER);

    echo "   ‚úÖ Found " . count($matches) . " room types in XML\n";

    if (count($matches) === 0) {
        echo "\n‚ùå ERROR: No room types found in XML!\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo "üìÑ First 2000 chars of response:\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo htmlspecialchars(substr($r['body'], 0, 2000));
        echo "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
        exit;
    }

    echo "   üîç Filtering and importing...\n";
    flush();

    $imported = 0;
    $skipped = 0;

    // STRICT FILTERING
    $invalidPatterns = [
        'wrong code',
        'cnl',
        '/id ',
        'id name',
        '/name',
        'shared bath',
        'dormitor',
        'female only',
        'male only',
        'beds)',
        'coed dorm',
        'en-suite'
    ];

    $validPrefixes = [
        'Single room',
        'Double room',
        'Twin room',
        'Twin/Double room',
        'Triple room',
        'Quadruple room',
        'Family room',
        'Suite',
        'Junior Suite',
        'Studio',
        'Apartment',
        'Villa',
        'Bungalow',
        'Chalet',
        'Cottage',
        'Cabana',
        'Penthouse',
        'Maisonette',
        'Presidential Suite',
        'Honeymoon Suite',
        'Water Villa',
        'Garden Villa',
        'Duplex',
        'Pavilion'
    ];

    foreach ($matches as $match) {
        $id = (int) $match[1];
        $name = html_entity_decode(trim($match[2]), ENT_QUOTES | ENT_XML1, 'UTF-8');

        if ($id <= 0 || empty($name) || strlen($name) < 3) {
            $skipped++;
            continue;
        }

        // Check invalid patterns
        $isInvalid = false;
        foreach ($invalidPatterns as $pattern) {
            if (stripos($name, $pattern) !== false) {
                $isInvalid = true;
                break;
            }
        }
        if ($isInvalid) {
            $skipped++;
            continue;
        }

        // Check valid prefixes
        $hasValidPrefix = false;
        foreach ($validPrefixes as $prefix) {
            if (stripos($name, $prefix) === 0) {
                $hasValidPrefix = true;
                break;
            }
        }
        if (!$hasValidPrefix) {
            $skipped++;
            continue;
        }

        // Import
        $result = $wpdb->query($wpdb->prepare(
            "INSERT IGNORE INTO ghwk_room_types (id, name, updated_at) VALUES (%d, %s, NOW())",
            $id,
            $name
        ));

        if ($result) {
            $imported++;
            if ($imported <= 10) {
                echo "      ‚Ä¢ ID $id: $name\n";
            }
        }
    }

    echo "\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    echo "‚úÖ SYNC COMPLETE!\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
    echo "üìä RESULTS:\n";
    echo "   ‚Ä¢ Total in API: " . count($matches) . "\n";
    echo "   ‚Ä¢ Imported: $imported\n";
    echo "   ‚Ä¢ Skipped (invalid): $skipped\n";

    // Calculate rejection rate (avoid division by zero)
    if (count($matches) > 0) {
        echo "   ‚Ä¢ Rejection rate: " . round(($skipped / count($matches)) * 100, 1) . "%\n\n";
    } else {
        echo "   ‚Ä¢ Rejection rate: N/A\n\n";
    }

    $finalCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
    echo "üìä DATABASE STATUS:\n";
    echo "   ‚Ä¢ ghwk_room_types: $finalCount records\n";
    echo "   ‚Ä¢ ghwk_hotel_room_types: 0 records (ready)\n\n";

    echo "‚úÖ DATABASE IS CLEAN!\n";
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";

    exit;
}

// === CRITICAL: TRUNCATE MUST RUN FIRST - BEFORE ANYTHING ELSE ===
// This runs at 'muplugins_loaded' which is THE EARLIEST possible hook
add_action('muplugins_loaded', function () {
    // TRUNCATE RESET: Complete database reset (most aggressive option)
    if (isset($_GET['truncate_room_types']) && $_GET['truncate_room_types'] === '1') {
        // Skip auth check initially to prevent OTHER hooks from running
        // We'll check auth and show UI right away

        header('Content-Type: text/plain; charset=utf-8');
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo "üíÄ TRUNCATE RESET: COMPLETE DATABASE WIPE\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";

        // Now check auth (user system should be available)
        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            echo "‚ùå ERROR: Not authorized\n";
            echo "   You must be logged in as WordPress admin\n";
            status_header(403);
            exit;
        }

        global $wpdb;

        $before = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
        echo "üìä Current records: " . number_format($before) . "\n\n";

        echo "üî• TRUNCATING ghwk_room_types...\n";
        $wpdb->query("TRUNCATE TABLE ghwk_room_types");
        $after = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
        echo "‚úÖ Table truncated! (Before: $before, After: $after)\n\n";

        echo "üî• TRUNCATING ghwk_hotel_room_types...\n";
        $wpdb->query("TRUNCATE TABLE ghwk_hotel_room_types");
        echo "‚úÖ Table truncated!\n\n";

        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo "‚úÖ COMPLETE RESET DONE!\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
        echo "üí° NEXT STEPS:\n";
        echo "   1. Run sync: https://shorttrips.eu/?sync_room_types=1\n";
        echo "   2. This will populate ONLY valid room types from API\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";

        exit; // STOP EVERYTHING - No other code will run
    }
}, -9999); // HIGHEST priority - run FIRST

add_action('init', function () {
    // ============================================================================
    // HOTEL SYNC - Must run with HIGHEST priority to prevent template loading
    // ============================================================================
    if (isset($_GET['sync_static_hotels'])) {
        // ‚úÖ CRITICAL: Stop WordPress from loading templates IMMEDIATELY
        define('SHORTTRIPS_SYNC_RUNNING', true);
        // CLI/HTTP_HOST-less calls: allow and fake minimal server vars to silence Polylang
        $sapi = php_sapi_name();
        $isCli = ($sapi === 'cli') || ($sapi === 'phpdbg') || (defined('WP_CLI') && WP_CLI) || empty($_SERVER['HTTP_HOST']);
        if ($isCli) {
            if (empty($_SERVER['HTTP_HOST'])) {
                $_SERVER['HTTP_HOST'] = parse_url(home_url(), PHP_URL_HOST) ?: 'localhost';
            }
            if (empty($_SERVER['REQUEST_URI'])) {
                $_SERVER['REQUEST_URI'] = '/';
            }
            if (!defined('SHORTTRIPS_SYNC_TRUSTED')) {
                define('SHORTTRIPS_SYNC_TRUSTED', true);
            }
        } else {
            // Immediately check auth and nonce
            nocache_headers();
            if (!is_user_logged_in() || !current_user_can('manage_options')) {
                status_header(403);
                exit('Not allowed');
            }
            $nonce = isset($_GET['_wpnonce']) ? $_GET['_wpnonce'] : '';
            if (empty($nonce) || !wp_verify_nonce($nonce, 'shorttrips_sync')) {
                status_header(403);
                exit('Invalid nonce');
            }
        }
        // If we reach here, sync is authorized - let it continue in the main handler below
    }

    // Cleanup corrupt room type data
    // FORCE CLEANUP: Aggressive cleanup for databases with 100K+ corrupt records
    if (isset($_GET['force_cleanup_room_types']) && $_GET['force_cleanup_room_types'] === '1') {
        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            status_header(403);
            exit('Not allowed');
        }

        header('Content-Type: text/plain; charset=utf-8');
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo "üö® FORCE CLEANUP: NUCLEAR OPTION\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";

        global $wpdb;
        $startTime = microtime(true);

        $beforeCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
        echo "üìä Current ghwk_room_types: " . number_format($beforeCount) . " records\n\n";

        if ($beforeCount > 10000) {
            echo "‚ö†Ô∏è  CRITICAL: Database has " . number_format($beforeCount) . " records!\n";
            echo "‚ö†Ô∏è  Expected: ~3000 clean records\n";
            echo "‚ö†Ô∏è  Strategy: Keep ONLY room types actually USED by hotels\n\n";
            echo "üî• Starting SMART cleanup...\n\n";

            // STEP 1: Create clean table with ONLY USED room types
            echo "STEP 1: Creating clean table with ONLY USED room types...\n";
            $wpdb->query("DROP TABLE IF EXISTS ghwk_room_types_clean");
            $wpdb->query("CREATE TABLE ghwk_room_types_clean LIKE ghwk_room_types");

            // Strategy: Keep ONLY room types that are:
            // 1. Used by hotels (exist in ghwk_hotel_room_types)
            // 2. OR are basic types (no specific modifiers like "Sea View", "Pool View", etc.)

            // First, copy room types that are ACTUALLY USED by hotels
            $usedQuery = "INSERT INTO ghwk_room_types_clean (id, name, description, updated_at)
                          SELECT DISTINCT rt.id, rt.name, rt.description, rt.updated_at
                          FROM ghwk_room_types rt
                          INNER JOIN ghwk_hotel_room_types hrt ON rt.id = hrt.room_type_id
                          WHERE LENGTH(rt.name) >= 12
                          AND LENGTH(rt.name) <= 100
                          AND rt.name NOT LIKE '%shared bath%'
                          AND rt.name NOT LIKE '%Shared bath%'
                          AND rt.name NOT LIKE '%/name%'
                          AND rt.name NOT LIKE '%sharedRoom%'
                          AND rt.name NOT LIKE '%Wrong Code%'
                          AND rt.name NOT LIKE '%Female only%'
                          AND rt.name NOT LIKE '%Male only%'
                          AND rt.name NOT LIKE '%Dormitor%'
                          AND rt.name NOT LIKE '%bedroom%'
                          AND rt.name NOT LIKE '%beds)%'
                          GROUP BY rt.id";

            $usedCount = $wpdb->query($usedQuery);
            echo "   ‚úÖ Step 1a: Copied " . number_format($usedCount) . " room types USED by hotels\n";

            // Second, add basic room types (fallback for hotels without specific types)
            $basicQuery = "INSERT IGNORE INTO ghwk_room_types_clean (id, name, description, updated_at)
                           SELECT id, name, description, updated_at
                           FROM ghwk_room_types
                           WHERE LENGTH(name) <= 30
                           AND name NOT LIKE '%-%'
                           AND name NOT LIKE '%shared bath%'
                           AND name NOT LIKE '%Dormitor%'
                           AND (
                               name = 'Single room'
                               OR name = 'Double room'
                               OR name = 'Twin room'
                               OR name = 'Twin/Double room'
                               OR name = 'Triple room'
                               OR name = 'Family room'
                               OR name = 'Suite'
                               OR name = 'Junior Suite'
                               OR name = 'Studio'
                               OR name LIKE 'Apartment % bedroom'
                               OR name LIKE 'Villa % bedroom%'
                               OR name = 'Bungalow'
                               OR name = 'Chalet'
                           )";

            $basicCount = $wpdb->query($basicQuery);
            echo "   ‚úÖ Step 1b: Added " . number_format($basicCount) . " basic fallback room types\n";

            $copied = $usedCount + $basicCount;
            echo "   ‚úÖ Extracted " . number_format($copied) . " CLEAN unique records\n\n";

            // STEP 2: Backup and replace
            echo "STEP 2: Replacing corrupt table with clean data...\n";
            $wpdb->query("DROP TABLE IF EXISTS ghwk_room_types_corrupt_backup");
            $wpdb->query("RENAME TABLE ghwk_room_types TO ghwk_room_types_corrupt_backup");
            $wpdb->query("RENAME TABLE ghwk_room_types_clean TO ghwk_room_types");
            echo "   ‚úÖ Replaced table\n";
            echo "   üíæ Corrupt data backed up to: ghwk_room_types_corrupt_backup\n\n";

        } else {
            echo "‚úÖ Database size is reasonable (" . number_format($beforeCount) . " records)\n";
            echo "   Running standard cleanup instead...\n\n";

            // Standard cleanup
            $deleted = $wpdb->query("DELETE FROM ghwk_room_types WHERE 
                name LIKE '%/name%' OR 
                name LIKE '%shared bath%' OR 
                name LIKE '%sharedRoom%' OR
                name LIKE '%Wrong Code%' OR 
                LENGTH(name) < 3");
            echo "   ‚úÖ Deleted $deleted corrupt records\n\n";
        }

        // STEP 3: Clean hotel_room_types
        echo "STEP 3: Cleaning ghwk_hotel_room_types...\n";
        $hotelDeleted = $wpdb->query("DELETE FROM ghwk_hotel_room_types WHERE 
            room_type_name LIKE '%/name%' OR 
            room_type_name LIKE '%shared bath%' OR 
            room_type_name LIKE '%Wrong Code%' OR
            LENGTH(room_type_name) < 3");
        echo "   ‚úÖ Deleted " . number_format($hotelDeleted) . " corrupt hotel-room records\n\n";

        // FINAL STATS
        $finalCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
        $hotelCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_room_types");

        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo "üéâ FORCE CLEANUP COMPLETE!\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
        echo "üìä BEFORE:  " . number_format($beforeCount) . " records (CORRUPT)\n";
        echo "üìä AFTER:   " . number_format($finalCount) . " records (CLEAN)\n";
        echo "üìä REMOVED: " . number_format($beforeCount - $finalCount) . " records\n";
        echo "üìä SAVINGS: " . number_format((($beforeCount - $finalCount) / $beforeCount) * 100, 1) . "% reduction\n\n";
        echo "üìä Hotel-room types: " . number_format($hotelCount) . " records\n\n";

        // Show samples
        $samples = $wpdb->get_results("SELECT id, name FROM ghwk_room_types ORDER BY id LIMIT 15", ARRAY_A);
        if ($samples) {
            echo "‚úÖ Sample of clean records:\n";
            foreach ($samples as $s) {
                echo "   - ID " . str_pad($s['id'], 4) . ": " . $s['name'] . "\n";
            }
        }

        $execTime = microtime(true) - $startTime;
        echo "\n‚è±Ô∏è  Execution time: " . number_format($execTime, 2) . " seconds\n";
        echo "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
        echo "‚úÖ DATABASE IS NOW CLEAN!\n";
        echo "\nüí° NEXT STEP: Fresh sync should work now\n";
        echo "   " . home_url('/?sync_room_types=1') . "\n";
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";

        exit;
    }

    if (isset($_GET['cleanup_room_types']) && $_GET['cleanup_room_types'] === '1') {
        // Admin-only gate
        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            status_header(403);
            exit('Not allowed - Please log in as WordPress admin first');
        }

        header('Content-Type: text/plain; charset=utf-8');
        echo "=== CLEANUP CORRUPT ROOM TYPE DATA ===\n\n";

        global $wpdb;

        // Show corrupt data before cleanup
        $corrupt = $wpdb->get_results("
            SELECT id, name FROM ghwk_room_types 
            WHERE name LIKE '%id name%' 
               OR name LIKE '%/id%'
               OR name LIKE '%Wrong Code%'
               OR name LIKE '%wrong code%'
               OR LENGTH(name) < 3
            ORDER BY id
        ", ARRAY_A);

        echo "üîç Found " . count($corrupt) . " corrupt room type records:\n";
        foreach (array_slice($corrupt, 0, 10) as $c) {
            echo "  - ID " . $c['id'] . ": " . $c['name'] . "\n";
        }
        if (count($corrupt) > 10) {
            echo "  ... and " . (count($corrupt) - 10) . " more\n";
        }
        echo "\n";

        // Delete corrupt records from ghwk_room_types
        $deleted1 = $wpdb->query("
            DELETE FROM ghwk_room_types 
            WHERE name LIKE '%id name%' 
               OR name LIKE '%/id%'
               OR name LIKE '%Wrong Code%'
               OR name LIKE '%wrong code%'
               OR LENGTH(name) < 3
        ");

        echo "üóëÔ∏è Deleted $deleted1 corrupt records from ghwk_room_types\n";

        // Show corrupt data in ghwk_hotel_room_types
        $corruptHotel = $wpdb->get_results("
            SELECT hotel_id, room_type_id, room_type_name FROM ghwk_hotel_room_types 
            WHERE room_type_name LIKE '%id name%' 
               OR room_type_name LIKE '%/id%'
               OR room_type_name LIKE '%Wrong Code%'
               OR room_type_name LIKE '%wrong code%'
               OR LENGTH(room_type_name) < 3
            ORDER BY hotel_id LIMIT 20
        ", ARRAY_A);

        echo "\nüîç Found " . count($corruptHotel) . " corrupt hotel-room type records\n";
        foreach (array_slice($corruptHotel, 0, 5) as $c) {
            echo "  - Hotel " . $c['hotel_id'] . ", Room Type " . $c['room_type_id'] . ": " . $c['room_type_name'] . "\n";
        }

        // Delete corrupt records from ghwk_hotel_room_types
        $deleted2 = $wpdb->query("
            DELETE FROM ghwk_hotel_room_types 
            WHERE room_type_name LIKE '%id name%' 
               OR room_type_name LIKE '%/id%'
               OR room_type_name LIKE '%Wrong Code%'
               OR room_type_name LIKE '%wrong code%'
               OR LENGTH(room_type_name) < 3
        ");

        echo "üóëÔ∏è Deleted $deleted2 corrupt records from ghwk_hotel_room_types\n";

        // Show remaining counts
        $totalRoomTypes = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
        $totalHotelRoomTypes = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_room_types");

        echo "\nüìä Remaining records:\n";
        echo "  - ghwk_room_types: $totalRoomTypes\n";
        echo "  - ghwk_hotel_room_types: $totalHotelRoomTypes\n";

        // Show sample of good remaining data
        $goodSamples = $wpdb->get_results("
            SELECT id, name FROM ghwk_room_types 
            WHERE LENGTH(name) >= 5 
            ORDER BY id LIMIT 10
        ", ARRAY_A);

        if ($goodSamples) {
            echo "\n‚úÖ Sample of good room types:\n";
            foreach ($goodSamples as $s) {
                echo "  - ID " . $s['id'] . ": " . $s['name'] . "\n";
            }
        }

        echo "\nüéâ Cleanup completed!\n";
        echo "üí° Now run sync again: " . home_url('/?sync_room_types=1') . "\n";

        exit;
    }

    if (isset($_GET['sync_room_types']) && $_GET['sync_room_types'] === '1') {
        // Admin-only gate
        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            status_header(403);
            exit('Not allowed - Please log in as WordPress admin first');
        }

        // Increase limits for large API response
        @set_time_limit(300);  // 5 minutes
        @ini_set('memory_limit', '512M');
        @ini_set('max_execution_time', '300');

        header('Content-Type: text/plain; charset=utf-8');
        echo "=== DIRECT ROOM TYPES SYNC ===\n\n";
        echo "‚öôÔ∏è  Execution time limit: 300 seconds\n";
        echo "‚öôÔ∏è  Memory limit: 512M\n\n";

        // Run room types sync directly
        $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
        $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

        echo "üîÑ Starting Room Types sync...\n";
        echo "üîë Username: " . $creds['username'] . "\n";
        flush();

        // Create room types table
        global $wpdb;
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_types (
            id INT PRIMARY KEY,
            name VARCHAR(255),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

        echo "üìä Current database status:\n";
        $currentCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
        echo "   Existing room types: $currentCount\n\n";
        flush();

        // Build SOAP request
        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<GetRoomTypes xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</GetRoomTypes>'
            . '</soap:Body>'
            . '</soap:Envelope>';

        echo "üì§ Sending API request...\n";
        $startTime = microtime(true);
        flush();

        $r = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetRoomTypes"'],
            'body' => $soap,
            'timeout' => 240  // Increased to 4 minutes
        ]);

        if (is_wp_error($r)) {
            echo "‚ùå Error: " . $r->get_error_message() . "\n";
            exit;
        } else {
            $responseTime = microtime(true) - $startTime;
            $responseSize = strlen($r['body']);
            echo "‚úÖ Response received: " . number_format($responseSize) . " bytes in " . number_format($responseTime, 2) . " seconds\n";

            if ($responseSize > 1000000) {
                echo "‚ö†Ô∏è  Large response detected (" . number_format($responseSize / 1024 / 1024, 2) . " MB) - processing may take time...\n";
            }
            flush();

            // Parse using REGEX (reliable for 27MB XML)
            echo "üìÑ Parsing XML with regex (optimized for large responses)...\n";
            $parseStart = microtime(true);

            // Extract all <roomType>...</roomType> blocks
            preg_match_all('/<roomType>.*?<id>(\d+)<\/id>.*?<name>(.*?)<\/name>.*?<\/roomType>/s', $r['body'], $matches, PREG_SET_ORDER);

            if (empty($matches)) {
                echo "‚ùå No room types found with regex pattern\n";
                echo "üìÑ Response sample: " . substr($r['body'], 0, 1000) . "\n";
                exit;
            }

            echo "‚úÖ Found " . count($matches) . " room types with regex parser\n";
            $nodes = $matches; // Use matches as nodes

            $updated = 0;

            // Process regex matches
            echo "üîç Processing " . count($nodes) . " room types...\n";
            flush();

            foreach ($nodes as $i => $match) {
                // $match[0] = full match, $match[1] = id, $match[2] = name
                $id = (int) $match[1];
                $name = trim($match[2]);

                // Clean name - decode HTML entities
                $name = html_entity_decode($name, ENT_QUOTES | ENT_XML1, 'UTF-8');
                $name = trim($name);

                // Skip if invalid
                if ($id <= 0 || empty($name) || strlen($name) < 3) {
                    continue;
                }

                // STRICT FILTERING: Skip invalid/useless room types
                $invalidPatterns = [
                    'wrong code',
                    'cnl',
                    '/id ',
                    'id name',
                    '/name',
                    'shared bath',
                    'dormitor',
                    'female only',
                    'male only',
                    'beds)',
                    'coed dorm',
                    'en-suite bathroom'
                ];

                $isInvalid = false;
                foreach ($invalidPatterns as $pattern) {
                    if (stripos($name, $pattern) !== false) {
                        $isInvalid = true;
                        break;
                    }
                }

                if ($isInvalid) {
                    continue;
                }

                // Only import room types that start with valid prefixes
                $validPrefixes = [
                    'Single room',
                    'Double room',
                    'Twin room',
                    'Twin/Double room',
                    'Triple room',
                    'Quadruple room',
                    'Family room',
                    'Suite',
                    'Junior Suite',
                    'Studio',
                    'Apartment',
                    'Villa',
                    'Bungalow',
                    'Chalet',
                    'Cottage',
                    'Cabana',
                    'Penthouse',
                    'Maisonette',
                    'Presidential Suite',
                    'Honeymoon Suite',
                    'Water Villa',
                    'Garden Villa',
                    'Duplex',
                    'Pavilion'
                ];

                $hasValidPrefix = false;
                foreach ($validPrefixes as $prefix) {
                    if (stripos($name, $prefix) === 0) {
                        $hasValidPrefix = true;
                        break;
                    }
                }

                if (!$hasValidPrefix) {
                    continue; // Skip if doesn't start with valid prefix
                }

                $result = $wpdb->query($wpdb->prepare(
                    "REPLACE INTO ghwk_room_types (id, name, updated_at) VALUES (%d, %s, NOW())",
                    $id,
                    $name
                ));

                if ($result !== false) {
                    $updated++;

                    // Show first 10 examples
                    if ($updated <= 10) {
                        echo "  ‚úÖ ID=$id: '$name'\n";
                    }
                }

                // Progress update every 500 items
                if ($i > 0 && $i % 500 === 0) {
                    echo "üìà Progress: $i/" . count($nodes) . " processed, $updated saved\n";
                    flush();
                }
            }

            echo "‚úÖ Room Types updated: $updated\n";
            flush();

            // Show final count
            $totalCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
            echo "üìä Total room types in database: $totalCount\n";

            // Show sample of good names
            $samples = $wpdb->get_results("SELECT id, name FROM ghwk_room_types WHERE LENGTH(name) > 5 AND name NOT LIKE '%wrong%' ORDER BY id LIMIT 5", ARRAY_A);
            if ($samples) {
                echo "\nüìã Sample room types:\n";
                foreach ($samples as $s) {
                    echo "  - ID " . $s['id'] . ": " . $s['name'] . "\n";
                }
            }

            // Performance stats
            $totalTime = microtime(true) - $startTime;
            echo "\n‚è±Ô∏è  Total execution time: " . number_format($totalTime, 2) . " seconds\n";
            echo "üíæ Memory peak usage: " . number_format(memory_get_peak_usage() / 1024 / 1024, 2) . " MB\n";

            echo "\nüéâ Sync completed successfully!\n";
            echo "\nüí° Next steps:\n";
            echo "   1. Review the sample room types above\n";
            echo "   2. If names look good, sync hotel-room relationships\n";
            echo "   3. If still issues, contact API support\n";
        }

        exit;
    }

    if (!isset($_GET['sync_static_hotels']))
        return;

    $sync_log = static function ($message) {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('[Shorttrips Sync] ' . $message);
        }
    };
    $read_query_int = static function ($key, $default, $min, $max) use ($sync_log) {
        $value = $_GET[$key] ?? $default;
        if (is_array($value)) {
            $sync_log(sprintf('%s provided as array, using first element.', $key));
            $value = reset($value);
        }
        if (!is_numeric($value)) {
            $sync_log(sprintf('%s invalid value "%s" ‚Äì falling back to %d', $key, is_scalar($value) ? $value : '(non-scalar)', $default));
            return (int) $default;
        }
        $value = (int) $value;
        $clamped = max($min, min($value, $max));
        if ($clamped !== $value) {
            $sync_log(sprintf('%s clamped from %d to %d', $key, $value, $clamped));
        }
        return $clamped;
    };

    // ‚úÖ CRITICAL: Stop WordPress from loading templates
    // This prevents front-page.php from overriding our sync output
    if (!defined('SHORTTRIPS_SYNC_RUNNING')) {
        define('SHORTTRIPS_SYNC_RUNNING', true);
    }
    remove_all_actions('template_redirect');
    remove_all_actions('wp');

    // Admin-only gate with nonce to prevent public abuse and WAF blocks
    nocache_headers();
    $sapi = php_sapi_name();
    $isCli = ($sapi === 'cli') || ($sapi === 'phpdbg') || (defined('WP_CLI') && WP_CLI) || empty($_SERVER['HTTP_HOST']);
    // Avoid Polylang notices in CLI by faking basic server vars
    if ($isCli) {
        if (empty($_SERVER['HTTP_HOST'])) {
            $_SERVER['HTTP_HOST'] = parse_url(home_url(), PHP_URL_HOST) ?: 'localhost';
        }
        if (empty($_SERVER['REQUEST_URI'])) {
            $_SERVER['REQUEST_URI'] = '/';
        }
    }
    if (!$isCli) {
        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            status_header(403);
            exit('Not allowed');
        }
        $nonce = isset($_GET['_wpnonce']) ? $_GET['_wpnonce'] : '';
        if (empty($nonce) || !wp_verify_nonce($nonce, 'shorttrips_sync')) {
            status_header(403);
            exit('Invalid nonce');
        }
    }
    ignore_user_abort(true);
    @set_time_limit(0);

    // Auto-run runner page (HTML + JS) ‚Äì allows chaining via direct URL using &auto=1
    if (isset($_GET['auto']) && $_GET['auto'] == '1') {
        $frontUrl = home_url('/');
        $limit = $read_query_int('limit', 25, 10, 250);
        $batch = $read_query_int('sync_static_hotels', 1, 1, 100000);
        $skipOnTimeout = isset($_GET['skip_on_timeout']) && $_GET['skip_on_timeout'] === '1';
        if (!headers_sent()) {
            header('Content-Type: text/html; charset=utf-8');
        }
        echo '<!doctype html><meta charset="utf-8"><title>Shorttrips Hotel Sync Runner</title>';
        echo '<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:900px;margin:20px auto;padding:0 20px;} pre{background:#111;color:#d4d4d4;padding:15px;border-radius:8px;height:400px;overflow:auto;font-size:13px;line-height:1.5;} button{padding:8px 16px;margin:4px;cursor:pointer;border:none;border-radius:4px;font-size:14px;} #stop{background:#dc3545;color:white;} #next{background:#28a745;color:white;} #pause{background:#ffc107;color:#000;} .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;} .stat-card{background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #007bff;} .stat-label{font-size:12px;color:#6c757d;text-transform:uppercase;margin-bottom:5px;} .stat-value{font-size:24px;font-weight:bold;color:#212529;}</style>';
        echo '<h1>üè® Hotel Sync Auto Runner</h1>';
        echo '<div class="stats"><div class="stat-card"><div class="stat-label">Batch Size</div><div class="stat-value" id="limit-display">' . intval($limit) . '</div></div><div class="stat-card"><div class="stat-label">Current Batch</div><div class="stat-value" id="batch-display">' . intval($batch) . '</div></div><div class="stat-card"><div class="stat-label">Total Batches</div><div class="stat-value" id="total-batches">...</div></div><div class="stat-card"><div class="stat-label">Status</div><div class="stat-value" id="status-display">Starting...</div></div></div>';
        echo '<pre id="log">üöÄ Initializing auto runner...\nüìä Batch size: ' . intval($limit) . ' destinations per batch\n‚è±Ô∏è  Timeout: 8 minutes per batch\n</pre>';
        echo '<p><button id="stop">‚èπÔ∏è Stop</button> <button id="pause">‚è∏Ô∏è Pause</button> <button id="next">‚ñ∂Ô∏è Run Next</button></p>';
        echo '<script>';
        echo '(()=>{ const front=' . json_encode(trailingslashit($frontUrl)) . '; const nonce=' . json_encode($nonce) . '; let limit=' . intval($limit) . '; let batch=' . intval($batch) . '; let stopped=false; let paused=false; const skipOnTimeout=' . ($skipOnTimeout ? 'true' : 'false') . '; const logEl=document.getElementById("log"); const batchDisplay=document.getElementById("batch-display"); const statusDisplay=document.getElementById("status-display"); const totalBatchesEl=document.getElementById("total-batches"); const log=(t)=>{ let ts=""; try{ ts = new Date().toISOString().slice(11,19); }catch(e){} if(ts){ logEl.textContent += "\n["+ts+"] "+t; } else { logEl.textContent += "\n"+t; } logEl.scrollTop=logEl.scrollHeight; }; const FETCH_TIMEOUT_MS=480000; let failedBatches=[]; async function fetchWithTimeout(url,ms){ const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),ms); try{ return await fetch(url,{credentials:"same-origin",cache:"no-store",signal:ctrl.signal}); } finally{ clearTimeout(to); } } document.getElementById("stop").onclick=()=>{stopped=true; statusDisplay.textContent="Stopped"; log("‚èπÔ∏è Stopped by user"); }; document.getElementById("pause").onclick=()=>{paused=!paused; statusDisplay.textContent=paused?"Paused":"Running"; log(paused?"‚è∏Ô∏è Paused":"‚ñ∂Ô∏è Resumed"); }; document.getElementById("next").onclick=()=>{ if(!stopped && paused){ paused=false; runOne(); } }; async function fetchInfo(){ const url = front+"?sync_static_hotels=1&info_only=1&limit="+limit+"&format=json&_wpnonce="+nonce; const r = await fetchWithTimeout(url,120000); if(!r.ok) throw new Error("Info HTTP "+r.status); return await r.json(); } async function runOne(){ if(stopped) return; if(paused){ statusDisplay.textContent="Paused"; return; } try{ statusDisplay.textContent="Fetching info..."; const info=await fetchInfo(); const total=info && info.total_destinations?parseInt(info.total_destinations):0; const totalBatches = Math.max(1, Math.ceil(total/limit)); totalBatchesEl.textContent=totalBatches; batchDisplay.textContent=batch; const progress = Math.round((batch/totalBatches)*100); statusDisplay.textContent="Running ("+progress+"%)"; log("‚û°Ô∏è Batch "+batch+"/"+totalBatches+" (limit="+limit+")"); const url = front+"?sync_static_hotels="+batch+"&limit="+limit+"&format=json&_wpnonce="+nonce; const startTime=Date.now(); const r = await fetchWithTimeout(url,FETCH_TIMEOUT_MS); const elapsed=((Date.now()-startTime)/1000).toFixed(1); if(!r.ok){ const txt=await r.text(); throw new Error("HTTP "+r.status+" - "+txt); } const d = await r.json(); const hotels=d.hotels_inserted||d.hotels_updated||0; log("‚úÖ Batch "+batch+" completed in "+elapsed+"s ("+hotels+" hotels)"); const info2 = await fetchInfo().catch(()=>null); let nb = info2 && info2.next_batch ? parseInt(info2.next_batch) : (batch<totalBatches?batch+1:1); batch = nb; if (!stopped && !paused && batch !== 1) { await new Promise(resolve=>setTimeout(resolve,500)); runOne(); } else if (!stopped && !paused) { statusDisplay.textContent="Complete!"; log("üèÅ All batches completed!"); if(failedBatches.length>0){ log("‚ö†Ô∏è Failed batches: "+failedBatches.join(", ")); log("üí° Retry with: &limit=10 for failed batches"); } } } catch(e){ const isTimeout = e && e.message && e.message.includes("abort"); if(isTimeout){ log("‚è±Ô∏è Batch "+batch+" timed out"); failedBatches.push(batch); if(skipOnTimeout){ log("‚è≠Ô∏è Skipping batch "+batch+", continuing with "+(batch+1)); batch++; if(!stopped && !paused){ await new Promise(resolve=>setTimeout(resolve,1000)); runOne(); } return; } else { log("‚ùå Stopped due to timeout. Add &skip_on_timeout=1 to auto-skip"); statusDisplay.textContent="Timeout"; stopped=true; } } else { log("‚ùå Error: "+(e && e.message ? e.message : e)); statusDisplay.textContent="Error"; stopped=true; } } } log("üîÑ Starting sync from batch "+batch+"..."); runOne(); })();';
        echo '</script>';
        die();
    }

    $format = $_GET['format'] ?? 'text';
    $infoOnly = isset($_GET['info_only']) && $_GET['info_only'] == '1';
    $lookupsOnly = isset($_GET['lookups_only']) && $_GET['lookups_only'] == '1';

    while (ob_get_level()) {
        ob_end_clean();
    }

    if (!headers_sent()) {
        if ($format === 'json') {
            header('Content-Type: application/json; charset=utf-8');
        } else {
            header('Content-Type: text/plain; charset=utf-8');
        }
    }
    // Reset requested: reset next batch index to 1
    if (isset($_GET['reset']) && $_GET['reset'] == '1') {
        update_option('shorttrips_sync_next_batch', 1);
        if ($format === 'json') {
            echo shorttrips_safe_json_encode(['message' => 'Reset to batch 1']);
        } else {
            echo "üîÑ Reset next batch to 1\n";
        }
        die();
    }


    @ini_set('max_execution_time', 1800);
    @ini_set('memory_limit', '1024M');

    global $wpdb;
    // Determine target hotels table dynamically to avoid writing to a non-existent schema
    $table = 'ghwk_bravo_hotels';
    $candidates = [
        'ghwk_bravo_hotels',
        $wpdb->prefix . 'bravo_hotels',
        'bravo_hotels',
    ];
    $requiredCols = ['hotel_id', 'title', 'slug', 'content', 'description', 'updated_at'];
    $chosen = null;
    foreach ($candidates as $cand) {
        $exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $cand));
        if (!$exists)
            continue;
        $cols = (array) $wpdb->get_col("SHOW COLUMNS FROM {$cand}");
        $missing = array_values(array_diff($requiredCols, $cols));
        if (empty($missing)) {
            $chosen = $cand;
            break;
        }
    }
    if ($chosen) {
        $table = $chosen;
        // Capture column set for downstream conditional updates
        $cols = (array) $wpdb->get_col("SHOW COLUMNS FROM {$table}");
        $hasStarsCol = in_array('stars', $cols, true);
    } else {
        // No suitable table found; bail with clear error message
        if (($_GET['format'] ?? '') === 'json') {
            echo shorttrips_safe_json_encode([
                'error' => 'No suitable hotels table found with required columns',
                'candidates' => $candidates,
                'required_columns' => $requiredCols,
            ]);
        } else {
            echo "‚ùå Geen geschikte hotels-tabel gevonden met vereiste kolommen. Geprobeerd: " . implode(', ', $candidates) . "\n";
        }
        die();
    }
    $creds = shorttrips_get_api_credentials();
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

    // Helpers for lookup tables (dynamic column names)
    $st_col_exists = function (string $table, string $col) use ($wpdb) {
        return (bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `$table` LIKE %s", $col));
    };
    $st_name_col = function (string $table) use ($st_col_exists) {
        return $st_col_exists($table, 'name') ? 'name' : ($st_col_exists($table, 'nameIndex') ? 'nameIndex' : 'name');
    };
    $st_img_col = function (string $table) use ($st_col_exists) {
        return $st_col_exists($table, 'image') ? 'image' : ($st_col_exists($table, 'image_url') ? 'image_url' : 'image');
    };
    // Optional: refresh lookups before hotel batches
    // ‚úÖ FIXED: Only run lookups on first batch OR when explicitly requested via &with_lookups=1
    // This prevents duplicate API calls on every batch
    $refreshLookups = isset($_GET['with_lookups']) && $_GET['with_lookups'] === '1';
    $isFirstBatch = isset($_GET['sync_static_hotels']) && intval($_GET['sync_static_hotels']) === 1;
    $refreshLookups = $refreshLookups || $isFirstBatch; // Run on first batch or when requested

    if ($refreshLookups) {
        if ($format !== 'json') {
            echo "üîÑ Refreshing lookup tables (Features, Themes, Meals, RoomTypes, etc.)...\n";
            echo "üîë Using credentials: Username=" . $creds['username'] . ", Language=" . $creds['language'] . "\n";
            echo "üåê Endpoint: " . $endpoint . "\n";
        }

        // 1. GetRoomTypes - CRUCIAL for room names!
        if ($format !== 'json')
            echo "üìã Syncing Room Types...\n";
        $roomTypesUpdated = 0;

        // Create room types table if not exists
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_types (
            id INT PRIMARY KEY,
            name VARCHAR(255),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<GetRoomTypes xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</GetRoomTypes>'
            . '</soap:Body>'
            . '</soap:Envelope>';

        $r = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetRoomTypes"'],
            'body' => $soap,
            'timeout' => 120,
            'stream' => false,
            'sslverify' => false // In case of SSL issues
        ]);

        if (is_wp_error($r)) {
            if ($format !== 'json')
                echo "‚ùå GetRoomTypes WP Error: " . $r->get_error_message() . "\n";
        } elseif (empty($r['body'])) {
            if ($format !== 'json')
                echo "‚ùå GetRoomTypes Empty response\n";
        } else {

            $responseSize = strlen($r['body']);
            if ($format !== 'json')
                echo "üìä Response size: " . number_format($responseSize) . " bytes\n";// Increase memory limit for large XML parsing
            $oldMemoryLimit = ini_get('memory_limit');
            ini_set('memory_limit', '512M');

            // Use libxml to handle large XML files
            libxml_use_internal_errors(true);
            $sx = @simplexml_load_string($r['body'], 'SimpleXMLElement', LIBXML_PARSEHUGE | LIBXML_BIGLINES);

            if (!$sx) {
                $xmlErrors = libxml_get_errors();
                $errorMsg = 'XML parsing failed';
                if (!empty($xmlErrors)) {
                    $errorMsg .= ': ' . $xmlErrors[0]->message;
                }
                if ($format !== 'json')
                    echo "‚ùå GetRoomTypes $errorMsg\n";
                libxml_clear_errors();

                // Restore memory limit
                ini_set('memory_limit', $oldMemoryLimit);
            } else {
                if ($format !== 'json')
                    echo "‚úÖ XML parsed successfully (size: " . number_format($responseSize) . " bytes)\n";
                $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

                // Try multiple XPath patterns
                $xpathPatterns = [
                    '//soap:Body//sh:getRoomTypesResult//sh:roomTypes//sh:roomType',
                    '//soap:Body//getRoomTypesResult//roomTypes//roomType',
                    '//getRoomTypesResult//roomTypes//roomType',
                    '//roomTypes//roomType',
                    '//roomType'
                ];

                $nodes = null;
                foreach ($xpathPatterns as $pattern) {
                    $nodes = $sx->xpath($pattern);
                    if ($nodes && count($nodes) > 0) {
                        if ($format !== 'json')
                            echo "üîç Found " . count($nodes) . " room types with pattern: $pattern\n";
                        break;
                    }
                }

                if (!$nodes || count($nodes) === 0) {
                    if ($format !== 'json')
                        echo "‚ùå No room type nodes found.\n";
                } else {
                    $totalNodes = count($nodes);
                    if ($format !== 'json')
                        echo "üîç Processing $totalNodes room type nodes...\n";

                    // Process in batches to avoid memory issues
                    $batchSize = 100;
                    $processed = 0;

                    for ($i = 0; $i < $totalNodes; $i += $batchSize) {
                        $batch = array_slice($nodes, $i, $batchSize);

                        foreach ($batch as $rt) {
                            $id = intval((string) ($rt->id ?? $rt->Id ?? ''));
                            $name = trim((string) ($rt->name ?? $rt->Name ?? ''));
                            $desc = trim((string) ($rt->description ?? $rt->Description ?? ''));

                            if ($id > 0 && $name !== '') {
                                $result = $wpdb->query($wpdb->prepare(
                                    "REPLACE INTO ghwk_room_types (id, name, description, updated_at) VALUES (%d, %s, %s, NOW())",
                                    $id,
                                    $name,
                                    $desc
                                ));
                                if ($result !== false) {
                                    $roomTypesUpdated++;
                                } else {
                                }
                            }
                            $processed++;
                        }

                        // Progress update for large datasets
                        if ($format !== 'json' && $totalNodes > 500) {
                            $percent = round(($processed / $totalNodes) * 100);
                            echo "üìà Progress: $processed/$totalNodes ($percent%)\n";
                        }

                        // Clear memory periodically
                        if ($i % 500 === 0) {
                            gc_collect_cycles();
                        }
                    }
                }

                // Restore memory limit
                ini_set('memory_limit', $oldMemoryLimit);
            }
        }
        if ($format !== 'json')
            echo "‚úÖ Room Types updated: $roomTypesUpdated\n";

        // 1.5. GetStaticHotelsAndRooms - CRUCIAL for hotel-room relationships!
        if ($format !== 'json')
            echo "üè® Syncing Hotel-Room relationships...\n";
        $hotelRoomTypesUpdated = 0;

        // Create hotel_room_types table if not exists
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_room_types (
            id INT AUTO_INCREMENT PRIMARY KEY,
            hotel_id INT,
            room_type_id INT,
            room_type_name VARCHAR(255),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            UNIQUE KEY unique_hotel_room (hotel_id, room_type_id)
        )");

        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<GetStaticHotelsAndRooms xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</GetStaticHotelsAndRooms>'
            . '</soap:Body>'
            . '</soap:Envelope>';

        $r = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetStaticHotelsAndRooms"'],
            'body' => $soap,
            'timeout' => 120
        ]);

        if (is_wp_error($r)) {
            if ($format !== 'json')
                echo "‚ùå GetStaticHotelsAndRooms WP Error: " . $r->get_error_message() . "\n";
        } elseif (empty($r['body'])) {
            if ($format !== 'json')
                echo "‚ùå GetStaticHotelsAndRooms Empty response\n";
        } else {
            $responseSize = strlen($r['body']);
            if ($format !== 'json')
                echo "üìä Response size: " . number_format($responseSize) . " bytes\n";

            libxml_use_internal_errors(true);
            $sx = @simplexml_load_string($r['body'], 'SimpleXMLElement', LIBXML_PARSEHUGE | LIBXML_BIGLINES);

            if (!$sx) {
                if ($format !== 'json')
                    echo "‚ùå GetStaticHotelsAndRooms XML parsing failed\n";
            } else {
                $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

                // Try to find hotels with room types
                $xpathPatterns = [
                    '//soap:Body//sh:getStaticHotelsAndRoomsResult//sh:hotels//sh:hotel',
                    '//getStaticHotelsAndRoomsResult//hotels//hotel',
                    '//hotels//hotel',
                    '//hotel'
                ];

                $hotelNodes = null;
                foreach ($xpathPatterns as $pattern) {
                    $hotelNodes = $sx->xpath($pattern);
                    if ($hotelNodes && count($hotelNodes) > 0) {
                        if ($format !== 'json')
                            echo "üîç Found " . count($hotelNodes) . " hotels with pattern: $pattern\n";
                        break;
                    }
                }

                if ($hotelNodes && count($hotelNodes) > 0) {
                    foreach ($hotelNodes as $hotel) {
                        $hotelId = intval((string) ($hotel->id ?? $hotel->Id ?? ''));
                        if ($hotelId <= 0)
                            continue;

                        // Look for room types within this hotel
                        $roomTypes = $hotel->xpath('.//roomType | .//roomTypes//roomType | .//rooms//room');
                        if ($roomTypes) {
                            foreach ($roomTypes as $room) {
                                $roomTypeId = intval((string) ($room->roomTypeId ?? $room->id ?? $room->Id ?? ''));
                                $roomTypeName = trim((string) ($room->roomTypeName ?? $room->name ?? $room->Name ?? $room->type ?? ''));
                                $description = trim((string) ($room->description ?? $room->Description ?? ''));

                                if ($hotelId > 0 && $roomTypeId > 0 && $roomTypeName !== '') {
                                    // Write to ghwk_hotel_room_types
                                    $result = $wpdb->query($wpdb->prepare(
                                        "REPLACE INTO ghwk_hotel_room_types (hotel_id, room_type_id, room_type_name, description, updated_at) VALUES (%d, %d, %s, %s, NOW())",
                                        $hotelId,
                                        $roomTypeId,
                                        $roomTypeName,
                                        $description
                                    ));

                                    // Note: We don't write to ghwk_term_relationships as it's a WordPress taxonomies table

                                    if ($result !== false) {
                                        $hotelRoomTypesUpdated++;
                                    } else {
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        if ($format !== 'json')
            echo "‚úÖ Hotel-Room relationships updated: $hotelRoomTypesUpdated\n";

        // 2. Features (NonStatic ‚Üí fallback Static)
        if ($format !== 'json')
            echo "üéØ Syncing Features...\n";
        $feats = [];
        $xml = shorttrips_call_nonstatic_xml('GetFeatures');
        if ($xml) {
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            $nodes = $xml->xpath('//sh:features//sh:feature | //features//feature');
            if ($nodes) {
                foreach ($nodes as $n) {
                    $id = intval((string) ($n->id ?? $n->Id ?? ($n['id'] ?? $n['Id'] ?? '')));
                    $name = trim((string) ($n->name ?? $n->Name ?? (string) $n));
                    if ($id <= 0 && $name !== '') {
                        $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                    }if ($id > 0 && $name !== '') {
                        $feats[] = ['id' => $id, 'name' => $name];
                    }
                }
            }
        }
        if (empty($feats)) {
            $soap = '<?xml version="1.0" encoding="utf-8"?>' . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><GetFeatures xmlns="http://xml.sunhotels.net/15/"><userName>' . esc_html($creds['username']) . '</userName><password>' . esc_html($creds['password']) . '</password><language>' . esc_html($creds['language']) . '</language></GetFeatures></soap:Body></soap:Envelope>';
            $r = wp_remote_post($endpoint, ['headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetFeatures"'], 'body' => $soap, 'timeout' => 60]);
            if (!is_wp_error($r) && !empty($r['body'])) {
                $sx = @simplexml_load_string($r['body']);
                if ($sx) {
                    $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    $nodes = $sx->xpath('//soap:Body//sh:getFeaturesResult//sh:features//sh:feature');
                    if ($nodes) {
                        foreach ($nodes as $n) {
                            $id = intval((string) ($n->id ?? $n->Id ?? ($n['id'] ?? $n['Id'] ?? '')));
                            $name = trim((string) ($n->name ?? $n->Name ?? (string) $n));
                            if ($id <= 0 && $name !== '') {
                                $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                            }if ($id > 0 && $name !== '') {
                                $feats[] = ['id' => $id, 'name' => $name];
                            }
                        }
                    }
                }
            }
            // Create features table if not exists
            $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_features (
            id INT PRIMARY KEY,
            name VARCHAR(500),
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

            $featuresUpdated = 0;
            if (!empty($feats)) {
                foreach ($feats as $it) {
                    $result = $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_features (id, name, updated_at) VALUES (%d, %s, NOW())", $it['id'], $it['name']));
                    if ($result !== false) {
                        $featuresUpdated++;
                    } else {
                    }
                }
            }
            if ($format !== 'json')
                echo "‚úÖ Features updated: $featuresUpdated\n";

            // 3. GetDestinations - Important for location data
            if ($format !== 'json')
                echo "üåç Syncing Destinations...\n";
            $destinationsUpdated = 0;
            $soap = '<?xml version="1.0" encoding="utf-8"?>'
                . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
                . '<soap:Body>'
                . '<GetDestinations xmlns="http://xml.sunhotels.net/15/">'
                . '<userName>' . esc_html($creds['username']) . '</userName>'
                . '<password>' . esc_html($creds['password']) . '</password>'
                . '<language>' . esc_html($creds['language']) . '</language>'
                . '</GetDestinations>'
                . '</soap:Body>'
                . '</soap:Envelope>';

            $r = wp_remote_post($endpoint, [
                'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetDestinations"'],
                'body' => $soap,
                'timeout' => 60
            ]);

            if (!is_wp_error($r) && !empty($r['body'])) {
                libxml_use_internal_errors(true);
                $sx = @simplexml_load_string($r['body']);
                if ($sx) {
                    $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

                    // Try multiple XPath patterns
                    $xpathPatterns = [
                        '//soap:Body//sh:getDestinationsResult//sh:destinations//sh:destination',
                        '//soap:Body//getDestinationsResult//destinations//destination',
                        '//getDestinationsResult//destinations//destination',
                        '//destinations//destination',
                        '//destination'
                    ];

                    $nodes = null;
                    foreach ($xpathPatterns as $pattern) {
                        $nodes = $sx->xpath($pattern);
                        if ($nodes && count($nodes) > 0) {
                            if ($format !== 'json')
                                echo "üîç Found " . count($nodes) . " destinations with XPath pattern: $pattern\n";
                            break;
                        }
                    }

                    if ($nodes && count($nodes) > 0) {
                        // Create destinations table if not exists (use bravo_destinations as main table)
                        $wpdb->query("CREATE TABLE IF NOT EXISTS bravo_destinations (
                        id INT AUTO_INCREMENT PRIMARY KEY,
                        destination_id INT NOT NULL,
                        destination_name VARCHAR(255),
                        country_id INT,
                        country_name VARCHAR(255),
                        deleted_at TIMESTAMP NULL DEFAULT NULL,
                        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                        UNIQUE KEY unique_destination (destination_id)
                    )");

                        foreach ($nodes as $dest) {
                            $id = intval((string) ($dest->id ?? $dest->Id ?? ''));
                            $name = trim((string) ($dest->name ?? $dest->Name ?? ''));
                            $countryId = intval((string) ($dest->countryId ?? $dest->CountryId ?? ''));
                            $countryName = trim((string) ($dest->countryName ?? $dest->CountryName ?? ''));

                            if ($id > 0 && $name !== '') {
                                $wpdb->query($wpdb->prepare(
                                    "INSERT INTO bravo_destinations (destination_id, destination_name, country_id, country_name, deleted_at, updated_at) 
                                 VALUES (%d, %s, %d, %s, NULL, NOW())
                                 ON DUPLICATE KEY UPDATE 
                                 destination_name = VALUES(destination_name),
                                 country_name = VALUES(country_name),
                                 deleted_at = NULL,
                                 updated_at = NOW()",
                                    $id,
                                    $name,
                                    $countryId,
                                    $countryName
                                ));
                                $destinationsUpdated++;
                            }
                        }
                    } else {
                        if ($format !== 'json')
                            echo "‚ùå No destination nodes found with any XPath pattern\n";
                    }
                } else {
                    if ($format !== 'json')
                        echo "‚ùå GetDestinations XML parsing failed\n";
                    libxml_clear_errors();
                }
            } else {
                if ($format !== 'json') {
                    if (is_wp_error($r)) {
                        echo "‚ùå GetDestinations WP Error: " . $r->get_error_message() . "\n";
                    } else {
                        echo "‚ùå GetDestinations Empty response\n";
                    }
                }
            }
            if ($format !== 'json')
                echo "‚úÖ Destinations updated: $destinationsUpdated\n";

            // Als alleen lookups gewenst, stop hier en toon resultaat
            if ($lookupsOnly) {
                if ($format === 'json') {
                    echo shorttrips_safe_json_encode([
                        'success' => true,
                        'message' => 'Lookup tables synchronized successfully',
                        'room_types_updated' => $roomTypesUpdated,
                        'features_updated' => isset($featuresUpdated) ? $featuresUpdated : 0,
                        'meals_updated' => isset($mealsUpdated) ? $mealsUpdated : 0,
                        'destinations_updated' => $destinationsUpdated,
                        'themes_updated' => 0  // Will be counted below
                    ]);
                } else {
                    echo "\n";
                    echo "‚úÖ ========================================\n";
                    echo "‚úÖ LOOKUP TABLES SYNC COMPLETED\n";
                    echo "‚úÖ ========================================\n";
                    echo "Room Types: $roomTypesUpdated\n";
                    echo "Destinations: $destinationsUpdated\n";
                    echo "\nJe kunt nu de hotels synchroniseren met:\n";
                    echo "?sync_static_hotels=1&limit=10&format=text&_wpnonce=" . $_GET['_wpnonce'] . "\n";
                }
                die();
            }

            // 4. Themes (Static SOAP)
            if ($format !== 'json')
                echo "üé® Syncing Themes...\n";
            $themesUpdated = 0;

            // Create themes table if not exists
            $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_themes (
            id INT PRIMARY KEY,
            name VARCHAR(500),
            image VARCHAR(500),
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

            $soap = '<?xml version="1.0" encoding="utf-8"?>' . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><GetThemes xmlns="http://xml.sunhotels.net/15/"><userName>' . esc_html($creds['username']) . '</userName><password>' . esc_html($creds['password']) . '</password><language>' . esc_html($creds['language']) . '</language></GetThemes></soap:Body></soap:Envelope>';
            $r = wp_remote_post($endpoint, ['headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetThemes"'], 'body' => $soap, 'timeout' => 60]);
            if (!is_wp_error($r) && !empty($r['body'])) {
                $sx = @simplexml_load_string($r['body']);
                if ($sx) {
                    $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    $nodes = $sx->xpath('//soap:Body//sh:getThemesResult//sh:themes//sh:theme');
                    if ($nodes) {
                        foreach ($nodes as $n) {
                            $id = intval((string) ($n->id ?? $n->Id ?? ($n['id'] ?? $n['Id'] ?? '')));
                            $name = trim((string) ($n->name ?? $n->Name ?? (string) $n));
                            $img = trim((string) ($n->image ?? $n->Image ?? ($n['image'] ?? $n['Image'] ?? '')));
                            if ($id <= 0 && $name !== '') {
                                $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                            }
                            if ($id > 0 && $name !== '') {
                                $result = $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_themes (id, name, image, updated_at) VALUES (%d, %s, %s, NOW())", $id, $name, $img));
                                if ($result !== false) {
                                    $themesUpdated++;
                                } else {
                                }
                            }
                        }
                    }
                }
            }
            if ($format !== 'json')
                echo "‚úÖ Themes updated: $themesUpdated\n";

            // 5. Meals (Static SOAP)
            if ($format !== 'json')
                echo "üçΩÔ∏è Syncing Meals...\n";
            $mealsUpdated = 0;

            // Create meals table if not exists
            $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_meals (
            id INT PRIMARY KEY,
            name VARCHAR(500),
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

            $soap = '<?xml version="1.0" encoding="utf-8"?>' . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><GetMeals xmlns="http://xml.sunhotels.net/15/"><userName>' . esc_html($creds['username']) . '</userName><password>' . esc_html($creds['password']) . '</password><language>' . esc_html($creds['language']) . '</language></GetMeals></soap:Body></soap:Envelope>';
            $r = wp_remote_post($endpoint, ['headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetMeals"'], 'body' => $soap, 'timeout' => 60]);
            if (!is_wp_error($r) && !empty($r['body'])) {
                $sx = @simplexml_load_string($r['body']);
                if ($sx) {
                    $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    $nodes = $sx->xpath('//soap:Body//sh:getMealsResult//sh:meals//sh:meal');
                    if ($nodes) {
                        foreach ($nodes as $m) {
                            $id = intval((string) ($m->id ?? $m->Id ?? ($m['id'] ?? $m['Id'] ?? '')));
                            $name = trim((string) ($m->name ?? $m->Name ?? (string) $m));
                            if ($id <= 0 && $name !== '') {
                                $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                            }
                            if ($id > 0 && $name !== '') {
                                $result = $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_meals (id, name, updated_at) VALUES (%d, %s, NOW())", $id, $name));
                                if ($result !== false) {
                                    $mealsUpdated++;
                                } else {
                                }
                            }
                        }
                    }
                }
            }
            if ($format !== 'json')
                echo "‚úÖ Meals updated: $mealsUpdated\n";

            // 6. Languages (Static SOAP)
            if ($format !== 'json')
                echo "üåê Syncing Languages...\n";
            $languagesUpdated = 0;

            // Create languages table if not exists
            $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_languages (
            id INT PRIMARY KEY,
            name VARCHAR(500),
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

            $soap = '<?xml version="1.0" encoding="utf-8"?>'
                . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
                . '<soap:Body>'
                . '<GetLanguages xmlns="http://xml.sunhotels.net/15/">'
                . '<userName>' . esc_html($creds['username']) . '</userName>'
                . '<password>' . esc_html($creds['password']) . '</password>'
                . '<language>' . esc_html($creds['language']) . '</language>'
                . '</GetLanguages>'
                . '</soap:Body>'
                . '</soap:Envelope>';

            $r = wp_remote_post($endpoint, [
                'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetLanguages"'],
                'body' => $soap,
                'timeout' => 60
            ]);

            if (!is_wp_error($r) && !empty($r['body'])) {
                $sx = @simplexml_load_string($r['body']);
                if ($sx) {
                    $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    $nodes = $sx->xpath('//soap:Body//sh:getLanguagesResult//sh:languages//sh:language | //soap:Body//getLanguagesResult//languages//language');
                    if ($nodes) {
                        foreach ($nodes as $lang) {
                            $id = intval((string) ($lang->id ?? $lang->Id ?? ''));
                            $name = trim((string) ($lang->name ?? $lang->Name ?? ''));
                            if ($id <= 0 && $name !== '') {
                                $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                            }
                            if ($id > 0 && $name !== '') {
                                $result = $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_languages (id, name, updated_at) VALUES (%d, %s, NOW())", $id, $name));
                                if ($result !== false) {
                                    $languagesUpdated++;
                                } else {
                                }
                            }
                        }
                    }
                }
            }
            if ($format !== 'json')
                echo "‚úÖ Languages updated: $languagesUpdated\n";

            // 7. Room Note Types (NonStatic)
            if ($format !== 'json')
                echo "üìù Syncing Room Note Types...\n";
            $roomNoteTypesUpdated = 0;

            // Create table if not exists
            $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_note_types (
            id INT PRIMARY KEY,
            name VARCHAR(500),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");
            $ns = shorttrips_call_nonstatic_xml('GetRoomNoteTypes');
            if ($ns) {
                $ns->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                $nodes = $ns->xpath('//sh:noteTypes//sh:noteType | //sh:roomNoteTypes//sh:roomNoteType');
                if ($nodes) {
                    foreach ($nodes as $n) {
                        $id = intval((string) ($n->id ?? $n->Id ?? ($n['id'] ?? $n['Id'] ?? '')));
                        $name = trim((string) ($n->name ?? $n->Name ?? $n->description ?? $n->Description ?? (string) $n));
                        if ($id <= 0 && $name !== '') {
                            $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                        }
                        if ($id > 0 && $name !== '') {
                            $result = $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_room_note_types (id, name, updated_at) VALUES (%d, %s, NOW())", $id, $name));
                            if ($result !== false) {
                                $roomNoteTypesUpdated++;
                            } else {
                            }
                        }
                    }
                }
            }
            if ($format !== 'json')
                echo "‚úÖ Room Note Types updated: $roomNoteTypesUpdated\n";

            // 8. Hotel Note Types (NonStatic)
            if ($format !== 'json')
                echo "üè® Syncing Hotel Note Types...\n";
            $hotelNoteTypesUpdated = 0;

            // Create table if not exists
            $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_note_types (
            id INT PRIMARY KEY,
            name VARCHAR(500),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

            $ns = shorttrips_call_nonstatic_xml('GetHotelNoteTypes');
            if ($ns) {
                $ns->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                $nodes = $ns->xpath('//sh:hotelNoteTypes//sh:hotelNoteType | //sh:noteTypes//sh:noteType');
                if ($nodes) {
                    foreach ($nodes as $n) {
                        $id = intval((string) ($n->id ?? $n->Id ?? ($n['id'] ?? $n['Id'] ?? '')));
                        $name = trim((string) ($n->name ?? $n->Name ?? $n->description ?? $n->Description ?? (string) $n));
                        if ($id <= 0 && $name !== '') {
                            $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                        }
                        if ($id > 0 && $name !== '') {
                            $result = $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_hotel_note_types (id, name, updated_at) VALUES (%d, %s, NOW())", $id, $name));
                            if ($result !== false) {
                                $hotelNoteTypesUpdated++;
                            } else {
                            }
                        }
                    }
                }
            }
            if ($format !== 'json')
                echo "‚úÖ Hotel Note Types updated: $hotelNoteTypesUpdated\n";

            if ($format !== 'json') {
                echo "üéâ Lookup tables sync completed!\n";
                echo "üìä Summary: RoomTypes($roomTypesUpdated), Features($featuresUpdated), Destinations($destinationsUpdated), Themes($themesUpdated), Meals($mealsUpdated), Languages($languagesUpdated), RoomNotes($roomNoteTypesUpdated), HotelNotes($hotelNoteTypesUpdated)\n\n";
            }
        }

        // Configurable batch size via query param (clamped 10‚Äì250)
        $limit = $read_query_int('limit', 100, 10, 250);

        // Per-destination timeout & retries (tunable via query params)
        $perTimeout = isset($_GET['per_timeout']) ? intval($_GET['per_timeout']) : 120; // seconds
        $perTimeout = max(30, min($perTimeout, 600));
        $retries = isset($_GET['retries']) ? intval($_GET['retries']) : 2; // number of additional tries
        $retries = max(0, min($retries, 5));

        // Optional cleanup parameters
        $cleanupOnly = isset($_GET['cleanup_only']) && $_GET['cleanup_only'] == '1';
        $cleanupAfter = isset($_GET['cleanup']) && $_GET['cleanup'] == '1';
        $olderHours = isset($_GET['older_than_hours']) ? intval($_GET['older_than_hours']) : 720; // default 30d
        $olderHours = max(1, min($olderHours, 24 * 365));

        // Cap op totaal aantal op te slaan hotels voor test (0 = geen cap)
        $hotelsCap = isset($_GET['hotels_cap']) ? max(0, intval($_GET['hotels_cap'])) : 0;
        $capInserted = 0;
        $capReached = false;

        // Bereken totaal aantal batches
        $totalDestinations = (int) $wpdb->get_var("
        SELECT COUNT(*) 
        FROM bravo_destinations 
        WHERE deleted_at IS NULL
    ");
        $totalBatches = max(1, ceil($totalDestinations / $limit));

        // Cleanup-only mode
        if ($cleanupOnly) {
            $deleted = $wpdb->query(
                $wpdb->prepare(
                    "DELETE FROM {$table} WHERE updated_at IS NULL OR updated_at < DATE_SUB(NOW(), INTERVAL %d HOUR)",
                    $olderHours
                )
            );
            if ($format === 'json') {
                echo shorttrips_safe_json_encode([
                    'deleted' => (int) $deleted,
                    'older_than_hours' => $olderHours,
                    'message' => "Pruned stale hotels"
                ]);
            } else {
                echo "üßπ Deleted {$deleted} stale rows older than {$olderHours} hours\n";
            }
            die();
        }

        // Als alleen info nodig is, return dat
        if ($infoOnly) {
            echo shorttrips_safe_json_encode([
                'total_destinations' => $totalDestinations,
                'total_batches' => $totalBatches,
                'batch_size' => $limit,
                'next_batch' => (int) get_option('shorttrips_sync_next_batch', 1)
            ]);
            die();
        }

        // Stop vroeg als er geen bestemmingen zijn
        if ($totalDestinations === 0) {
            if ($format === 'json') {
                echo shorttrips_safe_json_encode([
                    'batch' => 1,
                    'total_batches' => 1,
                    'completed' => true,
                    'hotels_saved' => 0,
                    'message' => 'Geen bestemmingen gevonden in bravo_destinations'
                ]);
            } else {
                echo "‚ö†Ô∏è Geen bestemmingen gevonden in bravo_destinations.\n";
            }
            die();
        }

        // Bepaal batch offset via URL-parameter (?sync_static_hotels=1,2,...)
        $batch = $read_query_int('sync_static_hotels', 1, 1, 100000);
        // Clamp batch to available total to avoid getting stuck on empty batches (e.g. 27/00)
        if ($batch > $totalBatches) {
            $batch = $totalBatches;
            update_option('shorttrips_sync_next_batch', $batch);
            if ($format !== 'json') {
                echo "‚ö†Ô∏è Batch bijgesneden naar {$batch} (totaal {$totalBatches}).\n";
            }
        }
        $offset = ($batch - 1) * $limit;

        if ($format === 'json') {
            // JSON mode - output wordt naar log gestuurd
        } else {
            echo "üì¶ Batch {$batch} gestart (bestemmingen {$offset}‚Äì" . ($offset + $limit) . ")\n";
        }
        // Selecteer bestemmingen uit bravo_destinations
        $destinations = $wpdb->get_results($wpdb->prepare("
        SELECT destination_id, destination_name, country_id, country_name 
        FROM bravo_destinations 
        WHERE deleted_at IS NULL 
        ORDER BY id ASC 
        LIMIT %d OFFSET %d
    ", $limit, $offset));

        if (!$destinations) {
            // Als we hier zijn, zat de offset voorbij het aantal bestemmingen; reset voor de zekerheid
            update_option('shorttrips_sync_next_batch', 1);
            if ($format === 'json') {
                echo shorttrips_safe_json_encode([
                    'batch' => $batch,
                    'total_batches' => $totalBatches,
                    'completed' => true,
                    'hotels_saved' => 0,
                    'message' => 'Geen bestemmingen gevonden; voortaan vanaf batch 1'
                ]);
            } else {
                echo "‚ö†Ô∏è Geen bestemmingen gevonden (offset {$offset}). Batch teruggezet naar 1.\n";
            }
            die();
        }

        $dbErrors = [];
        foreach ($destinations as $dest) {
            $destinationId = intval($dest->destination_id);
            if ($format !== 'json') {
                echo "\n‚è≥ Ophalen hotels voor {$dest->destination_name} (ID: {$destinationId})‚Ä¶\n";
            }

            $soapBody = '<?xml version="1.0" encoding="utf-8"?>'
                . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '
                . 'xmlns:xsd="http://www.w3.org/2001/XMLSchema" '
                . 'xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
                . '<soap:Body>'
                . '<GetStaticHotelsAndRooms xmlns="http://xml.sunhotels.net/15/">'
                . '<userName>' . esc_html($creds['username']) . '</userName>'
                . '<password>' . esc_html($creds['password']) . '</password>'
                . '<language>' . esc_html($creds['language']) . '</language>'
                . '<destination>' . intval($destinationId) . '</destination>'
                . '<showRoomImages>true</showRoomImages>'
                . '</GetStaticHotelsAndRooms>'
                . '</soap:Body>'
                . '</soap:Envelope>';

            // Try with retries/backoff
            $attempt = 0;
            $ok = false;
            $r = null;
            do {
                @set_time_limit(30);
                $tmpFile = function_exists('wp_tempnam') ? wp_tempnam('shorttrips_static_') : tempnam(sys_get_temp_dir(), 'st_static_');
                $r = wp_remote_post($endpoint, [
                    'headers' => [
                        "Content-Type" => "text/xml; charset=utf-8",
                        "SOAPAction" => "\"http://xml.sunhotels.net/15/GetStaticHotelsAndRooms\""
                    ],
                    'body' => $soapBody,
                    'timeout' => $perTimeout,
                    'stream' => true,
                    'filename' => $tmpFile,
                ]);

                $httpCode = is_array($r) && isset($r['response']['code']) ? intval($r['response']['code']) : 0;
                $hasBodyOrFile = (!empty($r['body'])) || (isset($r['filename']) && $r['filename'] && file_exists($r['filename']));
                $ok = (!is_wp_error($r) && $hasBodyOrFile && $httpCode >= 200 && $httpCode < 300);

                if ($ok) {
                    break;
                }

                if ($format !== 'json') {
                    $err = is_wp_error($r) ? $r->get_error_message() : ('HTTP ' . $httpCode);
                    echo "‚ö†Ô∏è Probeerslag " . ($attempt + 1) . " mislukt voor bestemming {$destinationId} ({$err}).\n";
                    @ob_flush();
                    flush();
                }

                $attempt++;
                if (isset($tmpFile) && $tmpFile && file_exists($tmpFile)) {
                    @unlink($tmpFile);
                }
                if ($attempt <= $retries) {
                    $sleep = min(8, 1 << ($attempt - 1));
                    sleep($sleep);
                }
            } while ($attempt <= $retries);

            if (!$ok) {
                if ($format !== 'json') {
                    echo "‚è≠Ô∏è Overgeslagen: geen geldig antwoord/timeout voor bestemming {$destinationId} na " . ($retries + 1) . " pogingen (timeout={$perTimeout}s).\n";
                }
                continue;
            }
            // Parse streamed XML from file using XMLReader to avoid high memory usage
            $responseFile = isset($r['filename']) && file_exists($r['filename']) ? $r['filename'] : (isset($tmpFile) && file_exists($tmpFile) ? $tmpFile : null);
            if (!$responseFile) {
                if ($format !== 'json') {
                    echo "‚ö†Ô∏è Geen geldig response-bestand voor bestemming {$destinationId}.\n";
                }
                continue;
            }

            libxml_use_internal_errors(true);
            $reader = new XMLReader();
            if (!$reader->open($responseFile)) {
                if ($format !== 'json') {
                    echo "‚ö†Ô∏è Kan XML niet openen voor bestemming {$destinationId}.\n";
                }
                @unlink($responseFile);
                continue;
            }

            $batchHotelCount = 0;
            try {
                while ($reader->read()) {
                    if ($reader->nodeType === XMLReader::ELEMENT && $reader->localName === 'hotel') {
                        $dom = new DOMDocument();
                        $node = $reader->expand($dom);
                        if (!$node) {
                            continue;
                        }
                        $xp = new DOMXPath($dom);
                        $xp->registerNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                        $xp->registerNamespace('sh', 'http://xml.sunhotels.net/15/');
                        // Use the expanded node as current <hotel>; fallback to documentElement
                        $h = ($node instanceof DOMElement) ? $node : $dom->documentElement;
                        if (!$h instanceof DOMElement) {
                            continue;
                        }
                        $hotel_id = intval($h->getElementsByTagName('hotel.id')->item(0)?->nodeValue ?? 0);
                        if ($hotel_id <= 0)
                            continue;

                        // Basis informatie
                        $title = $h->getElementsByTagName('name')->item(0)?->nodeValue ?? '';
                        $hotelname = $h->getElementsByTagName('hotelname')->item(0)?->nodeValue ?? $title;
                        $description = $h->getElementsByTagName('description')->item(0)?->nodeValue ?? '';

                        // Locatie informatie
                        $address1 = $h->getElementsByTagName('hotel.addr.1')->item(0)?->nodeValue ?? '';
                        $address2 = $h->getElementsByTagName('hotel.addr.2')->item(0)?->nodeValue ?? '';
                        $address3 = $h->getElementsByTagName('hotel.addr.3')->item(0)?->nodeValue ?? '';
                        $addressTag = $h->getElementsByTagName('address')->item(0)?->nodeValue ?? '';
                        $postal_code = $h->getElementsByTagName('postal_code')->item(0)?->nodeValue ?? '';
                        if ($postal_code === '') {
                            $postal_code = $h->getElementsByTagName('zip')->item(0)?->nodeValue ?? '';
                        }
                        if ($postal_code === '') {
                            $postal_code = $h->getElementsByTagName('zipcode')->item(0)?->nodeValue ?? '';
                        }
                        if ($postal_code === '') {
                            $postal_code = $h->getElementsByTagName('hotel.addr.zip')->item(0)?->nodeValue ?? '';
                        }
                        if ($postal_code === '') {
                            $postal_code = $h->getElementsByTagName('hotel.addr.postalcode')->item(0)?->nodeValue ?? '';
                        }
                        $state_xml = $h->getElementsByTagName('state')->item(0)?->nodeValue ?? '';
                        if (empty($state_xml)) {
                            $state_xml = $h->getElementsByTagName('hotel.addr.state')->item(0)?->nodeValue ?? '';
                        }
                        $lat = $h->getElementsByTagName('latitude')->item(0)?->nodeValue ?? '';
                        $lng = $h->getElementsByTagName('longitude')->item(0)?->nodeValue ?? '';
                        // Combineer adresvelden met fallbacks
                        $addressParts = [];
                        if (!empty($address1))
                            $addressParts[] = $address1;
                        if (!empty($address2))
                            $addressParts[] = $address2;
                        if (!empty($address3))
                            $addressParts[] = $address3;
                        if (empty($addressParts) && !empty($addressTag))
                            $addressParts[] = $addressTag;
                        if (!empty($postal_code))
                            $addressParts[] = $postal_code;
                        $address_full = trim(implode(', ', array_filter($addressParts)));

                        // Hotel details
                        // Stars/category: try multiple possible nodes
                        $category = 0;
                        $tryStar = function ($names) use ($h) {
                            foreach ($names as $n) {
                                $v = $h->getElementsByTagName($n)->item(0)?->nodeValue ?? '';
                                if ($v !== '' && $v !== null) {
                                    $iv = intval($v);
                                    if ($iv > 0)
                                        return $iv;
                                }
                            }
                            return 0;
                        };
                        // ‚≠ê CRITICAL FIX: Sunhotels API gebruikt 'classification' voor sterren aantal
                        // Bron: <classification>3</classification> in StaticXMLAPI response
                        $category = $tryStar(['classification', 'category', 'stars', 'starRating', 'hotel.stars', 'hotel_stars']);
                        $resort = $h->getElementsByTagName('resort')->item(0)?->nodeValue ?? $dest->destination_name;
                        $country = $h->getElementsByTagName('country')->item(0)?->nodeValue ?? $dest->country_name;
                        $country_code = $h->getElementsByTagName('hotel.addr.countrycode')->item(0)?->nodeValue ?? '';
                        if (empty($country_code)) {
                            $country_code = $h->getElementsByTagName('countrycode')->item(0)?->nodeValue ?? '';
                        }
                        $city_xml = $h->getElementsByTagName('city')->item(0)?->nodeValue ?? '';
                        $resort_id_xml = intval($h->getElementsByTagName('resort_id')->item(0)?->nodeValue ?? 0);
                        $type_xml = $h->getElementsByTagName('type')->item(0)?->nodeValue ?? 'Hotel';

                        // Contact informatie (met fallbacks)
                        $phone = $h->getElementsByTagName('phone')->item(0)?->nodeValue ?? '';
                        if (empty($phone)) {
                            $phone = $h->getElementsByTagName('telephone')->item(0)?->nodeValue ?? '';
                        }
                        $fax = $h->getElementsByTagName('fax')->item(0)?->nodeValue ?? '';
                        if (empty($fax)) {
                            $fax = $h->getElementsByTagName('telefax')->item(0)?->nodeValue ?? '';
                            if (empty($fax)) {
                                $fax = $h->getElementsByTagName('hotel_fax')->item(0)?->nodeValue ?? '';
                            }
                        }
                        $email = $h->getElementsByTagName('email')->item(0)?->nodeValue ?? '';
                        if (empty($email)) {
                            $email = $h->getElementsByTagName('hotel_email')->item(0)?->nodeValue ?? '';
                            if (empty($email)) {
                                $email = $h->getElementsByTagName('hotel.email')->item(0)?->nodeValue ?? '';
                            }
                            if (empty($email)) {
                                $email = $h->getElementsByTagName('contact_email')->item(0)?->nodeValue ?? '';
                            }
                        }

                        // Images ‚Äì bewaar image-ID's en schrijf URLs als hotelImage.aspx?id=...
                        $extractImageId = function ($raw) {
                            $u = trim((string) $raw);
                            if ($u === '')
                                return null;
                            $u = ltrim($u, '@');
                            if (preg_match('~hotelImage(?:Full)?\.aspx\?id=(\d+)~i', $u, $m)) {
                                return intval($m[1]);
                            }
                            if (preg_match('~^\d+$~', $u)) {
                                return intval($u);
                            }
                            return null;
                        };
                        $urlFromId = function ($id, $full = false) {
                            $id = intval($id);
                            if ($id <= 0)
                                return '';
                            return 'https://hotelimages.sunhotels.net/HotelInfo/hotelImage.aspx?id=' . $id . ($full ? '&full=1' : '');
                        };

                        $imageIds = [];
                        // main_image node kan ook een ID bevatten
                        $main_image = '';
                        $mainNode = $xp->query('.//sh:main_image | .//main_image', $h);
                        if ($mainNode && $mainNode->length > 0) {
                            $mn = $mainNode->item(0);
                            $mv = '';
                            if ($mn) {
                                $mv = trim((string) ($mn->nodeValue ?? ''));
                                if ($mv === '' && $mn->attributes && $mn->attributes->length > 0) {
                                    $mv = (string) ($mn->getAttribute('url') ?: $mn->getAttribute('src') ?: $mn->getAttribute('href') ?: $mn->getAttribute('id'));
                                }
                            }
                            $mid = $extractImageId($mv);
                            if (!empty($mid)) {
                                $imageIds[] = $mid;
                            }
                        }

                        // verzamel alle image IDs uit images-lijst
                        $imgNodes = $xp->query('.//sh:images//sh:image | .//images//image | .//sh:image | .//image', $h);
                        if ($imgNodes && $imgNodes->length > 0) {
                            foreach ($imgNodes as $imgNode) {
                                $raw = trim((string) ($imgNode->nodeValue ?? ''));
                                if ($raw === '' && method_exists($imgNode, 'getAttribute')) {
                                    $raw = (string) ($imgNode->getAttribute('url') ?: $imgNode->getAttribute('src') ?: $imgNode->getAttribute('href') ?: $imgNode->getAttribute('data-src') ?: $imgNode->getAttribute('id'));
                                }
                                $iid = $extractImageId($raw);
                                if (!empty($iid)) {
                                    $imageIds[] = $iid;
                                }
                            }
                        }

                        // de-duplicate en bouw URL's
                        $imageIds = array_values(array_unique(array_filter(array_map('intval', $imageIds))));
                        $images = [];
                        foreach ($imageIds as $iid) {
                            $u = $urlFromId($iid, false);
                            if ($u !== '')
                                $images[] = $u;
                        }

                        // Hoofd- en bannerafbeelding
                        if (!empty($imageIds)) {
                            $imageUrl = $urlFromId($imageIds[0], false);
                            $main_image = $imageUrl;
                            $bannerUrl = $urlFromId($imageIds[0], true);
                        } else {
                            $imageUrl = '';
                            $bannerUrl = '';
                            $main_image = '';
                        }

                        // JSON lijst (zonder &full)
                        $jsonImages = !empty($images) ? json_encode($images, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : json_encode([], JSON_UNESCAPED_SLASHES);

                        // Tijden
                        $check_in_time = $h->getElementsByTagName('check_in_time')->item(0)?->nodeValue ?? '';
                        $check_out_time = $h->getElementsByTagName('check_out_time')->item(0)?->nodeValue ?? '';
                        if (empty($check_in_time)) {
                            $check_in_time = $h->getElementsByTagName('check_in')->item(0)?->nodeValue ?? '';
                        }
                        if (empty($check_out_time)) {
                            $check_out_time = $h->getElementsByTagName('check_out')->item(0)?->nodeValue ?? '';
                        }

                        // Rating informatie (met fallback)
                        $rating = $h->getElementsByTagName('rating')->item(0)?->nodeValue ?? '';
                        if ($rating === '' || $rating === null) {
                            $rating = $h->getElementsByTagName('review_score')->item(0)?->nodeValue ?? '';
                        }
                        $review_score = !empty($rating) ? floatval($rating) : null;
                        $review_count = intval($h->getElementsByTagName('review_count')->item(0)?->nodeValue ?? 0);
                        if ($review_count <= 0) {
                            // Fallback: count review nodes if present
                            $rcNodes = $xp->query('.//sh:reviews//sh:review | .//reviews//review', $h);
                            if ($rcNodes && $rcNodes->length > 0) {
                                $review_count = $rcNodes->length;
                            }
                        }

                        // Extra informatie
                        $headline = $h->getElementsByTagName('headline')->item(0)?->nodeValue ?? '';
                        $surrounding = $h->getElementsByTagName('surrounding')->item(0)?->nodeValue ?? '';
                        $policy = $h->getElementsByTagName('policy')->item(0)?->nodeValue ?? '';
                        if (empty($policy)) {
                            $policy = $h->getElementsByTagName('hotel_policy')->item(0)?->nodeValue ?? '';
                        }

                        // Extra meta: time zone
                        $time_zone = $h->getElementsByTagName('timeZone')->item(0)?->nodeValue ?? '';

                        // Features JSON (id, name)
                        $featuresArr = [];
                        $featureNodes = $xp->query('.//sh:features//sh:feature | .//features//feature', $h);
                        if ($featureNodes && $featureNodes->length > 0) {
                            foreach ($featureNodes as $fn) {
                                $fid = '';
                                $fname = '';
                                if (method_exists($fn, 'getAttribute')) {
                                    $fid = trim((string) $fn->getAttribute('id'));
                                    $fname = trim((string) $fn->getAttribute('name'));
                                }
                                if ($fid !== '' || $fname !== '') {
                                    $featuresArr[] = [
                                        'id' => ($fid !== '' ? intval($fid) : null),
                                        'name' => $fname,
                                    ];
                                }
                            }
                        }
                        $features_json = !empty($featuresArr) ? json_encode($featuresArr, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : null;
                        if ($features_json === null || $features_json === '') {
                            $features_json = 'null';
                        }

                        // Upsert features lookup while syncing hotels
                        if (!empty($featuresArr)) {
                            $__ncol = (function ($wpdb) {
                                return (bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `ghwk_features` LIKE %s", 'name')) ? 'name' : ((bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `ghwk_features` LIKE %s", 'nameIndex')) ? 'nameIndex' : 'name'); })($wpdb);
                            foreach ($featuresArr as $__f) {
                                $fid = isset($__f['id']) ? intval($__f['id']) : 0;
                                $fname = isset($__f['name']) ? (string) $__f['name'] : '';
                                if ($fid > 0 && $fname !== '') {
                                    $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_features (id,`$__ncol`,updated_at) VALUES (%d,%s,NOW())", $fid, $fname));
                                }
                            }
                        }

                        // Themes JSON (id, name, image)
                        $themesArr = [];
                        $themeNodes = $xp->query('.//sh:themes//sh:theme | .//themes//theme', $h);
                        if ($themeNodes && $themeNodes->length > 0) {
                            foreach ($themeNodes as $tn) {
                                $tid = '';
                                $tname = '';
                                $timg = '';
                                if (method_exists($tn, 'getAttribute')) {
                                    $tid = trim((string) $tn->getAttribute('id'));
                                    $tname = trim((string) $tn->getAttribute('name'));
                                    $timg = trim((string) $tn->getAttribute('image'));
                                }
                                if ($tid !== '' || $tname !== '' || $timg !== '') {
                                    $themesArr[] = [
                                        'id' => ($tid !== '' ? intval($tid) : null),
                                        'name' => $tname,
                                        'image' => $timg,
                                    ];
                                }
                            }
                        }
                        $themes_json = !empty($themesArr) ? json_encode($themesArr, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : null;
                        if ($themes_json === null || $themes_json === '') {
                            $themes_json = 'null';
                        }

                        // Upsert themes lookup while syncing hotels
                        if (!empty($themesArr)) {
                            $__ncol = (function ($wpdb) {
                                return (bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `ghwk_themes` LIKE %s", 'name')) ? 'name' : ((bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `ghwk_themes` LIKE %s", 'nameIndex')) ? 'nameIndex' : 'name'); })($wpdb);
                            $__icol = (function ($wpdb) {
                                return (bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `ghwk_themes` LIKE %s", 'image')) ? 'image' : ((bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `ghwk_themes` LIKE %s", 'image_url')) ? 'image_url' : 'image'); })($wpdb);
                            foreach ($themesArr as $__t) {
                                $tid = isset($__t['id']) ? intval($__t['id']) : 0;
                                $tname = isset($__t['name']) ? (string) $__t['name'] : '';
                                $timg = isset($__t['image']) ? (string) $__t['image'] : '';
                                if ($tid > 0 && $tname !== '') {
                                    $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_themes (id,`$__ncol`,`$__icol`,updated_at) VALUES (%d,%s,%s,NOW())", $tid, $tname, $timg));
                                }
                            }
                        }
                        // Distance types JSON (flattened minimal structure)
                        $distanceTypesArr = [];
                        $dtNodes = $xp->query('.//sh:distanceTypes//sh:distanceType | .//distanceTypes//distanceType', $h);
                        if ($dtNodes && $dtNodes->length > 0) {
                            foreach ($dtNodes as $dtn) {
                                $idNode = $dtn->getElementsByTagName('hotelDistanceTypeId')->item(0);
                                $descNode = $dtn->getElementsByTagName('description')->item(0);
                                $dtEntry = [
                                    'hotelDistanceTypeId' => $idNode ? intval($idNode->nodeValue) : null,
                                    'description' => $descNode ? (string) $descNode->nodeValue : '',
                                    'distances' => [],
                                ];
                                $distNodes = $dtn->getElementsByTagName('distance');
                                foreach ($distNodes as $dn) {
                                    $meters = $dn->getElementsByTagName('distanceInMeters')->item(0)?->nodeValue ?? '';
                                    $place = $dn->getElementsByTagName('placeName')->item(0)?->nodeValue ?? '';
                                    $dtEntry['distances'][] = [
                                        'distanceInMeters' => ($meters !== '' ? intval($meters) : null),
                                        'placeName' => $place,
                                    ];
                                }
                                $distanceTypesArr[] = $dtEntry;
                            }
                        }
                        $distance_types_json = !empty($distanceTypesArr) ? json_encode($distanceTypesArr, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : null;
                        if ($distance_types_json === null || $distance_types_json === '') {
                            $distance_types_json = 'null';
                        }

                        // Prijs informatie (als beschikbaar in static API)
                        $price = null;
                        $sale_price = null;
                        $priceNode = $h->getElementsByTagName('price')->item(0);
                        if ($priceNode) {
                            $price = floatval($priceNode->nodeValue ?? 0);
                            if ($price <= 0)
                                $price = null;
                        }

                        // Video en Gallery
                        $video = $h->getElementsByTagName('video')->item(0)?->nodeValue ?? '';
                        $gallery = $h->getElementsByTagName('gallery')->item(0)?->nodeValue ?? '';

                        // iCal import URL
                        $ical_import_url = $h->getElementsByTagName('ical_import_url')->item(0)?->nodeValue ?? '';

                        // Extra price en Service fee
                        $enable_extra_price = 0;
                        $extra_price = null;
                        $enable_service_fee = 0;
                        $service_fee = null;

                        // Booking regels
                        $min_day_before_booking = intval($h->getElementsByTagName('min_day_before_booking')->item(0)?->nodeValue ?? 0);
                        $min_day_stays = intval($h->getElementsByTagName('min_day_stays')->item(0)?->nodeValue ?? 0);
                        $allow_full_day = intval($h->getElementsByTagName('allow_full_day')->item(0)?->nodeValue ?? 0);

                        // Map zoom
                        $map_zoom = intval($h->getElementsByTagName('map_zoom')->item(0)?->nodeValue ?? 0);

                        // Featured
                        $is_featured = intval($h->getElementsByTagName('is_featured')->item(0)?->nodeValue ?? 0);

                        // Facilities (amenities) - surrounding
                        $facilities = [];
                        $facilityNodes = $h->getElementsByTagName('facility');
                        foreach ($facilityNodes as $facNode) {
                            $facName = $facNode->nodeValue ?? '';
                            if (!empty($facName))
                                $facilities[] = $facName;
                        }
                        $surrounding_text = !empty($facilities) ? implode(', ', $facilities) : $surrounding;
                        // Bepaal beste city waarde (XML heeft prioriteit, anders destination_name)
                        $city = !empty($city_xml) ? $city_xml : $dest->destination_name;

                        // Bepaal beste destination_name (XML resort heeft prioriteit)
                        $destination_name = !empty($resort) ? $resort : $dest->destination_name;

                        // Gebruik INSERT ... ON DUPLICATE KEY UPDATE om dubbele data te voorkomen
                        // Dit vereist dat hotel_id een PRIMARY KEY of UNIQUE KEY is
                        // ‚úÖ FIXED: Removed DELETE - ON DUPLICATE KEY UPDATE handles updates automatically
                        // DELETE veroorzaakte onnodig verlies van oude records bij re-syncs

                        $wpdb->query(
                            $wpdb->prepare(
                                "INSERT INTO {$table}
                 (hotel_id, hotelname, title, slug, content, description,
                  address, latitude, longitude, map_lat, map_lng, map_zoom,
                  main_image, image, banner_image, json_images,
                  star_rate, category, phone, fax, email,
                  country_id, country_name, destination_id, destination_name, city, 
                  resort_id, type,
                  addr_1, addr_2, zip, state, country, country_code,
                  accomodation_type, place_id,
                  check_in_time, check_out_time, allow_full_day,
                  review_score, review_count,
                  headline, surrounding, policy,
                  classification, time_zone, features_json, themes_json, distance_types_json,
                  price, sale_price,
                  images_json,
                  gallery, video, ical_import_url,
                  enable_extra_price, extra_price,
                  min_day_before_booking, min_day_stays,
                  enable_service_fee, service_fee,
                  is_featured,
                  status, updated_at)
                 VALUES
                 (%d, %s, %s, %s, %s, %s,
                  %s, %s, %s, %s, %s, %d,
                  %s, %s, %s, %s,
                  %d, %d, %s, %s, %s,
                  %d, %s, %d, %s, %s,
                  %d, %s,
                  %s, %s, %s, %s, %s, %s,
                  %s, %d,
                  %s, %s, %d,
                  %s, %d,
                  %s, %s, %s,
                  %d, %s, %s, %s, %s,
                  %s, %s,
                  %s,
                  %s, %s, %s,
                  %d, %s,
                  %d, %d,
                  %d, %s,
                  %d,
                  %s, %s)
                 ON DUPLICATE KEY UPDATE
                  hotelname = VALUES(hotelname),
                  title = VALUES(title),
                  slug = VALUES(slug),
                  content = VALUES(content),
                  description = VALUES(description),
                  address = VALUES(address),
                  latitude = VALUES(latitude),
                  longitude = VALUES(longitude),
                  map_lat = VALUES(map_lat),
                  map_lng = VALUES(map_lng),
                  map_zoom = VALUES(map_zoom),
                  main_image = VALUES(main_image),
                  image = VALUES(image),
                  banner_image = VALUES(banner_image),
                  json_images = VALUES(json_images),
                  star_rate = VALUES(star_rate),
                  category = VALUES(category),
                  phone = VALUES(phone),
                  fax = VALUES(fax),
                  email = VALUES(email),
                  country_id = VALUES(country_id),
                  country_name = VALUES(country_name),
                  destination_id = VALUES(destination_id),
                  destination_name = VALUES(destination_name),
                  city = VALUES(city),
                  resort_id = VALUES(resort_id),
                  type = VALUES(type),
                  addr_1 = VALUES(addr_1),
                  addr_2 = VALUES(addr_2),
                  zip = VALUES(zip),
                  state = VALUES(state),
                  country = VALUES(country),
                  country_code = VALUES(country_code),
                  check_in_time = VALUES(check_in_time),
                  check_out_time = VALUES(check_out_time),
                  allow_full_day = VALUES(allow_full_day),
                  review_score = VALUES(review_score),
                  review_count = VALUES(review_count),
                  headline = VALUES(headline),
                  surrounding = VALUES(surrounding),
                  policy = VALUES(policy),
                  classification = VALUES(classification),
                  time_zone = VALUES(time_zone),
                  features_json = VALUES(features_json),
                  themes_json = VALUES(themes_json),
                  distance_types_json = VALUES(distance_types_json),
                  price = VALUES(price),
                  sale_price = VALUES(sale_price),
                  images_json = VALUES(images_json),
                  gallery = VALUES(gallery),
                  video = VALUES(video),
                  ical_import_url = VALUES(ical_import_url),
                  enable_extra_price = VALUES(enable_extra_price),
                  extra_price = VALUES(extra_price),
                  min_day_before_booking = VALUES(min_day_before_booking),
                  min_day_stays = VALUES(min_day_stays),
                  enable_service_fee = VALUES(enable_service_fee),
                  service_fee = VALUES(service_fee),
                  is_featured = VALUES(is_featured),
                  updated_at = NOW()",
                                $hotel_id,
                                sanitize_text_field($hotelname ?: $title),
                                sanitize_text_field($title),
                                sanitize_title($title ?: 'hotel-' . $hotel_id),
                                wp_kses_post($description),
                                wp_kses_post($description),
                                sanitize_text_field($address_full),
                                sanitize_text_field($lat),
                                sanitize_text_field($lng),
                                sanitize_text_field($lat),
                                sanitize_text_field($lng),
                                $map_zoom,
                                esc_url_raw($main_image),
                                esc_url_raw($imageUrl),
                                esc_url_raw($bannerUrl),
                                $jsonImages,
                                $category,
                                $category,
                                sanitize_text_field($phone),
                                sanitize_text_field($fax),
                                sanitize_email($email),
                                intval($dest->country_id),
                                sanitize_text_field($country ?: $dest->country_name),
                                intval($destinationId),
                                sanitize_text_field($destination_name),
                                sanitize_text_field($city),
                                ($resort_id_xml > 0 ? $resort_id_xml : 0),
                                sanitize_text_field($type_xml),
                                sanitize_text_field($address1),
                                sanitize_text_field($address2),
                                sanitize_text_field($postal_code),
                                sanitize_text_field($state_xml),
                                sanitize_text_field($country),
                                sanitize_text_field($country_code),
                                'Hotel',
                                intval($destinationId),
                                sanitize_text_field($check_in_time),
                                sanitize_text_field($check_out_time),
                                $allow_full_day,
                                $review_score,
                                $review_count,
                                sanitize_text_field($headline),
                                wp_kses_post($surrounding_text),
                                wp_kses_post($policy),
                                $category,
                                sanitize_text_field($time_zone),
                                $features_json,
                                $themes_json,
                                $distance_types_json,
                                $price !== null ? number_format($price, 2, '.', '') : null,
                                $sale_price !== null ? number_format($sale_price, 2, '.', '') : null,
                                $jsonImages,
                                sanitize_text_field($gallery),
                                sanitize_text_field($video),
                                esc_url_raw($ical_import_url),
                                $enable_extra_price,
                                $extra_price ? wp_kses_post($extra_price) : null,
                                $min_day_before_booking,
                                $min_day_stays,
                                $enable_service_fee,
                                $service_fee ? wp_kses_post($service_fee) : null,
                                $is_featured,
                                'publish',
                                current_time('mysql')
                            )
                        );

                        if ($wpdb->last_error) {
                            $dbErrors[] = [
                                'hotel_id' => $hotel_id,
                                'error' => $wpdb->last_error,
                            ];
                            if ($format !== 'json') {
                                echo "‚ö†Ô∏è DB-fout voor hotel {$hotel_id}: {$wpdb->last_error}\n";
                            }
                        } else {
                            if ($format !== 'json') {
                                echo "‚úÖ {$title}\n";
                            }
                            // If table has a 'stars' column, keep it in sync as well
                            if (isset($hasStarsCol) && $hasStarsCol && $category > 0) {
                                $wpdb->update($table, ['stars' => $category, 'updated_at' => current_time('mysql')], ['hotel_id' => $hotel_id]);
                            }
                            $capInserted++;
                            if ($hotelsCap > 0 && $capInserted >= $hotelsCap) {
                                $capReached = true;
                            }

                            // ============================================================
                            // ROOM TYPES IMAGES SYNC (per hotel)
                            // ============================================================
                            // Create/update room_types table if not exists
                            $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_room_types (
                    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
                    hotel_id INT NOT NULL,
                    room_type_id INT NOT NULL,
                    name VARCHAR(255),
                    room_type_name VARCHAR(255),
                    description TEXT,
                    amenities_json LONGTEXT,
                    bed_types_json LONGTEXT,
                    customized_room_type LONGTEXT,
                    images_json LONGTEXT,
                    size_in_m2 SMALLINT NULL,
                    beds SMALLINT NULL,
                    extrabeds SMALLINT NULL,
                    max_occupancy SMALLINT NULL,
                    shared_room TINYINT(1) DEFAULT 0,
                    shared_facilities TINYINT(1) DEFAULT 0,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                    UNIQUE KEY hotel_room_unique (hotel_id, room_type_id),
                    KEY hotel_id_idx (hotel_id),
                    KEY room_type_idx (room_type_id)
                )");

                            // Parse room types with images from XML
                            $roomTypesNodes = $xp->query('.//sh:roomtypes//sh:roomtype | .//roomtypes//roomtype', $h);
                            if ($roomTypesNodes && $roomTypesNodes->length > 0) {
                                $nowRoomSync = current_time('mysql');
                                $xmlBool = static function ($value) {
                                    $value = strtolower(trim((string) $value));
                                    return in_array($value, ['1', 'true', 'yes', 'y'], true);
                                };
                                $collectLabels = static function (DOMXPath $xpCtx, DOMNode $context, array $paths) {
                                    $labels = [];
                                    foreach ($paths as $path) {
                                        $nodes = $xpCtx->query($path, $context);
                                        if ($nodes && $nodes->length > 0) {
                                            foreach ($nodes as $node) {
                                                $txt = trim((string) $node->nodeValue);
                                                if ($txt !== '') {
                                                    $labels[$txt] = true;
                                                }
                                            }
                                        }
                                    }
                                    return array_keys($labels);
                                };
                                $collectNumericMax = static function (DOMXPath $xpCtx, DOMNode $context, array $paths) {
                                    $max = null;
                                    foreach ($paths as $path) {
                                        $nodes = $xpCtx->query($path, $context);
                                        if ($nodes && $nodes->length > 0) {
                                            foreach ($nodes as $node) {
                                                $raw = trim((string) $node->nodeValue);
                                                if ($raw === '') {
                                                    continue;
                                                }
                                                if (!is_numeric($raw)) {
                                                    if (preg_match('/(\d+)/', $raw, $matches)) {
                                                        $raw = $matches[1];
                                                    } else {
                                                        continue;
                                                    }
                                                }
                                                $val = (int) round(floatval($raw));
                                                if ($val > 0) {
                                                    $max = max($max ?? 0, $val);
                                                }
                                            }
                                        }
                                    }
                                    return $max;
                                };
                                $hasFlag = static function (DOMXPath $xpCtx, DOMNode $context, array $paths) use ($xmlBool) {
                                    foreach ($paths as $path) {
                                        $nodes = $xpCtx->query($path, $context);
                                        if ($nodes && $nodes->length > 0) {
                                            foreach ($nodes as $node) {
                                                if ($xmlBool($node->nodeValue)) {
                                                    return 1;
                                                }
                                            }
                                        }
                                    }
                                    return 0;
                                };
                                $amenityPaths = [
                                    './/sh:amenities//sh:amenity',
                                    './/amenities//amenity',
                                    './/sh:roomFacilities//sh:roomFacility',
                                    './/roomFacilities//roomFacility',
                                    './/sh:facilities//sh:facility',
                                    './/facilities//facility',
                                ];
                                $bedTypePaths = [
                                    './/sh:bedTypes//sh:bedType',
                                    './/bedTypes//bedType',
                                    './/sh:beds//sh:bed',
                                    './/beds//bed',
                                ];
                                $sharedRoomPaths = ['.//sh:sharedRoom', './/sharedRoom'];
                                $sharedFacilitiesPaths = ['.//sh:sharedFacilities', './/sharedFacilities'];
                                $bedsPaths = ['.//sh:beds', './/beds'];
                                $extrabedsPaths = ['.//sh:extrabeds', './/extrabeds', './/sh:extraBeds', './/extraBeds'];
                                $maxOccPaths = [
                                    './/sh:maxOccupancy',
                                    './/maxOccupancy',
                                    './/sh:maxoccupancy',
                                    './/maxoccupancy',
                                    './/sh:maxPersons',
                                    './/maxPersons',
                                    './/sh:maxpeople',
                                    './/maxpeople',
                                    './/sh:maxGuests',
                                    './/maxGuests'
                                ];
                                $sizePaths = ['.//sh:roomSize', './/roomSize', './/sh:roomsize', './/roomsize', './/sh:size', './/size', './/sh:roomArea', './/roomArea'];
                                $roomFacilityFormats = [
                                    'hotel_id' => '%d',
                                    'room_type_id' => '%d',
                                    'beds' => '%s',
                                    'extrabeds' => '%s',
                                    'max_occupancy' => '%s',
                                    'shared_room' => '%s',
                                    'shared_facilities' => '%s',
                                    'size_in_m2' => '%s',
                                    'amenities_json' => '%s',
                                    'bed_types_json' => '%s',
                                    'last_synced_at' => '%s',
                                    'updated_at' => '%s',
                                ];
                                $roomFacilityUpserts = [
                                    'beds = CASE WHEN VALUES(beds) IS NULL THEN beds ELSE VALUES(beds) END',
                                    'extrabeds = CASE WHEN VALUES(extrabeds) IS NULL THEN extrabeds ELSE VALUES(extrabeds) END',
                                    'max_occupancy = CASE WHEN VALUES(max_occupancy) IS NULL THEN max_occupancy ELSE VALUES(max_occupancy) END',
                                    'shared_room = CASE WHEN VALUES(shared_room) IS NULL THEN shared_room ELSE VALUES(shared_room) END',
                                    'shared_facilities = CASE WHEN VALUES(shared_facilities) IS NULL THEN shared_facilities ELSE VALUES(shared_facilities) END',
                                    'size_in_m2 = CASE WHEN VALUES(size_in_m2) IS NULL OR VALUES(size_in_m2) <= 0 THEN size_in_m2 ELSE VALUES(size_in_m2) END',
                                    'amenities_json = CASE WHEN VALUES(amenities_json) IS NULL THEN amenities_json ELSE VALUES(amenities_json) END',
                                    'bed_types_json = CASE WHEN VALUES(bed_types_json) IS NULL THEN bed_types_json ELSE VALUES(bed_types_json) END',
                                    'last_synced_at = VALUES(last_synced_at)',
                                    'updated_at = VALUES(updated_at)',
                                ];

                                foreach ($roomTypesNodes as $rtNode) {
                                    $rtId = 0;
                                    $rtName = '';
                                    $rtImages = [];
                                    $rtDescNode = $rtNode->getElementsByTagName('description')->item(0);
                                    $rtDescription = $rtDescNode ? trim((string) $rtDescNode->nodeValue) : '';

                                    // Get room type ID
                                    $rtIdNode = $rtNode->getElementsByTagName('roomtype.ID')->item(0);
                                    if (!$rtIdNode)
                                        $rtIdNode = $rtNode->getElementsByTagName('id')->item(0);
                                    if (!$rtIdNode)
                                        $rtIdNode = $rtNode->getElementsByTagName('roomTypeId')->item(0);
                                    if ($rtIdNode) {
                                        $rtId = intval($rtIdNode->nodeValue ?? 0);
                                    }

                                    // Get room type name
                                    $rtNameNode = $rtNode->getElementsByTagName('roomtype.Name')->item(0);
                                    if (!$rtNameNode)
                                        $rtNameNode = $rtNode->getElementsByTagName('name')->item(0);
                                    if (!$rtNameNode)
                                        $rtNameNode = $rtNode->getElementsByTagName('roomTypeName')->item(0);
                                    if ($rtNameNode) {
                                        $rtName = trim($rtNameNode->nodeValue ?? '');
                                    }

                                    // Collect facilities/meta per room type (for filters)
                                    $sharedRoomFlag = $hasFlag($xp, $rtNode, $sharedRoomPaths);
                                    $sharedFacilitiesFlag = $hasFlag($xp, $rtNode, $sharedFacilitiesPaths);
                                    $bedsVal = $collectNumericMax($xp, $rtNode, $bedsPaths);
                                    $extraBedsVal = $collectNumericMax($xp, $rtNode, $extrabedsPaths);
                                    $maxOccVal = $collectNumericMax($xp, $rtNode, $maxOccPaths);
                                    $sizeVal = $collectNumericMax($xp, $rtNode, $sizePaths);
                                    $amenitiesList = array_slice($collectLabels($xp, $rtNode, $amenityPaths), 0, 50);
                                    $bedTypesList = array_slice($collectLabels($xp, $rtNode, $bedTypePaths), 0, 20);

                                    // Fallback: als size_in_m2 niet in deze XML zit, probeer bestaande waarde uit ghwk_hotel_room_types
                                    if (($sizeVal === null || $sizeVal <= 0) && $hotel_id > 0 && $rtId > 0) {
                                        $sizeFallback = $wpdb->get_var($wpdb->prepare(
                                            "SELECT size_in_m2 FROM ghwk_hotel_room_types WHERE hotel_id = %d AND room_type_id = %d AND size_in_m2 > 0 LIMIT 1",
                                            $hotel_id,
                                            $rtId
                                        ));
                                        if (!empty($sizeFallback)) {
                                            $sizeVal = (int) $sizeFallback;
                                        }
                                    }
                                    $sizeStore = ($sizeVal !== null && $sizeVal > 0) ? (int) $sizeVal : null;

                                    if ($hotel_id > 0 && $rtId > 0) {
                                        $rfData = [
                                            'hotel_id' => (int) $hotel_id,
                                            'room_type_id' => (int) $rtId,
                                            'beds' => ($bedsVal !== null ? (int) $bedsVal : null),
                                            'extrabeds' => ($extraBedsVal !== null ? (int) $extraBedsVal : null),
                                            'max_occupancy' => ($maxOccVal !== null ? (int) $maxOccVal : null),
                                            'shared_room' => (int) $sharedRoomFlag,
                                            'shared_facilities' => (int) $sharedFacilitiesFlag,
                                            'size_in_m2' => ($sizeStore !== null ? (int) $sizeStore : null),
                                            'amenities_json' => !empty($amenitiesList) ? wp_json_encode($amenitiesList, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : null,
                                            'bed_types_json' => !empty($bedTypesList) ? wp_json_encode($bedTypesList, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : null,
                                            'last_synced_at' => $nowRoomSync,
                                            'updated_at' => $nowRoomSync,
                                        ];
                                        if (!shorttrips_wpdb_insert_on_duplicate('ghwk_room_facilities', $rfData, $roomFacilityFormats, $roomFacilityUpserts)) {
                                            $dbErrors[] = sprintf('Room facilities write failed for hotel %d room %d: %s', $hotel_id, $rtId, $wpdb->last_error);
                                        }
                                    }

                                    // Get room type images
                                    $rtImgNodes = $xp->query('.//sh:images//sh:image | .//images//image', $rtNode);
                                    if ($rtImgNodes && $rtImgNodes->length > 0) {
                                        foreach ($rtImgNodes as $imgNode) {
                                            $imgRaw = trim((string) ($imgNode->nodeValue ?? ''));
                                            if ($imgRaw === '' && method_exists($imgNode, 'getAttribute')) {
                                                $imgRaw = (string) ($imgNode->getAttribute('url') ?: $imgNode->getAttribute('src') ?: $imgNode->getAttribute('href') ?: $imgNode->getAttribute('id'));
                                            }

                                            // Extract image ID and build URL
                                            $imgId = $extractImageId($imgRaw);
                                            if ($imgId && $imgId > 0) {
                                                $imgUrl = $urlFromId($imgId, false);
                                                if ($imgUrl !== '')
                                                    $rtImages[] = $imgUrl;
                                            }
                                        }
                                    }

                                    // Save to database if we have valid data
                                    if ($hotel_id > 0 && !empty($rtName) && !empty($rtImages)) {
                                        $rtImagesJson = json_encode(array_unique($rtImages), JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);

                                        $safeSize = ($sizeVal !== null && (int) $sizeVal > 0) ? (int) $sizeVal : 0;
                                        $wpdb->query($wpdb->prepare(
                                            "INSERT INTO ghwk_hotel_room_types (hotel_id, room_type_id, name, room_type_name, description, images_json, size_in_m2, updated_at)
                                 VALUES (%d, %d, %s, %s, %s, %s, %d, NOW())
                                 ON DUPLICATE KEY UPDATE
                                    name = VALUES(name),
                                    room_type_name = VALUES(room_type_name),
                                    description = VALUES(description),
                                    images_json = VALUES(images_json),
                                    size_in_m2 = IF(VALUES(size_in_m2) > 0, VALUES(size_in_m2), size_in_m2),
                                    updated_at = NOW()",
                                            $hotel_id,
                                            $rtId,
                                            sanitize_text_field($rtName),
                                            sanitize_text_field($rtName),
                                            wp_kses_post($rtDescription),
                                            $rtImagesJson,
                                            $safeSize
                                        ));
                                    }
                                }
                            }
                            // ============================================================
                            // END ROOM TYPES IMAGES SYNC
                            // ============================================================
                        }
                        $batchHotelCount++;
                        if ($capReached) {
                            break;
                        }
                    }
                }
            } catch (\Throwable $e) {
                if ($format !== 'json') {
                    echo "‚è≠Ô∏è Overslaan: parse/regex fout voor bestemming {$destinationId} ‚Äì " . $e->getMessage() . "\n";
                }
                // laat batch verder gaan naar volgende bestemming
            }
            $reader->close();
            @unlink($responseFile);

            if ($format !== 'json') {
                echo "‚úÖ {$batchHotelCount} hotels opgeslagen voor {$dest->destination_name}.\n";
                @ob_flush();
                flush();
            }
            if ($capReached) {
                if ($format !== 'json') {
                    echo "‚èπÔ∏è Cap bereikt ({$capInserted}). Stoppen.\n";
                }break;
            }
        }
        // Bereken totaal aantal hotels in deze batch (opgeslagen in laatste uur)
        $totalHotelsInBatch = (int) $wpdb->get_var("
        SELECT COUNT(*) 
        FROM {$table} 
        WHERE updated_at >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
    ");

        // Persist next suggested batch index for the admin UI
        $nextBatch = ($batch < $totalBatches) ? ($batch + 1) : 1;
        update_option('shorttrips_sync_next_batch', $nextBatch);

        if ($cleanupAfter) {
            $deletedAfter = $wpdb->query(
                $wpdb->prepare(
                    "DELETE FROM {$table} WHERE updated_at IS NULL OR updated_at < DATE_SUB(NOW(), INTERVAL %d HOUR)",
                    $olderHours
                )
            );
        } else {
            $deletedAfter = 0;
        }

        if ($format === 'json') {
            echo shorttrips_safe_json_encode([
                'batch' => $batch,
                'total_batches' => $totalBatches,
                'completed' => true,
                'hotels_saved' => $totalHotelsInBatch,
                'destinations_processed' => count($destinations),
                'deleted_after' => (int) $deletedAfter,
                'cap_reached' => $capReached,
                'table' => $table,
                'db_errors' => array_slice($dbErrors, 0, 5),
                'message' => "Batch {$batch} voltooid"
            ]);
        } else {
            echo "\nüéâ Batch voltooid ({$limit} bestemmingen verwerkt).\n";
        }
        die();
    }
});

// -----------------------------------------------------------------------------
// SHORTTRIPS ‚Äì Lookups Runner (front) using Static + NonStatic with verbose logs
// Start via: https://example.com/?sync_lookups=1&_wpnonce=...
// Optional: &only=features,themes,meals,room_note_types,hotel_note_types,languages
// -----------------------------------------------------------------------------
add_action('init', function () {
    if (!isset($_GET['sync_lookups']))
        return;
    nocache_headers();
    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed');
    }
    $nonce = isset($_GET['_wpnonce']) ? $_GET['_wpnonce'] : '';
    if (empty($nonce) || !wp_verify_nonce($nonce, 'shorttrips_sync')) {
        status_header(403);
        exit('Invalid nonce');
    }

    $format = isset($_GET['format']) ? $_GET['format'] : 'json';
    while (ob_get_level()) {
        ob_end_clean();
    }
    if ($format === 'json') {
        header('Content-Type: application/json; charset=utf-8');
    } else {
        header('Content-Type: text/plain; charset=utf-8');
    }

    global $wpdb;
    $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
    $soapEndpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

    // Parse optional "only" parameter (comma-separated list of keys)
    $onlyParamRaw = isset($_GET['only']) ? $_GET['only'] : '';
    $onlyList = null;
    if ($onlyParamRaw !== '') {
        $onlyParamRaw = is_string($onlyParamRaw) ? $onlyParamRaw : '';
        $onlyList = array_filter(array_map('trim', explode(',', strtolower($onlyParamRaw))));
        if (empty($onlyList)) {
            $onlyList = null;
        }
    }
    $shouldSync = function (string $key) use ($onlyList): bool {
        if ($onlyList === null) {
            return true; // no filter ‚Üí sync everything
        }
        return in_array(strtolower($key), $onlyList, true);
    };

    $colExists = function (string $table, string $col) use ($wpdb) {
        return (bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `$table` LIKE %s", $col)); };
    $nameCol = function (string $table) use ($colExists) {
        return $colExists($table, 'name') ? 'name' : ($colExists($table, 'nameIndex') ? 'nameIndex' : 'name'); };
    $imgCol = function (string $table) use ($colExists) {
        return $colExists($table, 'image') ? 'image' : ($colExists($table, 'image_url') ? 'image_url' : 'image'); };

    $soapCall = function (string $action, string $xpathItems, array $extract) use ($soapEndpoint, $creds) {
        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<' . $action . ' xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</' . $action . '>'
            . '</soap:Body>'
            . '</soap:Envelope>';
        $r = wp_remote_post($soapEndpoint, ['headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/' . $action . '"'], 'body' => $soap, 'timeout' => 60]);
        if (is_wp_error($r) || empty($r['body']))
            return ['found' => 0, 'items' => []];
        $xml = @simplexml_load_string($r['body']);
        if (!$xml)
            return ['found' => 0, 'items' => []];
        $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
        $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
        $nodes = $xml->xpath($xpathItems);
        $items = [];
        if ($nodes) {
            foreach ($nodes as $n) {
                // Generic extraction tolerant to namespaces/attributes
                $id = 0;
                $name = '';
                $img = '';
                $candidatesId = [(string) ($n->id ?? ''), (string) ($n->Id ?? ''), (string) ($n['id'] ?? ''), (string) ($n['Id'] ?? '')];
                foreach ($candidatesId as $c) {
                    if ($c !== '') {
                        $id = intval($c);
                        break;
                    }
                }
                $candidatesName = [(string) ($n->name ?? ''), (string) ($n->Name ?? ''), (string) ($n->description ?? ''), (string) ($n->Description ?? ''), trim((string) $n)];
                foreach ($candidatesName as $c) {
                    if ($c !== '') {
                        $name = $c;
                        break;
                    }
                }
                $candidatesImg = [(string) ($n->image ?? ''), (string) ($n->Image ?? ''), (string) ($n['image'] ?? ''), (string) ($n['Image'] ?? '')];
                foreach ($candidatesImg as $c) {
                    if ($c !== '') {
                        $img = $c;
                        break;
                    }
                }
                if ($id <= 0 && $name !== '') {
                    $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                }
                if ($id > 0 && $name !== '') {
                    $items[] = ['id' => $id, 'name' => $name, 'image' => $img];
                }
            }
        }
        return ['found' => count($nodes ?? []), 'items' => $items];
    };

    $nsCall = function (string $action, string $xpathItems, array $extract) {
        $x = shorttrips_call_nonstatic_xml($action);
        if (!$x)
            return ['found' => 0, 'items' => []];
        $x->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
        $nodes = $x->xpath($xpathItems);
        $items = [];
        if ($nodes) {
            foreach ($nodes as $n) {
                $id = 0;
                $name = '';
                $img = '';
                $candidatesId = [(string) ($n->id ?? ''), (string) ($n->Id ?? ''), (string) ($n['id'] ?? ''), (string) ($n['Id'] ?? '')];
                foreach ($candidatesId as $c) {
                    if ($c !== '') {
                        $id = intval($c);
                        break;
                    }
                }
                $candidatesName = [(string) ($n->name ?? ''), (string) ($n->Name ?? ''), (string) ($n->description ?? ''), (string) ($n->Description ?? ''), trim((string) $n)];
                foreach ($candidatesName as $c) {
                    if ($c !== '') {
                        $name = $c;
                        break;
                    }
                }
                $candidatesImg = [(string) ($n->image ?? ''), (string) ($n->Image ?? ''), (string) ($n['image'] ?? ''), (string) ($n['Image'] ?? '')];
                foreach ($candidatesImg as $c) {
                    if ($c !== '') {
                        $img = $c;
                        break;
                    }
                }
                if ($id <= 0 && $name !== '') {
                    $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                }
                if ($id > 0 && $name !== '') {
                    $items[] = ['id' => $id, 'name' => $name, 'image' => $img];
                }
            }
        }
        return ['found' => count($nodes ?? []), 'items' => $items];
    };

    $summary = [];
    $upsertSimple = function (string $table, array $items) use ($wpdb, $nameCol) {
        $ncol = $nameCol($table);
        $ins = 0;
        foreach ($items as $it) {
            $ok = $wpdb->query($wpdb->prepare("REPLACE INTO `$table` (id,`$ncol`,updated_at) VALUES (%d,%s,NOW())", $it['id'], $it['name']));
            if ($ok !== false)
                $ins++;
        }
        return $ins;
    };
    $upsertWithImage = function (string $table, array $items) use ($wpdb, $nameCol, $imgCol) {
        $ncol = $nameCol($table);
        $icol = $imgCol($table);
        $ins = 0;
        foreach ($items as $it) {
            $ok = $wpdb->query($wpdb->prepare("REPLACE INTO `$table` (id,`$ncol`,`$icol`,updated_at) VALUES (%d,%s,%s,NOW())", $it['id'], $it['name'], $it['image']));
            if ($ok !== false)
                $ins++;
        }
        return $ins;
    };

    // Features (NonStatic ‚Üí fallback Static)
    if ($shouldSync('features')) {
        $ns = $nsCall('GetFeatures', '//sh:features//sh:feature | //features//feature', ['id' => './/sh:id | .//id | .//@id', 'name' => './/sh:name | .//name | .']);
        $st = $soapCall('GetFeatures', '//soap:Body//sh:getFeaturesResult//sh:features//sh:feature', ['id' => './/sh:id | .//id | .//@id', 'name' => './/sh:name | .//name | .']);
        $items = !empty($ns['items']) ? $ns['items'] : $st['items'];
        $summary['features'] = ['found' => max($ns['found'], $st['found']), 'updated' => $upsertSimple('ghwk_features', $items)];
    }

    // Themes (prefer Static for image)
    if ($shouldSync('themes')) {
        $st = $soapCall('GetThemes', '//soap:Body//sh:getThemesResult//sh:themes//sh:theme', ['id' => './/sh:id | .//id | .//@id', 'name' => './/sh:name | .//name | .', 'img' => './/sh:image | .//image | .//@image']);
        $summary['themes'] = ['found' => $st['found'], 'updated' => $upsertWithImage('ghwk_themes', $st['items'])];
    }

    // Meals (Static)
    if ($shouldSync('meals')) {
        $st = $soapCall('GetMeals', '//soap:Body//sh:getMealsResult//sh:meals//sh:meal', ['id' => './/sh:id | .//id | .//@id', 'name' => './/sh:name | .//name | .']);
        $summary['meals'] = ['found' => $st['found'], 'updated' => $upsertSimple('ghwk_meals', $st['items'])];
    }

    // Room Note Types (NonStatic only)
    if ($shouldSync('room_note_types')) {
        $ns = $nsCall('GetRoomNoteTypes', '//sh:noteTypes//sh:noteType | //sh:roomNoteTypes//sh:roomNoteType | //*[(local-name()="noteTypes" or local-name()="roomNoteTypes")]/*', ['id' => './/sh:id | .//id | .//@id', 'name' => './/sh:name | .//name | .//sh:description | .//description | .']);
        $summary['room_note_types'] = ['found' => $ns['found'], 'updated' => $upsertSimple('ghwk_room_note_types', $ns['items'])];
    }

    // Hotel Note Types (NonStatic only)
    if ($shouldSync('hotel_note_types')) {
        $ns = $nsCall('GetHotelNoteTypes', '//sh:hotelNoteTypes//sh:hotelNoteType | //sh:noteTypes//sh:noteType | //*[(local-name()="hotelNoteTypes" or local-name()="noteTypes")]/*', ['id' => './/sh:id | .//id | .//@id', 'name' => './/sh:name | .//name | .//sh:description | .//description | .']);
        $summary['hotel_note_types'] = ['found' => $ns['found'], 'updated' => $upsertSimple('ghwk_hotel_note_types', $ns['items'])];
    }

    // Languages (NonStatic only)
    if ($shouldSync('languages')) {
        $ns = $nsCall('GetLanguages', '//sh:languages//sh:language | //languages//language | //sh:language | //language | //*[(local-name()="languages")]/*', ['id' => './/sh:id | .//id | .//@id', 'name' => './/sh:name | .//name | .']);
        $summary['languages'] = ['found' => $ns['found'], 'updated' => $upsertSimple('ghwk_languages', $ns['items'])];
    }

    if ($format === 'json') {
        echo shorttrips_safe_json_encode(['completed' => true, 'summary' => $summary]);
    } else {
        foreach ($summary as $k => $v) {
            echo strtoupper($k) . ": found {$v['found']} updated {$v['updated']}\n";
        }
    }
    die();
});
// ===== Freestays DB schema updater (idempotent) =====
add_action('init', function () {
    $target_version = '1.0.9'; // bump bij nieuwe kolommen/indexen
    $current = get_option('freestays_schema_version', '0.0.0');
    if (version_compare($current, $target_version, '>=')) {
        return;
    }

    global $wpdb;

    // Helpers
    $column_exists = function (string $table, string $column) use ($wpdb): bool {
        return (bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `$table` LIKE %s", $column));
    };
    $index_exists = function (string $table, string $index) use ($wpdb): bool {
        return (bool) $wpdb->get_var($wpdb->prepare("SHOW INDEX FROM `$table` WHERE Key_name = %s", $index));
    };
    $add_column = function (string $table, string $column, string $definition) use ($wpdb, $column_exists) {
        if (!$column_exists($table, $column)) {
            $wpdb->query("ALTER TABLE `$table` ADD COLUMN `$column` $definition");
        }
    };
    $add_index = function (string $table, string $indexName, string $definitionSql, bool $unique = false) use ($wpdb, $index_exists) {
        if (!$index_exists($table, $indexName)) {
            $type = $unique ? 'UNIQUE' : 'INDEX';
            $wpdb->query("ALTER TABLE `$table` ADD $type `$indexName` $definitionSql");
        }
    };
    $supports_json = function () use ($wpdb): bool {
        $ver = $wpdb->get_var('SELECT VERSION()');
        return version_compare($ver, '5.7.8', '>='); // MySQL JSON support
    };
    $jsonType = $supports_json() ? 'JSON' : 'LONGTEXT';

    // Tabellen (pas aan naar de tabel waar de sync naar schrijft)
    $hotels = 'ghwk_bravo_hotels';
    // RoomTypes: kies ghwk_hotel_room_types als die bestaat, anders prefix-variant
    $candidateRt1 = 'ghwk_hotel_room_types';
    $candidateRt2 = $wpdb->prefix . 'hotel_room_types';
    $roomTypes = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $candidateRt1)) ? $candidateRt1 : $candidateRt2;

    // Maak ghwk_hotel_room_types aan indien nog niet aanwezig (single-room flow ondersteuning)
    if (!$wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $candidateRt1))) {
        $wpdb->query(
            "CREATE TABLE IF NOT EXISTS {$candidateRt1} (
                id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
                hotel_id INT UNSIGNED NOT NULL,
                name VARCHAR(255) NOT NULL,
                description TEXT NULL,
                amenities_json {$jsonType} NULL,
                images_json {$jsonType} NULL,
                size_in_m2 SMALLINT NULL,
                beds TINYINT NULL,
                extrabeds TINYINT NULL,
                shared_room TINYINT(1) NULL,
                shared_facilities TINYINT(1) NULL,
                customized_room_type {$jsonType} NULL,
                created_at DATETIME NULL,
                updated_at DATETIME NULL,
                PRIMARY KEY (id),
                KEY idx_hotel_id (hotel_id),
                KEY idx_name (name)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"
        );
        $roomTypes = $candidateRt1;
    }

    // bravo_hotels ‚Äî kolommen
    $add_column($hotels, 'review_count', 'INT UNSIGNED NULL');
    $add_column($hotels, 'destination_id', 'INT UNSIGNED NULL');
    $add_column($hotels, 'resort_id', 'INT UNSIGNED NULL');
    $add_column($hotels, 'type', 'VARCHAR(50) NULL');
    $add_column($hotels, 'classification', 'TINYINT NULL');
    $add_column($hotels, 'headline', 'TEXT NULL');
    $add_column($hotels, 'description', 'LONGTEXT NULL');
    $add_column($hotels, 'addr_1', 'VARCHAR(255) NULL');
    $add_column($hotels, 'addr_2', 'VARCHAR(255) NULL');
    $add_column($hotels, 'zip', 'VARCHAR(32) NULL');
    $add_column($hotels, 'city', 'VARCHAR(128) NULL');
    $add_column($hotels, 'region', 'VARCHAR(128) NULL');
    $add_column($hotels, 'state', 'VARCHAR(128) NULL');
    $add_column($hotels, 'country', 'VARCHAR(128) NULL');
    $add_column($hotels, 'country_code', 'VARCHAR(8) NULL');
    $add_column($hotels, 'address', 'VARCHAR(255) NULL');
    $add_column($hotels, 'map_lat', 'DECIMAL(10,7) NULL');
    $add_column($hotels, 'map_lng', 'DECIMAL(10,7) NULL');
    $add_column($hotels, 'time_zone', 'VARCHAR(32) NULL');
    $add_column($hotels, 'features_json', "$jsonType NULL");
    $add_column($hotels, 'themes_json', "$jsonType NULL");
    $add_column($hotels, 'images_json', "$jsonType NULL");
    $add_column($hotels, 'distance_types_json', "$jsonType NULL");

    // bravo_hotels ‚Äî indexen
    $add_index($hotels, 'idx_destination_id', '(destination_id)');
    $add_index($hotels, 'idx_resort_id', '(resort_id)');
    $add_index($hotels, 'idx_updated_at', '(updated_at)');

    // Unique op hotel_id (alleen toevoegen als nog niet unique)
    // Probeer eerst gewone index (veilig), zet daarna handmatig om naar UNIQUE als data clean is
    $add_index($hotels, 'idx_hotel_id', '(hotel_id)');

    // hotel_room_types ‚Äî kolommen
    if ($wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $roomTypes))) {
        $add_column($roomTypes, 'room_type_id', 'INT NULL');
        $add_column($roomTypes, 'name', 'VARCHAR(255) NULL');
        $add_column($roomTypes, 'shared_room', 'TINYINT(1) NULL');
        $add_column($roomTypes, 'shared_facilities', 'TINYINT(1) NULL');
        $add_column($roomTypes, 'images_json', "$jsonType NULL");
        $add_column($roomTypes, 'size_in_m2', 'SMALLINT NULL');
        $add_column($roomTypes, 'beds', 'TINYINT NULL');
        $add_column($roomTypes, 'extrabeds', 'TINYINT NULL');
        $add_column($roomTypes, 'amenities_json', "$jsonType NULL");
        $add_column($roomTypes, 'max_occupancy', 'TINYINT NULL');
        $add_column($roomTypes, 'customized_room_type', "$jsonType NULL");
    }

    // Lookup-tabellen voor filters (features/themes)
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_features (
		id INT UNSIGNED PRIMARY KEY,
		name VARCHAR(255) NOT NULL,
		updated_at DATETIME NULL,
		KEY idx_name (name)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_themes (
		id INT UNSIGNED PRIMARY KEY,
		name VARCHAR(255) NOT NULL,
		image VARCHAR(255) NULL,
		updated_at DATETIME NULL,
		KEY idx_name (name)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    // Nieuwe lookup: Meals (boards)
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_meals (
        id INT UNSIGNED PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        updated_at DATETIME NULL,
        KEY idx_name (name)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    // Nieuwe lookup: Room Note Types
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_note_types (
		id INT UNSIGNED PRIMARY KEY,
		name VARCHAR(255) NOT NULL,
		updated_at DATETIME NULL,
		KEY idx_name (name)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    // Nieuwe lookup: Hotel Note Types
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_note_types (
		id INT UNSIGNED PRIMARY KEY,
		name VARCHAR(255) NOT NULL,
		updated_at DATETIME NULL,
		KEY idx_name (name)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    // Nieuwe lookup: Languages
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_languages (
		id INT UNSIGNED PRIMARY KEY,
		name VARCHAR(255) NOT NULL,
		updated_at DATETIME NULL,
		KEY idx_name (name)
	) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_transfer_airports (
                airport_id INT UNSIGNED PRIMARY KEY,
                resort_id INT UNSIGNED NULL,
                airport_name VARCHAR(191) NOT NULL,
                iata_code VARCHAR(8) NULL,
                time_zone VARCHAR(64) NULL,
                last_synced_at DATETIME NULL,
                created_at DATETIME NULL,
                updated_at DATETIME NULL,
                KEY idx_resort (resort_id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_transfer_types (
                id INT UNSIGNED PRIMARY KEY,
                name VARCHAR(191) NOT NULL,
                updated_at DATETIME NULL,
                KEY idx_name (name)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_transfer_cache (
                id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
                cache_key VARCHAR(191) NOT NULL,
                hotel_id INT UNSIGNED NULL,
                resort_id INT UNSIGNED NULL,
                passengers SMALLINT NULL,
                request_payload {$jsonType} NULL,
                response_payload {$jsonType} NULL,
                expires_at DATETIME NOT NULL,
                created_at DATETIME NOT NULL,
                updated_at DATETIME NOT NULL,
                PRIMARY KEY (id),
                UNIQUE KEY uniq_cache_key (cache_key),
                KEY idx_expires (expires_at),
                KEY idx_hotel (hotel_id, resort_id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_facilities (
                id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
                hotel_id INT UNSIGNED NOT NULL,
                room_type_id INT UNSIGNED NOT NULL,
                beds TINYINT NULL,
                extrabeds TINYINT NULL,
                max_occupancy TINYINT NULL,
                shared_room TINYINT(1) DEFAULT 0,
                shared_facilities TINYINT(1) DEFAULT 0,
                size_in_m2 SMALLINT NULL,
                amenities_json {$jsonType} NULL,
                bed_types_json {$jsonType} NULL,
                last_synced_at DATETIME NULL,
                updated_at DATETIME NULL,
                PRIMARY KEY (id),
                UNIQUE KEY uniq_room_facilities (hotel_id, room_type_id),
                KEY idx_room_fac_room (room_type_id),
                KEY idx_room_fac_hotel (hotel_id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    // Materialized cache voor steden/resorts (snelle lookup voor zoekformulier)
    $wpdb->query("CREATE TABLE IF NOT EXISTS st_city_cache (
                id INT UNSIGNED NOT NULL,
                name VARCHAR(255) NOT NULL,
                name_lc VARCHAR(255) NOT NULL,
                country_id INT UNSIGNED NOT NULL,
                country_name VARCHAR(255) NOT NULL,
                slug VARCHAR(255) DEFAULT NULL,
                updated_at DATETIME NOT NULL,
                PRIMARY KEY (id),
                KEY idx_country (country_id),
                KEY idx_name (name_lc),
                KEY idx_country_name (country_id, name_lc)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    update_option('freestays_schema_version', $target_version, true);
}, -9998); // HIGH priority - run before templates but after reset hook

/*
  NOTE: Disabled legacy demo upsert block
  The code previously here wrote into `$wpdb->prefix.'bravo_hotels'` and referenced
  undefined `$hotelId` / `$loopDestinationId`, causing warnings and bypassing the
  real sync. The actual sync upsert lives above and writes to `ghwk_bravo_hotels`.
*/






// -----------------------------------------------------------------------------
// ADMIN PAGE ‚Äì Shorttrips Sync UI (Tools > Shorttrips Sync)
// -----------------------------------------------------------------------------
add_action('admin_menu', function () {
    add_management_page(
        'Shorttrips Sync',
        'Shorttrips Sync',
        'manage_options',
        'shorttrips-sync',
        'shorttrips_render_sync_page'
    );
});

function shorttrips_render_sync_page()
{
    if (!current_user_can('manage_options')) {
        wp_die(__('You do not have sufficient permissions to access this page.'));
    }

    global $wpdb;
    $totalDestinations = (int) $wpdb->get_var("SELECT COUNT(*) FROM bravo_destinations WHERE deleted_at IS NULL");
    $defaultLimit = 100;
    $nextBatch = (int) get_option('shorttrips_sync_next_batch', 1);
    if ($nextBatch < 1) {
        $nextBatch = 1;
    }
    $nonce = wp_create_nonce('shorttrips_sync');
    $frontUrl = home_url('/');

    $mockMode = get_option('shorttrips_prebook_mock_mode', '0');
    $mockScenario = sanitize_file_name(get_option('shorttrips_prebook_mock_scenario', 'default')) ?: 'default';
    $mockNotice = '';

    if (isset($_POST['shorttrips_prebook_mock_settings'])) {
        check_admin_referer('shorttrips_prebook_mock');
        $newMode = isset($_POST['shorttrips_prebook_mock_enabled']) ? '1' : '0';
        $newScenario = sanitize_file_name($_POST['shorttrips_prebook_mock_scenario'] ?? 'default');
        if ($newScenario === '') {
            $newScenario = 'default';
        }
        update_option('shorttrips_prebook_mock_mode', $newMode);
        update_option('shorttrips_prebook_mock_scenario', $newScenario);
        $mockMode = $newMode;
        $mockScenario = $newScenario;
        $mockNotice = '<div class="notice notice-success is-dismissible" style="margin:12px 0;"><p>Prebook testmodus-instellingen opgeslagen.</p></div>';
    }

    $totalBatches = max(1, (int) ceil($totalDestinations / max(10, min($defaultLimit, 250))));

    echo '<div class="wrap">';
    echo '<h1>Shorttrips Sync</h1>';
    echo '<p>Gebruik deze tool om Sunhotels static data in batches te synchroniseren.</p>';

    if ($mockNotice) {
        echo $mockNotice;
    }

    echo '<div class="card" style="max-width:720px;margin-top:12px;padding:16px 20px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.08);border-radius:6px;">';
    echo '<h2 style="margin-top:0;">Prebook testmodus</h2>';
    echo '<p style="color:#374151;">Schakel hier de dummy checkout flow in. Wanneer testmodus actief is worden er <strong>geen</strong> requests naar SunHotels verstuurd en worden kamerprijzen uit mockdata geladen.</p>';
    echo '<form method="post" style="display:flex;flex-direction:column;gap:12px;">';
    wp_nonce_field('shorttrips_prebook_mock');
    echo '<input type="hidden" name="shorttrips_prebook_mock_settings" value="1">';
    echo '<label style="display:flex;align-items:center;gap:10px;font-weight:600;">';
    echo '<input type="checkbox" name="shorttrips_prebook_mock_enabled" value="1" ' . checked($mockMode, '1', false) . ' />';
    echo 'Testmodus actief';
    echo '</label>';
    echo '<label style="display:flex;flex-direction:column;gap:4px;max-width:320px;">';
    echo '<span style="font-weight:600;">Mock scenario (bestandsnaam uit <code>wp-content/uploads/shorttrips-mocks</code>)</span>';
    echo '<input type="text" name="shorttrips_prebook_mock_scenario" value="' . esc_attr($mockScenario) . '">';
    echo '<span style="color:#6b7280;font-size:12px;">Laat leeg voor <code>default</code>. Gebruik bijvoorbeeld <code>familie</code> voor <code>familie.json</code>.</span>';
    echo '</label>';
    $statusLabel = $mockMode === '1' ? '<span style="color:#065f46;font-weight:600;">üß™ Testmodus staat AAN</span>' : '<span style="color:#991b1b;font-weight:600;">‚ö†Ô∏è Testmodus staat UIT</span>';
    echo '<p>' . $statusLabel . '</p>';
    echo '<button type="submit" class="button button-primary">Instellingen opslaan</button>';
    echo '</form>';
    echo '</div>';

    echo '<table class="widefat striped" style="max-width:720px;margin-top:12px;">';
    echo '<tbody>';
    echo '<tr><th scope="row">Totaal bestemmingen</th><td>' . esc_html($totalDestinations) . '</td></tr>';
    echo '<tr><th scope="row">Batch grootte</th><td><input id="st-sync-limit" type="number" min="10" max="250" value="' . esc_attr($defaultLimit) . '" /> (10‚Äì250)</td></tr>';
    echo '<tr><th scope="row">Volgende batch</th><td><input id="st-sync-batch" type="number" min="1" value="' . esc_attr($nextBatch) . '" /> / <span id="st-sync-total-batches">' . esc_html($totalBatches) . '</span></td></tr>';
    echo '</tbody>';
    echo '</table>';

    echo '<p style="margin-top:12px;">';
    echo '<button class="button button-primary" id="st-sync-run">Run next batch</button> ';
    echo '<button class="button" id="st-sync-recalc">Recalculate totals</button> ';
    echo '<button class="button" id="st-sync-reset">Reset progress</button>';
    echo ' <label style="margin-left:8px;">';
    echo '<input type="checkbox" id="st-sync-auto" /> Auto-run until complete';
    echo '</label>';
    echo ' <label style="margin-left:8px;">';
    echo '<input type="checkbox" id="st-sync-use-suggested" checked /> Use suggested next batch';
    echo '</label>';
    echo '</p>';

    // Direct URL helpers (updates live via JS)
    $initialUrl = add_query_arg([
        'sync_static_hotels' => $nextBatch,
        'limit' => $defaultLimit,
        'format' => 'json',
        '_wpnonce' => $nonce,
    ], $frontUrl);
    echo '<p style="max-width:720px;">';
    echo '<label for="st-sync-url"><strong>Direct URL</strong></label><br />';
    echo '<input id="st-sync-url" type="text" value="' . esc_attr($initialUrl) . '" style="width:100%;" readonly /> ';
    echo '<a class="button" id="st-sync-open" href="' . esc_url($initialUrl) . '" target="_blank" rel="noreferrer">Open direct URL</a>';
    echo '</p>';

    // Prune stale UI
    echo '<div style="max-width:720px;margin-top:12px;">';
    echo '<h2>Prune stale hotels</h2>';
    echo '<p>Delete hotels with <code>updated_at</code> older than the given hours.</p>';
    echo '<label>Older than (hours): <input id="st-clean-hours" type="number" min="1" max="8760" value="720" /></label> ';
    echo '<button class="button" id="st-clean-run">Prune stale</button>';
    echo '</div>';

    // New: Quick refresh buttons for lookups (admin-only)
    $adminSelf = admin_url('tools.php?page=shorttrips-sync');
    echo '<div style="max-width:720px;margin-top:18px;padding-top:10px;border-top:1px solid #e5e7eb;">';
    // Optional inline notice after refresh
    if (!empty($_GET['st_msg'])) {
        echo '<div class="notice notice-success" style="padding:8px 12px;margin:8px 0;">' . esc_html(wp_unslash($_GET['st_msg'])) . '</div>';
    }
    echo '<h2>Lookup tables sync</h2>';
    echo '<p>Sync alle lookup-tabellen (features, themes, meals, room-/hotelnotes, languages) via de centrale runner.</p>';

    // Runner (front) for lookups with verbose logging
    $lkBase = add_query_arg([
        'sync_lookups' => 1,
        'format' => 'json',
        '_wpnonce' => $nonce,
    ], $frontUrl);

    // E√©n duidelijke knop: volledige lookup sync
    echo '<p><a class="button button-primary" target="_blank" rel="noreferrer" href="' . esc_url($lkBase) . '">Run full lookup sync (all tables)</a></p>';

    // Snelle per-tabel knoppen via only=
    echo '<p style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">';
    echo '<a class="button" target="_blank" rel="noreferrer" href="' . esc_url(add_query_arg('only', 'features', $lkBase)) . '">Sync Features</a>';
    echo '<a class="button" target="_blank" rel="noreferrer" href="' . esc_url(add_query_arg('only', 'themes', $lkBase)) . '">Sync Themes</a>';
    echo '<a class="button" target="_blank" rel="noreferrer" href="' . esc_url(add_query_arg('only', 'meals', $lkBase)) . '">Sync Meals</a>';
    echo '<a class="button" target="_blank" rel="noreferrer" href="' . esc_url(add_query_arg('only', 'room_note_types', $lkBase)) . '">Sync Room Notes</a>';
    echo '<a class="button" target="_blank" rel="noreferrer" href="' . esc_url(add_query_arg('only', 'hotel_note_types', $lkBase)) . '">Sync Hotel Notes</a>';
    echo '<a class="button" target="_blank" rel="noreferrer" href="' . esc_url(add_query_arg('only', 'languages', $lkBase)) . '">Sync Languages</a>';
    echo '</p>';
    echo '<p class="description">Deze knoppen gebruiken de <code>?sync_lookups=1</code> runner. De losse <code>st_refresh_*</code>-acties blijven als fallback beschikbaar.</p>';
    echo '</div>';

    // Quick static sync presets with cap
    $front = trailingslashit($frontUrl);
    $preset = function ($cap, $limit) use ($front, $nonce) {
        $u = add_query_arg([
            'sync_static_hotels' => 1,
            'limit' => $limit,
            'format' => 'json',
            '_wpnonce' => $nonce,
            'auto' => 1,
            'hotels_cap' => $cap
        ], $front);
        return $u;
    };
    echo '<div style="max-width:720px;margin-top:18px;padding-top:10px;border-top:1px solid #e5e7eb;">';
    echo '<h2>Quick static sync (with cap)</h2>';
    echo '<p>Start an auto-run static sync with a maximum number of hotels.</p>';
    echo '<p style="display:flex;gap:8px;flex-wrap:wrap;">';
    echo '<a class="button button-primary" target="_blank" rel="noreferrer" href="' . esc_url($preset(100, 50)) . '">Run 100 hotels</a>';
    echo '<a class="button" target="_blank" rel="noreferrer" href="' . esc_url($preset(500, 75)) . '">Run 500 hotels</a>';
    echo '<a class="button" target="_blank" rel="noreferrer" href="' . esc_url($preset(1000, 100)) . '">Run 1000 hotels</a>';
    echo '</p>';
    echo '<p class="description">Opens runner in a new tab and stops automatically once the cap is reached.</p>';
    echo '</div>';

    // De-duplicate helper
    echo '<div style="max-width:720px;margin-top:18px;padding-top:10px;border-top:1px solid #e5e7eb;">';
    echo '<h2>Maintenance</h2>';
    echo '<p style="display:flex;gap:8px;flex-wrap:wrap;">';
    echo '<a class="button" href="' . esc_url(add_query_arg('st_dedupe_hotels', '1', $adminSelf)) . '">Deduplicate hotels & add unique index</a>';
    echo '</p>';
    echo '<p class="description">Removes duplicate rows by <code>hotel_id</code> and attempts to add <code>UNIQUE KEY (hotel_id)</code>.</p>';
    echo '</div>';

    echo '<pre id="st-sync-log" style="max-width:720px;height:260px;overflow:auto;background:#111;color:#d4d4d4;padding:12px;border-radius:6px;">Ready.</pre>';
    echo '<script>';
    echo '(()=>{';
    echo 'const adminAjax = ' . json_encode(admin_url('admin-ajax.php')) . ';';
    echo 'const front = ' . json_encode(trailingslashit($frontUrl)) . ';';
    echo 'const nonce = ' . json_encode($nonce) . ';';
    echo 'const log = (t)=>{ const el=document.getElementById("st-sync-log"); el.textContent += "\n" + t; el.scrollTop = el.scrollHeight; };';
    echo 'const q = (id)=>document.getElementById(id);';
    echo 'const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));';
    echo 'const FETCH_TIMEOUT_MS = 480000;';
    echo 'async function fetchWithTimeout(url, ms){ const ctrl = new AbortController(); const to = setTimeout(()=>ctrl.abort("timeout"), ms); try { return await fetch(url, {credentials:"same-origin", cache:"no-store", signal: ctrl.signal}); } finally { clearTimeout(to); } }';
    echo 'function totalBatchesFor(limit, total){ return Math.max(1, Math.ceil(total / clamp(limit,10,250))); }';
    echo 'function updateUrl(){ const limit = clamp(parseInt(q("st-sync-limit").value)||' . (int) $defaultLimit . ',10,250); const batch = parseInt(q("st-sync-batch").value)||1; let u = front + "?sync_static_hotels="+batch+"&limit="+limit+"&format=json&_wpnonce="+nonce; const autoEl = q("st-sync-auto"); if (autoEl && autoEl.checked) { u += "&auto=1"; } q("st-sync-url").value = u; q("st-sync-open").href = u; }';
    echo 'async function fetchInfo(){ const limit = clamp(parseInt(q("st-sync-limit").value)||' . (int) $defaultLimit . ',10,250); const url = front + "?sync_static_hotels=1&info_only=1&limit="+limit+"&format=json&_wpnonce="+nonce; const r = await fetchWithTimeout(url, 120000); if(!r.ok){ throw new Error("Info HTTP "+r.status); } const d = await r.json(); return d; }';
    echo 'updateUrl();';
    echo 'q("st-sync-limit").addEventListener("input", ()=>{ updateUrl(); });';
    echo 'q("st-sync-batch").addEventListener("input", ()=>{ updateUrl(); });';
    echo 'q("st-sync-recalc").addEventListener("click",()=>{ const limit = parseInt(q("st-sync-limit").value)||' . (int) $defaultLimit . '; const total = ' . (int) $totalDestinations . '; q("st-sync-total-batches").textContent = totalBatchesFor(limit,total); updateUrl(); log("Recalculated totals for limit="+limit+" ‚Üí batches="+q("st-sync-total-batches").textContent); });';
    echo 'q("st-sync-auto").addEventListener("change",()=>{ updateUrl(); });';
    echo 'q("st-sync-auto").addEventListener("click",()=>{ updateUrl(); });';
    echo 'q("st-sync-run").addEventListener("click", async ()=>{';
    echo '  const btn = q("st-sync-run"); btn.disabled = true;';
    echo '  const limit = clamp(parseInt(q("st-sync-limit").value)||' . (int) $defaultLimit . ',10,250);';
    echo '  let total = ' . (int) $totalDestinations . ';';
    echo '  let batch = parseInt(q("st-sync-batch").value)||1;';
    echo '  try {';
    echo '    const info = await fetchInfo();';
    echo '    if (q("st-sync-use-suggested").checked && info && info.next_batch) { batch = parseInt(info.next_batch) || batch; q("st-sync-batch").value = batch; }';
    echo '    if (info && info.total_destinations) { total = parseInt(info.total_destinations) || total; }';
    echo '  } catch(e) { log("‚ÑπÔ∏è Kon info niet verversen, ga door met lokale waarden."); }';
    echo '  const totalBatches = totalBatchesFor(limit,total);';
    echo '  q("st-sync-total-batches").textContent = totalBatches;';
    echo '  const url = front + "?sync_static_hotels="+batch+"&limit="+limit+"&format=json&_wpnonce="+nonce;';
    echo '  log("‚û°Ô∏è  Running batch "+batch+" of "+totalBatches+" (limit="+limit+")...");';
    echo '  updateUrl();';

    echo '  try {';
    echo '    const r = await fetchWithTimeout(url, FETCH_TIMEOUT_MS);';
    echo '    const ct = r.headers.get("content-type")||"";';
    echo '    if (!r.ok) { const txt = await r.text(); throw new Error("HTTP "+r.status+" - "+txt); }';
    echo '    const d = ct.includes("application/json") ? await r.json() : {message: await r.text()};';
    echo '    log("‚úÖ "+(d.message || "Batch completed"));';
    echo '    // Advance next batch (server also persists next index)';
    echo '    try { const info2 = await fetchInfo(); if(info2 && info2.next_batch){ batch = parseInt(info2.next_batch)||((batch < totalBatches)?(batch+1):1); } else { batch = (batch < totalBatches) ? (batch + 1) : 1; } } catch(_) { batch = (batch < totalBatches) ? (batch + 1) : 1; }';
    echo '    q("st-sync-batch").value = batch;';
    echo '    updateUrl();';
    echo '    if (q("st-sync-auto").checked) {';
    echo '      if (batch === 1) { log("üèÅ Completed all batches for current limit."); } else { setTimeout(()=>q("st-sync-run").click(), 250); }';
    echo '    }';
    echo '  } catch (e) {';
    echo '    log("‚ùå "+(e && e.message ? e.message : e));';
    echo '  } finally {';
    echo '    btn.disabled = false;';
    echo '  }';
    echo '});';

    // Cleanup button
    echo 'q("st-clean-run").addEventListener("click", async ()=>{';
    echo '  const btn = q("st-clean-run"); btn.disabled = true;';
    echo '  const hours = clamp(parseInt(q("st-clean-hours").value)||720, 1, 8760);';
    echo '  const url = front + "?sync_static_hotels=1&cleanup_only=1&older_than_hours="+hours+"&format=json&_wpnonce="+nonce;';
    echo '  log("üßπ Pruning hotels older than "+hours+" hours...");';
    echo '  try {';
    echo '    const r = await fetchWithTimeout(url, 120000);';
    echo '    if (!r.ok) { const txt = await r.text(); throw new Error("HTTP "+r.status+" - "+txt); }';
    echo '    const d = await r.json();';
    echo '    log("üßπ Deleted " + (d.deleted||0) + " rows (> " + hours + "h)." );';
    echo '  } catch(e) {';
    echo '    log("‚ùå Cleanup failed: "+(e && e.message ? e.message : e));';
    echo '  } finally {';
    echo '    btn.disabled = false;';
    echo '  }';
    echo '});';
    // Reset progress button
    echo 'q("st-sync-reset").addEventListener("click", async ()=>{';
    echo '  const btn = q("st-sync-reset"); btn.disabled = true;';
    echo '  const urlFront = front + "?sync_static_hotels=1&reset=1&format=json&_wpnonce="+nonce;';
    echo '  const urlAjax  = adminAjax + "?action=shorttrips_reset_sync&_wpnonce="+nonce;';
    echo '  log("üîÑ Resetting progress to batch 1...");';
    echo '  try {';
    echo '    // Prefer admin-ajax to avoid front-end caching/WAF issues';
    echo '    let r = await fetchWithTimeout(urlAjax, 30000);';
    echo '    if (!r.ok) {';
    echo '      // fallback to front endpoint';
    echo '      r = await fetchWithTimeout(urlFront, 30000);';
    echo '      if (!r.ok) {';
    echo '        const txt = await r.text(); throw new Error("HTTP "+r.status+" - "+txt);';
    echo '      }';
    echo '    }';
    echo '    q("st-sync-batch").value = 1;';
    echo '    updateUrl();';
    echo '    log("‚úÖ Progress reset to 1.");';
    echo '  } catch(e) {';
    echo '    log("‚ùå Reset failed: "+(e && e.message ? e.message : e));';
    echo '  } finally {';
    echo '    btn.disabled = false;';
    echo '  }';
    echo '});';
    echo '(async ()=>{ try{ const info = await fetchInfo(); if(info && info.next_batch){ q("st-sync-batch").value = parseInt(info.next_batch)||1; } if(info && info.total_batches){ q("st-sync-total-batches").textContent = parseInt(info.total_batches)||q("st-sync-total-batches").textContent; } updateUrl(); log("UI loaded. Ready to run sync."); } catch(e){ log("UI loaded. (Info fetch failed)"); } })();';
    echo '})();';
    echo '</script>';

    echo '</div>';
}

// Add AJAX reset handler for admin page
add_action('wp_ajax_shorttrips_reset_sync', 'shorttrips_reset_sync');
function shorttrips_reset_sync()
{
    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'Not allowed'], 403);
    }
    $nonce = isset($_REQUEST['_wpnonce']) ? $_REQUEST['_wpnonce'] : '';
    if (empty($nonce) || !wp_verify_nonce($nonce, 'shorttrips_sync')) {
        wp_send_json_error(['message' => 'Invalid nonce'], 403);
    }
    update_option('shorttrips_sync_next_batch', 1);
    wp_send_json_success(['message' => 'Reset to batch 1']);
}
// -----------------------------------------------------------------------------
// SHORTTRIPS ‚Äì Searchbar shortcode (plaats bovenaan pagina's)
// -----------------------------------------------------------------------------
add_shortcode('shorttrips_searchbar', function () {
    $checkin = sanitize_text_field($_REQUEST['start'] ?? ($_REQUEST['checkin'] ?? ''));
    $checkout = sanitize_text_field($_REQUEST['end'] ?? ($_REQUEST['checkout'] ?? ''));
    $rooms = intval($_REQUEST['room'] ?? ($_REQUEST['rooms'] ?? 1));
    $adults = intval($_REQUEST['adults'] ?? 2);
    $children = intval($_REQUEST['children'] ?? 0);
    $q = sanitize_text_field($_REQUEST['q'] ?? '');
    // Force single-room flow
    $rooms = 1;

    ob_start(); ?>
    <form method="get" action="" class="st-searchbar"
        style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:8px 0 16px 0;display:flex;flex-wrap:wrap;gap:8px;align-items:end">
        <div style="flex:1 1 240px;min-width:200px">
            <label style="display:block;font-size:12px;color:#6b7280">Destination or hotel</label>
            <input type="text" name="q" value="<?= esc_attr($q); ?>" placeholder="Amsterdam of hotelnaam"
                style="width:100%;border:1px solid #d1d5db;border-radius:8px;padding:8px" />
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Check‚Äëin</label>
            <input type="date" name="start" value="<?= esc_attr($checkin); ?>"
                style="border:1px solid #d1d5db;border-radius:8px;padding:8px" />
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Check‚Äëout</label>
            <input type="date" name="end" value="<?= esc_attr($checkout); ?>"
                style="border:1px solid #d1d5db;border-radius:8px;padding:8px" />
        </div>
        <div>
            <label for="st-room" style="display:block;font-size:12px;color:#6b7280">Rooms</label>
            <input id="st-room" type="number" name="room" min="1" max="1" value="<?= max(1, $rooms); ?>" placeholder="Rooms"
                style="width:80px;border:1px solid #d1d5db;border-radius:8px;padding:8px" />
            <input id="st-rooms" type="hidden" name="rooms" value="<?= max(1, $rooms); ?>" />
        </div>
        <div>
            <label for="st-adults" style="display:block;font-size:12px;color:#6b7280">Volwassenen</label>
            <input id="st-adults" type="number" name="adults" min="1" max="8" value="<?= max(1, $adults); ?>"
                placeholder="Adults" style="width:80px;border:1px solid #d1d5db;border-radius:8px;padding:8px" />
        </div>
        <div>
            <label for="st-children" style="display:block;font-size:12px;color:#6b7280">Kinderen</label>
            <input id="st-children" type="number" name="children" min="0" max="6" value="<?= max(0, $children); ?>"
                placeholder="Children" style="width:80px;border:1px solid #d1d5db;border-radius:8px;padding:8px" />
        </div>
        <div>
            <button type="submit" class="button button-primary"
                style="background:#2563eb;border:#2563eb;padding:10px 14px;border-radius:8px;color:#fff">Search</button>
        </div>
        <script>(function () {
                // Sync hidden rooms field with visible room input
                var r = document.getElementById('st-room');
                var rs = document.getElementById('st-rooms');
                if (r && rs) { r.addEventListener('input', function () { rs.value = r.value || '1'; }); }
            })();</script>
        <script>(function () {
                var f = document.querySelector('form.st-filters');
                if (!f) return;
                f.addEventListener('submit', function () {
                    var sb = document.querySelector('form.st-searchbar');
                    if (!sb) return;
                    var names = ['q', 'start', 'end', 'checkin', 'checkout', 'room', 'rooms', 'adults', 'children', 'child_ages', 'destination', 'destinationID', 'resort', 'resortID', 'country', 'language', 'currencies', 'hotelId'];
                    names.forEach(function (n) {
                        var els = sb.querySelectorAll('[name="' + n + '"]');
                        if (!els || !els.length) return;
                        els.forEach(function (el) {
                            var v = (el && typeof el.value !== 'undefined') ? el.value : '';
                            var input = document.createElement('input');
                            input.type = 'hidden'; input.name = n; input.value = v;
                            f.appendChild(input);
                        });
                    });
                });
            })();</script>
    </form>
    <?php return ob_get_clean();
});
// -----------------------------------------------------------------------------
// SHORTCODE ‚Äì Freestays filters (enhanced with dropdowns; overrides previous)
// -----------------------------------------------------------------------------
add_shortcode('freestays_filters', function () {
    // üö´ HIDE filter widget when search parameters are present (active search results)
    $hasSearchParams = !empty($_GET['destination_id']) || !empty($_GET['country_name']) || !empty($_GET['resort_name']);
    if ($hasSearchParams) {
        return ''; // Don't render filter widget during active search
    }

    // Post back to the current URL so we don't jump to prebook without hotelId
    $action = esc_url(strtok((isset($_SERVER['REQUEST_SCHEME']) ? $_SERVER['REQUEST_SCHEME'] : (is_ssl() ? 'https' : 'http')) . '://' . ($_SERVER['HTTP_HOST'] ?? '') . ($_SERVER['REQUEST_URI'] ?? ''), '#'));
    $qs = array_merge($_GET, $_POST);
    $get = function ($k, $d = '') use ($qs) {
        if (!isset($qs[$k]))
            return $d;
        $v = $qs[$k];
        if (is_array($v)) {
            $first = reset($v);
            return ($first === false ? $d : $first);
        }
        return $v;
    };

    // Build options (cached)
    $featuresOpt = shorttrips_get_feature_options();
    $themesOpt = shorttrips_get_theme_options();
    $mealsOpt = shorttrips_get_meal_options();

    // Selected values (single-value dropdowns) ‚Äì normalize arrays/CSV to scalar
    $selFeature = isset($qs['featureIds']) ? (is_array($qs['featureIds']) ? (string) reset($qs['featureIds']) : (string) $qs['featureIds']) : '';
    $selTheme = isset($qs['themeIds']) ? (is_array($qs['themeIds']) ? (string) reset($qs['themeIds']) : (string) $qs['themeIds']) : '';
    $selMeal = isset($qs['mealIds']) ? (is_array($qs['mealIds']) ? (string) reset($qs['mealIds']) : (string) $qs['mealIds']) : '';

    ob_start(); ?>
    <form method="get" action="<?= esc_url($action); ?>" class="st-filters"
        style="background:#f1f5f9;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:8px 0 16px 0;display:flex;flex-wrap:wrap;gap:10px;align-items:end">
        <?php
        // Ensure base search context persists on submit (GET)
        $persist = [
            'q',
            'start',
            'end',
            'checkin',
            'checkout',
            'room',
            'rooms',
            'adults',
            'children',
            'child_ages',
            'destination',
            'destinationID',
            'resort',
            'resortID',
            'country',
            'language',
            'currencies',
            'hotelId'
        ];
        foreach ($persist as $pk) {
            $val = null;
            if (isset($_GET[$pk])) {
                $val = $_GET[$pk];
            } elseif (isset($_POST[$pk])) {
                $val = $_POST[$pk];
            }
            if ($val === null || $val === '')
                continue;
            if (is_array($val)) {
                foreach ($val as $vv) {
                    echo '<input type="hidden" name="' . esc_attr($pk) . '[]" value="' . esc_attr($vv) . '" />';
                }
            } else {
                echo '<input type="hidden" name="' . esc_attr($pk) . '" value="' . esc_attr($val) . '" />';
            }
        }
        ?>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Min sterren</label>
            <select name="minStars" style="border:1px solid #d1d5db;border-radius:8px;padding:8px;min-width:80px">
                <option value="">-</option>
                <?php for ($i = 1; $i <= 5; $i++): ?>
                    <option value="<?= $i; ?>" <?= (string) $get('minStars') === (string) $i ? 'selected' : ''; ?>><?= $i; ?></option>
                <?php endfor; ?>
            </select>
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Max stars</label>
            <select name="maxStars" style="border:1px solid #d1d5db;border-radius:8px;padding:8px;min-width:80px">
                <option value="">-</option>
                <?php for ($i = 1; $i <= 5; $i++): ?>
                    <option value="<?= $i; ?>" <?= (string) $get('maxStars') === (string) $i ? 'selected' : ''; ?>><?= $i; ?></option>
                <?php endfor; ?>
            </select>
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Min price</label>
            <input type="number" name="minPrice" value="<?= esc_attr($get('minPrice')); ?>"
                style="width:110px;border:1px solid #d1d5db;border-radius:8px;padding:8px" />
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Max price</label>
            <input type="number" name="maxPrice" value="<?= esc_attr($get('maxPrice')); ?>"
                style="width:110px;border:1px solid #d1d5db;border-radius:8px;padding:8px" />
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Features</label>
            <select name="featureIds"
                style="min-width:220px;max-width:320px;border:1px solid #d1d5db;border-radius:8px;padding:8px;">
                <option value="">‚Äî kies ‚Äî</option>
                <?php foreach ($featuresOpt as $id => $name): ?>
                    <option value="<?= $id; ?>" <?= ((string) $id === (string) $selFeature) ? 'selected' : ''; ?>><?= esc_html($name); ?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Themes</label>
            <select name="themeIds"
                style="min-width:220px;max-width:320px;border:1px solid #d1d5db;border-radius:8px;padding:8px;">
                <option value="">‚Äî kies ‚Äî</option>
                <?php foreach ($themesOpt as $id => $name): ?>
                    <option value="<?= $id; ?>" <?= ((string) $id === (string) $selTheme) ? 'selected' : ''; ?>><?= esc_html($name); ?>
                    </option>
                <?php endforeach; ?>
            </select>
        </div>
        <div>
            <label style="display:block;font-size:12px;color:#6b7280">Board (meals)</label>
            <select name="mealIds"
                style="min-width:200px;max-width:300px;border:1px solid #d1d5db;border-radius:8px;padding:8px;">
                <option value="">‚Äî kies ‚Äî</option>
                <?php if (is_array($mealsOpt))
                    foreach ($mealsOpt as $id => $name): ?>
                        <option value="<?= $id; ?>" <?= ((string) $id === (string) $selMeal) ? 'selected' : ''; ?>><?= esc_html($name); ?>
                        </option>
                    <?php endforeach; ?>
            </select>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
            <label style="font-size:12px;color:#6b7280"><input type="checkbox" name="excludeSharedRooms" value="1"
                    <?= $get('excludeSharedRooms') ? 'checked' : ''; ?>> Geen gedeelde kamers</label>
            <label style="font-size:12px;color:#6b7280"><input type="checkbox" name="excludeSharedFacilities" value="1"
                    <?= $get('excludeSharedFacilities') ? 'checked' : ''; ?>> Geen gedeelde faciliteiten</label>
        </div>
        <?php
        // Build reset URL: preserve non-filter params by starting from merged GET+POST
        $resetKeysToClear = [
            'minStars',
            'maxStars',
            'minPrice',
            'maxPrice',
            'featureIds',
            'themeIds',
            'mealIds',
            'excludeSharedRooms',
            'excludeSharedFacilities'
        ];
        $resetQs = $qs; // merged earlier: $_GET + $_POST
        foreach ($resetKeysToClear as $rk) {
            if (isset($resetQs[$rk]))
                unset($resetQs[$rk]);
        }
        // Ensure base search context persists with consistent scalar/array handling
        $preserveKeys = [
            'q',
            'start',
            'end',
            'checkin',
            'checkout',
            'room',
            'rooms',
            'adults',
            'children',
            'child_ages',
            'destination',
            'destinationID',
            'resort',
            'resortID',
            'country',
            'language',
            'currencies',
            'hotelId'
        ];
        $tmp = [];
        foreach ($preserveKeys as $pk) {
            if (!isset($resetQs[$pk]))
                continue;
            $val = $resetQs[$pk];
            if (is_array($val)) {
                $tmp[$pk] = array_values($val);
            } else {
                $tmp[$pk] = $val;
            }
        }
        // Compose final query without filter keys
        $resetQuery = http_build_query(array_merge($resetQs, $tmp));
        $resetUrl = $action . ($resetQuery ? ('?' . $resetQuery) : '');
        ?>
        <div>
            <button type="submit" class="button button-primary"
                style="background:#2563eb;border:#2563eb;padding:10px 14px;border-radius:8px;color:#fff">Filters
                toepassen</button>
            <a href="<?= esc_url($resetUrl); ?>" class="button" style="margin-left:8px;">Reset</a>
        </div>
    </form>
    <?php return ob_get_clean();
});

// -----------------------------------------------------------------------------
// Hide ONLY the filters shortcode widget on certain pages via widget callback
// - Do NOT render the widget that contains [freestays_filters] on home or results
// - Allow it ONLY on prebook page
// -----------------------------------------------------------------------------
add_filter('widget_display_callback', function ($instance, $widget, $args) {
    if (is_admin())
        return $instance;
    $content = '';
    $idBase = isset($widget->id_base) ? (string) $widget->id_base : '';
    // Capture content across common widget types (classic + block widgets)
    if ($idBase === 'text' && isset($instance['text'])) {
        $content = (string) $instance['text'];
    } elseif ($idBase === 'custom_html' && isset($instance['content'])) {
        $content = (string) $instance['content'];
    } elseif ($idBase === 'shortcode' && isset($instance['text'])) {
        $content = (string) $instance['text'];
    } elseif ($idBase === 'block' && isset($instance['content'])) {
        $content = (string) $instance['content'];
    }
    $containsFiltersShortcode = (stripos($content, '[freestays_filters') !== false);
    if (!$containsFiltersShortcode)
        return $instance;

    // Block on homepage and results page
    // Check for results page by: page slug, query params, or AJAX action
    $currentUrl = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '';
    $hasSearchParams = !empty($_GET['destination_id']) || !empty($_GET['country_name']) || !empty($_GET['resort_name']);

    // Get all translated versions of hotel-zoeken page (Polylang multi-language support)
    $searchPageSlugs = [
        'hotel-zoeken',
        'hotel-suchen',
        'hotel-search',
        'hotels-deutsch',
        'recherche-hotel',
        'buscar-hotel',
        'cerca-hotel',
        'hotels',
        'hotel'
    ];
    $isSearchPage = false;
    foreach ($searchPageSlugs as $slug) {
        if ((is_page() && is_page($slug)) || (stripos($currentUrl, $slug) !== false)) {
            $isSearchPage = true;
            break;
        }
    }

    // ALWAYS hide filter widget when search parameters are present (regardless of page)
    // This ensures filter is hidden on ALL translated versions of the results page
    $isResults = $isSearchPage || $hasSearchParams;

    if (is_front_page() || is_home() || $isResults)
        return false;

    // Allow only on prebook page (slug 'prebook')
    $isPrebook = (is_page() && (is_page('prebook') || stripos((string) get_post_field('post_name', get_post()), 'prebook') !== false));
    if (!$isPrebook)
        return false;

    return $instance;
}, 10, 3);

// NOTE: Do not globally gate shortcode rendering; widget visibility is controlled
// via widget_display_callback, and results page uses explicit content injection.


// -----------------------------------------------------------------------------
// Admin helper ‚Äì refresh lookups (features/themes) via URL param
// Visit: /?st_refresh_lookups=1 (admin only)
// -----------------------------------------------------------------------------
add_action('admin_init', function () {
    if (!isset($_GET['st_refresh_lookups']) || $_GET['st_refresh_lookups'] !== '1')
        return;
    if (!current_user_can('manage_options'))
        return;
    $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';
    $do = function ($action) use ($creds, $endpoint) {
        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<' . $action . ' xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</' . $action . '>'
            . '</soap:Body>'
            . '</soap:Envelope>';
        $r = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/' . $action . '"'],
            'body' => $soap,
            'timeout' => 60
        ]);
        return (!is_wp_error($r) && !empty($r['body'])) ? $r['body'] : '';
    };
    global $wpdb;
    $bodyF = $do('GetFeatures');
    if ($bodyF) {
        $xml = @simplexml_load_string($bodyF);
        if ($xml) {
            $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            $nodes = $xml->xpath('//soap:Body//sh:getFeaturesResult//sh:features//sh:feature');
            if ($nodes) {
                foreach ($nodes as $n) {
                    $id = intval($n->id ?? 0);
                    $name = (string) ($n->name ?? '');
                    if ($id > 0 && $name !== '') {
                        $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_features (id,name,updated_at) VALUES (%d,%s,NOW())", $id, $name));
                    }
                }
            }
        }
    }
    $bodyT = $do('GetThemes');
    if ($bodyT) {
        $xml = @simplexml_load_string($bodyT);
        if ($xml) {
            $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            $nodes = $xml->xpath('//soap:Body//sh:getThemesResult//sh:themes//sh:theme');
            if ($nodes) {
                foreach ($nodes as $n) {
                    $id = intval($n->id ?? 0);
                    $name = (string) ($n->name ?? '');
                    $img = (string) ($n->image ?? '');
                    if ($id > 0 && $name !== '') {
                        $wpdb->query($wpdb->prepare("REPLACE INTO ghwk_themes (id,name,image,updated_at) VALUES (%d,%s,%s,NOW())", $id, $name, $img));
                    }
                }
            }
        }
    }
    delete_transient('st_filters_features');
    delete_transient('st_filters_themes');
    wp_safe_redirect(remove_query_arg('st_refresh_lookups'));
    exit;
});

// -----------------------------------------------------------------------------
// Helper NonStatic POST (x-www-form-urlencoded) ‚Üí SimpleXML of null
// -----------------------------------------------------------------------------
function shorttrips_call_nonstatic_xml($action, $params = [])
{
    $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx/' . $action;
    // Support agency/company if provided by credentials function (some NonStatic endpoints require these)
    $agency = $creds['agency'] ?? ($creds['agency_number'] ?? ($creds['AgencyNumber'] ?? ''));
    $company = $creds['company'] ?? ($creds['company_number'] ?? ($creds['CompanyNumber'] ?? ''));
    $base = [
        'userName' => $creds['username'],
        'password' => $creds['password'],
        'language' => $creds['language'],
    ];
    if (!empty($agency)) {
        $base['agency'] = $agency;
    }
    if (!empty($company)) {
        $base['company'] = $company;
    }
    $body = array_merge($base, $params);
    $resp = wp_remote_post($endpoint, [
        'headers' => ['Content-Type' => 'application/x-www-form-urlencoded'],
        'body' => http_build_query($body),
        'timeout' => 120,
    ]);
    if (is_wp_error($resp) || empty($resp['body']))
        return null;
    $xml = @simplexml_load_string($resp['body']);
    return $xml ?: null;
}
// -----------------------------------------------------------------------------
// Admin helpers ‚Äì refresh destinations/features/room note types (NonStatic)
// /?st_refresh_destinations=1, /?st_refresh_features=1, /?st_refresh_room_notes=1
// -----------------------------------------------------------------------------
add_action('admin_init', function () {
    if (!current_user_can('manage_options'))
        return;
    global $wpdb;

    // Basic credential presence check used by lookups
    $credsGlobal = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
    $credsMissing = (empty($credsGlobal['username']) || empty($credsGlobal['password']));

    // DB helpers
    $col_exists = function (string $table, string $column) use ($wpdb): bool {
        return (bool) $wpdb->get_var($wpdb->prepare("SHOW COLUMNS FROM `$table` LIKE %s", $column));
    };

    if (isset($_GET['st_refresh_destinations']) && $_GET['st_refresh_destinations'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_destinations');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }
        $updated = 0;
        $found = 0;
        $xml = shorttrips_call_nonstatic_xml('GetDestinations');
        if ($xml) {
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            $nodes = $xml->xpath('//sh:DestinationList//sh:Destinations//sh:Destination');
            if (!$nodes || count($nodes) === 0) {
                $nodes = $xml->xpath('//Destinations//Destination');
            }
            if ($nodes) {
                $found = count($nodes);
                foreach ($nodes as $n) {
                    $did = intval($n->destination_id ?? 0);
                    $dnam = (string) ($n->DestinationName ?? '');
                    $cid = intval($n->CountryId ?? 0);
                    $cnm = (string) ($n->CountryName ?? '');
                    if ($did <= 0 || $dnam === '')
                        continue;
                    $ok = $wpdb->query($wpdb->prepare(
                        "INSERT INTO bravo_destinations (destination_id,destination_name,country_id,country_name) VALUES (%d,%s,%d,%s)
                         ON DUPLICATE KEY UPDATE destination_name=VALUES(destination_name), country_id=VALUES(country_id), country_name=VALUES(country_name)",
                        $did,
                        $dnam,
                        $cid,
                        $cnm
                    ));
                    if ($ok !== false) {
                        $updated++;
                    }
                }
            }
        }
        $redir = remove_query_arg('st_refresh_destinations');
        $redir = add_query_arg('st_msg', rawurlencode("Destinations updated: {$updated} (found: {$found})"), $redir);
        wp_safe_redirect($redir);
        exit;
    }

    if (isset($_GET['st_refresh_features']) && $_GET['st_refresh_features'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_features');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }
        $updated = 0;
        $found = 0;
        $err = '';
        $xml = shorttrips_call_nonstatic_xml('GetFeatures');
        if ($xml) {
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            $nodes = $xml->xpath('//sh:features//sh:feature | //features//feature | //*[@*]/*[local-name()="feature"]');
            if ($nodes) {
                $found = count($nodes);
                foreach ($nodes as $n) {
                    if ($n instanceof SimpleXMLElement) {
                        $n->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    }
                    $idNode = $n->xpath('.//sh:id | .//id | .//@id');
                    $nameNode = $n->xpath('.//sh:name | .//name | .//sh:description | .//description | .');
                    $id = intval((string) ($idNode[0] ?? ''));
                    $name = trim((string) ($nameNode[0] ?? ''));
                    if ($id > 0 && $name !== '') {
                        $nameCol = $col_exists('ghwk_features', 'name') ? 'name' : ($col_exists('ghwk_features', 'nameIndex') ? 'nameIndex' : 'name');
                        $sql = "REPLACE INTO ghwk_features (id,`$nameCol`,updated_at) VALUES (%d,%s,NOW())";
                        $ok = $wpdb->query($wpdb->prepare($sql, $id, $name));
                        if ($ok !== false) {
                            $updated++;
                        } else if (!$err && $wpdb->last_error) {
                            $err = $wpdb->last_error;
                        }
                    }
                }
            }
        }
        if ($updated === 0) {
            // Fallback to Static SOAP
            $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
            $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';
            $soap = '<?xml version="1.0" encoding="utf-8"?>'
                . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
                . '<soap:Body>'
                . '<GetFeatures xmlns="http://xml.sunhotels.net/15/">'
                . '<userName>' . esc_html($creds['username']) . '</userName>'
                . '<password>' . esc_html($creds['password']) . '</password>'
                . '<language>' . esc_html($creds['language']) . '</language>'
                . '</GetFeatures>'
                . '</soap:Body>'
                . '</soap:Envelope>';
            $resp = wp_remote_post($endpoint, [
                'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetFeatures"'],
                'body' => $soap,
                'timeout' => 60
            ]);
            if (!is_wp_error($resp) && !empty($resp['body'])) {
                $sx = @simplexml_load_string($resp['body']);
                if ($sx) {
                    $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                    $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    $nodes = $sx->xpath('//soap:Body//sh:getFeaturesResult//sh:features//sh:feature | //soap:Body//*[local-name()="features"]/*[local-name()="feature"]');
                    if ($nodes) {
                        $found = max($found, count($nodes));
                        foreach ($nodes as $n) {
                            if ($n instanceof SimpleXMLElement) {
                                $n->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                            }
                            $idNode = $n->xpath('.//sh:id | .//id | .//@id');
                            $nameNode = $n->xpath('.//sh:name | .//name | .');
                            $id = intval((string) ($idNode[0] ?? ''));
                            $name = trim((string) ($nameNode[0] ?? ''));
                            if ($id > 0 && $name !== '') {
                                $nameCol = $col_exists('ghwk_features', 'name') ? 'name' : ($col_exists('ghwk_features', 'nameIndex') ? 'nameIndex' : 'name');
                                $sql = "REPLACE INTO ghwk_features (id,`$nameCol`,updated_at) VALUES (%d,%s,NOW())";
                                $ok = $wpdb->query($wpdb->prepare($sql, $id, $name));
                                if ($ok !== false) {
                                    $updated++;
                                } else if (!$err && $wpdb->last_error) {
                                    $err = $wpdb->last_error;
                                }
                            }
                        }
                    }
                }
            }
        }
        delete_transient('st_filters_features');
        $redir = remove_query_arg('st_refresh_features');
        if ($err) {
            $redir = add_query_arg('st_msg', rawurlencode("Features updated: {$updated} (found: {$found}) ‚Äì DB error: {$err}"), $redir);
        } else {
            $redir = add_query_arg('st_msg', rawurlencode("Features updated: {$updated} (found: {$found})"), $redir);
        }
        wp_safe_redirect($redir);
        exit;
    }

    if (isset($_GET['st_refresh_meals']) && $_GET['st_refresh_meals'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_meals');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }
        $updated = 0;
        $found = 0;
        $err = '';
        // Use Static API GetMeals (SOAP)
        $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
        $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';
        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<GetMeals xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</GetMeals>'
            . '</soap:Body>'
            . '</soap:Envelope>';
        $resp = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetMeals"'],
            'body' => $soap,
            'timeout' => 60,
        ]);
        if (!is_wp_error($resp) && !empty($resp['body'])) {
            $xml = @simplexml_load_string($resp['body']);
            if ($xml) {
                $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                $nodes = $xml->xpath('//soap:Body//sh:getMealsResult//sh:meals//sh:meal | //soap:Body//*[local-name()="meals"]/*[local-name()="meal"]');
                if ($nodes) {
                    $found = count($nodes);
                    foreach ($nodes as $m) {
                        if ($m instanceof SimpleXMLElement) {
                            $m->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                        }
                        $idNode = $m->xpath('.//sh:id | .//id | .//@id');
                        $nameNode = $m->xpath('.//sh:name | .//name | .');
                        $id = intval((string) ($idNode[0] ?? ''));
                        $name = trim((string) ($nameNode[0] ?? ''));
                        if ($id > 0 && $name !== '') {
                            $nameCol = $col_exists('ghwk_meals', 'name') ? 'name' : ($col_exists('ghwk_meals', 'nameIndex') ? 'nameIndex' : 'name');
                            $sql = "REPLACE INTO ghwk_meals (id,`$nameCol`,updated_at) VALUES (%d,%s,NOW())";
                            $ok = $wpdb->query($wpdb->prepare($sql, $id, $name));
                            if ($ok !== false) {
                                $updated++;
                            } else if (!$err && $wpdb->last_error) {
                                $err = $wpdb->last_error;
                            }
                        }
                    }
                }
            }
        }
        delete_transient('st_filters_meals');
        $redir = remove_query_arg('st_refresh_meals');
        if ($err) {
            $redir = add_query_arg('st_msg', rawurlencode("Meals updated: {$updated} (found: {$found}) ‚Äì DB error: {$err}"), $redir);
        } else {
            $redir = add_query_arg('st_msg', rawurlencode("Meals updated: {$updated} (found: {$found})"), $redir);
        }
        wp_safe_redirect($redir);
        exit;
    }
    if (isset($_GET['st_refresh_themes']) && $_GET['st_refresh_themes'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_themes');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }
        $updated = 0;
        $found = 0;
        $err = '';
        // Prefer Static SOAP for themes (image available)
        $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : ['username' => '', 'password' => '', 'language' => 'en'];
        $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';
        $soap = '<?xml version="1.0" encoding="utf-8"?>'
            . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
            . '<soap:Body>'
            . '<GetThemes xmlns="http://xml.sunhotels.net/15/">'
            . '<userName>' . esc_html($creds['username']) . '</userName>'
            . '<password>' . esc_html($creds['password']) . '</password>'
            . '<language>' . esc_html($creds['language']) . '</language>'
            . '</GetThemes>'
            . '</soap:Body>'
            . '</soap:Envelope>';
        $resp = wp_remote_post($endpoint, [
            'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetThemes"'],
            'body' => $soap,
            'timeout' => 60
        ]);
        if (!is_wp_error($resp) && !empty($resp['body'])) {
            $xml = @simplexml_load_string($resp['body']);
            if ($xml) {
                $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                $nodes = $xml->xpath('//soap:Body//sh:getThemesResult//sh:themes//sh:theme | //soap:Body//*[local-name()="themes"]/*[local-name()="theme"]');
                if ($nodes) {
                    $found = count($nodes);
                    foreach ($nodes as $n) {
                        if ($n instanceof SimpleXMLElement) {
                            $n->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                        }
                        $idNode = $n->xpath('.//sh:id | .//id | .//@id');
                        $nameNode = $n->xpath('.//sh:name | .//name | .');
                        $imgNode = $n->xpath('.//sh:image | .//image | .//@image');
                        $id = intval((string) ($idNode[0] ?? ''));
                        $name = trim((string) ($nameNode[0] ?? ''));
                        $img = trim((string) ($imgNode[0] ?? ''));
                        if ($id > 0 && $name !== '') {
                            $nameCol = $col_exists('ghwk_themes', 'name') ? 'name' : ($col_exists('ghwk_themes', 'nameIndex') ? 'nameIndex' : 'name');
                            $imgCol = $col_exists('ghwk_themes', 'image') ? 'image' : ($col_exists('ghwk_themes', 'image_url') ? 'image_url' : 'image');
                            $sql = "REPLACE INTO ghwk_themes (id,`$nameCol`,`$imgCol`,updated_at) VALUES (%d,%s,%s,NOW())";
                            $ok = $wpdb->query($wpdb->prepare($sql, $id, $name, $img));
                            if ($ok !== false) {
                                $updated++;
                            } else if (!$err && $wpdb->last_error) {
                                $err = $wpdb->last_error;
                            }
                        }
                    }
                }
            }
        }
        delete_transient('st_filters_themes');
        $redir = remove_query_arg('st_refresh_themes');
        if ($err) {
            $redir = add_query_arg('st_msg', rawurlencode("Themes updated: {$updated} (found: {$found}) ‚Äì DB error: {$err}"), $redir);
        } else {
            $redir = add_query_arg('st_msg', rawurlencode("Themes updated: {$updated} (found: {$found})"), $redir);
        }
        wp_safe_redirect($redir);
        exit;
    }

    if (isset($_GET['st_refresh_room_notes']) && $_GET['st_refresh_room_notes'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_room_notes');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }
        $updated = 0;
        $found = 0;
        $err = '';

        // Create table if not exists
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_note_types (
            id INT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

        $xml = shorttrips_call_nonstatic_xml('GetRoomNoteTypes');
        if ($xml) {
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            $nodes = $xml->xpath('//sh:noteTypes//sh:noteType | //sh:roomNoteTypes//sh:roomNoteType | //*[(local-name()="noteTypes" or local-name()="roomNoteTypes")]/*');
            if ($nodes) {
                $found = count($nodes);
                foreach ($nodes as $n) {
                    if ($n instanceof SimpleXMLElement) {
                        $n->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    }
                    $idNode = $n->xpath('.//sh:id | .//id | .//@id');
                    $nameNode = $n->xpath('.//sh:name | .//name | .//sh:description | .//description | .');
                    $id = intval((string) ($idNode[0] ?? ''));
                    $name = trim((string) ($nameNode[0] ?? ''));

                    if ($id <= 0 && $name !== '') {
                        $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                    }

                    if ($id > 0 && $name !== '') {
                        $nameCol = $col_exists('ghwk_room_note_types', 'name') ? 'name' : ($col_exists('ghwk_room_note_types', 'nameIndex') ? 'nameIndex' : 'name');
                        $sql = "REPLACE INTO ghwk_room_note_types (id,`$nameCol`,updated_at) VALUES (%d,%s,NOW())";
                        $ok = $wpdb->query($wpdb->prepare($sql, $id, $name));
                        if ($ok !== false) {
                            $updated++;
                        } else {
                            if (!$err && $wpdb->last_error) {
                                $err = $wpdb->last_error;
                            }
                        }
                    } else {
                    }
                }
            } else {
            }
        } else {
        }

        $redir = remove_query_arg('st_refresh_room_notes');
        if ($err) {
            $redir = add_query_arg('st_msg', rawurlencode("Room note types updated: {$updated} (found: {$found}) ‚Äì DB error: {$err}"), $redir);
        } else {
            $redir = add_query_arg('st_msg', rawurlencode("Room note types updated: {$updated} (found: {$found})"), $redir);
        }
        wp_safe_redirect($redir);
        exit;
    }

    if (isset($_GET['st_refresh_hotel_notes']) && $_GET['st_refresh_hotel_notes'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_hotel_notes');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }
        $updated = 0;
        $found = 0;
        $err = '';

        // Create table if not exists
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_note_types (
            id INT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

        $xml = shorttrips_call_nonstatic_xml('GetHotelNoteTypes');
        if ($xml) {
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            $nodes = $xml->xpath('//sh:hotelNoteTypes//sh:hotelNoteType | //sh:noteTypes//sh:noteType | //*[(local-name()="hotelNoteTypes" or local-name()="noteTypes")]/*');
            if ($nodes) {
                $found = count($nodes);
                foreach ($nodes as $n) {
                    if ($n instanceof SimpleXMLElement) {
                        $n->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    }
                    $idNode = $n->xpath('.//sh:id | .//id | .//@id');
                    $nameNode = $n->xpath('.//sh:name | .//name | .//sh:description | .//description | .');
                    $id = intval((string) ($idNode[0] ?? ''));
                    $name = trim((string) ($nameNode[0] ?? ''));

                    if ($id <= 0 && $name !== '') {
                        $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                    }

                    if ($id > 0 && $name !== '') {
                        $nameCol = $col_exists('ghwk_hotel_note_types', 'name') ? 'name' : ($col_exists('ghwk_hotel_note_types', 'nameIndex') ? 'nameIndex' : 'name');
                        $sql = "REPLACE INTO ghwk_hotel_note_types (id,`$nameCol`,updated_at) VALUES (%d,%s,NOW())";
                        $ok = $wpdb->query($wpdb->prepare($sql, $id, $name));
                        if ($ok !== false) {
                            $updated++;
                        } else {
                            if (!$err && $wpdb->last_error) {
                                $err = $wpdb->last_error;
                            }
                        }
                    } else {
                    }
                }
            } else {
            }
        } else {
        }

        $redir = remove_query_arg('st_refresh_hotel_notes');
        if ($err) {
            $redir = add_query_arg('st_msg', rawurlencode("Hotel note types updated: {$updated} (found: {$found}) ‚Äì DB error: {$err}"), $redir);
        } else {
            $redir = add_query_arg('st_msg', rawurlencode("Hotel note types updated: {$updated} (found: {$found})"), $redir);
        }
        wp_safe_redirect($redir);
        exit;
    }

    if (isset($_GET['st_refresh_languages']) && $_GET['st_refresh_languages'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_languages');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }
        $updated = 0;
        $found = 0;
        $err = '';
        $xml = shorttrips_call_nonstatic_xml('GetLanguages');
        if ($xml) {
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            $nodes = $xml->xpath('//sh:languages//sh:language | //languages//language | //sh:language | //language | //*[(local-name()="languages")]/*');
            if ($nodes) {
                $found = count($nodes);
                foreach ($nodes as $n) {
                    if ($n instanceof SimpleXMLElement) {
                        $n->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    }
                    $idNode = $n->xpath('.//sh:id | .//id | .//@id');
                    $nameNode = $n->xpath('.//sh:name | .//name | .');
                    $id = intval((string) ($idNode[0] ?? ''));
                    $name = trim((string) ($nameNode[0] ?? ''));
                    if ($id <= 0 && $name !== '') {
                        $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                    }
                    if ($id > 0 && $name !== '') {
                        $nameCol = $col_exists('ghwk_languages', 'name') ? 'name' : ($col_exists('ghwk_languages', 'nameIndex') ? 'nameIndex' : 'name');
                        $sql = "REPLACE INTO ghwk_languages (id,`$nameCol`,updated_at) VALUES (%d,%s,NOW())";
                        $ok = $wpdb->query($wpdb->prepare($sql, $id, $name));
                        if ($ok !== false) {
                            $updated++;
                        } else if (!$err && $wpdb->last_error) {
                            $err = $wpdb->last_error;
                        }
                    }
                }
            }
        }
        $redir = remove_query_arg('st_refresh_languages');
        if ($err) {
            $redir = add_query_arg('st_msg', rawurlencode("Languages updated: {$updated} (found: {$found}) ‚Äì DB error: {$err}"), $redir);
        } else {
            $redir = add_query_arg('st_msg', rawurlencode("Languages updated: {$updated} (found: {$found})"), $redir);
        }
        wp_safe_redirect($redir);
        exit;
    }

    if (isset($_GET['st_refresh_meals']) && $_GET['st_refresh_meals'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_meals');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }
        $updated = 0;
        $found = 0;
        $err = '';

        // Create table if not exists
        $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_meals (
            id INT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )");

        $xml = shorttrips_call_nonstatic_xml('GetMeals');
        if ($xml) {
            $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
            // Try multiple XPath patterns to find meal nodes
            $nodes = $xml->xpath('//sh:meals//sh:meal | //meals//meal | //sh:meal | //meal | //*[(local-name()="meals")]/*');
            if ($nodes) {
                $found = count($nodes);
                foreach ($nodes as $n) {
                    if ($n instanceof SimpleXMLElement) {
                        $n->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
                    }
                    $idNode = $n->xpath('.//sh:id | .//id | .//@id | .//sh:mealId | .//mealId');
                    $nameNode = $n->xpath('.//sh:name | .//name | .//sh:description | .//description | .');
                    $descNode = $n->xpath('.//sh:description | .//description');

                    $id = intval((string) ($idNode[0] ?? ''));
                    $name = trim((string) ($nameNode[0] ?? ''));
                    $desc = trim((string) ($descNode[0] ?? ''));

                    // Generate ID from name if missing
                    if ($id <= 0 && $name !== '') {
                        $id = (int) sprintf('%u', crc32(mb_strtolower($name, 'UTF-8')));
                    }

                    if ($id > 0 && $name !== '') {
                        $nameCol = $col_exists('ghwk_meals', 'name') ? 'name' : ($col_exists('ghwk_meals', 'nameIndex') ? 'nameIndex' : 'name');
                        $sql = "REPLACE INTO ghwk_meals (id,`$nameCol`,description,updated_at) VALUES (%d,%s,%s,NOW())";
                        $ok = $wpdb->query($wpdb->prepare($sql, $id, $name, $desc));
                        if ($ok !== false) {
                            $updated++;
                        } else {
                            if (!$err && $wpdb->last_error) {
                                $err = $wpdb->last_error;
                            }
                        }
                    } else {
                    }
                }
            } else {
            }
        } else {
        }

        $redir = remove_query_arg('st_refresh_meals');
        if ($err) {
            $redir = add_query_arg('st_msg', rawurlencode("Meals updated: {$updated} (found: {$found}) ‚Äì DB error: {$err}"), $redir);
        } else {
            $redir = add_query_arg('st_msg', rawurlencode("Meals updated: {$updated} (found: {$found})"), $redir);
        }
        wp_safe_redirect($redir);
        exit;
    }

    if (isset($_GET['st_refresh_room_images']) && $_GET['st_refresh_room_images'] === '1') {
        if ($credsMissing) {
            $r = remove_query_arg('st_refresh_room_images');
            wp_safe_redirect(add_query_arg('st_msg', rawurlencode('Missing Sunhotels credentials; define shorttrips_get_api_credentials()'), $r));
            exit;
        }

        // Redirect to sync endpoint with nonce in AUTO mode (very small batch size)
        $nonce = wp_create_nonce('shorttrips_sync');
        $sync_url = home_url('/?sync_room_images=1&_wpnonce=' . $nonce . '&batch_size=10&auto=1');
        wp_redirect($sync_url);
        exit;
    }

    // Deduplicate hotels and add unique index on hotel_id
    if (isset($_GET['st_dedupe_hotels']) && $_GET['st_dedupe_hotels'] === '1') {
        $table = 'ghwk_bravo_hotels';
        $cols = $wpdb->get_col("SHOW COLUMNS FROM {$table}");
        $hasId = in_array('id', $cols, true);
        $hasUpdated = in_array('updated_at', $cols, true);
        // Try to delete duplicates keeping the newest/last id
        if ($hasId) {
            $wpdb->query("DELETE h FROM {$table} h INNER JOIN {$table} h2 ON h.hotel_id=h2.hotel_id AND h.id<h2.id");
        } elseif ($hasUpdated) {
            $wpdb->query("DELETE h FROM {$table} h INNER JOIN (SELECT hotel_id, MAX(updated_at) mu FROM {$table} GROUP BY hotel_id) x ON h.hotel_id=x.hotel_id AND h.updated_at<x.mu");
        }
        // Try to add unique index (ignore if exists)
        $hasUnique = (bool) $wpdb->get_var("SELECT COUNT(1) FROM INFORMATION_SCHEMA.STATISTICS WHERE TABLE_SCHEMA=DATABASE() AND TABLE_NAME='{$table}' AND INDEX_NAME='uq_hotel_id'");
        if (!$hasUnique) {
            @$wpdb->query("ALTER TABLE {$table} ADD UNIQUE KEY uq_hotel_id (hotel_id)");
        }
        wp_safe_redirect(remove_query_arg('st_dedupe_hotels'));
        exit;
    }
});

// -----------------------------------------------------------------------------
// ADMIN TEST PAGE
// -----------------------------------------------------------------------------
add_action('admin_menu', function () {
    add_management_page(
        'Shorttrips Test',
        'Shorttrips Test',
        'manage_options',
        'shorttrips-test',
        function () {           // Callback function
            if (!current_user_can('manage_options')) {
                wp_die('Unauthorized');
            }
            $lookup_nonce = wp_create_nonce('shorttrips_sync');
            $lookup_front = home_url('/');

            echo '<div class="wrap">';
            echo '<h1>Shorttrips API Test</h1>';
            echo '<p>Test de Sunhotels API verbinding en database sync functies.</p>';

            // Show any messages
            if (isset($_GET['st_msg'])) {
                echo '<div class="notice notice-info"><p>' . esc_html(urldecode($_GET['st_msg'])) . '</p></div>';
            }

            // Handle settings save
            if (isset($_POST['save_settings']) && check_admin_referer('shorttrips_settings')) {
                $autoPriceLoad = isset($_POST['auto_price_load']) ? 'enabled' : 'disabled';
                update_option('shorttrips_auto_price_load', $autoPriceLoad);
                echo '<div class="notice notice-success"><p>‚úÖ Instellingen opgeslagen!</p></div>';
            }

            // Settings section
            echo '<h2>‚öôÔ∏è Instellingen</h2>';
            echo '<form method="post" style="background:#f9fafb;border:1px solid #e5e7eb;padding:20px;border-radius:8px;margin-bottom:30px">';
            wp_nonce_field('shorttrips_settings');

            $currentPriceLoad = get_option('shorttrips_auto_price_load', 'enabled');
            $priceLoadChecked = ($currentPriceLoad === 'enabled') ? 'checked' : '';

            echo '<h3 style="margin-top:0">Hotel Cards Prijzen</h3>';
            echo '<label style="display:flex;align-items:center;gap:8px;cursor:pointer">';
            echo '<input type="checkbox" name="auto_price_load" value="1" ' . $priceLoadChecked . '>';
            echo '<span>Automatisch prijzen laden in hotel cards (via NonStatic API)</span>';
            echo '</label>';
            echo '<p style="color:#6b7280;font-size:13px;margin:8px 0 0 26px">Als dit uitstaat, tonen hotel cards "Toon prijzen" zonder AJAX call.<br>Dit is sneller maar toont geen prijzen in de resultatenlijst.</p>';
            echo '<div style="margin-top:15px">';
            echo '<button type="submit" name="save_settings" class="button button-primary">Instellingen opslaan</button>';
            echo '</div>';
            echo '</form>';

            echo '<h2>Quick Actions</h2>';
            echo '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;margin-bottom:30px">';

            // Test API button
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üß™ API Test</h3>';
            echo '<p style="margin-bottom:10px">Test de Sunhotels API verbinding</p>';
            echo '<form method="get" action="">';
            echo '<input type="hidden" name="page" value="shorttrips-test">';
            echo '<input type="hidden" name="run_test" value="1">';
            echo '<button type="submit" class="button button-primary">Run API Test</button>';
            echo '</form>';
            echo '</div>';

            // Sync Room Types
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üè† Sync Room Types</h3>';
            echo '<p style="margin-bottom:10px">Sync room types van Sunhotels API</p>';
            echo '<a href="' . home_url('/?sync_room_types=1') . '" class="button button-secondary" target="_blank">Sync Room Types</a><br><br>';
            echo '<a href="' . home_url('/?cleanup_room_types=1') . '" class="button button-secondary" target="_blank" style="background:#dc2626;border-color:#dc2626;color:#fff">üóëÔ∏è Cleanup Corrupt Data</a>';
            echo ' <a href="' . home_url('/?force_cleanup_room_types=1') . '" class="button button-primary" target="_blank" style="background:#b91c1c;border-color:#b91c1c;color:#fff" onclick="return confirm(\'‚ö†Ô∏è FORCE CLEANUP will remove 100K+ corrupt records!\\n\\nCurrent: 129,465 records\\nAfter: ~2,500 clean records\\n\\nThis is the NUCLEAR OPTION.\\n\\nContinue?\')">üî• FORCE CLEANUP (Nuclear)</a>';
            echo '<p style="margin-top:8px;font-size:12px;color:#dc2626"><strong>‚ö†Ô∏è Use FORCE CLEANUP if you have 100K+ records!</strong></p>';
            echo '</div>';

            // Clean Room Types
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üßπ Clean Room Types</h3>';
            echo '<p style="margin-bottom:10px">Verwijder corrupte room type records</p>';
            echo '<a href="' . home_url('/?clean_room_types=1') . '" class="button button-secondary" target="_blank">Clean Database</a>';
            echo '</div>';

            // Debug Room Names
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üîç Debug Room Names</h3>';
            echo '<p style="margin-bottom:10px">Bekijk sample room names</p>';
            echo '<a href="' . home_url('/?debug_room_names=1') . '" class="button button-secondary" target="_blank">Debug Names</a>';
            echo '</div>';

            // Quick Sync
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">‚ö° Quick Sync</h3>';
            echo '<p style="margin-bottom:10px">Snelle sync van essenti√´le tabellen</p>';
            echo '<a href="' . home_url('/?sync_quick=1') . '" class="button button-secondary" target="_blank">Quick Sync</a>';
            echo '</div>';

            // Sync Empty Tables
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üîÑ Sync Empty Tables</h3>';
            echo '<p style="margin-bottom:10px">Sync alleen lege lookup tabellen</p>';
            echo '<a href="' . home_url('/?sync_empty_tables=1') . '" class="button button-secondary" target="_blank">Sync Empty</a>';
            echo '</div>';

            // Complete Sync
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üöÄ Complete Sync</h3>';
            echo '<p style="margin-bottom:10px">Volledige sync van alle tabellen</p>';
            echo '<a href="' . home_url('/?sync_all_tables=1') . '" class="button button-secondary" target="_blank">Complete Sync</a>';
            echo '</div>';

            // Check Database
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üìä Check Database</h3>';
            echo '<p style="margin-bottom:10px">Bekijk database status</p>';
            echo '<a href="' . home_url('/?check_room_types=1') . '" class="button button-secondary" target="_blank">Check Status</a>';
            echo '</div>';

            echo '</div>';

            // Lookup Tables section
            echo '<h2 style="margin-top:30px">Lookup Tables Sync</h2>';
            echo '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px;margin-bottom:30px">';

            // Sync Meals
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üçΩÔ∏è Sync Meals</h3>';
            echo '<p style="margin-bottom:10px">Sync meal types van Sunhotels API</p>';
            $lk_meals = add_query_arg([
                'sync_lookups' => 1,
                'only' => 'meals',
                'format' => 'json',
                '_wpnonce' => $lookup_nonce,
            ], $lookup_front);
            echo '<a href="' . esc_url($lk_meals) . '" target="_blank" class="button button-secondary">Sync Meals (lookup runner)</a>';
            echo '</div>';

            // Sync Room Note Types
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üìù Sync Room Notes</h3>';
            echo '<p style="margin-bottom:10px">Sync room note types van Sunhotels API</p>';
            $lk_roomnotes = add_query_arg([
                'sync_lookups' => 1,
                'only' => 'room_note_types',
                'format' => 'json',
                '_wpnonce' => $lookup_nonce,
            ], $lookup_front);
            echo '<a href="' . esc_url($lk_roomnotes) . '" target="_blank" class="button button-secondary">Sync Room Notes (lookup runner)</a>';
            echo '</div>';

            // Sync Hotel Note Types
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üè® Sync Hotel Notes</h3>';
            echo '<p style="margin-bottom:10px">Sync hotel note types van Sunhotels API</p>';
            $lk_hotelnote = add_query_arg([
                'sync_lookups' => 1,
                'only' => 'hotel_note_types',
                'format' => 'json',
                '_wpnonce' => $lookup_nonce,
            ], $lookup_front);
            echo '<a href="' . esc_url($lk_hotelnote) . '" target="_blank" class="button button-secondary">Sync Hotel Notes (lookup runner)</a>';
            echo '</div>';

            // Sync Features
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">‚≠ê Sync Features</h3>';
            echo '<p style="margin-bottom:10px">Sync features van Sunhotels API</p>';
            $lk_features = add_query_arg([
                'sync_lookups' => 1,
                'only' => 'features',
                'format' => 'json',
                '_wpnonce' => $lookup_nonce,
            ], $lookup_front);
            echo '<a href="' . esc_url($lk_features) . '" target="_blank" class="button button-secondary">Sync Features (lookup runner)</a>';
            echo '</div>';

            // Sync Themes
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üé® Sync Themes</h3>';
            echo '<p style="margin-bottom:10px">Sync themes van Sunhotels API</p>';
            $lk_themes = add_query_arg([
                'sync_lookups' => 1,
                'only' => 'themes',
                'format' => 'json',
                '_wpnonce' => $lookup_nonce,
            ], $lookup_front);
            echo '<a href="' . esc_url($lk_themes) . '" target="_blank" class="button button-secondary">Sync Themes (lookup runner)</a>';
            echo '</div>';

            // Sync Destinations (nog via legacy route, geen onderdeel van sync_lookups)
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üåç Sync Destinations</h3>';
            echo '<p style="margin-bottom:10px">Sync destinations van Sunhotels API</p>';
            echo '<form method="get" action="' . admin_url('tools.php') . '">';
            echo '<input type="hidden" name="page" value="shorttrips-test">';
            echo '<input type="hidden" name="st_refresh_destinations" value="1">';
            echo '<button type="submit" class="button button-secondary">Sync Destinations</button>';
            echo '</form>';
            echo '</div>';

            // Sync Room Images
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px">';
            echo '<h3 style="margin-top:0">üñºÔ∏è Sync Room Images (Auto-Continue)</h3>';
            echo '<p style="margin-bottom:10px"><strong>RoomTypeStaticData ZIP sync</strong> - Downloads complete room image database (1.9GB), streams parse with resume capability. <strong>Auto-continues until complete!</strong></p>';
            echo '<form method="get" action="' . admin_url('tools.php') . '">';
            echo '<input type="hidden" name="page" value="shorttrips-test">';
            echo '<input type="hidden" name="st_refresh_room_images" value="1">';
            echo '<button type="submit" class="button button-primary" style="background:#d63638;border-color:#d63638">üöÄ Start Auto-Sync (runs until complete)</button>';
            echo '</form>';
            echo '<p style="margin-top:10px;font-size:12px;color:#666">';
            echo 'üí° Batch size: 10 hotels per batch (~300 room types)<br>';
            echo 'üí° Auto-continues every 2 seconds until complete<br>';
            echo 'üí° Resume capable: Can stop/restart anytime<br>';
            echo 'üí° Includes room type name lookup for fast filtering<br>';
            echo '‚ö†Ô∏è  Note: XML scan from start each batch (~30-60s overhead)<br>';
            echo 'üí° Manual mode: <a href="' . home_url('/?sync_room_images=1&skip_nonce=1') . '" target="_blank">/?sync_room_images=1&skip_nonce=1</a>';
            echo '</p>';
            echo '</div>';

            echo '</div>';

            // Debug Logging Status
            echo '<div style="border:1px solid #ccc;padding:15px;border-radius:4px;margin-bottom:15px">';
            echo '<h3 style="margin-top:0">üêõ Debug Logging</h3>';
            $debug_status = shorttrips_enable_debug_logging();
            echo '<pre style="background:#f5f5f5;padding:10px;border-radius:4px;font-size:12px;line-height:1.6">' . esc_html($debug_status) . '</pre>';
            if (file_exists(WP_CONTENT_DIR . '/debug.log')) {
                $log_size = filesize(WP_CONTENT_DIR . '/debug.log');
                echo '<p style="margin:10px 0 5px 0"><strong>Recent Log Entries:</strong></p>';
                $log_content = file_get_contents(WP_CONTENT_DIR . '/debug.log');
                $log_lines = explode("\n", $log_content);
                $recent_lines = array_slice($log_lines, -20);
                echo '<pre style="background:#1e1e1e;color:#d4d4d4;padding:10px;border-radius:4px;font-size:11px;max-height:300px;overflow-y:auto">' . esc_html(implode("\n", $recent_lines)) . '</pre>';
                echo '<p><a href="' . content_url('debug.log') . '" target="_blank" class="button button-secondary">üìÑ View Full Debug Log</a></p>';
            }
            echo '</div>';

            // Run test if requested
            if (isset($_GET['run_test'])) {
                echo '<h2>Test Results</h2>';
                echo '<pre style="background:#f5f5f5;padding:15px;border:1px solid #ddd;border-radius:4px;overflow-x:auto">';
                ob_start();
                shorttrips_test_api_calls();
                $output = ob_get_clean();
                echo esc_html($output);
                echo '</pre>';
            }

            echo '</div>';
        }
    );
});

// === WORDPRESS DEBUG LOGGING HELPER ===
function shorttrips_enable_debug_logging()
{
    $wp_config_path = ABSPATH . 'wp-config.php';

    if (!file_exists($wp_config_path)) {
        return "‚ùå wp-config.php not found at: $wp_config_path";
    }

    if (!is_writable($wp_config_path)) {
        return "‚ùå wp-config.php is not writable. Please add these lines manually:\n\n" .
            "define('WP_DEBUG', true);\n" .
            "define('WP_DEBUG_LOG', true);\n" .
            "define('WP_DEBUG_DISPLAY', false);\n\n" .
            "Debug log will be created at: " . WP_CONTENT_DIR . "/debug.log";
    }

    $config_content = file_get_contents($wp_config_path);

    // Check if debug constants are already defined
    $has_debug = strpos($config_content, "define('WP_DEBUG'") !== false || strpos($config_content, 'define("WP_DEBUG"') !== false;
    $has_debug_log = strpos($config_content, "define('WP_DEBUG_LOG'") !== false || strpos($config_content, 'define("WP_DEBUG_LOG"') !== false;

    if ($has_debug && $has_debug_log) {
        return "‚úÖ Debug logging is already configured in wp-config.php\n" .
            "üìù Debug log location: " . WP_CONTENT_DIR . "/debug.log\n" .
            "üîç Current WP_DEBUG: " . (WP_DEBUG ? 'true' : 'false') . "\n" .
            "üîç Current WP_DEBUG_LOG: " . (defined('WP_DEBUG_LOG') && WP_DEBUG_LOG ? 'true' : 'false');
    }

    return "‚ö†Ô∏è Please add debug constants to wp-config.php manually:\n\n" .
        "define('WP_DEBUG', true);\n" .
        "define('WP_DEBUG_LOG', true);\n" .
        "define('WP_DEBUG_DISPLAY', false);\n\n" .
        "Add these lines before /* That's all, stop editing! */";
}

// === DEBUG FUNCTIE VOOR API CALLS ===
function shorttrips_test_api_calls()
{
    echo "=== TESTING SUNHOTELS API CALLS ===\n\n";

    // Check debug logging status
    echo "üêõ Debug Logging Status:\n";
    echo "   WP_DEBUG: " . (defined('WP_DEBUG') && WP_DEBUG ? '‚úÖ Enabled' : '‚ùå Disabled') . "\n";
    echo "   WP_DEBUG_LOG: " . (defined('WP_DEBUG_LOG') && WP_DEBUG_LOG ? '‚úÖ Enabled' : '‚ùå Disabled') . "\n";
    echo "   Log file: " . WP_CONTENT_DIR . "/debug.log\n";
    if (file_exists(WP_CONTENT_DIR . "/debug.log")) {
        $size = filesize(WP_CONTENT_DIR . "/debug.log");
        echo "   Log file size: " . number_format($size / 1024, 2) . " KB\n";
    } else {
        echo "   Log file: Not created yet\n";
    }
    echo "\n";

    // Check if credentials function exists
    if (!function_exists('shorttrips_get_api_credentials')) {
        echo "‚ùå ERROR: shorttrips_get_api_credentials() function not found!\n";
        echo "   This function should be defined in your theme or plugin.\n";
        return;
    }

    $creds = shorttrips_get_api_credentials();
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

    echo "üîë Credentials function found: ‚úÖ\n";
    echo "üîë Username: " . (empty($creds['username']) ? '‚ùå EMPTY' : '‚úÖ ' . $creds['username']) . "\n";
    echo "üîë Password: " . (empty($creds['password']) ? '‚ùå EMPTY' : '‚úÖ [HIDDEN]') . "\n";
    echo "üîë Language: " . $creds['language'] . "\n";
    echo "üåê Endpoint: " . $endpoint . "\n\n";

    if (empty($creds['username']) || empty($creds['password'])) {
        echo "‚ùå CRITICAL: Username or password is empty!\n";
        echo "   Please check your credentials configuration.\n";
        return;
    }

    // Test simple database write first
    echo "üóÑÔ∏è Testing database write...\n";
    global $wpdb;
    $testResult = $wpdb->query("CREATE TABLE IF NOT EXISTS test_shorttrips_sync (id INT PRIMARY KEY, test_value VARCHAR(100))");
    if ($testResult === false) {
        echo "‚ùå Database write failed: " . $wpdb->last_error . "\n";
    } else {
        echo "‚úÖ Database write successful\n";
        $wpdb->query("DROP TABLE IF EXISTS test_shorttrips_sync");
    }

    // Test GetRoomTypes
    echo "\nüìã Testing GetRoomTypes API call...\n";
    $soap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<GetRoomTypes xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>' . esc_html($creds['username']) . '</userName>'
        . '<password>' . esc_html($creds['password']) . '</password>'
        . '<language>' . esc_html($creds['language']) . '</language>'
        . '</GetRoomTypes>'
        . '</soap:Body>'
        . '</soap:Envelope>';

    echo "üì§ Sending SOAP request...\n";
    $r = wp_remote_post($endpoint, [
        'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetRoomTypes"'],
        'body' => $soap,
        'timeout' => 60
    ]);

    if (is_wp_error($r)) {
        echo "‚ùå WP Error: " . $r->get_error_message() . "\n";
    } elseif (empty($r['body'])) {
        echo "‚ùå Empty response body\n";
    } else {
        echo "‚úÖ Response received (" . strlen($r['body']) . " chars)\n";

        // Check for SOAP fault
        if (stripos($r['body'], 'soap:fault') !== false || stripos($r['body'], 'faultstring') !== false) {
            echo "‚ùå SOAP Fault detected in response!\n";
            echo "üìÑ Response: " . substr($r['body'], 0, 1000) . "\n";
            return;
        }

        echo "üìÑ First 500 chars: " . substr($r['body'], 0, 500) . "...\n\n";

        // Parse with LIBXML_PARSEHUGE for large XML responses (27MB+)
        libxml_use_internal_errors(true);
        $sx = @simplexml_load_string($r['body'], 'SimpleXMLElement', LIBXML_PARSEHUGE | LIBXML_BIGLINES);
        if (!$sx) {
            echo "‚ùå Failed to parse XML response\n";
            $errors = libxml_get_errors();
            if ($errors) {
                echo "üìÑ XML Errors:\n";
                foreach ($errors as $error) {
                    echo "   - Line {$error->line}: {$error->message}\n";
                }
                libxml_clear_errors();
            }
            echo "üìÑ Raw response (first 2000 chars): " . substr($r['body'], 0, 2000) . "\n";
        } else {
            echo "‚úÖ XML parsed successfully\n";

            // Try different XPath patterns
            $patterns = [
                '//roomType',
                '//sh:roomType',
                '//*[local-name()="roomType"]',
                '//getRoomTypesResult',
                '//*[local-name()="getRoomTypesResult"]'
            ];

            $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
            $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

            foreach ($patterns as $pattern) {
                $nodes = $sx->xpath($pattern);
                echo "üîç Pattern '$pattern': " . count($nodes) . " nodes\n";
                if ($nodes && count($nodes) > 0) {
                    echo "   ‚úÖ Found data with this pattern!\n";
                    break;
                }
            }

            // Show full XML structure for debugging
            echo "\nüìã Full XML structure (first 1000 chars):\n";
            echo substr($sx->asXML(), 0, 1000) . "...\n";
        }
    }

    echo "\n=== END TEST ===\n";
}

// === DEBUG FUNCTIE VOOR ROOM NAMES ===
function shorttrips_debug_room_names($hotelId = null)
{
    if (!$hotelId) {
        echo "Gebruik: shorttrips_debug_room_names(123) waar 123 het hotel ID is\n";
        return;
    }

    global $wpdb;

    echo "=== DEBUG ROOM NAMES VOOR HOTEL $hotelId ===\n\n";

    // Check database tables
    $tables = ['ghwk_hotels', 'ghwk_hotel_room_types', 'ghwk_room_types', 'ghwk_rooms'];
    foreach ($tables as $table) {
        $exists = $wpdb->get_var("SHOW TABLES LIKE '$table'");
        if ($exists) {
            echo "‚úÖ Tabel $table bestaat\n";
            $columns = $wpdb->get_results("SHOW COLUMNS FROM $table", ARRAY_A);
            echo "   Kolommen: " . implode(', ', array_column($columns, 'Field')) . "\n";

            $count = $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM $table WHERE hotel_id = %d OR id = %d", $hotelId, $hotelId));
            echo "   Records voor hotel $hotelId: $count\n\n";
        } else {
            echo "‚ùå Tabel $table bestaat niet\n";
        }
    }

    // Check recent error logs
    echo "=== RECENTE ERROR LOGS ===\n";
    if (defined('WP_DEBUG_LOG') && WP_DEBUG_LOG) {
        $logFile = WP_CONTENT_DIR . '/debug.log';
        if (file_exists($logFile)) {
            $logs = file_get_contents($logFile);
            $recentLogs = array_slice(explode("\n", $logs), -50); // Last 50 lines
            foreach ($recentLogs as $log) {
                if (stripos($log, 'room') !== false || stripos($log, 'prebook') !== false) {
                    echo $log . "\n";
                }
            }
        } else {
            echo "Debug log bestand niet gevonden\n";
        }
    } else {
        echo "WordPress debug logging is niet ingeschakeld\n";
    }
}

/**
 * AJAX handler voor hotel availability met search parameters
 * Dit is wat de JavaScript code in de hotel cards aanroept
 */
add_action('wp_ajax_shorttrips_get_availability', 'shorttrips_ajax_get_availability');
add_action('wp_ajax_nopriv_shorttrips_get_availability', 'shorttrips_ajax_get_availability');

// Voucher code validatie AJAX handler
add_action('wp_ajax_validate_voucher_code', 'shorttrips_validate_voucher_code');
add_action('wp_ajax_nopriv_validate_voucher_code', 'shorttrips_validate_voucher_code');

function shorttrips_validate_voucher_code()
{
    $code = isset($_POST['code']) ? sanitize_text_field($_POST['code']) : '';

    if (empty($code)) {
        wp_send_json(['success' => false, 'message' => 'Geen code opgegeven']);
        return;
    }

    // Check if WooCommerce is active
    if (!function_exists('wc_get_coupon_id_by_code')) {
        // Als WC niet actief is, accepteer alle codes (fallback)
        wp_send_json(['success' => true, 'message' => 'Code geaccepteerd']);
        return;
    }

    // Zoek coupon in WooCommerce
    $coupon_id = wc_get_coupon_id_by_code($code);

    if (!$coupon_id) {
        wp_send_json(['success' => false, 'message' => 'Code niet gevonden']);
        return;
    }

    // Check of coupon geldig is
    $coupon = new WC_Coupon($coupon_id);

    if (!$coupon || !$coupon->is_valid()) {
        wp_send_json(['success' => false, 'message' => 'Code is verlopen of ongeldig']);
        return;
    }

    // Check usage limit
    $usage_limit = $coupon->get_usage_limit();
    $usage_count = $coupon->get_usage_count();

    if ($usage_limit > 0 && $usage_count >= $usage_limit) {
        wp_send_json(['success' => false, 'message' => 'Code is al gebruikt']);
        return;
    }

    // Code is geldig!
    wp_send_json(['success' => true, 'message' => 'Code is geldig', 'coupon_id' => $coupon_id]);
}

function shorttrips_ajax_get_availability()
{
    // Debug logging// Get parameters from the AJAX request
    $hotelId = intval($_POST['hotelId'] ?? 0);
    $checkin = sanitize_text_field($_POST['checkin'] ?? '');
    $checkout = sanitize_text_field($_POST['checkout'] ?? '');
    $rooms = max(1, intval($_POST['rooms'] ?? 1));
    $adults = max(1, intval($_POST['adults'] ?? 2));
    $children = max(0, intval($_POST['children'] ?? 0));
    $childAges = sanitize_text_field($_POST['child_ages'] ?? '');

    // Validate required parameters
    if ($hotelId <= 0) {
        wp_send_json_error(['message' => 'Invalid hotel ID']);
        return;
    }

    // Use default dates if not provided (tomorrow + 7 days)
    if (empty($checkin) || empty($checkout)) {
        $checkin = date('Y-m-d', strtotime('+1 day'));
        $checkout = date('Y-m-d', strtotime('+8 days'));
    }

    // Get API credentials
    $creds = function_exists('shorttrips_get_api_credentials') ? shorttrips_get_api_credentials() : [
        'username' => defined('SUNHOTELS_USERNAME') ? SUNHOTELS_USERNAME : '',
        'password' => defined('SUNHOTELS_PASSWORD') ? SUNHOTELS_PASSWORD : '',
        'language' => 'en',
        'currency' => 'EUR'
    ];

    // Build SearchV3 request for this specific hotel
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx/SearchV3';
    $params = [
        'userName' => $creds['username'],
        'password' => $creds['password'],
        'language' => $creds['language'],
        'currencies' => $creds['currency'],
        'checkInDate' => $checkin,
        'checkOutDate' => $checkout,
        'numberOfRooms' => $rooms,
        'numberOfAdults' => $adults,
        'numberOfChildren' => $children,
        'hotelIds' => $hotelId,
        'showRoomTypeName' => 'true',
        'showReviews' => 'true',
        'b2c' => 'false',
        'blockSuperDeal' => 'true',
        'deals' => '0'
    ];

    if (!empty($childAges)) {
        $params['childrenAges'] = $childAges;
    }

    // Make API call
    $response = wp_remote_post($endpoint, [
        'headers' => ['Content-Type' => 'application/x-www-form-urlencoded'],
        'body' => http_build_query($params),
        'timeout' => 15,
    ]);

    if (is_wp_error($response) || empty($response['body'])) {
        wp_send_json_error(['message' => 'API request failed']);
        return;
    }

    // Parse XML response
    $xml = @simplexml_load_string($response['body']);
    if (!$xml || empty($xml->hotels->hotel)) {
        wp_send_json_error(['message' => 'No availability data']);
        return;
    }

    // Find lowest price and collect badges
    $lowest_price = null;
    $hasFreeCancel = false;
    $hasPartialRefund = false;
    $hasBreakfast = false;
    $isSuperDeal = false;
    $isBestBuy = false;

    foreach ($xml->hotels->hotel as $hotel) {
        if (!empty($hotel->roomtypes->roomtype)) {
            foreach ($hotel->roomtypes->roomtype as $roomtype) {
                if (!empty($roomtype->rooms->room)) {
                    foreach ($roomtype->rooms->room as $room) {
                        // Check for breakfast
                        if (!empty($room->meals->meal)) {
                            foreach ($room->meals->meal as $meal) {
                                $mealName = strtolower((string) $meal->name);
                                if (strpos($mealName, 'breakfast') !== false || strpos($mealName, 'ontbijt') !== false) {
                                    $hasBreakfast = true;
                                }
                                // Get price
                                if (!empty($meal->prices->price)) {
                                    $price = (float) $meal->prices->price;
                                    if ($price > 0 && ($lowest_price === null || $price < $lowest_price)) {
                                        $lowest_price = $price;
                                    }
                                }
                            }
                        }

                        // Check cancellation policies
                        if (isset($room->cancellation_policies->cancellation_policy)) {
                            foreach ($room->cancellation_policies->cancellation_policy as $cp) {
                                $pct = isset($cp->percentage) ? (float) $cp->percentage : null;
                                if ($pct === 0.0) {
                                    $hasFreeCancel = true;
                                }
                                if ($pct !== null && $pct > 0.0 && $pct < 100.0) {
                                    $hasPartialRefund = true;
                                }
                            }
                        }

                        // Check flags
                        if (isset($room->isSuperDeal) && ((string) $room->isSuperDeal) === 'true') {
                            $isSuperDeal = true;
                        }
                        if (isset($room->isBestBuy) && ((string) $room->isBestBuy) === 'true') {
                            $isBestBuy = true;
                        }
                    }
                }
            }
        }
    }

    // Format price text
    $price_text = null;
    if ($lowest_price !== null) {
        $price_text = '‚Ç¨' . number_format($lowest_price, 0, ',', '.');
    }

    // Build badges HTML
    $badges_html = '';
    if ($hasFreeCancel) {
        $badges_html .= '<span class="inline-block bg-emerald-100 text-emerald-800 text-xs font-medium px-2 py-0.5 rounded mb-1">Gratis annuleren</span>';
    } elseif ($hasPartialRefund) {
        $badges_html .= '<span class="inline-block bg-amber-100 text-amber-800 text-xs font-medium px-2 py-0.5 rounded mb-1">Gedeeltelijk restitueerbaar</span>';
    }
    if ($hasBreakfast) {
        $badges_html .= '<span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded mb-1">Ontbijt inbegrepen</span>';
    }
    if ($isSuperDeal || $isBestBuy) {
        $badges_html .= '<span class="inline-block bg-purple-100 text-purple-800 text-xs font-medium px-2 py-0.5 rounded mb-1">Deal</span>';
    }

    // Return success response
    wp_send_json_success([
        'hotel_id' => $hotelId,
        'best_price' => $lowest_price,
        'best_price_text' => $price_text,
        'badges_html' => $badges_html,
        'has_availability' => ($lowest_price !== null)
    ]);
}

/* End of hotel price display */

/**
 * ============================================================================
 * BESTEMMINGEN PAGINA (Destinations Overview)
 * ============================================================================
 * Shortcode: [shorttrips_destinations]
 * 
 * Combineert:
 * - Featured destinations (populairste resorts uit database)
 * - Trending destinations (meest gezocht)
 * - Recent searches (localStorage)
 * - Inspiratie per regio
 */

// Test: wordt dit bestand √ºberhaupt geladen?
if (WP_DEBUG) {
}

add_shortcode('shorttrips_destinations', function () {
    $hotelsUrl = esc_url(shorttrips_get_hotels_page_url());

    if (!apply_filters('shorttrips_enable_destinations_shortcode_legacy', false)) {
        return <<<HTML
<div style="padding:40px;text-align:center;background:#fff;border-radius:12px;margin:20px 0;">
        <h2 style="font-size:28px;margin-bottom:16px;">üè® Find your next destination</h2>
        <p style="font-size:16px;color:#6b7280;margin-bottom:24px;">Use our search function to find your hotel</p>
    <a href="{$hotelsUrl}" style="display:inline-block;padding:12px 24px;background:#2563eb;color:#fff;text-decoration:none;border-radius:8px;font-weight:600;">üîç Start searching</a>
        </div>
HTML;
    }

    return '<!-- shorttrips_destinations legacy output intentionally disabled -->';
});

add_shortcode('shorttrips_popular_destinations_v2', function ($atts) {
    $atts = shortcode_atts([
        'limit' => 4,
        'cache' => 4,
        'async' => 1,
        'fallback' => 1    // Gebruik statische fallback bij errors (1 = ja)
    ], $atts);

    $limit = max(1, min(12, intval($atts['limit'])));
    $cacheHours = max(1, min(24, intval($atts['cache'])));
    $async = intval($atts['async']) === 1;
    $useFallback = intval($atts['fallback']) === 1;

    // Async loading - laad via AJAX na pagina load (AANBEVOLEN)
    if ($async) {
        $uniqueId = 'st-pop-dest-' . wp_generate_password(8, false);
        ob_start();
        ?>
        <div id="<?php echo $uniqueId; ?>" class="st-popular-destinations-async">
            <div class="st-loading" style="text-align:center;padding:40px;color:#6b7280;">
                <div
                    style="display:inline-block;width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite;">
                </div>
                <p style="margin-top:12px;">Loading destinations...</p>
            </div>
        </div>
        <style>
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
        <script>
            (function () {
                fetch('<?php echo admin_url('admin-ajax.php'); ?>?action=shorttrips_get_popular_destinations&limit=<?php echo $limit; ?>')
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('<?php echo $uniqueId; ?>').innerHTML = html;
                    })
                    .catch(err => {
                        document.getElementById('<?php echo $uniqueId; ?>').innerHTML = '<p style="text-align:center;color:#ef4444;">‚ùå Kon bestemmingen niet laden</p>';
                    });
            })();
        </script>
        <?php
        return ob_get_clean();
    }

    // Normale (sync) loading met aggressive caching
    global $wpdb;

    // Cache key
    $cache_key = 'st_popular_dest_v2_' . $limit;
    $destinations = get_transient($cache_key);

    if (false === $destinations) {
        // Zoek hotels tabel
        $hotel_table = null;
        foreach (['ghwk_bravo_hotels', 'bravo_hotels', $wpdb->prefix . 'bravo_hotels'] as $table) {
            if ($wpdb->get_var("SHOW TABLES LIKE '{$table}'") === $table) {
                $hotel_table = $table;
                break;
            }
        }

        if (!$hotel_table) {
            if ($useFallback) {
                return shorttrips_popular_destinations_fallback($limit);
            }
            return '<p style="color:#6b7280;">Geen bestemmingen beschikbaar</p>';
        }

        // ‚ö° GEOPTIMALISEERDE QUERY met timeout protection
        $wpdb->query("SET SESSION MAX_EXECUTION_TIME=3000"); // 3 seconden max

        // Strategie: gebruik SAMPLE van hotels (niet alle 430K)
        // Dit is 100x sneller dan full table scan
        $sampleSize = 5000; // Alleen eerste 5000 hotels analyseren

        $destinations = $wpdb->get_results($wpdb->prepare("
            SELECT 
                destination_name as name,
                country_name as country,
                COUNT(*) as hotel_count,
                MAX(image) as example_image
            FROM (
                SELECT destination_name, country_name, image
                FROM {$hotel_table}
                WHERE destination_name IS NOT NULL 
                  AND destination_name != ''
                  AND country_name IS NOT NULL
                ORDER BY hotel_id
                LIMIT %d
            ) AS sample
            GROUP BY destination_name, country_name
            HAVING hotel_count >= 2
            ORDER BY hotel_count DESC
            LIMIT %d
        ", $sampleSize, $limit), ARRAY_A);

        // Als query faalt of leeg is, gebruik fallback
        if (empty($destinations) && $useFallback) {
            return shorttrips_popular_destinations_fallback($limit);
        }

        // Cache voor X uren
        if (!empty($destinations)) {
            set_transient($cache_key, $destinations, $cacheHours * HOUR_IN_SECONDS);
        }
    }

    if (empty($destinations)) {
        if ($useFallback) {
            return shorttrips_popular_destinations_fallback($limit);
        }
        return '<p style="color:#6b7280;text-align:center;padding:20px;">Geen populaire bestemmingen gevonden</p>';
    }

    // Render output
    ob_start();
    ?>
    <div class="st-popular-destinations">
        <div class="st-destinations-grid"
            style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;">
            <?php foreach ($destinations as $dest): ?>
                <a href="<?php
                echo esc_url(add_query_arg([
                    'action' => 'shorttrips_search_hotels',
                    'type' => 'resort',
                    'resort' => $dest['name'],
                    'country' => $dest['country'],
                    'checkin' => date('Y-m-d', strtotime('+7 days')),
                    'checkout' => date('Y-m-d', strtotime('+14 days')),
                    'rooms' => 1,
                    'adults' => 2
                ], shorttrips_get_hotels_page_url()));
                ?>" class="st-dest-card"
                    style="display:block;text-decoration:none;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;transition:all 0.2s;"
                    onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">

                    <?php if (!empty($dest['example_image'])): ?>
                        <div
                            style="width:100%;height:180px;background:url('<?php echo esc_url($dest['example_image']); ?>') center/cover;position:relative;">
                            <div
                                style="position:absolute;inset:0;background:linear-gradient(to bottom,transparent,rgba(0,0,0,0.6));">
                            </div>
                        </div>
                    <?php else: ?>
                        <div
                            style="width:100%;height:180px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-size:48px;">
                            üè®</div>
                    <?php endif; ?>

                    <div style="padding:16px;">
                        <h3 style="margin:0 0 4px 0;font-size:18px;font-weight:600;color:#111827;">
                            <?php echo esc_html($dest['name']); ?></h3>
                        <p style="margin:0 0 8px 0;font-size:14px;color:#6b7280;"><?php echo esc_html($dest['country']); ?></p>
                        <p style="margin:0;font-size:13px;color:#2563eb;font-weight:500;">
                            <?php echo intval($dest['hotel_count']); ?> hotels ‚Üí
                        </p>
                    </div>
                </a>
            <?php endforeach; ?>
        </div>
    </div>
    <?php
    return ob_get_clean();
});

/**
 * AJAX Handler voor async loading van populaire bestemmingen
 */
add_action('wp_ajax_shorttrips_get_popular_destinations', 'shorttrips_ajax_popular_destinations');
add_action('wp_ajax_nopriv_shorttrips_get_popular_destinations', 'shorttrips_ajax_popular_destinations');

function shorttrips_ajax_popular_destinations()
{
    $limit = isset($_GET['limit']) ? max(1, min(12, intval($_GET['limit']))) : 4;
    echo do_shortcode('[shorttrips_popular_destinations_v2 limit="' . $limit . '" async="0"]');
    wp_die();
}

// AJAX handler for autocomplete search (via admin-ajax.php)
add_action('wp_ajax_shorttrips_autocomplete', 'shorttrips_ajax_autocomplete');
add_action('wp_ajax_nopriv_shorttrips_autocomplete', 'shorttrips_ajax_autocomplete');

// FALLBACK: Direct endpoint via template_redirect (for when admin-ajax.php doesn't work)
add_action('template_redirect', function () {
    if (isset($_GET['action'])) {
        $action = sanitize_key($_GET['action']);

        if ($action === 'shorttrips_autocomplete') {
            shorttrips_ajax_autocomplete();
            exit;
        }

        if ($action === 'shorttrips_search_hotels') {
            if (!defined('DOING_AJAX')) {
                define('DOING_AJAX', true);
            }

            // Ensure POST contains required data for handler
            if (empty($_POST)) {
                $_POST = [];
            }

            foreach ($_GET as $key => $value) {
                if (!isset($_POST[$key])) {
                    $_POST[$key] = $value;
                }
            }

            $_POST['action'] = 'shorttrips_search_hotels';

            shorttrips_search_hotels();
            exit;
        }
    }

    // DEBUG: Test endpoint
    if (isset($_GET['test_autocomplete'])) {
        header('Content-Type: application/json');
        echo shorttrips_safe_json_encode([
            'test' => 'success',
            'message' => 'Autocomplete handler is loaded',
            'query' => isset($_GET['q']) ? $_GET['q'] : 'none',
            'timestamp' => date('Y-m-d H:i:s')
        ]);
        exit;
    }
});

function shorttrips_ajax_autocomplete()
{
    global $wpdb;

    // Get query parameter
    $query = isset($_GET['q']) ? sanitize_text_field($_GET['q']) : '';

    // Minimum 2 characters required
    if (strlen($query) < 2) {
        wp_send_json(['results' => [], 'query' => $query, 'count' => 0]);
        return;
    }

    $query_lower = strtolower($query);

    // Check if table exists
    $table_exists = $wpdb->get_var("SHOW TABLES LIKE 'ghwk_autocomplete_lookup'");
    if (!$table_exists) {
        wp_send_json([
            'results' => [],
            'query' => $query,
            'count' => 0,
            'error' => 'Autocomplete table does not exist'
        ]);
        return;
    }

    // Query the autocomplete_lookup table
    static $ajaxLookupHasHotelId = null;
    if ($ajaxLookupHasHotelId === null) {
        $columnCheck = $wpdb->get_var("SHOW COLUMNS FROM ghwk_autocomplete_lookup LIKE 'hotel_id'");
        $ajaxLookupHasHotelId = !empty($columnCheck);
    }

    $selectCols = "
        search_term as name,
        display_name,
        type,
        country_name as country,
        destination_id,
        hotel_count,
        stars,
        priority" . ($ajaxLookupHasHotelId ? ", hotel_id" : "") . "
    ";

    $results = $wpdb->get_results($wpdb->prepare("
        SELECT {$selectCols}
        FROM ghwk_autocomplete_lookup
        WHERE search_term_lower LIKE %s
        ORDER BY 
            priority DESC,
            hotel_count DESC,
            search_term ASC
        LIMIT 10
    ", $query_lower . '%'), ARRAY_A);

    // Check for database errors
    if ($wpdb->last_error) {
        wp_send_json([
            'results' => [],
            'query' => $query,
            'count' => 0,
            'error' => 'Database error: ' . $wpdb->last_error
        ]);
        return;
    }

    // Format results for frontend - match expected structure
    $formatted = array_map(function ($row) use ($ajaxLookupHasHotelId) {
        // Determine icon based on type
        $icon = 'üìç'; // default
        if ($row['type'] === 'country') {
            $icon = 'üåç';
        } elseif ($row['type'] === 'city') {
            $icon = 'üèôÔ∏è';
        } elseif ($row['type'] === 'resort') {
            $icon = 'üèñÔ∏è';
        } elseif ($row['type'] === 'hotel') {
            $icon = 'üè®';
        }

        // Build label and sublabel
        $label = $row['display_name'] ?: $row['name'];
        $sublabel = $row['country'] ?: '';
        if ($row['type'] === 'country') {
            $sublabel = intval($row['hotel_count']) . ' hotels';
        } elseif (intval($row['hotel_count']) > 0 && $row['country']) {
            $sublabel = $row['country'] . ' ‚Ä¢ ' . intval($row['hotel_count']) . ' hotels';
        }

        $hotelId = ($ajaxLookupHasHotelId && isset($row['hotel_id'])) ? (int) $row['hotel_id'] : null;
        return [
            'name' => $row['name'],
            'label' => $label,
            'sublabel' => $sublabel,
            'icon' => $icon,
            'type' => $row['type'],
            'country' => $row['country'],
            'destination_id' => $row['destination_id'],
            'hotel_count' => intval($row['hotel_count']),
            'stars' => $row['stars'] ? intval($row['stars']) : null,
            'hotel_id' => $hotelId
        ];
    }, $results);

    wp_send_json([
        'results' => $formatted,
        'query' => $query,
        'count' => count($formatted),
        'success' => true
    ]);
}

// AJAX endpoint to get resorts/cities for a selected country
add_action('wp_ajax_shorttrips_get_resorts_by_country', 'shorttrips_get_resorts_by_country');
add_action('wp_ajax_nopriv_shorttrips_get_resorts_by_country', 'shorttrips_get_resorts_by_country');

function shorttrips_get_resorts_by_country()
{
    global $wpdb;

    $country = sanitize_text_field($_GET['country'] ?? '');

    if (empty($country)) {
        wp_send_json_error(['message' => 'Country parameter is required']);
    }

    // üî• CODE VERSION CHECK - If you see this in API response, new code is active!
    $code_version = 'v38191_' . date('His');

    // üöÄ OPTIMIZED: Use database query with NEW INDEXES
    // After adding indexes (idx_country_destination, idx_country_status), 
    // this query is now 10x faster (< 200ms instead of 2-5 seconds)

    // üî• CACHE DISABLED - Always fetch fresh data to fix dropdown issue
    // Cache was causing old data (only A-B cities) to be shown
    // $cache_key = 'st_resorts_v4_' . md5($country);
    // $cached = get_transient($cache_key);
    // if (false !== $cached) { return $cached; }

    // ‚ö° TWO-STEP APPROACH: Fast city list + destination_id lookup
    // Step 1: Get cities fast (uses index, no JOIN)
    // Step 2: Get destination_id's separately (small table, fast)

    $hotel_table = 'ghwk_bravo_hotels';

    $start_time = microtime(true);

    // STEP 1: Fast query for city names AND destination_id - NO LIMIT to show ALL cities
    $query1 = $wpdb->prepare(
        "SELECT DISTINCT destination_name as name, destination_id as id
     FROM {$hotel_table}
     WHERE country_name = %s
       AND destination_name IS NOT NULL
       AND destination_name != ''
       AND destination_id IS NOT NULL
       AND destination_id > 0
       AND status = 'publish'
     ORDER BY destination_name ASC",
        $country
    );

    $cities = $wpdb->get_results($query1, ARRAY_A);

    if (empty($cities)) {
        $query_time = round((microtime(true) - $start_time) * 1000);
        wp_send_json_error([
            'message' => 'No cities found for this country',
            'query_time_ms' => $query_time,
            'db_error' => $wpdb->last_error ?: 'none'
        ]);
        return;
    }

    $query_time = round((microtime(true) - $start_time) * 1000);

    // ‚úÖ FIX: Format cities with destination_id from database
    $resorts = array_map(function ($city) {
        return [
            'name' => $city['name'],
            'id' => $city['id'] ?? null,  // ‚úÖ Now uses REAL destination_id from database!
            'hotel_count' => 0
        ];
    }, $cities);

    // Note: Some cities may have null id (not in bravo_destinations)
    // That's OK - the search will still work via city name

    // üî• CACHING DISABLED - Was causing dropdown to show only A-B cities
    // set_transient($cache_key, $resorts, 6 * HOUR_IN_SECONDS);

    wp_send_json_success([
        'country' => $country,
        'resorts' => $resorts,
        'total' => count($resorts),
        'cached' => false,
        'source' => 'database_direct_nocache',
        'query_time_ms' => $query_time,
        'code_version' => $code_version,
        'sql_limit' => 'NONE - ALL CITIES'
    ]);
}

/**
 * Statische fallback - gebruikt geen database queries
 * Toont handmatig gecureerde populaire bestemmingen
 */
function shorttrips_popular_destinations_fallback($limit = 4)
{
    $staticDestinations = [
        ['name' => 'Antalya', 'country' => 'Turkey', 'image' => '', 'count' => '500+'],
        ['name' => 'Bali', 'country' => 'Indonesia', 'image' => '', 'count' => '300+'],
        ['name' => 'Bangkok', 'country' => 'Thailand', 'image' => '', 'count' => '400+'],
        ['name' => 'Dubai', 'country' => 'United Arab Emirates', 'image' => '', 'count' => '250+'],
        ['name' => 'Phuket', 'country' => 'Thailand', 'image' => '', 'count' => '200+'],
        ['name' => 'Istanbul', 'country' => 'Turkey', 'image' => '', 'count' => '350+'],
    ];

    $destinations = array_slice($staticDestinations, 0, $limit);

    ob_start();
    ?>
    <div class="st-popular-destinations st-fallback">
        <div class="st-destinations-grid"
            style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;">
            <?php foreach ($destinations as $dest): ?>
                <a href="<?php
                echo esc_url(add_query_arg([
                    'action' => 'shorttrips_search_hotels',
                    'type' => 'resort',
                    'resort' => $dest['name'],
                    'country' => $dest['country'],
                    'checkin' => date('Y-m-d', strtotime('+7 days')),
                    'checkout' => date('Y-m-d', strtotime('+14 days')),
                    'rooms' => 1,
                    'adults' => 2
                ], shorttrips_get_hotels_page_url()));
                ?>" class="st-dest-card"
                    style="display:block;text-decoration:none;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;transition:all 0.2s;"
                    onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">

                    <div
                        style="width:100%;height:180px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-size:48px;">
                        <?php echo $dest['name'][0]; ?>
                    </div>

                    <div style="padding:16px;">
                        <h3 style="margin:0 0 4px 0;font-size:18px;font-weight:600;color:#111827;">
                            <?php echo esc_html($dest['name']); ?></h3>
                        <p style="margin:0 0 8px 0;font-size:14px;color:#6b7280;"><?php echo esc_html($dest['country']); ?></p>
                        <p style="margin:0;font-size:13px;color:#2563eb;font-weight:500;">
                            <?php echo $dest['count']; ?> hotels ‚Üí
                        </p>
                    </div>
                </a>
            <?php endforeach; ?>
        </div>
    </div>
    <?php
    return ob_get_clean();
}

/**
 * ============================================================================
 * RECENTE ZOEKOPDRACHTEN SHORTCODE
 * ============================================================================
 * Shortcode: [shorttrips_recent_searches]
 * 
 * Toont de laatste 3 zoekopdrachten van de gebruiker (uit localStorage)
 * Kan gebruikt worden in:
 * - Sidebar widgets
 * - Menu items
 * - Template locaties
 * - Anywhere via shortcode
 * 
 * Parameters:
 * - title: Aangepaste titel (default: "Uw recente zoekopdrachten")
 * - limit: Aantal items (default: 3)
 * - style: compact of full (default: full)
 * 
 * Voorbeelden:
 * [shorttrips_recent_searches]
 * [shorttrips_recent_searches limit="3" style="compact"]
 * [shorttrips_recent_searches title="Recente Zoekacties"]
 */
add_shortcode('shorttrips_recent_searches', function ($atts) {
    $atts = shortcode_atts([
        'title' => 'Uw recente zoekopdrachten',
        'limit' => 3,
        'style' => 'full'  // 'full' of 'compact'
    ], $atts);

    $limit = max(1, min(10, intval($atts['limit'])));
    $style = in_array($atts['style'], ['full', 'compact']) ? $atts['style'] : 'full';

    ob_start();
    ?>

    <div class="shorttrips-recent-searches" data-style="<?php echo esc_attr($style); ?>">
        <div id="st-recent-searches-container" style="display:none;">
            <?php if (!empty($atts['title'])): ?>
                <h3 class="st-recent-title">
                    <span class="st-recent-icon">üïê</span>
                    <?php echo esc_html($atts['title']); ?>
                </h3>
            <?php endif; ?>
            <div id="st-recent-searches-list" class="st-recent-list"></div>
        </div>

        <div id="st-recent-searches-empty" class="st-recent-empty">
            <p>Nog geen recente zoekopdrachten</p>
        </div>
    </div>

    <script>
        (function () {
            var limit = <?php echo intval($limit); ?>;
            var style = '<?php echo esc_js($style); ?>';

            // Haal recent searches op uit localStorage
            var recentSearches = [];
            try {
                var stored = localStorage.getItem('shorttrips_recent_searches');
                if (stored) {
                    recentSearches = JSON.parse(stored);
                }
            } catch (e) {
                console.error('ShortTrips: Error loading recent searches:', e);
            }

            // Toon searches als er data is
            if (recentSearches.length > 0) {
                document.getElementById('st-recent-searches-empty').style.display = 'none';
                document.getElementById('st-recent-searches-container').style.display = 'block';

                var list = document.getElementById('st-recent-searches-list');
                var html = '';

                recentSearches.slice(0, limit).forEach(function (search) {
                    var url = '<?php echo shorttrips_get_hotels_page_url(); ?>?action=shorttrips_search_hotels' +
                        '&type=' + encodeURIComponent(search.type || 'search') +
                        '&checkin=' + encodeURIComponent(search.checkin || '') +
                        '&checkout=' + encodeURIComponent(search.checkout || '') +
                        '&rooms=' + (search.rooms || 1) +
                        '&adults=' + (search.adults || 2) +
                        '&children=' + (search.children || 0);

                    if (search.resort) {
                        url += '&resort=' + encodeURIComponent(search.resort);
                        if (search.country) {
                            url += '&country=' + encodeURIComponent(search.country);
                        }
                    } else if (search.country) {
                        url += '&country=' + encodeURIComponent(search.country);
                    } else if (search.q) {
                        url += '&q=' + encodeURIComponent(search.q);
                    }

                    var label = search.resort || search.country || search.q || 'Zoekactie';
                    var dates = '';

                    if (style === 'full' && search.checkin && search.checkout) {
                        dates = ' <span class="st-recent-dates">(' + search.checkin + ' ‚Üí ' + search.checkout + ')</span>';
                    }

                    html += '<a href="' + url + '" class="st-recent-item">';
                    html += '<span class="st-recent-marker">üìç</span>';
                    html += '<div class="st-recent-info">';
                    html += '<span class="st-recent-label">' + label + dates + '</span>';

                    if (style === 'full') {
                        html += '<span class="st-recent-meta">' + search.adults + ' volw., ' + search.children + ' kind.</span>';
                    }

                    html += '</div>';
                    html += '</a>';
                });

                list.innerHTML = html;
            }
        })();
    </script>

    <style>
        .shorttrips-recent-searches {
            margin: 20px 0;
        }

        .st-recent-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .st-recent-icon {
            font-size: 20px;
        }

        .st-recent-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .st-recent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .st-recent-item:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
            transform: translateX(4px);
        }

        .st-recent-marker {
            font-size: 18px;
        }

        .st-recent-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .st-recent-label {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .st-recent-dates {
            font-size: 12px;
            font-weight: 400;
            color: #6b7280;
        }

        .st-recent-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .st-recent-empty {
            padding: 20px;
            text-align: center;
            background: #f9fafb;
            border-radius: 8px;
            color: #6b7280;
            font-size: 14px;
        }

        /* Compact Style */
        .shorttrips-recent-searches[data-style="compact"] .st-recent-item {
            padding: 8px 12px;
        }

        .shorttrips-recent-searches[data-style="compact"] .st-recent-marker {
            font-size: 16px;
        }

        .shorttrips-recent-searches[data-style="compact"] .st-recent-label {
            font-size: 13px;
        }

        .shorttrips-recent-searches[data-style="compact"] .st-recent-list {
            gap: 6px;
        }
    </style>

    <?php
    return ob_get_clean();
});

/**
 * Hotels Search Page Shortcode
 * Gebruik: [shorttrips_hotels_page]
 * 
 * Dit is de main hotels search pagina die:
 * 1. Zoekformulier toont (of verberg als ?action=... in URL)
 * 2. Automatisch search triggert als URL parameters aanwezig zijn
 * 3. Resultaten toont via AJAX
 */
add_shortcode('shorttrips_hotels_page', function () {
    // Check of er search parameters in URL staan
    $hasSearchParams = !empty($_GET['action']) && $_GET['action'] === 'shorttrips_search_hotels';
    $inlineFilters = shorttrips_render_filters_widget('inline');
    if (!$hasSearchParams) {
        $possibleKeys = [
            'destinationID',
            'destination_id',
            'country_name',
            'country',
            'resort',
            'resort_name',
            'q',
            'type'
        ];
        foreach ($possibleKeys as $key) {
            if (!empty($_GET[$key])) {
                $hasSearchParams = true;
                // Zorg dat downstream code weet dat dit een search is
                if (empty($_GET['action'])) {
                    $_GET['action'] = 'shorttrips_search_hotels';
                }
                break;
            }
        }
    }

    ob_start();
    ?>
    <div id="shorttrips-hotels-container" class="shorttrips-main-page">

        <?php if (!$hasSearchParams): ?>
            <!-- ZOEKFORMULIER (modern design met tabs) -->
            <div id="search-form-container" class="search-form-wrapper">
                <h2 class="search-title">Find your next stay</h2>
                <p class="search-subtitle" style="color:#475569;">üëÜ Use your voucher to book commission free</p>

                <!-- UNIVERSAL SEARCH BAR (Google-style autocomplete) -->
                <div class="st-universal-search-container" style="margin-bottom:24px;">
                    <div class="st-universal-search-wrapper" style="position:relative;max-width:700px;margin:0 auto;">
                        <div style="display:flex;align-items:center;background:white;border:2px solid #e5e7eb;border-radius:12px;padding:4px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.2s;"
                            id="st-search-input-wrapper">
                            <span style="padding:0 12px;font-size:20px;color:#6b7280;">üîç</span>
                            <input type="text" id="st-universal-search" placeholder="Find hotel, city, region or country..."
                                autocomplete="off"
                                style="flex:1;border:none;outline:none;padding:12px 8px;font-size:16px;color:#1f2937;" />
                            <button type="button" id="st-search-clear"
                                style="display:none;padding:8px 12px;background:transparent;border:none;color:#9ca3af;cursor:pointer;font-size:20px;"
                                title="Wissen">‚úï</button>
                        </div>

                        <!-- AUTOCOMPLETE DROPDOWN -->
                        <div id="st-autocomplete-results" class="st-autocomplete-dropdown"
                            style="display:none;position:absolute;top:100%;left:0;right:0;margin-top:8px;background:white;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-height:400px;overflow-y:auto;z-index:1000;">
                            <!-- Results will be injected here -->
                        </div>

                        <!-- LOADING INDICATOR -->
                        <div id="st-search-loading"
                            style="display:none;position:absolute;right:16px;top:50%;transform:translateY(-50%);pointer-events:none;">
                            <div
                                style="width:20px;height:20px;border:2px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 0.6s linear infinite;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB NAVIGATIE -->
                <div class="search-tabs">
                    <button class="search-tab active" data-tab="search" type="button">
                        Hotel zoeken
                    </button>
                    <button class="search-tab" data-tab="country" type="button">
                        Per land
                    </button>
                    <button class="search-tab" data-tab="resort" type="button">
                        Per resort
                    </button>
                </div>

                <!-- FORMULIER -->
                <form id="shorttrips-search-form" class="search-form">
                    <input type="hidden" name="type" id="search-type" value="search">

                    <!-- TAB CONTENT: HOTEL ZOEKEN -->
                    <div class="tab-content active" data-tab-content="search">
                        <div class="form-row">
                            <div class="form-field form-field-full">
                                <input type="text" name="q" placeholder="Enter your destination..."
                                    class="form-input form-input-lg">
                            </div>
                        </div>
                    </div>

                    <!-- TAB CONTENT: PER LAND -->
                    <div class="tab-content" data-tab-content="country" style="display:none;">
                        <div class="form-row">
                            <div class="form-field form-field-full">
                                <input type="text" name="country" placeholder="Enter a country (like Netherlands, Thailand...)"
                                    class="form-input form-input-lg">
                            </div>
                        </div>
                    </div>

                    <!-- TAB CONTENT: PER RESORT -->
                    <div class="tab-content" data-tab-content="resort" style="display:none;">
                        <div class="form-row">
                            <div class="form-field">
                                <input type="text" name="resort" placeholder="Resort name..." class="form-input">
                            </div>
                            <div class="form-field">
                                <input type="text" name="country_resort" placeholder="Country..." class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- GEMEENSCHAPPELIJKE VELDEN (voor alle tabs) -->
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-field">
                                <label class="form-label">Check-in</label>
                                <input type="date" name="checkin" required
                                    value="<?php echo date('Y-m-d', strtotime('+1 day')); ?>" class="form-input">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Check-out</label>
                                <input type="date" name="checkout" required
                                    value="<?php echo date('Y-m-d', strtotime('+8 days')); ?>" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-row form-row-three">
                            <div class="form-field">
                                <label class="form-label">Rooms</label>
                                <input type="number" name="rooms" min="1" value="1" class="form-input">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Adults</label>
                                <input type="number" name="adults" min="1" value="2" class="form-input">
                            </div>
                            <div class="form-field">
                                <label class="form-label">Children</label>
                                <input type="number" name="children" min="0" value="0" class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- SUBMIT BUTTON -->
                    <div class="form-submit">
                        <button type="submit" class="btn-submit">
                            Find hotels
                        </button>
                    </div>
                </form>
            </div>
        <?php endif; ?>

        <!-- SORTEER BAR (alleen zichtbaar als er resultaten zijn) -->
        <div id="st-sort-bar" class="st-sort-bar" style="display:none;">
            <div class="st-sort-container">
                <label class="st-sort-label">
                    <span>üîΩ Sorteer resultaten:</span>
                    <select id="st-sort-select" class="st-sort-select">
                        <option value="">‚Äî Standaard sortering ‚Äî</option>
                        <option value="price_asc">üí∞ Prijs: Laag ‚Üí Hoog</option>
                        <option value="price_desc">üí∞ Prijs: Hoog ‚Üí Laag</option>
                        <option value="stars_desc">‚≠ê Sterren: Hoog ‚Üí Laag (5‚Üí1)</option>
                        <option value="stars_asc">‚≠ê Sterren: Laag ‚Üí Hoog (1‚Üí5)</option>
                        <option value="rating_desc">üìä Beoordeling: Hoog ‚Üí Laag</option>
                    </select>
                </label>
                <span id="st-result-count" class="st-result-count"></span>
            </div>
        </div>

        <!-- RESULTATEN + FILTERS LAYOUT -->
        <div class="st-results-layout st-results-layout--inline" id="st-hotels-results-layout">
            <div class="st-results-primary">
                <div class="st-inline-filters-bar" id="st-inline-filters"
                    style="<?php echo $hasSearchParams ? '' : 'display:none;'; ?>">
                    <?php echo $inlineFilters; ?>
                </div>
                <div id="st-results" class="st-fullbleed">
                    <?php if ($hasSearchParams): ?>
                        <div class="text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                            <p class="mt-4 text-gray-600">Hotels laden...</p>
                        </div>
                    <?php else: ?>
                        <div class="text-center py-12 text-gray-500">
                            <p class="text-lg" style="color:#1f2937;">üëÜ Use your voucher to book commission free</p>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

    </div>

    <script>
        (function () {
            // ============================================================
            // UNIVERSAL AUTOCOMPLETE SEARCH (HOTELS PAGE)
            // ============================================================
            // Wait for function to be available
            if (typeof initUniversalSearch === 'function') {
                initUniversalSearch(
                    'st-universal-search',
                    'st-autocomplete-results',
                    'st-search-input-wrapper',
                    'st-search-clear',
                    'st-search-loading'
                );
            }

            // Universal search initialized via shared function
            // See wp_head action for initUniversalSearch() definition

            // ============================================================
            // EXISTING SEARCH FORM CODE (Standard dropdowns)
            // ============================================================
            var form = document.getElementById('shorttrips-search-form');
            var sortBar = document.getElementById('st-sort-bar');
            var sortSelect = document.getElementById('st-sort-select');
            var lastSearchData = null; // Bewaar de laatste zoekopdracht
            var inlineFiltersSidebar = document.getElementById('st-inline-filters');
            console.log('üîé Inline filters sidebar element:', inlineFiltersSidebar);
            var hasInitialSearch = <?php echo $hasSearchParams ? 'true' : 'false'; ?>;

            function hasInlineHotelCards() {
                var resultsDiv = document.getElementById('st-results');
                if (!resultsDiv) return false;
                return !!resultsDiv.querySelector('.st-hotel-card[data-hotel-id]');
            }

            function showInlineFilters(forceShow) {
                var wrapper = inlineFiltersSidebar ? inlineFiltersSidebar.querySelector('[data-st-filters-root]') : null;
                if (!inlineFiltersSidebar || !wrapper) {
                    console.warn('‚ö†Ô∏è showInlineFilters: sidebar/wrapper not found');
                }

                var hasCards = hasInlineHotelCards();
                var shouldForceShow = !!(forceShow || hasCards);
                console.log('üîß showInlineFilters called', { forceShow: forceShow, hasCards: hasCards });

                if (typeof window.stToggleInlineFilters === 'function') {
                    window.stToggleInlineFilters(shouldForceShow);
                } else if (inlineFiltersSidebar && wrapper) {
                    if (!shouldForceShow) {
                        inlineFiltersSidebar.style.display = 'none';
                        wrapper.style.display = 'none';
                        return;
                    }
                    inlineFiltersSidebar.style.display = 'block';
                    wrapper.style.display = 'block';
                }

                if (!shouldForceShow || !inlineFiltersSidebar || !wrapper) {
                    return;
                }

                if (!inlineFiltersSidebar.dataset.popupShown && !sessionStorage.getItem('stFiltersPopupShown')) {
                    sessionStorage.setItem('stFiltersPopupShown', '1');
                    var popup = document.createElement('div');
                    popup.className = 'st-filters-popup';
                    popup.innerHTML = '<strong>Wilt u de resultaten verder verfijnen?</strong><p style="margin:8px 0 0 0;font-size:13px;">Filter hieronder.</p><button type="button" aria-label="Sluiten">‚úï</button>';
                    var closeBtn = popup.querySelector('button');
                    closeBtn.addEventListener('click', function () {
                        if (popup && popup.parentNode) {
                            popup.parentNode.removeChild(popup);
                        }
                    });
                    wrapper.appendChild(popup);
                    setTimeout(function () { popup.classList.add('visible'); }, 30);
                    setTimeout(function () {
                        if (popup && popup.parentNode) {
                            popup.parentNode.removeChild(popup);
                        }
                    }, 10000);
                    inlineFiltersSidebar.dataset.popupShown = '1';
                }
            }

            if (hasInitialSearch) {
                showInlineFilters(true);
            }

            // ================================================================
            // üîß FIX: POPULATE FORM FIELDS FROM URL PARAMETERS
            // ================================================================
            (function populateFormFromURL() {
                if (!form) return;

                var urlParams = new URLSearchParams(window.location.search);
                var type = urlParams.get('type');
                var resort_name = urlParams.get('resort_name');
                var country_name = urlParams.get('country_name');
                var q = urlParams.get('q');

                console.log('üîß Populating form from URL:', { type, resort_name, country_name, q });

                // Populate based on type
                if (type === 'resort' && resort_name) {
                    // Switch to "Per resort" tab
                    var resortTab = document.querySelector('.search-tab[data-tab="resort"]');
                    var resortContent = document.querySelector('.tab-content[data-tab-content="resort"]');

                    if (resortTab && resortContent) {
                        // Activate resort tab
                        document.querySelectorAll('.search-tab').forEach(function (b) { b.classList.remove('active'); });
                        document.querySelectorAll('.tab-content').forEach(function (c) { c.style.display = 'none'; c.classList.remove('active'); });

                        resortTab.classList.add('active');
                        resortContent.style.display = 'block';
                        resortContent.classList.add('active');

                        // Fill resort field
                        var resortInput = form.querySelector('input[name="resort"]');
                        if (resortInput) {
                            resortInput.value = resort_name;
                            console.log('‚úÖ Filled resort field:', resort_name);
                        }

                        // Fill country field
                        if (country_name) {
                            var countryInput = form.querySelector('input[name="country_resort"]');
                            if (countryInput) {
                                countryInput.value = country_name;
                                console.log('‚úÖ Filled country field:', country_name);
                            }
                        }

                        // Update hidden type field
                        var typeInput = document.getElementById('search-type');
                        if (typeInput) {
                            typeInput.value = 'resort';
                        }
                    }
                } else if (type === 'country' && country_name) {
                    // Switch to "Per land" tab
                    var countryTab = document.querySelector('.search-tab[data-tab="country"]');
                    var countryContent = document.querySelector('.tab-content[data-tab-content="country"]');

                    if (countryTab && countryContent) {
                        // Activate country tab
                        document.querySelectorAll('.search-tab').forEach(function (b) { b.classList.remove('active'); });
                        document.querySelectorAll('.tab-content').forEach(function (c) { c.style.display = 'none'; c.classList.remove('active'); });

                        countryTab.classList.add('active');
                        countryContent.style.display = 'block';
                        countryContent.classList.add('active');

                        // Fill country field
                        var countryInput = form.querySelector('input[name="country"]');
                        if (countryInput) {
                            countryInput.value = country_name;
                            console.log('‚úÖ Filled country field:', country_name);
                        }

                        // Update hidden type field
                        var typeInput = document.getElementById('search-type');
                        if (typeInput) {
                            typeInput.value = 'country';
                        }
                    }
                } else if (q) {
                    // Use "Hotel zoeken" tab (default)
                    var searchInput = form.querySelector('input[name="q"]');
                    if (searchInput) {
                        searchInput.value = q;
                        console.log('‚úÖ Filled search field:', q);
                    }
                }
            })();

            // SORTEER FUNCTIONALITEIT
            if (sortSelect) {
                sortSelect.addEventListener('change', function () {
                    if (lastSearchData) {
                        // Voeg sorteer parameter toe
                        lastSearchData.set('sortBy', this.value);

                        console.log('ShortTrips: Re-sorting with:', this.value);

                        // Toon loading
                        var resultsDiv = document.getElementById('st-results');
                        resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div><p class="mt-4 text-gray-600">Hotels sorteren...</p></div>';

                        // Voer zoekopdracht opnieuw uit met sorteer parameter
                        fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                            method: 'POST',
                            body: lastSearchData,
                            credentials: 'same-origin'
                        })
                            .then(function (r) { return r.text(); })
                            .then(function (html) {
                                resultsDiv.innerHTML = html;
                                updateResultCount(html);
                            })
                            .catch(function (err) {
                                resultsDiv.innerHTML = '<div class="text-center py-8 text-red-600"><p>‚ùå Er ging iets mis. Probeer het opnieuw.</p></div>';
                                console.error('Sort error:', err);
                            });
                    }
                });
            }

            // Functie om aantal resultaten te tellen en tonen
            function updateResultCount(html) {
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                var hotelCards = tempDiv.querySelectorAll('.st-hotel-card, .hotel-card, .destination-card');
                var count = hotelCards.length;

                var countEl = document.getElementById('st-result-count');
                var sortBar = document.getElementById('st-sort-bar');
                if (countEl && count > 0) {
                    countEl.textContent = count + ' ' + (count === 1 ? 'hotel' : 'hotels') + ' gevonden';
                    if (sortBar) {
                        sortBar.style.display = 'block';
                    }
                    showInlineFilters();
                } else {
                    if (sortBar && count === 0) {
                        // Verberg sorteer bar als er geen resultaten zijn
                        sortBar.style.display = 'none';
                    }
                    if (inlineFiltersSidebar) {
                        inlineFiltersSidebar.style.display = 'none';
                        var wrapper = inlineFiltersSidebar.querySelector('[data-st-filters-root]');
                        if (wrapper) wrapper.style.display = 'none';
                    }
                }
            }

            // TAB SWITCHING
            var tabButtons = document.querySelectorAll('.search-tab');
            var tabContents = document.querySelectorAll('.tab-content');
            var typeInput = document.getElementById('search-type');

            tabButtons.forEach(function (btn) {
                btn.addEventListener('click', function () {
                    var targetTab = this.getAttribute('data-tab');

                    // Update active states
                    tabButtons.forEach(function (b) { b.classList.remove('active'); });
                    this.classList.add('active');

                    // Show/hide content
                    tabContents.forEach(function (content) {
                        var contentTab = content.getAttribute('data-tab-content');
                        if (contentTab === targetTab) {
                            content.style.display = 'block';
                            content.classList.add('active');
                        } else {
                            content.style.display = 'none';
                            content.classList.remove('active');
                        }
                    });

                    // Update hidden type field
                    typeInput.value = targetTab;

                    // Clear form fields in other tabs (optional)
                    if (targetTab !== 'search') {
                        form.querySelector('input[name="q"]').value = '';
                    }
                    if (targetTab !== 'country') {
                        form.querySelector('input[name="country"]').value = '';
                    }
                    if (targetTab !== 'resort') {
                        form.querySelector('input[name="resort"]').value = '';
                        form.querySelector('input[name="country_resort"]').value = '';
                    }
                });
            });

            // Handle form submit
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();

                    var formData = new FormData(form);
                    formData.append('action', 'shorttrips_search_hotels');

                    // Voor resort zoeken: map country_resort naar country
                    var currentType = typeInput.value;
                    if (currentType === 'resort') {
                        var countryResort = form.querySelector('input[name="country_resort"]').value;
                        if (countryResort) {
                            formData.append('country', countryResort);
                        }
                    }

                    // === SAVE TO RECENT SEARCHES ===
                    try {
                        var searchData = {
                            type: currentType,
                            checkin: form.querySelector('input[name="checkin"]').value,
                            checkout: form.querySelector('input[name="checkout"]').value,
                            rooms: form.querySelector('input[name="rooms"]').value,
                            adults: form.querySelector('input[name="adults"]').value,
                            children: form.querySelector('input[name="children"]').value,
                            timestamp: Date.now()
                        };

                        if (currentType === 'search') {
                            searchData.q = form.querySelector('input[name="q"]').value;
                        } else if (currentType === 'country') {
                            searchData.country = form.querySelector('input[name="country"]').value;
                        } else if (currentType === 'resort') {
                            searchData.resort = form.querySelector('input[name="resort"]').value;
                            searchData.country = form.querySelector('input[name="country_resort"]').value;
                        }

                        // Haal existing searches op
                        var recentSearches = [];
                        var stored = localStorage.getItem('shorttrips_recent_searches');
                        if (stored) {
                            recentSearches = JSON.parse(stored);
                        }

                        // Voeg nieuwe search toe aan begin
                        recentSearches.unshift(searchData);

                        // Limiteer tot 10 recente searches
                        recentSearches = recentSearches.slice(0, 10);

                        // Save terug naar localStorage
                        localStorage.setItem('shorttrips_recent_searches', JSON.stringify(recentSearches));
                    } catch (e) {
                        console.error('Error saving recent search:', e);
                    }

                    var resultsDiv = document.getElementById('st-results');
                    resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div><p class="mt-4 text-gray-600">Hotels zoeken...</p></div>';
                    showInlineFilters(true);

                    // Bewaar FormData voor later (voor sorting)
                    lastSearchData = new FormData(form);
                    lastSearchData.append('action', 'shorttrips_search_hotels');
                    if (currentType === 'resort') {
                        var countryResort = form.querySelector('input[name="country_resort"]').value;
                        if (countryResort) {
                            lastSearchData.append('country', countryResort);
                        }
                    }

                    fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    })
                        .then(function (r) { return r.text(); })
                        .then(function (html) {
                            resultsDiv.innerHTML = html;
                            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

                            // Toon sorteer bar en update count
                            updateResultCount(html);

                            // Reset sorteer dropdown naar standaard
                            if (sortSelect) {
                                sortSelect.value = '';
                            }
                        })
                        .catch(function (err) {
                            resultsDiv.innerHTML = '<div class="text-center py-8 text-red-600"><p>‚ùå Er ging iets mis. Probeer het opnieuw.</p></div>';
                            console.error('Search error:', err);
                        });
                });
            }

            // Auto-trigger search if URL has parameters
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'shorttrips_search_hotels') {
                var formData = new FormData();
                urlParams.forEach(function (value, key) {
                    // Skip country_resort als het in URL staat, wordt al als 'country' gestuurd
                    if (key !== 'country_resort') {
                        formData.append(key, value);
                    }
                });

                // Bewaar voor sorting
                lastSearchData = formData;

                var resultsDiv = document.getElementById('st-results');

                showInlineFilters(true);
                fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                    .then(function (r) { return r.text(); })
                    .then(function (html) {
                        resultsDiv.innerHTML = html;

                        // Toon sorteer bar en update count
                        updateResultCount(html);
                    })
                    .catch(function (err) {
                        resultsDiv.innerHTML = '<div class="text-center py-8 text-red-600"><p>‚ùå Er ging iets mis. Probeer het opnieuw.</p></div>';
                        console.error('Auto-search error:', err);
                    });
            }
        })();
    </script>

    <style>
        /* Main Container */
        .shorttrips-main-page {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding: 20px clamp(20px, 4vw, 60px);
        }

        /* Universal Search Autocomplete Styles */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .st-autocomplete-dropdown::-webkit-scrollbar {
            width: 8px;
        }

        .st-autocomplete-dropdown::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        .st-autocomplete-dropdown::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .st-autocomplete-dropdown::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Search Form Wrapper */
        .search-form-wrapper {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .search-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            padding: 24px 24px 16px;
            margin: 0;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Tabs */
        .search-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            background: #f9fafb;
        }

        .search-tab {
            flex: 1;
            padding: 16px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            bottom: -2px;
            /* Verticale centering van de tekst */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 56px;
        }

        .search-tab:hover {
            color: #2563eb;
            background: #eff6ff;
        }

        .search-tab.active {
            color: #ffffff;
            background: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
        }

        /* Form */
        .search-form {
            padding: 24px;
        }

        .tab-content {
            margin-bottom: 20px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-three {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-field {
            position: relative;
        }

        .form-field-full {
            grid-column: 1 / -1;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            color: #1f2937;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .form-input-lg {
            padding: 14px 18px;
            font-size: 16px;
        }

        /* Submit Button */
        .form-submit {
            margin-top: 24px;
        }

        .btn-submit {
            width: 100%;
            padding: 14px 24px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .btn-submit:hover {
            background: #1d4ed8;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        /* Loading Animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* SORTEER BAR */
        .st-sort-bar {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .st-sort-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .st-sort-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .st-sort-select {
            padding: 8px 32px 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #1f2937;
            cursor: pointer;
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .st-sort-select:hover {
            border-color: #9ca3af;
        }

        .st-sort-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .st-result-count {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {

            .form-row,
            .form-row-three {
                grid-template-columns: 1fr;
            }

            .search-tab {
                padding: 12px 16px;
                font-size: 14px;
            }

            .search-title {
                font-size: 20px;
                padding: 20px 16px 12px;
            }

            .search-form {
                padding: 16px;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>

    <?php if ($hasSearchParams): ?>
        <script>
            (function () {
                // Execute search with URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const formData = new FormData();

                // Copy all URL parameters to FormData
                for (const [key, value] of urlParams) {
                    formData.append(key, value);
                }

                // Ensure action parameter is set
                if (!formData.has('action')) {
                    formData.append('action', 'shorttrips_search_hotels');
                }

                console.log('üîç ShortTrips: Executing search with URL parameters');

                // Execute search via AJAX
                fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                    .then(function (r) {
                        if (!r.ok) throw new Error('HTTP ' + r.status);
                        return r.text();
                    })
                    .then(function (html) {
                        console.log('‚úÖ ShortTrips: Search results loaded');
                        const resultsDiv = document.getElementById('st-results');
                        if (resultsDiv) {
                            resultsDiv.innerHTML = html;
                        }
                    })
                    .catch(function (err) {
                        console.error('‚ùå ShortTrips: Search error:', err);
                        const resultsDiv = document.getElementById('st-results');
                        if (resultsDiv) {
                            resultsDiv.innerHTML = '<div style="text-align:center;padding:32px 0;"><p style="color:#ef4444;">‚ö†Ô∏è Er ging iets mis bij het laden van de hotels. Probeer het opnieuw.</p></div>';
                        }
                    });
            })();
        </script>
    <?php endif; ?>

    <?php
    return ob_get_clean();
});

/**
 * Filters Shortcode - Integreert met shorttrips_search_hotels
 * Gebruik: [freestays_filters]
 */

add_shortcode('freestays_filters', function () {
    global $wpdb;

    // Detecteer correcte tabel namen (met of zonder prefix)
    $features_table = null;
    $themes_table = null;
    $meals_table = null;

    // Haal ALLE tabellen op en zoek naar matches
    $all_tables = $wpdb->get_col("SHOW TABLES");

    // Zoek features tabel (probeer verschillende varianten)
    foreach (['ghwk_features', 'ghwk_bravo_features', 'bravo_features', $wpdb->prefix . 'bravo_features', $wpdb->prefix . 'features'] as $table) {
        if (in_array($table, $all_tables)) {
            $features_table = $table;
            break;
        }
    }

    // Zoek themes tabel (probeer verschillende varianten)
    foreach (['ghwk_themes', 'ghwk_bravo_themes', 'bravo_themes', $wpdb->prefix . 'bravo_themes', $wpdb->prefix . 'themes'] as $table) {
        if (in_array($table, $all_tables)) {
            $themes_table = $table;
            break;
        }
    }

    // Zoek meals tabel (probeer verschillende varianten)
    foreach (['ghwk_meals', 'ghwk_bravo_meals', 'bravo_meals', $wpdb->prefix . 'bravo_meals', $wpdb->prefix . 'meals'] as $table) {
        if (in_array($table, $all_tables)) {
            $meals_table = $table;
            break;
        }
    }

    if (defined('WP_DEBUG') && WP_DEBUG) {
        $relevant_tables = array_filter($all_tables, function ($t) {
            return stripos($t, 'bravo_') !== false ||
                stripos($t, 'features') !== false ||
                stripos($t, 'themes') !== false ||
                stripos($t, 'meals') !== false;
        });
    }

    // Haal filter data op uit database (let op: niet alle tabellen hebben deleted_at kolom!)
    $features = [];
    $themes = [];
    $meals = [];

    if ($features_table) {
        // Check of deleted_at kolom bestaat
        $columns = $wpdb->get_col("SHOW COLUMNS FROM {$features_table}");
        $has_deleted = in_array('deleted_at', $columns);
        $where = $has_deleted ? "WHERE deleted_at IS NULL" : "";
        $features = $wpdb->get_results("SELECT id, name FROM {$features_table} {$where} ORDER BY name ASC", ARRAY_A);
    }

    if ($themes_table) {
        // Check of deleted_at kolom bestaat
        $columns = $wpdb->get_col("SHOW COLUMNS FROM {$themes_table}");
        $has_deleted = in_array('deleted_at', $columns);
        $where = $has_deleted ? "WHERE deleted_at IS NULL" : "";
        $themes = $wpdb->get_results("SELECT id, name FROM {$themes_table} {$where} ORDER BY name ASC", ARRAY_A);
    }

    if ($meals_table) {
        // Check of deleted_at kolom bestaat
        $columns = $wpdb->get_col("SHOW COLUMNS FROM {$meals_table}");
        $has_deleted = in_array('deleted_at', $columns);
        $where = $has_deleted ? "WHERE deleted_at IS NULL" : "";
        $meals = $wpdb->get_results("SELECT id, name FROM {$meals_table} {$where} ORDER BY name ASC", ARRAY_A);
    }

    // Debug logging
    if (defined('WP_DEBUG') && WP_DEBUG && current_user_can('manage_options')) {
        if (count($themes) > 0) {
        }
    }

    ob_start();
    ?>

    <!-- üö® ADMIN DEBUG DISABLED - Filters werken prima zonder debug meldingen -->

    <div id="shorttrips-filters" class="st-filters-container" style="display:none;">
        <div class="st-filters-grid">
            <!-- STERREN -->
            <div class="st-filter-group">
                <label class="st-filter-label">Min sterren</label>
                <select name="minStars" id="filter-min-stars" class="st-filter-select">
                    <option value="">-</option>
                    <option value="1">1 ster</option>
                    <option value="2">2 sterren</option>
                    <option value="3">3 sterren</option>
                    <option value="4">4 sterren</option>
                    <option value="5">5 sterren</option>
                </select>
            </div>

            <div class="st-filter-group">
                <label class="st-filter-label">Max sterren</label>
                <select name="maxStars" id="filter-max-stars" class="st-filter-select">
                    <option value="">-</option>
                    <option value="1">1 ster</option>
                    <option value="2">2 sterren</option>
                    <option value="3">3 sterren</option>
                    <option value="4">4 sterren</option>
                    <option value="5">5 sterren</option>
                </select>
            </div>

            <!-- PRIJS -->
            <div class="st-filter-group">
                <label class="st-filter-label">Min prijs (‚Ç¨)</label>
                <input type="number" name="minPrice" id="filter-min-price" class="st-filter-input" placeholder="0" min="0"
                    step="10">
            </div>

            <div class="st-filter-group">
                <label class="st-filter-label">Max prijs (‚Ç¨)</label>
                <input type="number" name="maxPrice" id="filter-max-price" class="st-filter-input" placeholder="1000"
                    min="0" step="10">
            </div>

            <!-- FEATURES (Custom Dropdown met Checkboxes) -->
            <div class="st-filter-group">
                <label class="st-filter-label">Features</label>
                <div class="st-custom-dropdown" id="features-dropdown">
                    <div class="st-dropdown-trigger">
                        <span class="st-dropdown-label">‚Äî kies ‚Äî</span>
                        <span class="st-dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="st-dropdown-menu">
                        <?php if (!empty($features)): ?>
                            <?php foreach ($features as $feature): ?>
                                <label class="st-dropdown-option">
                                    <input type="checkbox" name="featureIds[]" value="<?php echo esc_attr($feature['id']); ?>">
                                    <span><?php echo esc_html($feature['name']); ?></span>
                                </label>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <div class="st-dropdown-empty">Geen features beschikbaar</div>
                        <?php endif; ?>
                    </div>
                </div>
                <?php if (empty($features) && current_user_can('manage_options')): ?>
                    <small style="color:#dc2626;font-size:11px;">‚ö†Ô∏è Sync features eerst</small>
                <?php endif; ?>
            </div>

            <!-- THEMES (Custom Dropdown met Checkboxes) -->
            <div class="st-filter-group">
                <label class="st-filter-label">Themes</label>
                <div class="st-custom-dropdown" id="themes-dropdown">
                    <div class="st-dropdown-trigger">
                        <span class="st-dropdown-label">‚Äî kies ‚Äî</span>
                        <span class="st-dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="st-dropdown-menu">
                        <?php if (!empty($themes)): ?>
                            <?php foreach ($themes as $theme): ?>
                                <label class="st-dropdown-option">
                                    <input type="checkbox" name="themeIds[]" value="<?php echo esc_attr($theme['id']); ?>">
                                    <span><?php echo esc_html(ucfirst(str_replace('-', ' ', $theme['name']))); ?></span>
                                </label>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <div class="st-dropdown-empty">Geen themes beschikbaar</div>
                        <?php endif; ?>
                    </div>
                </div>
                <?php if (empty($themes) && current_user_can('manage_options')): ?>
                    <small style="color:#dc2626;font-size:11px;">‚ö†Ô∏è Geen themes gevonden</small>
                <?php endif; ?>
            </div>

            <!-- MEALS (Custom Dropdown met Checkboxes) -->
            <div class="st-filter-group">
                <label class="st-filter-label">Board (meals)</label>
                <div class="st-custom-dropdown" id="meals-dropdown">
                    <div class="st-dropdown-trigger">
                        <span class="st-dropdown-label">‚Äî kies ‚Äî</span>
                        <span class="st-dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="st-dropdown-menu">
                        <?php if (!empty($meals)): ?>
                            <?php foreach ($meals as $meal): ?>
                                <label class="st-dropdown-option">
                                    <input type="checkbox" name="mealIds[]" value="<?php echo esc_attr($meal['id']); ?>">
                                    <span><?php echo esc_html($meal['name']); ?></span>
                                </label>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <div class="st-dropdown-empty">Nog niet beschikbaar</div>
                        <?php endif; ?>
                    </div>
                </div>
                <?php if (empty($meals) && current_user_can('manage_options')): ?>
                    <small style="color:#dc2626;font-size:11px;">‚ö†Ô∏è Tabel is nog leeg</small>
                <?php endif; ?>
            </div>

            <!-- CHECKBOXES -->
            <div class="st-filter-group st-filter-checkboxes">
                <label class="st-filter-checkbox">
                    <input type="checkbox" name="excludeSharedRooms" id="filter-no-shared-rooms" value="1">
                    <span>Geen gedeelde kamers</span>
                </label>
                <label class="st-filter-checkbox">
                    <input type="checkbox" name="excludeSharedFacilities" id="filter-no-shared-facilities" value="1">
                    <span>Geen gedeelde faciliteiten</span>
                </label>
            </div>
        </div>

        <!-- BUTTONS -->
        <div class="st-filters-actions">
            <button type="button" id="st-reset-filters" class="st-btn st-btn-secondary">
                ‚Üª Reset alle filters
            </button>
            <button type="button" id="st-apply-filters" class="st-btn st-btn-primary">
                ‚úì Filters toepassen
            </button>
        </div>
    </div>

    <script>
        (function () {
            var filtersContainer = document.getElementById('shorttrips-filters');
            var searchParams = {};

            // Cache inline sidebar reference (indien aanwezig in hotels page)
            var inlineSidebar = document.getElementById('st-inline-filters');
            var inlineWrapper = inlineSidebar ? inlineSidebar.querySelector('[data-st-filters-root]') : null;
            var isInlineMode = inlineSidebar && inlineWrapper && inlineWrapper.contains(filtersContainer);

            // === SHOW FILTERS AFTER SEARCH RESULTS ===
            function showFiltersWhenResultsLoaded() {
                // Check 1: Zijn er URL parameters die duiden op een zoekopdracht?
                var urlParams = new URLSearchParams(window.location.search);
                var hasSearchParams = urlParams.has('action') && urlParams.get('action') === 'shorttrips_search_hotels';
                hasSearchParams = hasSearchParams || urlParams.has('type') || urlParams.has('resort') || urlParams.has('country');

                // Check 2: Zijn er visuele zoekresultaten op de pagina?
                // BELANGRIJK: Negeer bestemmingen pagina (st-popular-destinations)
                var resultsContainers = [
                    '#st-results',
                    '.st-search-results',
                    '.st-hotel-grid',
                    '[data-search-results]',
                    '.hotel-results',
                    '.search-results-container'
                ];

                var hasVisibleResults = false;
                for (var i = 0; i < resultsContainers.length; i++) {
                    var container = document.querySelector(resultsContainers[i]);
                    if (container && container.children.length > 0) {
                        // Extra check: heeft de container ook echt hotel SEARCH results?
                        var hotelCards = container.querySelectorAll('.st-hotel-card[data-hotel-id]');
                        if (hotelCards.length > 0) {
                            hasVisibleResults = true;
                            console.log('‚úÖ ShortTrips Filters: Found search results in:', resultsContainers[i]);
                            break;
                        }
                    }
                }

                // Check 3: Staat het filters-widget daadwerkelijk op de pagina?
                var hasFiltersWidget = document.querySelector('[data-st-filters-root]') !== null;

                // TOON filters ALLEEN als er ECHTE search results zijn (niet op basis van localStorage)
                // Dit voorkomt dat filters verschijnen op bestemmingen pagina
                if (isInlineMode) {
                    filtersContainer.style.display = 'block';
                    return;
                }

                if ((hasSearchParams || hasVisibleResults) && hasFiltersWidget) {
                    filtersContainer.style.display = 'block';
                    if (inlineSidebar) {
                        inlineSidebar.style.display = 'block';
                    }
                    if (inlineWrapper) {
                        inlineWrapper.style.display = 'block';
                    }
                    console.log('‚úÖ ShortTrips Filters: Showing filters (searchParams:', hasSearchParams, ', visibleResults:', hasVisibleResults, ')');
                } else {
                    filtersContainer.style.display = 'none';
                    if (inlineSidebar) {
                        inlineSidebar.style.display = 'none';
                    }
                    if (inlineWrapper) {
                        inlineWrapper.style.display = 'none';
                    }
                    console.log('‚ö†Ô∏è ShortTrips Filters: Hiding filters - no active search detected');
                }
            }

            // Check bij laden
            document.addEventListener('DOMContentLoaded', function () {
                // Initial check
                setTimeout(showFiltersWhenResultsLoaded, 100); // Small delay to let content load

                // Check again after 500ms (for AJAX loaded content)
                setTimeout(showFiltersWhenResultsLoaded, 500);

                // Ook checken na AJAX calls (MutationObserver)
                var observer = new MutationObserver(function () {
                    showFiltersWhenResultsLoaded();
                });

                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
            });

            // Functie om search params op te halen uit verschillende bronnen
            function getSearchParams() {
                var params = {};

                // PRIORITEIT 0: Payload element uit laatste zoekresultaat (meest betrouwbaar)
                var payloadEl = document.getElementById('st-search-payload');
                if (payloadEl) {
                    var payloadData = payloadEl.getAttribute('data-payload');
                    if (payloadData) {
                        try {
                            var parsedPayload = JSON.parse(payloadData);
                            if (parsedPayload && Object.keys(parsedPayload).length > 0) {
                                console.log('ShortTrips Filters: Loaded params from payload element:', parsedPayload);
                                sessionStorage.setItem('st_last_search', JSON.stringify(parsedPayload));
                                return parsedPayload;
                            }
                        } catch (e) {
                            console.error('ShortTrips Filters: Error parsing payload element:', e);
                        }
                    }
                }

                // PRIORITEIT 1: URL parameters
                var urlParams = new URLSearchParams(window.location.search);
                urlParams.forEach(function (value, key) {
                    params[key] = value;
                });

                if (Object.keys(params).length > 0) {
                    console.log('ShortTrips Filters: Loaded params from URL:', params);
                    sessionStorage.setItem('st_last_search', JSON.stringify(params));
                    return params;
                }

                // PRIORITEIT 2: Recent search uit localStorage (van zoekformulier)
                try {
                    var recentSearches = localStorage.getItem('shorttrips_recent_searches');
                    if (recentSearches) {
                        var searches = JSON.parse(recentSearches);
                        if (searches.length > 0) {
                            var lastSearch = searches[0];
                            params = {
                                type: lastSearch.type || 'search',
                                checkin: lastSearch.checkin,
                                checkout: lastSearch.checkout,
                                rooms: lastSearch.rooms || 1,
                                adults: lastSearch.adults || 2,
                                children: lastSearch.children || 0
                            };

                            if (lastSearch.resort) {
                                params.resort = lastSearch.resort;
                                params.type = 'resort';
                            }
                            if (lastSearch.country) {
                                params.country = lastSearch.country;
                            }
                            if (lastSearch.q) {
                                params.q = lastSearch.q;
                                params.type = 'search';
                            }

                            console.log('ShortTrips Filters: Loaded params from recent search:', params);
                            sessionStorage.setItem('st_last_search', JSON.stringify(params));
                            return params;
                        }
                    }
                } catch (e) {
                    console.error('ShortTrips Filters: Error loading recent searches:', e);
                }

                // PRIORITEIT 3: SessionStorage fallback
                try {
                    var stored = sessionStorage.getItem('st_last_search');
                    if (stored) {
                        params = JSON.parse(stored);
                        console.log('ShortTrips Filters: Loaded params from sessionStorage:', params);
                        return params;
                    }
                } catch (e) {
                    console.error('ShortTrips Filters: Error loading from sessionStorage:', e);
                }

                console.warn('ShortTrips Filters: No search params found!');
                return {};
            }

            // Haal search parameters op
            searchParams = getSearchParams();

            // Apply filters button
            document.getElementById('st-apply-filters').addEventListener('click', function () {
                applyFilters();
            });

            // Reset filters button
            document.getElementById('st-reset-filters').addEventListener('click', function () {
                resetFilters();
            });

            function filterResultsClientSide(filters) {
                var minStars = parseFloat(filters.minStars) || 0;
                var maxStars = parseFloat(filters.maxStars) || 0;
                var minPrice = parseFloat(filters.minPrice) || 0;
                var maxPrice = parseFloat(filters.maxPrice) || 0;

                var cards = document.querySelectorAll('#st-results .st-hotel-card');
                if (!cards.length) {
                    return;
                }

                var visible = 0;
                cards.forEach(function (card) {
                    var stars = parseFloat(card.getAttribute('data-stars') || '0');
                    var price = parseFloat(card.getAttribute('data-price') || '0');

                    var matches = true;
                    if (minStars) matches = matches && stars >= minStars;
                    if (maxStars) matches = matches && stars <= maxStars;
                    if (minPrice) matches = matches && (price > 0 ? price >= minPrice : false);
                    if (maxPrice) matches = matches && (price > 0 ? price <= maxPrice : false);

                    if (matches) {
                        card.style.display = '';
                        visible++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                var countEl = document.querySelector('#st-results .st-results-count span');
                if (countEl) {
                    countEl.textContent = visible;
                }

                var noResultsMsg = document.getElementById('st-filter-no-results');
                if (visible === 0) {
                    if (!noResultsMsg) {
                        noResultsMsg = document.createElement('div');
                        noResultsMsg.id = 'st-filter-no-results';
                        noResultsMsg.style.padding = '24px';
                        noResultsMsg.style.marginTop = '16px';
                        noResultsMsg.style.background = '#fee2e2';
                        noResultsMsg.style.border = '1px solid #fecaca';
                        noResultsMsg.style.borderRadius = '10px';
                        noResultsMsg.style.color = '#991b1b';
                        noResultsMsg.style.fontWeight = '600';
                        noResultsMsg.textContent = 'Geen hotels gevonden voor deze filterinstellingen.';
                        var resultsContainer = document.querySelector('#st-results');
                        if (resultsContainer) {
                            resultsContainer.appendChild(noResultsMsg);
                        }
                    }
                } else if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            }

            function applyFilters() {
                // Get all filter values
                var filters = {
                    minStars: document.getElementById('filter-min-stars').value,
                    maxStars: document.getElementById('filter-max-stars').value,
                    minPrice: document.getElementById('filter-min-price').value,
                    maxPrice: document.getElementById('filter-max-price').value,
                    excludeSharedRooms: document.getElementById('filter-no-shared-rooms').checked ? '1' : '',
                    excludeSharedFacilities: document.getElementById('filter-no-shared-facilities').checked ? '1' : ''
                };

                // Get multi-select values from custom dropdowns (checkboxes)
                var selectedFeatures = Array.from(document.querySelectorAll('#features-dropdown input[type="checkbox"]:checked'))
                    .map(cb => cb.value);

                var selectedThemes = Array.from(document.querySelectorAll('#themes-dropdown input[type="checkbox"]:checked'))
                    .map(cb => cb.value);

                var selectedMeals = Array.from(document.querySelectorAll('#meals-dropdown input[type="checkbox"]:checked'))
                    .map(cb => cb.value);

                // Build FormData for AJAX request
                var formData = new FormData();
                formData.append('action', 'shorttrips_search_hotels');

                console.log('ShortTrips Filters: Search params object:', searchParams);

                // Add existing search parameters - ALLE parameters behalve filter-specifieke
                for (var key in searchParams) {
                    if (searchParams.hasOwnProperty(key)) {
                        // Skip only filter-related parameters (we add those fresh from the form)
                        if (key !== 'action' && key !== 'minStars' && key !== 'maxStars' &&
                            key !== 'minPrice' && key !== 'maxPrice' && key !== 'featureIds' &&
                            key !== 'themeIds' && key !== 'mealIds' && key !== 'excludeSharedRooms' &&
                            key !== 'excludeSharedFacilities') {
                            console.log('ShortTrips Filters: Adding param:', key, '=', searchParams[key]);
                            formData.append(key, searchParams[key]);
                        }
                    }
                }

                // Add filter parameters
                if (filters.minStars) formData.append('minStars', filters.minStars);
                if (filters.maxStars) formData.append('maxStars', filters.maxStars);
                if (filters.minPrice) formData.append('minPrice', filters.minPrice);
                if (filters.maxPrice) formData.append('maxPrice', filters.maxPrice);
                if (filters.excludeSharedRooms) formData.append('excludeSharedRooms', '1');
                if (filters.excludeSharedFacilities) formData.append('excludeSharedFacilities', '1');

                // Add multi-select arrays
                selectedFeatures.forEach(function (id) {
                    formData.append('featureIds[]', id);
                });
                selectedThemes.forEach(function (id) {
                    formData.append('themeIds[]', id);
                });
                selectedMeals.forEach(function (id) {
                    formData.append('mealIds[]', id);
                });

                console.log('ShortTrips Filters: Final FormData being sent:');
                for (var pair of formData.entries()) {
                    console.log(pair[0] + ': ' + pair[1]);
                }

                // Show loading
                var resultsDiv = document.getElementById('st-results');
                if (resultsDiv) {
                    resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div><p class="mt-4 text-gray-600">Filters toepassen...</p></div>';

                    // Scroll to results
                    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                // Make AJAX request
                fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                })
                    .then(function (r) { return r.text(); })
                    .then(function (html) {
                        if (resultsDiv) {
                            resultsDiv.innerHTML = html;
                            filterResultsClientSide(filters);
                        }
                    })
                    .catch(function (err) {
                        console.error('Filter error:', err);
                        if (resultsDiv) {
                            resultsDiv.innerHTML = '<div class="text-center py-8 text-red-600"><p>‚ùå Er ging iets mis. Probeer het opnieuw.</p></div>';
                        }
                    });
            }

            function resetFilters() {
                // Reset all form fields
                document.getElementById('filter-min-stars').value = '';
                document.getElementById('filter-max-stars').value = '';
                document.getElementById('filter-min-price').value = '';
                document.getElementById('filter-max-price').value = '';

                // Reset checkboxen in custom dropdowns
                var allCheckboxes = filtersContainer.querySelectorAll('.st-custom-dropdown input[type="checkbox"]');
                allCheckboxes.forEach(function (cb) {
                    cb.checked = false;
                });

                // Reset labels
                var allLabels = filtersContainer.querySelectorAll('.st-dropdown-label');
                allLabels.forEach(function (label) {
                    label.textContent = '‚Äî kies ‚Äî';
                });

                document.getElementById('filter-no-shared-rooms').checked = false;
                document.getElementById('filter-no-shared-facilities').checked = false;

                // Re-apply search without filters
                applyFilters();
            }

            // Load filter values from searchParams if present
            if (searchParams.minStars) {
                document.getElementById('filter-min-stars').value = searchParams.minStars;
            }
            if (searchParams.maxStars) {
                document.getElementById('filter-max-stars').value = searchParams.maxStars;
            }
            if (searchParams.minPrice) {
                document.getElementById('filter-min-price').value = searchParams.minPrice;
            }
            if (searchParams.maxPrice) {
                document.getElementById('filter-max-price').value = searchParams.maxPrice;
            }
            if (searchParams.excludeSharedRooms) {
                document.getElementById('filter-no-shared-rooms').checked = true;
            }
            if (searchParams.excludeSharedFacilities) {
                document.getElementById('filter-no-shared-facilities').checked = true;
            }

            // ==========================================
            // CUSTOM DROPDOWN FUNCTIONALITEIT
            // ==========================================

            // Sluit alle dropdowns
            function closeAllDropdowns() {
                var allDropdowns = document.querySelectorAll('.st-custom-dropdown');
                allDropdowns.forEach(function (dropdown) {
                    dropdown.classList.remove('open');
                });
            }

            // Toggle dropdown open/close
            var dropdownTriggers = document.querySelectorAll('.st-dropdown-trigger');
            dropdownTriggers.forEach(function (trigger) {
                trigger.addEventListener('click', function (e) {
                    e.stopPropagation();
                    var dropdown = this.parentElement;
                    var wasOpen = dropdown.classList.contains('open');

                    // Sluit alle dropdowns eerst
                    closeAllDropdowns();

                    // Open deze als hij gesloten was
                    if (!wasOpen) {
                        dropdown.classList.add('open');
                    }
                });
            });

            // Update label wanneer checkboxen worden aangeklikt
            var dropdownCheckboxes = document.querySelectorAll('.st-custom-dropdown input[type="checkbox"]');
            dropdownCheckboxes.forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    var dropdown = this.closest('.st-custom-dropdown');
                    var label = dropdown.querySelector('.st-dropdown-label');
                    var checkedBoxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');

                    if (checkedBoxes.length === 0) {
                        label.textContent = '‚Äî kies ‚Äî';
                    } else if (checkedBoxes.length === 1) {
                        label.textContent = checkedBoxes[0].nextElementSibling.textContent;
                    } else {
                        label.textContent = checkedBoxes.length + ' geselecteerd';
                    }
                });
            });

            // Sluit dropdowns bij klik buiten
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.st-custom-dropdown')) {
                    closeAllDropdowns();
                }
            });

            // Voorkom dat dropdown sluit bij klik op optie
            var dropdownOptions = document.querySelectorAll('.st-dropdown-option');
            dropdownOptions.forEach(function (option) {
                option.addEventListener('click', function (e) {
                    e.stopPropagation();
                    // Checkbox wordt automatisch getriggered
                });
            });

        })();
    </script>

    <style>
        .st-filters-container {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            padding: 16px 20px 8px 20px;
            margin: 20px 0 28px 0;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        }

        .st-filters-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 18px;
            margin-bottom: 12px;
            align-items: flex-end;
        }

        .st-filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1 1 180px;
            min-width: 160px;
        }

        .st-filter-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #94a3b8;
        }

        .st-filter-select,
        .st-filter-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5f5;
            border-radius: 12px;
            font-size: 14px;
            background: #f8fafc;
            color: #0f172a;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            min-height: 44px;
        }

        .st-filter-select:focus,
        .st-filter-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        /* CUSTOM DROPDOWN STYLING */
        .st-custom-dropdown {
            position: relative;
            width: 100%;
        }

        .st-dropdown-trigger {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #cbd5f5;
            border-radius: 12px;
            font-size: 14px;
            background: #f8fafc;
            color: #0f172a;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            min-height: 44px;
        }

        .st-dropdown-trigger:hover {
            border-color: #94a3b8;
        }

        .st-custom-dropdown.open .st-dropdown-trigger {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        .st-dropdown-label {
            flex: 1;
            color: #64748b;
        }

        .st-custom-dropdown.open .st-dropdown-label {
            color: #0f172a;
        }

        .st-dropdown-arrow {
            font-size: 12px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .st-custom-dropdown.open .st-dropdown-arrow {
            transform: rotate(180deg);
        }

        .st-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .st-custom-dropdown.open .st-dropdown-menu {
            display: block;
        }

        .st-dropdown-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 14px;
            color: #1f2937;
        }

        .st-dropdown-option:hover {
            background: #f3f4f6;
        }

        .st-dropdown-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            margin: 0;
        }

        .st-dropdown-option span {
            flex: 1;
            user-select: none;
        }

        .st-dropdown-empty {
            padding: 12px;
            text-align: center;
            color: #9ca3af;
            font-size: 13px;
            font-style: italic;
        }

        .st-filter-checkboxes {
            flex-direction: row;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .st-filter-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #374151;
        }

        .st-filter-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .st-filters-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: flex-start;
            border-top: 1px solid #e2e8f0;
            padding-top: 12px;
            margin-top: 4px;
        }

        .st-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            min-width: 170px;
            text-align: center;
        }

        .st-btn-primary {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 24px;
        }

        .st-btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }

        .st-btn-secondary {
            background: #f1f5f9;
            border: 1px solid #cbd5f5;
            color: #0f172a;
            padding: 8px 18px;
            font-size: 13px;
        }

        .st-btn-secondary:hover {
            border-color: #94a3b8;
            color: #0f172a;
            background: #e2e8f0;
        }

        @media (max-width: 768px) {
            .st-filters-grid {
                grid-template-columns: 1fr 1fr;
            }

            .st-filter-checkboxes {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 480px) {
            .st-filters-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <?php
    return ob_get_clean();
});




/**
 * ============================================================================
 * COMPLETE LOOKUP SYNC ENDPOINTS - ALLE TABELLEN
 * ============================================================================
 * 
 * Voeg dit toe aan EINDE van functions.php
 * Gebruikt template_redirect voor directe output
 * 
 * ============================================================================
 */

// Helper function voor debugging
if (!function_exists('sync_debug_log')) {
    function sync_debug_log($message)
    {
        echo $message . "\n";
        flush();
    }
}

// -----------------------------------------------------------------------------
// 1. FEATURES SYNC - /?sync_features=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['sync_features']) || $_GET['sync_features'] !== '1') {
        return;
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed - Please log in as WordPress admin first');
    }

    nocache_headers();
    while (ob_get_level())
        ob_end_clean();

    @set_time_limit(300);
    @ini_set('memory_limit', '512M');

    header('Content-Type: text/plain; charset=utf-8');
    echo "=== FEATURES SYNC ===\n\n";

    global $wpdb;

    // Check if function exists
    if (!function_exists('shorttrips_get_api_credentials')) {
        echo "‚ùå Error: shorttrips_get_api_credentials() function not found\n";
        echo "Make sure this code is in functions.php, not a separate file!\n";
        exit;
    }

    $creds = shorttrips_get_api_credentials();
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

    echo "üîë API Username: " . $creds['username'] . "\n";
    echo "üåê Endpoint: $endpoint\n\n";

    // Create table
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_features (
      id INT PRIMARY KEY,
      name VARCHAR(500),
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  )");

    echo "üîÑ Calling GetFeatures API...\n";
    flush();

    $soap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<GetFeatures xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>' . esc_html($creds['username']) . '</userName>'
        . '<password>' . esc_html($creds['password']) . '</password>'
        . '<language>' . esc_html($creds['language']) . '</language>'
        . '</GetFeatures>'
        . '</soap:Body>'
        . '</soap:Envelope>';

    $startTime = microtime(true);
    $r = wp_remote_post($endpoint, [
        'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetFeatures"'],
        'body' => $soap,
        'timeout' => 120
    ]);
    $duration = round(microtime(true) - $startTime, 2);

    echo "‚è±Ô∏è  API call completed in {$duration}s\n";

    $updated = 0;
    if (is_wp_error($r)) {
        echo "‚ùå API Error: " . $r->get_error_message() . "\n";
    } elseif (empty($r['body'])) {
        echo "‚ùå Empty API response\n";
    } else {
        echo "üìä Response size: " . number_format(strlen($r['body'])) . " bytes\n";
        echo "üîÑ Parsing XML...\n";

        libxml_use_internal_errors(true);
        $sx = @simplexml_load_string($r['body']);

        if (!$sx) {
            echo "‚ùå XML parsing failed\n";
            $errors = libxml_get_errors();
            if ($errors) {
                echo "XML Error: " . $errors[0]->message . "\n";
            }
        } else {
            echo "‚úÖ XML parsed successfully\n";
            $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
            $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

            // Try multiple XPath patterns
            $patterns = [
                '//soap:Body//sh:getFeaturesResult//sh:features//sh:feature',
                '//getFeaturesResult//features//feature',
                '//features//feature',
                '//feature'
            ];

            $nodes = null;
            foreach ($patterns as $pattern) {
                $nodes = $sx->xpath($pattern);
                if ($nodes && count($nodes) > 0) {
                    echo "üîç Found " . count($nodes) . " features with XPath: $pattern\n";
                    break;
                }
            }

            if (!$nodes || count($nodes) === 0) {
                echo "‚ö†Ô∏è  No feature nodes found with any XPath pattern\n";
                echo "üìÑ Sample of response (first 500 chars):\n";
                echo substr($r['body'], 0, 500) . "...\n";
            } else {
                echo "üîÑ Processing features...\n";
                foreach ($nodes as $n) {
                    $id = intval((string) ($n->id ?? $n->Id ?? ''));
                    $name = trim((string) ($n->name ?? $n->Name ?? ''));

                    if ($id > 0 && $name !== '') {
                        $result = $wpdb->query($wpdb->prepare(
                            "REPLACE INTO ghwk_features (id, name, updated_at) VALUES (%d, %s, NOW())",
                            $id,
                            $name
                        ));
                        if ($result !== false) {
                            $updated++;
                        }
                    }
                }
            }
        }
    }

    $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_features");
    echo "\n‚úÖ Features synced: $updated\n";
    echo "üìä Total features in database: $total\n";

    // Show sample
    if ($total > 0) {
        $samples = $wpdb->get_results("SELECT id, name FROM ghwk_features ORDER BY id LIMIT 5", ARRAY_A);
        echo "\nüìã Sample features:\n";
        foreach ($samples as $s) {
            echo "  - ID {$s['id']}: {$s['name']}\n";
        }
    }

    exit;
});

// -----------------------------------------------------------------------------
// 2. THEMES SYNC - /?sync_themes=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['sync_themes']) || $_GET['sync_themes'] !== '1') {
        return;
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed');
    }

    nocache_headers();
    while (ob_get_level())
        ob_end_clean();

    @set_time_limit(300);
    @ini_set('memory_limit', '512M');

    header('Content-Type: text/plain; charset=utf-8');
    echo "=== THEMES SYNC ===\n\n";

    global $wpdb;
    $creds = shorttrips_get_api_credentials();
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_themes (
      id INT PRIMARY KEY,
      name VARCHAR(500),
      image VARCHAR(500),
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  )");

    echo "üîÑ Calling GetThemes API...\n";
    flush();

    $soap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<GetThemes xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>' . esc_html($creds['username']) . '</userName>'
        . '<password>' . esc_html($creds['password']) . '</password>'
        . '<language>' . esc_html($creds['language']) . '</language>'
        . '</GetThemes>'
        . '</soap:Body>'
        . '</soap:Envelope>';

    $r = wp_remote_post($endpoint, [
        'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetThemes"'],
        'body' => $soap,
        'timeout' => 120
    ]);

    $updated = 0;
    if (!is_wp_error($r) && !empty($r['body'])) {
        echo "üìä Response received: " . number_format(strlen($r['body'])) . " bytes\n";

        $sx = @simplexml_load_string($r['body']);
        if ($sx) {
            $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
            $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

            $patterns = [
                '//soap:Body//sh:getThemesResult//sh:themes//sh:theme',
                '//getThemesResult//themes//theme',
                '//themes//theme',
                '//theme'
            ];

            $nodes = null;
            foreach ($patterns as $pattern) {
                $nodes = $sx->xpath($pattern);
                if ($nodes && count($nodes) > 0) {
                    echo "üîç Found " . count($nodes) . " themes\n";
                    break;
                }
            }

            if ($nodes) {
                foreach ($nodes as $n) {
                    $id = intval((string) ($n->id ?? $n->Id ?? ''));
                    $name = trim((string) ($n->name ?? $n->Name ?? ''));
                    $img = trim((string) ($n->image ?? $n->Image ?? ''));

                    if ($id > 0 && $name !== '') {
                        $wpdb->query($wpdb->prepare(
                            "REPLACE INTO ghwk_themes (id, name, image, updated_at) VALUES (%d, %s, %s, NOW())",
                            $id,
                            $name,
                            $img
                        ));
                        $updated++;
                    }
                }
            }
        }
    }

    $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_themes");
    echo "‚úÖ Themes synced: $updated\n";
    echo "üìä Total themes: $total\n";

    exit;
});

// -----------------------------------------------------------------------------
// 3. OLD MEALS SYNC - COMMENTED OUT (replaced by FIXED version at line 14302)
// -----------------------------------------------------------------------------
/*
add_action('template_redirect', function() {
  if (!isset($_GET['sync_meals']) || $_GET['sync_meals'] !== '1') {
      return;
  }
  
  if (!is_user_logged_in() || !current_user_can('manage_options')) {
      status_header(403);
      exit('Not allowed');
  }
  
  nocache_headers();
  while (ob_get_level()) ob_end_clean();
  
  @set_time_limit(300);
  @ini_set('memory_limit', '512M');
  
  header('Content-Type: text/plain; charset=utf-8');
  echo "=== MEALS SYNC ===\n\n";
  
  global $wpdb;
  $creds = shorttrips_get_api_credentials();
  $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';
  
  $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_meals (
      id INT PRIMARY KEY,
      name VARCHAR(500),
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  )");
  
  echo "üîÑ Calling GetMeals API...\n";
  flush();
  
  $soap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<GetMeals xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>'.esc_html($creds['username']).'</userName>'
        . '<password>'.esc_html($creds['password']).'</password>'
        . '<language>'.esc_html($creds['language']).'</language>'
        . '</GetMeals>'
        . '</soap:Body>'
        . '</soap:Envelope>';
  
  $r = wp_remote_post($endpoint, [
      'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetMeals"'],
      'body' => $soap,
      'timeout' => 120
  ]);
  
  $updated = 0;
  if (!is_wp_error($r) && !empty($r['body'])) {
      echo "üìä Response received\n";
      
      $sx = @simplexml_load_string($r['body']);
      if ($sx) {
          $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
          $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
          
          $patterns = [
              '//soap:Body//sh:getMealsResult//sh:meals//sh:meal',
              '//getMealsResult//meals//meal',
              '//meals//meal',
              '//meal'
          ];
          
          $nodes = null;
          foreach ($patterns as $pattern) {
              $nodes = $sx->xpath($pattern);
              if ($nodes && count($nodes) > 0) {
                  echo "üîç Found " . count($nodes) . " meals\n";
                  break;
              }
          }
          
          if ($nodes) {
              foreach ($nodes as $n) {
                  $id = intval((string)($n->id ?? $n->Id ?? ''));
                  $name = trim((string)($n->name ?? $n->Name ?? ''));
                  
                  if ($id > 0 && $name !== '') {
                      $wpdb->query($wpdb->prepare(
                          "REPLACE INTO ghwk_meals (id, name, updated_at) VALUES (%d, %s, NOW())",
                          $id, $name
                      ));
                      $updated++;
                  }
              }
          }
      }
  }
  
  $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_meals");
  echo "‚úÖ Meals synced: $updated\n";
  echo "üìä Total meals: $total\n";
  
  exit;
});
*/

// -----------------------------------------------------------------------------
// 4. LANGUAGES SYNC - /?sync_languages=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['sync_languages']) || $_GET['sync_languages'] !== '1') {
        return;
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed');
    }

    nocache_headers();
    while (ob_get_level())
        ob_end_clean();

    @set_time_limit(300);
    @ini_set('memory_limit', '512M');

    header('Content-Type: text/plain; charset=utf-8');
    echo "=== LANGUAGES SYNC ===\n\n";

    global $wpdb;
    $creds = shorttrips_get_api_credentials();
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_languages (
      id INT PRIMARY KEY,
      name VARCHAR(500),
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  )");

    echo "üîÑ Calling GetLanguages API...\n";
    flush();

    $soap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<GetLanguages xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>' . esc_html($creds['username']) . '</userName>'
        . '<password>' . esc_html($creds['password']) . '</password>'
        . '<language>' . esc_html($creds['language']) . '</language>'
        . '</GetLanguages>'
        . '</soap:Body>'
        . '</soap:Envelope>';

    $r = wp_remote_post($endpoint, [
        'headers' => ['Content-Type' => 'text/xml; charset=utf-8', 'SOAPAction' => '"http://xml.sunhotels.net/15/GetLanguages"'],
        'body' => $soap,
        'timeout' => 120
    ]);

    $updated = 0;
    if (!is_wp_error($r) && !empty($r['body'])) {
        echo "üìä Response received\n";

        $sx = @simplexml_load_string($r['body']);
        if ($sx) {
            $sx->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
            $sx->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

            $patterns = [
                '//soap:Body//sh:getLanguagesResult//sh:languages//sh:language',
                '//getLanguagesResult//languages//language',
                '//languages//language',
                '//language'
            ];

            $nodes = null;
            foreach ($patterns as $pattern) {
                $nodes = $sx->xpath($pattern);
                if ($nodes && count($nodes) > 0) {
                    echo "üîç Found " . count($nodes) . " languages\n";
                    break;
                }
            }

            if ($nodes) {
                foreach ($nodes as $n) {
                    $id = intval((string) ($n->id ?? $n->Id ?? ''));
                    $name = trim((string) ($n->name ?? $n->Name ?? ''));

                    if ($id > 0 && $name !== '') {
                        $wpdb->query($wpdb->prepare(
                            "REPLACE INTO ghwk_languages (id, name, updated_at) VALUES (%d, %s, NOW())",
                            $id,
                            $name
                        ));
                        $updated++;
                    }
                }
            }
        }
    }

    $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_languages");
    echo "‚úÖ Languages synced: $updated\n";
    echo "üìä Total languages: $total\n";

    exit;
});

// -----------------------------------------------------------------------------
// 5. ROOM NOTE TYPES - /?sync_room_note_types=1
// OLD SYNC CODE REMOVED - DEBUG VERSION BELOW WILL BE USED


/**
 * ============================================================================
 * OLD DB DEBUG CODE REMOVED - XML STRUCTURE DEBUG BELOW WILL BE USED
 * ============================================================================
 */

// OLD CODE COMMENTED OUT - SEE XML STRUCTURE DEBUG VERSION BELOW

/*
// OLD: ROOM NOTE TYPES SYNC - WITH DB DEBUGGING (REMOVED)
add_action('template_redirect', function() {
  if (!isset($_GET['sync_room_note_types']) || $_GET['sync_room_note_types'] !== '1') {
      return;
  }

  if (!is_user_logged_in() || !current_user_can('manage_options')) {
      status_header(403);
      exit('Not allowed');
  }

  nocache_headers();
  while (ob_get_level()) ob_end_clean();

  @set_time_limit(300);
  @ini_set('memory_limit', '512M');

  header('Content-Type: text/plain; charset=utf-8');
  echo "=== ROOM NOTE TYPES SYNC (WITH DB DEBUG) ===\n\n";

  global $wpdb;

  // Show DB errors
  $wpdb->show_errors();

  echo "üìä Database info:\n";
  echo "  - DB Name: " . DB_NAME . "\n";
  echo "  - Table prefix: " . $wpdb->prefix . "\n";
  echo "  - Charset: " . $wpdb->charset . "\n\n";

  // Create table
  echo "üîß Creating table ghwk_room_note_types...\n";
  $createResult = $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_note_types (
      id INT PRIMARY KEY,
      name VARCHAR(500),
      description TEXT,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  )");

  if ($createResult === false) {
      echo "‚ùå Table creation failed: " . $wpdb->last_error . "\n";
  } else {
      echo "‚úÖ Table ready\n";
  }

  // Check table structure
  $columns = $wpdb->get_results("SHOW COLUMNS FROM ghwk_room_note_types", ARRAY_A);
  echo "üìã Table columns:\n";
  foreach ($columns as $col) {
      echo "  - {$col['Field']} ({$col['Type']})\n";
  }
  echo "\n";

  echo "üîÑ Calling GetRoomNoteTypes API (NonStatic)...\n";
  flush();

  $updated = 0;
  $failed = 0;
  $skipped = 0;

  if (!function_exists('shorttrips_call_nonstatic_xml')) {
      echo "‚ùå Error: shorttrips_call_nonstatic_xml() not found\n";
      exit;
  }

  $ns = shorttrips_call_nonstatic_xml('GetRoomNoteTypes');

  if (!$ns) {
      echo "‚ùå No response from NonStatic API\n";
  } else {
      echo "‚úÖ NonStatic API response received\n";
      $ns->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

      $patterns = [
          '//sh:noteTypes//sh:noteType',
          '//sh:roomNoteTypes//sh:roomNoteType',
          '//noteTypes//noteType',
          '//roomNoteTypes//roomNoteType'
      ];

      $nodes = null;
      $usedPattern = '';
      foreach ($patterns as $pattern) {
          $nodes = $ns->xpath($pattern);
          if ($nodes && count($nodes) > 0) {
              $usedPattern = $pattern;
              echo "üîç Found " . count($nodes) . " room note types with XPath: $pattern\n";
              break;
          }
      }

      if (!$nodes || count($nodes) === 0) {
          echo "‚ö†Ô∏è  No room note type nodes found\n";
      } else {
          echo "üîÑ Processing nodes...\n";
          echo "üìã First 5 samples:\n";

          $sampleCount = 0;
          foreach ($nodes as $n) {
              $id = intval((string)($n->id ?? $n->Id ?? ''));
              $name = trim((string)($n->name ?? $n->Name ?? $n->description ?? $n->Description ?? ''));

              // Show first 5 as samples
              if ($sampleCount < 5) {
                  echo "  Sample: ID=$id, Name=" . substr($name, 0, 50) . "\n";
                  $sampleCount++;
              }

              if ($id <= 0) {
                  $skipped++;
                  if ($skipped <= 3) {
                      echo "  ‚ö†Ô∏è  Skipped: ID=$id (invalid)\n";
                  }
                  continue;
              }

              if ($name === '') {
                  $skipped++;
                  if ($skipped <= 3) {
                      echo "  ‚ö†Ô∏è  Skipped: ID=$id, Name empty\n";
                  }
                  continue;
              }

              // Try insert
              $result = $wpdb->query($wpdb->prepare(
                  "REPLACE INTO ghwk_room_note_types (id, name, updated_at) VALUES (%d, %s, NOW())",
                  $id, $name
              ));

              if ($result === false) {
                  $failed++;
                  if ($failed <= 5) {
                      echo "  ‚ùå Insert failed for ID=$id: " . $wpdb->last_error . "\n";
                  }
              } else {
                  $updated++;
                  if ($updated <= 5) {
                      echo "  ‚úÖ Inserted ID=$id: $name\n";
                  }
              }

              // Progress indicator
              if (($updated + $failed + $skipped) % 500 === 0) {
                  echo "üìà Progress: " . ($updated + $failed + $skipped) . " processed...\n";
                  flush();
              }
          }

          echo "\n";
      }
  }

  $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_note_types");

  echo "\nüìä RESULTS:\n";
  echo "  ‚úÖ Successfully synced: $updated\n";
  echo "  ‚ùå Failed inserts: $failed\n";
  echo "  ‚ö†Ô∏è  Skipped (invalid): $skipped\n";
  echo "  üìä Total in database: $total\n";

  // Show sample from database
  if ($total > 0) {
      echo "\nüìã Sample from database:\n";
      $samples = $wpdb->get_results("SELECT id, name FROM ghwk_room_note_types ORDER BY id LIMIT 5", ARRAY_A);
      foreach ($samples as $s) {
          echo "  - ID {$s['id']}: {$s['name']}\n";
      }
  }

  exit;
});

// -----------------------------------------------------------------------------
// HOTEL NOTE TYPES SYNC - WITH DB DEBUGGING
// URL: /?sync_hotel_note_types=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function() {
  if (!isset($_GET['sync_hotel_note_types']) || $_GET['sync_hotel_note_types'] !== '1') {
      return;
  }

  if (!is_user_logged_in() || !current_user_can('manage_options')) {
      status_header(403);
      exit('Not allowed');
  }

  nocache_headers();
  while (ob_get_level()) ob_end_clean();

  @set_time_limit(300);
  @ini_set('memory_limit', '512M');

  header('Content-Type: text/plain; charset=utf-8');
  echo "=== HOTEL NOTE TYPES SYNC (WITH DB DEBUG) ===\n\n";

  global $wpdb;
  $wpdb->show_errors();

  echo "üîß Creating table ghwk_hotel_note_types...\n";
  $createResult = $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_note_types (
      id INT PRIMARY KEY,
      name VARCHAR(500),
      description TEXT,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  )");

  if ($createResult === false) {
      echo "‚ùå Table creation failed: " . $wpdb->last_error . "\n";
  } else {
      echo "‚úÖ Table ready\n\n";
  }

  echo "üîÑ Calling GetHotelNoteTypes API (NonStatic)...\n";
  flush();

  $updated = 0;
  $failed = 0;
  $skipped = 0;

  $ns = shorttrips_call_nonstatic_xml('GetHotelNoteTypes');

  if (!$ns) {
      echo "‚ùå No response from NonStatic API\n";
  } else {
      echo "‚úÖ NonStatic API response received\n";
      $ns->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

      $patterns = [
          '//sh:hotelNoteTypes//sh:hotelNoteType',
          '//sh:noteTypes//sh:noteType',
          '//hotelNoteTypes//hotelNoteType',
          '//noteTypes//noteType'
      ];

      $nodes = null;
      foreach ($patterns as $pattern) {
          $nodes = $ns->xpath($pattern);
          if ($nodes && count($nodes) > 0) {
              echo "üîç Found " . count($nodes) . " hotel note types with XPath: $pattern\n";
              break;
          }
      }

      if (!$nodes || count($nodes) === 0) {
          echo "‚ö†Ô∏è  No hotel note type nodes found\n";
      } else {
          echo "üîÑ Processing nodes...\n";
          echo "üìã First 5 samples:\n";

          $sampleCount = 0;
          foreach ($nodes as $n) {
              $id = intval((string)($n->id ?? $n->Id ?? ''));
              $name = trim((string)($n->name ?? $n->Name ?? $n->description ?? $n->Description ?? ''));

              // Show first 5 as samples
              if ($sampleCount < 5) {
                  echo "  Sample: ID=$id, Name=" . substr($name, 0, 50) . "\n";
                  $sampleCount++;
              }

              if ($id <= 0) {
                  $skipped++;
                  continue;
              }

              if ($name === '') {
                  $skipped++;
                  continue;
              }

              // Try insert
              $result = $wpdb->query($wpdb->prepare(
                  "REPLACE INTO ghwk_hotel_note_types (id, name, updated_at) VALUES (%d, %s, NOW())",
                  $id, $name
              ));

              if ($result === false) {
                  $failed++;
                  if ($failed <= 5) {
                      echo "  ‚ùå Insert failed for ID=$id: " . $wpdb->last_error . "\n";
                  }
              } else {
                  $updated++;
                  if ($updated <= 5) {
                      echo "  ‚úÖ Inserted ID=$id: $name\n";
                  }
              }

              if (($updated + $failed + $skipped) % 500 === 0) {
                  echo "üìà Progress: " . ($updated + $failed + $skipped) . " processed...\n";
                  flush();
              }
          }

          echo "\n";
      }
  }

  $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_note_types");

  echo "\nüìä RESULTS:\n";
  echo "  ‚úÖ Successfully synced: $updated\n";
  echo "  ‚ùå Failed inserts: $failed\n";
  echo "  ‚ö†Ô∏è  Skipped (invalid): $skipped\n";
  echo "  üìä Total in database: $total\n";

  if ($total > 0) {
      echo "\nüìã Sample from database:\n";
      $samples = $wpdb->get_results("SELECT id, name FROM ghwk_hotel_note_types ORDER BY id LIMIT 5", ARRAY_A);
      foreach ($samples as $s) {
          echo "  - ID {$s['id']}: {$s['name']}\n";
      }
  }

  exit;
});
*/

// END OF OLD DEBUG CODE

/**
 * ============================================================================
 * FIXED NOTE TYPES SYNC - Using ATTRIBUTES instead of child elements
 * ============================================================================
 * 
 * XML structure uses attributes:
 * <noteType id="134" text="Gala Dinner included"/>
 * 
 * NOT child elements like:
 * <noteType><id>134</id><name>...</name></noteType>
 * 
 * ============================================================================
 */

// -----------------------------------------------------------------------------
// ROOM NOTE TYPES SYNC - FIXED
// URL: /?sync_room_note_types=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['sync_room_note_types']) || $_GET['sync_room_note_types'] !== '1') {
        return;
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed');
    }

    nocache_headers();
    while (ob_get_level())
        ob_end_clean();

    @set_time_limit(300);
    @ini_set('memory_limit', '512M');

    header('Content-Type: text/plain; charset=utf-8');
    echo "=== ROOM NOTE TYPES SYNC (FIXED) ===\n\n";

    global $wpdb;
    $wpdb->show_errors();

    // Create table
    echo "üîß Creating table ghwk_room_note_types...\n";
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_room_note_types (
      id INT PRIMARY KEY,
      name VARCHAR(500),
      description TEXT,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  )");
    echo "‚úÖ Table ready\n\n";

    echo "üîÑ Calling GetRoomNoteTypes API...\n";
    flush();

    $ns = shorttrips_call_nonstatic_xml('GetRoomNoteTypes');

    if (!$ns) {
        echo "‚ùå No response from NonStatic API\n";
        exit;
    }

    echo "‚úÖ API response received\n\n";

    $ns->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

    // XPath to find nodes
    $nodes = $ns->xpath('//sh:noteTypes//sh:noteType');

    if (!$nodes || count($nodes) === 0) {
        echo "‚ùå No nodes found\n";
        exit;
    }

    echo "üîç Found " . count($nodes) . " room note types\n";
    echo "üîÑ Processing...\n\n";

    $updated = 0;
    $failed = 0;
    $skipped = 0;

    foreach ($nodes as $n) {
        // ‚úÖ CORRECT: Use ATTRIBUTES, not child elements
        $id = intval((string) $n['id']);  // ‚Üê ATTRIBUTE access with ['id']
        $name = trim((string) $n['text']); // ‚Üê ATTRIBUTE access with ['text']

        // Show first 5
        if ($updated + $failed + $skipped < 5) {
            echo "  Processing: ID=$id, Name=" . substr($name, 0, 50) . "\n";
        }

        if ($id <= 0) {
            $skipped++;
            continue;
        }

        if ($name === '') {
            $skipped++;
            continue;
        }

        // Insert into database
        $result = $wpdb->query($wpdb->prepare(
            "REPLACE INTO ghwk_room_note_types (id, name, updated_at) VALUES (%d, %s, NOW())",
            $id,
            $name
        ));

        if ($result === false) {
            $failed++;
            if ($failed <= 3) {
                echo "  ‚ùå Insert failed for ID=$id: " . $wpdb->last_error . "\n";
            }
        } else {
            $updated++;
        }

        // Progress indicator
        if (($updated + $failed + $skipped) % 500 === 0) {
            echo "üìà Progress: " . ($updated + $failed + $skipped) . " / " . count($nodes) . "\n";
            flush();
        }
    }

    $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_note_types");

    echo "\nüìä RESULTS:\n";
    echo "  ‚úÖ Successfully synced: $updated\n";
    echo "  ‚ùå Failed inserts: $failed\n";
    echo "  ‚ö†Ô∏è  Skipped (invalid): $skipped\n";
    echo "  üìä Total in database: $total\n";

    if ($total > 0) {
        echo "\nüìã Sample from database:\n";
        $samples = $wpdb->get_results("SELECT id, name FROM ghwk_room_note_types ORDER BY id LIMIT 10", ARRAY_A);
        foreach ($samples as $s) {
            echo "  - ID {$s['id']}: {$s['name']}\n";
        }
    }

    exit;
});

// -----------------------------------------------------------------------------
// HOTEL NOTE TYPES SYNC - FIXED
// URL: /?sync_hotel_note_types=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['sync_hotel_note_types']) || $_GET['sync_hotel_note_types'] !== '1') {
        return;
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed');
    }

    nocache_headers();
    while (ob_get_level())
        ob_end_clean();

    @set_time_limit(300);
    @ini_set('memory_limit', '512M');

    header('Content-Type: text/plain; charset=utf-8');
    echo "=== HOTEL NOTE TYPES SYNC (FIXED) ===\n\n";

    global $wpdb;
    $wpdb->show_errors();

    // Create table
    echo "üîß Creating table ghwk_hotel_note_types...\n";
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_hotel_note_types (
      id INT PRIMARY KEY,
      name VARCHAR(500),
      description TEXT,
      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  )");
    echo "‚úÖ Table ready\n\n";

    echo "üîÑ Calling GetHotelNoteTypes API...\n";
    flush();

    $ns = shorttrips_call_nonstatic_xml('GetHotelNoteTypes');

    if (!$ns) {
        echo "‚ùå No response from NonStatic API\n";
        exit;
    }

    echo "‚úÖ API response received\n";
    $ns->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

    // Try both patterns
    $patterns = [
        '//sh:hotelNoteTypes//sh:hotelNoteType',
        '//sh:noteTypes//sh:noteType'
    ];

    $nodes = null;
    $usedPattern = '';
    foreach ($patterns as $pattern) {
        $nodes = $ns->xpath($pattern);
        if ($nodes && count($nodes) > 0) {
            $usedPattern = $pattern;
            break;
        }
    }

    if (!$nodes || count($nodes) === 0) {
        echo "‚ùå No nodes found\n";
        exit;
    }

    echo "üîç Found " . count($nodes) . " hotel note types (pattern: $usedPattern)\n";
    echo "üîÑ Processing...\n\n";

    $updated = 0;
    $failed = 0;
    $skipped = 0;

    foreach ($nodes as $n) {
        // ‚úÖ CORRECT: Use ATTRIBUTES
        $id = intval((string) $n['id']);
        $name = trim((string) $n['text']);

        // Show first 5
        if ($updated + $failed + $skipped < 5) {
            echo "  Processing: ID=$id, Name=" . substr($name, 0, 50) . "\n";
        }

        if ($id <= 0) {
            $skipped++;
            continue;
        }

        if ($name === '') {
            $skipped++;
            continue;
        }

        // Insert into database
        $result = $wpdb->query($wpdb->prepare(
            "REPLACE INTO ghwk_hotel_note_types (id, name, updated_at) VALUES (%d, %s, NOW())",
            $id,
            $name
        ));

        if ($result === false) {
            $failed++;
            if ($failed <= 3) {
                echo "  ‚ùå Insert failed for ID=$id: " . $wpdb->last_error . "\n";
            }
        } else {
            $updated++;
        }

        if (($updated + $failed + $skipped) % 500 === 0) {
            echo "üìà Progress: " . ($updated + $failed + $skipped) . " / " . count($nodes) . "\n";
            flush();
        }
    }

    $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_note_types");


    echo "\nüìä RESULTS:\n";
    echo "  ‚úÖ Successfully synced: $updated\n";
    echo "  ‚ùå Failed inserts: $failed\n";
    echo "  ‚ö†Ô∏è  Skipped (invalid): $skipped\n";
    echo "  üìä Total in database: $total\n";

    if ($total > 0) {
        echo "\nüìã Sample from database:\n";
        $samples = $wpdb->get_results("SELECT id, name FROM ghwk_hotel_note_types ORDER BY id LIMIT 10", ARRAY_A);
        foreach ($samples as $s) {
            echo "  - ID {$s['id']}: {$s['name']}\n";
        }
    }

    exit;
});

// -----------------------------------------------------------------------------
// HOTEL ROOM TYPES SYNC - Using Static API (COMPLETE room types per hotel)
// URL: /?sync_hotel_room_types=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['sync_hotel_room_types']) || $_GET['sync_hotel_room_types'] !== '1') {
        return;
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed');
    }

    nocache_headers();
    while (ob_get_level())
        ob_end_clean();

    @set_time_limit(600);
    @ini_set('memory_limit', '512M');

    header('Content-Type: text/plain; charset=utf-8');
    echo "=== HOTEL ROOM TYPES SYNC (Static API - Complete) ===\n\n";

    global $wpdb;
    $wpdb->show_errors();

    // Only recreate table on first run (offset=0)
    $offset = isset($_GET['offset']) ? intval($_GET['offset']) : 0;

    if ($offset === 0) {
        echo "üîß Creating table ghwk_hotel_room_types...\n";
        $wpdb->query("DROP TABLE IF EXISTS ghwk_hotel_room_types");
        $wpdb->query("CREATE TABLE ghwk_hotel_room_types (
            id INT AUTO_INCREMENT PRIMARY KEY,
            hotel_id INT NOT NULL,
            room_type_id INT NOT NULL,
            room_type_name VARCHAR(500),
            description TEXT,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            UNIQUE KEY unique_hotel_room (hotel_id, room_type_id),
            INDEX idx_hotel_id (hotel_id),
            INDEX idx_room_type_id (room_type_id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");
        echo "‚úÖ Table ready\n\n";
    } else {
        echo "‚úÖ Using existing table\n\n";
    }

    // Get hotels from database
    $limit = isset($_GET['limit']) ? intval($_GET['limit']) : 50;

    echo "üè® Getting hotels from database (limit: $limit, offset: $offset)...\n";
    $hotels = $wpdb->get_results($wpdb->prepare(
        "SELECT hotel_id, hotelname FROM ghwk_bravo_hotels LIMIT %d OFFSET %d",
        $limit,
        $offset
    ), ARRAY_A);

    if (!$hotels) {
        echo "‚ùå No more hotels found\n";
        $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_room_types");
        echo "‚úÖ SYNC COMPLETE! Total relationships: $total\n";
        exit;
    }

    echo "‚úÖ Found " . count($hotels) . " hotels to process\n\n";

    // Check if room types exist
    $roomTypesCount = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
    if ($roomTypesCount == 0) {
        echo "‚ö†Ô∏è  Warning: No room types in database!\n";
        echo "üí° Run room types sync first: /?sync_room_types=1\n\n";
    } else {
        echo "‚úÖ Room types in database: $roomTypesCount\n\n";
    }

    $inserted = 0;
    $failed = 0;
    $hotelsWithRooms = 0;
    $hotelsWithoutRooms = 0;

    // Get API credentials
    $creds = function_exists('shorttrips_get_api_credentials')
        ? shorttrips_get_api_credentials()
        : ['username' => 'Freestays', 'password' => '', 'language' => 'en', 'currency' => 'EUR'];

    // Date range for search - use near future dates (better availability)
    // Try multiple date ranges if first fails
    $checkin = date('Y-m-d', strtotime('+14 days'));   // 2 weeks from now
    $checkout = date('Y-m-d', strtotime('+16 days'));  // 2 day stay

    echo "üîë API Username: {$creds['username']}\n";
    echo "üåê Using NonStatic API: SearchV3 (with wide date range)\n";
    echo "üìÖ Dates: $checkin to $checkout\n";
    echo "üîÑ Processing hotels...\n\n";
    flush();

    $showDebug = isset($_GET['debug']) && $_GET['debug'] === '1';

    foreach ($hotels as $i => $hotel) {
        $hotelId = $hotel['hotel_id'];
        $hotelName = substr($hotel['hotelname'], 0, 40);

        if (($i + 1) % 10 === 0 || $i < 5) {
            echo "  [" . ($i + 1) . "/" . count($hotels) . "] Hotel $hotelId ($hotelName)...\n";
            flush();
        }

        // Call NonStatic SearchV3 API
        if (!function_exists('shorttrips_call_nonstatic_xml')) {
            echo "‚ùå Function shorttrips_call_nonstatic_xml not found\n";
            exit;
        }

        $params = [
            'hotelId' => $hotelId,
            'checkin' => $checkin,
            'checkout' => $checkout,
            'rooms' => 1,
            'adults' => 2
        ];

        $search = shorttrips_call_nonstatic_xml('SearchV3', $params);

        if (!$search) {
            $hotelsWithoutRooms++;
            if ($showDebug && $i < 3) {
                echo "    ‚ùå API call failed\n";
            }
            continue;
        }

        // Register namespace
        $search->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

        // Get all rooms from search result
        $rooms = $search->xpath('//sh:room');

        if (!$rooms || count($rooms) === 0) {
            $hotelsWithoutRooms++;
            if ($showDebug && $i < 3) {
                echo "    ‚ö†Ô∏è  No rooms available\n";
            }
            continue;
        }

        if ($showDebug && $i < 3) {
            echo "    ‚úÖ Found " . count($rooms) . " available rooms\n";
        }

        $hotelsWithRooms++;
        $roomsForThisHotel = 0;
        $seenRoomTypes = [];

        // Extract unique room types from available rooms
        foreach ($rooms as $room) {
            $roomTypeId = intval((string) $room->roomTypeId);
            $roomTypeName = trim((string) $room->roomType);

            if ($roomTypeId <= 0 || empty($roomTypeName)) {
                continue;
            }

            // Skip duplicates for this hotel
            if (isset($seenRoomTypes[$roomTypeId])) {
                continue;
            }
            $seenRoomTypes[$roomTypeId] = true;

            // Insert into database
            $result = $wpdb->query($wpdb->prepare(
                "INSERT IGNORE INTO ghwk_hotel_room_types 
                (hotel_id, room_type_id, room_type_name, updated_at) 
                VALUES (%d, %d, %s, NOW())",
                $hotelId,
                $roomTypeId,
                $roomTypeName
            ));

            if ($result !== false && $wpdb->rows_affected > 0) {
                $inserted++;
                $roomsForThisHotel++;
            } else if ($result === false) {
                $failed++;
            }
        }

        if ($showDebug && $i < 3 && $roomsForThisHotel > 0) {
            echo "    üíæ Inserted $roomsForThisHotel unique room types\n";
        }

        // Rate limiting
        if ($i < count($hotels) - 1) {
            usleep(150000); // 0.15 second
        }
    }

    $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_room_types");
    $uniqueHotels = $wpdb->get_var("SELECT COUNT(DISTINCT hotel_id) FROM ghwk_hotel_room_types");
    $uniqueRoomTypes = $wpdb->get_var("SELECT COUNT(DISTINCT room_type_id) FROM ghwk_hotel_room_types");

    echo "\nüìä RESULTS (this batch):\n";
    echo "  ‚úÖ Successfully inserted: $inserted relationships\n";
    echo "  ‚ùå Failed inserts: $failed\n";
    echo "  üè® Hotels with room types: $hotelsWithRooms\n";
    echo "  ‚ö†Ô∏è  Hotels without room types: $hotelsWithoutRooms\n";
    echo "\nüìä DATABASE TOTALS:\n";
    echo "  üìä Total relationships: $total\n";
    echo "  üè® Unique hotels: $uniqueHotels\n";
    echo "  üõèÔ∏è  Unique room types: $uniqueRoomTypes\n";

    if ($total > 0) {
        echo "\nüìã Sample from database:\n";
        $samples = $wpdb->get_results(
            "SELECT h.hotelname, hrt.room_type_id, hrt.room_type_name 
             FROM ghwk_hotel_room_types hrt 
             LEFT JOIN ghwk_bravo_hotels h ON h.hotel_id = hrt.hotel_id 
             LIMIT 10",
            ARRAY_A
        );
        foreach ($samples as $s) {
            $hotelName = substr($s['hotelname'], 0, 30);
            $roomName = substr($s['room_type_name'], 0, 40);
            echo "  - $hotelName ‚Üí Room {$s['room_type_id']}: $roomName\n";
        }
    }

    echo "\nüí° PAGINATION:\n";
    echo "To process more hotels, use:\n";
    $nextOffset = $offset + $limit;
    echo "  Next batch: /?sync_hotel_room_types=1&limit=$limit&offset=$nextOffset\n";

    exit;
});

// -----------------------------------------------------------------------------
// MEALS SYNC - FIXED
// URL: /?sync_meals=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['sync_meals']) || $_GET['sync_meals'] !== '1') {
        return;
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed');
    }

    nocache_headers();
    while (ob_get_level())
        ob_end_clean();

    @set_time_limit(300);
    @ini_set('memory_limit', '512M');

    header('Content-Type: text/plain; charset=utf-8');
    echo "=== MEALS SYNC (FIXED) ===\n\n";

    global $wpdb;
    $wpdb->show_errors();

    // Create table
    echo "üîß Creating table ghwk_meals...\n";
    $wpdb->query("CREATE TABLE IF NOT EXISTS ghwk_meals (
        id INT PRIMARY KEY,
        name VARCHAR(500),
        description TEXT,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    )");

    // Add description column if it doesn't exist
    $columns = $wpdb->get_results("SHOW COLUMNS FROM ghwk_meals LIKE 'description'");
    if (empty($columns)) {
        echo "  Adding description column...\n";
        $wpdb->query("ALTER TABLE ghwk_meals ADD COLUMN description TEXT AFTER name");
    }

    echo "‚úÖ Table ready\n\n";

    // Get API credentials
    $creds = function_exists('shorttrips_get_api_credentials')
        ? shorttrips_get_api_credentials()
        : ['username' => 'Freestays', 'password' => '', 'language' => 'en'];

    echo "üîë API Username: {$creds['username']}\n";
    echo "üîÑ Calling GetMeals API...\n";
    flush();

    // Call Static API
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';

    $soap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<GetMeals xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>' . esc_html($creds['username']) . '</userName>'
        . '<password>' . esc_html($creds['password']) . '</password>'
        . '<language>' . esc_html($creds['language']) . '</language>'
        . '</GetMeals>'
        . '</soap:Body>'
        . '</soap:Envelope>';

    $response = wp_remote_post($endpoint, [
        'headers' => [
            'Content-Type' => 'text/xml; charset=utf-8',
            'SOAPAction' => '"http://xml.sunhotels.net/15/GetMeals"'
        ],
        'body' => $soap,
        'timeout' => 60
    ]);

    if (is_wp_error($response)) {
        echo "‚ùå API error: " . $response->get_error_message() . "\n";
        exit;
    }

    $body = wp_remote_retrieve_body($response);
    if (empty($body)) {
        echo "‚ùå Empty response\n";
        exit;
    }

    echo "‚úÖ API response received (" . strlen($body) . " bytes)\n";

    // Parse XML - use DOMDocument + XPath directly
    libxml_use_internal_errors(true);
    libxml_clear_errors();

    $dom = new DOMDocument();
    $loaded = $dom->loadXML($body, LIBXML_NOCDATA);

    if (!$loaded) {
        echo "‚ùå DOMDocument failed to load XML\n";
        $errors = libxml_get_errors();
        if ($errors) {
            echo "Errors:\n";
            foreach ($errors as $error) {
                echo "  Line {$error->line}: " . trim($error->message) . "\n";
            }
        }
        libxml_clear_errors();
        exit;
    }

    echo "‚úÖ XML parsed successfully\n";

    // Use XPath to find meals
    $xpath = new DOMXPath($dom);
    $xpath->registerNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
    $xpath->registerNamespace('sh', 'http://xml.sunhotels.net/15/');

    // Try different XPath patterns
    $patterns = [
        '//sh:meals/sh:meal',
        '//meal',
        '//sh:meal'
    ];

    $mealNodes = null;
    $usedPattern = '';

    foreach ($patterns as $pattern) {
        $mealNodes = $xpath->query($pattern);
        if ($mealNodes && $mealNodes->length > 0) {
            $usedPattern = $pattern;
            break;
        }
    }

    if (!$mealNodes || $mealNodes->length === 0) {
        echo "‚ùå No meals found\n";
        echo "Tried patterns: " . implode(', ', $patterns) . "\n";
        exit;
    }

    echo "üîç Found " . $mealNodes->length . " meals (pattern: $usedPattern)\n";
    echo "üîÑ Processing...\n\n";

    $updated = 0;
    $failed = 0;
    $skipped = 0;

    foreach ($mealNodes as $mealNode) {
        // Extract data from DOM nodes (try both with and without namespace)
        $idNode = $xpath->query('.//sh:id', $mealNode)->item(0);
        if (!$idNode) {
            $idNode = $xpath->query('.//id', $mealNode)->item(0);
        }

        $nameNode = $xpath->query('.//sh:name', $mealNode)->item(0);
        if (!$nameNode) {
            $nameNode = $xpath->query('.//name', $mealNode)->item(0);
        }

        $id = $idNode ? intval($idNode->textContent) : 0;
        $name = $nameNode ? trim($nameNode->textContent) : '';

        // Build description from labels
        $description = '';
        $labelNodes = $xpath->query('.//sh:labels/sh:label', $mealNode);
        if (!$labelNodes || $labelNodes->length === 0) {
            $labelNodes = $xpath->query('.//labels/label', $mealNode);
        }

        if ($labelNodes && $labelNodes->length > 0) {
            $labels = [];
            foreach ($labelNodes as $labelNode) {
                $textNode = $xpath->query('.//sh:text', $labelNode)->item(0);
                if (!$textNode) {
                    $textNode = $xpath->query('.//text', $labelNode)->item(0);
                }
                if ($textNode) {
                    $labels[] = trim($textNode->textContent);
                }
            }
            if (!empty($labels)) {
                $description = implode(', ', $labels);
            }
        }

        // Show first 5
        if ($updated + $failed + $skipped < 5) {
            echo "  Sample: ID=$id, Name=$name" . ($description ? " ($description)" : "") . "\n";
        }

        if ($id <= 0) {
            $skipped++;
            continue;
        }

        if (empty($name)) {
            $skipped++;
            continue;
        }

        // Insert into database
        $result = $wpdb->query($wpdb->prepare(
            "REPLACE INTO ghwk_meals (id, name, description, updated_at) VALUES (%d, %s, %s, NOW())",
            $id,
            $name,
            $description
        ));

        if ($result !== false) {
            $updated++;
        } else {
            $failed++;
            if ($failed <= 3) {
                echo "  ‚ùå Insert failed for ID=$id: " . $wpdb->last_error . "\n";
            }
        }
    }

    $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_meals");

    echo "\nüìä RESULTS:\n";
    echo "  ‚úÖ Successfully synced: $updated\n";
    echo "  ‚ùå Failed inserts: $failed\n";
    echo "  ‚ö†Ô∏è  Skipped (invalid): $skipped\n";
    echo "  üìä Total in database: $total\n";

    if ($total > 0) {
        echo "\nüìã Sample from database:\n";
        $samples = $wpdb->get_results("SELECT id, name FROM ghwk_meals ORDER BY id LIMIT 10", ARRAY_A);
        foreach ($samples as $s) {
            echo "  - ID {$s['id']}: {$s['name']}\n";
        }
    }

    exit;
});

// -----------------------------------------------------------------------------
// ROOM IMAGES SYNC - TEST VERSION (Check XMLReader & ZIP download)
// URL: /?test_room_sync=1
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['test_room_sync']) || $_GET['test_room_sync'] !== '1') {
        return;
    }

    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        exit('‚ùå Not authorized');
    }

    if (!headers_sent()) {
        nocache_headers();
        header('Content-Type: text/plain; charset=utf-8');
    }

    echo "=== ROOM SYNC CAPABILITY TEST ===\n\n";

    // Test 1: XMLReader
    echo "1Ô∏è‚É£ Testing XMLReader availability...\n";
    if (class_exists('XMLReader')) {
        echo "   ‚úÖ XMLReader class exists\n";
        $reader = new XMLReader();
        echo "   ‚úÖ XMLReader instance created\n";
    } else {
        echo "   ‚ùå XMLReader NOT available\n";
        echo "   This is REQUIRED for streaming large XML files\n";
        exit;
    }

    // Test 2: ZipArchive
    echo "\n2Ô∏è‚É£ Testing ZipArchive availability...\n";
    if (class_exists('ZipArchive')) {
        echo "   ‚úÖ ZipArchive class exists\n";
    } else {
        echo "   ‚ö†Ô∏è  ZipArchive NOT available (will use WP unzip_file)\n";
    }

    // Test 3: Memory & execution time
    echo "\n3Ô∏è‚É£ Checking PHP configuration...\n";
    echo "   Memory limit: " . ini_get('memory_limit') . "\n";
    echo "   Max execution time: " . ini_get('max_execution_time') . "s\n";
    echo "   Upload max filesize: " . ini_get('upload_max_filesize') . "\n";

    // Test 4: Upload directory writable
    echo "\n4Ô∏è‚É£ Testing upload directory...\n";
    $uploadDir = wp_upload_dir();
    $testDir = $uploadDir['basedir'] . '/room-images-cache';

    if (!is_dir($testDir)) {
        if (wp_mkdir_p($testDir)) {
            echo "   ‚úÖ Created test directory: $testDir\n";
        } else {
            echo "   ‚ùå Failed to create directory\n";
            exit;
        }
    } else {
        echo "   ‚úÖ Directory exists: $testDir\n";
    }

    if (is_writable($testDir)) {
        echo "   ‚úÖ Directory is writable\n";
    } else {
        echo "   ‚ùå Directory is NOT writable\n";
        exit;
    }

    // Test 5: Small XML parsing test
    echo "\n5Ô∏è‚É£ Testing XML parsing...\n";
    $testXml = '<?xml version="1.0"?><root><Hotel><Id>123</Id><RoomTypes><RoomType><Id>1</Id><ImageIds><ImageId>12345</ImageId></ImageIds></RoomType></RoomTypes></Hotel></root>';

    $reader = new XMLReader();
    if ($reader->XML($testXml)) {
        echo "   ‚úÖ XMLReader can parse XML string\n";

        while ($reader->read()) {
            if ($reader->nodeType == XMLReader::ELEMENT && $reader->name == 'Hotel') {
                $hotelXml = $reader->readOuterXml();
                $hotel = simplexml_load_string('<root>' . $hotelXml . '</root>');
                if ($hotel && isset($hotel->Hotel->Id)) {
                    echo "   ‚úÖ Can expand and parse Hotel nodes\n";
                    echo "   ‚úÖ Test Hotel ID: " . (int) $hotel->Hotel->Id . "\n";
                    break;
                }
            }
        }
        $reader->close();
    } else {
        echo "   ‚ùå XMLReader failed to parse test XML\n";
        exit;
    }

    echo "\n" . str_repeat("=", 50) . "\n";
    echo "‚úÖ ALL TESTS PASSED!\n";
    echo "\nYour server supports:\n";
    echo "  ‚úÖ XMLReader streaming\n";
    echo "  ‚úÖ SimpleXML parsing\n";
    echo "  ‚úÖ Writable upload directory\n";
    echo "\nüéâ Ready to proceed with full sync!\n";

    exit;
});

// -----------------------------------------------------------------------------
// ROOM IMAGES SYNC - OPTIMIZED VERSION WITH ZIP DOWNLOAD & STREAMING  
// URL: /?sync_room_images=1&_wpnonce=<nonce>&offset=0&batch_size=100
// Uses RoomTypeStaticData export (cached weekly) with XMLReader streaming
// -----------------------------------------------------------------------------
add_action('template_redirect', function () {
    if (!isset($_GET['sync_room_images']) || $_GET['sync_room_images'] !== '1') {
        return;
    }

    // Wrap everything in try-catch for safety
    try {

        if (!is_user_logged_in() || !current_user_can('manage_options')) {
            exit('‚ùå Not authorized');
        }

        // Nonce check - allow skip for testing
        $skipNonce = isset($_GET['skip_nonce']) && $_GET['skip_nonce'] === '1';

        if (!$skipNonce) {
            $nonce = isset($_GET['_wpnonce']) ? $_GET['_wpnonce'] : '';
            if (!wp_verify_nonce($nonce, 'shorttrips_sync')) {
                exit('‚ùå Invalid nonce. Add &skip_nonce=1 to bypass during testing.');
            }
        }

        nocache_headers();
        @set_time_limit(900); // 15 minutes for large file processing
        @ini_set('memory_limit', '1024M'); // Increased for ZIP extraction
        @ini_set('max_execution_time', '900'); // 15 minutes
        header('Content-Type: text/plain; charset=utf-8');

        // Enable error display for debugging
        @ini_set('display_errors', '1');
        error_reporting(E_ALL);

        global $wpdb;

        echo "=== ROOM IMAGES SYNC (RoomTypeStaticData) ===\n";
        echo "üïí " . current_time('Y-m-d H:i:s') . "\n";
        echo "üìä PHP Memory: " . ini_get('memory_limit') . "\n";
        echo "‚è±Ô∏è  Timeout: " . ini_get('max_execution_time') . "s\n\n";
        flush();

        // Get API credentials
        try {
            $creds = shorttrips_get_api_credentials();
            if (empty($creds['username']) || empty($creds['password'])) {
                echo "‚ùå API credentials missing\n";
                exit;
            }
            echo "üîë API Username: {$creds['username']}\n\n";
        } catch (Exception $e) {
            echo "‚ùå Error getting credentials: " . $e->getMessage() . "\n";
            exit;
        }

        // Parameters - reduced batch size to prevent timeout
        // Note: Smaller batches = faster per-batch, but XML must be scanned from start each time
        $batchSize = isset($_GET['batch_size']) ? intval($_GET['batch_size']) : 10; // Very small to ensure completion
        $offset = isset($_GET['offset']) ? intval($_GET['offset']) : 0;
        $autoMode = isset($_GET['auto']) && $_GET['auto'] === '1';
        $forceDownload = isset($_GET['force_download']) && $_GET['force_download'] === '1';

        echo "üìä Batch size: $batchSize hotels per batch\n";
        echo "üìç Starting offset: $offset\n";
        echo "ü§ñ Auto mode: " . ($autoMode ? 'YES' : 'NO') . "\n";
        echo "üíæ Force download: " . ($forceDownload ? 'YES' : 'NO') . "\n";

        // Show estimated scan time warning
        if ($offset > 0 || get_option('room_sync_last_hotel_id', 0) > 0) {
            echo "‚ö†Ô∏è  Note: XMLReader must scan from file start each time (~30-60s)\n";
        }
        echo "\n";
        flush();

        // Setup upload directory (use existing temp_roomimages if it exists)
        $uploadDir = wp_upload_dir();
        $tempDir = $uploadDir['basedir'] . '/temp_roomimages';
        $cacheDir = $uploadDir['basedir'] . '/room-images-cache';

        // Check if XML already exists in temp_roomimages (from previous runs)
        $existingXmlFile = $tempDir . '/RoomTypeStaticData_en.xml';

        if (file_exists($existingXmlFile)) {
            echo "‚úÖ Found existing XML in temp directory\n";
            $cacheDir = $tempDir;
            $xmlFile = $existingXmlFile;
            $zipFile = $tempDir . '/RoomTypeStaticData.zip';
        } else {
            // Use cache directory for new downloads
            if (!is_dir($cacheDir)) {
                if (!wp_mkdir_p($cacheDir)) {
                    echo "‚ùå Failed to create cache directory\n";
                    exit;
                }
            }
            $zipFile = $cacheDir . '/RoomTypeStaticData.zip';
            $xmlFile = $cacheDir . '/RoomTypeStaticData_en.xml';
        }

        echo "üìÇ Using directory: $cacheDir\n";
        echo "üìÑ XML file: " . basename($xmlFile) . "\n\n";

        // Step 1: Download/check ZIP file
        echo "üì• Step 1: Checking cached ZIP file...\n";
        flush();
        $needsDownload = $forceDownload;

        if (!$forceDownload && file_exists($zipFile)) {
            $zipAge = time() - filemtime($zipFile);
            $daysOld = round($zipAge / 86400, 1);
            echo "  ‚úÖ Found cached ZIP ({$daysOld} days old)\n";

            if ($zipAge > 604800) { // 7 days
                echo "  ‚ö†Ô∏è  ZIP is older than 7 days, will download fresh\n";
                $needsDownload = true;
            }
        } else {
            echo "  ‚ö†Ô∏è  No cached ZIP found\n";
            $needsDownload = true;
        }

        if ($needsDownload) {
            echo "  üì° Downloading RoomTypeStaticData ZIP...\n";
            echo "  ‚è±Ô∏è  This may take 30-60 seconds...\n";
            flush();

            try {
                $apiUrl = 'https://xml.sunhotels.net/15/DownloadExport.aspx?'
                    . 'username=' . urlencode($creds['username'])
                    . '&password=' . urlencode($creds['password'])
                    . '&language=en'
                    . '&xmlType=RoomTypeStaticData'
                    . '&format=zip'
                    . '&version=170';

                echo "  üîó URL: " . substr($apiUrl, 0, 100) . "...\n";
                flush();

                $downloadStart = microtime(true);
                $response = wp_remote_get($apiUrl, [
                    'timeout' => 300,
                    'stream' => true,
                    'filename' => $zipFile
                ]);
                $downloadTime = round(microtime(true) - $downloadStart, 1);

                if (is_wp_error($response)) {
                    echo "  ‚ùå Download failed: " . $response->get_error_message() . "\n";
                    exit;
                }

                if (!file_exists($zipFile)) {
                    echo "  ‚ùå ZIP file not created\n";
                    exit;
                }

                $fileSize = filesize($zipFile);
                if ($fileSize < 1000) {
                    echo "  ‚ùå Downloaded file too small ({$fileSize} bytes) - probably an error\n";
                    echo "  Content: " . file_get_contents($zipFile) . "\n";
                    exit;
                }

                echo "  ‚úÖ Downloaded " . number_format($fileSize) . " bytes (" . round($fileSize / 1024 / 1024, 1) . " MB) in {$downloadTime}s\n";

                // Delete old XML to force re-extraction
                if (file_exists($xmlFile)) {
                    unlink($xmlFile);
                }
            } catch (Exception $e) {
                echo "  ‚ùå Exception during download: " . $e->getMessage() . "\n";
                exit;
            }
        }

        echo "\n";

        // Step 2: Check for extracted XML and split into chunks if needed
        echo "üì¶ Step 2: Checking extracted XML...\n";
        flush();

        if (!file_exists($xmlFile)) {
            echo "  üìÇ XML not found, attempting extraction...\n";
            flush();

            if (!file_exists($zipFile)) {
                echo "  ‚ùå ZIP file not found: $zipFile\n";
                exit;
            }

            // Use ZipArchive instead of WP unzip_file (more memory efficient)
            echo "  üîß Using ZipArchive for extraction...\n";
            $zip = new ZipArchive();

            if ($zip->open($zipFile) === true) {
                $extractStart = microtime(true);

                // Extract only XML files (not all files at once)
                for ($i = 0; $i < $zip->numFiles; $i++) {
                    $filename = $zip->getNameIndex($i);
                    if (stripos($filename, '.xml') !== false) {
                        echo "  üìÑ Extracting: $filename\n";
                        $zip->extractTo($cacheDir, $filename);
                    }
                }

                $zip->close();
                $extractTime = round(microtime(true) - $extractStart, 1);
                echo "  ‚úÖ Extracted in {$extractTime}s\n";
            } else {
                echo "  ‚ùå Failed to open ZIP file\n";
                exit;
            }
        } else {
            $xmlAge = time() - filemtime($xmlFile);
            $daysOld = round($xmlAge / 86400, 1);
            echo "  ‚úÖ XML already extracted ({$daysOld} days old)\n";
        }

        if (!file_exists($xmlFile)) {
            echo "  ‚ùå XML file not found after extraction\n";
            exit;
        }

        $xmlSize = filesize($xmlFile);
        echo "  üìä XML file size: " . number_format($xmlSize) . " bytes (" . round($xmlSize / 1024 / 1024, 1) . " MB)\n";
        echo "\n";

        // Load global dictionaries (Features / BedTypes) as per Sunhotels protocol
        echo "üìö Step 2b: Loading dictionaries (Features & BedTypes)...\n";
        $dictCacheFile = $cacheDir . '/RoomTypeStaticData_dicts.json';
        $dictData = null;
        $dictCacheFresh = file_exists($dictCacheFile)
            && filemtime($dictCacheFile) >= filemtime($xmlFile);
        if (!$forceDownload && $dictCacheFresh) {
            $dictData = json_decode(file_get_contents($dictCacheFile), true);
        }
        if (!is_array($dictData) || empty($dictData['features'])) {
            $dictData = shorttrips_roomtype_static_extract_dictionaries($xmlFile);
            file_put_contents(
                $dictCacheFile,
                wp_json_encode($dictData, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE)
            );
            echo "  üîÑ Dictionaries refreshed from XML\n";
        } else {
            echo "  ‚úÖ Dictionaries loaded from cache\n";
        }
        $featureDictionary = $dictData['features'] ?? [];
        $bedTypeDictionary = $dictData['bed_types'] ?? [];
        echo "     ‚Ä¢ Features: " . count($featureDictionary) . "\n";
        echo "     ‚Ä¢ Bed types: " . count($bedTypeDictionary) . "\n\n";

        // Step 3: Split XML into chunks for faster access
        echo "‚úÇÔ∏è  Step 3: Checking/creating XML chunks...\n";
        flush();

        $chunksDir = $cacheDir . '/chunks';
        $chunkIndexFile = $chunksDir . '/chunk_index.json';
        $needsSplit = false;

        if (!is_dir($chunksDir)) {
            wp_mkdir_p($chunksDir);
            $needsSplit = true;
        } elseif (!file_exists($chunkIndexFile)) {
            $needsSplit = true;
        } else {
            // Check if chunks are up to date
            $indexAge = time() - filemtime($chunkIndexFile);
            if ($indexAge > 604800) { // 7 days old
                echo "  ‚ö†Ô∏è  Chunks are old, will regenerate\n";
                $needsSplit = true;
            } else {
                echo "  ‚úÖ Chunks already exist\n";
            }
        }

        if ($needsSplit || $forceDownload) {
            echo "  üìù Splitting XML into chunks (one-time operation)...\n";
            echo "  ‚è±Ô∏è  This may take 2-5 minutes...\n";
            flush();

            $splitStart = microtime(true);
            $chunkSize = 100; // 100 hotels per chunk
            $currentChunk = 0;
            $hotelsInChunk = 0;
            $chunkHotels = [];
            $chunkIndex = [];

            $reader = new XMLReader();
            $reader->open($xmlFile);

            $totalHotels = 0;

            while ($reader->read()) {
                if ($reader->nodeType != XMLReader::ELEMENT || $reader->name != 'Hotel') {
                    continue;
                }

                $hotelXml = $reader->readOuterXml();
                $hotelNode = @simplexml_load_string('<root>' . $hotelXml . '</root>');

                if (!$hotelNode || !isset($hotelNode->Hotel->Id)) {
                    continue;
                }

                $hotelId = (int) $hotelNode->Hotel->Id;
                $chunkHotels[] = $hotelXml;
                $hotelsInChunk++;
                $totalHotels++;

                // Save chunk when full
                if ($hotelsInChunk >= $chunkSize) {
                    $chunkFile = $chunksDir . "/chunk_{$currentChunk}.xml";
                    $chunkContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<Hotels>\n"
                        . implode("\n", $chunkHotels)
                        . "\n</Hotels>";
                    file_put_contents($chunkFile, $chunkContent);

                    $chunkIndex[$currentChunk] = [
                        'file' => basename($chunkFile),
                        'hotels' => $hotelsInChunk,
                        'first_hotel_id' => $hotelId - $hotelsInChunk + 1,
                        'last_hotel_id' => $hotelId
                    ];

                    if ($totalHotels % 500 == 0) {
                        echo "  üì¶ Created " . ($currentChunk + 1) . " chunks ($totalHotels hotels)...\n";
                        flush();
                    }

                    $currentChunk++;
                    $hotelsInChunk = 0;
                    $chunkHotels = [];
                }

                $reader->next('Hotel');
            }

            // Save remaining hotels
            if (!empty($chunkHotels)) {
                $chunkFile = $chunksDir . "/chunk_{$currentChunk}.xml";
                $chunkContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<Hotels>\n"
                    . implode("\n", $chunkHotels)
                    . "\n</Hotels>";
                file_put_contents($chunkFile, $chunkContent);

                $chunkIndex[$currentChunk] = [
                    'file' => basename($chunkFile),
                    'hotels' => $hotelsInChunk
                ];
                $currentChunk++;
            }

            $reader->close();

            // Save index
            file_put_contents($chunkIndexFile, json_encode([
                'total_chunks' => $currentChunk,
                'total_hotels' => $totalHotels,
                'chunk_size' => $chunkSize,
                'created_at' => time(),
                'chunks' => $chunkIndex
            ], JSON_PRETTY_PRINT));

            $splitTime = round(microtime(true) - $splitStart, 1);
            echo "  ‚úÖ Split into $currentChunk chunks ($totalHotels hotels) in {$splitTime}s\n";
        }

        // Load chunk index
        $chunkIndex = json_decode(file_get_contents($chunkIndexFile), true);
        echo "  üìä Total chunks: {$chunkIndex['total_chunks']}\n";
        echo "  üìä Total hotels in chunks: {$chunkIndex['total_hotels']}\n";
        echo "\n";

        // Step 4: Load room type names lookup
        echo "üìö Step 3: Loading room type names...\n";
        flush();

        $roomTypeNames = [];
        $roomTypesResult = $wpdb->get_results("SELECT id, name FROM ghwk_room_types WHERE name IS NOT NULL AND name != ''", ARRAY_A);
        foreach ($roomTypesResult as $rt) {
            $roomTypeNames[(int) $rt['id']] = $rt['name'];
        }
        echo "  ‚úÖ Loaded " . count($roomTypeNames) . " room type names\n\n";

        // Step 5: Process chunks
        echo "üîÑ Step 5: Processing chunks...\n";
        flush();

        // Get current progress
        $lastProcessedChunk = get_option('room_sync_last_chunk', 0);
        $totalProcessed = get_option('room_sync_total_processed', 0);

        if ($forceDownload) {
            update_option('room_sync_last_chunk', 0);
            update_option('room_sync_total_processed', 0);
            $lastProcessedChunk = 0;
            $totalProcessed = 0;
        }

        echo "  üíæ Starting from chunk: $lastProcessedChunk\n";
        echo "  üìä Hotels processed so far: $totalProcessed\n\n";
        flush();

        $hotelsInBatch = 0;
        $imagesInserted = 0;
        $hotelIds = [];
        $chunksProcessed = 0;

        libxml_use_internal_errors(true);

        // Process chunks until batch is full
        for ($chunkNum = $lastProcessedChunk; $chunkNum < $chunkIndex['total_chunks']; $chunkNum++) {
            $chunkFile = $chunksDir . "/chunk_{$chunkNum}.xml";

            if (!file_exists($chunkFile)) {
                echo "  ‚ö†Ô∏è  Chunk file missing: $chunkFile\n";
                continue;
            }

            echo "  üì¶ Processing chunk $chunkNum...\n";
            flush();

            // Load chunk as SimpleXML (much faster than XMLReader for small files)
            $chunkXml = @simplexml_load_file($chunkFile);

            if (!$chunkXml) {
                echo "  ‚ö†Ô∏è  Failed to parse chunk $chunkNum\n";
                continue;
            }

            $hotelsInChunk = count($chunkXml->Hotel);
            echo "  üìä Hotels in this chunk: $hotelsInChunk\n";

            // Process each hotel in chunk
            $hotelsWithRooms = 0;
            $hotelsSkipped = 0;

            foreach ($chunkXml->Hotel as $hotel) {
                $hotelId = (int) $hotel->Id;

                if ($hotelId <= 0) {
                    continue;
                }

                // Get room types
                if (!isset($hotel->RoomTypes) || !isset($hotel->RoomTypes->RoomType)) {
                    $hotelsSkipped++;
                    continue;
                }

                $hotelsWithRooms++;
                $hotelIds[] = $hotelId;
                $roomsProcessed = 0;

                // Hotel-level features apply to every room in the property.
                $hotelFeatureIds = [];
                if (isset($hotel->AllRoomTypeFeatureIds) && isset($hotel->AllRoomTypeFeatureIds->FeatureId)) {
                    foreach ($hotel->AllRoomTypeFeatureIds->FeatureId as $featNode) {
                        $attr = (int) ($featNode['Id'] ?? $featNode['id'] ?? $featNode);
                        if ($attr > 0) {
                            $hotelFeatureIds[] = $attr;
                        }
                    }
                }

                $nowRoomSync = current_time('mysql');
                $roomFacilityFormats = [
                    'hotel_id' => '%d',
                    'room_type_id' => '%d',
                    'beds' => '%s',
                    'extrabeds' => '%s',
                    'max_occupancy' => '%s',
                    'shared_room' => '%s',
                    'shared_facilities' => '%s',
                    'size_in_m2' => '%s',
                    'amenities_json' => '%s',
                    'bed_types_json' => '%s',
                    'customized_room_type' => '%s',
                    'last_synced_at' => '%s',
                    'updated_at' => '%s',
                ];
                $roomFacilityUpserts = [
                    'beds = CASE WHEN VALUES(beds) IS NULL THEN beds ELSE VALUES(beds) END',
                    'extrabeds = CASE WHEN VALUES(extrabeds) IS NULL THEN extrabeds ELSE VALUES(extrabeds) END',
                    'max_occupancy = CASE WHEN VALUES(max_occupancy) IS NULL THEN max_occupancy ELSE VALUES(max_occupancy) END',
                    'shared_room = CASE WHEN VALUES(shared_room) IS NULL THEN shared_room ELSE VALUES(shared_room) END',
                    'shared_facilities = CASE WHEN VALUES(shared_facilities) IS NULL THEN shared_facilities ELSE VALUES(shared_facilities) END',
                    'size_in_m2 = CASE WHEN VALUES(size_in_m2) IS NULL OR VALUES(size_in_m2) <= 0 THEN size_in_m2 ELSE VALUES(size_in_m2) END',
                    'amenities_json = CASE WHEN VALUES(amenities_json) IS NULL THEN amenities_json ELSE VALUES(amenities_json) END',
                    'bed_types_json = CASE WHEN VALUES(bed_types_json) IS NULL THEN bed_types_json ELSE VALUES(bed_types_json) END',
                    'customized_room_type = CASE WHEN VALUES(customized_room_type) IS NULL THEN customized_room_type ELSE VALUES(customized_room_type) END',
                    'last_synced_at = VALUES(last_synced_at)',
                    'updated_at = VALUES(updated_at)',
                ];

                // Process each room type
                foreach ($hotel->RoomTypes->RoomType as $roomType) {
                    $roomTypeId = (int) $roomType->Id;
                    if ($roomTypeId <= 0) {
                        continue;
                    }

                    // Customized occupancy info (format: roomTypeId.beds.extrabeds)
                    $customIds = [];
                    if (isset($roomType->CustomizedRoomTypeIds) && isset($roomType->CustomizedRoomTypeIds->Id)) {
                        foreach ($roomType->CustomizedRoomTypeIds->Id as $cid) {
                            $customIds[] = (string) $cid;
                        }
                    }
                    $customInfo = shorttrips_roomtype_static_parse_customized_ids($customIds);
                    $bedsVal = $customInfo['beds'];
                    $extraBedsVal = $customInfo['extrabeds'];

                    // Gather feature IDs
                    $roomFeatureIds = [];
                    if (isset($roomType->FeatureIds) && isset($roomType->FeatureIds->FeatureId)) {
                        foreach ($roomType->FeatureIds->FeatureId as $featNode) {
                            $attr = (int) ($featNode['Id'] ?? $featNode['id'] ?? $featNode);
                            if ($attr > 0) {
                                $roomFeatureIds[] = $attr;
                            }
                        }
                    }
                    $amenitiesList = shorttrips_roomtype_static_feature_labels(
                        array_merge($hotelFeatureIds, $roomFeatureIds),
                        $featureDictionary ?? []
                    );
                    $amenitiesJson = !empty($amenitiesList)
                        ? wp_json_encode($amenitiesList, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE)
                        : null;

                    // Bed type combinations (determine max occupancy + bed labels)
                    $bedTypeDetails = [];
                    $comboMaxOccupancy = 0;
                    if (isset($roomType->BedTypeCombinations) && isset($roomType->BedTypeCombinations->BedTypeCombination)) {
                        foreach ($roomType->BedTypeCombinations->BedTypeCombination as $combo) {
                            $comboOccupancy = 0;
                            if (isset($combo->BedTypeCombinationDetails) && isset($combo->BedTypeCombinationDetails->BedTypeCombinationDetail)) {
                                foreach ($combo->BedTypeCombinationDetails->BedTypeCombinationDetail as $detail) {
                                    $qty = (int) ($detail->Quantity ?? 0);
                                    $bedTypeId = (int) ($detail->BedTypeId ?? 0);
                                    if ($qty <= 0) {
                                        continue;
                                    }
                                    $comboOccupancy += $qty;
                                    $bedTypeDetails[] = [
                                        'bed_type_id' => $bedTypeId,
                                        'bed_type' => $bedTypeDictionary[$bedTypeId] ?? '',
                                        'quantity' => $qty,
                                    ];
                                }
                            }
                            $comboMaxOccupancy = max($comboMaxOccupancy, $comboOccupancy);
                        }
                    }
                    $bedTypesJson = !empty($bedTypeDetails)
                        ? wp_json_encode($bedTypeDetails, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE)
                        : null;

                    // Extract images
                    $imageUrls = [];
                    if (isset($roomType->ImageIds) && isset($roomType->ImageIds->ImageId)) {
                        foreach ($roomType->ImageIds->ImageId as $imageId) {
                            $url = shorttrips_room_image_url_from_raw((string) $imageId);
                            if ($url) {
                                $imageUrls[] = $url;
                            }
                        }
                    }
                    $imagesJson = !empty($imageUrls)
                        ? wp_json_encode(array_values(array_unique($imageUrls)), JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE)
                        : null;

                    // Room size (m¬≤)
                    $roomSize = null;
                    $sizeCandidates = ['RoomSizeInM2', 'roomSizeInM2', 'RoomSize', 'roomSize'];
                    foreach ($sizeCandidates as $candidate) {
                        if (isset($roomType->{$candidate}) && trim((string) $roomType->{$candidate}) !== '') {
                            $roomSize = (int) round((float) $roomType->{$candidate});
                            if ($roomSize <= 0) {
                                $roomSize = null;
                            }
                            break;
                        }
                    }

                    $maxOccupancy = max(
                        $comboMaxOccupancy,
                        ($bedsVal ?? 0) + ($extraBedsVal ?? 0)
                    );
                    if ($maxOccupancy <= 0) {
                        $maxOccupancy = null;
                    }

                    $roomTypeName = $roomTypeNames[$roomTypeId] ?? '';
                    $displayName = $roomTypeName !== '' ? $roomTypeName : 'Room ' . $roomTypeId;
                    $customJson = !empty($customInfo['raw'])
                        ? wp_json_encode($customInfo['raw'], JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE)
                        : null;

                    // Persist facilities meta for filters
                    $rfData = [
                        'hotel_id' => (int) $hotelId,
                        'room_type_id' => (int) $roomTypeId,
                        'beds' => ($bedsVal !== null ? (int) $bedsVal : null),
                        'extrabeds' => ($extraBedsVal !== null ? (int) $extraBedsVal : null),
                        'max_occupancy' => ($maxOccupancy !== null ? (int) $maxOccupancy : null),
                        'shared_room' => 0,
                        'shared_facilities' => 0,
                        'size_in_m2' => ($roomSize !== null ? (int) $roomSize : null),
                        'amenities_json' => $amenitiesJson,
                        'bed_types_json' => $bedTypesJson,
                        'customized_room_type' => $customJson,
                        'last_synced_at' => $nowRoomSync,
                        'updated_at' => $nowRoomSync,
                    ];
                    shorttrips_wpdb_insert_on_duplicate('ghwk_room_facilities', $rfData, $roomFacilityFormats, $roomFacilityUpserts);

                    // Insert/update hotel-room record
                    $result = $wpdb->query($wpdb->prepare(
                        "INSERT INTO ghwk_hotel_room_types
                        (hotel_id, room_type_id, name, room_type_name, description, amenities_json, bed_types_json, customized_room_type, images_json, size_in_m2, beds, extrabeds, max_occupancy, shared_room, shared_facilities, updated_at)
                     VALUES (%d, %d, %s, %s, %s, NULLIF(%s,''), NULLIF(%s,''), NULLIF(%s,''), NULLIF(%s,''), NULLIF(%s,''), NULLIF(%s,''), NULLIF(%s,''), NULLIF(%s,''), %d, %d, NOW())
                     ON DUPLICATE KEY UPDATE
                        name = VALUES(name),
                        room_type_name = VALUES(room_type_name),
                        description = VALUES(description),
                        amenities_json = VALUES(amenities_json),
                        bed_types_json = VALUES(bed_types_json),
                        customized_room_type = VALUES(customized_room_type),
                        images_json = VALUES(images_json),
                        size_in_m2 = IF(VALUES(size_in_m2) > 0, VALUES(size_in_m2), size_in_m2),
                        beds = IF(VALUES(beds) > 0, VALUES(beds), beds),
                        extrabeds = IF(VALUES(extrabeds) >= 0, VALUES(extrabeds), extrabeds),
                        max_occupancy = IF(VALUES(max_occupancy) > 0, VALUES(max_occupancy), max_occupancy),
                        shared_room = VALUES(shared_room),
                        shared_facilities = VALUES(shared_facilities),
                        updated_at = NOW()",
                        $hotelId,
                        $roomTypeId,
                        sanitize_text_field($displayName),
                        sanitize_text_field($roomTypeName ?: $displayName),
                        null,
                        $amenitiesJson,
                        $bedTypesJson,
                        $customJson,
                        $imagesJson,
                        $roomSize !== null ? (string) $roomSize : '',
                        $bedsVal !== null ? (string) $bedsVal : '',
                        $extraBedsVal !== null ? (string) $extraBedsVal : '',
                        $maxOccupancy !== null ? (string) $maxOccupancy : '',
                        0,
                        0
                    ));

                    if ($result !== false) {
                        $imagesInserted++;
                        $roomsProcessed++;
                    } else {
                        if ($wpdb->last_error) {
                            echo "  ‚ö†Ô∏è  DB Error for Hotel $hotelId, Room $roomTypeId: " . $wpdb->last_error . "\n";
                        }
                    }
                }

                if ($roomsProcessed > 0) {
                    echo "  ‚úÖ Hotel $hotelId: $roomsProcessed room types with images\n";
                }

                $hotelsInBatch++;
                $totalProcessed++;

                // Save progress every 10 hotels
                if ($hotelsInBatch % 10 == 0) {
                    update_option('room_sync_last_hotel_id', $hotelId);
                    update_option('room_sync_total_processed', $totalProcessed);
                    echo "  üíæ Progress saved (processed: $totalProcessed)\n";
                    flush();
                }

                // Stop if we've reached batch size
                if ($hotelsInBatch >= $batchSize) {
                    echo "\n  ‚è∏Ô∏è  Batch limit reached ($batchSize hotels)\n";
                    break 2; // Break out of both foreach and for loops
                }
            } // end foreach hotel

            echo "  üìä Chunk $chunkNum: $hotelsWithRooms hotels with rooms, $hotelsSkipped skipped\n";

            // Save progress after each chunk
            update_option('room_sync_last_chunk', $chunkNum + 1);
            update_option('room_sync_total_processed', $totalProcessed);
            $chunksProcessed++;

        } // end for chunk

        // Check if all chunks done
        if ($chunkNum >= $chunkIndex['total_chunks'] - 1) {
            // Reset for next full sync
            update_option('room_sync_last_chunk', 0);
        }

        echo "\n" . str_repeat("=", 70) . "\n";
        echo "üìä Batch Summary:\n";
        echo "  Hotels in batch: $hotelsInBatch\n";
        echo "  Room types with images inserted: $imagesInserted\n";
        echo "  Total processed so far: $totalProcessed hotels\n";
        echo str_repeat("=", 70) . "\n\n";

        // Check if we should continue
        $allDone = ($chunkNum >= $chunkIndex['total_chunks'] - 1) && ($hotelsInBatch < $batchSize);

        if ($allDone) {
            echo "üéâ All chunks processed! Sync complete.\n\n";

            // Reset progress
            update_option('room_sync_last_chunk', 0);
            update_option('room_sync_total_processed', 0);

            echo "‚úÖ Progress reset. Ready for next sync.\n";
        } else if ($autoMode) {
            echo "üîÑ AUTO MODE: Continuing to next batch...\n";
            echo "‚è±Ô∏è  Waiting 2 seconds...\n";
            flush();
            sleep(2);

            $nonce = wp_create_nonce('shorttrips_sync');
            $nextUrl = home_url("/?sync_room_images=1&_wpnonce={$nonce}&batch_size={$batchSize}&auto=1");

            echo "‚û°Ô∏è  Redirecting to next batch...\n\n";
            flush();

            // Switch to HTML mode for redirect
            header('Content-Type: text/html; charset=utf-8');
            echo "<!DOCTYPE html><html><head><meta charset='utf-8'>";
            echo "<meta http-equiv='refresh' content='2;url=" . htmlspecialchars($nextUrl) . "'>";
            echo "<script>setTimeout(function(){ window.location.href = " . json_encode($nextUrl) . "; }, 2000);</script>";
            echo "</head><body><pre>";
            echo "Redirecting in 2 seconds...\n";
            echo "If not redirected automatically, click: <a href='" . htmlspecialchars($nextUrl) . "'>Continue</a>";
            echo "</pre></body></html>";
        } else {
            echo "‚úÖ Batch complete!\n\n";
            echo "üìã Continue sync:\n";
            $nonce = wp_create_nonce('shorttrips_sync');
            echo "  Manual: " . home_url("/?sync_room_images=1&_wpnonce={$nonce}&batch_size={$batchSize}") . "\n";
            echo "  Auto:   " . home_url("/?sync_room_images=1&_wpnonce={$nonce}&batch_size={$batchSize}&auto=1") . "\n";
        }

    } catch (Exception $e) {
        echo "\n‚ùå CRITICAL ERROR:\n";
        echo "Error: " . $e->getMessage() . "\n";
        echo "File: " . $e->getFile() . "\n";
        echo "Line: " . $e->getLine() . "\n\n";
        echo "Stack trace:\n" . $e->getTraceAsString() . "\n";
    }

    exit;
});

/**
 * Convert a raw image token (ID or URL) into a proper Sunhotels image URL.
 * Uses the public hotelimages.sunhotels.net CDN (same as hotel images).
 */
function shorttrips_room_image_url_from_raw($raw)
{
    if ($raw === '') {
        return null;
    }

    if (filter_var($raw, FILTER_VALIDATE_URL)) {
        return $raw;
    }

    if (preg_match('/(\d{5,})/', $raw, $m)) {
        $id = $m[1];
        // Use public Sunhotels image CDN (no authentication required)
        return "https://hotelimages.sunhotels.net/HotelInfo/hotelImage.aspx?id=" . $id . "&full=1";
    }

    return null;
}

/**
 * Extract global dictionaries (Features, BedTypes, etc.) from the RoomTypeStaticData XML.
 *
 * @param string $xmlFile Absolute path to the extracted XML file.
 * @return array{features: array<int,string>, bed_types: array<int,string>}
 */
function shorttrips_roomtype_static_extract_dictionaries($xmlFile)
{
    $result = [
        'features' => [],
        'bed_types' => [],
    ];
    if (!is_readable($xmlFile)) {
        return $result;
    }
    $reader = new XMLReader();
    if (!$reader->open($xmlFile, null, LIBXML_PARSEHUGE | LIBXML_BIGLINES)) {
        return $result;
    }
    while ($reader->read()) {
        if ($reader->nodeType !== XMLReader::ELEMENT) {
            continue;
        }
        $localName = $reader->localName;
        if ($localName === 'Features' || $localName === 'BedTypes') {
            $outer = $reader->readOuterXml();
            if (!$outer) {
                continue;
            }
            $wrapped = simplexml_load_string($outer);
            if (!$wrapped) {
                continue;
            }
            if ($localName === 'Features') {
                foreach ($wrapped->children() as $feature) {
                    $id = (int) ($feature['Id'] ?? $feature['id'] ?? 0);
                    $desc = trim((string) ($feature['Description'] ?? $feature['description'] ?? $feature));
                    if ($id > 0 && $desc !== '') {
                        $result['features'][$id] = $desc;
                    }
                }
            } elseif ($localName === 'BedTypes') {
                foreach ($wrapped->children() as $bedType) {
                    $id = (int) ($bedType['Id'] ?? $bedType['id'] ?? 0);
                    $desc = trim((string) ($bedType['Description'] ?? $bedType['description'] ?? $bedType));
                    if ($id > 0 && $desc !== '') {
                        $result['bed_types'][$id] = $desc;
                    }
                }
            }
        }
        // Stop once we start hitting hotel nodes to avoid scanning the full file twice.
        if ($localName === 'Hotel') {
            break;
        }
    }
    $reader->close();
    return $result;
}

/**
 * Provide room cards solely from the static DB when live API data is unavailable.
 *
 * @param int $hotelId
 * @param int $limit
 * @return array<int, array<string,mixed>>
 */
function shorttrips_prebook_local_room_fallback($hotelId, $limit = 120)
{
    global $wpdb;
    if ($hotelId <= 0) {
        return [];
    }
    static $tableAvailable = null;
    if ($tableAvailable === null) {
        $tableAvailable = (bool) $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", 'ghwk_hotel_room_types'));
    }
    if (!$tableAvailable) {
        return [];
    }
    $limit = max(10, min((int) $limit, 200));
    $rows = $wpdb->get_results($wpdb->prepare(
        "SELECT room_type_id, name, room_type_name, description, amenities_json, bed_types_json,
                size_in_m2, beds, extrabeds, max_occupancy, shared_room, shared_facilities, updated_at
         FROM ghwk_hotel_room_types
         WHERE hotel_id = %d
         ORDER BY updated_at DESC
         LIMIT {$limit}",
        $hotelId
    ), ARRAY_A);
    if (!$rows) {
        return [];
    }

    $fallbackRooms = [];
    foreach ($rows as $row) {
        $amenList = [];
        if (!empty($row['amenities_json'])) {
            $decodedAmen = json_decode($row['amenities_json'], true);
            if (is_array($decodedAmen)) {
                foreach ($decodedAmen as $entry) {
                    $label = '';
                    if (is_array($entry)) {
                        if (isset($entry['name'])) {
                            $label = (string) $entry['name'];
                        } elseif (isset($entry[1])) {
                            $label = (string) $entry[1];
                        } elseif (isset($entry[0])) {
                            $label = (string) $entry[0];
                        }
                    } else {
                        $label = (string) $entry;
                    }
                    $label = trim($label);
                    if ($label !== '') {
                        $amenList[] = $label;
                    }
                }
            }
        }

        $bedNotes = [];
        if (!empty($row['bed_types_json'])) {
            $decodedBeds = json_decode($row['bed_types_json'], true);
            if (is_array($decodedBeds)) {
                foreach ($decodedBeds as $bedEntry) {
                    if (!is_array($bedEntry)) {
                        continue;
                    }
                    $bedLabel = isset($bedEntry['bed_type']) ? trim((string) $bedEntry['bed_type']) : '';
                    $bedQty = isset($bedEntry['quantity']) ? (int) $bedEntry['quantity'] : 0;
                    if ($bedLabel === '') {
                        continue;
                    }
                    $bedNotes[] = ($bedQty > 0 ? $bedQty . '√ó ' : '') . $bedLabel;
                }
            }
        }

        $fallbackRooms[] = [
            'type' => $row['name'] ?: ($row['room_type_name'] ?: ('Room ' . ((string) ($row['room_type_id'] ?? '')))),
            'room_type_id' => isset($row['room_type_id']) ? (int) $row['room_type_id'] : null,
            'meal' => 'Op aanvraag',
            'price' => 0,
            'desc' => $row['description'] ?? '',
            'policy' => 'Live prijs niet beschikbaar',
            'beds' => isset($row['beds']) && $row['beds'] !== '' ? (int) $row['beds'] : null,
            'extrabeds' => isset($row['extrabeds']) && $row['extrabeds'] !== '' ? (int) $row['extrabeds'] : null,
            'shared_room' => (int) ($row['shared_room'] ?? 0),
            'shared_facilities' => (int) ($row['shared_facilities'] ?? 0),
            'superdeal' => false,
            'bestbuy' => false,
            'amen' => array_values(array_unique($amenList)),
            'room_id' => null,
            'room_notes' => array_values(array_unique($bedNotes)),
            'size_in_m2' => isset($row['size_in_m2']) ? (int) $row['size_in_m2'] : 0,
            'max_occupancy' => isset($row['max_occupancy']) && $row['max_occupancy'] !== '' ? (int) $row['max_occupancy'] : null,
        ];
    }

    return $fallbackRooms;
}

/**
 * Map a list of feature IDs to human readable labels using the provided dictionary.
 *
 * @param array<int|string> $ids
 * @param array<int,string> $dict
 * @return array<int,string>
 */
function shorttrips_roomtype_static_feature_labels(array $ids, array $dict)
{
    $labels = [];
    foreach ($ids as $raw) {
        $id = (int) $raw;
        if ($id > 0 && isset($dict[$id])) {
            $labels[$id] = $dict[$id];
        }
    }
    return array_values($labels);
}

/**
 * Parse CustomizedRoomTypeIds (format: roomTypeId.beds.extraBeds) into structured info.
 *
 * @param array<int|string> $idStrings
 * @return array{raw: array, beds: int|null, extrabeds: int|null}
 */
function shorttrips_roomtype_static_parse_customized_ids(array $idStrings)
{
    $beds = null;
    $extraBeds = null;
    foreach ($idStrings as $raw) {
        $raw = trim((string) $raw);
        if ($raw === '') {
            continue;
        }
        $parts = explode('.', $raw);
        if (count($parts) >= 3) {
            $maybeBeds = (int) $parts[1];
            $maybeExtra = (int) $parts[2];
            if ($maybeBeds > 0) {
                $beds = max($beds ?? 0, $maybeBeds);
            }
            if ($maybeExtra >= 0) {
                $extraBeds = max($extraBeds ?? 0, $maybeExtra);
            }
        }
    }
    return [
        'raw' => array_values(array_filter(array_map('strval', $idStrings))),
        'beds' => $beds,
        'extrabeds' => $extraBeds,
    ];
}

// OLD CODE BELOW - REMOVE EVERYTHING FROM HERE TO LINE 23359
/*
    $creds = function_exists('shorttrips_get_api_credentials')
        ? shorttrips_get_api_credentials()
        : ['username' => '', 'password' => '', 'language' => 'en'];
    
    if (empty($creds['username']) || empty($creds['password'])) {
        echo "‚ùå API credentials missing (shorttrips_get_api_credentials).\n";
        exit;
    }
    
    echo "üîë API Username: {$creds['username']}\n\n";
    
    // Check if we should skip directly to parsing (debug mode)
    $skipToXml = isset($_GET['skip_extract']) && $_GET['skip_extract'] === '1';
    
    if ($skipToXml) {
        echo "‚ö° SKIP MODE: Going directly to XML parsing\n\n";
        
        $uploadDir = wp_upload_dir();
        $tempDir = $uploadDir['basedir'] . '/temp_roomimages';
        
        // Manually specify XML file path
        $xmlFile = $tempDir . '/RoomTypeStaticData_en.xml';
        
        if (!file_exists($xmlFile)) {
            echo "‚ùå XML file not found at: $xmlFile\n";
            echo "üí° Available files in directory:\n";
            if (is_dir($tempDir)) {
                $files = scandir($tempDir);
                foreach ($files as $f) {
                    if ($f !== '.' && $f !== '..') {
                        echo "   - $f\n";
                    }
                }
            }
            exit;
        }
        
        echo "‚úÖ Found XML file: " . basename($xmlFile) . "\n";
        echo "üìä File size: " . number_format(filesize($xmlFile)) . " bytes\n\n";
        
        // Jump directly to Step 3 (parsing)
        goto parse_xml;
    }
    
    // Create tables if not exist
    echo "üîß Checking database tables...\n";
    
    // Check if table exists and has images_json column
    $tableExists = $wpdb->get_var("SHOW TABLES LIKE 'ghwk_hotel_room_types'");
    
    if (!$tableExists) {
        $wpdb->query("CREATE TABLE ghwk_hotel_room_types (
            id INT AUTO_INCREMENT PRIMARY KEY,
            hotel_id INT NOT NULL,
            room_type_id INT NOT NULL,
            name VARCHAR(500),
            room_type_name VARCHAR(500),
            images_json JSON,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            UNIQUE KEY unique_hotel_room (hotel_id, room_type_id),
            INDEX idx_hotel_id (hotel_id),
            INDEX idx_room_type_id (room_type_id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");
        echo "‚úÖ Created ghwk_hotel_room_types table\n";
    } else {
        // Check if images_json column exists
        $hasImagesJson = $wpdb->get_var("SHOW COLUMNS FROM ghwk_hotel_room_types LIKE 'images_json'");
        if (!$hasImagesJson) {
            $wpdb->query("ALTER TABLE ghwk_hotel_room_types ADD COLUMN images_json JSON AFTER room_type_name");
            echo "‚úÖ Added images_json column to ghwk_hotel_room_types\n";
        }
        echo "‚úÖ Table ghwk_hotel_room_types ready\n";
    }
    
    echo "\n";
    
    // Step 1: Check for existing ZIP or download new one
    echo "üì• Step 1: Checking for existing ZIP file...\n";
    flush();
    
    $uploadDir = wp_upload_dir();
    $tempDir = $uploadDir['basedir'] . '/temp_roomimages';
    
    // Check if temp directory exists
    if (!is_dir($tempDir)) {
        if (!wp_mkdir_p($tempDir)) {
            echo "‚ùå Failed to create temp directory: $tempDir\n";
            exit;
        }
        echo "‚úÖ Created temp directory: $tempDir\n";
    }
    
    // Look for existing ZIP files
    $existingZips = glob($tempDir . '/roomtypes*.zip');
    $useExistingZip = false;
    $zipFile = null;
    $zipData = null;
    
    if (!empty($existingZips)) {
        // Use most recent ZIP if less than 24 hours old
        usort($existingZips, function($a, $b) { return filemtime($b) - filemtime($a); });
        $latestZip = $existingZips[0];
        $zipAge = time() - filemtime($latestZip);
        
        if ($zipAge < 86400) { // 24 hours
            $zipFile = $latestZip;
            $useExistingZip = true;
            echo "‚úÖ Found existing ZIP (age: " . round($zipAge / 3600, 1) . " hours): " . basename($zipFile) . "\n";
            echo "üìä ZIP size: " . number_format(filesize($zipFile)) . " bytes\n";
            echo "üí° Using existing ZIP (skip download)\n\n";
        }
    }
    
    if (!$useExistingZip) {
        echo "üåê Downloading new ZIP from SunHotels...\n";
        
        $downloadUrl = 'https://xml.sunhotels.net/15/DownloadExport.aspx'
            . '?username=' . urlencode($creds['username'])
            . '&password=' . urlencode($creds['password'])
            . '&language=' . urlencode($creds['language'] ?? 'en')
            . '&xmlType=RoomTypeStaticData'
            . '&format=zip'
            . '&version=170';
        
        echo "üì¶ Parameters: username={$creds['username']}, language=en, xmlType=RoomTypeStaticData\n";
        flush();
        
        $startTime = microtime(true);
        $response = wp_remote_get($downloadUrl, [
            'timeout' => 300,
            'stream' => false,
            'sslverify' => false
        ]);
        $duration = round(microtime(true) - $startTime, 2);
        
        echo "‚è±Ô∏è  Download completed in {$duration}s\n";
        
        if (is_wp_error($response)) {
            echo "‚ùå Download Error: " . $response->get_error_message() . "\n";
            exit;
        }
        
        $zipData = wp_remote_retrieve_body($response);
        if (!$zipData || strlen($zipData) < 100) {
            echo "‚ùå Empty or invalid ZIP response\n";
            exit;
        }
        
        echo "üìä Downloaded ZIP size: " . number_format(strlen($zipData)) . " bytes\n";
        
        // Save new ZIP
        $zipFile = $tempDir . '/roomtypes_' . time() . '.zip';
        file_put_contents($zipFile, $zipData);
        echo "‚úÖ Saved ZIP to: " . basename($zipFile) . "\n\n";
    }
    
    // Step 2: Check for existing extracted XML or extract ZIP
    echo "üìÇ Step 2: Looking for XML file...\n";
    echo "üìÅ Checking directory: $tempDir\n";
    
    // First check if XML already exists (manually extracted)
    // Try both lowercase and uppercase extensions
    $xmlFiles = array_merge(
        glob($tempDir . '/*.xml'),
        glob($tempDir . '/*.XML')
    );
    $xmlFile = null;
    
    // Also try scandir as fallback
    if (empty($xmlFiles) && is_dir($tempDir)) {
        $allFiles = scandir($tempDir);
        echo "üîç All files in directory:\n";
        foreach ($allFiles as $file) {
            if ($file === '.' || $file === '..') continue;
            $fullPath = $tempDir . '/' . $file;
            if (is_file($fullPath)) {
                $ext = strtolower(pathinfo($file, PATHINFO_EXTENSION));
                echo "   - $file (ext: $ext, size: " . number_format(filesize($fullPath)) . " bytes)\n";
                if ($ext === 'xml') {
                    $xmlFiles[] = $fullPath;
                }
            }
        }
    }
    
    echo "üîç Found " . count($xmlFiles) . " XML files\n";
    
    if (!empty($xmlFiles)) {
        $xmlFile = $xmlFiles[0];
        $xmlSize = filesize($xmlFile);
        echo "‚úÖ Found existing XML file: " . basename($xmlFile) . "\n";
        echo "üìä XML size: " . number_format($xmlSize) . " bytes\n";
        
        // Check if XML is valid (not empty and reasonable size)
        if ($xmlSize > 1000000) { // > 1MB means it's probably valid
            echo "üí° Using existing XML (skip extraction)\n\n";
        } else {
            echo "‚ö†Ô∏è  XML file seems too small, will re-extract from ZIP\n";
            @unlink($xmlFile);
            $xmlFile = null;
        }
    }
    
    // If no XML found, extract from ZIP
    if (!$xmlFile) {
        echo "üì¶ Extracting ZIP file: " . basename($zipFile) . "\n";
        echo "‚è±Ô∏è  This may take 1-3 minutes for large files...\n";
        flush();
        
        $extractStartTime = microtime(true);
        
        // Extract ZIP using WP_Filesystem
        WP_Filesystem();
        global $wp_filesystem;
        
        $result = unzip_file($zipFile, $tempDir);
        if (is_wp_error($result)) {
            echo "‚ùå Unzip error: " . $result->get_error_message() . "\n";
            echo "\nüí° TIP: You can manually extract the ZIP and upload the .xml file to: {$tempDir}/\n";
            exit;
        }
        
        $extractDuration = round(microtime(true) - $extractStartTime, 2);
        echo "‚úÖ ZIP extracted successfully in {$extractDuration}s\n";
        
        // Find XML file
        echo "üîç Looking for XML file in extracted content...\n";
        $files = $wp_filesystem->dirlist($tempDir);
        
        foreach ($files as $filename => $fileinfo) {
            if (substr($filename, -4) === '.xml') {
                $xmlFile = $tempDir . '/' . $filename;
                echo "‚úÖ Found XML file: $filename\n";
                break;
            }
        }
        
        if (!$xmlFile || !file_exists($xmlFile)) {
            echo "‚ùå No XML file found after extraction\n";
            exit;
        }
    }
    
    // Step 3: Parse XML file
    echo "\nüìÑ Step 3: Parsing XML file...\n";
    echo "üìä XML file: " . basename($xmlFile) . "\n";
    echo "‚ö†Ô∏è  Large file - this will take 2-3 minutes, please wait...\n";
    flush();
    
    $parseStartTime = microtime(true);
    
    // Parse with DOMDocument (load directly from file)
    $doc = new DOMDocument();
    libxml_use_internal_errors(true);
    
    echo "üîÑ Loading XML...\n";
    flush();
    
    if (!@$doc->load($xmlFile)) {
        echo "‚ùå XML parse error\n";
        $errors = libxml_get_errors();
        if ($errors) {
            echo "Error: " . $errors[0]->message . "\n";
        }
        libxml_clear_errors();
        exit;
    }
    
    $parseDuration = round(microtime(true) - $parseStartTime, 2);
    echo "‚úÖ XML loaded in {$parseDuration}s\n\n";
    
    // Get hotels with XPath
    $xp = new DOMXPath($doc);
    $hotelNodes = $xp->query('//Hotel');
    
    echo "üè® Found " . $hotelNodes->length . " hotels\n\n";
    
    // Load room type names from lookup table
    echo "üìö Loading room type names...\n";
    $roomTypeNames = [];
    $roomTypesFromDb = $wpdb->get_results("SELECT id, name FROM ghwk_room_types", ARRAY_A);
    foreach ($roomTypesFromDb as $rt) {
        if (!empty($rt['name'])) {
            $roomTypeNames[intval($rt['id'])] = $rt['name'];
        }
    }
    echo "‚úÖ Loaded " . count($roomTypeNames) . " room type names\n";
    echo "üîÑ Processing hotels...\n\n";
    flush();
    
    // Process hotels
    $updated = 0;
    $skipped_no_images = 0;
    $skipped_no_roomtype = 0;
    $skipped_no_name = 0;
    $now = current_time('mysql');
    $processed = 0;
    
    foreach ($hotelNodes as $hotelNode) {
        // Get hotel ID
        $hotelIdNodes = $hotelNode->getElementsByTagName('Id');
        if ($hotelIdNodes->length === 0) continue;
        
        $hotelId = intval($hotelIdNodes->item(0)->textContent);
        if ($hotelId <= 0) continue;
        
        $processed++;
        
        if ($processed % 100 === 0) {
            echo "  üìä Progress: $processed / " . $hotelNodes->length . " hotels, $updated room types saved\n";
            flush();
        }
        
        // Get room types
        $roomTypesNodes = $hotelNode->getElementsByTagName('RoomTypes');
        if ($roomTypesNodes->length === 0) {
            $skipped_no_roomtype++;
            continue;
        }
        
        $roomTypesList = $roomTypesNodes->item(0)->getElementsByTagName('RoomType');
        if ($roomTypesList->length === 0) {
            $skipped_no_roomtype++;
            continue;
        }
        
        // Process room types
        foreach ($roomTypesList as $rtNode) {
            // Get room type ID
            $rtIdNodes = $rtNode->getElementsByTagName('Id');
            if ($rtIdNodes->length === 0) continue;
            
            $roomTypeId = intval($rtIdNodes->item(0)->textContent);
            if ($roomTypeId <= 0) continue;
            
                // Save to database
                $result = $wpdb->query($wpdb->prepare(
                    "INSERT INTO ghwk_hotel_room_types
                        (hotel_id, room_type_id, name, room_type_name, images_json, updated_at)
                     VALUES (%d, %d, %s, %s, %s, %s)
                     ON DUPLICATE KEY UPDATE
                        name = VALUES(name),
                        room_type_name = VALUES(room_type_name),
                        images_json = VALUES(images_json),
                        updated_at = VALUES(updated_at)",
                    $currentHotelId,
                    $currentRoomTypeId,
                    $roomTypeName,
                    $roomTypeName,
                    wp_json_encode(array_keys($urls), JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE),
                    $now
                ));
    
    // Cleanup temp files (keep ZIP for next run, only delete extracted XML)
    echo "\nüßπ Cleaning up...\n";
    if (isset($xmlFile) && file_exists($xmlFile)) {
        @unlink($xmlFile);
    }
    // Clean up old ZIP files (keep only the most recent)
    $existingZips = glob($tempDir . '/roomtypes*.zip');
    if (count($existingZips) > 1) {
        usort($existingZips, function($a, $b) { return filemtime($b) - filemtime($a); });
        array_shift($existingZips); // Keep the newest
        foreach ($existingZips as $oldZip) {
            @unlink($oldZip);
        }
    }
    echo "‚úÖ Cleanup complete (kept most recent ZIP for future use)\n";
    
    $totalHotels = $wpdb->get_var("SELECT COUNT(DISTINCT hotel_id) FROM ghwk_hotel_room_types");
    $totalRooms = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_hotel_room_types");
    
    echo "\n" . str_repeat("=", 60) . "\n";
    echo "‚úÖ SYNC FINISHED!\n";
    echo str_repeat("=", 60) . "\n";
    echo "üìä Hotels processed: $processed\n";
    echo "üìä Records updated: $updated\n";
    echo "üìä Skipped (no name in lookup): $skipped_no_name\n";
    echo "üìä Skipped (no images): $skipped_no_images\n";
    echo "üìä Skipped (no room types): $skipped_no_roomtype\n";
    echo "üìä Total hotels with room images: $totalHotels\n";
    echo "üìä Total room type records: $totalRooms\n";
    
    // Show sample
    if ($totalRooms > 0) {
        echo "\nüìã Sample room types with images:\n";
        $samples = $wpdb->get_results("
            SELECT hotel_id, room_type_id, room_type_name, 
                   JSON_LENGTH(images_json) as image_count
            FROM ghwk_hotel_room_types 
            WHERE images_json IS NOT NULL 
            ORDER BY updated_at DESC 
            LIMIT 10
        ", ARRAY_A);
        foreach ($samples as $s) {
            echo "  - Hotel {$s['hotel_id']}, Room Type {$s['room_type_id']}: {$s['room_type_name']} ({$s['image_count']} images)\n";
        }
    }
    
    exit;
});

// -----------------------------------------------------------------------------
// ROOM TYPES CLEANUP & RE-SYNC - FIXED
// URL: /?sync_room_types_cleanup=1
// This will delete invalid entries (/name, etc) and re-sync with proper parsing
// -----------------------------------------------------------------------------
add_action('template_redirect', function() {
    if (!isset($_GET['sync_room_types_cleanup']) || $_GET['sync_room_types_cleanup'] !== '1') {
        return;
    }
    
    if (!is_user_logged_in() || !current_user_can('manage_options')) {
        status_header(403);
        exit('Not allowed');
    }
    
    nocache_headers();
    while (ob_get_level()) ob_end_clean();
    
    @set_time_limit(0); // No time limit
    @ini_set('memory_limit', '2048M'); // More memory for large XML
    @ini_set('max_execution_time', '0');
    
    header('Content-Type: text/plain; charset=utf-8');
    echo "=== ROOM TYPES CLEANUP & RE-SYNC ===\n\n";
    
    global $wpdb;
    $wpdb->show_errors();
    
    // Step 1: Clean up invalid entries
    echo "üßπ Step 1: Cleaning up invalid room types...\n";
    
    $invalidPatterns = [
        '/name',
        'wrong code',
        'cnl',
        '/id ',
        'id name'
    ];
    
    $deleted = 0;
    foreach ($invalidPatterns as $pattern) {
        $result = $wpdb->query($wpdb->prepare(
            "DELETE FROM ghwk_room_types WHERE name LIKE %s",
            '%' . $wpdb->esc_like($pattern) . '%'
        ));
        if ($result) {
            echo "  ‚úÖ Deleted $result entries containing '$pattern'\n";
            flush();
            $deleted += $result;
        }
    }
    
    $remaining = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
    echo "  üìä Total deleted: $deleted\n";
    echo "  üìä Remaining: $remaining\n\n";
    flush();
    
    // Step 2: Re-sync from API
    echo "üîÑ Step 2: Re-syncing from API with proper parsing...\n";
    
    // Get API credentials
    $creds = function_exists('shorttrips_get_api_credentials') 
        ? shorttrips_get_api_credentials() 
        : ['username' => 'Freestays', 'password' => '', 'language' => 'en'];
    
    echo "üîë API Username: {$creds['username']}\n";
    echo "üì§ Calling GetRoomTypes API...\n";
    flush();
    
    // Call Static API
    $endpoint = 'https://xml.sunhotels.net/15/PostGet/StaticXMLAPI.asmx';
    
    $soap = '<?xml version="1.0" encoding="utf-8"?>'
        . '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'
        . '<soap:Body>'
        . '<GetRoomTypes xmlns="http://xml.sunhotels.net/15/">'
        . '<userName>'.esc_html($creds['username']).'</userName>'
        . '<password>'.esc_html($creds['password']).'</password>'
        . '<language>'.esc_html($creds['language']).'</language>'
        . '</GetRoomTypes>'
        . '</soap:Body>'
        . '</soap:Envelope>';
    
    $startTime = microtime(true);
    $response = wp_remote_post($endpoint, [
        'headers' => [
            'Content-Type' => 'text/xml; charset=utf-8',
            'SOAPAction' => '"http://xml.sunhotels.net/15/GetRoomTypes"'
        ],
        'body' => $soap,
        'timeout' => 240
    ]);
    
    if (is_wp_error($response)) {
        echo "‚ùå API error: " . $response->get_error_message() . "\n";
        exit;
    }
    
    $body = wp_remote_retrieve_body($response);
    if (empty($body)) {
        echo "‚ùå Empty response\n";
        exit;
    }
    
    $responseTime = microtime(true) - $startTime;
    $responseSize = strlen($body);
    echo "‚úÖ API response received: " . number_format($responseSize) . " bytes in " . number_format($responseTime, 2) . "s\n";
    
    if ($responseSize > 5000000) {
        echo "‚ö†Ô∏è  Large response (" . number_format($responseSize / 1024 / 1024, 2) . " MB) - processing may take time...\n";
    }
    flush();
    
    // Parse XML with DOMDocument (same as meals sync)
    echo "üìÑ Parsing XML with DOMDocument...\n";
    
    libxml_use_internal_errors(true);
    libxml_clear_errors();
    
    $dom = new DOMDocument();
    $loaded = $dom->loadXML($body, LIBXML_NOCDATA);
    
    if (!$loaded) {
        echo "‚ùå DOMDocument failed to load XML\n";
        $errors = libxml_get_errors();
        if ($errors) {
            echo "Errors:\n";
            foreach ($errors as $error) {
                echo "  Line {$error->line}: " . trim($error->message) . "\n";
            }
        }
        libxml_clear_errors();
        exit;
    }
    
    echo "‚úÖ XML parsed successfully\n";
    
    // Use XPath to find room types
    $xpath = new DOMXPath($dom);
    $xpath->registerNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
    $xpath->registerNamespace('sh', 'http://xml.sunhotels.net/15/');
    
    // Try different XPath patterns
    $patterns = [
        '//sh:roomTypes/sh:roomType',
        '//roomType',
        '//sh:roomType'
    ];
    
    $roomNodes = null;
    $usedPattern = '';
    
    foreach ($patterns as $pattern) {
        $roomNodes = $xpath->query($pattern);
        if ($roomNodes && $roomNodes->length > 0) {
            $usedPattern = $pattern;
            break;
        }
    }
    
    if (!$roomNodes || $roomNodes->length === 0) {
        echo "‚ùå No room types found\n";
        echo "Tried patterns: " . implode(', ', $patterns) . "\n";
        exit;
    }
    
    echo "üîç Found " . $roomNodes->length . " room types (pattern: $usedPattern)\n";
    echo "üîÑ Processing...\n\n";
    
    $updated = 0;
    $failed = 0;
    $skipped = 0;
    $progress = 0;
    
    foreach ($roomNodes as $roomNode) {
        // Extract data from DOM nodes (try both with and without namespace)
        $idNode = $xpath->query('.//sh:id', $roomNode)->item(0);
        if (!$idNode) {
            $idNode = $xpath->query('.//id', $roomNode)->item(0);
        }
        
        $nameNode = $xpath->query('.//sh:name', $roomNode)->item(0);
        if (!$nameNode) {
            $nameNode = $xpath->query('.//name', $roomNode)->item(0);
        }
        
        $id = $idNode ? intval($idNode->textContent) : 0;
        $name = $nameNode ? trim($nameNode->textContent) : '';
        
        // Clean HTML entities
        $name = html_entity_decode($name, ENT_QUOTES | ENT_XML1, 'UTF-8');
        $name = trim($name);
        
        // Show first 10
        if ($updated + $failed + $skipped < 10) {
            echo "  Sample: ID=$id, Name=" . substr($name, 0, 60) . "\n";
        }
        
        // Skip invalid
        if ($id <= 0 || empty($name) || strlen($name) < 2) {
            $skipped++;
            continue;
        }
        
        // Skip if name contains invalid patterns
        $isInvalid = false;
        foreach ($invalidPatterns as $pattern) {
            if (stripos($name, $pattern) !== false) {
                $isInvalid = true;
                break;
            }
        }
        
        if ($isInvalid) {
            $skipped++;
            continue;
        }
        
        // Insert into database
        $result = $wpdb->query($wpdb->prepare(
            "REPLACE INTO ghwk_room_types (id, name, updated_at) VALUES (%d, %s, NOW())",
            $id, $name
        ));
        
        if ($result !== false) {
            $updated++;
        } else {
            $failed++;
            if ($failed <= 3) {
                echo "  ‚ùå Insert failed for ID=$id: " . $wpdb->last_error . "\n";
            }
        }
        
        // Progress indicator for large datasets
        $progress++;
        if ($progress % 5000 === 0) {
            $percent = round(($progress / $roomNodes->length) * 100, 1);
            echo "  üìà Progress: " . number_format($progress) . " / " . $roomNodes->length . " ($percent%)\n";
            flush();
            
            // Force output
            if (ob_get_level() > 0) {
                ob_flush();
            }
        }
    }
    
    $total = $wpdb->get_var("SELECT COUNT(*) FROM ghwk_room_types");
    
    echo "\nüìä RESULTS:\n";
    echo "  ‚úÖ Successfully synced: " . number_format($updated) . "\n";
    echo "  ‚ùå Failed inserts: $failed\n";
    echo "  ‚ö†Ô∏è  Skipped (invalid): " . number_format($skipped) . "\n";
    echo "  üìä Total in database: " . number_format($total) . "\n";
    
    if ($total > 0) {
        echo "\nüìã Sample from database (first 10):\n";
        $samples = $wpdb->get_results("SELECT id, name FROM ghwk_room_types ORDER BY id LIMIT 10", ARRAY_A);
        foreach ($samples as $s) {
            echo "  - ID {$s['id']}: {$s['name']}\n";
        }
        
        echo "\nüìã Check for remaining invalid entries:\n";
        $invalid = $wpdb->get_results("SELECT id, name FROM ghwk_room_types WHERE name LIKE '%/name%' LIMIT 5", ARRAY_A);
        if (empty($invalid)) {
            echo "  ‚úÖ No invalid entries found!\n";
        } else {
            echo "  ‚ö†Ô∏è  Found " . count($invalid) . " invalid entries:\n";
            foreach ($invalid as $inv) {
                echo "    - ID {$inv['id']}: {$inv['name']}\n";
            }
        }
    }
    
    echo "\n‚úÖ Room types cleanup and re-sync complete!\n";
    
    exit;
});

// END OF SYNC NOTE TYPES - All old XML structure debug code replaced with FIXED versions

// -----------------------------------------------------------------------------
// WOOCOMMERCE ORDER CREATION - FREESTAYS HOTEL BOOKING
// -----------------------------------------------------------------------------
/**
 * AJAX Handler: Create WooCommerce Order for Hotel Booking
 * 
 * This is called when user clicks "Ga naar betaling" on checkout page.
 * Creates a WC order with hotel booking details and redirects to WC checkout.
 * 
 * Flow:
 * 1. User fills Freestays checkout form
 * 2. Clicks "Ga naar betaling"
 * 3. AJAX call to this function
 * 4. Create WC order with booking data
 * 5. Redirect to WC checkout (Stripe payment)
 * 6. After payment: trigger SunHotels booking (see below)
 */
add_action('wp_ajax_freestays_create_order', 'freestays_create_wc_order');
add_action('wp_ajax_nopriv_freestays_create_order', 'freestays_create_wc_order');

function freestays_create_wc_order()
{
    // Verify nonce
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'freestays_checkout')) {
        wp_send_json_error(['message' => 'Security check failed']);
        return;
    }

    // Validate required data
    $hotel_id = isset($_POST['hotel_id']) ? intval($_POST['hotel_id']) : 0;
    $checkin = isset($_POST['checkin']) ? sanitize_text_field($_POST['checkin']) : '';
    $checkout = isset($_POST['checkout']) ? sanitize_text_field($_POST['checkout']) : '';
    $price = isset($_POST['price']) ? floatval($_POST['price']) : 0;
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';

    if ($hotel_id <= 0 || $price <= 0 || empty($email) || empty($checkin) || empty($checkout)) {
        wp_send_json_error(['message' => 'Ongeldige booking data. Controleer alle velden.']);
        return;
    }

    // Get hotel name from database
    global $wpdb;
    $hotel = $wpdb->get_row($wpdb->prepare(
        "SELECT title, hotelname FROM ghwk_bravo_hotels WHERE hotel_id=%d",
        $hotel_id
    ));
    $hotel_name = $hotel ? ($hotel->hotelname ?: $hotel->title) : 'Hotel #' . $hotel_id;

    try {
        // Haal (optioneel) bestaande gebruiker op of cre√´er later bij welkomstoptie
        $user_id = get_current_user_id();

        // Create WooCommerce order
        $order = wc_create_order([
            'customer_id' => $user_id ?: 0,
        ]);

        // Product name with dates
        $product_name = sprintf(
            '%s - %s t/m %s',
            $hotel_name,
            date('d-m-Y', strtotime($checkin)),
            date('d-m-Y', strtotime($checkout))
        );

        // Add hotel booking as virtual product
        $item = new WC_Order_Item_Product();
        $item->set_name($product_name);
        $item->set_quantity(1);
        $item->set_subtotal($price);
        $item->set_total($price);
        $order->add_item($item);

        // Add booking fee
        $booking_fee = 15.00;
        $fee = new WC_Order_Item_Fee();
        $fee->set_name('Boekingskosten');
        $fee->set_amount($booking_fee);
        $fee->set_total($booking_fee);
        $order->add_item($fee);

        // Handle voucher discount and purchase
        $voucher_code = isset($_POST['voucher_code']) ? sanitize_text_field($_POST['voucher_code']) : '';
        $voucher_purchase = isset($_POST['voucher_purchase']) ? sanitize_text_field($_POST['voucher_purchase']) : '';

        if (!empty($voucher_code)) {
            // Apply existing voucher (15% discount)
            $discount = $price * 0.15;
            $coupon_item = new WC_Order_Item_Coupon();
            $coupon_item->set_code($voucher_code);
            $coupon_item->set_discount($discount);
            $order->add_item($coupon_item);

        } elseif (!empty($voucher_purchase)) {
            if ($voucher_purchase === 'welcome') {
                // Welkomstoptie: maak (eenmalig) welkomstcoupon aan voor gebruiker en pas direct 15% voordeel toe
                if (!$user_id) {
                    // Probeer gebruiker te vinden op basis van e‚Äëmail
                    $maybe_user = get_user_by('email', $email);
                    if ($maybe_user && $maybe_user->ID) {
                        $user_id = (int) $maybe_user->ID;
                    }
                }
                if ($user_id) {
                    if (function_exists('freestays_award_welcome_coupon')) {
                        freestays_award_welcome_coupon($user_id);
                    }
                    $welcome_code = get_user_meta($user_id, 'freestays_welcome_coupon_code', true);
                    // Toepassen als coupon-item (voor transparantie), maar zonder deze code nogmaals naar Stripe te pushen
                    if ($welcome_code) {
                        $discount = $price * 0.15;
                        $coupon_item = new WC_Order_Item_Coupon();
                        $coupon_item->set_code($welcome_code);
                        $coupon_item->set_discount($discount);
                        $order->add_item($coupon_item);
                    } else {
                        // Fallback: voeg in ieder geval een duidelijk Freestays voordeel toe
                        $discount = $price * 0.15;
                        $discount_fee = new WC_Order_Item_Fee();
                        $discount_fee->set_name('Freestays voordeel (15%)');
                        $discount_fee->set_amount(-$discount);
                        $discount_fee->set_total(-$discount);
                        $order->add_item($discount_fee);
                    }
                } else {
                    // Geen user kunnen koppelen: behandel als regulier Freestays voordeel zonder code
                    $discount = $price * 0.15;
                    $discount_fee = new WC_Order_Item_Fee();
                    $discount_fee->set_name('Freestays voordeel (15%)');
                    $discount_fee->set_amount(-$discount);
                    $discount_fee->set_total(-$discount);
                    $order->add_item($discount_fee);
                }
            } else {
                // Betaalde voucher / jaarkaart purchase
                $voucher_cost = ($voucher_purchase === 'fj') ? 129.00 : 35.00;
                $voucher_name = ($voucher_purchase === 'fj') ?
                    'Freestays Jaarkaart' : 'Freestays Hotel Cheque';

                $voucher_item = new WC_Order_Item_Product();
                $voucher_item->set_name($voucher_name);
                $voucher_item->set_quantity(1);
                $voucher_item->set_subtotal($voucher_cost);
                $voucher_item->set_total($voucher_cost);
                $order->add_item($voucher_item);

                // Apply 15% discount on hotel booking
                $discount = $price * 0.15;
                $discount_fee = new WC_Order_Item_Fee();
                $discount_fee->set_name('Freestays voordeel (15%)');
                $discount_fee->set_amount(-$discount);
                $discount_fee->set_total(-$discount);
                $order->add_item($discount_fee);
            }
        }

        // Set billing address
        $order->set_billing_first_name(isset($_POST['first_name']) ? sanitize_text_field($_POST['first_name']) : '');
        $order->set_billing_last_name(isset($_POST['last_name']) ? sanitize_text_field($_POST['last_name']) : '');
        $order->set_billing_email($email);
        $order->set_billing_phone(isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '');
        $order->set_billing_address_1(isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '');
        $order->set_billing_postcode(isset($_POST['postcode']) ? sanitize_text_field($_POST['postcode']) : '');
        $order->set_billing_city(isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '');
        $order->set_billing_country(isset($_POST['country']) ? sanitize_text_field($_POST['country']) : 'NL');

        // Add custom meta data for SunHotels booking
        $order->update_meta_data('_freestays_booking', 'yes');
        $order->update_meta_data('_hotel_id', $hotel_id);
        $order->update_meta_data('_hotel_name', $hotel_name);
        $order->update_meta_data('_checkin', $checkin);
        $order->update_meta_data('_checkout', $checkout);
        $order->update_meta_data('_rooms', isset($_POST['rooms']) ? intval($_POST['rooms']) : 1);
        $order->update_meta_data('_adults', isset($_POST['adults']) ? intval($_POST['adults']) : 2);
        $order->update_meta_data('_children', isset($_POST['children']) ? intval($_POST['children']) : 0);
        $order->update_meta_data('_child_ages', isset($_POST['child_ages']) ? sanitize_text_field($_POST['child_ages']) : '');
        $order->update_meta_data('_room_type', isset($_POST['room_type']) ? sanitize_text_field($_POST['room_type']) : '');
        $order->update_meta_data('_meal', isset($_POST['meal']) ? sanitize_text_field($_POST['meal']) : '');
        $order->update_meta_data('_policy', isset($_POST['policy']) ? sanitize_text_field($_POST['policy']) : '');
        $order->update_meta_data('_booking_status', 'pending'); // Will change after API call
        $order->update_meta_data('_room_id', isset($_POST['room_id']) ? sanitize_text_field($_POST['room_id']) : '');

        // Calculate totals
        $order->calculate_totals();

        // Save order
        $order->save();

        // Log order creation// Return success with checkout URL
        wp_send_json_success([
            'order_id' => $order->get_id(),
            'checkout_url' => $order->get_checkout_payment_url()
        ]);

    } catch (Exception $e) {
        wp_send_json_error(['message' => 'Order kon niet aangemaakt worden. Probeer het opnieuw.']);
    }
}

// -----------------------------------------------------------------------------
// WOOCOMMERCE PAYMENT COMPLETE HOOK - TRIGGER SUNHOTELS BOOKING
// -----------------------------------------------------------------------------
/**
 * üö® KRITIEK: Dit is waar we SunHotels boeken NA succesvolle betaling!
 * 
 * Hook: woocommerce_order_status_processing
 * Triggered: Na succesvolle Stripe payment
 * 
 * Flow:
 * 1. Stripe payment succeeds
 * 2. WooCommerce order status ‚Üí "Processing"
 * 3. This hook triggers
 * 4. We call SunHotels API to create booking
 * 5. Save booking reference to order
 * 6. Send confirmation email (WC handles this)
 */
add_action('woocommerce_order_status_processing', 'freestays_process_hotel_booking', 10, 1);

function freestays_process_hotel_booking($order_id)
{
    $order = wc_get_order($order_id);

    if (!$order) {
        return;
    }

    // Check if this is a Freestays hotel booking
    if ($order->get_meta('_freestays_booking') !== 'yes') {
        return; // Not our booking, skip
    }

    // üö® KRITIEK: BLOKKEER SUNHOTELS BOOKINGS IN TEST MODE! üö®
    // Check if Stripe is in test mode
    $stripe_settings = get_option('woocommerce_stripe_settings', []);
    $is_test_mode = isset($stripe_settings['testmode']) && $stripe_settings['testmode'] === 'yes';

    if ($is_test_mode) {
        $order->update_meta_data('_booking_status', 'test_mode_skip');
        $order->add_order_note('üß™ TEST MODE: SunHotels booking NIET uitgevoerd. Switch naar live mode om bookings te activeren.');
        $order->save();
        return; // STOP! Geen booking in test mode
    }

    // Check if already processed (prevent duplicates)
    $booking_status = $order->get_meta('_booking_status');
    if ($booking_status === 'confirmed' || $booking_status === 'processing') {
        return;
    }

    // Mark as processing to prevent duplicate calls
    $order->update_meta_data('_booking_status', 'processing');
    $order->save();// Get booking data from order meta
    $booking_data = [
        'hotel_id' => $order->get_meta('_hotel_id'),
        'hotel_name' => $order->get_meta('_hotel_name'),
        'checkin' => $order->get_meta('_checkin'),
        'checkout' => $order->get_meta('_checkout'),
        'rooms' => $order->get_meta('_rooms'),
        'adults' => $order->get_meta('_adults'),
        'children' => $order->get_meta('_children'),
        'child_ages' => $order->get_meta('_child_ages'),
        'room_type' => $order->get_meta('_room_type'),
        'meal' => $order->get_meta('_meal'),
        'policy' => $order->get_meta('_policy'),
        'room_id' => $order->get_meta('_room_id'),
        'customer_name' => $order->get_billing_first_name() . ' ' . $order->get_billing_last_name(),
        'customer_email' => $order->get_billing_email(),
        'customer_phone' => $order->get_billing_phone(),
        'order_id' => $order_id,
        'order_total' => $order->get_total(),
    ];

    // Call SunHotels API
    $result = freestays_create_sunhotels_booking($booking_data);

    if ($result['success']) {
        // ‚úÖ Success! Save booking reference
        $order->update_meta_data('_booking_status', 'confirmed');
        $order->update_meta_data('_sunhotels_reference', $result['booking_reference']);
        $order->update_meta_data('_sunhotels_booked_at', current_time('mysql'));
        $order->save();

        // Add order note
        $order->add_order_note(sprintf(
            '‚úÖ SunHotels booking succesvol!<br>Referentie: <strong>%s</strong>',
            esc_html($result['booking_reference'])
        ));
    } else {
        // ‚ùå Booking failed!
        $order->update_meta_data('_booking_status', 'failed');
        $order->update_meta_data('_booking_error', $result['error']);
        $order->update_meta_data('_booking_failed_at', current_time('mysql'));
        $order->save();

        // Add order note
        $order->add_order_note(sprintf(
            '‚ùå SunHotels booking GEFAALD!<br>Error: %s<br><br>Actie vereist: Boek handmatig of refund.',
            esc_html($result['error'])
        ));

        // Email admin
        $admin_email = get_option('admin_email');
        $subject = 'üö® Freestays Booking Failed - Order #' . $order_id;
        $message = sprintf(
            "Order #%d heeft betaling ontvangen maar SunHotels booking is gefaald.\n\n" .
            "KLANT:\n" .
            "Naam: %s\n" .
            "Email: %s\n" .
            "Telefoon: %s\n\n" .
            "HOTEL:\n" .
            "Hotel: %s (ID: %s)\n" .
            "Check-in: %s\n" .
            "Check-out: %s\n" .
            "Kamers: %s\n\n" .
            "ERROR:\n" .
            "%s\n\n" .
            "ACTIE VEREIST:\n" .
            "1. Probeer handmatig te boeken bij SunHotels\n" .
            "2. Of refund de betaling aan klant\n" .
            "3. Informeer klant over status\n\n" .
            "Order bekijken: %s",
            $order_id,
            $booking_data['customer_name'],
            $booking_data['customer_email'],
            $booking_data['customer_phone'],
            $booking_data['hotel_name'],
            $booking_data['hotel_id'],
            date('d-m-Y', strtotime($booking_data['checkin'])),
            date('d-m-Y', strtotime($booking_data['checkout'])),
            $booking_data['rooms'],
            $result['error'],
            admin_url('post.php?post=' . $order_id . '&action=edit')
        );

        wp_mail($admin_email, $subject, $message);
    }
}

// -----------------------------------------------------------------------------
// SUNHOTELS BOOKING API FUNCTION
// -----------------------------------------------------------------------------
/**
 * Create booking at SunHotels via NonStatic API
 * 
 * TODO: Verify exact API method and parameters with SunHotels documentation
 * This is a template based on common SOAP booking APIs
 * 
 * @param array $data Booking data
 * @return array ['success' => bool, 'booking_reference' => string, 'error' => string]
 */
function freestays_create_sunhotels_booking($data)
{
    // Get API credentials
    $creds = shorttrips_get_sunhotels_credentials();
    $username = $creds['username'];
    $password = $creds['password'];
    $language = $creds['language'];
    $currency = $creds['currency'];

    // Parse child ages
    $child_ages_str = '';
    if (!empty($data['child_ages'])) {
        $ages = array_map('intval', explode(',', $data['child_ages']));
        foreach ($ages as $age) {
            $child_ages_str .= '<sh:childAge>' . $age . '</sh:childAge>';
        }
    }

    // Build SOAP request

    $soap_envelope = '<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" 
               xmlns:sh="http://xml.sunhotels.net/15/">
  <soap:Body>
    <sh:Book>
      <sh:userName>' . esc_xml($username) . '</sh:userName>
      <sh:password>' . esc_xml($password) . '</sh:password>
      <sh:language>' . esc_xml($language) . '</sh:language>
      <sh:currency>' . esc_xml($currency) . '</sh:currency>
      <sh:roomId>' . esc_xml($data['room_id']) . '</sh:roomId>
      <sh:checkIn>' . esc_xml($data['checkin']) . '</sh:checkIn>
      <sh:checkOut>' . esc_xml($data['checkout']) . '</sh:checkOut>
      <sh:numberOfRooms>' . intval($data['rooms']) . '</sh:numberOfRooms>
      <sh:numberOfAdults>' . intval($data['adults']) . '</sh:numberOfAdults>
      <sh:numberOfChildren>' . intval($data['children']) . '</sh:numberOfChildren>
      ' . $child_ages_str . '
      <sh:customerTitle>Mr</sh:customerTitle>
      <sh:customerFirstName>' . esc_xml(explode(' ', $data['customer_name'])[0]) . '</sh:customerFirstName>
      <sh:customerLastName>' . esc_xml(substr($data['customer_name'], strpos($data['customer_name'], ' ') + 1)) . '</sh:customerLastName>
      <sh:customerEmail>' . esc_xml($data['customer_email']) . '</sh:customerEmail>
      <sh:customerPhone>' . esc_xml($data['customer_phone']) . '</sh:customerPhone>
      <sh:externalReference>ORDER-' . intval($data['order_id']) . '</sh:externalReference>
    </sh:Book>
  </soap:Body>
</soap:Envelope>';

    // Log request (without sensitive data)// Send request
    $response = wp_remote_post('https://xml.sunhotels.net/15/PostGet/NonStaticXMLAPI.asmx', [
        'headers' => [
            'Content-Type' => 'text/xml; charset=utf-8',
            'SOAPAction' => 'http://xml.sunhotels.net/15/Book'
        ],
        'body' => $soap_envelope,
        'timeout' => 30
    ]);

    if (is_wp_error($response)) {
        return [
            'success' => false,
            'error' => 'API connection failed: ' . $response->get_error_message()
        ];
    }

    $body = wp_remote_retrieve_body($response);

    // Parse response
    libxml_use_internal_errors(true);
    $xml = simplexml_load_string($body);

    if ($xml === false) {
        $errors = libxml_get_errors();
        $error_msg = !empty($errors) ? $errors[0]->message : 'XML parse error';
        return [
            'success' => false,
            'error' => 'Invalid API response: ' . $error_msg
        ];
    }

    // Register namespace
    $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');
    $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');

    // Check for errors first
    $errors = $xml->xpath('//sh:Error | //Error');
    if (!empty($errors)) {
        $error_msg = isset($errors[0]->Message) ? (string) $errors[0]->Message : 'Unknown error';
        return [
            'success' => false,
            'error' => 'SunHotels error: ' . $error_msg
        ];
    }

    // Extract booking reference

    $references = $xml->xpath('//sh:bookingReference | //bookingReference | //sh:confirmationNumber | //confirmationNumber');

    if (!empty($references)) {
        $booking_ref = (string) $references[0];
        return [
            'success' => true,
            'booking_reference' => $booking_ref
        ];
    } else {
        // Log full response for debugging
        return [
            'success' => false,
            'error' => 'No booking reference in response'
        ];
    }
}

// -----------------------------------------------------------------------------
// VOUCHER AUTO-GENERATIE NA SUCCESVOLLE BETALING
// -----------------------------------------------------------------------------
/**
 * Automatisch voucher codes genereren na succesvolle betaling
 * 
 * Hook: woocommerce_order_status_processing (na Stripe payment success)
 * 
 * Detecteert Jaarkaart/Hotel Cheque aankoop en:
 * 1. Genereert unieke code (FJ2026-XXXX of FHC-XXXX)
 * 2. Maakt WooCommerce coupon aan (15% discount)
 * 3. Slaat code op in order meta
 * 4. Stuurt email naar klant met code
 * 5. Code direct bruikbaar voor volgende booking
 */
add_action('woocommerce_order_status_processing', 'freestays_generate_voucher_for_order', 20, 1);

function freestays_generate_voucher_for_order($order_id)
{
    $order = wc_get_order($order_id);

    if (!$order) {
        return;
    }

    // Check if voucher already generated (prevent duplicates)
    if ($order->get_meta('_voucher_generated') === 'yes') {
        return;
    }

    // üö® KRITIEK: BLOKKEER VOUCHER GENERATIE IN TEST MODE! üö®
    // Check if Stripe is in test mode
    $stripe_settings = get_option('woocommerce_stripe_settings', []);
    $is_test_mode = isset($stripe_settings['testmode']) && $stripe_settings['testmode'] === 'yes';

    if ($is_test_mode) {
        $order->add_order_note('üß™ TEST MODE: Voucher codes NIET gegenereerd. Switch naar live mode om vouchers te activeren.');
        $order->save();
        return; // STOP! Geen vouchers in test mode
    }

    $vouchers_created = [];
    $voucher_used_in_booking = false;

    // Loop through order items to find voucher products
    foreach ($order->get_items() as $item) {
        $product_name = $item->get_name();

        // Detect voucher type
        $type = null;
        $usage_limit = null;
        $voucher_product_name = '';

        if (stripos($product_name, 'Jaarkaart') !== false) {
            $type = 'FJ';
            $usage_limit = 0; // Unlimited for 1 year
            $voucher_product_name = 'Freestays Jaarkaart';

        } elseif (
            stripos($product_name, 'Hotel Cheque') !== false ||
            stripos($product_name, 'Cheque') !== false
        ) {
            $type = 'FHC';
            $usage_limit = 1; // Already used in this booking!
            $voucher_product_name = 'Freestays Hotel Cheque';
        }

        if (!$type) {
            continue; // Not a voucher product
        }

        // Generate unique code
        $code = freestays_generate_voucher_code($type);

        // Check if this order is also a hotel booking (voucher purchased WITH booking)
        $is_hotel_booking = ($order->get_meta('_freestays_booking') === 'yes');

        // Set usage count: 1 if used in this booking, 0 if still available
        $usage_count = 0;
        if ($is_hotel_booking && $type === 'FHC') {
            // Hotel Cheque was used immediately in this booking
            $usage_count = 1;
            $voucher_used_in_booking = true;
        }

        // Create WooCommerce coupon
        $coupon_id = freestays_create_wc_coupon([
            'code' => $code,
            'type' => $type,
            'discount_percent' => 15,
            'usage_limit' => $usage_limit,
            'usage_count' => $usage_count,
            'order_id' => $order_id,
            'customer_email' => $order->get_billing_email(),
            'used_in_booking' => $voucher_used_in_booking,
        ]);

        if ($coupon_id) {
            $vouchers_created[] = [
                'code' => $code,
                'type' => $type,
                'name' => $voucher_product_name,
                'used' => $voucher_used_in_booking,
            ];
        } else {
        }
    }

    // If vouchers were created, update order
    if (!empty($vouchers_created)) {
        $codes_string = implode(', ', array_column($vouchers_created, 'code'));
        $order->update_meta_data('_voucher_generated', 'yes');
        $order->update_meta_data('_voucher_codes', $codes_string);
        $order->update_meta_data('_voucher_details', $vouchers_created);

        // Add order note (visible in admin)
        $note_parts = [];
        foreach ($vouchers_created as $v) {
            $note_parts[] = sprintf(
                '<strong>%s</strong>%s',
                $v['code'],
                $v['used'] ? ' (direct gebruikt in deze boeking)' : ''
            );
        }

        $order->add_order_note(sprintf(
            'üé´ Voucher code(s) gegenereerd: %s',
            implode(', ', $note_parts)
        ));

        $order->save();

        // NO separate email - voucher info will be in booking confirmation
        // (Email is handled by WooCommerce order email)
    }
}

/**
 * Generate unique voucher code
 * 
 * Format:
 * - Jaarkaart: FJ2026-A3B7C9
 * - Hotel Cheque: FHC-A3B7C9
 * 
 * Uses MD5 hash of uniqid for randomness
 * Checks for collisions (very rare)
 */
function freestays_generate_voucher_code($type)
{
    // Format: FJ2026-XXXX or FHC-XXXX
    $year = date('Y');
    $random = strtoupper(substr(md5(uniqid(mt_rand(), true)), 0, 6));

    if ($type === 'FJ') {
        $code = 'FJ' . $year . '-' . $random;
    } else {
        $code = 'FHC-' . $random;
    }

    // Check if code already exists (collision prevention)
    if (wc_get_coupon_id_by_code($code)) {
        // Collision! Try again (very rare, but possible)return freestays_generate_voucher_code($type);
    }

    return $code;
}

/**
 * Create WooCommerce coupon programmatically
 * 
 * Settings:
 * - 15% discount
 * - Individual use (cannot combine)
 * - Email restricted (only for buyer)
 * - Usage limit (0=unlimited, 1=once)
 * - Expiry (1 year for FJ, none for FHC)
 */
function freestays_create_wc_coupon($data)
{
    try {
        $coupon = new WC_Coupon();

        // Basic settings
        $coupon->set_code($data['code']);
        $coupon->set_discount_type('percent'); // Percentage discount
        $coupon->set_amount(15); // 15%
        $coupon->set_usage_limit($data['usage_limit']); // 0 = unlimited, 1 = once

        // Set initial usage count (if voucher was used immediately)
        if (isset($data['usage_count']) && $data['usage_count'] > 0) {
            $coupon->set_usage_count($data['usage_count']);
        }

        // Advanced settings
        $coupon->set_individual_use(true); // Cannot combine with other coupons
        $coupon->set_email_restrictions([$data['customer_email']]); // Only for this customer
        $coupon->set_free_shipping(false);

        // Expiry (1 year for FJ, no expiry for FHC)
        if ($data['type'] === 'FJ') {
            $expiry = date('Y-m-d', strtotime('+1 year'));
            $coupon->set_date_expires($expiry);
        }

        // Meta data for tracking
        $coupon->update_meta_data('_freestays_voucher', 'yes');
        $coupon->update_meta_data('_voucher_type', $data['type']);
        $coupon->update_meta_data('_source_order_id', $data['order_id']);
        $coupon->update_meta_data('_generated_at', current_time('mysql'));

        if (isset($data['used_in_booking']) && $data['used_in_booking']) {
            $coupon->update_meta_data('_used_in_source_order', 'yes');
        }

        // Description (visible in admin)
        $description = sprintf(
            'Freestays %s - Gegenereerd voor order #%d op %s%s',
            ($data['type'] === 'FJ' ? 'Jaarkaart' : 'Hotel Cheque'),
            $data['order_id'],
            date('d-m-Y H:i'),
            (isset($data['used_in_booking']) && $data['used_in_booking'] ? ' (direct gebruikt)' : '')
        );
        $coupon->set_description($description);

        // Save
        $coupon_id = $coupon->save();

        if ($coupon_id) {
            return $coupon_id;
        } else {
            return false;
        }

    } catch (Exception $e) {
        return false;
    }
}

/**
 * Email voucher codes to customer
 * 
 * Sends plain text email with:
 * - Thank you message
 * - Voucher code(s)
 * - Usage instructions
 */
function freestays_email_voucher_codes($order, $codes)
{
    $to = $order->get_billing_email();
    $customer_name = $order->get_billing_first_name();
    $subject = 'Uw Freestays Voucher Code(s)';

    // Build code list
    $code_list = '';
    foreach ($codes as $code) {
        $code_list .= 'üé´ ' . $code . "\n";
    }

    // Email message
    $message = sprintf(
        "Beste %s,\n\n" .
        "Bedankt voor uw aankoop bij Freestays!\n\n" .
        "Uw voucher code(s):\n\n" .
        "%s\n" .
        "U kunt deze code(s) gebruiken bij uw volgende booking op Shorttrips.eu\n\n" .
        "Hoe te gebruiken:\n" .
        "1. Ga naar Shorttrips.eu en kies uw hotel\n" .
        "2. Vul uw gegevens in bij de checkout\n" .
        "3. Voer de voucher code in\n" .
        "4. Ontvang 15%% korting op uw boeking\n\n" .
        "Veel plezier met uw reis!\n\n" .
        "Met vriendelijke groet,\n" .
        "Het Freestays Team\n\n" .
        "---\n" .
        "Order #%d\n" .
        "Datum: %s",
        $customer_name,
        $code_list,
        $order->get_id(),
        date('d-m-Y H:i')
    );

    // Headers
    $headers = [
        'Content-Type: text/plain; charset=UTF-8',
        'From: Freestays <noreply@shorttrips.eu>'
    ];

    // Send email
    $sent = wp_mail($to, $subject, $message, $headers);

    if ($sent) {
    } else {
    }

    return $sent;
}

// -----------------------------------------------------------------------------
// VOUCHER INFO IN WOOCOMMERCE ORDER EMAIL
// -----------------------------------------------------------------------------
/**
 * Voeg voucher info toe aan WooCommerce order confirmation email
 * 
 * Toont onderaan de email:
 * "Uw aankoop [type] en bedrag van [‚Ç¨35/‚Ç¨129] hebben wij direct toegepast in uw reservering."
 */
add_action('woocommerce_email_order_meta', 'freestays_add_voucher_to_order_email', 10, 3);

function freestays_add_voucher_to_order_email($order, $sent_to_admin, $plain_text)
{
    // Only for customer emails (not admin)
    if ($sent_to_admin) {
        return;
    }

    // Check if vouchers were generated
    $voucher_details = $order->get_meta('_voucher_details');
    if (empty($voucher_details)) {
        return;
    }

    // Check if this is also a hotel booking
    $is_hotel_booking = ($order->get_meta('_freestays_booking') === 'yes');
    if (!$is_hotel_booking) {
        return; // Only show for combined booking+voucher orders
    }

    // Build voucher text
    foreach ($voucher_details as $voucher) {
        if (!$voucher['used']) {
            continue; // Skip vouchers that weren't used immediately
        }

        // Determine amount
        $amount = ($voucher['type'] === 'FJ') ? '‚Ç¨129,00' : '‚Ç¨35,00';

        if ($plain_text) {
            echo "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
            echo "VOUCHER INFORMATIE\n";
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n";
            echo "Uw aankoop " . $voucher['name'] . " (" . $amount . ") hebben wij direct toegepast in uw reservering.\n";
            echo "Code: " . $voucher['code'] . "\n\n";
        } else {
            ?>
            <div style="margin-top:20px;padding:15px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px">
                <h3 style="margin:0 0 10px 0;color:#0c4a6e;font-size:16px">üé´ Voucher Informatie</h3>
                <p style="margin:0;color:#374151">
                    <strong>Uw aankoop <?php echo esc_html($voucher['name']); ?> (<?php echo $amount; ?>)</strong>
                    hebben wij direct toegepast in uw reservering.
                </p>
                <p style="margin:10px 0 0 0;color:#6b7280;font-size:14px">
                    Code: <strong><?php echo esc_html($voucher['code']); ?></strong>
                </p>
            </div>
            <?php
        }
    }
}

// -----------------------------------------------------------------------------
// AJAX: VALIDATE VOUCHER CODE
// -----------------------------------------------------------------------------
/**
 * Valideer of een voucher code geldig en beschikbaar is
 * 
 * Used by: Checkout form (regel 4837-4883)
 * 
 * Checks:
 * 1. Code bestaat als WooCommerce coupon
 * 2. Code is niet verlopen
 * 3. Code heeft nog usage left (niet op gebruikt)
 * 
 * Returns:
 * - success: true/false
 * - message: error message indien niet geldig
 */
add_action('wp_ajax_validate_voucher_code', 'freestays_validate_voucher_code');
add_action('wp_ajax_nopriv_validate_voucher_code', 'freestays_validate_voucher_code');

function freestays_validate_voucher_code()
{
    $code = isset($_POST['code']) ? sanitize_text_field($_POST['code']) : '';

    if (empty($code)) {
        wp_send_json_error(['message' => 'Geen code opgegeven']);
        return;
    }

    // Check if code exists as WooCommerce coupon
    $coupon = new WC_Coupon($code);

    if (!$coupon || !$coupon->get_id()) {
        wp_send_json_error(['message' => 'Code niet gevonden']);
        return;
    }

    // Check if coupon is valid (not expired, usage limit, etc)
    $is_valid = $coupon->is_valid();

    if (is_wp_error($is_valid)) {
        wp_send_json_error(['message' => $is_valid->get_error_message()]);
        return;
    }

    // Check usage limit
    $usage_limit = $coupon->get_usage_limit();
    $usage_count = $coupon->get_usage_count();

    if ($usage_limit > 0 && $usage_count >= $usage_limit) {
        wp_send_json_error(['message' => 'Deze code is al gebruikt']);
        return;
    }

    // Check expiry date
    $expiry_date = $coupon->get_date_expires();
    if ($expiry_date && $expiry_date->getTimestamp() < time()) {
        wp_send_json_error(['message' => 'Deze code is verlopen']);
        return;
    }

    // All checks passed!
    wp_send_json_success([
        'code' => $code,
        'discount_amount' => $coupon->get_amount(),
        'discount_type' => $coupon->get_discount_type()
    ]);
}

// =============================================================================
// üöÄ GLOBAL PAGINATION SCRIPT - ALWAYS LOADED
// =============================================================================
// This script is loaded on every page to ensure pagination works even when
// results are loaded via AJAX after initial page load
// =============================================================================
add_action('wp_footer', function () {
    ?>
    <style>
        /* Amenity items hover effect - consistent styling across all pages */
        .st-amenity-item:hover {
            background: #eff6ff !important;
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1);
        }
    </style>

    <script>
        // ‚úÖ GLOBAL PAGINATION HANDLER
        // Ensure pagination function exists globally
        if (typeof window.initShortTripsPagination !== "function") {
            window.initShortTripsPagination = function () {
                console.log("üöÄ ShortTrips Pagination: Initializing (global)...");

                // ‚úÖ CRITICAL: Load payload from data attribute BEFORE checking buttons
                var payloadEl = document.getElementById("st-search-payload");
                if (payloadEl) {
                    try {
                        var payloadData = payloadEl.getAttribute("data-payload");
                        if (payloadData) {
                            window.stLastSearchPayload = JSON.parse(payloadData);
                            console.log("‚úÖ Search payload loaded from data attribute:", window.stLastSearchPayload);
                        }
                    } catch (e) {
                        console.error("‚ùå Failed to parse payload:", e);
                    }
                }

                var pagerButtons = document.querySelectorAll(".st-pager-btn");

                if (!pagerButtons || pagerButtons.length === 0) {
                    console.log("‚è≠Ô∏è No pagination buttons (single page or no results)");
                    return;
                }

                console.log("‚úÖ Found " + pagerButtons.length + " pagination buttons");

                pagerButtons.forEach(function (btn) {
                    // Remove existing handler to prevent duplicates
                    btn.removeEventListener("click", btn._paginationHandler);

                    btn._paginationHandler = function (e) {
                        e.preventDefault();

                        var targetPage = parseInt(btn.getAttribute("data-page"));
                        console.log("üìÑ Pagination: Loading page " + targetPage);

                        var payload = window.stLastSearchPayload || {};

                        if (!payload.action) {
                            console.error("‚ùå No search payload found!");
                            return;
                        }

                        payload.page = targetPage;

                        var resultsContainer = document.querySelector(".st-fullbleed");
                        if (resultsContainer) {
                            resultsContainer.innerHTML = '<div style="text-align:center;padding:60px 20px;"><div style="display:inline-block;width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 0.8s linear infinite;"></div><p style="margin-top:16px;color:#6b7280;">Pagina laden...</p></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
                            resultsContainer.scrollIntoView({ behavior: "smooth", block: "start" });
                        }

                        var formData = new FormData();
                        for (var key in payload) {
                            if (payload.hasOwnProperty(key)) {
                                var val = payload[key];
                                if (Array.isArray(val)) {
                                    val.forEach(function (v) { formData.append(key + "[]", v); });
                                } else if (val !== null && val !== undefined && val !== "") {
                                    formData.append(key, val);
                                }
                            }
                        }

                        console.log("üì§ Sending AJAX request for page " + targetPage);

                        fetch('<?php echo admin_url('admin-ajax.php'); ?>', {
                            method: "POST",
                            body: formData,
                            credentials: "same-origin"
                        })
                            .then(function (r) {
                                if (!r.ok) throw new Error("HTTP " + r.status);
                                return r.text();
                            })
                            .then(function (html) {
                                console.log("‚úÖ Page " + targetPage + " loaded successfully");
                                if (resultsContainer) {
                                    resultsContainer.innerHTML = html;
                                }

                                // ‚úÖ CRITICAL: Update payload with new page number BEFORE re-init
                                if (window.stLastSearchPayload) {
                                    window.stLastSearchPayload.page = targetPage;
                                    console.log("‚úÖ Payload updated with page:", targetPage);
                                } else {
                                    console.warn("‚ö†Ô∏è No payload to update - this should not happen!");
                                }

                                var urlParams = new URLSearchParams(window.location.search);
                                urlParams.set("page", targetPage);
                                window.history.replaceState({}, "", "?" + urlParams.toString());

                                setTimeout(window.initShortTripsPagination, 100);
                                console.log("‚úÖ Pagination re-initialized for new page");
                            })
                            .catch(function (err) {
                                console.error("‚ùå Pagination error:", err);
                                if (resultsContainer) {
                                    resultsContainer.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#ef4444;"><p><strong>‚ùå Fout bij laden van pagina</strong></p><p style="margin-top:8px;color:#6b7280;">Probeer het opnieuw</p></div>';
                                }
                            });
                    };

                    btn.addEventListener("click", btn._paginationHandler);
                });

                console.log("‚úÖ ShortTrips Pagination: AJAX handlers attached");
            };
        }

        // Always try to init (safe to call multiple times)
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", window.initShortTripsPagination);
        } else {
            window.initShortTripsPagination();
        }

        // ‚úÖ CRITICAL: Re-init when results container changes (AJAX loads)
        var paginationObserver = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                // Check if pagination buttons were added
                var addedButtons = false;
                mutation.addedNodes.forEach(function (node) {
                    if (node.nodeType === 1) { // Element node
                        if (node.classList && node.classList.contains("st-pager-btn")) {
                            addedButtons = true;
                        } else if (node.querySelector && node.querySelector(".st-pager-btn")) {
                            addedButtons = true;
                        }
                    }
                });

                if (addedButtons) {
                    console.log("üîÑ Pagination buttons detected via MutationObserver, re-initializing...");
                    setTimeout(window.initShortTripsPagination, 50);
                }
            });
        });

        // Observe the body for changes
        paginationObserver.observe(document.body, {
            childList: true,
            subtree: true
        });

        console.log("üëÅÔ∏è MutationObserver active: watching for pagination buttons");
    </script>
    <script>
        (function () {
            function bindCardExtras() {
                if (window.__stCardExtrasBound) { return; }
                window.__stCardExtrasBound = true;
                document.addEventListener("click", function (e) {
                    var descBtn = e.target && e.target.closest ? e.target.closest(".st-desc-toggle") : null;
                    if (descBtn) {
                        var targetId = descBtn.getAttribute("data-target");
                        if (!targetId) return;
                        var targetEl = document.getElementById(targetId);
                        if (!targetEl) return;
                        var fullText = targetEl.getAttribute("data-full") || "";
                        var shortText = targetEl.getAttribute("data-short") || "";
                        var expanded = targetEl.classList.toggle("is-expanded");
                        targetEl.textContent = expanded ? fullText : shortText;
                        descBtn.textContent = expanded ? "Lees minder" : "Lees meer";
                        return;
                    }
                    var featureBtn = e.target && e.target.closest ? e.target.closest(".st-features-more") : null;
                    if (featureBtn) {
                        var html = featureBtn.getAttribute("data-hidden") || "";
                        var card = featureBtn.closest(".st-hotel-card");
                        if (!card) return;
                        var popup = card.querySelector(".st-features-popup");
                        if (!popup) return;
                        popup.classList.add("active");
                        var content = popup.querySelector(".st-features-content");
                        if (content) { content.innerHTML = html; }
                        return;
                    }
                    var closeBtn = e.target && e.target.closest ? e.target.closest("[data-close]") : null;
                    if (closeBtn) {
                        var closeId = closeBtn.getAttribute("data-close");
                        var popupEl = document.getElementById("st-popup-" + closeId);
                        if (popupEl) { popupEl.classList.remove("active"); }
                        return;
                    }
                    if (e.target && e.target.classList && e.target.classList.contains("st-features-popup")) {
                        e.target.classList.remove("active");
                    }
                });
            }
            window.initShortTripsCardExtras = function () {
                bindCardExtras();
            };
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", bindCardExtras);
            } else {
                bindCardExtras();
            }
        })();
    </script>
    <?php
}, 999); // Late priority to ensure it loads after other scripts

/**
 * ============================================================================
 * FILTERS WIDGET VOOR RESULTATEN PAGINA
 * ============================================================================
 * 
 * Dit voegt een filter sidebar toe aan de hotel resultaten pagina
 * Shortcode: [shorttrips_filters]
 * 
 * ============================================================================
 */

/**
 * Render filter widget (standalone of inline)
 */
function shorttrips_render_filters_widget($mode = 'standalone')
{
    global $wpdb;

    $isInline = strtolower((string) $mode) === 'inline';

    // Haal beschikbare filter opties op uit database
    $features = $wpdb->get_results("SELECT id, name FROM ghwk_features ORDER BY name", ARRAY_A);
    $themes = $wpdb->get_results("SELECT id, name FROM ghwk_themes ORDER BY name", ARRAY_A);
    $meals = $wpdb->get_results("SELECT id, name FROM ghwk_meals ORDER BY name", ARRAY_A);

    static $stFiltersStylePrinted = false;

    ob_start();

    if (!$stFiltersStylePrinted) {
        $stFiltersStylePrinted = true;
        ?>
        <style>
            .st-results-layout {
                display: block;
                width: 100%;
                background: #ffffff;
                border-radius: 28px;
                padding: 32px;
                box-shadow: 0 25px 60px rgba(15, 23, 42, 0.08);
                border: 1px solid #e2e8f0;
            }

            .st-results-primary {
                width: 100%;
            }

            .st-inline-filters-bar {
                width: 100%;
                margin-bottom: 20px;
                background: #ffffff;
                border-radius: 20px;
                padding: 24px;
                border: 1px solid #e2e8f0;
                box-shadow: 0 20px 60px rgba(15, 23, 42, 0.06);
            }

            .shorttrips-main-page,
            #hotels-results-container,
            #st-hotels-results-layout {
                max-width: 100%;
                width: 100%;
                margin: 0 auto;
                padding-left: clamp(20px, 4vw, 60px);
                padding-right: clamp(20px, 4vw, 60px);
            }

            .st-filters-popup {
                position: absolute;
                top: -16px;
                right: -16px;
                background: linear-gradient(135deg, #2563eb, #1d4ed8);
                color: #fff;
                padding: 16px 48px 16px 16px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
                opacity: 0;
                transform: translateY(-10px);
                transition: opacity 0.25s ease, transform 0.25s ease;
                z-index: 50;
            }

            .st-filters-popup.visible {
                opacity: 1;
                transform: translateY(0);
            }

            .st-filters-popup button {
                position: absolute;
                top: 8px;
                right: 8px;
                background: rgba(255, 255, 255, 0.15);
                border: none;
                color: #fff;
                width: 28px;
                height: 28px;
                border-radius: 50%;
                cursor: pointer;
            }

            [data-st-filters-root] {
                color: #111827;
            }

            [data-st-filters-root] h3,
            [data-st-filters-root] h4,
            [data-st-filters-root] label,
            [data-st-filters-root] span {
                color: #111827;
            }

            [data-st-filters-root] select,
            [data-st-filters-root] input[type="number"] {
                width: 100%;
                background: #ffffff;
                color: #111827;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                padding: 10px;
            }

            [data-st-filters-root] input[type="checkbox"] {
                accent-color: #1d4ed8;
            }

            [data-st-filters-root] .st-dropdown-option span,
            [data-st-filters-root] .st-filter-checkbox span {
                display: inline-flex;
                align-items: center;
                padding: 6px 10px;
                border-radius: 6px;
                border: 1px solid #e5e7eb;
                background: #fff;
                color: #111827;
                font-weight: 500;
            }

            [data-st-filters-root] input[type="checkbox"]:checked+span {
                background: #1d4ed8;
                border-color: #1d4ed8;
                color: #ffffff;
            }

            [data-mode="inline"] .st-filters-widget {
                position: static;
                background: transparent;
                border: none;
                border-radius: 0;
                box-shadow: none;
                padding: 0;
                display: flex;
                flex-wrap: nowrap;
                gap: 16px;
                overflow-x: auto;
            }

            [data-mode="inline"] .st-filter-section {
                flex: 0 0 auto;
                min-width: 190px;
                margin-bottom: 0;
            }

            [data-mode="inline"] .st-custom-dropdown,
            [data-mode="inline"] .st-filter-section>div {
                background: transparent;
                border: none;
                padding: 0;
            }

            [data-mode="inline"] .st-custom-dropdown .st-dropdown-menu {
                max-height: 160px;
            }

            [data-mode="inline"] .st-filter-checkbox {
                background: transparent;
                border: none;
                padding: 0;
            }

            [data-mode="inline"] .st-filters-actions {
                flex: 0 0 220px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
                margin-top: 0;
            }

            [data-mode="inline"] #st-apply-filters,
            [data-mode="inline"] #st-reset-filters {
                flex: none;
                font-size: 15px;
                border-radius: 10px;
                border: 1px solid transparent;
                transition: all 0.2s ease;
            }

            [data-mode="inline"] #st-apply-filters {
                background: #1d4ed8;
                color: #fff;
            }

            [data-mode="inline"] #st-apply-filters:hover {
                background: #1e40af;
            }

            [data-mode="inline"] #st-reset-filters {
                background: #ffffff;
                border-color: #d1d5db;
                color: #1f2937;
            }

            [data-mode="inline"] #st-reset-filters:hover {
                border-color: #1d4ed8;
                color: #1d4ed8;
            }

            [data-mode="inline"] .st-filter-section h4 {
                font-size: 13px;
                text-transform: uppercase;
                letter-spacing: 0.02em;
                margin-bottom: 6px;
                color: #0f172a;
            }

            [data-mode="inline"] .st-filter-section .st-dropdown-option,
            [data-mode="inline"] .st-filter-section .st-filter-checkbox {
                padding: 0;
            }

            [data-mode="inline"] .st-filter-section .st-dropdown-option span,
            [data-mode="inline"] .st-filter-section .st-filter-checkbox span {
                border-radius: 20px;
            }

            [data-mode="inline"] .st-filter-section--compact {
                min-width: 150px;
                flex: 0 0 150px;
            }

            [data-mode="inline"] .st-filter-section--dropdown {
                flex: 0 0 220px;
                min-width: 220px;
            }

            [data-mode="inline"] .st-inline-dropdown {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 14px;
                overflow: hidden;
                color: #0f172a;
            }

            .st-inline-dropdown__toggle {
                width: 100%;
                background: transparent;
                color: inherit;
                border: none;
                font-size: 14px;
                font-weight: 600;
                letter-spacing: 0.01em;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                cursor: pointer;
            }

            .st-inline-dropdown__chevron {
                transition: transform 0.2s ease;
            }

            .st-inline-dropdown.is-open .st-inline-dropdown__chevron {
                transform: rotate(180deg);
            }

            .st-inline-dropdown__panel {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.25s ease;
                padding: 0 16px;
            }

            .st-inline-dropdown.is-open .st-inline-dropdown__panel {
                max-height: 240px;
                padding: 0 16px 12px;
            }

            .st-inline-dropdown__panel .st-dropdown-menu,
            .st-inline-dropdown__panel .st-filter-checkboxes {
                border: none;
                padding: 0;
                max-height: 200px;
                overflow-y: auto;
                overflow-x: hidden;
            }

            .st-inline-dropdown__panel label {
                display: flex;
                align-items: center;
                justify-content: space-between;
                border: 1px solid #e2e8f0;
                border-radius: 0;
                padding: 4px 6px;
                margin-bottom: 4px;
                background: #ffffff;
                font-size: 11px;
                gap: 10px;
            }

            .st-inline-dropdown__panel label span {
                order: 1;
                flex: 1;
                color: #0f172a;
                background: none;
                border: none;
                padding: 0;
                font-size: 11px;
            }

            .st-inline-dropdown__panel label input[type="checkbox"] {
                order: 2;
                margin: 0;
                transform: scale(0.85);
            }

            .st-inline-dropdown__panel input[type="checkbox"]:checked+span {
                font-weight: 600;
                color: #1d4ed8;
            }

            [data-mode="inline"] .st-filter-section .st-dropdown-option span,
            [data-mode="inline"] .st-filter-section .st-filter-checkbox span {
                border-radius: 0;
                background: #ffffff;
                color: #0f172a;
                padding: 4px 6px;
                font-size: 11px;
                border: 1px solid #e2e8f0;
            }

            [data-mode="inline"] .st-filter-section .st-dropdown-option input[type="checkbox"]:checked+span,
            [data-mode="inline"] .st-filter-section .st-filter-checkbox input[type="checkbox"]:checked+span {
                background: #ffffff;
                border-color: #e2e8f0;
                color: #1d4ed8;
            }

            @media (max-width: 1024px) {

                [data-mode="inline"] .st-filter-section,
                [data-mode="inline"] .st-filter-section--dropdown,
                [data-mode="inline"] .st-filters-actions {
                    flex: 1 1 100%;
                }
            }
        </style>
        <?php
    }
    ?>

    <?php
    $wrapperStyle = $isInline ? 'display:block;' : 'display:none;';
    $widgetStyle = $isInline
        ? 'padding:0;background:transparent;border-radius:0;box-shadow:none;position:static;'
        : 'background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);position:sticky;top:20px;';
    ?>
    <div class="st-filters-widget-wrapper" data-st-filters-root
        data-mode="<?php echo $isInline ? 'inline' : 'standalone'; ?>" style="<?php echo $wrapperStyle; ?>">
        <div class="st-filters-widget" style="<?php echo $widgetStyle; ?>">
            <?php if (!$isInline): ?>
                <h3
                    style="margin:0 0 20px 0;font-size:18px;font-weight:600;color:#111827;border-bottom:2px solid #e5e7eb;padding-bottom:12px;">
                    üîç Filters
                </h3>
            <?php endif; ?>

            <!-- Reset Filters Button -->
            <?php if (!$isInline): ?>
                <button onclick="stResetFilters()"
                    style="width:100%;padding:8px;margin-bottom:16px;background:#f3f4f6;border:1px solid #d1d5db;border-radius:6px;cursor:pointer;font-size:14px;color:#374151;">
                    ‚Üª Reset alle filters
                </button>
            <?php endif; ?>

            <!-- Star Rating Filter -->
            <div class="st-filter-section st-filter-section--compact" style="margin-bottom:24px;">
                <h4
                    style="font-size:14px;font-weight:600;color:<?php echo $isInline ? '#ffffff' : '#374151'; ?>;margin:0 0 12px 0;">
                    ‚≠ê Sterren</h4>

                <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <select id="st-filter-min-stars"
                        style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
                        <option value="">Min</option>
                        <option value="1">1‚≠ê</option>
                        <option value="2">2‚≠ê</option>
                        <option value="3">3‚≠ê</option>
                        <option value="4">4‚≠ê</option>
                        <option value="5">5‚≠ê</option>
                    </select>
                    <span style="padding:8px 4px;color:#6b7280;">-</span>
                    <select id="st-filter-max-stars"
                        style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;">
                        <option value="">Max</option>
                        <option value="1">1‚≠ê</option>
                        <option value="2">2‚≠ê</option>
                        <option value="3">3‚≠ê</option>
                        <option value="4">4‚≠ê</option>
                        <option value="5">5‚≠ê</option>
                    </select>
                </div>
            </div>

            <!-- Price Range Filter -->
            <div class="st-filter-section st-filter-section--compact" style="margin-bottom:24px;">
                <h4
                    style="font-size:14px;font-weight:600;color:<?php echo $isInline ? '#ffffff' : '#374151'; ?>;margin:0 0 12px 0;">
                    üí∞ Prijs per nacht</h4>

                <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <input type="number" id="st-filter-min-price" placeholder="Min ‚Ç¨"
                        style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
                    <span style="padding:8px 4px;color:#6b7280;">-</span>
                    <input type="number" id="st-filter-max-price" placeholder="Max ‚Ç¨"
                        style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;" />
                </div>
            </div>

            <!-- Facilities Filter -->
            <?php if (!empty($features)): ?>
                <div class="st-filter-section <?php echo $isInline ? 'st-filter-section--dropdown' : ''; ?>"
                    style="margin-bottom:24px;">
                    <?php if ($isInline): ?>
                        <div class="st-inline-dropdown" data-inline-dropdown>
                            <button type="button" class="st-inline-dropdown__toggle">
                                <span>üèä Faciliteiten</span>
                                <span class="st-inline-dropdown__chevron">‚ñº</span>
                            </button>
                            <div class="st-inline-dropdown__panel">
                                <div class="st-dropdown-menu">
                                    <?php foreach ($features as $feature): ?>
                                        <label class="st-dropdown-option">
                                            <input type="checkbox" class="st-filter-feature"
                                                value="<?php echo esc_attr($feature['id']); ?>" />
                                            <span><?php echo esc_html($feature['name']); ?></span>
                                        </label>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>
                    <?php else: ?>
                        <h4 style="font-size:14px;font-weight:600;color:#374151;margin:0 0 12px 0;">üèä Faciliteiten</h4>
                        <div style="max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:6px;padding:8px;">
                            <?php foreach (array_slice($features, 0, 15) as $feature): ?>
                                <label
                                    style="display:block;padding:6px 8px;cursor:pointer;border-radius:4px;transition:background 0.2s;font-size:13px;"
                                    onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" class="st-filter-feature" value="<?php echo esc_attr($feature['id']); ?>"
                                        style="margin-right:8px;" />
                                    <?php echo esc_html($feature['name']); ?>
                                </label>
                            <?php endforeach; ?>
                            <?php if (count($features) > 15): ?>
                                <button onclick="stShowAllFeatures()"
                                    style="width:100%;padding:6px;margin-top:8px;background:#f3f4f6;border:none;border-radius:4px;cursor:pointer;font-size:12px;color:#2563eb;">
                                    + Toon alle <?php echo count($features); ?> faciliteiten
                                </button>
                            <?php endif; ?>
                        </div>
                    <?php endif; ?>
                </div>
            <?php endif; ?>

            <!-- Meals Filter -->
            <?php if (!empty($meals)): ?>
                <div class="st-filter-section <?php echo $isInline ? 'st-filter-section--dropdown' : ''; ?>"
                    style="margin-bottom:24px;">
                    <?php if ($isInline): ?>
                        <div class="st-inline-dropdown" data-inline-dropdown>
                            <button type="button" class="st-inline-dropdown__toggle">
                                <span>üçΩÔ∏è Maaltijden</span>
                                <span class="st-inline-dropdown__chevron">‚ñº</span>
                            </button>
                            <div class="st-inline-dropdown__panel">
                                <div class="st-dropdown-menu">
                                    <?php foreach ($meals as $meal): ?>
                                        <label class="st-dropdown-option">
                                            <input type="checkbox" class="st-filter-meal"
                                                value="<?php echo esc_attr($meal['id']); ?>" />
                                            <span><?php echo esc_html($meal['name']); ?></span>
                                        </label>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>
                    <?php else: ?>
                        <h4 style="font-size:14px;font-weight:600;color:#374151;margin:0 0 12px 0;">üçΩÔ∏è Maaltijden</h4>
                        <div style="border:1px solid #e5e7eb;border-radius:6px;padding:8px;">
                            <?php foreach ($meals as $meal): ?>
                                <label
                                    style="display:block;padding:6px 8px;cursor:pointer;border-radius:4px;transition:background 0.2s;font-size:13px;"
                                    onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox" class="st-filter-meal" value="<?php echo esc_attr($meal['id']); ?>"
                                        style="margin-right:8px;" />
                                    <?php echo esc_html($meal['name']); ?>
                                </label>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                </div>
            <?php endif; ?>

            <!-- Room Options -->
            <div class="st-filter-section <?php echo $isInline ? 'st-filter-section--dropdown' : ''; ?>"
                style="margin-bottom:24px;">
                <?php if ($isInline): ?>
                    <div class="st-inline-dropdown" data-inline-dropdown>
                        <button type="button" class="st-inline-dropdown__toggle">
                            <span>üõèÔ∏è Kameropties</span>
                            <span class="st-inline-dropdown__chevron">‚ñº</span>
                        </button>
                        <div class="st-inline-dropdown__panel st-filter-checkboxes">
                            <label class="st-filter-checkbox">
                                <input type="checkbox" id="st-filter-no-shared-rooms" />
                                <span>Geen gedeelde kamers</span>
                            </label>
                            <label class="st-filter-checkbox">
                                <input type="checkbox" id="st-filter-no-shared-facilities" />
                                <span>Geen gedeelde faciliteiten</span>
                            </label>
                        </div>
                    </div>
                <?php else: ?>
                    <h4 style="font-size:14px;font-weight:600;color:#374151;margin:0 0 12px 0;">üõèÔ∏è Kameropties</h4>
                    <label
                        style="display:block;padding:8px;background:#f9fafb;border-radius:6px;margin-bottom:8px;cursor:pointer;font-size:13px;">
                        <input type="checkbox" id="st-filter-no-shared-rooms" style="margin-right:8px;" />
                        Geen gedeelde kamers
                    </label>
                    <label
                        style="display:block;padding:8px;background:#f9fafb;border-radius:6px;margin-bottom:8px;cursor:pointer;font-size:13px;">
                        <input type="checkbox" id="st-filter-no-shared-facilities" style="margin-right:8px;" />
                        Geen gedeelde faciliteiten
                    </label>
                <?php endif; ?>
            </div>

            <!-- Apply Filters Button -->
            <button onclick="stApplyFilters()"
                style="width:100%;padding:12px;background:#2563eb;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;transition:background 0.2s;"
                onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">
                ‚úì Filters toepassen
            </button>

            <!-- Active Filters Display -->
            <div id="st-active-filters" style="margin-top:16px;display:none;">
                <h5 style="font-size:12px;font-weight:600;color:#6b7280;margin:0 0 8px 0;">ACTIEVE FILTERS:</h5>
                <div id="st-active-filters-list" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
            </div>
        </div>

        <script>
            // Filter JavaScript Functions

            function stGetFilterValues() {
                const minStars = document.getElementById('st-filter-min-stars').value;
                const maxStars = document.getElementById('st-filter-max-stars').value;
                const minPrice = document.getElementById('st-filter-min-price').value;
                const maxPrice = document.getElementById('st-filter-max-price').value;

                const featureIds = Array.from(document.querySelectorAll('.st-filter-feature:checked'))
                    .map(cb => cb.value);

                const mealIds = Array.from(document.querySelectorAll('.st-filter-meal:checked'))
                    .map(cb => cb.value);

                const excludeSharedRooms = document.getElementById('st-filter-no-shared-rooms').checked ? '1' : '';
                const excludeSharedFacilities = document.getElementById('st-filter-no-shared-facilities').checked ? '1' : '';

                return {
                    minStars,
                    maxStars,
                    minPrice,
                    maxPrice,
                    featureIds,
                    mealIds,
                    excludeSharedRooms,
                    excludeSharedFacilities
                };
            }

            function stApplyFilters() {
                const filters = stGetFilterValues();

                const url = new URL(window.location.href);
                const arrayKeys = ['featureIds', 'mealIds'];

                arrayKeys.forEach(key => {
                    url.searchParams.delete(key);
                    url.searchParams.delete(key + '[]');
                });

                Object.keys(filters).forEach(key => {
                    const value = filters[key];
                    if (Array.isArray(value)) {
                        if (value.length > 0) {
                            value.forEach(v => url.searchParams.append(key + '[]', v));
                        } else {
                            url.searchParams.delete(key + '[]');
                        }
                    } else if (value) {
                        url.searchParams.set(key, value);
                    } else {
                        url.searchParams.delete(key);
                    }
                });

                window.location.href = url.toString();
            }

            function stResetFilters() {
                // Clear all filter inputs
                document.getElementById('st-filter-min-stars').value = '';
                document.getElementById('st-filter-max-stars').value = '';
                document.getElementById('st-filter-min-price').value = '';
                document.getElementById('st-filter-max-price').value = '';

                document.querySelectorAll('.st-filter-feature').forEach(cb => cb.checked = false);
                document.querySelectorAll('.st-filter-meal').forEach(cb => cb.checked = false);
                document.getElementById('st-filter-no-shared-rooms').checked = false;
                document.getElementById('st-filter-no-shared-facilities').checked = false;

                // Remove filter params from URL
                const url = new URL(window.location.href);
                ['minStars', 'maxStars', 'minPrice', 'maxPrice', 'excludeSharedRooms', 'excludeSharedFacilities'].forEach(key => {
                    url.searchParams.delete(key);
                });
                ['featureIds', 'mealIds'].forEach(key => {
                    url.searchParams.delete(key);
                    url.searchParams.delete(key + '[]');
                });

                window.location.href = url.toString();
            }

            function stShowActiveFilters() {
                const filters = stGetFilterValues();
                const container = document.getElementById('st-active-filters');
                const list = document.getElementById('st-active-filters-list');

                let hasFilters = false;
                list.innerHTML = '';

                if (filters.minStars || filters.maxStars) {
                    hasFilters = true;
                    const badge = document.createElement('span');
                    badge.style.cssText = 'padding:4px 8px;background:#dbeafe;color:#1e40af;border-radius:4px;font-size:12px;';
                    badge.textContent = `‚≠ê ${filters.minStars || '0'}-${filters.maxStars || '5'}`;
                    list.appendChild(badge);
                }

                if (filters.minPrice || filters.maxPrice) {
                    hasFilters = true;
                    const badge = document.createElement('span');
                    badge.style.cssText = 'padding:4px 8px;background:#d1fae5;color:#065f46;border-radius:4px;font-size:12px;';
                    badge.textContent = `üí∞ ‚Ç¨${filters.minPrice || '0'}-${filters.maxPrice || '‚àû'}`;
                    list.appendChild(badge);
                }

                if (filters.featureIds && filters.featureIds.length) {
                    hasFilters = true;
                    const count = filters.featureIds.length;
                    const badge = document.createElement('span');
                    badge.style.cssText = 'padding:4px 8px;background:#fef3c7;color:#92400e;border-radius:4px;font-size:12px;';
                    badge.textContent = `üèä ${count} faciliteiten`;
                    list.appendChild(badge);
                }

                container.style.display = hasFilters ? 'block' : 'none';
            }

            // Load active filters from URL on page load
            document.addEventListener('DOMContentLoaded', function () {
                const url = new URL(window.location.href);

                const minStars = url.searchParams.get('minStars');
                const maxStars = url.searchParams.get('maxStars');
                const minPrice = url.searchParams.get('minPrice');
                const maxPrice = url.searchParams.get('maxPrice');
                const featureIds = url.searchParams.getAll('featureIds[]');
                const mealIds = url.searchParams.getAll('mealIds[]');
                const excludeSharedRooms = url.searchParams.get('excludeSharedRooms');
                const excludeSharedFacilities = url.searchParams.get('excludeSharedFacilities');

                if (minStars) document.getElementById('st-filter-min-stars').value = minStars;
                if (maxStars) document.getElementById('st-filter-max-stars').value = maxStars;
                if (minPrice) document.getElementById('st-filter-min-price').value = minPrice;
                if (maxPrice) document.getElementById('st-filter-max-price').value = maxPrice;

                featureIds.forEach(id => {
                    const cb = document.querySelector(`.st-filter-feature[value="${id}"]`);
                    if (cb) cb.checked = true;
                });

                mealIds.forEach(id => {
                    const cb = document.querySelector(`.st-filter-meal[value="${id}"]`);
                    if (cb) cb.checked = true;
                });

                if (excludeSharedRooms === '1') {
                    document.getElementById('st-filter-no-shared-rooms').checked = true;
                }
                if (excludeSharedFacilities === '1') {
                    document.getElementById('st-filter-no-shared-facilities').checked = true;
                }

                stShowActiveFilters();
            });
        </script>
        <?php if ($isInline): ?>
            <script>
                (function () {
                    if (window.__stInlineFiltersHelper) return;
                    window.__stInlineFiltersHelper = true;

                    function bindInlineDropdowns(scope) {
                        var root = scope || document;
                        var dropdowns = root.querySelectorAll('[data-inline-dropdown]');
                        dropdowns.forEach(function (drop) {
                            if (drop.__stDropdownBound) return;
                            var toggle = drop.querySelector('.st-inline-dropdown__toggle');
                            if (!toggle) return;
                            drop.__stDropdownBound = true;
                            toggle.addEventListener('click', function () {
                                drop.classList.toggle('is-open');
                            });
                        });
                    }

                    document.addEventListener('DOMContentLoaded', function () {
                        bindInlineDropdowns(document);
                    });

                    window.stInitInlineDropdowns = bindInlineDropdowns;

                    window.stToggleInlineFilters = function (forceShow) {
                        var sidebar = document.getElementById('st-inline-filters');
                        if (!sidebar) return;

                        var wrapper = sidebar.querySelector('[data-st-filters-root]');
                        if (!wrapper) return;

                        var hasCards = document.querySelectorAll('#st-results .st-hotel-card[data-hotel-id]').length > 0;
                        var urlParams = new URLSearchParams(window.location.search);
                        var hasSearchParams = false;
                        ['destinationID', 'destination_id', 'country', 'country_name', 'resort', 'resort_name', 'q', 'type', 'checkin', 'checkout', 'action'].some(function (key) {
                            if (urlParams.has(key) && urlParams.get(key)) {
                                hasSearchParams = true;
                                return true;
                            }
                            return false;
                        });

                        var persistent = window.__stInlineFiltersPersistent === true;
                        var shouldShow = forceShow || persistent || hasSearchParams || hasCards;

                        if (!shouldShow) {
                            sidebar.style.display = 'none';
                            wrapper.style.display = 'none';
                            return;
                        }

                        window.__stInlineFiltersPersistent = true;
                        sidebar.style.display = 'block';
                        wrapper.style.display = 'block';
                        bindInlineDropdowns(wrapper);
                    };
                })();
            </script>
        <?php endif; ?>
    </div>

    <?php
    $shortcodeOutput = ob_get_clean();

    if (!$isInline) {
        $shortcodeOutput .= <<<HTML
<script>
(function(){
    if (window.__stFiltersSidebarInit) return;
    window.__stFiltersSidebarInit = true;
    
    var resultsSelectors = ['#st-results', '.st-fullbleed', '.st-search-results', '.st-results-grid'];
    
    function hasHotelCards() {
        var cards = document.querySelectorAll('.st-hotel-card[data-hotel-id]');
        return cards.length > 0;
    }
    
    function findResultsContainer() {
        for (var i = 0; i < resultsSelectors.length; i++) {
            var el = document.querySelector(resultsSelectors[i]);
            if (el && el.querySelector && el.querySelector('.st-hotel-card')) {
                return el;
            }
            if (el) return el;
        }
        return null;
    }
    
    function ensureLayout(results) {
        if (!results) return null;
        var layout = results.closest('.st-results-layout');
        if (!layout) {
            layout = document.createElement('div');
            layout.className = 'st-results-layout';
            results.parentNode.insertBefore(layout, results);
            
            var primary = document.createElement('div');
            primary.className = 'st-results-primary';
            primary.appendChild(results);
            layout.appendChild(primary);
            
            var sidebar = document.createElement('aside');
            sidebar.className = 'st-results-sidebar';
            layout.appendChild(sidebar);
        } else if (!layout.querySelector('.st-results-sidebar')) {
            var sidebar = document.createElement('aside');
            sidebar.className = 'st-results-sidebar';
            layout.appendChild(sidebar);
        }
        return layout;
    }
    
    function showPopup(filtersWrapper) {
        if (!filtersWrapper || sessionStorage.getItem('stFiltersPopupShown')) return;
        sessionStorage.setItem('stFiltersPopupShown', '1');
        
        var popup = document.createElement('div');
        popup.className = 'st-filters-popup';
        popup.innerHTML = '<strong>Wilt u de resultaten verder verfijnen?</strong><p style="margin:8px 0 0 0;font-size:13px;">Filter hieronder.</p><button type="button" aria-label="Sluiten">‚úï</button>';
        
        var closeBtn = popup.querySelector('button');
        closeBtn.addEventListener('click', function() {
            if (popup && popup.parentNode) {
                popup.parentNode.removeChild(popup);
            }
        });
        
        filtersWrapper.appendChild(popup);
        setTimeout(function(){ popup.classList.add('visible'); }, 30);
        
        setTimeout(function(){
            if (popup && popup.parentNode) {
                popup.parentNode.removeChild(popup);
            }
        }, 10000);
    }
    
    function mountFilters() {
        var filtersWrapper = document.querySelector('[data-st-filters-root][data-mode="standalone"]');
        if (!filtersWrapper || filtersWrapper.getAttribute('data-st-filters-mounted') === '1') return;
        var results = findResultsContainer();
        if (!results || !hasHotelCards()) return;
        
        var layout = ensureLayout(results);
        if (!layout) return;
        
        var sidebar = layout.querySelector('.st-results-sidebar');
        sidebar.appendChild(filtersWrapper);
        filtersWrapper.style.display = 'block';
        filtersWrapper.setAttribute('data-st-filters-mounted', '1');
        filtersWrapper.style.position = 'relative';
        showPopup(filtersWrapper);
    }
    
    function tryMount() {
        try { mountFilters(); } catch (err) { console.error('ShortTrips Filters: mount error', err); }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryMount);
    } else {
        tryMount();
    }
    
    var observer = new MutationObserver(function() {
        if (hasHotelCards()) {
            tryMount();
        }
    });
    observer.observe(document.body, { childList: true, subtree: true });
})();
</script>
HTML;
    }

    return $shortcodeOutput;
}

add_shortcode('shorttrips_filters', function ($atts) {
    $atts = shortcode_atts([
        'mode' => 'standalone'
    ], $atts, 'shorttrips_filters');

    return shorttrips_render_filters_widget($atts['mode']);
});

/**
 * ============================================================================
 * HEADER SEARCH WIDGET - FREESTAYS THEME
 * ============================================================================
 * 
 * Modern header search widget met:
 * - Sticky positioning in header
 * - Freestays blauw kleurenschema
 * - Landen popup (multi-select)
 * - Datepicker
 * - Reisduur selector
 * - Gasten selector
 * 
 * Shortcode: [shorttrips_header_search]
 * 
 * ============================================================================
 */

add_shortcode('shorttrips_header_search', function ($atts) {
    global $wpdb;

    // Haal landen op voor dropdown (nu super snel dankzij optimization!)
    $landen = $wpdb->get_results("
        SELECT 
            bl.name,
            bl.slug,
            COUNT(bh.hotel_id) as hotel_count
        FROM bravo_locations bl
        LEFT JOIN ghwk_bravo_hotels bh ON bl.name = bh.country_name
        WHERE bl.status = 'publish'
        GROUP BY bl.name, bl.slug
        HAVING hotel_count > 0
        ORDER BY hotel_count DESC
    ", ARRAY_A);

    // Top 6 populaire landen voor quick select
    $populaire_landen = array_slice($landen, 0, 6);

    ob_start();
    ?>

    <!-- Header Search Widget -->
    <div id="st-header-search" class="st-header-search-widget">
        <div class="st-search-container">
            <h2 class="st-search-title">Find your next stay</h2>

            <!-- UNIVERSAL SEARCH BAR (Google-style autocomplete) -->
            <div class="st-universal-search-container" style="margin-bottom:24px;">
                <div class="st-universal-search-wrapper" style="position:relative;max-width:700px;margin:0 auto;">
                    <div style="display:flex;align-items:center;background:white;border:2px solid #e5e7eb;border-radius:12px;padding:4px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.2s;"
                        id="st-search-input-wrapper-header">
                        <span style="padding:0 12px;font-size:20px;color:#6b7280;">üîç</span>
                        <input type="text" id="st-universal-search-header"
                            placeholder="Search hotel, city, region or country..." autocomplete="off"
                            style="flex:1;border:none;outline:none;padding:12px 8px;font-size:16px;color:#1f2937;" />
                        <button type="button" id="st-search-clear-header"
                            style="display:none;padding:8px 12px;background:transparent;border:none;color:#9ca3af;cursor:pointer;font-size:20px;"
                            title="Wissen">‚úï</button>
                    </div>

                    <!-- AUTOCOMPLETE DROPDOWN -->
                    <div id="st-autocomplete-results-header" class="st-autocomplete-dropdown"
                        style="display:none;position:absolute;top:100%;left:0;right:0;margin-top:8px;background:white;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-height:400px;overflow-y:auto;z-index:1000;">
                        <!-- Results will be injected here -->
                    </div>

                    <!-- LOADING INDICATOR -->
                    <div id="st-search-loading-header"
                        style="display:none;position:absolute;right:16px;top:50%;transform:translateY(-50%);pointer-events:none;">
                        <div
                            style="width:20px;height:20px;border:2px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 0.6s linear infinite;">
                        </div>
                    </div>
                </div>
            </div>

            <form id="st-search-form" method="GET" action="<?php echo shorttrips_get_hotels_page_url(); ?>">
                <input type="hidden" name="type" value="country">
                <!-- destinationID will be added dynamically by JavaScript -->

                <div class="st-search-grid">

                    <!-- Bestemming Field -->
                    <div class="st-search-field st-field-destination">
                        <label class="st-field-label">
                            <span class="st-field-icon">üåç</span>
                            <span class="st-field-text">Destination</span>
                        </label>
                        <button type="button" class="st-field-input" id="st-destination-trigger">
                            <span id="st-destination-display">All Countries</span>
                            <span class="st-dropdown-arrow">‚ñº</span>
                        </button>
                        <input type="hidden" name="country_name" id="st-countries-input" value="">
                    </div>

                    <!-- Datums Field (Checkin + Checkout in √©√©n) -->
                    <div class="st-search-field st-field-date">
                        <label class="st-field-label">
                            <span class="st-field-icon">üìÖ</span>
                            <span class="st-field-text">Check-in & Check-out</span>
                        </label>
                        <button type="button" class="st-field-input" id="st-date-trigger">
                            <span id="st-date-display">Choose the date</span>
                            <span class="st-dropdown-arrow">‚ñº</span>
                        </button>
                        <input type="hidden" name="checkin" id="st-checkin-input" value="">
                        <input type="hidden" name="checkout" id="st-checkout-input" value="">
                    </div>

                    <!-- Reizigers Field -->
                    <div class="st-search-field st-field-travelers">
                        <label class="st-field-label">
                            <span class="st-field-icon">üë•</span>
                            <span class="st-field-text">Travelling group</span>
                        </label>
                        <button type="button" class="st-field-input" id="st-travelers-trigger">
                            <span id="st-travelers-display">2 persons in 1 room</span>
                            <span class="st-dropdown-arrow">‚ñº</span>
                        </button>
                        <input type="hidden" name="rooms" id="st-rooms-input" value="1">
                        <input type="hidden" name="adults" id="st-adults-input" value="2">
                        <input type="hidden" name="children" id="st-children-input" value="0">
                        <input type="hidden" name="child_ages" id="st-child-ages-input" value="">
                    </div>

                    <!-- Search Buttons -->
                    <div class="st-search-field st-field-submit">
                        <button type="button" class="st-reset-btn" onclick="stResetAllFields()">
                            <span class="st-btn-icon">üîÑ</span>
                            <span class="st-btn-text">Reset</span>
                        </button>
                        <button type="submit" id="st-submit-btn" class="st-submit-btn">
                            <span class="st-btn-icon">üîç</span>
                            <span class="st-btn-text">Find hotels</span>
                        </button>
                    </div>

                </div>
            </form>

            <!-- RESULTS + FILTERS LAYOUT -->
            <div class="st-results-layout st-results-layout--inline" id="hotels-results-container" style="margin-top:24px;">
                <div class="st-results-primary">
                    <div class="st-inline-filters-bar" id="st-inline-filters" style="display:none;">
                        <?php echo shorttrips_render_filters_widget('inline'); ?>
                    </div>
                    <div id="st-results" class="st-fullbleed">
                        <div class="text-center py-12 text-gray-500">
                            <p class="text-lg" style="color:#1f2937;">üëÜ Use your voucher to book commission free</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Landen Popup -->
    <div id="st-destination-modal" class="st-modal" style="display:none;">
        <div class="st-modal-overlay"></div>
        <div class="st-modal-content">
            <div class="st-modal-header">
                <h3>Bestemming</h3>
                <button type="button" class="st-modal-close" onclick="stCloseModal('destination')">&times;</button>
            </div>

            <div class="st-modal-body">
                <!-- Zoekbalk -->
                <div class="st-search-box">
                    <input type="text" id="st-country-search" placeholder="Find your destination..."
                        class="st-search-input">
                </div>

                <!-- Populaire Bestemmingen -->
                <div class="st-popular-section">
                    <h4>‚≠ê Popular destinations</h4>
                    <div class="st-popular-grid">
                        <?php foreach ($populaire_landen as $land):
                            // Try to find country image in uploads folder (2025/11)
                            $country_slug = sanitize_title($land['name']);
                            $possible_images = [
                                home_url('/wp-content/uploads/2025/11/' . $land['name'] . '.jpg'),
                                home_url('/wp-content/uploads/2025/11/' . $land['name'] . '.png'),
                                home_url('/wp-content/uploads/2025/11/' . $country_slug . '.jpg'),
                                home_url('/wp-content/uploads/2025/11/' . $country_slug . '.png'),
                            ];

                            $image_url = null;

                            // Check if any of the possible images exist
                            foreach ($possible_images as $img) {
                                $file_path = str_replace(home_url(), ABSPATH, $img);
                                if (file_exists($file_path)) {
                                    $image_url = $img;
                                    break;
                                }
                            }

                            // Fallback: gebruik eerste hotel foto van dit land
                            if (!$image_url) {
                                $first_hotel = $wpdb->get_row($wpdb->prepare(
                                    "SELECT main_image, image, banner_image 
                                     FROM ghwk_bravo_hotels 
                                     WHERE country_name = %s 
                                       AND (main_image IS NOT NULL OR image IS NOT NULL OR banner_image IS NOT NULL)
                                       AND status = 'publish'
                                     LIMIT 1",
                                    $land['name']
                                ), ARRAY_A);

                                if ($first_hotel) {
                                    $image_url = $first_hotel['main_image'] ?: ($first_hotel['image'] ?: $first_hotel['banner_image']);
                                }
                            }

                            // Final fallback: gradient achtergrond
                            if (!$image_url) {
                                $image_url = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200"%3E%3Cdefs%3E%3ClinearGradient id="grad" x1="0%25" y1="0%25" x2="100%25" y2="100%25"%3E%3Cstop offset="0%25" style="stop-color:%232563eb;stop-opacity:1" /%3E%3Cstop offset="100%25" style="stop-color:%231e40af;stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="400" height="200" fill="url(%23grad)" /%3E%3C/svg%3E';
                            }
                            ?>
                            <label class="st-country-card" style="position:relative;overflow:hidden;padding:0;height:120px;">
                                <!-- Background Image -->
                                <div
                                    style="position:absolute;inset:0;background-image:url('<?php echo esc_url($image_url); ?>');background-size:cover;background-position:center;">
                                </div>

                                <!-- Gradient Overlay -->
                                <div
                                    style="position:absolute;inset:0;background:linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.7) 100%);">
                                </div>

                                <!-- Content -->
                                <input type="checkbox" class="st-country-checkbox"
                                    value="<?php echo esc_attr($land['name']); ?>"
                                    data-slug="<?php echo esc_attr($land['slug']); ?>"
                                    style="position:absolute;top:8px;right:8px;z-index:10;width:20px;height:20px;">
                                <div class="st-card-content"
                                    style="position:relative;z-index:5;padding:16px;height:100%;display:flex;flex-direction:column;justify-content:flex-end;">
                                    <span class="st-country-name"
                                        style="color:white;font-size:16px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,0.5);"><?php echo esc_html($land['name']); ?></span>
                                    <span class="st-hotel-count"
                                        style="color:rgba(255,255,255,0.9);font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,0.5);"><?php echo number_format($land['hotel_count']); ?>
                                        hotels</span>
                                </div>
                            </label>
                        <?php endforeach; ?>
                    </div>
                </div>

                <!-- Alle Bestemmingen -->
                <div class="st-all-countries-section">
                    <h4>üìç All destinations</h4>
                    <div class="st-countries-list">
                        <?php foreach ($landen as $land): ?>
                            <label class="st-country-item">
                                <input type="checkbox" class="st-country-checkbox"
                                    value="<?php echo esc_attr($land['name']); ?>"
                                    data-slug="<?php echo esc_attr($land['slug']); ?>">
                                <span class="st-country-name"><?php echo esc_html($land['name']); ?></span>
                                <span class="st-hotel-count"><?php echo number_format($land['hotel_count']); ?></span>
                            </label>
                        <?php endforeach; ?>
                    </div>
                </div>
            </div>

            <div class="st-modal-footer">
                <button type="button" class="st-btn-secondary" onclick="stResetCountries()">Reset</button>
                <button type="button" class="st-btn-primary" onclick="stApplyCountries()">Save</button>
            </div>
        </div>
    </div>

    <!-- Datepicker Popup (Range Picker) -->
    <div id="st-date-modal" class="st-modal" style="display:none;">
        <div class="st-modal-overlay"></div>
        <div class="st-modal-content">
            <div class="st-modal-header">
                <h3>Check-in & Check-out Dates</h3>
                <button type="button" class="st-modal-close" onclick="stCloseModal('date')">&times;</button>
            </div>

            <div class="st-modal-body">
                <p style="margin:0 0 16px 0;color:#6b7280;font-size:14px;">
                    Select arrival and departure date
                </p>
                <div class="st-date-input-grid">
                    <div class="st-date-field">
                        <label for="st-date-modal-checkin">Check-in</label>
                        <input type="text" id="st-date-modal-checkin" placeholder="YYYY-MM-DD" readonly>
                    </div>
                    <div class="st-date-field">
                        <label for="st-date-modal-checkout">Check-out</label>
                        <input type="text" id="st-date-modal-checkout" placeholder="YYYY-MM-DD" readonly>
                    </div>
                </div>
            </div>

            <div class="st-modal-footer">
                <button type="button" class="st-btn-secondary" onclick="stResetDate()">Reset</button>
                <button type="button" class="st-btn-primary" onclick="stApplyDate()">Save</button>
            </div>
        </div>
    </div>

    <!-- Resort/City Selector Popup -->
    <div id="st-resort-modal" class="st-modal" style="display:none;">
        <div class="st-modal-overlay"></div>
        <div class="st-modal-content">
            <div class="st-modal-header">
                <h3 id="st-resort-modal-title">Choose a city or resort</h3>
                <button type="button" class="st-modal-close" onclick="stCloseModal('resort')">&times;</button>
            </div>

            <div class="st-modal-body">
                <!-- Loading state -->
                <div id="st-resort-loading" style="text-align:center;padding:40px;">
                    <div
                        style="display:inline-block;width:40px;height:40px;border:4px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite;">
                    </div>
                    <p style="margin-top:16px;color:#6b7280;">Loading cities...</p>
                </div>

                <!-- Search bar -->
                <div id="st-resort-search-box" class="st-search-box" style="display:none;margin-bottom:20px;">
                    <input type="text" id="st-resort-search" placeholder="search city..." class="st-search-input">
                </div>

                <!-- Option to skip resort selection -->
                <div id="st-resort-skip"
                    style="display:none;margin-bottom:20px;padding:12px;background:#f3f4f6;border-radius:8px;">
                    <label style="display:flex;align-items:center;cursor:pointer;">
                        <input type="radio" name="st-resort-choice" value="" id="st-resort-all" checked
                            style="margin-right:8px;">
                        <span style="font-weight:500;">All cities in <span id="st-resort-country-name"></span></span>
                    </label>
                </div>

                <!-- Resort list -->
                <div id="st-resort-list" class="st-country-list" style="display:none;"></div>

                <!-- Error state -->
                <div id="st-resort-error" style="display:none;text-align:center;padding:40px;color:#ef4444;">
                    <p>‚ö†Ô∏è Kon geen steden laden</p>
                </div>
            </div>

            <div class="st-modal-footer">
                <button type="button" class="st-btn-secondary" onclick="stBackToCountries()">‚Üê Back to country list</button>
                <button type="button" class="st-btn-primary" onclick="stApplyResort()">Save</button>
            </div>
        </div>
    </div>

    <!-- Reizigers Popup -->
    <div id="st-travelers-modal" class="st-modal" style="display:none;">
        <div class="st-modal-overlay"></div>
        <div class="st-modal-content st-modal-small">
            <div class="st-modal-header">
                <h3>Travel company</h3>
                <button type="button" class="st-modal-close" onclick="stCloseModal('travelers')">&times;</button>
            </div>

            <div class="st-modal-body">
                <!-- Kamers -->
                <div class="st-counter-row">
                    <span class="st-counter-label">Rooms</span>
                    <div class="st-counter-controls">
                        <button type="button" class="st-counter-btn" onclick="stUpdateCounter('rooms', -1)">-</button>
                        <span id="st-rooms-count" class="st-counter-value">1</span>
                        <button type="button" class="st-counter-btn" onclick="stUpdateCounter('rooms', 1)">+</button>
                    </div>
                </div>

                <!-- Volwassenen -->
                <div class="st-counter-row">
                    <span class="st-counter-label">Adults</span>
                    <div class="st-counter-controls">
                        <button type="button" class="st-counter-btn" onclick="stUpdateCounter('adults', -1)">-</button>
                        <span id="st-adults-count" class="st-counter-value">2</span>
                        <button type="button" class="st-counter-btn" onclick="stUpdateCounter('adults', 1)">+</button>
                    </div>
                </div>

                <!-- Kinderen -->
                <div class="st-counter-row">
                    <span class="st-counter-label">Children (0-17 years)</span>
                    <div class="st-counter-controls">
                        <button type="button" class="st-counter-btn" onclick="stUpdateCounter('children', -1)">-</button>
                        <span id="st-children-count" class="st-counter-value">0</span>
                        <button type="button" class="st-counter-btn" onclick="stUpdateCounter('children', 1)">+</button>
                    </div>
                </div>

                <!-- Leeftijd per kind (dynamisch) -->
                <div id="st-children-ages-container"
                    style="display:none;margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb;">
                    <div style="font-size:13px;font-weight:600;color:#374151;margin-bottom:12px;">Child age at arrival:
                    </div>
                    <div id="st-children-ages-list"></div>
                </div>
            </div>

            <div class="st-modal-footer">
                <button type="button" class="st-btn-primary" onclick="stApplyTravelers()">Save</button>
            </div>
        </div>
    </div>

    <?php
    return ob_get_clean();
});

/**
 * Enqueue datepicker libraries (Flatpickr)
 */
add_action('wp_enqueue_scripts', function () {
    wp_enqueue_style(
        'flatpickr',
        'https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css',
        array(),
        '4.6.13'
    );

    wp_enqueue_script(
        'flatpickr',
        'https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js',
        array(),
        '4.6.13',
        true
    );

    wp_enqueue_script(
        'flatpickr-nl',
        'https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/l10n/nl.js',
        array('flatpickr'),
        '4.6.13',
        true
    );
});

/**
 * Enqueue styles and scripts for header search
 */
add_action('wp_footer', function () {
    ?>

    <!-- Header Search Styles -->
    <style>
        /* ============================================================================
           HEADER SEARCH WIDGET STYLES - FREESTAYS BLUE THEME
           ============================================================================ */

        :root {
            --st-blue-primary: #0055A5;
            --st-blue-dark: #003d7a;
            --st-blue-light: #e6f2ff;
            --st-red-primary: #DC2626;
            --st-red-dark: #B91C1C;
            --st-gray-50: #F9FAFB;
            --st-gray-100: #F3F4F6;
            --st-gray-200: #E5E7EB;
            --st-gray-300: #D1D5DB;
            --st-gray-600: #6B7280;
            --st-gray-900: #1F2937;
        }

        /* Widget Container */
        .st-header-search-widget {
            position: relative;
            top: auto;
            z-index: 1;
            background: #ffffff;
            box-shadow: 0 25px 60px rgba(15, 23, 42, 0.08);
            padding: 32px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .st-search-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 0 clamp(20px, 4vw, 60px);
        }

        .st-search-title {
            color: #0f172a;
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 20px 0;
            text-align: center;
        }

        /* Search Grid - 3 fields + button */
        .st-search-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr) auto;
            gap: 12px;
            align-items: end;
        }

        /* Search Field */
        .st-search-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .st-field-label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #0f172a;
            font-size: 14px;
            font-weight: 600;
        }

        .st-field-icon {
            font-size: 18px;
        }

        .st-field-input {
            width: 100%;
            padding: 14px 16px;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 15px;
            color: var(--st-gray-900);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        .st-field-input:hover {
            border-color: var(--st-blue-light);
            box-shadow: 0 2px 8px rgba(0, 85, 165, 0.1);
        }

        .st-field-input:focus {
            outline: none;
            border-color: var(--st-blue-primary);
            box-shadow: 0 0 0 3px rgba(0, 85, 165, 0.1);
        }

        .st-dropdown-arrow {
            color: var(--st-gray-600);
            font-size: 12px;
            transition: transform 0.2s;
        }

        .st-field-input:hover .st-dropdown-arrow {
            transform: translateY(2px);
        }

        /* Submit Button */
        .st-submit-btn {
            width: 100%;
            padding: 14px 24px;
            background: #2563eb;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
        }

        .st-submit-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
        }

        .st-submit-btn:active {
            transform: translateY(0);
        }

        /* Reset Button */
        .st-reset-btn {
            width: 100%;
            margin-top: 8px;
            padding: 10px 16px;
            background: transparent;
            border: 2px solid white;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .st-reset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--st-blue-light);
            transform: translateY(-1px);
        }

        .st-reset-btn:active {
            transform: translateY(0);
        }

        .st-btn-icon {
            font-size: 20px;
        }

        /* Modal Styles */
        .st-modal {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .st-modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .st-modal-content {
            position: relative;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .st-modal-small {
            max-width: 400px;
        }

        .st-modal-header {
            padding: 24px;
            border-bottom: 2px solid var(--st-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .st-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--st-gray-900);
        }

        .st-modal-close {
            background: none;
            border: none;
            font-size: 32px;
            line-height: 1;
            color: var(--st-gray-600);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .st-modal-close:hover {
            background: var(--st-gray-100);
            color: var(--st-gray-900);
        }

        .st-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .st-modal-footer {
            padding: 20px 24px;
            border-top: 2px solid var(--st-gray-200);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Buttons */
        .st-btn-primary {
            padding: 12px 24px;
            background: var(--st-blue-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .st-btn-primary:hover {
            background: var(--st-blue-dark);
            transform: translateY(-1px);
        }

        .st-btn-secondary {
            padding: 12px 24px;
            background: var(--st-gray-100);
            color: var(--st-gray-900);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .st-btn-secondary:hover {
            background: var(--st-gray-200);
        }

        /* Search Box */
        .st-search-box {
            margin-bottom: 24px;
        }

        .st-search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--st-gray-300);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .st-search-input:focus {
            outline: none;
            border-color: var(--st-blue-primary);
            box-shadow: 0 0 0 3px rgba(0, 85, 165, 0.1);
        }

        /* Popular Section */
        .st-popular-section {
            margin-bottom: 32px;
        }

        .st-popular-section h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--st-gray-900);
            margin: 0 0 16px 0;
        }

        .st-popular-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .st-country-card {
            padding: 16px;
            border: 2px solid var(--st-gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
            position: relative;
        }

        .st-country-card:hover {
            border-color: var(--st-blue-primary);
            background: var(--st-blue-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .st-country-card input[type="checkbox"] {
            display: none;
        }

        .st-country-card input[type="checkbox"]:checked+.st-card-content {
            color: var(--st-blue-primary);
            font-weight: 600;
        }

        .st-card-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .st-country-name {
            font-size: 15px;
            color: var(--st-gray-900);
        }

        .st-hotel-count {
            font-size: 13px;
            color: var(--st-gray-600);
        }

        /* Countries List */
        .st-all-countries-section h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--st-gray-900);
            margin: 0 0 16px 0;
        }

        .st-countries-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--st-gray-200);
            border-radius: 8px;
            padding: 8px;
        }

        .st-country-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .st-country-item:hover {
            background: var(--st-gray-50);
        }

        .st-country-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .st-country-item .st-country-name {
            flex: 1;
            font-size: 14px;
        }

        .st-country-item .st-hotel-count {
            font-size: 13px;
            color: var(--st-gray-600);
        }

        /* Quick Select Buttons */
        .st-quick-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .st-quick-btn {
            padding: 8px 16px;
            background: var(--st-gray-100);
            border: 2px solid transparent;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .st-quick-btn:hover {
            background: var(--st-gray-200);
        }

        .st-quick-btn.active {
            background: var(--st-blue-primary);
            color: white;
            border-color: var(--st-blue-primary);
        }

        /* Datepicker Styling */
        .st-date-input-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .st-date-field {
            flex: 1 1 150px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .st-date-field label {
            font-size: 13px;
            font-weight: 600;
            color: var(--st-gray-700);
        }

        .st-date-field input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--st-gray-200);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
            background: white;
            cursor: pointer;
        }

        .st-date-field input:hover,
        .st-date-field input:focus {
            border-color: var(--st-blue-primary);
            box-shadow: 0 0 0 3px rgba(0, 85, 165, 0.1);
            outline: none;
        }

        /* Flatpickr Custom Styling */
        .flatpickr-calendar {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12) !important;
            border: 2px solid var(--st-gray-200) !important;
            border-radius: 16px !important;
        }

        .flatpickr-day.selected {
            background: var(--st-blue-primary) !important;
            border-color: var(--st-blue-primary) !important;
        }

        .flatpickr-day.selected:hover {
            background: var(--st-blue-dark) !important;
            border-color: var(--st-blue-dark) !important;
        }

        .flatpickr-day:hover {
            background: var(--st-blue-light) !important;
            border-color: var(--st-blue-light) !important;
        }

        .flatpickr-months .flatpickr-month {
            background: var(--st-blue-primary) !important;
            color: white !important;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: var(--st-blue-primary) !important;
        }

        .flatpickr-weekday {
            color: var(--st-blue-primary) !important;
            font-weight: 600 !important;
        }

        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            color: white !important;
        }

        .flatpickr-months .flatpickr-month {
            background: var(--st-blue-primary) !important;
            border-radius: 12px 12px 0 0 !important;
        }

        /* Radio List */
        .st-radio-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .st-radio-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: 2px solid var(--st-gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .st-radio-item:hover {
            background: var(--st-gray-50);
            border-color: var(--st-blue-primary);
        }

        .st-radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .st-radio-item input[type="radio"]:checked~span {
            color: var(--st-blue-primary);
            font-weight: 600;
        }

        /* Counter Controls */
        .st-counter-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--st-gray-200);
        }

        .st-counter-row:last-child {
            border-bottom: none;
        }

        .st-counter-label {
            font-size: 15px;
            font-weight: 500;
            color: var(--st-gray-900);
        }

        .st-counter-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .st-counter-btn {
            width: 36px;
            height: 36px;
            border: 2px solid var(--st-blue-primary);
            border-radius: 50%;
            background: white;
            color: var(--st-blue-primary);
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .st-counter-btn:hover {
            background: var(--st-blue-primary);
            color: white;
        }

        .st-counter-value {
            font-size: 18px;
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .st-search-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .st-field-submit {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 640px) {
            .st-search-grid {
                grid-template-columns: 1fr;
            }

            .st-header-search-widget {
                position: relative;
                /* NOT sticky on mobile */
                padding: 16px 0;
            }

            .st-search-title {
                font-size: 20px;
                margin-bottom: 16px;
            }

            .st-popular-grid {
                grid-template-columns: 1fr;
            }

            .st-modal-content {
                max-width: 100%;
                margin: 0 12px;
            }
        }

        /* ============================================================================
           HIDE OLD SEARCH FORMS ON HOTELS PAGE
           ============================================================================ */
        body.page-hotels #st-tab-free,
        body.page-hotels #st-tab-advanced,
        body.page-hotels .st-tablink,
        body.page-hotels .st-tabs-container,
        body.page-hotels .st-search-tabs,
        body.post-type-archive-hotel #st-tab-free,
        body.post-type-archive-hotel #st-tab-advanced,
        body.post-type-archive-hotel .st-tablink,
        body.post-type-archive-hotel .st-tabs-container,
        body.post-type-archive-hotel .st-search-tabs {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
            opacity: 0 !important;
        }
    </style>

    <script>
        // ============================================================================
        // UNIVERSAL AUTOCOMPLETE SEARCH (HEADER)
        // ============================================================================
        (function () {
            // Wait for function to be available
            function initHeaderSearch() {
                if (typeof initUniversalSearch === 'function') {
                    initUniversalSearch(
                        'st-universal-search-header',
                        'st-autocomplete-results-header',
                        'st-search-input-wrapper-header',
                        'st-search-clear-header',
                        'st-search-loading-header'
                    );
                } else {
                    // Retry after a short delay if function not yet loaded
                    setTimeout(initHeaderSearch, 50);
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initHeaderSearch);
            } else {
                initHeaderSearch();
            }
        })();

        // ============================================================================
        // HEADER SEARCH WIDGET JAVASCRIPT
        // ============================================================================

        // State management
        let stSearchState = {
            selectedCountries: [],
            checkinDate: null,
            checkoutDate: null,
            nights: 7,  // Calculated automatically from date range
            rooms: 1,
            adults: 2,
            children: 0
        };


        // Modal functions
        function stOpenModal(type) {
            const modal = document.getElementById(`st-${type}-modal`);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function stCloseModal(type) {
            const modal = document.getElementById(`st-${type}-modal`);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // Close on overlay click
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('st-modal-overlay')) {
                const modal = e.target.closest('.st-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }
        });

        // ESC key to close
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.st-modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                document.body.style.overflow = '';
            }
        });

        // Trigger buttons
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('st-destination-trigger')?.addEventListener('click', () => stOpenModal('destination'));
            document.getElementById('st-date-trigger')?.addEventListener('click', () => stOpenModal('date'));
            document.getElementById('st-travelers-trigger')?.addEventListener('click', () => stOpenModal('travelers'));

            // Hide old search forms completely (they are already in hidden div, this is extra safety)
            const oldSearchForms = document.querySelectorAll('#st-tab-free, #st-tab-advanced, .st-tablink, .st-tabs-container, .st-search-tabs, #st-search-form-container, .st-search-wrapper, .st-toggle-search');
            oldSearchForms.forEach(form => {
                if (form && !form.closest('[style*="display:none"]')) {
                    form.style.display = 'none';
                    form.style.visibility = 'hidden';
                    form.style.height = '0';
                    form.style.overflow = 'hidden';
                    form.style.opacity = '0';
                    form.style.pointerEvents = 'none';
                }
            });

            // Also hide "Pas uw zoekopdracht aan" link
            const toggleLinks = document.querySelectorAll('a[href*="toggle"], a[onclick*="search"], .st-search-toggle, button[onclick*="search"]');
            toggleLinks.forEach(link => {
                const text = link.textContent || link.innerText || '';
                if (text.toLowerCase().includes('pas uw') || text.toLowerCase().includes('zoekopdracht') || text.toLowerCase().includes('aanpassen')) {
                    link.style.display = 'none';
                }
            });

            console.log('‚úÖ Old search forms hidden everywhere');
        });

        // Countries functions
        function stResetCountries() {
            document.querySelectorAll('.st-country-checkbox').forEach(cb => cb.checked = false);
            stSearchState.selectedCountries = [];
            document.getElementById('st-destination-display').textContent = 'Alle landen';
            document.getElementById('st-countries-input').value = '';
        }

        function stApplyCountries() {
            const selected = [];
            document.querySelectorAll('.st-country-checkbox:checked').forEach(cb => {
                selected.push(cb.value);
            });

            stSearchState.selectedCountries = selected;

            // Als √©√©n land geselecteerd, toon resort selector
            if (selected.length === 1) {
                stCloseModal('destination');
                stShowResortSelector(selected[0]);
                return;
            }

            // Anders: gewone flow
            const display = selected.length === 0 ? 'Alle landen'
                : `${selected.length} landen geselecteerd`;

            document.getElementById('st-destination-display').textContent = display;
            document.getElementById('st-countries-input').value = selected.length > 0 ? selected[0] : '';

            stCloseModal('destination');
        }

        // Resort/City selector functions
        let stCurrentCountry = '';
        let stAvailableResorts = [];

        function stShowResortSelector(country) {
            stCurrentCountry = country;

            // Update modal title
            document.getElementById('st-resort-modal-title').textContent = `Kies een stad/resort in ${country}`;
            document.getElementById('st-resort-country-name').textContent = country;

            // Show modal with loading state
            document.getElementById('st-resort-modal').style.display = 'flex';
            document.getElementById('st-resort-loading').style.display = 'block';
            document.getElementById('st-resort-search-box').style.display = 'none';
            document.getElementById('st-resort-skip').style.display = 'none';
            document.getElementById('st-resort-list').style.display = 'none';
            document.getElementById('st-resort-error').style.display = 'none';

            // Fetch resorts via AJAX
            const ajaxurl = '<?php echo admin_url('admin-ajax.php'); ?>';
            fetch(`${ajaxurl}?action=shorttrips_get_resorts_by_country&country=${encodeURIComponent(country)}`)
                .then(r => r.json())
                .then(data => {
                    console.log('üì° API RESPONSE ONTVANGEN:', data);
                    console.log('üîç API Details:', {
                        success: data.success,
                        total: data.data?.total,
                        code_version: data.data?.code_version,
                        sql_limit: data.data?.sql_limit,
                        first_city: data.data?.resorts?.[0]?.name,
                        last_city: data.data?.resorts?.[data.data.resorts.length - 1]?.name,
                        resorts_length: data.data?.resorts?.length
                    });
                    if (data.success && data.data.resorts) {
                        console.log('‚úÖ DATA SUCCESS - Steden array lengte:', data.data.resorts.length);
                        stAvailableResorts = data.data.resorts;
                        stRenderResorts(data.data.resorts);
                    } else {
                        console.error('‚ùå DATA FAILED:', data);
                        stShowResortError();
                    }
                })
                .catch(err => {
                    console.error('Resort fetch error:', err);
                    stShowResortError();
                });
        }

        function stRenderResorts(resorts) {
            console.log('üé® stRenderResorts START - Aantal steden ontvangen:', resorts.length);
            console.log('üé® Eerste 3 steden:', resorts.slice(0, 3).map(r => r.name));
            console.log('üé® Laatste 3 steden:', resorts.slice(-3).map(r => r.name));

            const list = document.getElementById('st-resort-list');
            list.innerHTML = '';

            if (resorts.length === 0) {
                stShowResortError();
                return;
            }

            // Hide loading, show content
            document.getElementById('st-resort-loading').style.display = 'none';
            document.getElementById('st-resort-search-box').style.display = 'block';
            document.getElementById('st-resort-skip').style.display = 'block';
            list.style.display = 'block';

            // Render resort radio buttons
            let renderedCount = 0;
            resorts.forEach(resort => {
                renderedCount++;
                const label = document.createElement('label');
                label.className = 'st-country-item';
                label.style.cursor = 'pointer';
                label.style.padding = '12px';
                label.style.borderRadius = '8px';
                label.style.border = '1px solid #e5e7eb';
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '12px';
                label.style.transition = 'all 0.2s';

                const countHtml = resort.hotel_count > 0
                    ? `<div class="st-hotel-count" style="font-size:13px;color:#6b7280;">${resort.hotel_count} hotels</div>`
                    : '';

                // üîß FIX: Add data-id attribute for API call
                label.dataset.id = resort.id || '';  // Store destination_id
                label.dataset.name = resort.name;    // Store name for display

                label.innerHTML = `
                <input type="radio" name="st-resort-choice" value="${resort.name}" style="margin:0;">
                <div style="flex:1;">
                    <div class="st-country-name" style="font-weight:500;font-size:15px;">${resort.name}</div>
                    ${countHtml}
                </div>
            `;

                label.addEventListener('mouseenter', () => {
                    label.style.background = '#f3f4f6';
                });
                label.addEventListener('mouseleave', () => {
                    label.style.background = '#fff';
                });

                list.appendChild(label);
            });

            console.log('‚úÖ RENDER COMPLETE - Toegevoegd aan DOM:', renderedCount, 'steden');
            console.log('‚úÖ Items in list:', list.children.length);

            // Setup resort search
            const searchInput = document.getElementById('st-resort-search');
            if (searchInput) {
                searchInput.value = '';
                searchInput.oninput = () => {
                    const query = searchInput.value.toLowerCase();
                    const items = list.querySelectorAll('.st-country-item');
                    console.log('üîç SEARCH:', query, '- Totaal items:', items.length);
                    let visible = 0;
                    items.forEach(item => {
                        const name = item.querySelector('.st-country-name').textContent.toLowerCase();
                        const show = name.includes(query);
                        item.style.display = show ? 'flex' : 'none';
                        if (show) visible++;
                    });
                    console.log('‚úÖ SEARCH RESULT:', visible, 'van', items.length, 'zichtbaar');
                };
            }

            console.log('‚úÖ stRenderResorts KLAAR');
        }

        function stShowResortError() {
            document.getElementById('st-resort-loading').style.display = 'none';
            document.getElementById('st-resort-error').style.display = 'block';
        }

        function stBackToCountries() {
            stCloseModal('resort');
            stOpenModal('destination');
        }

        function stApplyResort() {
            const selected = document.querySelector('input[name="st-resort-choice"]:checked');

            if (!selected) {
                alert('Selecteer een stad of kies "Alle steden"');
                return;
            }

            const resortName = selected.value;
            const selectedItem = selected.closest('.st-country-item');
            const resortId = selectedItem ? selectedItem.dataset.id : null;

            // Update display and form
            if (resortName === '') {
                // User chose "All cities in country"
                document.getElementById('st-destination-display').textContent = stCurrentCountry;
                document.getElementById('st-countries-input').value = stCurrentCountry;

                // Clear resort input if exists
                let resortInput = document.getElementById('st-resort-input');
                if (!resortInput) {
                    resortInput = document.createElement('input');
                    resortInput.type = 'hidden';
                    resortInput.name = 'resort_name';
                    resortInput.id = 'st-resort-input';
                    document.getElementById('st-search-form').appendChild(resortInput);
                }
                resortInput.value = '';

                // üîß CRITICAL FIX: Use FIRST destination_id when "All cities" is selected
                // This ensures SearchV3 API gets at least ONE valid destination for the country
                if (stAvailableResorts && stAvailableResorts.length > 0) {
                    const firstResortWithId = stAvailableResorts.find(r => r.id && r.id !== 'null');
                    if (firstResortWithId) {
                        let destIdInput = document.getElementById('st-destination-id-input');
                        if (!destIdInput) {
                            destIdInput = document.createElement('input');
                            destIdInput.type = 'hidden';
                            destIdInput.name = 'destinationID';
                            destIdInput.id = 'st-destination-id-input';
                            document.getElementById('st-search-form').appendChild(destIdInput);
                        }
                        destIdInput.value = firstResortWithId.id;
                        console.log('‚úÖ Using first destination_id for country search:', firstResortWithId.id, firstResortWithId.name);
                    } else {
                        // No valid IDs - remove destinationID input
                        const destIdInput = document.getElementById('st-destination-id-input');
                        if (destIdInput) {
                            destIdInput.remove();
                        }
                        console.warn('‚ö†Ô∏è No destination_id available for:', stCurrentCountry);
                    }
                }
            } else {
                // User chose specific city
                // üîß FIX: Use destination_id instead of name for API call
                document.getElementById('st-destination-display').textContent = `${resortName}, ${stCurrentCountry}`;
                document.getElementById('st-countries-input').value = stCurrentCountry;

                // Add destination ID input (for API call)
                if (resortId) {
                    let destIdInput = document.getElementById('st-destination-id-input');
                    if (!destIdInput) {
                        destIdInput = document.createElement('input');
                        destIdInput.type = 'hidden';
                        destIdInput.name = 'destinationID';
                        destIdInput.id = 'st-destination-id-input';
                        document.getElementById('st-search-form').appendChild(destIdInput);
                    }
                    destIdInput.value = resortId;

                    // Remove old resort_name input if exists (we use ID now)
                    const oldResortInput = document.getElementById('st-resort-input');
                    if (oldResortInput) {
                        oldResortInput.remove();
                    }
                } else {
                    // Fallback: als geen ID, gebruik naam
                    console.warn('‚ö†Ô∏è No destination_id found for:', resortName);
                    let resortInput = document.getElementById('st-resort-input');
                    if (!resortInput) {
                        resortInput = document.createElement('input');
                        resortInput.type = 'hidden';
                        resortInput.name = 'resort_name';
                        resortInput.id = 'st-resort-input';
                        document.getElementById('st-search-form').appendChild(resortInput);
                    }
                    resortInput.value = resortName;
                }
            }

            console.log('üèôÔ∏è Resort selected:', {
                country: stCurrentCountry,
                resort: resortName || 'All cities',
                destinationID: resortId
            });

            // Close modal
            stCloseModal('resort');
        }

        // Country search with improved UX - show search results first, then popular
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('st-country-search');
            const popularSection = document.querySelector('.st-popular-section');
            const allSection = document.querySelector('.st-all-countries-section');

            if (searchInput && popularSection && allSection) {
                searchInput.addEventListener('input', function (e) {
                    const query = e.target.value.toLowerCase().trim();

                    if (query === '') {
                        // No search - show popular first, then all
                        popularSection.style.display = 'block';
                        popularSection.style.order = '1';
                        allSection.style.order = '2';

                        // Show all countries
                        document.querySelectorAll('.st-country-item, .st-country-card').forEach(item => {
                            item.style.display = 'flex';
                        });
                    } else {
                        // Active search - hide popular section, show only matching results
                        popularSection.style.display = 'none';
                        allSection.style.order = '1';

                        // Filter countries
                        document.querySelectorAll('.st-country-item').forEach(item => {
                            const name = item.querySelector('.st-country-name').textContent.toLowerCase();
                            item.style.display = name.includes(query) ? 'flex' : 'none';
                        });
                    }
                });
            }
        });

        // Duration functions REMOVED - now using date range picker instead

        // Travelers functions
        function stUpdateCounter(type, delta) {
            const countEl = document.getElementById(`st-${type}-count`);
            const inputEl = document.getElementById(`st-${type}-input`);
            let current = parseInt(countEl.textContent);

            const min = type === 'rooms' || type === 'adults' ? 1 : 0;
            const max = type === 'rooms' ? 10 : type === 'adults' ? 20 : 10;

            current = Math.max(min, Math.min(max, current + delta));

            countEl.textContent = current;
            inputEl.value = current;
            stSearchState[type] = current;

            // Update children ages inputs when children count changes
            if (type === 'children') {
                stUpdateChildrenAges(current);
            }
        }

        function stUpdateChildrenAges(count) {
            const container = document.getElementById('st-children-ages-container');
            const list = document.getElementById('st-children-ages-list');

            if (count === 0) {
                container.style.display = 'none';
                list.innerHTML = '';
                return;
            }

            container.style.display = 'block';

            // Get current ages if they exist
            const currentAges = [];
            const existingSelects = list.querySelectorAll('select');
            existingSelects.forEach(select => {
                currentAges.push(parseInt(select.value) || 5);
            });

            // Build new age selectors
            let html = '';
            for (let i = 0; i < count; i++) {
                const defaultAge = currentAges[i] || 5;
                html += `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <label style="flex:1;font-size:13px;color:#374151;">Kind ${i + 1}:</label>
                    <select class="st-child-age-select" data-index="${i}" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;min-width:80px;">
                        ${Array.from({ length: 18 }, (_, age) =>
                `<option value="${age}" ${age === defaultAge ? 'selected' : ''}>${age} jaar</option>`
            ).join('')}
                    </select>
                </div>
            `;
            }

            list.innerHTML = html;
        }

        function stApplyTravelers() {
            const rooms = stSearchState.rooms;
            const adults = stSearchState.adults;
            const children = stSearchState.children;

            // Collect child ages
            const ageSelects = document.querySelectorAll('.st-child-age-select');
            const childAges = Array.from(ageSelects).map(select => select.value);

            // Update hidden input for child_ages
            const childAgesInput = document.getElementById('st-child-ages-input');
            if (childAgesInput) {
                childAgesInput.value = childAges.join(',');
            }

            let text = `${adults + children} ${adults + children === 1 ? 'persoon' : 'personen'} op ${rooms} ${rooms === 1 ? 'kamer' : 'kamers'}`;
            if (children > 0) {
                text += ` (${children} ${children === 1 ? 'kind' : 'kinderen'})`;
            }

            document.getElementById('st-travelers-display').textContent = text;

            stCloseModal('travelers');
        }

        // Date helper functies (zelfde experience als vrije zoekveld)
        const ST_MONTHS_SHORT = ['jan', 'feb', 'mrt', 'apr', 'mei', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
        let stCheckinPicker = null;
        let stCheckoutPicker = null;

        function stBuildDefaultRange(offsetDays = 7, nights = 7) {
            const start = new Date();
            start.setHours(0, 0, 0, 0);
            start.setDate(start.getDate() + offsetDays);
            const end = new Date(start);
            end.setDate(end.getDate() + nights);
            return { start, end };
        }

        function stApplyRangeToState(startDate, endDate) {
            if (!startDate || !endDate) return;

            const start = new Date(startDate);
            const end = new Date(endDate);

            stSearchState.checkinDate = start.toISOString().split('T')[0];
            stSearchState.checkoutDate = end.toISOString().split('T')[0];
            stSearchState.nights = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));

            document.getElementById('st-checkin-input').value = stSearchState.checkinDate;
            document.getElementById('st-checkout-input').value = stSearchState.checkoutDate;
            stUpdateDateDisplayFromState();
        }

        function stUpdateDateDisplayFromState() {
            if (!stSearchState.checkinDate || !stSearchState.checkoutDate) {
                document.getElementById('st-date-display').textContent = 'Kies datums';
                return;
            }

            const checkin = new Date(stSearchState.checkinDate);
            const checkout = new Date(stSearchState.checkoutDate);
            const displayText = `${checkin.getDate()} ${ST_MONTHS_SHORT[checkin.getMonth()]} - ${checkout.getDate()} ${ST_MONTHS_SHORT[checkout.getMonth()]}`;
            document.getElementById('st-date-display').textContent = displayText;
        }

        function stInitDatepickers() {
            if (typeof flatpickr === 'undefined') {
                setTimeout(stInitDatepickers, 120);
                return;
            }

            const checkinEl = document.getElementById('st-date-modal-checkin');
            const checkoutEl = document.getElementById('st-date-modal-checkout');
            if (!checkinEl || !checkoutEl) {
                return;
            }

            const defaults = stBuildDefaultRange();
            const defaultRange = stSearchState.checkinDate && stSearchState.checkoutDate
                ? [new Date(stSearchState.checkinDate), new Date(stSearchState.checkoutDate)]
                : [defaults.start, defaults.end];

            if (stCheckinPicker) {
                stCheckinPicker.destroy();
                stCheckinPicker = null;
            }
            if (stCheckoutPicker) {
                stCheckoutPicker.destroy();
                stCheckoutPicker = null;
            }

            stCheckinPicker = flatpickr(checkinEl, {
                dateFormat: 'Y-m-d',
                minDate: 'today',
                disableMobile: true,
                defaultDate: defaultRange[0],
                locale: 'nl',
                onChange(selectedDates) {
                    if (selectedDates[0]) {
                        const start = selectedDates[0];
                        const minCheckout = new Date(start);
                        minCheckout.setDate(minCheckout.getDate() + 1);
                        if (stCheckoutPicker) {
                            stCheckoutPicker.set('minDate', minCheckout);
                            if (!stCheckoutPicker.selectedDates[0] || stCheckoutPicker.selectedDates[0] <= start) {
                                const autoCheckout = new Date(start);
                                autoCheckout.setDate(autoCheckout.getDate() + 7);
                                stCheckoutPicker.setDate(autoCheckout, false);
                            }
                        }
                    }
                }
            });

            const checkoutMin = new Date(defaultRange[0].getTime() + 86400000);

            stCheckoutPicker = flatpickr(checkoutEl, {
                dateFormat: 'Y-m-d',
                minDate: checkoutMin,
                disableMobile: true,
                defaultDate: defaultRange[1],
                locale: 'nl',
                onChange(selectedDates) {
                    if (selectedDates[0]) {
                        stApplyRangeToState(stCheckinPicker && stCheckinPicker.selectedDates[0] ? stCheckinPicker.selectedDates[0] : defaultRange[0], selectedDates[0]);
                    }
                }
            });

            console.log('‚úÖ Flatpickr datumvelden klaar');
        }

        function stResetDate() {
            document.getElementById('st-date-display').textContent = 'Select dates';
            document.getElementById('st-checkin-input').value = '';
            document.getElementById('st-checkout-input').value = '';
            stSearchState.checkinDate = null;
            stSearchState.checkoutDate = null;
            stSearchState.nights = null;
            if (stCheckinPicker) {
                stCheckinPicker.clear();
            }
            if (stCheckoutPicker) {
                stCheckoutPicker.clear();
            }
        }

        function stApplyDate() {
            const checkinField = document.getElementById('st-date-modal-checkin');
            const checkoutField = document.getElementById('st-date-modal-checkout');

            let checkinDate = checkinField && checkinField.value ? new Date(checkinField.value) : null;
            let checkoutDate = checkoutField && checkoutField.value ? new Date(checkoutField.value) : null;

            if (!checkinDate) {
                alert('Selecteer een check-in datum');
                return;
            }

            if (!checkoutDate) {
                checkoutDate = new Date(checkinDate);
                checkoutDate.setDate(checkoutDate.getDate() + 7);
                if (stCheckoutPicker) {
                    stCheckoutPicker.setDate(checkoutDate, false);
                }
            }

            if (checkoutDate <= checkinDate) {
                checkoutDate = new Date(checkinDate);
                checkoutDate.setDate(checkoutDate.getDate() + 1);
                if (stCheckoutPicker) {
                    stCheckoutPicker.setDate(checkoutDate, false);
                }
            }

            stApplyRangeToState(checkinDate, checkoutDate);

            console.log('üìÖ Date range applied:', {
                checkin: stSearchState.checkinDate,
                checkout: stSearchState.checkoutDate,
                nights: stSearchState.nights
            });

            stCloseModal('date');
        }

        // Initialize Flatpickr inputs when date modal opens
        document.addEventListener('DOMContentLoaded', function () {
            const dateTrigger = document.getElementById('st-date-trigger');
            if (dateTrigger) {
                dateTrigger.addEventListener('click', function () {
                    setTimeout(stInitDatepickers, 120);
                });
            }
        });

        // Form submit handler - just log before normal GET submit
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('st-search-form');
            if (form) {
                form.addEventListener('submit', async function (e) {
                    // Verify required fields
                    const checkin = document.getElementById('st-checkin-input').value;
                    const checkout = document.getElementById('st-checkout-input').value;

                    if (!checkin || !checkout) {
                        e.preventDefault();
                        alert('Kies datum voor uw reis\n\nKlik op het datumveld om uw check-in en check-out datums te selecteren.');
                        return false;
                    }

                    const country = document.getElementById('st-countries-input').value;

                    // üîß CRITICAL: Ensure destinationID exists before submitting
                    let destIdInput = document.getElementById('st-destination-id-input');
                    if (country && (!destIdInput || !destIdInput.value)) {
                        e.preventDefault();

                        // Fetch first destination_id for this country
                        console.log('‚ö° Fetching destination_id for:', country);
                        try {
                            const ajaxurl = '<?php echo admin_url('admin-ajax.php'); ?>';
                            const response = await fetch(`${ajaxurl}?action=shorttrips_get_resorts_by_country&country=${encodeURIComponent(country)}`);
                            const data = await response.json();

                            if (data.success && data.data.resorts && data.data.resorts.length > 0) {
                                const firstResortWithId = data.data.resorts.find(r => r.id && r.id !== 'null');
                                if (firstResortWithId) {
                                    // Add destinationID to form
                                    if (!destIdInput) {
                                        destIdInput = document.createElement('input');
                                        destIdInput.type = 'hidden';
                                        destIdInput.name = 'destinationID';
                                        destIdInput.id = 'st-destination-id-input';
                                        form.appendChild(destIdInput);
                                    }
                                    destIdInput.value = firstResortWithId.id;
                                    console.log('‚úÖ Added destinationID:', firstResortWithId.id);

                                    // Resubmit form
                                    form.submit();
                                    return;
                                }
                            }

                            console.warn('‚ö†Ô∏è No destination_id found, submitting without it');
                            form.submit();
                        } catch (error) {
                            console.error('‚ùå Error fetching destination_id:', error);
                            form.submit(); // Submit anyway
                        }
                        return false;
                    }

                    // Build URL manually to verify all params
                    const urlFormData = new FormData(form);
                    const params = new URLSearchParams(urlFormData);
                    const url = form.action + '?' + params.toString();

                    // üîß DEBUG: Log all form data including destinationID
                    const destId = destIdInput ? destIdInput.value : 'MISSING';
                    console.log('üîç Form submitting to /hotels/ with params:', {
                        type: 'country',
                        country_name: country || 'Alle landen',
                        destinationID: destId,  // üîß CRITICAL: Log if destinationID is present
                        checkin: checkin,
                        checkout: checkout,
                        rooms: stSearchState.rooms,
                        adults: stSearchState.adults,
                        children: stSearchState.children
                    });

                    if (destId === 'MISSING') {
                        console.error('‚ùå WARNING: destinationID is MISSING from form!');
                    }

                    console.log('üåê Full URL will be:', url);

                    // üöÄ CRITICAL FIX: Use AJAX submit instead of GET navigation
                    // Dit zorgt ervoor dat hotels direct geladen worden zonder page reload
                    e.preventDefault();

                    // Show loading state
                    const submitBtn = document.getElementById('st-submit-btn');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span>üîÑ Search...</span>';
                    }

                    // Call the search handler via AJAX
                    const formData = new FormData(form);
                    formData.append('action', 'shorttrips_search_hotels');

                    // Convert FormData to URLSearchParams for POST
                    const postData = new URLSearchParams();
                    for (const [key, value] of formData.entries()) {
                        postData.append(key, value);
                    }

                    console.log('üöÄ Submitting search via AJAX...');

                    const postBody = postData.toString();
                    const fallbackSearchUrl = '<?php echo home_url('/'); ?>?action=shorttrips_search_hotels';
                    const primarySearchUrl = '<?php echo admin_url('admin-ajax.php'); ?>';

                    function executeSearch(url, isFallback) {
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: postBody
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                                }
                                return response.text();
                            })
                            .then(html => {
                                console.log('‚úÖ Search results received (' + (isFallback ? 'fallback' : 'primary') + ')');

                                const resultsContainer = document.getElementById('hotels-results-container');
                                let resultsTarget = document.getElementById('st-results');

                                if (resultsTarget) {
                                    resultsTarget.innerHTML = html;
                                } else if (resultsContainer) {
                                    resultsTarget = resultsContainer;
                                    resultsTarget.innerHTML = html;
                                } else {
                                    console.warn('‚ö†Ô∏è No results container found, showing below form');
                                    const fallbackDiv = document.createElement('div');
                                    fallbackDiv.id = 'hotels-results-container';
                                    fallbackDiv.innerHTML = html;
                                    form.parentNode.appendChild(fallbackDiv);
                                    resultsTarget = fallbackDiv;
                                }

                                if (resultsTarget) {
                                    const payloadNode = resultsTarget.querySelector('#st-search-payload');
                                    if (payloadNode) {
                                        const payloadAttr = payloadNode.getAttribute('data-payload');
                                        if (payloadAttr) {
                                            try {
                                                window.stLastSearchPayload = JSON.parse(payloadAttr);
                                                console.log('‚úÖ Search payload refreshed:', window.stLastSearchPayload);
                                            } catch (err) {
                                                console.error('‚ùå Failed to parse search payload:', err);
                                            }
                                        }
                                    }
                                }

                                if (resultsContainer) {
                                    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }

                                if (typeof window.stToggleInlineFilters === 'function') {
                                    window.stToggleInlineFilters(true);
                                }

                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = '<span>üîç Find hotels</span>';
                                }

                                if (typeof window.initShortTripsPagination === 'function') {
                                    setTimeout(window.initShortTripsPagination, 50);
                                }
                                if (typeof window.initShortTripsCardExtras === 'function') {
                                    window.initShortTripsCardExtras();
                                }
                            })
                            .catch(error => {
                                console.error('‚ùå Search failed (' + (isFallback ? 'fallback' : 'primary') + '):', error);

                                if (!isFallback) {
                                    console.warn('‚ö†Ô∏è Primary search failed, trying fallback endpoint...');
                                    executeSearch(fallbackSearchUrl, true);
                                    return;
                                }

                                // Show user-friendly error
                                const resultsTarget = document.getElementById('st-results') || document.getElementById('hotels-results-container');
                                if (resultsTarget) {
                                    resultsTarget.innerHTML = '<div class="text-center py-12"><div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-md mx-auto"><h3 class="text-red-800 font-semibold text-lg mb-2">‚ö†Ô∏è Zoeken tijdelijk niet beschikbaar</h3><p class="text-red-600 mb-4">Er is een probleem met de verbinding. Probeer het over een paar seconden opnieuw.</p><button onclick="location.reload()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Vernieuw pagina</button></div></div>';
                                } else {
                                    alert('Er ging iets mis bij het zoeken. Probeer het opnieuw.');
                                }

                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = '<span>üîç Search hotels</span>';
                                }
                            });
                    }

                    executeSearch(primarySearchUrl, false);

                    return false;
                });
            }
        });

        // Set default dates on page load OR restore from URL (7 days from now + 7 nights = 14 days total)
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);

            // Check if we have search params in URL (after search)
            const urlCheckin = urlParams.get('checkin');
            const urlCheckout = urlParams.get('checkout');
            const urlNights = urlParams.get('nights');
            const urlCountry = urlParams.get('country_name') || urlParams.get('country');
            const urlResort = urlParams.get('resort_name') || urlParams.get('resort');
            const urlRooms = urlParams.get('rooms');
            const urlAdults = urlParams.get('adults');
            const urlChildren = urlParams.get('children');
            const urlChildAges = urlParams.get('child_ages');

            if (urlCheckin && urlCheckout) {
                // Restore search values from URL
                document.getElementById('st-checkin-input').value = urlCheckin;
                document.getElementById('st-checkout-input').value = urlCheckout;

                stSearchState.checkinDate = urlCheckin;
                stSearchState.checkoutDate = urlCheckout;
                // Calculate nights from date range
                const diffTimeMs = Math.abs(new Date(urlCheckout) - new Date(urlCheckin));
                stSearchState.nights = Math.ceil(diffTimeMs / (1000 * 60 * 60 * 24));

                // Update display texts
                if (urlCountry) {
                    document.getElementById('st-destination-display').textContent = urlResort || urlCountry;
                    document.getElementById('st-countries-input').value = urlCountry;
                }
                if (urlResort && document.getElementById('st-resorts-input')) {
                    document.getElementById('st-resorts-input').value = urlResort;
                }

                // Update travelers
                if (urlRooms) {
                    document.getElementById('st-rooms-count').textContent = urlRooms;
                    document.getElementById('st-rooms-input').value = urlRooms;
                    stSearchState.rooms = parseInt(urlRooms);
                }
                if (urlAdults) {
                    document.getElementById('st-adults-count').textContent = urlAdults;
                    document.getElementById('st-adults-input').value = urlAdults;
                    stSearchState.adults = parseInt(urlAdults);
                }
                if (urlChildren) {
                    document.getElementById('st-children-count').textContent = urlChildren;
                    document.getElementById('st-children-input').value = urlChildren;
                    stSearchState.children = parseInt(urlChildren);

                    // Parse child ages and update the UI
                    if (urlChildAges && document.getElementById('st-child-ages-input')) {
                        document.getElementById('st-child-ages-input').value = urlChildAges;

                        // Trigger the child ages UI update
                        stUpdateChildAges();
                    }
                }

                // Update travelers display
                const totalGuests = (parseInt(urlAdults) || 2) + (parseInt(urlChildren) || 0);
                document.getElementById('st-travelers-display').textContent = `${totalGuests} ${totalGuests === 1 ? 'gast' : 'gasten'}`;

                // Update date display
                const checkinDate = new Date(urlCheckin);
                const checkoutDate = new Date(urlCheckout);
                const months = ['jan', 'feb', 'mrt', 'apr', 'mei', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
                document.getElementById('st-date-display').textContent =
                    `${checkinDate.getDate()} ${months[checkinDate.getMonth()]} - ${checkoutDate.getDate()} ${months[checkoutDate.getMonth()]}`;

                // Calculate nights from date range
                const diffTime = Math.abs(checkoutDate - checkinDate);
                stSearchState.nights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                console.log('üîÑ Search values restored from URL');

                // üöÄ AUTO-SUBMIT: Als destinationID in URL staat, submit automatisch het formulier
                const urlDestinationID = urlParams.get('destinationID');
                const urlType = urlParams.get('type');

                if (urlDestinationID && urlType) {
                    console.log('üéØ AUTO-SUBMIT detected! destinationID:', urlDestinationID);

                    // Voeg destinationID toe aan formulier als hidden input
                    const form = document.getElementById('st-search-form');
                    if (form) {
                        // Zorg dat destinationID input bestaat
                        let destIdInput = document.getElementById('st-destination-id-input');
                        if (!destIdInput) {
                            destIdInput = document.createElement('input');
                            destIdInput.type = 'hidden';
                            destIdInput.name = 'destinationID';
                            destIdInput.id = 'st-destination-id-input';
                            form.appendChild(destIdInput);
                        }
                        destIdInput.value = urlDestinationID;

                        // Voeg type input toe
                        let typeInput = form.querySelector('input[name="type"]');
                        if (!typeInput) {
                            typeInput = document.createElement('input');
                            typeInput.type = 'hidden';
                            typeInput.name = 'type';
                            form.appendChild(typeInput);
                        }
                        typeInput.value = urlType;

                        // Voeg resort_name toe als die in URL staat
                        if (urlResort) {
                            let resortInput = document.getElementById('st-resort-input');
                            if (!resortInput) {
                                resortInput = document.createElement('input');
                                resortInput.type = 'hidden';
                                resortInput.name = 'resort_name';
                                resortInput.id = 'st-resort-input';
                                form.appendChild(resortInput);
                            }
                            resortInput.value = urlResort;
                        }

                        console.log('‚úÖ Form prepared with all parameters, auto-submitting...');
                        console.log('   - destinationID:', urlDestinationID);
                        console.log('   - type:', urlType);
                        console.log('   - resort_name:', urlResort || 'N/A');
                        console.log('   - country_name:', urlCountry || 'N/A');

                        // AUTO SUBMIT via AJAX
                        setTimeout(function () {
                            console.log('üöÄ AUTO-SUBMIT: Triggering search via submit button click...');
                            const submitBtn = document.getElementById('st-submit-btn');
                            if (submitBtn) {
                                // Click submit button - dit triggert de AJAX handler hierboven
                                submitBtn.click();
                            } else {
                                console.error('‚ùå Submit button not found!');
                            }
                        }, 800); // Delay zodat alle velden geladen zijn
                    }
                }
            } else {
                // üîß FIX: DON'T set default dates - force user to select dates
                // This ensures the "Kies datum voor uw reis" popup appears when needed
                stSearchState.checkinDate = null;
                stSearchState.checkoutDate = null;
                stSearchState.nights = 0;

                document.getElementById('st-checkin-input').value = '';
                document.getElementById('st-checkout-input').value = '';
                document.getElementById('st-date-display').textContent = 'Select dates';

                console.log('üìÖ No default dates - user must select dates');
            }
        });

        // Reset All Fields Function
        function stResetAllFields() {
            console.log('üîÑ Resetting all search fields...');

            // Reset destination
            stSearchState.countries = [];
            document.getElementById('st-destination-display').textContent = 'Kies een land';
            document.getElementById('st-countries-input').value = '';

            // Clear all country checkboxes
            document.querySelectorAll('.st-country-checkbox').forEach(cb => cb.checked = false);

            // Reset dates to defaults (7 days from now + 7 nights)
            const today = new Date();
            today.setDate(today.getDate() + 7);
            const checkinDefault = today.toISOString().split('T')[0];

            const checkout = new Date(today);
            checkout.setDate(checkout.getDate() + 7);
            const checkoutDefault = checkout.toISOString().split('T')[0];

            stSearchState.checkinDate = checkinDefault;
            stSearchState.checkoutDate = checkoutDefault;
            document.getElementById('st-checkin-input').value = checkinDefault;
            document.getElementById('st-checkout-input').value = checkoutDefault;
            stUpdateDateDisplayFromState();

            if (stCheckinPicker) {
                stCheckinPicker.setDate(checkinDefault, false);
            }
            if (stCheckoutPicker) {
                const minCheckout = new Date(checkinDefault);
                minCheckout.setDate(minCheckout.getDate() + 1);
                stCheckoutPicker.set('minDate', minCheckout);
                stCheckoutPicker.setDate(checkoutDefault, false);
            }

            // Reset nights (calculated from date range)
            stSearchState.nights = 7;

            // Reset travelers to defaults (1 room, 2 adults, 0 children)
            stSearchState.rooms = 1;
            stSearchState.adults = 2;
            stSearchState.children = 0;

            document.getElementById('st-rooms-input').value = '1';
            document.getElementById('st-adults-input').value = '2';
            document.getElementById('st-children-input').value = '0';

            document.getElementById('st-rooms-count').textContent = '1';
            document.getElementById('st-adults-count').textContent = '2';
            document.getElementById('st-children-count').textContent = '0';

            document.getElementById('st-travelers-display').textContent = '2 personen op 1 kamer';

            console.log('‚úÖ All fields reset to defaults');
        }

        console.log('üöÄ Header Search Widget loaded');
    </script>

    <!-- Legacy auto-run removed: handled by new universal search system -->

    <?php
}, 999);

/*  
||==========================================================================
|| ‚ö†Ô∏è OUDE VERSIE - VERVANGEN DOOR [shorttrips_destinations_showcase]
||==========================================================================
|| SHORTTRIPS ‚Äì POPULAIRE BESTEMMINGEN PER CONTINENT (TABBED INTERFACE)
|| 
|| Shortcode: [shorttrips_popular_continents limit="4"]
|| 
|| ‚ö†Ô∏è DEPRECATED: Deze shortcode is vervangen door de nieuwe versie
||    met admin panel: [shorttrips_destinations_showcase]
|| 
|| Ga naar: Instellingen ‚Üí Bestemmingen Beheer om bestemmingen te beheren
|| 
|| Deze shortcode blijft werken voor backwards compatibility, maar gebruikt
|| hardcoded land lijsten. Voor volledig beheer, gebruik de nieuwe shortcode.
||==========================================================================
*/
add_shortcode('shorttrips_popular_continents', function ($atts) {
    global $wpdb;

    // Parse attributes
    $atts = shortcode_atts([
        'limit' => 6,
        'show_count' => 'yes'
    ], $atts);

    $limit = intval($atts['limit']);
    $showCount = $atts['show_count'] === 'yes';

    // Continent mapping (name ‚Üí countries)
    $continents = [
        'Europa' => ['Netherlands', 'Germany', 'France', 'Spain', 'Italy', 'Portugal', 'Greece', 'Austria', 'Switzerland', 'Belgium', 'United Kingdom', 'Ireland', 'Norway', 'Sweden', 'Denmark', 'Finland', 'Poland', 'Czech Republic', 'Hungary', 'Croatia', 'Turkey'],
        'Azi√´' => ['Thailand', 'Indonesia', 'Vietnam', 'Malaysia', 'Singapore', 'Philippines', 'Japan', 'China', 'South Korea', 'India', 'Sri Lanka', 'Maldives', 'United Arab Emirates', 'Israel', 'Jordan', 'Taiwan', 'Cambodia', 'Laos', 'Myanmar', 'Nepal'],
        'Amerika' => ['United States', 'Canada', 'Mexico', 'Brazil', 'Argentina', 'Chile', 'Peru', 'Colombia', 'Costa Rica', 'Panama', 'Cuba', 'Jamaica', 'Dominican Republic', 'Bahamas', 'Barbados', 'Trinidad and Tobago'],
        'Afrika' => ['South Africa', 'Kenya', 'Tanzania', 'Morocco', 'Egypt', 'Tunisia', 'Mauritius', 'Seychelles', 'Namibia', 'Botswana', 'Zimbabwe', 'Zambia', 'Madagascar', 'Mozambique'],
        'Oceani√´' => ['Australia', 'New Zealand', 'Fiji', 'French Polynesia', 'New Caledonia', 'Papua New Guinea', 'Vanuatu', 'Samoa', 'Tonga', 'Cook Islands']
    ];

    // Cache key (v3 for 6 countries, 2 rows)
    $cacheKey = 'shorttrips_popular_continents_v3_' . $limit;
    $data = get_transient($cacheKey);

    if ($data === false) {
        $data = [];

        foreach ($continents as $continent => $countries) {
            // Query top countries per continent
            $placeholders = implode(',', array_fill(0, count($countries), '%s'));
            $query = "
                SELECT 
                    bl.name,
                    bl.slug,
                    bl.image_id,
                    COUNT(DISTINCT bh.hotel_id) as hotel_count
                FROM bravo_locations bl
                LEFT JOIN ghwk_bravo_hotels bh ON bl.name = bh.country_name
                WHERE bl.status = 'publish'
                  AND bl.name IN ($placeholders)
                GROUP BY bl.name, bl.slug, bl.image_id
                HAVING hotel_count > 0
                ORDER BY hotel_count DESC
                LIMIT %d
            ";

            $params = array_merge($countries, [$limit]);
            $results = $wpdb->get_results($wpdb->prepare($query, $params), ARRAY_A);

            $data[$continent] = $results;
        }

        // Cache for 6 hours
        set_transient($cacheKey, $data, 6 * HOUR_IN_SECONDS);
    }

    // Pre-fetch country images - use cached images from the countries we're showing
    $countryImages = [];

    // Start output buffering
    ob_start();
    ?>

    <style>
        .st-continents-section {
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .st-continents-title {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 32px;
            color: #111827;
        }

        .st-continent-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .st-continent-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            margin-bottom: -2px;
        }

        .st-continent-tab:hover {
            color: #0055A5;
            background: #f0f9ff;
        }

        .st-continent-tab.active {
            color: #0055A5;
            border-bottom-color: #0055A5;
            background: #f0f9ff;
        }

        .st-continent-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .st-continent-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .st-countries-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-top: 20px;
        }

        .st-country-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            height: 380px;
            background: white;
        }

        .st-country-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        }

        .st-country-image-wrapper {
            position: relative;
            height: 280px;
            overflow: hidden;
        }

        .st-country-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .st-country-card:hover .st-country-image {
            transform: scale(1.08);
        }

        .st-country-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 2;
        }

        .st-country-info {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            background: white;
        }

        .st-country-name {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            color: #111827;
            transition: color 0.3s ease;
            text-align: center;
        }

        .st-country-name::before {
            content: 'üìç ';
        }

        .st-country-card:hover .st-country-name {
            color: #667eea;
        }

        .st-country-count {
            display: none;
        }

        @media (max-width: 768px) {
            .st-continents-title {
                font-size: 24px;
            }

            .st-continent-tabs {
                gap: 8px;
            }

            .st-continent-tab {
                padding: 10px 16px;
                font-size: 14px;
            }

            .st-countries-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .st-country-card {
                height: 320px;
            }

            .st-country-image-wrapper {
                height: 220px;
            }

            .st-country-name {
                font-size: 24px;
            }

            .st-country-badge {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>

    <div class="st-continents-section">
        <h2 class="st-continents-title">üåç Find populair destinations worldwide</h2>
        <p class="st-continents-subtitle">Choose your favorite continent and start your journey</p>

        <!-- Continent Tabs -->
        <div class="st-continent-tabs">
            <?php
            $first = true;
            foreach ($data as $continent => $countries):
                ?>
                <button class="st-continent-tab <?php echo $first ? 'active' : ''; ?>"
                    onclick="stSwitchContinent(event, '<?php echo esc_attr($continent); ?>')">
                    <?php
                    $flags = [
                        'Europa' => 'üá™üá∫',
                        'Azi√´' => 'üåè',
                        'Amerika' => 'üåé',
                        'Afrika' => 'üåç',
                        'Oceani√´' => 'üåä'
                    ];
                    echo $flags[$continent] . ' ' . esc_html($continent);
                    ?>
                </button>
                <?php
                $first = false;
            endforeach;
            ?>
        </div>

        <!-- Continent Content -->
        <?php
        $first = true;
        foreach ($data as $continent => $countries):
            ?>
            <div class="st-continent-content <?php echo $first ? 'active' : ''; ?>"
                id="continent-<?php echo esc_attr($continent); ?>">
                <div class="st-countries-grid">
                    <?php foreach ($countries as $country):
                        // Get country image
                        $imageUrl = '';

                        // Try WordPress media library
                        if (!empty($country['image_id'])) {
                            $imageUrl = wp_get_attachment_image_url($country['image_id'], 'large');
                        }

                        // Fallback: Get ONE hotel image from database (simple, fast query)
                        if (!$imageUrl) {
                            if (!isset($countryImages[$country['name']])) {
                                global $wpdb;
                                $countryImages[$country['name']] = $wpdb->get_var($wpdb->prepare(
                                    "SELECT image FROM ghwk_bravo_hotels 
                                     WHERE country_name = %s AND image IS NOT NULL AND image != '' 
                                     LIMIT 1",
                                    $country['name']
                                ));
                            }
                            if ($countryImages[$country['name']]) {
                                $imageUrl = $countryImages[$country['name']];
                            }
                        }

                        // Final fallback: placeholder
                        if (!$imageUrl) {
                            $imageUrl = 'https://via.placeholder.com/600x400/667eea/ffffff?text=' . urlencode($country['name']);
                        }

                        // üîß CRITICAL: Get first destination_id for this country (needed for API)
                        // Try exact match first
                        $firstDestinationId = $wpdb->get_var($wpdb->prepare(
                            "SELECT bd.destination_id 
                             FROM bravo_destinations bd
                             WHERE bd.country_name = %s
                               AND bd.destination_id IS NOT NULL
                               AND bd.deleted_at IS NULL
                             ORDER BY bd.destination_id ASC
                             LIMIT 1",
                            $country['name']
                        ));

                        // Fallback: Try LIKE match if exact match failed
                        if (!$firstDestinationId) {
                            $firstDestinationId = $wpdb->get_var($wpdb->prepare(
                                "SELECT bd.destination_id 
                                 FROM bravo_destinations bd
                                 WHERE bd.country_name LIKE %s
                                   AND bd.destination_id IS NOT NULL
                                   AND bd.deleted_at IS NULL
                                 ORDER BY bd.destination_id ASC
                                 LIMIT 1",
                                '%' . $wpdb->esc_like($country['name']) . '%'
                            ));
                        }

                        // Build search URL with type=country AND destinationID
                        $searchParams = [
                            'type' => 'country',
                            'country_name' => $country['name'],
                            'checkin' => date('Y-m-d', strtotime('+7 days')),
                            'checkout' => date('Y-m-d', strtotime('+14 days')),
                            'nights' => 7,
                            'rooms' => 1,
                            'adults' => 2,
                            'children' => 0
                        ];

                        // ‚úÖ Add destinationID if found (CRITICAL for SearchV3 API)
                        if ($firstDestinationId) {
                            $searchParams['destinationID'] = $firstDestinationId;
                        } else {
                            // DEBUG: Log when NO destination_id found
                            if (defined('WP_DEBUG') && WP_DEBUG) {
                                error_log("‚ö†Ô∏è NO destination_id found for country: {$country['name']}");
                            }
                        }

                        $searchUrl = add_query_arg($searchParams, shorttrips_get_hotels_page_url());
                        ?>
                        <a href="<?php echo esc_url($searchUrl); ?>" class="st-country-card">
                            <div class="st-country-image-wrapper">
                                <img src="<?php echo esc_url($imageUrl); ?>" alt="<?php echo esc_attr($country['name']); ?>"
                                    class="st-country-image" loading="lazy" />
                                <?php if ($showCount): ?>
                                    <div class="st-country-badge">
                                        <?php echo number_format($country['hotel_count']); ?> Hotels
                                    </div>
                                <?php endif; ?>
                            </div>
                            <div class="st-country-info">
                                <h3 class="st-country-name"><?php echo esc_html($country['name']); ?></h3>
                            </div>
                        </a>
                    <?php endforeach; ?>

                    <?php if (empty($countries)): ?>
                        <p style="grid-column: 1/-1; text-align:center; color:#6b7280; padding:40px 0;">
                            Geen populaire bestemmingen beschikbaar voor <?php echo esc_html($continent); ?>
                        </p>
                    <?php endif; ?>
                </div>
            </div>
            <?php
            $first = false;
        endforeach;
        ?>
    </div>

    <script>
        function stSwitchContinent(event, continent) {
            // Remove active class from all tabs
            document.querySelectorAll('.st-continent-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Hide all content
            document.querySelectorAll('.st-continent-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected content
            document.getElementById('continent-' + continent).classList.add('active');
        }
    </script>

    <?php
    return ob_get_clean();
});

// =============================================================================
// CUSTOM LANGUAGE SWITCHER WIDGET FOR POLYLANG
// =============================================================================
// Displays a beautifully styled language switcher in the sidebar
// Compatible with Polylang plugin
// =============================================================================

add_action('widgets_init', function () {
    register_widget('Shorttrips_Language_Switcher_Widget');
});

class Shorttrips_Language_Switcher_Widget extends WP_Widget
{

    function __construct()
    {
        parent::__construct(
            'shorttrips_language_switcher',
            'üåê Language Switcher (Shorttrips)',
            ['description' => 'Taal switcher voor Polylang met custom styling']
        );
    }

    public function widget($args, $instance)
    {
        if (!function_exists('pll_the_languages')) {
            return; // Polylang not active
        }

        echo $args['before_widget'];

        if (!empty($instance['title'])) {
            echo $args['before_title'] . apply_filters('widget_title', $instance['title']) . $args['after_title'];
        }

        // Get ALL languages, including those without translations
        $languages = pll_the_languages([
            'raw' => 1,
            'hide_if_empty' => 0,  // Show all languages, even without translations
            'show_flags' => 1,
            'show_names' => 1
        ]);

        // Debug: log what we get
        if (defined('WP_DEBUG') && WP_DEBUG && empty($languages)) {
            error_log('üåê Widget: pll_the_languages returned empty!');
        }

        if (!empty($languages)) {
            $current_lang = '';
            foreach ($languages as $lang) {
                if ($lang['current_lang']) {
                    $current_lang = $lang['slug'];
                    break;
                }
            }

            // üîç Preserve current search parameters
            $preserve_params = ['destination_id', 'country_name', 'resort_name', 'checkin', 'checkout', 'rooms', 'adults', 'children', 'type'];
            $current_params = [];
            foreach ($preserve_params as $param) {
                if (isset($_GET[$param]) && !empty($_GET[$param])) {
                    $current_params[$param] = sanitize_text_field($_GET[$param]);
                }
            }

            echo '<div class="st-language-switcher" style="padding:16px;">';
            echo '<style>
                .st-lang-dropdown {
                    width: 100%;
                    padding: 14px 16px;
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    font-size: 15px;
                    font-weight: 500;
                    color: #374151;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    appearance: none;
                    background-image: url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'12\' viewBox=\'0 0 12 12\'%3E%3Cpath fill=\'%23374151\' d=\'M6 9L1 4h10z\'/%3E%3C/svg%3E");
                    background-repeat: no-repeat;
                    background-position: right 12px center;
                    padding-right: 36px;
                    line-height: 1.6;
                    min-height: 48px;
                }
                .st-lang-dropdown:hover {
                    border-color: #2563eb;
                    box-shadow: 0 2px 8px rgba(37,99,235,0.15);
                }
                .st-lang-dropdown:focus {
                    outline: none;
                    border-color: #2563eb;
                    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
                }
                .st-lang-dropdown option {
                    padding: 12px;
                    font-size: 15px;
                    line-height: 1.8;
                }
                .st-language-switcher {
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
            </style>';

            echo '<select class="st-lang-dropdown" onchange="if(this.value) window.location.href=this.value;">';

            foreach ($languages as $lang) {
                $selected = $lang['current_lang'] ? 'selected' : '';
                $flag_emoji = '';

                // Add flag emoji based on language code
                $flag_map = [
                    'nl' => 'üá≥üá±',
                    'en' => 'üá¨üáß',
                    'de' => 'üá©üá™',
                    'fr' => 'üá´üá∑',
                    'es' => 'üá™üá∏',
                    'it' => 'üáÆüáπ',
                    'pt' => 'üáµüáπ',
                    'ru' => 'üá∑üá∫',
                    'pl' => 'üáµüá±',
                    'tr' => 'üáπüá∑',
                    'sv' => 'üá∏üá™',
                    'da' => 'üá©üá∞',
                    'no' => 'üá≥üá¥',
                    'fi' => 'üá´üáÆ',
                ];

                if (isset($flag_map[$lang['slug']])) {
                    $flag_emoji = $flag_map[$lang['slug']] . ' ';
                }

                // üîó Append search parameters to language URL
                $lang_url = $lang['url'];
                if (!empty($current_params)) {
                    $separator = (strpos($lang_url, '?') !== false) ? '&' : '?';
                    $lang_url .= $separator . http_build_query($current_params);
                }

                echo '<option value="' . esc_url($lang_url) . '" ' . $selected . '>';
                echo $flag_emoji . esc_html($lang['name']);
                echo '</option>';
            }

            echo '</select>';
            echo '</div>';
        }

        echo $args['after_widget'];
    }

    public function form($instance)
    {
        $title = !empty($instance['title']) ? $instance['title'] : 'üåê Taal / Language';
        ?>
        <p>
            <label for="<?php echo $this->get_field_id('title'); ?>">Widget Title:</label>
            <input class="widefat" id="<?php echo $this->get_field_id('title'); ?>"
                name="<?php echo $this->get_field_name('title'); ?>" type="text" value="<?php echo esc_attr($title); ?>"
                placeholder="üåê Taal / Language">
        </p>
        <p class="description">
            Dit werkt alleen als Polylang is ge√Ønstalleerd en talen zijn geconfigureerd in Settings ‚Üí Languages.
        </p>
        <?php
    }

    public function update($new_instance, $old_instance)
    {
        $instance = [];
        $instance['title'] = (!empty($new_instance['title'])) ? strip_tags($new_instance['title']) : '';
        return $instance;
    }
}

/*
||==========================================================================
|| SHORTCODE: Super Deals
||==========================================================================
|| Displays hotels with super deals from SunHotels API
|| Usage: [shorttrips_super_deals limit="6"]
||==========================================================================
*/
add_shortcode('shorttrips_super_deals', function ($atts) {
    // Parse attributes
    $atts = shortcode_atts([
        'limit' => 6,
        'cache_hours' => 6
    ], $atts);

    $limit = intval($atts['limit']);
    $cacheKey = 'shorttrips_super_deals_' . $limit;

    // Try to get cached data
    $deals = get_transient($cacheKey);

    if ($deals === false) {
        // Prepare API call to SunHotels
        $endpoint = 'https://xml.sunhotels.net/15/WebService.asmx';

        // Fixed date for testing super deals
        $checkin = '2026-03-01';
        $checkout = '2026-03-31';

        $soapBody = '<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
               xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
               xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <GetHotelsAndPrices xmlns="http://xml.sunhotels.net/15/">
      <Login>
        <CompanyID>GHWK</CompanyID>
        <UserName>shorttrips</UserName>
        <Password>Naxos12345!</Password>
      </Login>
      <SearchCriteria>
        <ArrivalDate>' . $checkin . '</ArrivalDate>
        <Nights>30</Nights>
        <Rooms>
          <RoomType>
            <NumberOfAdults>2</NumberOfAdults>
            <ChildAge />
          </RoomType>
        </Rooms>
        <Nationality>NL</Nationality>
      </SearchCriteria>
      <Language>nl</Language>
      <OutputFields>
        <IsSuperDeal>1</IsSuperDeal>
        <B2C>1</B2C>
      </OutputFields>
    </GetHotelsAndPrices>
  </soap:Body>
</soap:Envelope>';

        $resp = wp_remote_post($endpoint, [
            'headers' => [
                'Content-Type' => 'text/xml; charset=utf-8',
                'SOAPAction' => '"http://xml.sunhotels.net/15/GetHotelsAndPrices"'
            ],
            'body' => $soapBody,
            'timeout' => 60
        ]);

        $deals = [];

        if (!is_wp_error($resp) && !empty($resp['body'])) {
            $xml = @simplexml_load_string($resp['body']);
            if ($xml) {
                $xml->registerXPathNamespace('soap', 'http://schemas.xmlsoap.org/soap/envelope/');
                $xml->registerXPathNamespace('sh', 'http://xml.sunhotels.net/15/');

                $hotels = $xml->xpath('//soap:Body//sh:getHotelsAndPricesResult//sh:hotel');

                if ($hotels) {
                    foreach ($hotels as $hotel) {
                        // Include all hotels (testing with B2C=1)
                        // $isSuperDeal = isset($hotel->isSuperDeal) && (string)$hotel->isSuperDeal === 'true';

                        if (true) {
                            $hotelId = (string) $hotel->hotelID;
                            $price = (float) $hotel->minPrice;
                            $oldPrice = !empty($hotel->originalPrice) ? (float) $hotel->originalPrice : $price * 1.3;
                            $discount = round((($oldPrice - $price) / $oldPrice) * 100);

                            $deals[] = [
                                'id' => $hotelId,
                                'name' => (string) $hotel->hotelname,
                                'resort' => (string) $hotel->resort,
                                'country' => (string) $hotel->country,
                                'stars' => (int) $hotel->category,
                                'price' => $price,
                                'old_price' => $oldPrice,
                                'discount' => $discount,
                                'image' => (string) $hotel->main_image,
                                'checkin' => $checkin,
                                'checkout' => $checkout
                            ];

                            if (count($deals) >= $limit)
                                break;
                        }
                    }
                }
            }
        }

        // Cache for specified hours
        if (!empty($deals)) {
            set_transient($cacheKey, $deals, intval($atts['cache_hours']) * HOUR_IN_SECONDS);
        }
    }

    // Start output
    ob_start();
    ?>

    <style>
        .st-superdeals-section {
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
        }

        .st-superdeals-title {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 32px;
            color: #111827;
        }

        .st-superdeals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .st-superdeal-card {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            height: 380px;
            background: white;
        }

        .st-superdeal-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        }

        .st-superdeal-image-wrapper {
            position: relative;
            height: 280px;
            overflow: hidden;
        }

        .st-superdeal-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .st-superdeal-card:hover .st-superdeal-image {
            transform: scale(1.08);
        }

        .st-superdeal-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .st-superdeal-info {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            background: white;
        }

        .st-superdeal-name {
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 4px 0;
            color: #111827;
            transition: color 0.3s ease;
            text-align: center;
        }

        .st-superdeal-name::before {
            content: 'üìç ';
        }

        .st-superdeal-location {
            font-size: 14px;
            color: #6b7280;
            margin: 0 0 8px 0;
            text-align: center;
        }

        .st-superdeal-price {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin: 0;
        }

        .st-superdeal-card:hover .st-superdeal-name {
            color: #667eea;
        }

        @media (max-width: 768px) {
            .st-superdeals-title {
                font-size: 24px;
            }

            .st-superdeals-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .st-superdeal-card {
                height: 320px;
            }

            .st-superdeal-image-wrapper {
                height: 220px;
            }

            .st-superdeal-name {
                font-size: 18px;
            }

            .st-superdeal-badge {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>

    <div class="st-superdeals-section">
        <h2 class="st-superdeals-title">üî• Super Deals - Exclusieve Aanbiedingen</h2>

        <?php if (!empty($deals)): ?>
            <div class="st-superdeals-grid">
                <?php foreach ($deals as $deal):
                    // Build hotel detail URL
                    $hotelUrl = home_url('/hotel/') . $deal['id'] . '/?checkin=' . $deal['checkin'] . '&checkout=' . $deal['checkout'] . '&rooms=1&adults=2&children=0';
                    ?>
                    <a href="<?php echo esc_url($hotelUrl); ?>" class="st-superdeal-card">
                        <div class="st-superdeal-image-wrapper">
                            <img src="<?php echo esc_url($deal['image']); ?>" alt="<?php echo esc_attr($deal['name']); ?>"
                                class="st-superdeal-image" loading="lazy" />
                            <?php if ($deal['discount'] > 0): ?>
                                <div class="st-superdeal-badge">
                                    -<?php echo $deal['discount']; ?>%
                                </div>
                            <?php endif; ?>
                        </div>
                        <div class="st-superdeal-info">
                            <h3 class="st-superdeal-name"><?php echo esc_html($deal['name']); ?></h3>
                            <p class="st-superdeal-location">
                                <?php echo esc_html($deal['resort']); ?>, <?php echo esc_html($deal['country']); ?>
                            </p>
                            <p class="st-superdeal-price">
                                ‚Ç¨<?php echo number_format($deal['price'], 2); ?>
                            </p>
                        </div>
                    </a>
                <?php endforeach; ?>
            </div>
        <?php else: ?>
            <p style="text-align: center; color: #6b7280; padding: 40px 0;">
                Momenteel zijn er geen super deals beschikbaar. Probeer het later opnieuw.
            </p>
        <?php endif; ?>
    </div>

    <?php
    return ob_get_clean();
});

/*  
||==========================================================================
|| SHORTTRIPS ‚Äì WELCOME IMPRESSION POPUP + CACHE PRELOADER
|| 
|| Shows an engaging welcome popup on first visit with:
|| - Beautiful impression photos
|| - Marketing copy to engage visitors
|| - Meanwhile: Preloads critical cache (countries, popular destinations)
|| 
|| Benefits:
|| 1. Engages users immediately with stunning visuals
|| 2. Builds anticipation and curiosity
|| 3. Gives time for cache to warm up (countries & cities load faster)
|| 4. Reduces perceived wait time on first search
||==========================================================================
*/

add_action('wp_footer', function () {
    // Show on all pages (needed for banner button trigger)
    // Auto-show only happens on first visit to homepage

    // Debug log to verify this action is being called
    // error_log('üéÅ Welcome popup wp_footer action called on: ' . $_SERVER['REQUEST_URI']);

    ?>
    <style>
        /* Welcome Impression Popup */
        #st-welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        #st-welcome-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: slideUp 0.6s ease-out 0.3s both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #st-welcome-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #st-welcome-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .st-welcome-slideshow {
            position: relative;
            height: 400px;
            overflow: hidden;
        }

        .st-welcome-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            text-align: center;
            color: white;
        }

        .st-welcome-slide.active {
            opacity: 1;
        }

        .st-welcome-slide-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* Voucher form input styling */
        .st-voucher-slide input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .st-voucher-slide input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.15);
        }

        .st-welcome-slide h2 {
            font-size: 36px;
            font-weight: 700;
            margin: 0 0 16px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .st-welcome-slide p {
            font-size: 18px;
            line-height: 1.6;
            margin: 0;
            max-width: 600px;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }

        .st-welcome-cta {
            background: white;
            padding: 30px;
            text-align: center;
        }

        .st-welcome-cta-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .st-welcome-cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .st-welcome-progress {
            display: flex;
            gap: 8px;
            justify-content: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
        }

        .st-progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
        }

        .st-progress-dot.active {
            background: white;
            width: 30px;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            #st-welcome-modal {
                width: 95%;
                max-width: 100%;
            }

            .st-welcome-slideshow {
                height: 350px;
            }

            .st-welcome-slide h2 {
                font-size: 28px;
            }

            .st-welcome-slide p {
                font-size: 16px;
            }

            .st-welcome-slide-icon {
                font-size: 60px;
            }
        }
    </style>

    <div id="st-welcome-overlay" style="display: none;">
        <div id="st-welcome-modal">
            <button id="st-welcome-close" aria-label="Sluiten">√ó</button>

            <div class="st-welcome-slideshow">
                <!-- SLIDE 1: Ontdek de Wereld -->
                <div class="st-welcome-slide active" data-slide="0">
                    <div class="st-welcome-slide-icon">üåç</div>
                    <h2>Ontdek de Wereld</h2>
                    <p>Van bruisende steden tot paradijselijke stranden. Duizenden hotels wereldwijd wachten op je. Waar
                        breng jij je volgende vakantie door?</p>
                </div>

                <!-- SLIDE 2: Exclusieve Deals -->
                <div class="st-welcome-slide" data-slide="1">
                    <div class="st-welcome-slide-icon">üíé</div>
                    <h2>Exclusieve Deals</h2>
                    <p>Profiteer van onze speciale aanbiedingen en last-minute deals. Luxe hotels voor een fractie van de
                        prijs. Jouw droomvakantie is dichterbij dan je denkt!</p>
                </div>

                <!-- SLIDE 3: Direct Beschikbaar -->
                <div class="st-welcome-slide" data-slide="2">
                    <div class="st-welcome-slide-icon">‚ö°</div>
                    <h2>Direct Beschikbaar</h2>
                    <p>Real-time beschikbaarheid van duizenden hotels. Boek vandaag nog en vertrek morgen. Spontane trips
                        waren nog nooit zo makkelijk!</p>
                </div>

                <!-- SLIDE 4: Jouw Perfecte Match -->
                <div class="st-welcome-slide" data-slide="3">
                    <div class="st-welcome-slide-icon">üéØ</div>
                    <h2>Jouw Perfecte Match</h2>
                    <p>Filter op locatie, prijs, faciliteiten en meer. Vind precies het hotel dat bij jou past. Van
                        budget-friendly tot ultieme luxe.</p>
                </div>
            </div>

            <div class="st-welcome-progress">
                <div class="st-progress-dot active" data-dot="0"></div>
                <div class="st-progress-dot" data-dot="1"></div>
                <div class="st-progress-dot" data-dot="2"></div>
                <div class="st-progress-dot" data-dot="3"></div>
            </div>

            <div class="st-welcome-cta">
                <button class="st-welcome-cta-button" id="st-welcome-start">
                    üîç Start searching
                </button>
            </div>
        </div>
    </div>

    <script>
        try {
            console.log('üéÅ Welcome popup script loading...');

            (function () {
                console.log('üéÅ Welcome popup IIFE started');

                // Storage keys
                const STORAGE_KEY = 'st_welcome_seen';
                const CACHE_PRELOAD_KEY = 'st_cache_preloaded';

                // ========================================
                // üé¨ SLIDESHOW LOGIC - Always initialized
                // ========================================
                let currentSlide = 0;
                let slideInterval = null;

                function initSlideshow() {
                    const slides = document.querySelectorAll('.st-welcome-slide');
                    const dots = document.querySelectorAll('.st-progress-dot');
                    const totalSlides = slides.length;

                    if (slides.length === 0) {
                        console.warn('‚ö†Ô∏è No slides found');
                        return;
                    }

                    // Reset to first slide
                    currentSlide = 0;

                    function showSlide(index) {
                        slides.forEach(s => s.classList.remove('active'));
                        dots.forEach(d => d.classList.remove('active'));

                        slides[index].classList.add('active');
                        dots[index].classList.add('active');
                    }

                    function nextSlide() {
                        currentSlide = (currentSlide + 1) % totalSlides;
                        showSlide(currentSlide);
                    }

                    // Clear any existing interval
                    if (slideInterval) clearInterval(slideInterval);

                    // Auto-advance slides every 3 seconds
                    slideInterval = setInterval(nextSlide, 3000);

                    // Show first slide
                    showSlide(0);

                    // Manual dot navigation (remove old listeners first)
                    dots.forEach((dot, index) => {
                        // Remove old listeners by cloning
                        const newDot = dot.cloneNode(true);
                        dot.parentNode.replaceChild(newDot, dot);

                        newDot.addEventListener('click', function () {
                            if (slideInterval) clearInterval(slideInterval);
                            currentSlide = index;
                            showSlide(currentSlide);
                        });
                    });

                    console.log('‚úÖ Slideshow initialized: ' + totalSlides + ' slides');
                }

                // Global function for skipping voucher slide
                window.stNextSlide = function () {
                    if (slideInterval) clearInterval(slideInterval);
                    currentSlide = (currentSlide + 1) % document.querySelectorAll('.st-welcome-slide').length;
                    const slides = document.querySelectorAll('.st-welcome-slide');
                    const dots = document.querySelectorAll('.st-progress-dot');
                    slides.forEach(s => s.classList.remove('active'));
                    dots.forEach(d => d.classList.remove('active'));
                    slides[currentSlide].classList.add('active');
                    dots[currentSlide].classList.add('active');
                };

                // ========================================
                // üéØ EVENT LISTENERS - Always active
                // ========================================
                document.addEventListener('DOMContentLoaded', function () {
                    const overlay = document.getElementById('st-welcome-overlay');
                    const modal = document.getElementById('st-welcome-modal');
                    const closeBtn = document.getElementById('st-welcome-close');
                    const startBtn = document.getElementById('st-welcome-start');
                    const voucherForm = document.getElementById('st-voucher-registration-form');

                    if (!overlay) {
                        console.warn('‚ö†Ô∏è Welcome popup overlay not found');
                        return;
                    }

                    // Close popup function
                    function closeWelcome() {
                        overlay.style.opacity = '0';
                        setTimeout(function () {
                            overlay.style.display = 'none';
                        }, 300);

                        // Mark as seen
                        localStorage.setItem(STORAGE_KEY, 'true');

                        if (slideInterval) clearInterval(slideInterval);
                    }

                    // Close button
                    if (closeBtn) {
                        closeBtn.addEventListener('click', closeWelcome);
                    }

                    // Start button
                    if (startBtn) {
                        startBtn.addEventListener('click', function () {
                            closeWelcome();

                            // Scroll to search form
                            const searchForm = document.getElementById('st-search-form');
                            if (searchForm) {
                                searchForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        });
                    }

                    // Close on overlay click (outside modal)
                    overlay.addEventListener('click', function (e) {
                        if (e.target === overlay) {
                            closeWelcome();
                        }
                    });

                    // Close on ESC key
                    document.addEventListener('keydown', function (e) {
                        if (e.key === 'Escape' && overlay.style.display === 'flex') {
                            closeWelcome();
                        }
                    });

                    // Voucher form submission
                    if (voucherForm) {
                        voucherForm.addEventListener('submit', function (e) {
                            e.preventDefault();

                            const name = document.getElementById('st-voucher-name').value;
                            const email = document.getElementById('st-voucher-email').value;

                            console.log('üìß Voucher registration:', { name, email });

                            // TODO: Send to server via AJAX
                            // Show success message
                            const form = e.target;
                            form.innerHTML = '<div style="text-align:center;"><div style="font-size:60px;margin-bottom:16px;">‚úÖ</div><h3 style="margin:0 0 8px 0;">Gelukt!</h3><p style="font-size:16px;opacity:0.9;">Check je email voor je voucher code!</p></div>';

                            // Auto-advance to next slide after 2 seconds
                            setTimeout(window.stNextSlide, 2000);
                        });
                    }

                    // ========================================
                    // üöÄ AUTO-SHOW on first visit (only on homepage)
                    // ========================================
                    const hasSeenWelcome = localStorage.getItem(STORAGE_KEY);
                    const isHomepage = window.location.pathname === '/' || window.location.pathname === '/en/';

                    if (!hasSeenWelcome && isHomepage) {
                        console.log('üéÅ First visit on homepage - showing welcome popup...');
                        setTimeout(function () {
                            overlay.style.display = 'flex';
                            initSlideshow();
                        }, 500);
                    } else if (!isHomepage) {
                        console.log('‚ÑπÔ∏è Not homepage - popup available via banner button');
                    } else {
                        console.log('‚úÖ Welcome popup already seen');
                    }

                    // ========================================
                    // üöÄ CACHE PRELOADER - Runs in background
                    // ========================================
                    const ajaxurl = '<?php echo admin_url('admin-ajax.php'); ?>';
                    const cachePreloaded = sessionStorage.getItem(CACHE_PRELOAD_KEY);

                    if (cachePreloaded) {
                        console.log('‚úÖ Cache already preloaded this session');
                    } else {
                        console.log('üöÄ Starting cache preload...');
                    }

                    // Preload popular countries (top 10)
                    const popularCountries = [
                        'Spain', 'Italy', 'Greece', 'Portugal', 'France',
                        'Turkey', 'Croatia', 'Netherlands', 'Germany', 'Austria'
                    ];

                    let preloadCount = 0;
                    const totalPreloads = popularCountries.length;

                    // Preload function with staggered timing
                    function preloadCountryCache(country, delay) {
                        setTimeout(function () {
                            fetch(ajaxurl + '?action=shorttrips_get_resorts_by_country&country=' + encodeURIComponent(country))
                                .then(r => r.json())
                                .then(data => {
                                    if (data.success) {
                                        preloadCount++;
                                        const resortCount = data.data.resorts ? data.data.resorts.length : 0;
                                        console.log('‚úÖ Preloaded ' + country + ': ' + resortCount + ' cities (' + preloadCount + '/' + totalPreloads + ')');

                                        // Mark as complete when all done
                                        if (preloadCount === totalPreloads) {
                                            sessionStorage.setItem(CACHE_PRELOAD_KEY, 'true');
                                            console.log('üéâ Cache preload COMPLETE! All searches will be faster now.');
                                        }
                                    }
                                })
                                .catch(err => {
                                    console.warn('‚ö†Ô∏è Failed to preload ' + country, err);
                                });
                        }, delay);
                    }

                    // Stagger requests to avoid server overload (500ms between each)
                    popularCountries.forEach((country, index) => {
                        preloadCountryCache(country, index * 500);
                    });

                    // Also preload popular destinations cache
                    setTimeout(function () {
                        fetch(ajaxurl + '?action=shorttrips_get_popular_destinations')
                            .then(r => r.json())
                            .then(data => {
                                console.log('‚úÖ Preloaded popular destinations cache');
                            })
                            .catch(err => {
                                console.warn('‚ö†Ô∏è Failed to preload popular destinations', err);
                            });
                    }, 1000);

                });
                // ========================================
                // üîó GLOBAL FUNCTION + TRIGGERS
                // ========================================

                // Global function to open popup manually (voor banner button)
                window.stOpenWelcomePopup = function () {
                    const overlay = document.getElementById('st-welcome-overlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                        overlay.style.opacity = '1';
                        initSlideshow(); // Start slideshow
                        console.log('üéÅ Welcome popup manually opened');
                    } else {
                        console.warn('‚ö†Ô∏è Welcome popup not found in DOM');
                    }
                };

                // Event delegation for popup triggers
                document.body.addEventListener('click', function (e) {
                    const target = e.target.closest('.st-open-welcome, [href="#welcome"], [href="#freestays-welcome"]');

                    if (target) {
                        e.preventDefault();
                        console.log('üéÅ Welcome popup trigger clicked:', target);
                        window.stOpenWelcomePopup();
                    }
                });

                console.log('‚úÖ Welcome popup ready - triggers active');
            });
        }) ();
        } catch (err) {
            console.error('‚ùå Welcome popup error:', err);
        }
    </script>
    <?php
}, 1); // Priority 1 = load EARLY in footer

/**
 * FALLBACK: Simpele onclick trigger voor welcome popup
 * Als de complexe event delegation niet werkt, gebruik deze
 */
add_action('wp_footer', function () {
    ?>
    <script>
        // Ultra-simpele fallback trigger
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üîß Fallback popup trigger loaded');

            // Simpele slideshow functie
            function startSlideshow() {
                var slides = document.querySelectorAll('.st-welcome-slide');
                var dots = document.querySelectorAll('.st-progress-dot');
                var currentSlide = 0;

                if (slides.length === 0) return;

                // Toon eerste slide
                slides[0].classList.add('active');
                dots[0].classList.add('active');

                // Auto-advance elke 3 seconden
                setInterval(function () {
                    slides[currentSlide].classList.remove('active');
                    dots[currentSlide].classList.remove('active');

                    currentSlide = (currentSlide + 1) % slides.length;

                    slides[currentSlide].classList.add('active');
                    dots[currentSlide].classList.add('active');
                }, 3000);

                console.log('‚úÖ Slideshow started: ' + slides.length + ' slides');
            }

            // Close functie
            function closePopup() {
                var popup = document.getElementById('st-welcome-overlay');
                if (popup) {
                    popup.style.opacity = '0';
                    setTimeout(function () {
                        popup.style.display = 'none';
                    }, 300);
                }
            }

            // Event listeners voor buttons
            var closeBtn = document.getElementById('st-welcome-close');
            var startBtn = document.getElementById('st-welcome-start');

            // Trigger voucher popup na sluiten welcome popup (alleen op eerste bezoek)
            function closePopupAndShowVoucher() {
                closePopup();

                // Trigger voucher popup na korte delay
                setTimeout(function () {
                    var voucherPopup = document.getElementById('fs-welcome');
                    if (voucherPopup) {
                        voucherPopup.style.display = 'flex';
                        console.log('üéÅ Voucher popup triggered');
                    } else {
                        console.warn('‚ö†Ô∏è Voucher popup #fs-welcome not found');
                    }
                }, 500);
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', function () {
                    var isFirstVisit = !localStorage.getItem('st_welcome_seen');
                    if (isFirstVisit) {
                        closePopupAndShowVoucher();
                    } else {
                        closePopup();
                    }
                });
            }

            if (startBtn) {
                startBtn.addEventListener('click', function () {
                    var isFirstVisit = !localStorage.getItem('st_welcome_seen');
                    if (isFirstVisit) {
                        closePopupAndShowVoucher();
                    } else {
                        closePopup();
                    }

                    var searchForm = document.getElementById('st-search-form');
                    if (searchForm) {
                        searchForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }

            // Simpele onclick handler voor links met #welcome
            document.addEventListener('click', function (e) {
                var link = e.target.closest('a[href*="#welcome"]');
                if (link) {
                    e.preventDefault();
                    console.log('üéØ Fallback trigger clicked!');

                    var popup = document.getElementById('st-welcome-overlay');
                    if (popup) {
                        popup.style.display = 'flex';
                        popup.style.opacity = '1';
                        startSlideshow();
                        console.log('‚úÖ Popup opened via fallback');
                    } else {
                        console.warn('‚ùå Popup element not found');
                    }
                }
            });
        });
    </script>
    <?php
}, 999); // Priority 999 = load LATE, after everything else

/**
 * Auto-load voucher popup in footer (homepage only)
 */
add_action('wp_footer', function () {
    // Only on homepage and only for non-logged-in users
    if (!is_front_page() || is_user_logged_in()) {
        return;
    }

    // Output voucher popup HTML
    echo do_shortcode('[freestays_welcome_popup]');
}, 2); // Priority 2 = load early, after welcome popup

/*--------------------------------------------------------------------------
| UNIVERSAL SEARCH - SHARED JAVASCRIPT FUNCTION
|--------------------------------------------------------------------------
| Reusable autocomplete search functionality for homepage and hotels page
| MUST load in wp_head to be available BEFORE shortcodes are rendered
|--------------------------------------------------------------------------
*/
add_action('wp_head', function () {
    ?>
    <style>
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .st-autocomplete-dropdown::-webkit-scrollbar {
            width: 8px;
        }

        .st-autocomplete-dropdown::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }

        .st-autocomplete-dropdown::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .st-autocomplete-dropdown::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>

    <script>
        function initUniversalSearch(inputId, dropdownId, wrapperIdParam, clearBtnId, loadingId) {
            var universalInput = document.getElementById(inputId);
            var resultsDropdown = document.getElementById(dropdownId);
            var searchInputWrapper = document.getElementById(wrapperIdParam);
            var clearBtn = document.getElementById(clearBtnId);
            var loadingIndicator = document.getElementById(loadingId);

            if (!universalInput) return;

            var searchTimeout = null;
            var selectedResult = null;
            var currentResults = [];
            var selectedIndex = -1;

            // Input event - debounced search
            universalInput.addEventListener('input', function () {
                var query = this.value.trim();

                // Show/hide clear button
                clearBtn.style.display = query ? 'block' : 'none';

                // Clear timeout
                clearTimeout(searchTimeout);

                if (query.length < 2) {
                    resultsDropdown.style.display = 'none';
                    loadingIndicator.style.display = 'none';
                    return;
                }

                // Show loading
                loadingIndicator.style.display = 'block';
                searchInputWrapper.style.borderColor = '#2563eb';

                // Debounce 500ms (verhoogd voor minder database queries)
                searchTimeout = setTimeout(function () {
                    performAutocompleteSearch(query);
                }, 500);
            });

            // Clear button
            clearBtn.addEventListener('click', function () {
                universalInput.value = '';
                clearBtn.style.display = 'none';
                resultsDropdown.style.display = 'none';
                searchInputWrapper.style.borderColor = '#e5e7eb';
                universalInput.focus();
            });

            // Focus - highlight border
            universalInput.addEventListener('focus', function () {
                searchInputWrapper.style.borderColor = '#2563eb';
                searchInputWrapper.style.boxShadow = '0 4px 12px rgba(37,99,235,0.15)';
            });

            // Blur - reset border (with delay for click to register)
            universalInput.addEventListener('blur', function () {
                setTimeout(function () {
                    searchInputWrapper.style.borderColor = '#e5e7eb';
                    searchInputWrapper.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
                }, 200);
            });

            // Keyboard navigation
            universalInput.addEventListener('keydown', function (e) {
                // ALWAYS prevent Enter from submitting if this is inside a form
                if (e.key === 'Enter') {
                    e.preventDefault();

                    // If dropdown is visible with results, select the highlighted item
                    if (resultsDropdown && resultsDropdown.style.display !== 'none') {
                        var items = resultsDropdown.querySelectorAll('.st-result-item');
                        if (selectedIndex >= 0 && items[selectedIndex]) {
                            items[selectedIndex].click();
                        }
                    }
                    return;
                }

                if (!resultsDropdown || resultsDropdown.style.display === 'none') return;

                var items = resultsDropdown.querySelectorAll('.st-result-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    resultsDropdown.style.display = 'none';
                    selectedIndex = -1;
                }
            });

            function performAutocompleteSearch(query) {
                var fallbackUrl = '<?php echo home_url('/'); ?>?action=shorttrips_autocomplete&q=' + encodeURIComponent(query);
                var primaryUrl = '<?php echo admin_url('admin-ajax.php'); ?>?action=shorttrips_autocomplete&q=' + encodeURIComponent(query);

                console.log('üîç Autocomplete search for:', query);
                console.log('üì° Primary URL:', primaryUrl);
                var startTime = Date.now();

                function executeAutocomplete(url, isFallback) {
                    var timeoutId = setTimeout(function () {
                        console.error('‚è±Ô∏è Autocomplete timeout after 10 seconds');
                        loadingIndicator.style.display = 'none';
                        resultsDropdown.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">' +
                            '<p style="margin:0 0 8px 0;font-weight:600;">‚ö†Ô∏è Zoekopdracht duurde te lang</p>' +
                            '<p style="margin:0;font-size:13px;color:#dc2626;">Server reageert niet. Check console voor details.</p>' +
                            '</div>';
                        resultsDropdown.style.display = 'block';
                    }, 10000);

                    fetch(url, {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                        .then(function (response) {
                            clearTimeout(timeoutId);
                            var elapsed = Date.now() - startTime;
                            console.log('‚úÖ Response received (' + (isFallback ? 'fallback' : 'primary') + '):', {
                                status: response.status,
                                statusText: response.statusText,
                                elapsed: elapsed + 'ms',
                                contentType: response.headers.get('content-type')
                            });

                            if (!response.ok) {
                                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                            }

                            return response.text().then(function (text) {
                                console.log('üìÑ Raw response (first 500 chars):', text.substring(0, 500));
                                try {
                                    return JSON.parse(text);
                                } catch (e) {
                                    console.error('‚ùå JSON parse error:', e);
                                    console.error('üìÑ Full response:', text);
                                    throw new Error('Invalid JSON response: ' + e.message);
                                }
                            });
                        })
                        .then(function (data) {
                            loadingIndicator.style.display = 'none';
                            var elapsed = Date.now() - startTime;
                            console.log('üì¶ Parsed data:', data, '(' + elapsed + 'ms)');

                            if (data.error) {
                                console.error('‚ùå Server error:', data.error);
                                resultsDropdown.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">' +
                                    '<p style="margin:0 0 8px 0;font-weight:600;">‚ö†Ô∏è Fout</p>' +
                                    '<p style="margin:0;font-size:13px;color:#dc2626;">' + escapeHtml(data.error) + '</p>' +
                                    '</div>';
                                resultsDropdown.style.display = 'block';
                                return;
                            }

                            if (data.results && data.results.length > 0) {
                                currentResults = data.results;
                                renderAutocompleteResults(data.results);
                            } else {
                                resultsDropdown.innerHTML = '<div style="padding:20px;text-align:center;color:#9ca3af;">' +
                                    '<p style="margin:0;">Geen resultaten voor "' + escapeHtml(query) + '"</p>' +
                                    '<p style="margin:8px 0 0 0;font-size:12px;color:#6b7280;">Probeer een andere zoekterm</p>' +
                                    '</div>';
                                resultsDropdown.style.display = 'block';
                            }
                        })
                        .catch(function (error) {
                            clearTimeout(timeoutId);
                            console.error('‚ùå Fetch error (' + (isFallback ? 'fallback' : 'primary') + '):', error);

                            if (!isFallback) {
                                console.warn('‚ö†Ô∏è Primary autocomplete failed, trying fallback endpoint...');
                                executeAutocomplete(primaryUrl, true);
                                return;
                            }

                            loadingIndicator.style.display = 'none';
                            resultsDropdown.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">' +
                                '<p style="margin:0 0 8px 0;font-weight:600;">‚ö†Ô∏è Verbindingsfout</p>' +
                                '<p style="margin:0;font-size:13px;color:#dc2626;">' + escapeHtml(error.message) + '</p>' +
                                '<p style="margin:8px 0 0 0;font-size:11px;color:#9ca3af;">Check browser console (F12) voor details</p>' +
                                '</div>';
                            resultsDropdown.style.display = 'block';
                        });
                }

                executeAutocomplete(fallbackUrl, false);
            }

            function renderAutocompleteResults(results) {
                var html = '';

                results.forEach(function (result, index) {
                    var stars = '';
                    if (result.stars && result.stars > 0) {
                        stars = '<span style="color:#fbbf24;font-size:12px;margin-left:4px;">' + '‚òÖ'.repeat(result.stars) + '</span>';
                    }

                    html += '<div class="st-result-item" data-index="' + index + '" style="padding:12px 16px;cursor:pointer;border-bottom:1px solid #f3f4f6;transition:background 0.15s;">' +
                        '<div style="display:flex;align-items:center;gap:12px;">' +
                        '<span style="font-size:20px;">' + result.icon + '</span>' +
                        '<div style="flex:1;">' +
                        '<div style="font-weight:600;color:#1f2937;font-size:15px;">' + escapeHtml(result.label) + stars + '</div>' +
                        '<div style="font-size:13px;color:#6b7280;">' + escapeHtml(result.sublabel) + '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                });

                resultsDropdown.innerHTML = html;
                resultsDropdown.style.display = 'block';
                selectedIndex = -1;

                // Add click handlers
                var items = resultsDropdown.querySelectorAll('.st-result-item');
                items.forEach(function (item) {
                    item.addEventListener('mouseenter', function () {
                        items.forEach(function (i) { i.style.background = ''; });
                        this.style.background = '#f3f4f6';
                    });

                    item.addEventListener('mouseleave', function () {
                        this.style.background = '';
                    });

                    item.addEventListener('click', function () {
                        var index = parseInt(this.getAttribute('data-index'));
                        selectResult(results[index]);
                    });
                });
            }

            function updateSelection(items) {
                items.forEach(function (item, index) {
                    if (index === selectedIndex) {
                        item.style.background = '#f3f4f6';
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.style.background = '';
                    }
                });
            }

            function selectResult(result) {
                selectedResult = result;
                console.log('Selected:', result);

                // Hide dropdown
                resultsDropdown.style.display = 'none';

                // Show popup modal for date/guest selection
                showSearchModal(result);
            }

            function showSearchModal(result) {
                // Create modal
                var modal = document.createElement('div');
                modal.id = 'st-search-modal';
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;';

                var modalContent = '<div style="background:white;border-radius:16px;max-width:500px;width:100%;padding:32px;box-shadow:0 20px 40px rgba(0,0,0,0.3);position:relative;">' +
                    '<button onclick="document.getElementById(\'st-search-modal\').remove()" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:24px;color:#9ca3af;cursor:pointer;padding:4px 8px;">‚úï</button>' +
                    '<h3 style="margin:0 0 8px 0;font-size:24px;color:#1f2937;font-weight:700;">Zoeken naar</h3>' +
                    '<div style="display:flex;align-items:center;gap:8px;margin-bottom:24px;padding:12px;background:#f3f4f6;border-radius:8px;">' +
                    '<span style="font-size:24px;">' + result.icon + '</span>' +
                    '<div>' +
                    '<div style="font-weight:600;color:#1f2937;">' + escapeHtml(result.label) + '</div>' +
                    '<div style="font-size:13px;color:#6b7280;">' + escapeHtml(result.sublabel) + '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div style="margin-bottom:20px;">' +
                    '<label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">üìÖ Check-in & Check-out</label>' +
                    '<div style="display:flex;gap:8px;">' +
                    '<input type="text" id="modal-checkin" placeholder="Check-in" style="flex:1;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;" readonly>' +
                    '<input type="text" id="modal-checkout" placeholder="Check-out" style="flex:1;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;" readonly>' +
                    '</div>' +
                    '</div>' +
                    '<div style="margin-bottom:24px;">' +
                    '<label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">üë• Gasten</label>' +
                    '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">' +
                    '<div>' +
                    '<label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">Volwassenen</label>' +
                    '<input type="number" id="modal-adults" value="2" min="1" max="10" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">' +
                    '</div>' +
                    '<div>' +
                    '<label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">Kinderen</label>' +
                    '<input type="number" id="modal-children" value="0" min="0" max="10" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">' +
                    '</div>' +
                    '<div>' +
                    '<label style="display:block;font-size:12px;color:#6b7280;margin-bottom:4px;">Kamers</label>' +
                    '<input type="number" id="modal-rooms" value="1" min="1" max="10" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;">' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<button id="modal-search-btn" style="width:100%;padding:14px;background:#2563eb;color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:background 0.2s;">üîç Find hotels</button>' +
                    '</div>';

                modal.innerHTML = modalContent;
                document.body.appendChild(modal);

                // Initialize flatpickr if available
                var checkinInput = document.getElementById('modal-checkin');
                var checkoutInput = document.getElementById('modal-checkout');

                // Default dates: tomorrow + 7 days to tomorrow + 14 days
                // (tomorrow to account for timezone differences worldwide)
                var defaultCheckin = new Date();
                defaultCheckin.setDate(defaultCheckin.getDate() + 8); // Tomorrow + 7 days
                var defaultCheckout = new Date();
                defaultCheckout.setDate(defaultCheckout.getDate() + 15); // Tomorrow + 14 days

                checkinInput.value = defaultCheckin.toISOString().split('T')[0];
                checkoutInput.value = defaultCheckout.toISOString().split('T')[0];

                // Try to use existing flatpickr if available
                if (typeof flatpickr !== 'undefined') {
                    // Min/Max dates for worldwide compatibility
                    var tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    var maxDate = new Date();
                    maxDate.setFullYear(maxDate.getFullYear() + 1);

                    flatpickr(checkinInput, {
                        dateFormat: 'Y-m-d',
                        minDate: tomorrow, // Tomorrow (not today) for timezone safety
                        maxDate: maxDate,
                        defaultDate: defaultCheckin,
                        onChange: function (selectedDates) {
                            if (selectedDates[0]) {
                                var nextDay = new Date(selectedDates[0]);
                                nextDay.setDate(nextDay.getDate() + 1);
                                if (checkoutInput._flatpickr) {
                                    checkoutInput._flatpickr.set('minDate', nextDay);
                                }
                            }
                        }
                    });

                    flatpickr(checkoutInput, {
                        dateFormat: 'Y-m-d',
                        minDate: defaultCheckout,
                        maxDate: maxDate,
                        defaultDate: defaultCheckout
                    });
                } else {
                    // Fallback: gebruik native HTML5 date input
                    checkinInput.type = 'date';
                    checkoutInput.type = 'date';
                    var tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    checkinInput.min = tomorrow.toISOString().split('T')[0];
                    checkoutInput.min = defaultCheckout.toISOString().split('T')[0];
                }

                // Search button handler
                document.getElementById('modal-search-btn').addEventListener('click', function () {
                    executeUniversalSearch(result);
                });

                // Close on background click
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            function executeUniversalSearch(result) {
                var checkin = document.getElementById('modal-checkin').value;
                var checkout = document.getElementById('modal-checkout').value;
                var adults = document.getElementById('modal-adults').value;
                var children = document.getElementById('modal-children').value;
                var rooms = document.getElementById('modal-rooms').value;

                if (!checkin || !checkout) {
                    alert('Vul check-in en check-out datums in');
                    return;
                }

                // Calculate nights
                var checkinDate = new Date(checkin);
                var checkoutDate = new Date(checkout);
                var nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));

                // Build search parameters based on result type
                var searchParams = {
                    action: 'shorttrips_search_hotels',
                    checkin: checkin,
                    checkout: checkout,
                    nights: nights,
                    adults: adults,
                    children: children,
                    rooms: rooms
                };

                if (result.type === 'hotel') {
                    searchParams.type = 'hotel';
                    searchParams.hotelIDs = result.hotel_id || result.destination_id || '';
                    searchParams.selected_hotel_label = result.label || result.name || '';
                } else if (result.type === 'city') {
                    searchParams.type = 'resort';
                    searchParams.resort = result.destination_id || '';
                    searchParams.resort_name = result.name;
                    if (result.resort_id || result.destination_id) {
                        searchParams['resortIDs[]'] = result.resort_id || result.destination_id;
                    }
                    searchParams.country_name = result.country;
                    if (result.destination_id) {
                        searchParams.destinationID = result.destination_id;
                    }
                } else if (result.type === 'region') {
                    searchParams.type = 'resort';
                    searchParams.resort = result.destination_id || '';
                    searchParams.resort_name = result.name;
                    if (result.resort_id || result.destination_id) {
                        searchParams['resortIDs[]'] = result.resort_id || result.destination_id;
                    }
                    searchParams.country_name = result.country;
                    if (result.destination_id) {
                        searchParams.destinationID = result.destination_id;
                    }
                } else if (result.type === 'country') {
                    searchParams.type = 'country';
                    searchParams.country_name = result.name;
                    if (result.destination_id) {
                        searchParams.destinationID = result.destination_id;
                    }
                }

                if (searchParams.hotelIDs === '' || searchParams.hotelIDs === undefined) {
                    delete searchParams.hotelIDs;
                }

                console.log('Universal search params:', searchParams);

                // Close modal
                document.getElementById('st-search-modal').remove();

                // Clear universal search
                universalInput.value = '';
                clearBtn.style.display = 'none';

                console.log('‚úÖ Universal search - filling main form instead of navigating');

                // Find the main search form (with st-search-form ID)
                var mainForm = document.getElementById('st-search-form');
                if (!mainForm) {
                    console.error('‚ùå Main form not found, fallback to URL navigation');
                    var url = '<?php echo shorttrips_get_hotels_page_url(); ?>?' + new URLSearchParams(searchParams).toString();
                    window.location.href = url;
                    return;
                }

                // FILL THE MAIN FORM - Then it will submit with its own handler

                // 1. DESTINATION DISPLAY - Format: "Amsterdam, Netherlands" (zoals je foto)
                var destDisplay = document.getElementById('st-destination-display');
                if (destDisplay) {
                    if (result.type === 'city' || result.type === 'resort') {
                        // Voor steden: toon "Amsterdam, Netherlands"
                        destDisplay.textContent = result.name + ', ' + result.country;
                    } else if (result.type === 'country') {
                        // Voor landen: toon alleen "Netherlands"
                        destDisplay.textContent = result.country;
                    } else {
                        destDisplay.textContent = result.label || result.name;
                    }
                }

                // 2. Country input
                var countryInput = document.getElementById('st-countries-input');
                if (!countryInput) {
                    countryInput = document.createElement('input');
                    countryInput.type = 'hidden';
                    countryInput.name = 'country_name';
                    countryInput.id = 'st-countries-input';
                    mainForm.appendChild(countryInput);
                }
                countryInput.value = result.country || '';

                // 3. DestinationID input (CRITICAL FOR SUNHOTELS API!)
                var destIdInput = document.getElementById('st-destination-id-input');
                if (!destIdInput) {
                    destIdInput = document.createElement('input');
                    destIdInput.type = 'hidden';
                    destIdInput.name = 'destinationID';
                    destIdInput.id = 'st-destination-id-input';
                    mainForm.appendChild(destIdInput);
                }
                destIdInput.value = result.destination_id || '';

                if (result.type === 'hotel') {
                    var hotelIdInput = document.getElementById('st-hotel-id-input');
                    if (!hotelIdInput) {
                        hotelIdInput = document.createElement('input');
                        hotelIdInput.type = 'hidden';
                        hotelIdInput.name = 'hotelIDs';
                        hotelIdInput.id = 'st-hotel-id-input';
                        mainForm.appendChild(hotelIdInput);
                    }
                    hotelIdInput.value = result.hotel_id || '';

                    var hotelLabelInput = document.getElementById('st-hotel-label-input');
                    if (!hotelLabelInput) {
                        hotelLabelInput = document.createElement('input');
                        hotelLabelInput.type = 'hidden';
                        hotelLabelInput.name = 'selected_hotel_label';
                        hotelLabelInput.id = 'st-hotel-label-input';
                        mainForm.appendChild(hotelLabelInput);
                    }
                    hotelLabelInput.value = result.label || result.name || '';
                }

                // 4. Resort name (for cities)
                if (result.type === 'city' || result.type === 'resort') {
                    var resortInput = document.getElementById('st-resort-input');
                    if (!resortInput) {
                        resortInput = document.createElement('input');
                        resortInput.type = 'hidden';
                        resortInput.name = 'resort_name';
                        resortInput.id = 'st-resort-input';
                        mainForm.appendChild(resortInput);
                    }
                    resortInput.value = result.name;
                }

                // 5. Search type
                var typeInput = mainForm.querySelector('input[name="type"]');
                if (!typeInput) {
                    typeInput = document.createElement('input');
                    typeInput.type = 'hidden';
                    typeInput.name = 'type';
                    mainForm.appendChild(typeInput);
                }
                typeInput.value = result.type === 'city' ? 'resort' : result.type;

                // 6. Dates
                var checkinInput = document.getElementById('st-checkin-input');
                if (checkinInput) checkinInput.value = checkin;

                var checkoutInput = document.getElementById('st-checkout-input');
                if (checkoutInput) checkoutInput.value = checkout;

                // Update date display - Format: "16 dec - 20 dec" (zoals in je foto)
                var dateDisplay = document.getElementById('st-date-display');
                if (dateDisplay) {
                    var checkinDate = new Date(checkin);
                    var checkoutDate = new Date(checkout);
                    var months = ['jan', 'feb', 'mrt', 'apr', 'mei', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
                    var checkinFormatted = checkinDate.getDate() + ' ' + months[checkinDate.getMonth()];
                    var checkoutFormatted = checkoutDate.getDate() + ' ' + months[checkoutDate.getMonth()];
                    dateDisplay.textContent = checkinFormatted + ' - ' + checkoutFormatted;
                }

                // 7. Travelers
                var adultsInput = document.getElementById('st-adults-input');
                if (adultsInput) adultsInput.value = adults;

                var childrenInput = document.getElementById('st-children-input');
                if (childrenInput) childrenInput.value = children;

                var roomsInput = document.getElementById('st-rooms-input');
                if (roomsInput) roomsInput.value = rooms;

                // Update travelers display - Format: "2 gasten" (zoals in je foto)
                var travelersDisplay = document.getElementById('st-travelers-display');
                if (travelersDisplay) {
                    var totalPeople = parseInt(adults) + parseInt(children);
                    var text = totalPeople + ' ' + (totalPeople === 1 ? 'gast' : 'gasten');
                    travelersDisplay.textContent = text;
                }

                // BELANGRIJK: Update de internal state zodat modal/popups correcte data tonen
                if (typeof stSearchState !== 'undefined') {
                    stSearchState.selectedCountries = [result.country];
                    stSearchState.adults = parseInt(adults);
                    stSearchState.children = parseInt(children);
                    stSearchState.rooms = parseInt(rooms);
                }

                console.log('‚úÖ Main form filled with:', {
                    destinationID: result.destination_id,
                    resort_name: result.name,
                    country: result.country,
                    type: result.type,
                    checkin: checkin,
                    checkout: checkout
                });

                // Submit the form - will use existing search handler!
                mainForm.submit();
            }

            function escapeHtml(text) {
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ============================================================================
        // INITIALIZE UNIVERSAL SEARCH
        // ============================================================================
        // Wait for DOM to be ready, then initialize the search
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                console.log('üöÄ Initializing Universal Search...');
                initUniversalSearch(
                    'st-universal-search-header',
                    'st-autocomplete-results-header',
                    'st-search-input-wrapper-header',
                    'st-search-clear-header',
                    'st-search-loading-header'
                );
                console.log('‚úÖ Universal Search initialized');
            });
        } else {
            // DOM already loaded
            console.log('üöÄ Initializing Universal Search (DOM already ready)...');
            initUniversalSearch(
                'st-universal-search-header',
                'st-autocomplete-results-header',
                'st-search-input-wrapper-header',
                'st-search-clear-header',
                'st-search-loading-header'
            );
            console.log('‚úÖ Universal Search initialized');
        }
    </script>
    <?php
}, 5); // Priority 5 = Load early, before shortcodes render


// =============================================================================
// FREESTAYS PAGE SHORTCODES - Modern, Fresh, Contemporary Design
// =============================================================================

/**
 * Terms & Conditions Shortcode
 * Usage: [freestays_terms]
 */
add_shortcode('freestays_terms', function () {
    ob_start();
    ?>
    <style>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           FREESTAYS TERMS & CONDITIONS - Modern Design System
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        :root {
            --fs-primary: #2563eb;
            --fs-primary-dark: #1d4ed8;
            --fs-primary-light: #dbeafe;
            --fs-secondary: #7c3aed;
            --fs-accent: #f59e0b;
            --fs-success: #10b981;
            --fs-text: #1f2937;
            --fs-text-light: #6b7280;
            --fs-bg: #f8fafc;
            --fs-white: #ffffff;
            --fs-border: #e5e7eb;
            --fs-gradient: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            --fs-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --fs-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --fs-radius: 16px;
            --fs-radius-sm: 8px;
        }

        .fs-terms-page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px 80px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Hero Header */
        .fs-terms-hero {
            background: var(--fs-gradient);
            border-radius: var(--fs-radius);
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .fs-terms-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .fs-terms-hero h1 {
            color: var(--fs-white);
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800;
            margin: 0 0 16px;
            position: relative;
            z-index: 1;
        }

        .fs-terms-hero .fs-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            font-weight: 400;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        .fs-terms-hero .fs-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 50px;
            color: var(--fs-white);
            font-size: 14px;
            font-weight: 500;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        /* Meta Info Bar */
        .fs-terms-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            background: var(--fs-white);
            border-radius: var(--fs-radius);
            padding: 24px;
            margin-bottom: 40px;
            box-shadow: var(--fs-shadow);
            border: 1px solid var(--fs-border);
        }

        .fs-meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 20px;
            border-right: 1px solid var(--fs-border);
        }

        .fs-meta-item:last-child {
            border-right: none;
        }

        .fs-meta-icon {
            width: 40px;
            height: 40px;
            background: var(--fs-primary-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .fs-meta-text {
            display: flex;
            flex-direction: column;
        }

        .fs-meta-label {
            font-size: 12px;
            color: var(--fs-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fs-meta-value {
            font-size: 14px;
            color: var(--fs-text);
            font-weight: 600;
        }

        /* Table of Contents */
        .fs-terms-toc {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: var(--fs-radius);
            padding: 32px;
            margin-bottom: 40px;
            border: 1px solid #bae6fd;
        }

        .fs-toc-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--fs-text);
            margin-bottom: 20px;
        }

        .fs-toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .fs-toc-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--fs-white);
            border-radius: var(--fs-radius-sm);
            color: var(--fs-text);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .fs-toc-item:hover {
            background: var(--fs-primary);
            color: var(--fs-white);
            transform: translateX(4px);
            border-color: var(--fs-primary);
        }

        .fs-toc-num {
            width: 28px;
            height: 28px;
            background: var(--fs-primary-light);
            color: var(--fs-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .fs-toc-item:hover .fs-toc-num {
            background: rgba(255, 255, 255, 0.2);
            color: var(--fs-white);
        }

        /* Section Styling */
        .fs-terms-section {
            background: var(--fs-white);
            border-radius: var(--fs-radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--fs-shadow);
            border: 1px solid var(--fs-border);
            transition: all 0.3s ease;
        }

        .fs-terms-section:hover {
            box-shadow: var(--fs-shadow-lg);
            transform: translateY(-2px);
        }

        .fs-section-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--fs-primary-light);
        }

        .fs-section-num {
            width: 48px;
            height: 48px;
            background: var(--fs-gradient);
            color: var(--fs-white);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            flex-shrink: 0;
        }

        .fs-section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--fs-text);
            margin: 0;
            line-height: 1.3;
        }

        .fs-section-title .fs-emoji {
            margin-right: 8px;
        }

        /* Content Styling */
        .fs-terms-content h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--fs-text);
            margin: 24px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fs-terms-content h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--fs-gradient);
            border-radius: 2px;
        }

        .fs-terms-content p {
            font-size: 15px;
            line-height: 1.8;
            color: var(--fs-text-light);
            margin: 0 0 16px;
        }

        .fs-terms-content ul {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }

        .fs-terms-content ul li {
            position: relative;
            padding-left: 28px;
            margin-bottom: 12px;
            font-size: 15px;
            line-height: 1.7;
            color: var(--fs-text-light);
        }

        .fs-terms-content ul li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            top: 0;
            width: 20px;
            height: 20px;
            background: var(--fs-success);
            color: var(--fs-white);
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Highlight Box */
        .fs-highlight-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: var(--fs-radius-sm);
            padding: 20px 24px;
            margin: 20px 0;
            border-left: 4px solid var(--fs-accent);
        }

        .fs-highlight-box p {
            color: #92400e;
            margin: 0;
            font-weight: 500;
        }

        /* Info Box */
        .fs-info-box {
            background: var(--fs-primary-light);
            border-radius: var(--fs-radius-sm);
            padding: 20px 24px;
            margin: 20px 0;
            border-left: 4px solid var(--fs-primary);
        }

        .fs-info-box p {
            color: var(--fs-primary-dark);
            margin: 0;
        }

        /* Refund Table */
        .fs-refund-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: var(--fs-radius-sm);
            overflow: hidden;
            box-shadow: var(--fs-shadow);
        }

        .fs-refund-table th {
            background: var(--fs-gradient);
            color: var(--fs-white);
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .fs-refund-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--fs-border);
            font-size: 14px;
            color: var(--fs-text);
        }

        .fs-refund-table tr:last-child td {
            border-bottom: none;
        }

        .fs-refund-table tr:nth-child(even) td {
            background: var(--fs-bg);
        }

        .fs-refund-100 {
            color: var(--fs-success);
            font-weight: 600;
        }

        .fs-refund-50 {
            color: var(--fs-accent);
            font-weight: 600;
        }

        .fs-refund-0 {
            color: #ef4444;
            font-weight: 600;
        }

        /* Contact Card */
        .fs-contact-card {
            background: var(--fs-gradient);
            border-radius: var(--fs-radius);
            padding: 40px;
            text-align: center;
            margin-top: 40px;
            color: var(--fs-white);
        }

        .fs-contact-card h3 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px;
            color: var(--fs-white);
        }

        .fs-contact-card h3::before {
            display: none;
        }

        .fs-contact-card p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 24px;
        }

        .fs-contact-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
        }

        .fs-contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--fs-white);
            color: var(--fs-primary);
            padding: 14px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: var(--fs-shadow);
        }

        .fs-contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--fs-shadow-lg);
            background: var(--fs-bg);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .fs-terms-page {
                padding: 20px 16px 60px;
            }

            .fs-terms-hero {
                padding: 40px 24px;
            }

            .fs-terms-meta {
                flex-direction: column;
                gap: 16px;
            }

            .fs-meta-item {
                border-right: none;
                border-bottom: 1px solid var(--fs-border);
                padding: 0 0 16px;
            }

            .fs-meta-item:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            .fs-terms-section {
                padding: 24px;
            }

            .fs-section-header {
                flex-direction: column;
                gap: 12px;
            }

            .fs-contact-card {
                padding: 32px 24px;
            }

            .fs-contact-methods {
                flex-direction: column;
            }
        }
    </style>

    <div class="fs-terms-page">
        <!-- Hero Header -->
        <div class="fs-terms-hero">
            <h1>üìú Terms & Conditions</h1>
            <p class="fs-subtitle">Booking Policies & User Agreements for Freestays.eu</p>
            <span class="fs-badge">
                <span>üîí</span> Your Rights Protected
            </span>
        </div>

        <!-- Meta Info -->
        <div class="fs-terms-meta">
            <div class="fs-meta-item">
                <div class="fs-meta-icon">üìÖ</div>
                <div class="fs-meta-text">
                    <span class="fs-meta-label">Last Updated</span>
                    <span class="fs-meta-value">December 2, 2024</span>
                </div>
            </div>
            <div class="fs-meta-item">
                <div class="fs-meta-icon">üè¢</div>
                <div class="fs-meta-text">
                    <span class="fs-meta-label">Governing Entity</span>
                    <span class="fs-meta-value">Travelar Group BV</span>
                </div>
            </div>
            <div class="fs-meta-item">
                <div class="fs-meta-icon">üìç</div>
                <div class="fs-meta-text">
                    <span class="fs-meta-label">Location</span>
                    <span class="fs-meta-value">Barneveld, Netherlands</span>
                </div>
            </div>
        </div>

        <!-- Table of Contents -->
        <div class="fs-terms-toc">
            <div class="fs-toc-title">
                <span>üìë</span> Quick Navigation
            </div>
            <div class="fs-toc-grid">
                <a href="#section-1" class="fs-toc-item">
                    <span class="fs-toc-num">1</span>
                    <span>Website Overview & General Terms</span>
                </a>
                <a href="#section-2" class="fs-toc-item">
                    <span class="fs-toc-num">2</span>
                    <span>Booking & Reservation Policies</span>
                </a>
                <a href="#section-3" class="fs-toc-item">
                    <span class="fs-toc-num">3</span>
                    <span>Payment Terms & Refund Rules</span>
                </a>
                <a href="#section-4" class="fs-toc-item">
                    <span class="fs-toc-num">4</span>
                    <span>Cancellation Policy</span>
                </a>
                <a href="#section-5" class="fs-toc-item">
                    <span class="fs-toc-num">5</span>
                    <span>Privacy Policy & Data Protection</span>
                </a>
                <a href="#section-6" class="fs-toc-item">
                    <span class="fs-toc-num">6</span>
                    <span>User Responsibilities</span>
                </a>
                <a href="#section-7" class="fs-toc-item">
                    <span class="fs-toc-num">7</span>
                    <span>Liability Limitations</span>
                </a>
                <a href="#section-8" class="fs-toc-item">
                    <span class="fs-toc-num">8</span>
                    <span>Intellectual Property Rights</span>
                </a>
                <a href="#section-9" class="fs-toc-item">
                    <span class="fs-toc-num">9</span>
                    <span>Dispute Resolution</span>
                </a>
                <a href="#section-10" class="fs-toc-item">
                    <span class="fs-toc-num">10</span>
                    <span>Contact Us</span>
                </a>
            </div>
        </div>

        <!-- Section 1 -->
        <div id="section-1" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">1</div>
                <h2 class="fs-section-title"><span class="fs-emoji">üåê</span> Website Overview & General Terms</h2>
            </div>
            <div class="fs-terms-content">
                <h3>1.1 About Freestays.eu</h3>
                <p>www.freestays.eu is operated by Travelar Group BV, registered at Veemweg 29-31, 3771 TM Barneveld,
                    Netherlands.</p>

                <h3>1.2 Acceptance of Terms</h3>
                <p>By accessing or booking through Freestays.eu, you agree to these Terms & Conditions, our Privacy Policy,
                    and Cancellation Policy. Non-compliance prohibits further use.</p>

                <h3>1.3 Policy Updates</h3>
                <p>We reserve the right to modify terms at any time. Continued use post-update constitutes acceptance.
                    Regularly review this page for changes.</p>
            </div>
        </div>

        <!-- Section 2 -->
        <div id="section-2" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">2</div>
                <h2 class="fs-section-title"><span class="fs-emoji">üìã</span> Booking & Reservation Policies</h2>
            </div>
            <div class="fs-terms-content">
                <h3>2.1 Eligibility Requirements</h3>
                <p>Users must be 18+ years to book accommodations.</p>

                <h3>2.2 Account Creation</h3>
                <ul>
                    <li>Provide accurate details during registration</li>
                    <li>Safeguard your account credentials</li>
                    <li>Report unauthorized access immediately</li>
                </ul>

                <h3>2.3 Service Availability & Confirmation</h3>
                <ul>
                    <li>Bookings are subject to availability</li>
                    <li>Confirmation emails will detail your reservation</li>
                </ul>
            </div>
        </div>

        <!-- Section 3 -->
        <div id="section-3" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">3</div>
                <h2 class="fs-section-title"><span class="fs-emoji">üí≥</span> Payment Terms & Refund Rules</h2>
            </div>
            <div class="fs-terms-content">
                <h3>3.1 Pricing & Taxes</h3>
                <p>All prices are in Euros (‚Ç¨) and include applicable taxes unless stated otherwise.</p>

                <h3>3.2 Accepted Payment Methods</h3>
                <p>Credit/debit cards and other listed payment options.</p>

                <h3>3.3 Refund Process</h3>
                <div class="fs-info-box">
                    <p>üí° Refunds follow our Cancellation Policy as detailed in Section 4 below.</p>
                </div>
            </div>
        </div>

        <!-- Section 4 -->
        <div id="section-4" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">4</div>
                <h2 class="fs-section-title"><span class="fs-emoji">üîÑ</span> Cancellation Policy & Booking Modifications
                </h2>
            </div>
            <div class="fs-terms-content">
                <h3>4.1 Refundable Bookings</h3>
                <table class="fs-refund-table">
                    <thead>
                        <tr>
                            <th>‚è∞ Cancellation Timing</th>
                            <th>üí∞ Refund Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>21+ days before check-in</td>
                            <td class="fs-refund-100">‚úÖ 100% refund</td>
                        </tr>
                        <tr>
                            <td>12‚Äì20 days before check-in</td>
                            <td class="fs-refund-50">‚ö†Ô∏è 50% refund</td>
                        </tr>
                        <tr>
                            <td>Less than 11 days before check-in</td>
                            <td class="fs-refund-0">‚ùå No refund</td>
                        </tr>
                    </tbody>
                </table>

                <h3>4.2 Non-Refundable Bookings</h3>
                <div class="fs-highlight-box">
                    <p>‚ö†Ô∏è No refunds for cancellations or changes on non-refundable bookings.</p>
                </div>

                <h3>4.3 Modification Guidelines</h3>
                <p>Changes are subject to availability and potential fees.</p>
            </div>
        </div>

        <!-- Section 5 -->
        <div id="section-5" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">5</div>
                <h2 class="fs-section-title"><span class="fs-emoji">üîê</span> Privacy Policy & Data Protection</h2>
            </div>
            <div class="fs-terms-content">
                <h3>5.1 Data Usage</h3>
                <p>Personal data is used for booking management, customer support, and service improvement.</p>

                <h3>5.2 User Rights</h3>
                <ul>
                    <li>Access, correct, or delete your data via account settings</li>
                    <li>Opt out of marketing communications anytime</li>
                </ul>

                <div class="fs-info-box">
                    <p>üìñ <a href="/privacy-policy" style="color:var(--fs-primary-dark);font-weight:600;">Read our Full
                            Privacy Policy ‚Üí</a></p>
                </div>
            </div>
        </div>

        <!-- Section 6 -->
        <div id="section-6" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">6</div>
                <h2 class="fs-section-title"><span class="fs-emoji">üë§</span> User Responsibilities</h2>
            </div>
            <div class="fs-terms-content">
                <h3>6.1 Accurate Information</h3>
                <p>Maintain up-to-date booking and account details.</p>

                <h3>6.2 Prohibited Activities</h3>
                <ul>
                    <li>No fraudulent actions</li>
                    <li>No hacking or unauthorized access attempts</li>
                    <li>No misuse of the platform</li>
                </ul>

                <h3>6.3 Force Majeure</h3>
                <p>We are not liable for delays/cancellations due to unforeseen events (e.g., natural disasters, technical
                    outages).</p>
            </div>
        </div>

        <!-- Section 7 -->
        <div id="section-7" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">7</div>
                <h2 class="fs-section-title"><span class="fs-emoji">‚öñÔ∏è</span> Liability Limitations</h2>
            </div>
            <div class="fs-terms-content">
                <p>We are not liable for indirect, incidental, or consequential damages from website use.</p>
                <div class="fs-highlight-box">
                    <p>üìå Maximum liability = total booking amount paid.</p>
                </div>
            </div>
        </div>

        <!-- Section 8 -->
        <div id="section-8" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">8</div>
                <h2 class="fs-section-title"><span class="fs-emoji">¬©Ô∏è</span> Intellectual Property Rights</h2>
            </div>
            <div class="fs-terms-content">
                <p>All website content (text, logos, images) is owned by Travelar Group BV and protected under copyright
                    law.</p>
                <div class="fs-highlight-box">
                    <p>‚ö†Ô∏è Unauthorized use, copying, or distribution is prohibited.</p>
                </div>
            </div>
        </div>

        <!-- Section 9 -->
        <div id="section-9" class="fs-terms-section">
            <div class="fs-section-header">
                <div class="fs-section-num">9</div>
                <h2 class="fs-section-title"><span class="fs-emoji">üèõÔ∏è</span> Dispute Resolution & Legal Jurisdiction</h2>
            </div>
            <div class="fs-terms-content">
                <h3>9.1 Governing Law</h3>
                <p>Disputes governed by Dutch law.</p>

                <h3>9.2 Arbitration Process</h3>
                <p>Conflicts resolved via binding arbitration in the Netherlands.</p>
            </div>
        </div>

        <!-- Section 10 - Contact -->
        <div id="section-10" class="fs-contact-card">
            <h3>üìû Contact Us for Support</h3>
            <p>Have questions about our terms? We're here to help!</p>
            <div class="fs-contact-methods">
                <a href="mailto:info@freestays.eu" class="fs-contact-btn">
                    <span>‚úâÔ∏è</span> info@freestays.eu
                </a>
                <a href="https://maps.google.com/?q=Veemweg+29-31,+3771+TM+Barneveld" target="_blank"
                    class="fs-contact-btn">
                    <span>üìç</span> Veemweg 29-31, Barneveld
                </a>
            </div>
        </div>
    </div>

    <script>
        // Smooth scroll for TOC links
        document.querySelectorAll('.fs-toc-item').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    </script>
    <?php
    return ob_get_clean();
});


/**
 * Privacy Policy Shortcode
 * Usage: [freestays_privacy]
 */
add_shortcode('freestays_privacy', function () {
    ob_start();
    ?>
    <style>
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           FREESTAYS PRIVACY POLICY - Modern Design System
           Uses same design tokens as Terms & Conditions for consistency
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        .fs-privacy-page {
            --fs-primary: #2563eb;
            --fs-primary-dark: #1d4ed8;
            --fs-primary-light: #dbeafe;
            --fs-secondary: #7c3aed;
            --fs-accent: #f59e0b;
            --fs-success: #10b981;
            --fs-text: #1f2937;
            --fs-text-light: #6b7280;
            --fs-bg: #f8fafc;
            --fs-white: #ffffff;
            --fs-border: #e5e7eb;
            --fs-gradient: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%);
            --fs-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --fs-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --fs-radius: 16px;
            --fs-radius-sm: 8px;

            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px 80px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Hero Header - Purple theme for Privacy */
        .fs-privacy-hero {
            background: var(--fs-gradient);
            border-radius: var(--fs-radius);
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .fs-privacy-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .fs-privacy-hero::after {
            content: 'üîí';
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 80px;
            opacity: 0.15;
        }

        .fs-privacy-hero h1 {
            color: var(--fs-white);
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800;
            margin: 0 0 16px;
            position: relative;
            z-index: 1;
        }

        .fs-privacy-hero .fs-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            font-weight: 400;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        .fs-privacy-hero .fs-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            position: relative;
            z-index: 1;
        }

        .fs-privacy-hero .fs-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 50px;
            color: var(--fs-white);
            font-size: 14px;
            font-weight: 500;
        }

        /* Meta Info Bar */
        .fs-privacy-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            background: var(--fs-white);
            border-radius: var(--fs-radius);
            padding: 24px;
            margin-bottom: 40px;
            box-shadow: var(--fs-shadow);
            border: 1px solid var(--fs-border);
        }

        .fs-privacy-meta .fs-meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 20px;
            border-right: 1px solid var(--fs-border);
        }

        .fs-privacy-meta .fs-meta-item:last-child {
            border-right: none;
        }

        .fs-privacy-meta .fs-meta-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .fs-privacy-meta .fs-meta-text {
            display: flex;
            flex-direction: column;
        }

        .fs-privacy-meta .fs-meta-label {
            font-size: 12px;
            color: var(--fs-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fs-privacy-meta .fs-meta-value {
            font-size: 14px;
            color: var(--fs-text);
            font-weight: 600;
        }

        /* GDPR Compliance Banner */
        .fs-gdpr-banner {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: var(--fs-radius);
            padding: 24px 32px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid #a7f3d0;
        }

        .fs-gdpr-icon {
            width: 60px;
            height: 60px;
            background: var(--fs-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }

        .fs-gdpr-text h3 {
            font-size: 18px;
            font-weight: 700;
            color: #065f46;
            margin: 0 0 4px;
        }

        .fs-gdpr-text p {
            font-size: 14px;
            color: #047857;
            margin: 0;
            line-height: 1.5;
        }

        /* Table of Contents */
        .fs-privacy-toc {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-radius: var(--fs-radius);
            padding: 32px;
            margin-bottom: 40px;
            border: 1px solid #e9d5ff;
        }

        .fs-privacy-toc .fs-toc-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--fs-text);
            margin-bottom: 20px;
        }

        .fs-privacy-toc .fs-toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .fs-privacy-toc .fs-toc-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--fs-white);
            border-radius: var(--fs-radius-sm);
            color: var(--fs-text);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .fs-privacy-toc .fs-toc-item:hover {
            background: var(--fs-secondary);
            color: var(--fs-white);
            transform: translateX(4px);
        }

        .fs-privacy-toc .fs-toc-num {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            color: var(--fs-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .fs-privacy-toc .fs-toc-item:hover .fs-toc-num {
            background: rgba(255, 255, 255, 0.2);
            color: var(--fs-white);
        }

        /* Section Styling */
        .fs-privacy-section {
            background: var(--fs-white);
            border-radius: var(--fs-radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--fs-shadow);
            border: 1px solid var(--fs-border);
            transition: all 0.3s ease;
        }

        .fs-privacy-section:hover {
            box-shadow: var(--fs-shadow-lg);
            transform: translateY(-2px);
        }

        .fs-privacy-section .fs-section-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #ede9fe;
        }

        .fs-privacy-section .fs-section-num {
            width: 48px;
            height: 48px;
            background: var(--fs-gradient);
            color: var(--fs-white);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            flex-shrink: 0;
        }

        .fs-privacy-section .fs-section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--fs-text);
            margin: 0;
            line-height: 1.3;
        }

        /* Content Styling */
        .fs-privacy-content h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--fs-text);
            margin: 24px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fs-privacy-content h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--fs-gradient);
            border-radius: 2px;
        }

        .fs-privacy-content p {
            font-size: 15px;
            line-height: 1.8;
            color: var(--fs-text-light);
            margin: 0 0 16px;
        }

        .fs-privacy-content ul {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }

        .fs-privacy-content ul li {
            position: relative;
            padding-left: 28px;
            margin-bottom: 12px;
            font-size: 15px;
            line-height: 1.7;
            color: var(--fs-text-light);
        }

        .fs-privacy-content ul li::before {
            content: 'üîπ';
            position: absolute;
            left: 0;
            top: 0;
        }

        .fs-privacy-content ul.fs-check-list li::before {
            content: '‚úì';
            background: var(--fs-success);
            color: var(--fs-white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Data Category Cards */
        .fs-data-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .fs-data-card {
            background: var(--fs-bg);
            border-radius: var(--fs-radius-sm);
            padding: 20px;
            border: 1px solid var(--fs-border);
        }

        .fs-data-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .fs-data-card-icon {
            width: 36px;
            height: 36px;
            background: var(--fs-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .fs-data-card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--fs-text);
        }

        .fs-data-card ul {
            margin: 0;
        }

        .fs-data-card ul li {
            font-size: 13px;
            margin-bottom: 8px;
        }

        /* Rights Grid */
        .fs-rights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .fs-right-item {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-radius: var(--fs-radius-sm);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #e9d5ff;
        }

        .fs-right-icon {
            font-size: 24px;
        }

        .fs-right-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--fs-text);
        }

        /* Info Box */
        .fs-privacy-info-box {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-radius: var(--fs-radius-sm);
            padding: 20px 24px;
            margin: 20px 0;
            border-left: 4px solid var(--fs-secondary);
        }

        .fs-privacy-info-box p {
            color: #5b21b6;
            margin: 0;
            font-weight: 500;
        }

        /* Security Features */
        .fs-security-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        .fs-security-item {
            text-align: center;
            padding: 24px 16px;
            background: var(--fs-bg);
            border-radius: var(--fs-radius-sm);
            border: 1px solid var(--fs-border);
        }

        .fs-security-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .fs-security-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--fs-text);
        }

        /* Contact Card */
        .fs-privacy-contact {
            background: var(--fs-gradient);
            border-radius: var(--fs-radius);
            padding: 40px;
            text-align: center;
            margin-top: 40px;
            color: var(--fs-white);
        }

        .fs-privacy-contact h3 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px;
            color: var(--fs-white);
        }

        .fs-privacy-contact h3::before {
            display: none;
        }

        .fs-privacy-contact p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 24px;
        }

        .fs-privacy-contact .fs-contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--fs-white);
            color: var(--fs-secondary);
            padding: 14px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: var(--fs-shadow);
        }

        .fs-privacy-contact .fs-contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--fs-shadow-lg);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .fs-privacy-page {
                padding: 20px 16px 60px;
            }

            .fs-privacy-hero {
                padding: 40px 24px;
            }

            .fs-privacy-meta {
                flex-direction: column;
                gap: 16px;
            }

            .fs-privacy-meta .fs-meta-item {
                border-right: none;
                border-bottom: 1px solid var(--fs-border);
                padding: 0 0 16px;
            }

            .fs-privacy-meta .fs-meta-item:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            .fs-gdpr-banner {
                flex-direction: column;
                text-align: center;
            }

            .fs-privacy-section {
                padding: 24px;
            }

            .fs-privacy-section .fs-section-header {
                flex-direction: column;
                gap: 12px;
            }

            .fs-security-grid {
                grid-template-columns: 1fr;
            }

            .fs-privacy-contact {
                padding: 32px 24px;
            }
        }
    </style>

    <div class="fs-privacy-page">
        <!-- Hero Header -->
        <div class="fs-privacy-hero">
            <h1>üîê Privacy Policy</h1>
            <p class="fs-subtitle">How we collect, use, and protect your personal data</p>
            <div class="fs-badges">
                <span class="fs-badge">
                    <span>üá™üá∫</span> GDPR Compliant
                </span>
                <span class="fs-badge">
                    <span>üîí</span> Data Protected
                </span>
                <span class="fs-badge">
                    <span>‚úÖ</span> Transparent
                </span>
            </div>
        </div>

        <!-- Meta Info -->
        <div class="fs-privacy-meta">
            <div class="fs-meta-item">
                <div class="fs-meta-icon">üìÖ</div>
                <div class="fs-meta-text">
                    <span class="fs-meta-label">Last Updated</span>
                    <span class="fs-meta-value">February 3, 2025</span>
                </div>
            </div>
            <div class="fs-meta-item">
                <div class="fs-meta-icon">üè¢</div>
                <div class="fs-meta-text">
                    <span class="fs-meta-label">Website Owner</span>
                    <span class="fs-meta-value">TravelAR Group BV</span>
                </div>
            </div>
            <div class="fs-meta-item">
                <div class="fs-meta-icon">üìç</div>
                <div class="fs-meta-text">
                    <span class="fs-meta-label">Location</span>
                    <span class="fs-meta-value">Barneveld, Netherlands</span>
                </div>
            </div>
        </div>

        <!-- GDPR Banner -->
        <div class="fs-gdpr-banner">
            <div class="fs-gdpr-icon">üá™üá∫</div>
            <div class="fs-gdpr-text">
                <h3>GDPR Compliant</h3>
                <p>This Privacy Policy outlines how Freestays.eu collects, uses, and protects your personal data in
                    compliance with the General Data Protection Regulation (GDPR). By using our Services, you agree to these
                    terms.</p>
            </div>
        </div>

        <!-- Table of Contents -->
        <div class="fs-privacy-toc">
            <div class="fs-toc-title">
                <span>üìë</span> Quick Navigation
            </div>
            <div class="fs-toc-grid">
                <a href="#privacy-1" class="fs-toc-item">
                    <span class="fs-toc-num">1</span>
                    <span>Information We Collect</span>
                </a>
                <a href="#privacy-2" class="fs-toc-item">
                    <span class="fs-toc-num">2</span>
                    <span>How We Use Your Data</span>
                </a>
                <a href="#privacy-3" class="fs-toc-item">
                    <span class="fs-toc-num">3</span>
                    <span>Legal Basis for Processing</span>
                </a>
                <a href="#privacy-4" class="fs-toc-item">
                    <span class="fs-toc-num">4</span>
                    <span>Data Sharing</span>
                </a>
                <a href="#privacy-5" class="fs-toc-item">
                    <span class="fs-toc-num">5</span>
                    <span>Data Retention</span>
                </a>
                <a href="#privacy-6" class="fs-toc-item">
                    <span class="fs-toc-num">6</span>
                    <span>Your Rights</span>
                </a>
                <a href="#privacy-7" class="fs-toc-item">
                    <span class="fs-toc-num">7</span>
                    <span>Cookies & Tracking</span>
                </a>
                <a href="#privacy-8" class="fs-toc-item">
                    <span class="fs-toc-num">8</span>
                    <span>Security Measures</span>
                </a>
            </div>
        </div>

        <!-- Section 1: Information We Collect -->
        <div id="privacy-1" class="fs-privacy-section">
            <div class="fs-section-header">
                <div class="fs-section-num">1</div>
                <h2 class="fs-section-title">üìä Information We Collect</h2>
            </div>
            <div class="fs-privacy-content">
                <p>We collect data to enhance your travel experience:</p>

                <h3>1.1 Personal Information</h3>

                <div class="fs-data-cards">
                    <div class="fs-data-card">
                        <div class="fs-data-card-header">
                            <div class="fs-data-card-icon">üë§</div>
                            <span class="fs-data-card-title">Provided by You</span>
                        </div>
                        <ul>
                            <li>Name, email, phone number, and address</li>
                            <li>Payment details (e.g., credit card information)</li>
                            <li>Travel preferences (e.g., dietary needs, room requests)</li>
                            <li>Details of fellow travelers (e.g., family or friends)</li>
                        </ul>
                    </div>
                    <div class="fs-data-card">
                        <div class="fs-data-card-header">
                            <div class="fs-data-card-icon">ü§ù</div>
                            <span class="fs-data-card-title">From Third Parties</span>
                        </div>
                        <ul>
                            <li>Partners (e.g., travel agencies) may share data to improve bookings</li>
                        </ul>
                    </div>
                </div>

                <h3>1.2 Automatic Data Collection</h3>
                <ul>
                    <li><strong>Device Data:</strong> IP address, browser type, OS</li>
                    <li><strong>Usage Analytics:</strong> Pages visited, session duration, search queries</li>
                    <li><strong>Cookies:</strong> Used for functionality, analytics, and ads (see Section 7)</li>
                </ul>

                <h3>1.3 Sensitive Data</h3>
                <div class="fs-privacy-info-box">
                    <p>üõ°Ô∏è We do not collect racial, religious, or health data unless voluntarily provided (e.g., dietary
                        restrictions).</p>
                </div>
            </div>
        </div>

        <!-- Section 2: How We Use Your Data -->
        <div id="privacy-2" class="fs-privacy-section">
            <div class="fs-section-header">
                <div class="fs-section-num">2</div>
                <h2 class="fs-section-title">‚öôÔ∏è How We Use Your Data</h2>
            </div>
            <div class="fs-privacy-content">
                <p>Your information helps us:</p>
                <ul class="fs-check-list">
                    <li><strong>Process Bookings:</strong> Confirm reservations, manage payments, and send updates</li>
                    <li><strong>Improve Services:</strong> Personalize offers and develop new features</li>
                    <li><strong>Marketing:</strong> Send promotions (with consent) and display tailored ads</li>
                    <li><strong>Security:</strong> Prevent fraud and comply with legal obligations</li>
                </ul>
            </div>
        </div>

        <!-- Section 3: Legal Basis -->
        <div id="privacy-3" class="fs-privacy-section">
            <div class="fs-section-header">
                <div class="fs-section-num">3</div>
                <h2 class="fs-section-title">‚öñÔ∏è Legal Basis for Processing</h2>
            </div>
            <div class="fs-privacy-content">
                <p>We process data under:</p>
                <div class="fs-data-cards">
                    <div class="fs-data-card">
                        <div class="fs-data-card-header">
                            <div class="fs-data-card-icon">‚úÖ</div>
                            <span class="fs-data-card-title">Consent</span>
                        </div>
                        <p style="margin:0;font-size:13px;color:var(--fs-text-light)">e.g., marketing emails</p>
                    </div>
                    <div class="fs-data-card">
                        <div class="fs-data-card-header">
                            <div class="fs-data-card-icon">üìù</div>
                            <span class="fs-data-card-title">Contractual Necessity</span>
                        </div>
                        <p style="margin:0;font-size:13px;color:var(--fs-text-light)">e.g., booking fulfillment</p>
                    </div>
                    <div class="fs-data-card">
                        <div class="fs-data-card-header">
                            <div class="fs-data-card-icon">üìã</div>
                            <span class="fs-data-card-title">Legal Compliance</span>
                        </div>
                        <p style="margin:0;font-size:13px;color:var(--fs-text-light)">e.g., tax laws</p>
                    </div>
                    <div class="fs-data-card">
                        <div class="fs-data-card-header">
                            <div class="fs-data-card-icon">üéØ</div>
                            <span class="fs-data-card-title">Legitimate Interests</span>
                        </div>
                        <p style="margin:0;font-size:13px;color:var(--fs-text-light)">e.g., fraud prevention</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Data Sharing -->
        <div id="privacy-4" class="fs-privacy-section">
            <div class="fs-section-header">
                <div class="fs-section-num">4</div>
                <h2 class="fs-section-title">ü§ù Data Sharing</h2>
            </div>
            <div class="fs-privacy-content">
                <p>We share data with:</p>
                <ul>
                    <li><strong>Service Providers:</strong> Payment processors, IT support</li>
                    <li><strong>Travel Partners:</strong> Hotels, airlines</li>
                    <li><strong>Legal Authorities:</strong> When required by law</li>
                </ul>
                <div class="fs-privacy-info-box">
                    <p>üîí All partners adhere to strict GDPR standards.</p>
                </div>
            </div>
        </div>

        <!-- Section 5: Data Retention -->
        <div id="privacy-5" class="fs-privacy-section">
            <div class="fs-section-header">
                <div class="fs-section-num">5</div>
                <h2 class="fs-section-title">üóÑÔ∏è Data Retention</h2>
            </div>
            <div class="fs-privacy-content">
                <p>We retain data only as long as necessary to:</p>
                <ul class="fs-check-list">
                    <li>Fulfill bookings</li>
                    <li>Comply with laws</li>
                    <li>Resolve disputes</li>
                </ul>
                <div class="fs-privacy-info-box">
                    <p>üóëÔ∏è Post-retention, data is securely deleted or anonymized.</p>
                </div>
            </div>
        </div>

        <!-- Section 6: Your Rights -->
        <div id="privacy-6" class="fs-privacy-section">
            <div class="fs-section-header">
                <div class="fs-section-num">6</div>
                <h2 class="fs-section-title">‚úä Your Rights</h2>
            </div>
            <div class="fs-privacy-content">
                <p>Under GDPR, you may:</p>
                <div class="fs-rights-grid">
                    <div class="fs-right-item">
                        <span class="fs-right-icon">üëÅÔ∏è</span>
                        <span class="fs-right-text">Access your data</span>
                    </div>
                    <div class="fs-right-item">
                        <span class="fs-right-icon">‚úèÔ∏è</span>
                        <span class="fs-right-text">Correct your data</span>
                    </div>
                    <div class="fs-right-item">
                        <span class="fs-right-icon">üóëÔ∏è</span>
                        <span class="fs-right-text">Delete your data</span>
                    </div>
                    <div class="fs-right-item">
                        <span class="fs-right-icon">‚è∏Ô∏è</span>
                        <span class="fs-right-text">Restrict processing</span>
                    </div>
                    <div class="fs-right-item">
                        <span class="fs-right-icon">üö´</span>
                        <span class="fs-right-text">Object to marketing</span>
                    </div>
                    <div class="fs-right-item">
                        <span class="fs-right-icon">‚Ü©Ô∏è</span>
                        <span class="fs-right-text">Withdraw consent</span>
                    </div>
                </div>
                <div class="fs-privacy-info-box">
                    <p>üìß Contact us at <a href="mailto:info@freestays.eu"
                            style="color:#5b21b6;font-weight:600;">info@freestays.eu</a> to exercise these rights.</p>
                </div>
            </div>
        </div>

        <!-- Section 7: Cookies -->
        <div id="privacy-7" class="fs-privacy-section">
            <div class="fs-section-header">
                <div class="fs-section-num">7</div>
                <h2 class="fs-section-title">üç™ Cookies & Tracking</h2>
            </div>
            <div class="fs-privacy-content">
                <p>We use cookies to:</p>
                <ul class="fs-check-list">
                    <li>Enhance site functionality</li>
                    <li>Analyze traffic</li>
                    <li>Deliver targeted ads</li>
                </ul>
                <div class="fs-privacy-info-box">
                    <p>‚öôÔ∏è Manage preferences via browser settings or visit <a href="https://www.internetcookies.org"
                            target="_blank" style="color:#5b21b6;font-weight:600;">internetcookies.org</a></p>
                </div>
            </div>
        </div>

        <!-- Section 8: Security -->
        <div id="privacy-8" class="fs-privacy-section">
            <div class="fs-section-header">
                <div class="fs-section-num">8</div>
                <h2 class="fs-section-title">üõ°Ô∏è Security Measures</h2>
            </div>
            <div class="fs-privacy-content">
                <p>We protect data using:</p>
                <div class="fs-security-grid">
                    <div class="fs-security-item">
                        <div class="fs-security-icon">üîê</div>
                        <div class="fs-security-label">Encryption (SSL/TLS)</div>
                    </div>
                    <div class="fs-security-item">
                        <div class="fs-security-icon">üîë</div>
                        <div class="fs-security-label">Access Controls</div>
                    </div>
                    <div class="fs-security-item">
                        <div class="fs-security-icon">üîç</div>
                        <div class="fs-security-label">Regular Audits</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Card -->
        <div class="fs-privacy-contact">
            <h3>üì¨ Questions About Your Privacy?</h3>
            <p>We're here to help you understand and manage your data.</p>
            <a href="mailto:info@freestays.eu" class="fs-contact-btn">
                <span>‚úâÔ∏è</span> Contact Us at info@freestays.eu
            </a>
        </div>
    </div>

    <script>
        // Smooth scroll for TOC links
        document.querySelectorAll('.fs-privacy-toc .fs-toc-item').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    </script>
    <?php
    return ob_get_clean();
});


/**
 * FAQ Shortcode - Interactive Accordion with Search
 * Usage: [freestays_faq]
 */
add_shortcode('freestays_faq', function () {
    ob_start();

    // FAQ Data organized by category
    $faq_categories = [
        'reservations' => [
            'icon' => 'üìÖ',
            'title' => 'Reservations',
            'description' => 'Booking, modifications, and cancellations',
            'questions' => [
                ['q' => 'How do I make a booking with Freestays.eu?', 'a' => 'Visit our website, choose your destination and hotel, and complete the booking process using a valid Freestays hotel cheque code.'],
                ['q' => 'Can I book multiple rooms with one voucher?', 'a' => 'Each voucher is valid for one room. If you need multiple rooms, you\'ll need additional hotel cheques and make a second booking.'],
                ['q' => 'How can I cancel or modify my reservation?', 'a' => 'You can cancel or modify your reservation through our website or by contacting customer service. Cancellation policies vary by hotel and are outlined in your booking confirmation.'],
                ['q' => 'What is the latest I can book a room?', 'a' => 'You can book a room up to 24 hours before your intended check-in, subject to availability.'],
                ['q' => 'Can I book a room for someone else using my hotel cheque?', 'a' => 'Yes, you can book a room for another person, but make sure at check-in details match.'],
                ['q' => 'What is included in the cost of my stay?', 'a' => 'The room is complimentary with a Freestays hotel cheque. You only need to pay for breakfast and dinner, which must be settled directly with the hotel upon your booking.'],
                ['q' => 'Are there any hidden fees?', 'a' => 'No hidden fees; however, extra charges may apply for services like room service, minibar, or additional amenities, payable directly to the hotel.'],
                ['q' => 'Do I need a credit card to make a booking?', 'a' => 'Yes, a valid credit card is required to secure your booking. This card may also be used for any additional charges during your stay. We also offer iDEAL payments.'],
                ['q' => 'Is my payment information secure?', 'a' => 'Freestays.eu utilizes secure encryption technology to safeguard your payment information.'],
                ['q' => 'How do I check the status of my reservation?', 'a' => 'Log in to your Freestays.eu account and go to "My Bookings" to check the status of your reservations.'],
                ['q' => 'Can I book a stay without a Freestays hotel cheque?', 'a' => 'Yes, but you need a valid Freestays hotel cheque to book free rooms or get a discount on our platform.'],
                ['q' => 'What happens if the hotel I booked is overbooked?', 'a' => 'Please contact Freestays customer hotline service immediately. We will assist you in finding alternative accommodation.'],
                ['q' => 'How do I know if my booking is confirmed?', 'a' => 'You will receive a confirmation email with your booking details. You can also check your booking status in your Freestays.eu account.'],
                ['q' => 'Can I book for a large group?', 'a' => 'Yes, but you will need multiple hotel cheques. Please contact our customer service for assistance with group bookings.'],
                ['q' => 'Is there a minimum age requirement for booking?', 'a' => 'The main guest needs to be at least 18 years old.'],
                ['q' => 'How can I extend my stay?', 'a' => 'Contact the hotel directly to inquire about availability for an extended stay. You may require an additional hotel cheque.'],
                ['q' => 'What should I do if I lose my hotel cheque?', 'a' => 'Please contact Freestays customer service for assistance in retrieving your voucher information.'],
                ['q' => 'Can I book last-minute stays?', 'a' => 'Yes, subject to availability. Ensure you have a valid hotel cheque and check availability on our website.'],
                ['q' => 'How do I find out about special offers or promotions?', 'a' => 'Make sure to sign up for our newsletter and regularly check the "Offers" section on our website.'],
                ['q' => 'Can I book a hotel for the same day?', 'a' => 'Same-day bookings are possible, depending on availability.'],
                ['q' => 'Do I receive a booking confirmation via email?', 'a' => 'Yes, a confirmation email will be sent once your booking is completed. If you don\'t see it, please check your spam/junk folder.'],
                ['q' => 'Can I make a reservation without creating an account?', 'a' => 'Yes, you can book without creating an account. We will save your data subject to the booking you make.'],
                ['q' => 'How can I retrieve my booking details if I lose the confirmation email?', 'a' => 'Please log in to your Freestays account and go to "My Bookings" to view your booking history.'],
                ['q' => 'How do I know if my booking has special requirements or restrictions?', 'a' => 'Any specific requirements or restrictions will be detailed in the booking confirmation.'],
                ['q' => 'What happens if I arrive late at the hotel?', 'a' => 'Inform the hotel of your late arrival to ensure your room is reserved for you.'],
                ['q' => 'Can I specify my check-in and check-out times?', 'a' => 'Standard check-in and check-out times apply. Early check-in or late check-out are available upon request, subject to availability.'],
                ['q' => 'How do I change the name on my booking?', 'a' => 'Please contact customer service to update the name on your booking.'],
                ['q' => 'What should I do if I miss my check-in date?', 'a' => 'Contact the hotel as soon as possible, as policies for no-shows may differ from one hotel to another.'],
            ]
        ],
        'rooms' => [
            'icon' => 'üõèÔ∏è',
            'title' => 'Rooms & Amenities',
            'description' => 'Room types, facilities, and services',
            'questions' => [
                ['q' => 'Are there family rooms available?', 'a' => 'Remember to check if the hotel offers family rooms and its amenities before making a booking.'],
                ['q' => 'What is the maximum occupancy per room?', 'a' => 'The maximum number of people allowed in each room type and hotel may differ. Please verify during the booking process.'],
                ['q' => 'Do hotels offer babysitting services?', 'a' => 'Some hotels offer babysitting services. Please contact the hotel directly to inquire about this service.'],
                ['q' => 'Can I get an airport shuttle service?', 'a' => 'Remember to check if the hotel offers airport shuttle services by reviewing the hotel\'s amenities or contacting them directly.'],
                ['q' => 'What if I need a hypoallergenic room?', 'a' => 'Please don\'t forget to request hypoallergenic rooms when making your booking. However, please note that availability depends on the hotel.'],
                ['q' => 'Can I request a room with a specific view?', 'a' => 'Special requests for room views can be made, but they are subject to availability.'],
                ['q' => 'Are there fitness facilities at the hotel?', 'a' => 'Make sure to check the hotel\'s amenities section as many hotels offer fitness facilities.'],
                ['q' => 'Can I get a room with a kitchenette?', 'a' => 'Some hotels provide rooms with kitchenettes. Remember to review the hotel\'s amenities when making a booking.'],
                ['q' => 'Are there safety deposit boxes in the rooms?', 'a' => 'Make sure to inquire about the availability of safety deposit boxes when booking a hotel room.'],
                ['q' => 'Are there accessible rooms available?', 'a' => 'Yes, many hotels offer accessible rooms. Check the hotel\'s amenities during booking or contact the hotel directly.'],
                ['q' => 'Can I request extra amenities (e.g., cribs, rollaway beds)?', 'a' => 'Yes, request these amenities during booking or by contacting the hotel directly.'],
                ['q' => 'Is room service included in my stay?', 'a' => 'Room service is not included in the voucher and is an additional charge.'],
                ['q' => 'Are there laundry facilities available at the hotel?', 'a' => 'Many hotels offer laundry services. Check the hotel\'s amenities or inquire at the front desk.'],
                ['q' => 'Can I bring outside food and drinks into my room?', 'a' => 'The policies differ by hotel. Please contact the hotel directly for clarification.'],
                ['q' => 'Is Wi-Fi included in my stay?', 'a' => 'Most hotels offer free Wi-Fi. Please check the hotel\'s amenities for more details.'],
                ['q' => 'What is the policy on smoking in rooms?', 'a' => 'This varies by hotel. Most hotels have designated smoking and non-smoking rooms.'],
                ['q' => 'Are toiletries provided in the rooms?', 'a' => 'Yes, most hotels provide basic toiletries. Check the hotel\'s amenities for specifics.'],
                ['q' => 'Can I upgrade my room after booking?', 'a' => 'Upgrades are subject to availability and may incur additional charges. Contact the hotel directly.'],
            ]
        ],
        'vouchers' => [
            'icon' => 'üé´',
            'title' => 'Hotel Cheques & Vouchers',
            'description' => 'Using, purchasing, and managing vouchers',
            'questions' => [
                ['q' => 'How do I know the value of my hotel cheque?', 'a' => 'The value of hotel cheque is determined at the time of purchase and can be found in your Freestays account.'],
                ['q' => 'What if my hotel cheque is lost or stolen?', 'a' => 'Please report the loss to Freestays customer service for assistance.'],
                ['q' => 'Can I use a hotel cheque for multiple stays?', 'a' => 'Each hotel cheque is valid for one stay only.'],
                ['q' => 'How do I redeem a hotel cheque?', 'a' => 'Make sure to enter the hotel cheque code when you make a booking on Freestays.eu.'],
                ['q' => 'Can hotel cheques be combined with other discounts?', 'a' => 'Sorry, hotel cheques cannot be combined with any other promotions or discounts.'],
                ['q' => 'Are there any restrictions on transferring hotel cheques?', 'a' => 'Ensure the recipient\'s details are correctly updated during the booking process.'],
                ['q' => 'Can I extend the validity of my hotel cheque?', 'a' => 'The hotel cheque cannot be extended and must be used before the expiration date.'],
                ['q' => 'What if my hotel cheque code does not work?', 'a' => 'Contact Freestays customer service for assistance with hotel cheque issues.'],
                ['q' => 'Are hotel cheques available for corporate purchases?', 'a' => 'Feel free to get in touch with Freestays customer service if you need to buy vouchers in bulk or for corporate purposes.'],
                ['q' => 'How do I purchase a Freestays hotel cheque?', 'a' => 'You can buy hotel cheques directly on the Freestays.eu website.'],
                ['q' => 'Can I transfer my hotel cheque to someone else?', 'a' => 'Yes, hotel cheques can be transferred. Make sure to update the new guest\'s details when booking.'],
                ['q' => 'How do I check the validity of my hotel cheque?', 'a' => 'Log in to your Freestays.eu account and check the "My hotel cheques" section for validity details.'],
                ['q' => 'Can I combine multiple hotel cheques for a longer stay?', 'a' => 'No, each hotel cheque is valid for one stay. Additional vouchers are required for extended stays.'],
                ['q' => 'Are there any restrictions on hotel cheque use?', 'a' => 'Hotel cheques are subject to terms and conditions, including expiration dates and participating hotels.'],
                ['q' => 'How do I receive my Freestays hotel cheque after purchase?', 'a' => 'Hotel cheques are sent via email after purchase. Check your spam/junk folders if you do not receive it.'],
                ['q' => 'Can I get a refund for an unused hotel cheque?', 'a' => 'Hotel cheques are non-refundable, but they can be transferred to another person.'],
            ]
        ],
        'payments' => [
            'icon' => 'üí≥',
            'title' => 'Payments & Billing',
            'description' => 'Payment methods, invoices, and refunds',
            'questions' => [
                ['q' => 'What forms of payment are accepted for meals and additional charges?', 'a' => 'Most hotels accept credit cards, debit cards, and cash. Check with the specific hotel for their accepted payment methods.'],
                ['q' => 'Are there any taxes or additional fees I should be aware of?', 'a' => 'Local taxes and fees may be applicable, depending on the hotel and location. These will be specified during the booking process.'],
                ['q' => 'How do I receive an invoice for my stay?', 'a' => 'The hotel will issue an invoice for your meals and any additional charges upon request during check-out.'],
                ['q' => 'Can I prepay for meals and services?', 'a' => 'Prepayment policies differ among hotels. Please get in touch with the hotel directly to ask about prepayment options.'],
                ['q' => 'What happens if there are issues with my payment?', 'a' => 'Please contact the hotel\'s front desk or Freestays customer service for assistance.'],
                ['q' => 'Is there a security deposit required at check-in?', 'a' => 'Some hotels may require a security deposit. This information will be provided during the booking process.'],
                ['q' => 'Can I use multiple payment methods for one stay?', 'a' => 'Most hotels accept multiple payment methods. Please verify this with the hotel during check-in.'],
                ['q' => 'What should I do if I am charged incorrectly?', 'a' => 'Please make sure to contact the hotel\'s front desk right away if you have any issues that need to be resolved.'],
                ['q' => 'Are there discounts for longer stays?', 'a' => 'Consider contacting hotels directly to inquire about potential discounts for longer stays.'],
                ['q' => 'How are refunds processed?', 'a' => 'Refunds are processed in accordance with the hotel\'s policy and may take several days to appear in your account.'],
                ['q' => 'Are there additional costs for amenities like Wi-Fi or parking?', 'a' => 'Most hotels provide basic amenities during your stay; please review specific hotel policies for any additional costs.'],
                ['q' => 'How do I pay for additional services during my stay?', 'a' => 'Please note that any additional services will be paid directly to the hotel, typically at the time of check-out.'],
                ['q' => 'Can I split the bill for my stay with another guest?', 'a' => 'Yes, but please confirm this with the hotel at check-in.'],
                ['q' => 'Is it possible to get a detailed receipt for my stay?', 'a' => 'Make sure to ask the hotel for it when you check out.'],
                ['q' => 'What happens if there are payment issues at check-in?', 'a' => 'If you have any issues with payment, please contact Freestays customer service or your bank for assistance. But because we offer pre-payments this can not be happening.'],
                ['q' => 'Can I pay for my stay using a company credit card?', 'a' => 'Yes, but make sure to provide and authorize the cardholder\'s details for the booking.'],
            ]
        ],
        'support' => [
            'icon' => 'üÜò',
            'title' => 'Support & Issues',
            'description' => 'Getting help and resolving problems',
            'questions' => [
                ['q' => 'What should I do if I encounter an issue during my stay?', 'a' => 'Contact the hotel\'s front desk for immediate assistance. If the issue remains unresolved, reach out to Freestays customer service.'],
                ['q' => 'How do I contact Freestays customer service?', 'a' => 'You can contact us via email at customerservice@freestays.eu. For booking support, call our hotline‚Äîavailable 24/7!'],
                ['q' => 'What should I bring for check-in?', 'a' => 'Please ensure you have your valid ID and your booking confirmation with you.'],
                ['q' => 'Is there a minimum stay requirement?', 'a' => 'Some hotels may have minimum stay requirements. This information will be available for you.'],
                ['q' => 'Can I combine my stay with other promotions?', 'a' => 'Freestays hotel cheque cannot be combined with other promotions or discounts.'],
                ['q' => 'Are there blackout dates?', 'a' => 'Some hotels may have blackout dates, so make sure to check the hotel\'s availability during your planned stay.'],
                ['q' => 'What if I have a special request for my stay?', 'a' => 'Feel free to make any specific requests during the booking process or get in touch with the hotel directly.'],
                ['q' => 'Are there specific check-in and check-out times?', 'a' => 'The times vary by hotel and are listed in your booking confirmation.'],
                ['q' => 'Can I leave feedback about my stay?', 'a' => 'Please log in to your Freestays.eu account to leave a review of your stay.'],
                ['q' => 'How do I handle special medical needs during my stay?', 'a' => 'Please make sure to inform the hotel of any special medical needs when booking or during check-in.'],
                ['q' => 'Can I arrange for a late check-out?', 'a' => 'Late check-out requests are based on availability and may result in extra charges.'],
                ['q' => 'Are there multilingual staff at the hotels?', 'a' => 'It\'s a good idea to check the hotel\'s amenities for details about whether they have multilingual staff.'],
                ['q' => 'What should I do if there is an emergency during my stay?', 'a' => 'Contact the hotel\'s front desk immediately. In case of serious emergencies, call local emergency services.'],
                ['q' => 'What should I do if my room is not as described?', 'a' => 'Contact the hotel\'s front desk immediately. If the issue is not resolved, contact Freestays customer service.'],
            ]
        ],
        'account' => [
            'icon' => 'üë§',
            'title' => 'Account & Membership',
            'description' => 'Managing your Freestays account',
            'questions' => [
                ['q' => 'How can I subscribe to the Freestays newsletter?', 'a' => 'Subscribe to receive updates and special offers on the Freestays.eu website.'],
                ['q' => 'Can I earn loyalty points with Freestays?', 'a' => 'Freestays does not currently offer a loyalty program, but check back for future updates.'],
                ['q' => 'How do I find the best deals on Freestays.eu?', 'a' => 'Check our "Offers" section regularly and subscribe to our newsletter for exclusive deals.'],
                ['q' => 'Is there a mobile app for Freestays?', 'a' => 'Freestays does not currently offer a mobile app. Bookings can be made through our website.'],
                ['q' => 'What languages are supported by Freestays customer service?', 'a' => 'Customer service is available in multiple languages including English, Dutch, German, French, and Turkish.'],
                ['q' => 'Can I book multiple rooms under one account?', 'a' => 'Yes, you will need separate hotel cheques for each room.'],
                ['q' => 'Are there any special packages or deals for holidays?', 'a' => 'Make sure to visit the "Offers" section on our website for holiday packages and special deals.'],
                ['q' => 'How do I update my personal information in my Freestays account?', 'a' => 'Remember to log in to your account and then navigate to "Account Settings" in order to update your information.'],
                ['q' => 'What is Freestays\' cancellation policy?', 'a' => 'The cancellation policies differ by hotel and will be provided in your booking confirmation.'],
                ['q' => 'How do I sign up for Freestays?', 'a' => 'Visit Freestays.eu and click on "Sign Up" to create an account.'],
                ['q' => 'Can I book accommodation for longer stays (e.g., month-long stays)?', 'a' => 'For longer stays, please reach out to customer service to make special arrangements and to get information about hotel cheque requirements.'],
            ]
        ],
    ];

    // Count total questions
    $total_questions = 0;
    foreach ($faq_categories as $cat) {
        $total_questions += count($cat['questions']);
    }
    ?>
    <style>
        .fs-faq-page {
            --fs-primary: #2563eb;
            --fs-primary-dark: #1d4ed8;
            --fs-primary-light: #dbeafe;
            --fs-secondary: #7c3aed;
            --fs-text: #1f2937;
            --fs-text-light: #6b7280;
            --fs-bg: #f8fafc;
            --fs-white: #ffffff;
            --fs-border: #e5e7eb;
            --fs-gradient: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
            --fs-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --fs-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --fs-radius: 16px;
            --fs-radius-sm: 8px;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px 80px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .fs-faq-hero {
            background: var(--fs-gradient);
            border-radius: var(--fs-radius);
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .fs-faq-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .fs-faq-hero h1 {
            color: var(--fs-white);
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800;
            margin: 0 0 16px;
            position: relative;
            z-index: 1;
        }

        .fs-faq-hero .fs-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            margin: 0 0 24px;
            position: relative;
            z-index: 1;
        }

        .fs-faq-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            position: relative;
            z-index: 1;
        }

        .fs-faq-stat-num {
            font-size: 36px;
            font-weight: 800;
            color: var(--fs-white);
        }

        .fs-faq-stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .fs-faq-search {
            background: var(--fs-white);
            border-radius: var(--fs-radius);
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: var(--fs-shadow);
            border: 1px solid var(--fs-border);
        }

        .fs-faq-search-inner {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }

        .fs-faq-search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--fs-text-light);
        }

        .fs-faq-search input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            font-size: 16px;
            border: 2px solid var(--fs-border);
            border-radius: 50px;
            outline: none;
            transition: all 0.3s ease;
        }

        .fs-faq-search input:focus {
            border-color: var(--fs-primary);
            box-shadow: 0 0 0 4px var(--fs-primary-light);
        }

        .fs-faq-search-results {
            text-align: center;
            margin-top: 12px;
            font-size: 14px;
            color: var(--fs-text-light);
            display: none;
        }

        .fs-faq-search-results.active {
            display: block;
        }

        .fs-faq-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 40px;
        }

        .fs-faq-cat-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 16px;
            background: var(--fs-white);
            border: 2px solid var(--fs-border);
            border-radius: var(--fs-radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--fs-text);
        }

        .fs-faq-cat-btn:hover,
        .fs-faq-cat-btn.active {
            border-color: var(--fs-primary);
            background: var(--fs-primary-light);
            transform: translateY(-2px);
        }

        .fs-faq-cat-btn.active {
            background: var(--fs-primary);
            color: var(--fs-white);
        }

        .fs-faq-cat-icon {
            font-size: 28px;
        }

        .fs-faq-cat-label {
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }

        .fs-faq-cat-count {
            font-size: 11px;
            color: var(--fs-text-light);
            background: var(--fs-bg);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .fs-faq-cat-btn.active .fs-faq-cat-count {
            background: rgba(255, 255, 255, 0.2);
            color: var(--fs-white);
        }

        .fs-faq-section {
            margin-bottom: 32px;
        }

        .fs-faq-section-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--fs-border);
        }

        .fs-faq-section-icon {
            width: 48px;
            height: 48px;
            background: var(--fs-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .fs-faq-section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--fs-text);
            margin: 0;
        }

        .fs-faq-section-desc {
            font-size: 14px;
            color: var(--fs-text-light);
            margin: 4px 0 0;
        }

        .fs-faq-item {
            background: var(--fs-white);
            border: 1px solid var(--fs-border);
            border-radius: var(--fs-radius-sm);
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .fs-faq-item:hover {
            box-shadow: var(--fs-shadow);
        }

        .fs-faq-item.hidden {
            display: none;
        }

        .fs-faq-question {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--fs-text);
            background: transparent;
            transition: all 0.3s ease;
        }

        .fs-faq-question:hover {
            background: var(--fs-bg);
        }

        .fs-faq-question-text {
            flex: 1;
            padding-right: 16px;
        }

        .fs-faq-toggle {
            width: 32px;
            height: 32px;
            background: var(--fs-primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--fs-primary);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .fs-faq-item.open .fs-faq-toggle {
            background: var(--fs-primary);
            color: var(--fs-white);
            transform: rotate(45deg);
        }

        .fs-faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .fs-faq-item.open .fs-faq-answer {
            max-height: 500px;
        }

        .fs-faq-answer-inner {
            padding: 0 24px 24px;
            font-size: 15px;
            line-height: 1.8;
            color: var(--fs-text-light);
            border-top: 1px solid var(--fs-border);
            padding-top: 20px;
        }

        .fs-faq-no-results {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .fs-faq-no-results.active {
            display: block;
        }

        .fs-faq-no-results-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .fs-faq-no-results h3 {
            font-size: 20px;
            color: var(--fs-text);
            margin: 0 0 8px;
        }

        .fs-faq-no-results p {
            color: var(--fs-text-light);
            margin: 0;
        }

        .fs-faq-contact {
            background: var(--fs-gradient);
            border-radius: var(--fs-radius);
            padding: 40px;
            text-align: center;
            margin-top: 40px;
            color: var(--fs-white);
        }

        .fs-faq-contact h3 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px;
            color: var(--fs-white);
        }

        .fs-faq-contact p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 24px;
        }

        .fs-faq-contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--fs-white);
            color: var(--fs-primary);
            padding: 14px 28px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: var(--fs-shadow);
        }

        .fs-faq-contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--fs-shadow-lg);
        }

        @media (max-width: 768px) {
            .fs-faq-page {
                padding: 20px 16px 60px;
            }

            .fs-faq-hero {
                padding: 40px 24px;
            }

            .fs-faq-stats {
                flex-direction: column;
                gap: 16px;
            }

            .fs-faq-categories {
                grid-template-columns: repeat(3, 1fr);
            }

            .fs-faq-cat-btn {
                padding: 16px 12px;
            }

            .fs-faq-cat-label {
                font-size: 11px;
            }

            .fs-faq-section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .fs-faq-question {
                padding: 16px;
            }

            .fs-faq-answer-inner {
                padding: 0 16px 16px;
            }

            .fs-faq-contact {
                padding: 32px 24px;
            }
        }
    </style>

    <div class="fs-faq-page">
        <div class="fs-faq-hero">
            <h1>‚ùì Frequently Asked Questions</h1>
            <p class="fs-subtitle">Find answers to common questions about Freestays</p>
            <div class="fs-faq-stats">
                <div class="fs-faq-stat">
                    <div class="fs-faq-stat-num"><?php echo $total_questions; ?></div>
                    <div class="fs-faq-stat-label">Questions Answered</div>
                </div>
                <div class="fs-faq-stat">
                    <div class="fs-faq-stat-num"><?php echo count($faq_categories); ?></div>
                    <div class="fs-faq-stat-label">Categories</div>
                </div>
                <div class="fs-faq-stat">
                    <div class="fs-faq-stat-num">24/7</div>
                    <div class="fs-faq-stat-label">Support Available</div>
                </div>
            </div>
        </div>

        <div class="fs-faq-search">
            <div class="fs-faq-search-inner">
                <span class="fs-faq-search-icon">üîç</span>
                <input type="text" id="faq-search" placeholder="Search for answers... (e.g., 'cancel booking', 'voucher')">
            </div>
            <div class="fs-faq-search-results" id="faq-search-results">
                Showing <span id="faq-result-count">0</span> results
            </div>
        </div>

        <div class="fs-faq-categories">
            <button class="fs-faq-cat-btn active" data-category="all">
                <span class="fs-faq-cat-icon">üìö</span>
                <span class="fs-faq-cat-label">All Questions</span>
                <span class="fs-faq-cat-count"><?php echo $total_questions; ?></span>
            </button>
            <?php foreach ($faq_categories as $key => $cat): ?>
                <button class="fs-faq-cat-btn" data-category="<?php echo $key; ?>">
                    <span class="fs-faq-cat-icon"><?php echo $cat['icon']; ?></span>
                    <span class="fs-faq-cat-label"><?php echo $cat['title']; ?></span>
                    <span class="fs-faq-cat-count"><?php echo count($cat['questions']); ?></span>
                </button>
            <?php endforeach; ?>
        </div>

        <div class="fs-faq-no-results" id="faq-no-results">
            <div class="fs-faq-no-results-icon">üîç</div>
            <h3>No results found</h3>
            <p>Try different keywords or browse by category</p>
        </div>

        <?php foreach ($faq_categories as $key => $cat): ?>
            <div class="fs-faq-section" data-section="<?php echo $key; ?>">
                <div class="fs-faq-section-header">
                    <div class="fs-faq-section-icon"><?php echo $cat['icon']; ?></div>
                    <div>
                        <h2 class="fs-faq-section-title"><?php echo $cat['title']; ?></h2>
                        <p class="fs-faq-section-desc"><?php echo $cat['description']; ?></p>
                    </div>
                </div>
                <?php foreach ($cat['questions'] as $faq): ?>
                    <div class="fs-faq-item" data-category="<?php echo $key; ?>">
                        <div class="fs-faq-question">
                            <span class="fs-faq-question-text"><?php echo esc_html($faq['q']); ?></span>
                            <span class="fs-faq-toggle">+</span>
                        </div>
                        <div class="fs-faq-answer">
                            <div class="fs-faq-answer-inner"><?php echo esc_html($faq['a']); ?></div>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        <?php endforeach; ?>

        <div class="fs-faq-contact">
            <h3>ü§î Still have questions?</h3>
            <p>Our support team is available 24/7 to help you</p>
            <a href="mailto:customerservice@freestays.eu" class="fs-faq-contact-btn">
                <span>‚úâÔ∏è</span> Contact Support
            </a>
        </div>
    </div>

    <script>
        (function () {
            document.querySelectorAll('.fs-faq-question').forEach(q => {
                q.addEventListener('click', function () {
                    const item = this.closest('.fs-faq-item');
                    const wasOpen = item.classList.contains('open');
                    document.querySelectorAll('.fs-faq-item').forEach(i => i.classList.remove('open'));
                    if (!wasOpen) item.classList.add('open');
                });
            });

            document.querySelectorAll('.fs-faq-cat-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const cat = this.dataset.category;
                    document.querySelectorAll('.fs-faq-cat-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('faq-search').value = '';
                    document.getElementById('faq-search-results').classList.remove('active');
                    document.getElementById('faq-no-results').classList.remove('active');
                    document.querySelectorAll('.fs-faq-section').forEach(s => {
                        s.style.display = (cat === 'all' || s.dataset.section === cat) ? 'block' : 'none';
                    });
                    document.querySelectorAll('.fs-faq-item').forEach(i => i.classList.remove('hidden'));
                });
            });

            const searchInput = document.getElementById('faq-search');
            searchInput.addEventListener('input', function () {
                const q = this.value.toLowerCase().trim();
                if (q.length < 2) {
                    document.querySelectorAll('.fs-faq-section').forEach(s => s.style.display = 'block');
                    document.querySelectorAll('.fs-faq-item').forEach(i => i.classList.remove('hidden'));
                    document.getElementById('faq-search-results').classList.remove('active');
                    document.getElementById('faq-no-results').classList.remove('active');
                    return;
                }
                document.querySelectorAll('.fs-faq-cat-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.fs-faq-cat-btn[data-category="all"]').classList.add('active');
                document.querySelectorAll('.fs-faq-section').forEach(s => s.style.display = 'block');
                let count = 0;
                document.querySelectorAll('.fs-faq-item').forEach(item => {
                    const question = item.querySelector('.fs-faq-question-text').textContent.toLowerCase();
                    const answer = item.querySelector('.fs-faq-answer-inner').textContent.toLowerCase();
                    if (question.includes(q) || answer.includes(q)) {
                        item.classList.remove('hidden');
                        count++;
                    } else {
                        item.classList.add('hidden');
                    }
                });
                document.querySelectorAll('.fs-faq-section').forEach(s => {
                    s.style.display = s.querySelectorAll('.fs-faq-item:not(.hidden)').length > 0 ? 'block' : 'none';
                });
                document.getElementById('faq-result-count').textContent = count;
                document.getElementById('faq-search-results').classList.add('active');
                document.getElementById('faq-no-results').classList[count === 0 ? 'add' : 'remove']('active');
            });
        })();
    </script>
    <?php
    return ob_get_clean();
});


/**
 * About Us / Wie Wij Zijn Shortcode
 * Usage: [freestays_about]
 */
add_shortcode('freestays_about', function () {
    // Image paths - update these when images are uploaded
    $img_base = '/wp-content/uploads/freestays-pages/';

    ob_start();
    ?>
    <style>
        .fs-about-page {
            --fs-primary: #2563eb;
            --fs-primary-dark: #1d4ed8;
            --fs-primary-light: #dbeafe;
            --fs-secondary: #7c3aed;
            --fs-accent: #f59e0b;
            --fs-success: #10b981;
            --fs-text: #1f2937;
            --fs-text-light: #6b7280;
            --fs-bg: #f8fafc;
            --fs-white: #ffffff;
            --fs-border: #e5e7eb;
            --fs-gradient: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            --fs-gradient-warm: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            --fs-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --fs-shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --fs-radius: 20px;
            --fs-radius-sm: 12px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--fs-text);
        }

        /* Hero Section */
        .fs-about-hero {
            background: var(--fs-gradient);
            padding: 80px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .fs-about-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="rgba(255,255,255,0.05)"/></svg>');
            background-size: 200px;
            opacity: 0.5;
        }

        .fs-about-hero-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .fs-about-hero h1 {
            font-size: clamp(32px, 6vw, 56px);
            font-weight: 800;
            color: var(--fs-white);
            margin: 0 0 20px;
            line-height: 1.2;
        }

        .fs-about-hero h1 span {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .fs-about-hero .fs-tagline {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 32px;
        }

        .fs-about-hero-btns {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .fs-btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--fs-white);
            color: var(--fs-primary);
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: var(--fs-shadow);
        }

        .fs-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--fs-shadow-lg);
        }

        .fs-btn-secondary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: var(--fs-white);
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 16px;
            text-decoration: none;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .fs-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .fs-hero-trust {
            display: flex;
            gap: 24px;
            justify-content: center;
            flex-wrap: wrap;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .fs-hero-trust span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Welcome Section */
        .fs-about-welcome {
            max-width: 1000px;
            margin: 0 auto;
            padding: 80px 20px;
        }

        .fs-about-welcome-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .fs-about-welcome-header h2 {
            font-size: 36px;
            font-weight: 800;
            margin: 0 0 16px;
            background: var(--fs-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .fs-about-welcome-header p {
            font-size: 18px;
            color: var(--fs-text-light);
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.8;
        }

        /* Benefits Grid */
        .fs-benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 48px 0;
        }

        .fs-benefit-card {
            background: var(--fs-white);
            border-radius: var(--fs-radius-sm);
            padding: 28px;
            box-shadow: var(--fs-shadow);
            border: 1px solid var(--fs-border);
            transition: all 0.3s ease;
        }

        .fs-benefit-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--fs-shadow-lg);
        }

        .fs-benefit-icon {
            width: 56px;
            height: 56px;
            background: var(--fs-primary-light);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 16px;
        }

        .fs-benefit-card h3 {
            font-size: 18px;
            font-weight: 700;
            margin: 0 0 8px;
            color: var(--fs-text);
        }

        .fs-benefit-card p {
            font-size: 14px;
            color: var(--fs-text-light);
            margin: 0;
            line-height: 1.6;
        }

        /* What We Offer Section */
        .fs-about-offers {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 80px 20px;
        }

        .fs-about-offers-inner {
            max-width: 1000px;
            margin: 0 auto;
        }

        .fs-about-offers h2 {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            margin: 0 0 48px;
            color: var(--fs-text);
        }

        .fs-offers-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .fs-offer-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            background: var(--fs-white);
            padding: 20px;
            border-radius: var(--fs-radius-sm);
            box-shadow: var(--fs-shadow);
        }

        .fs-offer-check {
            width: 28px;
            height: 28px;
            background: var(--fs-success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--fs-white);
            font-size: 14px;
            flex-shrink: 0;
        }

        .fs-offer-text {
            font-size: 15px;
            color: var(--fs-text);
            font-weight: 500;
        }

        /* Traveler Types Section */
        .fs-about-travelers {
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 20px;
        }

        .fs-about-travelers h2 {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            margin: 0 0 48px;
        }

        .fs-traveler-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .fs-traveler-card {
            background: var(--fs-white);
            border-radius: var(--fs-radius);
            overflow: hidden;
            box-shadow: var(--fs-shadow-lg);
            transition: all 0.3s ease;
        }

        .fs-traveler-card:hover {
            transform: translateY(-8px);
        }

        .fs-traveler-img {
            height: 200px;
            background: var(--fs-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
        }

        .fs-traveler-card:nth-child(1) .fs-traveler-img {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        }

        .fs-traveler-card:nth-child(2) .fs-traveler-img {
            background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
        }

        .fs-traveler-card:nth-child(3) .fs-traveler-img {
            background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
        }

        .fs-traveler-content {
            padding: 24px;
            text-align: center;
        }

        .fs-traveler-content h3 {
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 8px;
        }

        .fs-traveler-content p {
            font-size: 14px;
            color: var(--fs-text-light);
            margin: 0 0 16px;
        }

        .fs-traveler-btn {
            display: inline-block;
            background: var(--fs-primary);
            color: var(--fs-white);
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .fs-traveler-btn:hover {
            background: var(--fs-primary-dark);
        }

        /* Testimonials Section */
        .fs-about-testimonials {
            background: var(--fs-text);
            padding: 80px 20px;
        }

        .fs-about-testimonials-inner {
            max-width: 1200px;
            margin: 0 auto;
        }

        .fs-about-testimonials h2 {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            color: var(--fs-white);
            margin: 0 0 48px;
        }

        .fs-testimonials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .fs-testimonial-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--fs-radius-sm);
            padding: 28px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fs-testimonial-stars {
            color: #fbbf24;
            font-size: 18px;
            margin-bottom: 16px;
        }

        .fs-testimonial-text {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.7;
            margin-bottom: 20px;
            font-style: italic;
        }

        .fs-testimonial-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fs-testimonial-avatar {
            width: 44px;
            height: 44px;
            background: var(--fs-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--fs-white);
        }

        .fs-testimonial-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--fs-white);
        }

        .fs-testimonial-location {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Pricing Section */
        .fs-about-pricing {
            max-width: 1000px;
            margin: 0 auto;
            padding: 80px 20px;
        }

        .fs-about-pricing h2 {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            margin: 0 0 16px;
        }

        .fs-about-pricing>p {
            text-align: center;
            font-size: 18px;
            color: var(--fs-text-light);
            margin: 0 0 48px;
        }

        .fs-pricing-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .fs-pricing-card {
            background: var(--fs-white);
            border-radius: var(--fs-radius);
            padding: 36px;
            box-shadow: var(--fs-shadow-lg);
            border: 2px solid var(--fs-border);
            position: relative;
        }

        .fs-pricing-card.featured {
            border-color: var(--fs-primary);
            transform: scale(1.02);
        }

        .fs-pricing-badge {
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--fs-gradient-warm);
            color: var(--fs-white);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fs-pricing-header {
            text-align: center;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--fs-border);
            margin-bottom: 24px;
        }

        .fs-pricing-title {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 16px;
        }

        .fs-pricing-price {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 8px;
        }

        .fs-pricing-amount {
            font-size: 48px;
            font-weight: 800;
            color: var(--fs-primary);
        }

        .fs-pricing-original {
            font-size: 24px;
            color: var(--fs-text-light);
            text-decoration: line-through;
        }

        .fs-pricing-features {
            list-style: none;
            padding: 0;
            margin: 0 0 28px;
        }

        .fs-pricing-features li {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
            font-size: 14px;
            color: var(--fs-text);
        }

        .fs-pricing-features li::before {
            content: '‚úÖ';
            font-size: 14px;
        }

        .fs-pricing-btn {
            display: block;
            width: 100%;
            text-align: center;
            background: var(--fs-primary);
            color: var(--fs-white);
            padding: 16px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .fs-pricing-btn:hover {
            background: var(--fs-primary-dark);
            transform: translateY(-2px);
        }

        .fs-pricing-card.featured .fs-pricing-btn {
            background: var(--fs-gradient);
        }

        .fs-pricing-note {
            text-align: center;
            font-size: 13px;
            color: var(--fs-text-light);
            margin-top: 12px;
        }

        /* Company Info Section */
        .fs-about-company {
            background: var(--fs-bg);
            padding: 60px 20px;
        }

        .fs-about-company-inner {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
            text-align: center;
        }

        .fs-company-item h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--fs-text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 12px;
        }

        .fs-company-item p {
            font-size: 15px;
            color: var(--fs-text);
            margin: 0;
            line-height: 1.6;
        }

        .fs-company-item a {
            color: var(--fs-primary);
            text-decoration: none;
        }

        .fs-company-item a:hover {
            text-decoration: underline;
        }

        /* Important Notes */
        .fs-about-notes {
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        .fs-notes-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: var(--fs-radius-sm);
            padding: 28px;
            border-left: 4px solid var(--fs-accent);
        }

        .fs-notes-box h3 {
            font-size: 18px;
            font-weight: 700;
            color: #92400e;
            margin: 0 0 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fs-notes-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .fs-notes-box ul li {
            padding: 8px 0;
            font-size: 14px;
            color: #92400e;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .fs-notes-box ul li::before {
            content: '‚ö†Ô∏è';
        }

        /* Responsive */
        @media (max-width: 768px) {
            .fs-about-hero {
                padding: 60px 20px;
            }

            .fs-about-hero h1 {
                font-size: 32px;
            }

            .fs-about-hero-btns {
                flex-direction: column;
                align-items: center;
            }

            .fs-hero-trust {
                flex-direction: column;
                gap: 12px;
            }

            .fs-traveler-cards {
                grid-template-columns: 1fr;
            }

            .fs-pricing-cards {
                grid-template-columns: 1fr;
            }

            .fs-pricing-card.featured {
                transform: none;
            }

            .fs-about-company-inner {
                grid-template-columns: 1fr;
                gap: 32px;
            }
        }
    </style>

    <div class="fs-about-page">
        <!-- Hero Section -->
        <section class="fs-about-hero">
            <div class="fs-about-hero-content">
                <h1>Pay only for meals, <span>not rooms</span>.</h1>
                <p class="fs-tagline">Access 450,000+ premium hotels worldwide. No hidden fees. No booking commissions.</p>
                <div class="fs-about-hero-btns">
                    <a href="/winkel/" class="fs-btn-primary">üé´ Get One-Time Voucher ‚Äì ‚Ç¨29,95</a>
                    <a href="/winkel/" class="fs-btn-secondary">üåü Unlimited Annual Card ‚Äì ‚Ç¨99</a>
                </div>
                <div class="fs-hero-trust">
                    <span>üîí Instant Delivery</span>
                    <span>‚úÖ Trusted by 15,000+ Users</span>
                    <span>üïê 24/7 Support</span>
                </div>
            </div>
        </section>

        <!-- Welcome Section -->
        <section class="fs-about-welcome">
            <div class="fs-about-welcome-header">
                <h2>üè® Join Freestays: Dine at the hotel - Stay for free!</h2>
                <p>Welcome to Freestays, the innovative hospitality concept that's redefining the way we travel. Located in
                    the heart of the Netherlands, Barneveld, our company has been a pioneer in the industry since 1996,
                    starting as a licensee in Germany.</p>
            </div>

            <p
                style="text-align:center;font-size:16px;color:var(--fs-text-light);max-width:800px;margin:0 auto 48px;line-height:1.8;">
                With a unique approach that offers free stays at partner hotels in exchange for breakfast and dinner,
                Freestays is the perfect choice for travel enthusiasts looking for an affordable and exciting experience.
                And with our growing list of top destinations and discount options, including discount coupons and Freestays
                vouchers, you'll have endless opportunities to explore the world without breaking the bank.
            </p>

            <!-- Benefits Grid -->
            <h3 style="text-align:center;font-size:24px;font-weight:700;margin-bottom:32px;">‚ú® Experience the freedom to
                travel with Freestays vouchers!</h3>
            <div class="fs-benefits-grid">
                <div class="fs-benefit-card">
                    <div class="fs-benefit-icon">üí∞</div>
                    <h3>Cost-effective</h3>
                    <p>By paying only for meals, you can save money on accommodation costs and stretch your travel budget
                        further.</p>
                </div>
                <div class="fs-benefit-card">
                    <div class="fs-benefit-icon">üåç</div>
                    <h3>Endless Destinations</h3>
                    <p>Access to a range of top destinations and partner hotels, giving you the freedom to explore new
                        places and cultures.</p>
                </div>
                <div class="fs-benefit-card">
                    <div class="fs-benefit-icon">üìÖ</div>
                    <h3>Flexibility</h3>
                    <p>Choose from one-time stays or annual subscriptions, allowing you to plan your travels around your
                        schedule.</p>
                </div>
                <div class="fs-benefit-card">
                    <div class="fs-benefit-icon">üéÅ</div>
                    <h3>Thoughtful Gifts</h3>
                    <p>Freestays vouchers make a unique and thoughtful gift for friends and family members who love to
                        travel.</p>
                </div>
                <div class="fs-benefit-card">
                    <div class="fs-benefit-icon">üìã</div>
                    <h3>Practicality</h3>
                    <p>Factor in additional expenses like meals, transport, and other incidentals when planning your trip.
                    </p>
                </div>
            </div>
        </section>

        <!-- Important Notes -->
        <section class="fs-about-notes">
            <div class="fs-notes-box">
                <h3>üìå Before using Freestays vouchers, consider:</h3>
                <ul>
                    <li><strong>Limited availability:</strong> Popular hotels may have limited availability, so plan ahead.
                    </li>
                    <li><strong>Usage Restrictions:</strong> Check for blackout dates or restrictions to ensure your voucher
                        can be used when and where you want.</li>
                </ul>
            </div>
        </section>

        <!-- What We Offer Section -->
        <section class="fs-about-offers">
            <div class="fs-about-offers-inner">
                <h2>üéØ What Freestays.eu Offers</h2>
                <div class="fs-offers-list">
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">Free hotel nights with half board or all-inclusive bookings</span>
                    </div>
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">Up to 50% discount on regular (room-only) stays</span>
                    </div>
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">Access to over 450,000 partner hotels worldwide</span>
                    </div>
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">Instant digital delivery of your hotel voucher</span>
                    </div>
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">Valid for 12 months ‚Äì flexible, no obligations</span>
                    </div>
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">Exclusive deals and room upgrades</span>
                    </div>
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">Family sharing included with the Annual Card (up to 4 people)</span>
                    </div>
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">Choose between one-time or unlimited bookings</span>
                    </div>
                    <div class="fs-offer-item">
                        <span class="fs-offer-check">‚úì</span>
                        <span class="fs-offer-text">24/7 Booking Support ‚Äì Always Available by Phone</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Traveler Types Section -->
        <section class="fs-about-travelers">
            <h2>üß≥ Perfect for Every Type of Traveler</h2>
            <div class="fs-traveler-cards">
                <div class="fs-traveler-card">
                    <div class="fs-traveler-img">üéâ</div>
                    <div class="fs-traveler-content">
                        <h3>Adventure & Nightlife</h3>
                        <p>Explore vibrant nightlife & meet new friends around Europe</p>
                        <a href="https://www.shorttrips.eu/belevenissen/" class="fs-traveler-btn">Start Your Adventure</a>
                    </div>
                </div>
                <div class="fs-traveler-card">
                    <div class="fs-traveler-img">‚ù§Ô∏è</div>
                    <div class="fs-traveler-content">
                        <h3>Romantic Escapes</h3>
                        <p>Surprise your partner with unforgettable luxury and charm</p>
                        <a href="#" class="fs-traveler-btn">Plan Romance</a>
                    </div>
                </div>
                <div class="fs-traveler-card">
                    <div class="fs-traveler-img">üë®‚Äçüë©‚Äçüëß</div>
                    <div class="fs-traveler-content">
                        <h3>Family Getaways</h3>
                        <p>Family sharing included with the Annual Card (up to 4 persons)</p>
                        <a href="#" class="fs-traveler-btn">Secure Family Trip</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Testimonials Section -->
        <section class="fs-about-testimonials">
            <div class="fs-about-testimonials-inner">
                <h2>üí¨ Trusted by Travelers</h2>
                <div class="fs-testimonials-grid">
                    <div class="fs-testimonial-card">
                        <div class="fs-testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                        <p class="fs-testimonial-text">"Incredible service! Saved ‚Ç¨250 on my Rome trip. The hotels were
                            exactly as promised. Luxury for free!"</p>
                        <div class="fs-testimonial-author">
                            <div class="fs-testimonial-avatar">S</div>
                            <div>
                                <div class="fs-testimonial-name">Sophie M.</div>
                                <div class="fs-testimonial-location">üá©üá™ Germany</div>
                            </div>
                        </div>
                    </div>
                    <div class="fs-testimonial-card">
                        <div class="fs-testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                        <p class="fs-testimonial-text">"Used it 3 times already! Perfect for my business travels. No hidden
                            fees, amazing hotels."</p>
                        <div class="fs-testimonial-author">
                            <div class="fs-testimonial-avatar">M</div>
                            <div>
                                <div class="fs-testimonial-name">Marco R.</div>
                                <div class="fs-testimonial-location">üáÆüáπ Italy</div>
                            </div>
                        </div>
                    </div>
                    <div class="fs-testimonial-card">
                        <div class="fs-testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                        <p class="fs-testimonial-text">"Family vacation was affordable. Each travel code saved us the
                            savings. Highly recommend!"</p>
                        <div class="fs-testimonial-author">
                            <div class="fs-testimonial-avatar">E</div>
                            <div>
                                <div class="fs-testimonial-name">Emma L.</div>
                                <div class="fs-testimonial-location">üá™üá∏ Spain</div>
                            </div>
                        </div>
                    </div>
                    <div class="fs-testimonial-card">
                        <div class="fs-testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                        <p class="fs-testimonial-text">"Solo traveler here ‚Äì met amazing people and saved real money.
                            Customer support is excellent."</p>
                        <div class="fs-testimonial-author">
                            <div class="fs-testimonial-avatar">H</div>
                            <div>
                                <div class="fs-testimonial-name">Hans K.</div>
                                <div class="fs-testimonial-location">üá©üá™ Germany</div>
                            </div>
                        </div>
                    </div>
                    <div class="fs-testimonial-card">
                        <div class="fs-testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê</div>
                        <p class="fs-testimonial-text">"Romantic getaway made perfect! Beautiful hotel, my room booked, and
                            the price was unbeatable."</p>
                        <div class="fs-testimonial-author">
                            <div class="fs-testimonial-avatar">A</div>
                            <div>
                                <div class="fs-testimonial-name">Anna S.</div>
                                <div class="fs-testimonial-location">üá´üá∑ France</div>
                            </div>
                        </div>
                    </div>
                    <div class="fs-testimonial-card">
                        <div class="fs-testimonial-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                        <p class="fs-testimonial-text">"450,000+ hotels to choose from. Found perfect spot in Barcelona and
                            Paris. Will use again."</p>
                        <div class="fs-testimonial-author">
                            <div class="fs-testimonial-avatar">C</div>
                            <div>
                                <div class="fs-testimonial-name">Carlos F.</div>
                                <div class="fs-testimonial-location">üá™üá∏ Spain</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Pricing Section -->
        <section class="fs-about-pricing">
            <h2>üõí Order now and book your Freestays instantly!</h2>
            <p>Choose the plan that fits your travel style</p>

            <div class="fs-pricing-cards">
                <div class="fs-pricing-card">
                    <div class="fs-pricing-header">
                        <h3 class="fs-pricing-title">One-Time Hotel Voucher</h3>
                        <div class="fs-pricing-price">
                            <span class="fs-pricing-amount">‚Ç¨35</span>
                        </div>
                    </div>
                    <ul class="fs-pricing-features">
                        <li>1x free hotel night for 2 people</li>
                        <li>Access to 450,000+ hotels</li>
                        <li>Instant digital delivery</li>
                        <li>Valid for 12 months</li>
                        <li>No booking fees</li>
                        <li>24/7 support</li>
                    </ul>
                    <a href="/winkel/" class="fs-pricing-btn">Order Now ‚Äì ‚Ç¨35,00</a>
                    <p class="fs-pricing-note">Join 15,000+ satisfied travelers</p>
                </div>

                <div class="fs-pricing-card featured">
                    <span class="fs-pricing-badge">üî• Most Popular ‚Äì Save 57%</span>
                    <div class="fs-pricing-header">
                        <h3 class="fs-pricing-title">Annual Unlimited Card</h3>
                        <div class="fs-pricing-price">
                            <span class="fs-pricing-amount">‚Ç¨129</span>
                            <span class="fs-pricing-original">‚Ç¨299</span>
                        </div>
                    </div>
                    <ul class="fs-pricing-features">
                        <li>Unlimited overnight stays (1 per trip)</li>
                        <li>Extra hotel deals & VIP upgrades</li>
                        <li>Mobile app access</li>
                        <li>Access to exclusive hotels</li>
                        <li>Family sharing (up to 4 people)</li>
                        <li>Priority customer support</li>
                        <li>Cancel anytime</li>
                    </ul>
                    <a href="/winkel/" class="fs-pricing-btn">Activate Annual Membership ‚Äì ‚Ç¨129,00</a>
                    <p class="fs-pricing-note">‚è∞ Offer expires in 3 days</p>
                </div>
            </div>
        </section>

        <!-- Company Info Section -->
        <section class="fs-about-company">
            <div class="fs-about-company-inner">
                <div class="fs-company-item">
                    <h4>üè¢ Chamber of Commerce</h4>
                    <p>NL - Amersfoort: 76305821</p>
                </div>
                <div class="fs-company-item">
                    <h4>üìç Address</h4>
                    <p>Veemweg 29-31<br>3771 MT Barneveld</p>
                </div>
                <div class="fs-company-item">
                    <h4>üìû Legal & Contact</h4>
                    <p>
                        <a href="/terms-conditions">Our Terms and Conditions</a><br>
                        <a href="mailto:info@freestays.eu">info@freestays.eu</a><br>
                        <a href="/privacy-policy">Our Privacy Policy</a>
                    </p>
                </div>
            </div>
        </section>
    </div>
    <?php
    return ob_get_clean();
});


/**
 * How It Works Shortcode - Interactive & Animated
 * Usage: [freestays_how_it_works]
 */
add_shortcode('freestays_how_it_works', function () {
    ob_start();
    ?>
    <style>
        .fs-hiw-page {
            --fs-primary: #2563eb;
            --fs-primary-dark: #1d4ed8;
            --fs-primary-light: #dbeafe;
            --fs-secondary: #7c3aed;
            --fs-accent: #f59e0b;
            --fs-success: #10b981;
            --fs-text: #1f2937;
            --fs-text-light: #6b7280;
            --fs-bg: #f8fafc;
            --fs-white: #ffffff;
            --fs-border: #e5e7eb;
            --fs-gradient: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            --fs-gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --fs-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --fs-shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            --fs-radius: 24px;
            --fs-radius-sm: 16px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
        }

        /* Hero Section with Floating Elements */
        .fs-hiw-hero {
            background: var(--fs-gradient);
            padding: 100px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .fs-hiw-hero::before {
            content: '';
            position: absolute;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            top: -200px;
            right: -200px;
            animation: float 8s ease-in-out infinite;
        }

        .fs-hiw-hero::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 70%);
            bottom: -100px;
            left: -100px;
            animation: float 6s ease-in-out infinite reverse;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-30px) rotate(5deg);
            }
        }

        .fs-hiw-hero-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .fs-hiw-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 50px;
            color: var(--fs-white);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 24px;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fs-hiw-hero h1 {
            font-size: clamp(36px, 7vw, 64px);
            font-weight: 800;
            color: var(--fs-white);
            margin: 0 0 24px;
            line-height: 1.1;
            animation: slideUp 0.8s ease-out 0.2s both;
        }

        .fs-hiw-hero h1 .highlight {
            background: var(--fs-gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fs-hiw-hero p {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
            max-width: 700px;
            margin: 0 auto 32px;
            line-height: 1.7;
            animation: slideUp 0.8s ease-out 0.4s both;
        }

        .fs-hiw-hero-cta {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            animation: slideUp 0.8s ease-out 0.6s both;
        }

        .fs-hiw-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 18px 36px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .fs-hiw-btn-primary {
            background: var(--fs-white);
            color: var(--fs-primary);
            box-shadow: var(--fs-shadow-lg);
        }

        .fs-hiw-btn-primary:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.3);
        }

        .fs-hiw-btn-outline {
            background: transparent;
            color: var(--fs-white);
            border: 2px solid rgba(255, 255, 255, 0.4);
        }

        .fs-hiw-btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* Interactive Steps Section */
        .fs-hiw-steps {
            max-width: 1100px;
            margin: 0 auto;
            padding: 100px 20px;
        }

        .fs-hiw-steps-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .fs-hiw-steps-header h2 {
            font-size: 40px;
            font-weight: 800;
            margin: 0 0 16px;
            color: var(--fs-text);
        }

        .fs-hiw-steps-header p {
            font-size: 18px;
            color: var(--fs-text-light);
        }

        /* Timeline Steps */
        .fs-hiw-timeline {
            position: relative;
            padding-left: 60px;
        }

        .fs-hiw-timeline::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, var(--fs-primary), var(--fs-secondary), var(--fs-success));
            border-radius: 2px;
        }

        .fs-hiw-step {
            position: relative;
            margin-bottom: 48px;
            opacity: 0;
            transform: translateX(-30px);
            transition: all 0.6s ease-out;
        }

        .fs-hiw-step.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .fs-hiw-step-num {
            position: absolute;
            left: -60px;
            top: 0;
            width: 52px;
            height: 52px;
            background: var(--fs-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 800;
            color: var(--fs-white);
            box-shadow: 0 8px 20px -5px rgba(37, 99, 235, 0.4);
            z-index: 1;
        }

        .fs-hiw-step-content {
            background: var(--fs-white);
            border-radius: var(--fs-radius-sm);
            padding: 32px;
            box-shadow: var(--fs-shadow);
            border: 1px solid var(--fs-border);
            transition: all 0.3s ease;
        }

        .fs-hiw-step-content:hover {
            box-shadow: var(--fs-shadow-lg);
            transform: translateX(8px);
        }

        .fs-hiw-step-icon {
            font-size: 40px;
            margin-bottom: 16px;
        }

        .fs-hiw-step-content h3 {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 12px;
            color: var(--fs-text);
        }

        .fs-hiw-step-content p {
            font-size: 15px;
            color: var(--fs-text-light);
            margin: 0;
            line-height: 1.7;
        }

        /* Interactive Voucher Types */
        .fs-hiw-vouchers {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 100px 20px;
            position: relative;
            overflow: hidden;
        }

        .fs-hiw-vouchers::before {
            content: 'üé´';
            position: absolute;
            font-size: 300px;
            opacity: 0.03;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .fs-hiw-vouchers-inner {
            max-width: 1100px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .fs-hiw-vouchers h2 {
            text-align: center;
            font-size: 36px;
            font-weight: 800;
            color: var(--fs-white);
            margin: 0 0 16px;
        }

        .fs-hiw-vouchers>p {
            text-align: center;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0 0 60px;
        }

        /* Interactive Tabs */
        .fs-hiw-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .fs-hiw-tab {
            padding: 16px 32px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fs-hiw-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--fs-white);
        }

        .fs-hiw-tab.active {
            background: var(--fs-gradient);
            border-color: transparent;
            color: var(--fs-white);
            box-shadow: 0 8px 30px -10px rgba(37, 99, 235, 0.5);
        }

        /* Tab Content */
        .fs-hiw-tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .fs-hiw-tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fs-hiw-voucher-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: var(--fs-radius);
            padding: 48px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            align-items: center;
        }

        .fs-hiw-voucher-visual {
            position: relative;
        }

        .fs-hiw-voucher-mockup {
            background: var(--fs-gradient);
            border-radius: var(--fs-radius-sm);
            padding: 40px;
            text-align: center;
            box-shadow: var(--fs-shadow-lg);
            transform: rotate(-3deg);
            transition: transform 0.3s ease;
        }

        .fs-hiw-voucher-mockup:hover {
            transform: rotate(0deg) scale(1.02);
        }

        .fs-hiw-voucher-mockup h4 {
            color: var(--fs-white);
            font-size: 24px;
            margin: 0 0 8px;
        }

        .fs-hiw-voucher-mockup .price {
            font-size: 48px;
            font-weight: 800;
            color: var(--fs-white);
        }

        .fs-hiw-voucher-mockup .tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 50px;
            color: var(--fs-white);
            font-size: 14px;
            margin-top: 16px;
        }

        .fs-hiw-voucher-info h3 {
            font-size: 28px;
            font-weight: 800;
            color: var(--fs-white);
            margin: 0 0 16px;
        }

        .fs-hiw-voucher-info p {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.8;
            margin: 0 0 24px;
        }

        .fs-hiw-voucher-features {
            list-style: none;
            padding: 0;
            margin: 0 0 32px;
        }

        .fs-hiw-voucher-features li {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fs-hiw-voucher-features li:last-child {
            border-bottom: none;
        }

        .fs-hiw-voucher-features li::before {
            content: '‚úÖ';
            font-size: 16px;
        }

        /* Benefits Comparison */
        .fs-hiw-compare {
            max-width: 1000px;
            margin: 0 auto;
            padding: 100px 20px;
        }

        .fs-hiw-compare h2 {
            text-align: center;
            font-size: 36px;
            font-weight: 800;
            margin: 0 0 60px;
        }

        .fs-hiw-compare-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 32px;
        }

        .fs-hiw-compare-card {
            background: var(--fs-white);
            border-radius: var(--fs-radius);
            padding: 40px;
            box-shadow: var(--fs-shadow-lg);
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .fs-hiw-compare-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
        }

        .fs-hiw-compare-card.free::before {
            background: var(--fs-gradient);
        }

        .fs-hiw-compare-card.discount::before {
            background: var(--fs-gradient-gold);
        }

        .fs-hiw-compare-card:hover {
            transform: translateY(-8px);
        }

        .fs-hiw-compare-icon {
            font-size: 56px;
            margin-bottom: 20px;
        }

        .fs-hiw-compare-card h3 {
            font-size: 24px;
            font-weight: 800;
            margin: 0 0 8px;
        }

        .fs-hiw-compare-card .subtitle {
            font-size: 15px;
            color: var(--fs-text-light);
            margin: 0 0 20px;
        }

        .fs-hiw-compare-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .fs-hiw-compare-card ul li {
            padding: 10px 0;
            font-size: 14px;
            color: var(--fs-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fs-hiw-compare-card ul li::before {
            content: '‚Üí';
            color: var(--fs-primary);
            font-weight: bold;
        }

        /* Final CTA Section */
        .fs-hiw-cta {
            background: var(--fs-gradient);
            padding: 100px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .fs-hiw-cta::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: 100px;
            animation: sparkle 20s linear infinite;
        }

        @keyframes sparkle {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(-100px);
            }
        }

        .fs-hiw-cta-content {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .fs-hiw-cta h2 {
            font-size: clamp(32px, 5vw, 48px);
            font-weight: 800;
            color: var(--fs-white);
            margin: 0 0 20px;
        }

        .fs-hiw-cta p {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
            margin: 0 0 40px;
            line-height: 1.7;
        }

        .fs-hiw-cta-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Animated Counter */
        .fs-hiw-stats {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin-top: 60px;
            flex-wrap: wrap;
        }

        .fs-hiw-stat {
            text-align: center;
        }

        .fs-hiw-stat-num {
            font-size: 48px;
            font-weight: 800;
            color: var(--fs-white);
            display: block;
        }

        .fs-hiw-stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .fs-hiw-hero {
                padding: 60px 20px;
            }

            .fs-hiw-timeline {
                padding-left: 50px;
            }

            .fs-hiw-timeline::before {
                left: 19px;
            }

            .fs-hiw-step-num {
                left: -50px;
                width: 42px;
                height: 42px;
                font-size: 18px;
            }

            .fs-hiw-voucher-card {
                grid-template-columns: 1fr;
            }

            .fs-hiw-compare-grid {
                grid-template-columns: 1fr;
            }

            .fs-hiw-stats {
                gap: 32px;
            }

            .fs-hiw-stat-num {
                font-size: 36px;
            }
        }
    </style>

    <div class="fs-hiw-page">
        <!-- Hero Section -->
        <section class="fs-hiw-hero">
            <div class="fs-hiw-hero-content">
                <span class="fs-hiw-badge">üîì Unlock the Secret</span>
                <h1>Sleeping <span class="highlight">for Free</span>: Introducing Freestays</h1>
                <p>Imagine waking up to a new day, feeling refreshed and rejuvenated, without worrying about the hefty cost
                    of your accommodation. With Freestays, this reality is now possible.</p>
                <div class="fs-hiw-hero-cta">
                    <a href="/winkel/" class="fs-hiw-btn fs-hiw-btn-primary">üé´ Get Your Voucher Now</a>
                    <a href="#how-it-works" class="fs-hiw-btn fs-hiw-btn-outline">üìñ See How It Works</a>
                </div>
            </div>
        </section>

        <!-- Steps Section -->
        <section class="fs-hiw-steps" id="how-it-works">
            <div class="fs-hiw-steps-header">
                <h2>üöÄ How It Works</h2>
                <p>Revolutionizing the way you experience travel in just 4 simple steps</p>
            </div>

            <div class="fs-hiw-timeline">
                <div class="fs-hiw-step" data-step="1">
                    <div class="fs-hiw-step-num">1</div>
                    <div class="fs-hiw-step-content">
                        <div class="fs-hiw-step-icon">üé´</div>
                        <h3>Get Your Hotel Cheque</h3>
                        <p>Purchase a one-time voucher or unlimited annual card. Receive instant digital delivery to your
                            email. Your ticket to free hotel stays is just one click away!</p>
                    </div>
                </div>

                <div class="fs-hiw-step" data-step="2">
                    <div class="fs-hiw-step-num">2</div>
                    <div class="fs-hiw-step-content">
                        <div class="fs-hiw-step-icon">üîç</div>
                        <h3>Search & Choose Your Hotel</h3>
                        <p>Browse through 450,000+ partner hotels worldwide. Filter by destination, dates, and amenities.
                            Find your perfect stay from luxury resorts to cozy boutique hotels.</p>
                    </div>
                </div>

                <div class="fs-hiw-step" data-step="3">
                    <div class="fs-hiw-step-num">3</div>
                    <div class="fs-hiw-step-content">
                        <div class="fs-hiw-step-icon">‚ú®</div>
                        <h3>Enter Your Cheque Code</h3>
                        <p>Simply fill in your hotel cheque code during reservation. Choose between FREE stay (with meals)
                            or DISCOUNT option (up to 50% off room-only). Confirm your booking instantly!</p>
                    </div>
                </div>

                <div class="fs-hiw-step" data-step="4">
                    <div class="fs-hiw-step-num">4</div>
                    <div class="fs-hiw-step-content">
                        <div class="fs-hiw-step-icon">üõèÔ∏è</div>
                        <h3>Enjoy Your Stay!</h3>
                        <p>Check in at your hotel and enjoy a luxurious stay. Pay only for meals (if applicable) or enjoy
                            your discounted room. Wake up refreshed without the hefty accommodation bill!</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Voucher Types Section -->
        <section class="fs-hiw-vouchers">
            <div class="fs-hiw-vouchers-inner">
                <h2>üéÅ Choose Your Travel Freedom</h2>
                <p>Two ways to save on your next adventure</p>

                <div class="fs-hiw-tabs">
                    <button class="fs-hiw-tab active" data-tab="free">üè® Free Stay Voucher</button>
                    <button class="fs-hiw-tab" data-tab="discount">üí∞ Discount Voucher</button>
                </div>

                <div class="fs-hiw-tab-content active" data-content="free">
                    <div class="fs-hiw-voucher-card">
                        <div class="fs-hiw-voucher-visual">
                            <div class="fs-hiw-voucher-mockup">
                                <h4>Freestays Hotel Cheque</h4>
                                <div class="price">FREE</div>
                                <span class="tag">üõèÔ∏è Room Included</span>
                            </div>
                        </div>
                        <div class="fs-hiw-voucher-info">
                            <h3>Sleep for Free!</h3>
                            <p>Our "Freestays Hotel" rooms offer a 100% free room, with the possibility to enjoy delicious
                                meals and drinks when booking with Half-Board, All-Inclusive or Ultra All-Inclusive.</p>
                            <ul class="fs-hiw-voucher-features">
                                <li>Room is completely FREE</li>
                                <li>Pay only for breakfast & dinner</li>
                                <li>Half-Board, All-Inclusive options</li>
                                <li>Access to 450,000+ hotels</li>
                                <li>Perfect for meal-inclusive travelers</li>
                            </ul>
                            <a href="/winkel/" class="fs-hiw-btn fs-hiw-btn-primary">Get Free Stay Voucher</a>
                        </div>
                    </div>
                </div>

                <div class="fs-hiw-tab-content" data-content="discount">
                    <div class="fs-hiw-voucher-card">
                        <div class="fs-hiw-voucher-visual">
                            <div class="fs-hiw-voucher-mockup" style="background: var(--fs-gradient-gold);">
                                <h4>Discount Hotel Cheque</h4>
                                <div class="price">50% OFF</div>
                                <span class="tag">üí≥ Room Only</span>
                            </div>
                        </div>
                        <div class="fs-hiw-voucher-info">
                            <h3>Up to 50% Discount!</h3>
                            <p>Our exclusive Freestays hotel cheque offers unrivalled savings, up to 50% off our already
                                discounted room rates. No strings attached, no breakfast and dinner obligations!</p>
                            <ul class="fs-hiw-voucher-features">
                                <li>Up to 50% off room price</li>
                                <li>No meal obligations</li>
                                <li>Room-only flexibility</li>
                                <li>Access to 450,000+ hotels</li>
                                <li>Perfect for flexible travelers</li>
                            </ul>
                            <a href="/winkel/" class="fs-hiw-btn fs-hiw-btn-primary"
                                style="background: var(--fs-gradient-gold);">Get Discount Voucher</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Comparison Section -->
        <section class="fs-hiw-compare">
            <h2>üÜö Which Option is Right for You?</h2>
            <div class="fs-hiw-compare-grid">
                <div class="fs-hiw-compare-card free">
                    <div class="fs-hiw-compare-icon">üè®</div>
                    <h3>Free Stay Option</h3>
                    <p class="subtitle">Best for meal-inclusive travelers</p>
                    <ul>
                        <li>100% free room accommodation</li>
                        <li>Pay for Half-Board or All-Inclusive</li>
                        <li>Enjoy hotel restaurants & bars</li>
                        <li>Great for resort vacations</li>
                        <li>Perfect for families</li>
                    </ul>
                </div>
                <div class="fs-hiw-compare-card discount">
                    <div class="fs-hiw-compare-icon">üí∞</div>
                    <h3>Discount Option</h3>
                    <p class="subtitle">Best for flexible travelers</p>
                    <ul>
                        <li>Up to 50% off room rates</li>
                        <li>No meal obligations</li>
                        <li>Explore local restaurants</li>
                        <li>Great for city breaks</li>
                        <li>Perfect for business travelers</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Final CTA -->
        <section class="fs-hiw-cta">
            <div class="fs-hiw-cta-content">
                <h2>üåü Ready to Travel Smarter?</h2>
                <p>At Freestays, we strive to make your travel dreams a reality. Whether you're a traveler, business leader,
                    or corporate executive, Freestays has the solution for you.</p>
                <div class="fs-hiw-cta-buttons">
                    <a href="/winkel/" class="fs-hiw-btn fs-hiw-btn-primary">üé´ Order Your Voucher Today</a>
                    <a href="/" class="fs-hiw-btn fs-hiw-btn-outline">üîç Explore Hotels</a>
                </div>

                <div class="fs-hiw-stats">
                    <div class="fs-hiw-stat">
                        <span class="fs-hiw-stat-num" data-target="450000">450,000+</span>
                        <span class="fs-hiw-stat-label">Hotels Worldwide</span>
                    </div>
                    <div class="fs-hiw-stat">
                        <span class="fs-hiw-stat-num">15,000+</span>
                        <span class="fs-hiw-stat-label">Happy Travelers</span>
                    </div>
                    <div class="fs-hiw-stat">
                        <span class="fs-hiw-stat-num">50%</span>
                        <span class="fs-hiw-stat-label">Max Savings</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        (function () {
            // Scroll animation for steps
            const steps = document.querySelectorAll('.fs-hiw-step');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry, index) => {
                    if (entry.isIntersecting) {
                        setTimeout(() => {
                            entry.target.classList.add('visible');
                        }, index * 150);
                    }
                });
            }, { threshold: 0.2 });

            steps.forEach(step => observer.observe(step));

            // Tab switching
            const tabs = document.querySelectorAll('.fs-hiw-tab');
            const contents = document.querySelectorAll('.fs-hiw-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.tab;

                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.querySelector(`[data-content="${target}"]`).classList.add('active');
                });
            });

            // Smooth scroll for anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        })();
    </script>
    <?php
    return ob_get_clean();
});


/**
 * Benefits for Hotels Shortcode
 * Usage: [freestays_hotel_benefits]
 */
add_shortcode('freestays_hotel_benefits', function () {
    ob_start();
    ?>
    <style>
        /* Benefits for Hotels - Unique Design */
        .fs-benefits-wrap {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #1a1a2e;
            line-height: 1.7;
            overflow-x: hidden;
        }

        .fs-benefits-wrap * {
            box-sizing: border-box;
        }

        /* Hero Section - Split Design */
        .fs-benefits-hero {
            min-height: 85vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b4e 100%);
            position: relative;
            overflow: hidden;
        }

        .fs-benefits-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 80%;
            height: 200%;
            background: radial-gradient(ellipse, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            animation: heroGlow 8s ease-in-out infinite;
        }

        @keyframes heroGlow {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }

            50% {
                transform: translate(-5%, 5%) scale(1.1);
                opacity: 0.8;
            }
        }

        .fs-benefits-hero-left {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 80px 60px 80px 80px;
            position: relative;
            z-index: 2;
        }

        .fs-benefits-hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.4);
            padding: 8px 16px;
            border-radius: 50px;
            color: #a5b4fc;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 30px;
            width: fit-content;
            animation: fadeInUp 0.8s ease-out;
        }

        .fs-benefits-hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 800;
            color: #fff;
            line-height: 1.1;
            margin: 0 0 20px 0;
            animation: fadeInUp 0.8s ease-out 0.1s both;
        }

        .fs-benefits-hero h1 span {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .fs-benefits-hero-subtitle {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.7);
            max-width: 500px;
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .fs-benefits-hero-stats {
            display: flex;
            gap: 40px;
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        .fs-benefits-stat {
            text-align: left;
        }

        .fs-benefits-stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #6366f1;
            display: block;
        }

        .fs-benefits-stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .fs-benefits-hero-right {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 60px;
        }

        .fs-benefits-hero-visual {
            position: relative;
            width: 100%;
            max-width: 450px;
        }

        .fs-benefits-hero-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px;
            animation: floatCard 6s ease-in-out infinite;
        }

        @keyframes floatCard {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .fs-benefits-hero-card h3 {
            color: #fff;
            font-size: 1.5rem;
            margin: 0 0 25px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fs-benefits-hero-card-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fs-benefits-hero-card-item:last-child {
            border-bottom: none;
        }

        .fs-benefits-hero-card-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .fs-benefits-hero-card-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 15px;
        }

        .fs-benefits-hero-card-text strong {
            color: #fff;
            display: block;
            font-size: 16px;
            margin-bottom: 2px;
        }

        /* Why Freestays Section */
        .fs-benefits-why {
            padding: 100px 20px;
            background: #fafbfc;
        }

        .fs-benefits-why-inner {
            max-width: 1200px;
            margin: 0 auto;
        }

        .fs-benefits-section-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .fs-benefits-section-header h2 {
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 800;
            color: #1a1a2e;
            margin: 0 0 15px 0;
        }

        .fs-benefits-section-header p {
            font-size: 1.1rem;
            color: #64748b;
            max-width: 600px;
            margin: 0 auto;
        }

        .fs-benefits-why-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
        }

        .fs-benefits-why-card {
            background: #fff;
            border-radius: 20px;
            padding: 35px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .fs-benefits-why-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .fs-benefits-why-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.15);
        }

        .fs-benefits-why-card:hover::before {
            transform: scaleX(1);
        }

        .fs-benefits-why-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f0f1ff 0%, #e8e9ff 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .fs-benefits-why-card h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0 0 12px 0;
        }

        .fs-benefits-why-card p {
            font-size: 15px;
            color: #64748b;
            margin: 0;
            line-height: 1.6;
        }

        /* Hotel Benefits Section - Dark */
        .fs-benefits-hotels {
            padding: 100px 20px;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f23 100%);
            position: relative;
        }

        .fs-benefits-hotels::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%236366f1' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .fs-benefits-hotels-inner {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .fs-benefits-hotels .fs-benefits-section-header h2 {
            color: #fff;
        }

        .fs-benefits-hotels .fs-benefits-section-header p {
            color: rgba(255, 255, 255, 0.6);
        }

        .fs-benefits-hotels-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }

        .fs-benefits-hotel-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 40px;
            transition: all 0.4s ease;
        }

        .fs-benefits-hotel-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-5px);
        }

        .fs-benefits-hotel-card-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }

        .fs-benefits-hotel-icon {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            flex-shrink: 0;
        }

        .fs-benefits-hotel-card h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            margin: 0 0 8px 0;
        }

        .fs-benefits-hotel-card p {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.6);
            margin: 0;
            line-height: 1.7;
        }

        .fs-benefits-hotel-quote {
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid #6366f1;
            padding: 15px 20px;
            margin-top: 20px;
            border-radius: 0 10px 10px 0;
        }

        .fs-benefits-hotel-quote p {
            font-style: italic;
            color: #a5b4fc;
            font-size: 14px;
            margin: 0;
        }

        /* Comparison Section */
        .fs-benefits-compare {
            padding: 100px 20px;
            background: #fff;
        }

        .fs-benefits-compare-inner {
            max-width: 1000px;
            margin: 0 auto;
        }

        .fs-benefits-compare-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 50px;
        }

        .fs-benefits-compare-col {
            border-radius: 24px;
            padding: 40px;
            position: relative;
        }

        .fs-benefits-compare-col.guests {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
        }

        .fs-benefits-compare-col.hotels {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 2px solid #a855f7;
        }

        .fs-benefits-compare-col h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 25px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fs-benefits-compare-col.guests h3 {
            color: #0369a1;
        }

        .fs-benefits-compare-col.hotels h3 {
            color: #7c3aed;
        }

        .fs-benefits-compare-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .fs-benefits-compare-list li {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            font-size: 15px;
            color: #334155;
        }

        .fs-benefits-compare-list li::before {
            content: '‚úì';
            width: 24px;
            height: 24px;
            background: #10b981;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Service Fee Section */
        .fs-benefits-fee {
            padding: 80px 20px;
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
        }

        .fs-benefits-fee-inner {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .fs-benefits-fee-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #fbbf24;
            color: #78350f;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 25px;
        }

        .fs-benefits-fee h2 {
            font-size: 2rem;
            font-weight: 800;
            color: #1a1a2e;
            margin: 0 0 15px 0;
        }

        .fs-benefits-fee-price {
            font-size: 4rem;
            font-weight: 800;
            color: #6366f1;
            margin: 30px 0;
        }

        .fs-benefits-fee-price span {
            font-size: 1.5rem;
            color: #64748b;
        }

        .fs-benefits-fee-features {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .fs-benefits-fee-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: #334155;
        }

        .fs-benefits-fee-feature::before {
            content: '‚úì';
            width: 22px;
            height: 22px;
            background: #10b981;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        /* CTA Section */
        .fs-benefits-cta {
            padding: 100px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .fs-benefits-cta::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            animation: ctaPulse 10s ease-in-out infinite;
        }

        @keyframes ctaPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        .fs-benefits-cta-inner {
            max-width: 700px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .fs-benefits-cta h2 {
            font-size: clamp(2rem, 4vw, 2.8rem);
            font-weight: 800;
            color: #fff;
            margin: 0 0 20px 0;
        }

        .fs-benefits-cta p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.85);
            margin: 0 0 40px 0;
        }

        .fs-benefits-cta-tagline {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-top: 50px;
            opacity: 0.9;
        }

        .fs-benefits-cta-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            color: #6366f1;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .fs-benefits-cta-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        /* Guest Benefits Footer */
        .fs-benefits-guest-footer {
            padding: 60px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .fs-benefits-guest-footer-inner {
            max-width: 1000px;
            margin: 0 auto;
        }

        .fs-benefits-guest-footer h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0 0 30px 0;
            text-align: center;
        }

        .fs-benefits-guest-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        .fs-benefits-guest-item {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .fs-benefits-guest-item-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 18px;
            flex-shrink: 0;
        }

        .fs-benefits-guest-item p {
            font-size: 14px;
            color: #334155;
            margin: 0;
            line-height: 1.6;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .fs-benefits-hero {
                grid-template-columns: 1fr;
                min-height: auto;
            }

            .fs-benefits-hero-left {
                padding: 60px 30px;
            }

            .fs-benefits-hero-right {
                padding: 30px;
            }

            .fs-benefits-why-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .fs-benefits-hotels-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .fs-benefits-hero-stats {
                flex-direction: column;
                gap: 20px;
            }

            .fs-benefits-why-grid {
                grid-template-columns: 1fr;
            }

            .fs-benefits-compare-table {
                grid-template-columns: 1fr;
            }

            .fs-benefits-fee-features {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .fs-benefits-guest-list {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <div class="fs-benefits-wrap">
        <!-- Hero Section -->
        <section class="fs-benefits-hero">
            <div class="fs-benefits-hero-left">
                <div class="fs-benefits-hero-badge">
                    üè® For Hotels & Partners
                </div>
                <h1>The Future of<br><span>Hotel Bookings</span></h1>
                <p class="fs-benefits-hero-subtitle">
                    A New Era with Freestays. Transforming the way people book hotels with exclusive hotel cheques that
                    unlock instant discounts‚Äîno commissions, no hidden fees.
                </p>
                <div class="fs-benefits-hero-stats">
                    <div class="fs-benefits-stat">
                        <span class="fs-benefits-stat-value">0%</span>
                        <span class="fs-benefits-stat-label">Commission</span>
                    </div>
                    <div class="fs-benefits-stat">
                        <span class="fs-benefits-stat-value">100%</span>
                        <span class="fs-benefits-stat-label">Revenue Retention</span>
                    </div>
                    <div class="fs-benefits-stat">
                        <span class="fs-benefits-stat-value">450K+</span>
                        <span class="fs-benefits-stat-label">Hotels Listed</span>
                    </div>
                </div>
            </div>
            <div class="fs-benefits-hero-right">
                <div class="fs-benefits-hero-visual">
                    <div class="fs-benefits-hero-card">
                        <h3>üéØ Why Hotels Choose Us</h3>
                        <div class="fs-benefits-hero-card-item">
                            <div class="fs-benefits-hero-card-icon">üí∞</div>
                            <div class="fs-benefits-hero-card-text">
                                <strong>Keep All Revenue</strong>
                                No commission deducted‚Äîever
                            </div>
                        </div>
                        <div class="fs-benefits-hero-card-item">
                            <div class="fs-benefits-hero-card-icon">üÜì</div>
                            <div class="fs-benefits-hero-card-text">
                                <strong>Free Listing</strong>
                                No subscription or membership fees
                            </div>
                        </div>
                        <div class="fs-benefits-hero-card-item">
                            <div class="fs-benefits-hero-card-icon">üéõÔ∏è</div>
                            <div class="fs-benefits-hero-card-text">
                                <strong>Full Control</strong>
                                Set your own rates & policies
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Why Book with Freestays -->
        <section class="fs-benefits-why">
            <div class="fs-benefits-why-inner">
                <div class="fs-benefits-section-header">
                    <h2>üåü Why Book with Freestays</h2>
                    <p>Smart travelers choose Freestays for transparent pricing and guaranteed savings</p>
                </div>
                <div class="fs-benefits-why-grid">
                    <div class="fs-benefits-why-card">
                        <div class="fs-benefits-why-icon">üí∏</div>
                        <h3>Lowest Rates</h3>
                        <p>No commissions built into pricing, allowing hotels to offer better rates. Guests consistently get
                            more affordable bookings.</p>
                    </div>
                    <div class="fs-benefits-why-card">
                        <div class="fs-benefits-why-icon">üîç</div>
                        <h3>Transparent Pricing</h3>
                        <p>Every booking includes only a small service fee, clearly shown at checkout. No last-minute
                            surprises.</p>
                    </div>
                    <div class="fs-benefits-why-card">
                        <div class="fs-benefits-why-icon">üö´</div>
                        <h3>No Hidden Fees</h3>
                        <p>Guests see one final cost that includes everything. No hidden commissions or unexpected charges.
                        </p>
                    </div>
                    <div class="fs-benefits-why-card">
                        <div class="fs-benefits-why-icon">‚úÖ</div>
                        <h3>Best Deals Guaranteed</h3>
                        <p>The voucher system ensures Freestays always presents the lowest net price available online.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Benefits for Hotels -->
        <section class="fs-benefits-hotels">
            <div class="fs-benefits-hotels-inner">
                <div class="fs-benefits-section-header">
                    <h2>üè® Benefits for Hotels</h2>
                    <p>Gain access to a powerful new model for attracting guests without sacrificing margins or control</p>
                </div>
                <div class="fs-benefits-hotels-grid">
                    <div class="fs-benefits-hotel-card">
                        <div class="fs-benefits-hotel-card-header">
                            <div class="fs-benefits-hotel-icon">üí∞</div>
                            <div>
                                <h3>100% Revenue Retention</h3>
                                <p>Hotels keep all of the booking revenue‚Äîno commission is deducted. This dramatically
                                    improves profit margins.</p>
                            </div>
                        </div>
                        <div class="fs-benefits-hotel-quote">
                            <p>"Say goodbye to OTA fees forever. OTAs take 15%‚Äì30% of your revenue. We take 0%."</p>
                        </div>
                    </div>
                    <div class="fs-benefits-hotel-card">
                        <div class="fs-benefits-hotel-card-header">
                            <div class="fs-benefits-hotel-icon">üÜì</div>
                            <div>
                                <h3>No Membership or Subscription Fees</h3>
                                <p>Hotels are listed automatically and for free. There's no cost to be on the platform and
                                    no upfront charges.</p>
                            </div>
                        </div>
                    </div>
                    <div class="fs-benefits-hotel-card">
                        <div class="fs-benefits-hotel-card-header">
                            <div class="fs-benefits-hotel-icon">üéõÔ∏è</div>
                            <div>
                                <h3>Pricing Freedom</h3>
                                <p>Without commission pressure, hotels can offer lower rates or keep them steady‚Äîgiving full
                                    control over pricing strategy.</p>
                            </div>
                        </div>
                    </div>
                    <div class="fs-benefits-hotel-card">
                        <div class="fs-benefits-hotel-card-header">
                            <div class="fs-benefits-hotel-icon">ü§ù</div>
                            <div>
                                <h3>Direct Relationship with Guests</h3>
                                <p>Hotels retain guest contact information and communications, helping build stronger
                                    relationships and drive future direct bookings.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Comparison Table -->
        <section class="fs-benefits-compare">
            <div class="fs-benefits-compare-inner">
                <div class="fs-benefits-section-header">
                    <h2>üìä A Better Booking Model</h2>
                    <p>Benefits for everyone in the booking ecosystem</p>
                </div>
                <div class="fs-benefits-compare-table">
                    <div class="fs-benefits-compare-col guests">
                        <h3>üë§ For Guests</h3>
                        <ul class="fs-benefits-compare-list">
                            <li>Lower prices with no commission markup</li>
                            <li>Transparent pricing at every step</li>
                            <li>Honest, no-surprise bookings</li>
                            <li>Clear service fee shown upfront</li>
                            <li>Best available rates guaranteed</li>
                        </ul>
                    </div>
                    <div class="fs-benefits-compare-col hotels">
                        <h3>üè® For Hotels</h3>
                        <ul class="fs-benefits-compare-list">
                            <li>Full revenue from every booking</li>
                            <li>No commissions or subscriptions</li>
                            <li>Greater control over rates</li>
                            <li>Direct guest relationships</li>
                            <li>Free automatic listing</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Service Fee Section -->
        <section class="fs-benefits-fee">
            <div class="fs-benefits-fee-inner">
                <div class="fs-benefits-fee-badge">üí° Transparent Fee Structure</div>
                <h2>Guest Service Fee</h2>
                <p>To keep the platform sustainable, Freestays charges a flat service fee per booking</p>
                <div class="fs-benefits-fee-price">‚Ç¨15<span> / booking</span></div>
                <div class="fs-benefits-fee-features">
                    <div class="fs-benefits-fee-feature">Clearly displayed at checkout</div>
                    <div class="fs-benefits-fee-feature">Paid by guest, not hotel</div>
                    <div class="fs-benefits-fee-feature">Supports platform operations</div>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="fs-benefits-cta">
            <div class="fs-benefits-cta-inner">
                <h2>Join the Future of Hotel Bookings</h2>
                <p>Freestays represents the next generation of hotel booking‚Äîwhere transparency, savings, and value are
                    standard.</p>
                <a href="/winkel/" class="fs-benefits-cta-btn">
                    üé´ Get Your Hotel Cheque
                </a>
                <div class="fs-benefits-cta-tagline">
                    More savings. More value. No surprises.
                </div>
            </div>
        </section>

        <!-- Guest Benefits Footer -->
        <section class="fs-benefits-guest-footer">
            <div class="fs-benefits-guest-footer-inner">
                <h3>‚ú® Guest Benefits Summary</h3>
                <div class="fs-benefits-guest-list">
                    <div class="fs-benefits-guest-item">
                        <div class="fs-benefits-guest-item-icon">üí∏</div>
                        <p><strong>Lower prices</strong> due to zero commission on hotel rates</p>
                    </div>
                    <div class="fs-benefits-guest-item">
                        <div class="fs-benefits-guest-item-icon">üîç</div>
                        <p><strong>Transparent service fee</strong> clearly shown before booking</p>
                    </div>
                    <div class="fs-benefits-guest-item">
                        <div class="fs-benefits-guest-item-icon">‚úÖ</div>
                        <p><strong>Honest pricing structure</strong> with no unexpected costs</p>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <?php
    return ob_get_clean();
});


/**
 * Become a B2B Partner Shortcode
 * Usage: [freestays_b2b]
 */
add_shortcode('freestays_b2b', function () {
    ob_start();
    ?>
    <style>
        /* B2B Partner Page - Corporate Design */
        .fs-b2b-wrap {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #1a1a2e;
            line-height: 1.7;
            overflow-x: hidden;
        }

        .fs-b2b-wrap * {
            box-sizing: border-box;
        }

        /* Hero Section */
        .fs-b2b-hero {
            min-height: 70vh;
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 30%, #0369a1 60%, #0284c7 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            overflow: hidden;
        }

        .fs-b2b-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .fs-b2b-hero::after {
            content: '';
            position: absolute;
            bottom: -50%;
            right: -20%;
            width: 80%;
            height: 150%;
            background: radial-gradient(ellipse, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
            animation: b2bGlow 10s ease-in-out infinite;
        }

        @keyframes b2bGlow {

            0%,
            100% {
                transform: translate(0, 0);
                opacity: 0.5;
            }

            50% {
                transform: translate(-10%, -5%);
                opacity: 0.8;
            }
        }

        .fs-b2b-hero-inner {
            max-width: 900px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .fs-b2b-hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 12px 24px;
            border-radius: 50px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease-out;
        }

        .fs-b2b-hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 800;
            color: #fff;
            line-height: 1.15;
            margin: 0 0 25px 0;
            animation: fadeInUp 0.8s ease-out 0.1s both;
        }

        .fs-b2b-hero h1 span {
            color: #fbbf24;
        }

        .fs-b2b-hero-subtitle {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.85);
            max-width: 700px;
            margin: 0 auto 40px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .fs-b2b-hero-cta {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #fbbf24;
            color: #78350f;
            padding: 16px 35px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        .fs-b2b-hero-cta:hover {
            background: #f59e0b;
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(251, 191, 36, 0.4);
        }

        /* Pricing Section */
        .fs-b2b-pricing {
            padding: 100px 20px;
            background: linear-gradient(180deg, #f8fafc 0%, #fff 100%);
        }

        .fs-b2b-pricing-inner {
            max-width: 1100px;
            margin: 0 auto;
        }

        .fs-b2b-section-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .fs-b2b-section-header h2 {
            font-size: clamp(2rem, 4vw, 2.8rem);
            font-weight: 800;
            color: #1a1a2e;
            margin: 0 0 15px 0;
        }

        .fs-b2b-section-header p {
            font-size: 1.1rem;
            color: #64748b;
            max-width: 650px;
            margin: 0 auto;
        }

        /* Interactive Pricing Table */
        .fs-b2b-table-wrap {
            background: #fff;
            border-radius: 24px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .fs-b2b-table {
            width: 100%;
            border-collapse: collapse;
        }

        .fs-b2b-table thead {
            background: linear-gradient(135deg, #0c4a6e 0%, #0369a1 100%);
        }

        .fs-b2b-table th {
            padding: 22px 20px;
            color: #fff;
            font-weight: 700;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .fs-b2b-table th:first-child {
            text-align: left;
            padding-left: 35px;
        }

        .fs-b2b-table tbody tr {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .fs-b2b-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .fs-b2b-table tbody tr:hover {
            background: linear-gradient(90deg, #e0f2fe 0%, #f0f9ff 100%);
            transform: scale(1.01);
        }

        .fs-b2b-table tbody tr.highlight {
            background: linear-gradient(90deg, #fef3c7 0%, #fef9c3 100%);
            position: relative;
        }

        .fs-b2b-table tbody tr.highlight::before {
            content: 'üî• POPULAR';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            background: #f59e0b;
            color: #fff;
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }

        .fs-b2b-table tbody tr.best-deal {
            background: linear-gradient(90deg, #dcfce7 0%, #d1fae5 100%);
            position: relative;
        }

        .fs-b2b-table tbody tr.best-deal::before {
            content: 'üíé BEST';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            background: #10b981;
            color: #fff;
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }

        .fs-b2b-table td {
            padding: 20px;
            text-align: center;
            font-size: 15px;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
        }

        .fs-b2b-table td:first-child {
            text-align: left;
            padding-left: 35px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .fs-b2b-table .price {
            font-weight: 800;
            font-size: 18px;
            color: #0369a1;
        }

        .fs-b2b-table .price-annual {
            font-weight: 800;
            font-size: 18px;
            color: #7c3aed;
        }

        .fs-b2b-table .savings {
            display: inline-block;
            background: #dcfce7;
            color: #166534;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 20px;
            margin-left: 8px;
        }

        /* Calculator Buttons */
        .fs-b2b-calc-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 50px;
        }

        .fs-b2b-calc-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #0369a1 0%, #0284c7 100%);
            color: #fff;
            padding: 30px 25px;
            border-radius: 20px;
            text-decoration: none;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .fs-b2b-calc-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .fs-b2b-calc-btn:hover::before {
            left: 100%;
        }

        .fs-b2b-calc-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(3, 105, 161, 0.3);
        }

        .fs-b2b-calc-btn.annual {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
        }

        .fs-b2b-calc-btn.annual:hover {
            box-shadow: 0 20px 40px rgba(124, 58, 237, 0.3);
        }

        .fs-b2b-calc-btn-icon {
            font-size: 40px;
        }

        .fs-b2b-calc-btn-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .fs-b2b-calc-btn-subtitle {
            font-size: 14px;
            opacity: 0.85;
        }

        /* What's Included Section */
        .fs-b2b-included {
            padding: 100px 20px;
            background: #fff;
        }

        .fs-b2b-included-inner {
            max-width: 1100px;
            margin: 0 auto;
        }

        .fs-b2b-included-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-top: 50px;
        }

        .fs-b2b-included-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 24px;
            padding: 40px;
        }

        .fs-b2b-included-card.features {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-color: #a855f7;
        }

        .fs-b2b-included-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 25px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fs-b2b-included-card h3.blue {
            color: #0369a1;
        }

        .fs-b2b-included-card h3.purple {
            color: #7c3aed;
        }

        .fs-b2b-included-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .fs-b2b-included-list li {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 14px 0;
            font-size: 15px;
            color: #334155;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .fs-b2b-included-list li:last-child {
            border-bottom: none;
        }

        .fs-b2b-included-list li::before {
            content: '‚úì';
            width: 26px;
            height: 26px;
            background: #10b981;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Contact CTA Section */
        .fs-b2b-contact {
            padding: 100px 20px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            position: relative;
            overflow: hidden;
        }

        .fs-b2b-contact::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -30%;
            width: 80%;
            height: 200%;
            background: radial-gradient(ellipse, rgba(14, 165, 233, 0.15) 0%, transparent 60%);
        }

        .fs-b2b-contact-inner {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .fs-b2b-contact-icon {
            font-size: 60px;
            margin-bottom: 25px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .fs-b2b-contact h2 {
            font-size: clamp(2rem, 4vw, 2.5rem);
            font-weight: 800;
            color: #fff;
            margin: 0 0 20px 0;
        }

        .fs-b2b-contact p {
            font-size: 1.15rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0 0 40px 0;
        }

        .fs-b2b-contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: #fff;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(14, 165, 233, 0.4);
        }

        .fs-b2b-contact-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(14, 165, 233, 0.5);
        }

        .fs-b2b-contact-email {
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 15px;
        }

        .fs-b2b-contact-email a {
            color: #0ea5e9;
            text-decoration: none;
            font-weight: 600;
        }

        .fs-b2b-contact-email a:hover {
            text-decoration: underline;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .fs-b2b-table-wrap {
                overflow-x: auto;
            }

            .fs-b2b-table {
                min-width: 600px;
            }

            .fs-b2b-calc-buttons {
                grid-template-columns: 1fr;
            }

            .fs-b2b-included-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .fs-b2b-hero {
                padding: 60px 20px;
            }

            .fs-b2b-table tbody tr.highlight::before,
            .fs-b2b-table tbody tr.best-deal::before {
                display: none;
            }
        }
    </style>

    <div class="fs-b2b-wrap">
        <!-- Hero Section -->
        <section class="fs-b2b-hero">
            <div class="fs-b2b-hero-inner">
                <div class="fs-b2b-hero-badge">
                    üè® B2B Partnership Program
                </div>
                <h1>Freestays B2B Hotel Cheque Offer<br><span>Volume Discounts for Business Orders</span></h1>
                <p class="fs-b2b-hero-subtitle">
                    Unlock powerful marketing potential with Freestays hotel cheques ‚Äì the perfect value-added gift for your
                    customers, clients, or staff. Whether you're running a promotion, driving sales, or enhancing loyalty,
                    our travel vouchers offer an unforgettable experience.
                </p>
                <a href="#pricing" class="fs-b2b-hero-cta">
                    üíº View B2B Pricing
                </a>
            </div>
        </section>

        <!-- Pricing Section -->
        <section class="fs-b2b-pricing" id="pricing">
            <div class="fs-b2b-pricing-inner">
                <div class="fs-b2b-section-header">
                    <h2>üíº Special B2B Pricing</h2>
                    <p>The More You Order, The Less You Pay. Our voucher pricing is dynamically adjusted based on your total
                        order value.</p>
                </div>

                <div class="fs-b2b-table-wrap">
                    <table class="fs-b2b-table">
                        <thead>
                            <tr>
                                <th>Order Volume</th>
                                <th>Hotel Cheque Rate</th>
                                <th>Annual Subscription Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1 ‚Äì 10 B2B</td>
                                <td><span class="price">‚Ç¨35,00</span> / cheque</td>
                                <td><span class="price-annual">‚Ç¨129,00</span> / Annual</td>
                            </tr>
                            <tr>
                                <td>11 ‚Äì 50 B2B</td>
                                <td><span class="price">‚Ç¨29,00</span> / cheque</td>
                                <td><span class="price-annual">‚Ç¨99,00</span> / Annual</td>
                            </tr>
                            <tr class="highlight">
                                <td>51 ‚Äì 100 B2B</td>
                                <td><span class="price">‚Ç¨22,50</span> / cheque <span class="savings">-36%</span></td>
                                <td><span class="price-annual">‚Ç¨79,00</span> / Annual <span class="savings">-39%</span></td>
                            </tr>
                            <tr>
                                <td>101 ‚Äì 250 B2B</td>
                                <td><span class="price">‚Ç¨19,00</span> / cheque</td>
                                <td><span class="price-annual">‚Ç¨59,00</span> / Annual</td>
                            </tr>
                            <tr class="highlight">
                                <td>251 ‚Äì 1.000 B2B</td>
                                <td><span class="price">‚Ç¨15,00</span> / cheque <span class="savings">-57%</span></td>
                                <td><span class="price-annual">‚Ç¨29,95</span> / Annual <span class="savings">-77%</span></td>
                            </tr>
                            <tr>
                                <td>1.001 ‚Äì 5.000 B2B</td>
                                <td><span class="price">‚Ç¨9,95</span> / cheque</td>
                                <td><span class="price-annual">‚Ç¨19,95</span> / Annual</td>
                            </tr>
                            <tr>
                                <td>5.001 ‚Äì 10.000 B2B</td>
                                <td><span class="price">‚Ç¨4,95</span> / cheque</td>
                                <td><span class="price-annual">‚Ç¨14,95</span> / Annual</td>
                            </tr>
                            <tr class="best-deal">
                                <td>10.000+ B2B</td>
                                <td><span class="price">‚Ç¨2,50</span> / cheque <span class="savings">-93%</span></td>
                                <td><span class="price-annual">‚Ç¨9,95</span> / Annual <span class="savings">-92%</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Calculator Buttons -->
                <div class="fs-b2b-calc-buttons">
                    <a href="#" class="fs-b2b-calc-btn">
                        <span class="fs-b2b-calc-btn-icon">üßÆ</span>
                        <span class="fs-b2b-calc-btn-title">Hotel Cheque Calculator</span>
                        <span class="fs-b2b-calc-btn-subtitle">Calculate your instant discount</span>
                    </a>
                    <a href="#" class="fs-b2b-calc-btn annual">
                        <span class="fs-b2b-calc-btn-icon">üìä</span>
                        <span class="fs-b2b-calc-btn-title">Annual Subscription Calculator</span>
                        <span class="fs-b2b-calc-btn-subtitle">Calculate your annual savings</span>
                    </a>
                </div>
            </div>
        </section>

        <!-- What's Included Section -->
        <section class="fs-b2b-included">
            <div class="fs-b2b-included-inner">
                <div class="fs-b2b-section-header">
                    <h2>üéÅ What You Get</h2>
                    <p>Everything included with your B2B hotel cheque order</p>
                </div>

                <div class="fs-b2b-included-grid">
                    <div class="fs-b2b-included-card">
                        <h3 class="blue">‚úÖ What's Included</h3>
                        <ul class="fs-b2b-included-list">
                            <li>12 months of hotel stays across thousands of destinations</li>
                            <li>Booking through our Freestays platform</li>
                            <li>24/7 support and booking assistance</li>
                            <li>Access to 450,000+ hotels worldwide</li>
                        </ul>
                    </div>

                    <div class="fs-b2b-included-card features">
                        <h3 class="purple">üì¶ B2B Features</h3>
                        <ul class="fs-b2b-included-list">
                            <li>Custom branding (optional)</li>
                            <li>Volume-based discounts</li>
                            <li>Fast digital delivery</li>
                            <li>Dedicated account manager for large campaigns</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact CTA Section -->
        <section class="fs-b2b-contact">
            <div class="fs-b2b-contact-inner">
                <div class="fs-b2b-contact-icon">üì©</div>
                <h2>Want to Check Larger Volumes?</h2>
                <p>Contact us for a custom quote tailored to your business needs. Our B2B team is ready to help you create
                    the perfect package.</p>
                <a href="mailto:info@freestays.eu" class="fs-b2b-contact-btn">
                    ‚úâÔ∏è Request Custom Quote
                </a>
                <p class="fs-b2b-contact-email">
                    Or email us directly at <a href="mailto:info@freestays.eu">info@freestays.eu</a>
                </p>
            </div>
        </section>
    </div>

    <script>
        (function () {
            // Smooth scroll for anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Table row hover animation
            const tableRows = document.querySelectorAll('.fs-b2b-table tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('mouseenter', function () {
                    this.style.transform = 'scale(1.02)';
                });
                row.addEventListener('mouseleave', function () {
                    this.style.transform = 'scale(1)';
                });
            });
        })();
    </script>
    <?php
    return ob_get_clean();
});


/**
 * Colophon Page Shortcode
 * Usage: [freestays_colophon]
 */
add_shortcode('freestays_colophon', function () {
    // Get current user info for profile link
    $profile_url = is_user_logged_in() ? get_edit_profile_url() : wp_login_url();
    $bookings_url = is_user_logged_in() ? wc_get_account_endpoint_url('orders') : wp_login_url();
    $wishlist_url = class_exists('YITH_WCWL') ? YITH_WCWL()->get_wishlist_url() : '';

    ob_start();
    ?>
    <style>
        /* Colophon Page - Clean Legal Design */
        .fs-colophon-wrap {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #1a1a2e;
            line-height: 1.7;
            overflow-x: hidden;
        }

        .fs-colophon-wrap * {
            box-sizing: border-box;
        }

        /* Hero Section */
        .fs-colophon-hero {
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            padding: 80px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .fs-colophon-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .fs-colophon-hero-inner {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .fs-colophon-hero h1 {
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 800;
            color: #fff;
            margin: 0 0 15px 0;
        }

        .fs-colophon-hero p {
            font-size: 1.15rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }

        /* Main Content */
        .fs-colophon-content {
            max-width: 1100px;
            margin: 0 auto;
            padding: 80px 20px;
        }

        /* Company Info Section */
        .fs-colophon-company {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 24px;
            padding: 50px;
            margin-bottom: 60px;
            border: 1px solid #e2e8f0;
        }

        .fs-colophon-company-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .fs-colophon-company-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #0369a1 0%, #0284c7 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: #fff;
        }

        .fs-colophon-company-header h2 {
            font-size: 1.8rem;
            font-weight: 800;
            color: #1a1a2e;
            margin: 0;
        }

        .fs-colophon-company-header p {
            font-size: 15px;
            color: #64748b;
            margin: 5px 0 0 0;
        }

        .fs-colophon-company-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
        }

        .fs-colophon-detail {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .fs-colophon-detail-icon {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .fs-colophon-detail h4 {
            font-size: 13px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 8px 0;
        }

        .fs-colophon-detail p {
            font-size: 15px;
            color: #1a1a2e;
            margin: 0;
            line-height: 1.5;
        }

        .fs-colophon-detail a {
            color: #0369a1;
            text-decoration: none;
        }

        .fs-colophon-detail a:hover {
            text-decoration: underline;
        }

        /* Section Headers */
        .fs-colophon-section {
            margin-bottom: 50px;
        }

        .fs-colophon-section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .fs-colophon-section-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #0369a1 0%, #0284c7 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .fs-colophon-section-header h3 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0;
        }

        /* Links Table */
        .fs-colophon-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        .fs-colophon-table thead {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }

        .fs-colophon-table th {
            padding: 18px 25px;
            color: #fff;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: left;
        }

        .fs-colophon-table tbody tr {
            transition: all 0.3s ease;
        }

        .fs-colophon-table tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        .fs-colophon-table tbody tr:hover {
            background: #e0f2fe;
        }

        .fs-colophon-table td {
            padding: 18px 25px;
            font-size: 15px;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
        }

        .fs-colophon-table td:first-child {
            font-weight: 600;
            color: #1a1a2e;
        }

        .fs-colophon-table td a {
            color: #0369a1;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .fs-colophon-table td a:hover {
            color: #0284c7;
            text-decoration: underline;
        }

        .fs-colophon-table td a::after {
            content: '‚Üí';
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .fs-colophon-table td a:hover::after {
            transform: translateX(4px);
        }

        .fs-colophon-category {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .fs-colophon-category td {
            font-weight: 700;
            color: #0369a1;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 14px 25px;
            border-bottom: 2px solid #0ea5e9;
        }

        .fs-colophon-category td::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #0ea5e9;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* Legal Section */
        .fs-colophon-legal {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border: 2px solid #f59e0b;
            border-radius: 20px;
            padding: 40px;
            margin-top: 60px;
        }

        .fs-colophon-legal h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #92400e;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .fs-colophon-legal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .fs-colophon-legal-item {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .fs-colophon-legal-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .fs-colophon-legal-item p {
            font-size: 14px;
            color: #78350f;
            margin: 0;
            line-height: 1.6;
        }

        .fs-colophon-legal-item strong {
            display: block;
            color: #92400e;
            margin-bottom: 3px;
        }

        /* Copyright Footer */
        .fs-colophon-copyright {
            text-align: center;
            margin-top: 60px;
            padding-top: 40px;
            border-top: 1px solid #e2e8f0;
        }

        .fs-colophon-copyright p {
            font-size: 14px;
            color: #64748b;
            margin: 0;
        }

        .fs-colophon-copyright strong {
            color: #1a1a2e;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .fs-colophon-company-details {
                grid-template-columns: 1fr;
            }

            .fs-colophon-legal-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .fs-colophon-company {
                padding: 30px 20px;
            }

            .fs-colophon-company-header {
                flex-direction: column;
                text-align: center;
            }

            .fs-colophon-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>

    <div class="fs-colophon-wrap">
        <!-- Hero Section -->
        <section class="fs-colophon-hero">
            <div class="fs-colophon-hero-inner">
                <h1>üìã Colophon</h1>
                <p>Legal information, site map, and company details</p>
            </div>
        </section>

        <!-- Main Content -->
        <div class="fs-colophon-content">
            <!-- Company Info -->
            <section class="fs-colophon-company">
                <div class="fs-colophon-company-header">
                    <div class="fs-colophon-company-logo">üè®</div>
                    <div>
                        <h2>Travelar Group BV</h2>
                        <p>Trading as Freestays.eu</p>
                    </div>
                </div>
                <div class="fs-colophon-company-details">
                    <div class="fs-colophon-detail">
                        <div class="fs-colophon-detail-icon">üìç</div>
                        <h4>Address</h4>
                        <p>Veemweg 29-31<br>3771 MT Barneveld<br>Netherlands</p>
                    </div>
                    <div class="fs-colophon-detail">
                        <div class="fs-colophon-detail-icon">üìß</div>
                        <h4>Contact</h4>
                        <p><a href="mailto:info@freestays.eu">info@freestays.eu</a><br>24/7 Customer Support</p>
                    </div>
                    <div class="fs-colophon-detail">
                        <div class="fs-colophon-detail-icon">üèõÔ∏è</div>
                        <h4>Registration</h4>
                        <p>KvK: Netherlands<br>VAT: NL registered</p>
                    </div>
                </div>
            </section>

            <!-- Site Map Section -->
            <section class="fs-colophon-section">
                <div class="fs-colophon-section-header">
                    <div class="fs-colophon-section-icon">üó∫Ô∏è</div>
                    <h3>Site Map & Quick Links</h3>
                </div>

                <table class="fs-colophon-table">
                    <thead>
                        <tr>
                            <th>Page</th>
                            <th>Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Account & Personal -->
                        <tr class="fs-colophon-category">
                            <td colspan="2">üë§ Account & Personal</td>
                        </tr>
                        <tr>
                            <td>Your Protected Data</td>
                            <td><a href="<?php echo esc_url($profile_url); ?>">View your profile</a></td>
                        </tr>
                        <tr>
                            <td>See My Booking History</td>
                            <td><a href="<?php echo esc_url($bookings_url); ?>">View your bookings</a></td>
                        </tr>
                        <?php if (!empty($wishlist_url)): ?>
                            <tr>
                                <td>My Created Wishlist</td>
                                <td><a href="<?php echo esc_url($wishlist_url); ?>">View your wishlist</a></td>
                            </tr>
                        <?php endif; ?>

                        <!-- Information Pages -->
                        <tr class="fs-colophon-category">
                            <td colspan="2">üìñ Information</td>
                        </tr>
                        <tr>
                            <td>Who We Are</td>
                            <td><a href="/about-us/">About Freestays</a></td>
                        </tr>
                        <tr>
                            <td>How It Works</td>
                            <td><a href="/how-it-works/">Learn how Freestays works</a></td>
                        </tr>
                        <tr>
                            <td>Questions & Answers</td>
                            <td><a href="/faq/">Frequently Asked Questions</a></td>
                        </tr>
                        <tr>
                            <td>All Freestays News</td>
                            <td><a href="/news/">Latest news and updates</a></td>
                        </tr>

                        <!-- Legal Pages -->
                        <tr class="fs-colophon-category">
                            <td colspan="2">‚öñÔ∏è Legal</td>
                        </tr>
                        <tr>
                            <td>Terms & Conditions</td>
                            <td><a href="/terms-and-conditions/">Read our terms</a></td>
                        </tr>
                        <tr>
                            <td>Legal Notice / Privacy Policy</td>
                            <td><a href="/privacy-policy/">Read our privacy policy</a></td>
                        </tr>

                        <!-- Business -->
                        <tr class="fs-colophon-category">
                            <td colspan="2">üíº Business</td>
                        </tr>
                        <tr>
                            <td>Benefits for Hotels</td>
                            <td><a href="/benefits-for-hotels/">Partner with us</a></td>
                        </tr>
                        <tr>
                            <td>Become a B2B Partner</td>
                            <td><a href="/b2b-partner/">B2B volume discounts</a></td>
                        </tr>

                        <!-- Booking -->
                        <tr class="fs-colophon-category">
                            <td colspan="2">üè® Booking</td>
                        </tr>
                        <tr>
                            <td>Search Hotels</td>
                            <td><a href="/">Find your perfect stay</a></td>
                        </tr>
                        <tr>
                            <td>Order Vouchers</td>
                            <td><a href="/winkel/">Get your hotel cheque</a></td>
                        </tr>
                        <tr>
                            <td>Experiences</td>
                            <td><a href="/belevenissen/">Book activities & tours</a></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Legal Statements -->
            <section class="fs-colophon-legal">
                <h3>‚öñÔ∏è Legal Statements</h3>
                <div class="fs-colophon-legal-grid">
                    <div class="fs-colophon-legal-item">
                        <div class="fs-colophon-legal-icon">üîí</div>
                        <p>
                            <strong>Data Protection</strong>
                            Your personal data is protected under GDPR regulations. We only collect data necessary for
                            booking fulfillment and service improvement.
                        </p>
                    </div>
                    <div class="fs-colophon-legal-item">
                        <div class="fs-colophon-legal-icon">¬©Ô∏è</div>
                        <p>
                            <strong>Copyright</strong>
                            All content, logos, and images on this website are owned by Travelar Group BV and protected
                            under copyright law.
                        </p>
                    </div>
                    <div class="fs-colophon-legal-item">
                        <div class="fs-colophon-legal-icon">üç™</div>
                        <p>
                            <strong>Cookies</strong>
                            We use cookies to enhance your browsing experience. By using our site, you consent to our cookie
                            policy as outlined in our Privacy Policy.
                        </p>
                    </div>
                    <div class="fs-colophon-legal-item">
                        <div class="fs-colophon-legal-icon">üèõÔ∏è</div>
                        <p>
                            <strong>Governing Law</strong>
                            All disputes are governed by Dutch law and resolved via binding arbitration in the Netherlands.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Copyright Footer -->
            <div class="fs-colophon-copyright">
                <p>¬© <?php echo date('Y'); ?> <strong>Travelar Group BV</strong> trading as <strong>Freestays.eu</strong>.
                    All rights reserved.</p>
            </div>
        </div>
    </div>
    <?php
    return ob_get_clean();
});


/**
 * News / Blog Page Shortcode
 * Usage: [freestays_news]
 * Displays WordPress blog posts in a modern, dynamic layout
 */
add_shortcode('freestays_news', function ($atts) {
    $atts = shortcode_atts([
        'posts_per_page' => 12,
        'category' => '',
    ], $atts);

    // Query posts
    $args = [
        'post_type' => 'post',
        'post_status' => 'publish',
        'posts_per_page' => intval($atts['posts_per_page']),
        'orderby' => 'date',
        'order' => 'DESC',
    ];

    if (!empty($atts['category'])) {
        $args['category_name'] = $atts['category'];
    }

    $posts_query = new WP_Query($args);

    // Get categories for filter
    $categories = get_categories(['hide_empty' => true]);

    ob_start();
    ?>
    <style>
        /* News Page - Modern Blog Design */
        .fs-news-wrap {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #1a1a2e;
            line-height: 1.7;
            overflow-x: hidden;
        }

        .fs-news-wrap * {
            box-sizing: border-box;
        }

        /* Hero Section */
        .fs-news-hero {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            padding: 80px 20px 100px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .fs-news-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230ea5e9' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .fs-news-hero::after {
            content: '';
            position: absolute;
            bottom: -50px;
            left: 0;
            right: 0;
            height: 100px;
            background: #f8fafc;
            clip-path: ellipse(70% 100% at 50% 100%);
        }

        .fs-news-hero-inner {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .fs-news-hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid rgba(14, 165, 233, 0.4);
            padding: 10px 20px;
            border-radius: 50px;
            color: #38bdf8;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 25px;
        }

        .fs-news-hero h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 800;
            color: #fff;
            margin: 0 0 15px 0;
        }

        .fs-news-hero p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }

        /* Category Filter */
        .fs-news-filters {
            background: #f8fafc;
            padding: 30px 20px 50px;
        }

        .fs-news-filters-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .fs-news-filter-btn {
            background: #fff;
            border: 2px solid #e2e8f0;
            padding: 10px 22px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fs-news-filter-btn:hover {
            border-color: #0ea5e9;
            color: #0ea5e9;
        }

        .fs-news-filter-btn.active {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-color: transparent;
            color: #fff;
        }

        /* Posts Grid */
        .fs-news-content {
            background: #f8fafc;
            padding: 0 20px 80px;
        }

        .fs-news-grid {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
        }

        /* Featured Post (First Post) */
        .fs-news-card.featured {
            grid-column: span 2;
            grid-row: span 2;
        }

        .fs-news-card.featured .fs-news-card-img {
            height: 100%;
            min-height: 400px;
        }

        .fs-news-card.featured .fs-news-card-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.5) 50%, transparent 100%);
        }

        .fs-news-card.featured .fs-news-card-title {
            font-size: 1.8rem;
            color: #fff;
        }

        .fs-news-card.featured .fs-news-card-excerpt {
            color: rgba(255, 255, 255, 0.8);
            display: block;
        }

        .fs-news-card.featured .fs-news-card-meta {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Regular Post Card */
        .fs-news-card {
            background: #fff;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .fs-news-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .fs-news-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
            height: 100%;
        }

        .fs-news-card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .fs-news-card:hover .fs-news-card-img {
            transform: scale(1.05);
        }

        .fs-news-card-img-wrap {
            overflow: hidden;
            position: relative;
        }

        .fs-news-card-category {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: #fff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2;
        }

        .fs-news-card-content {
            padding: 25px;
        }

        .fs-news-card-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 12px;
        }

        .fs-news-card-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .fs-news-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0 0 12px 0;
            line-height: 1.4;
            transition: color 0.3s ease;
        }

        .fs-news-card:hover .fs-news-card-title {
            color: #0ea5e9;
        }

        .fs-news-card-excerpt {
            font-size: 14px;
            color: #64748b;
            margin: 0;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .fs-news-card-read-more {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 18px;
            font-size: 14px;
            font-weight: 600;
            color: #0ea5e9;
            transition: gap 0.3s ease;
        }

        .fs-news-card:hover .fs-news-card-read-more {
            gap: 12px;
        }

        /* No Posts Message */
        .fs-news-empty {
            grid-column: span 3;
            text-align: center;
            padding: 80px 20px;
            background: #fff;
            border-radius: 20px;
        }

        .fs-news-empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .fs-news-empty h3 {
            font-size: 1.5rem;
            color: #1a1a2e;
            margin: 0 0 10px 0;
        }

        .fs-news-empty p {
            color: #64748b;
            margin: 0;
        }

        /* Newsletter CTA */
        .fs-news-newsletter {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            padding: 80px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .fs-news-newsletter::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            animation: newsletterPulse 15s ease-in-out infinite;
        }

        @keyframes newsletterPulse {

            0%,
            100% {
                transform: scale(1) rotate(0deg);
            }

            50% {
                transform: scale(1.2) rotate(180deg);
            }
        }

        .fs-news-newsletter-inner {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .fs-news-newsletter h2 {
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 800;
            color: #fff;
            margin: 0 0 15px 0;
        }

        .fs-news-newsletter p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.85);
            margin: 0 0 30px 0;
        }

        .fs-news-newsletter-form {
            display: flex;
            gap: 12px;
            max-width: 450px;
            margin: 0 auto;
        }

        .fs-news-newsletter-input {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 50px;
            font-size: 15px;
            outline: none;
        }

        .fs-news-newsletter-btn {
            background: #1a1a2e;
            color: #fff;
            padding: 16px 30px;
            border: none;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fs-news-newsletter-btn:hover {
            background: #0f0f23;
            transform: translateY(-2px);
        }

        /* Load More Button */
        .fs-news-load-more {
            text-align: center;
            margin-top: 50px;
        }

        .fs-news-load-more-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            color: #0ea5e9;
            border: 2px solid #0ea5e9;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fs-news-load-more-btn:hover {
            background: #0ea5e9;
            color: #fff;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .fs-news-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .fs-news-card.featured {
                grid-column: span 2;
                grid-row: span 1;
            }

            .fs-news-card.featured .fs-news-card-img {
                min-height: 300px;
            }
        }

        @media (max-width: 768px) {
            .fs-news-grid {
                grid-template-columns: 1fr;
            }

            .fs-news-card.featured {
                grid-column: span 1;
            }

            .fs-news-empty {
                grid-column: span 1;
            }

            .fs-news-newsletter-form {
                flex-direction: column;
            }
        }
    </style>

    <div class="fs-news-wrap">
        <!-- Hero Section -->
        <section class="fs-news-hero">
            <div class="fs-news-hero-inner">
                <div class="fs-news-hero-badge">
                    üì∞ Freestays Blog
                </div>
                <h1>Latest News & Updates</h1>
                <p>Travel tips, destination guides, and the latest from Freestays</p>
            </div>
        </section>

        <!-- Category Filters -->
        <?php if (!empty($categories)): ?>
            <section class="fs-news-filters">
                <div class="fs-news-filters-inner">
                    <button class="fs-news-filter-btn active" data-category="all">All Posts</button>
                    <?php foreach ($categories as $cat): ?>
                        <button class="fs-news-filter-btn" data-category="<?php echo esc_attr($cat->slug); ?>">
                            <?php echo esc_html($cat->name); ?>
                        </button>
                    <?php endforeach; ?>
                </div>
            </section>
        <?php endif; ?>

        <!-- Posts Grid -->
        <section class="fs-news-content">
            <div class="fs-news-grid">
                <?php if ($posts_query->have_posts()): ?>
                    <?php $post_count = 0; ?>
                    <?php while ($posts_query->have_posts()):
                        $posts_query->the_post(); ?>
                        <?php
                        $post_count++;
                        $is_featured = ($post_count === 1);
                        $categories_list = get_the_category();
                        $category_name = !empty($categories_list) ? $categories_list[0]->name : 'News';
                        $category_slugs = array_map(function ($c) {
                            return $c->slug; }, $categories_list);
                        $thumbnail = get_the_post_thumbnail_url(get_the_ID(), 'large');
                        if (!$thumbnail) {
                            // Fallback placeholder
                            $thumbnail = 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800&h=600&fit=crop';
                        }
                        ?>
                        <article class="fs-news-card <?php echo $is_featured ? 'featured' : ''; ?>"
                            data-categories="<?php echo esc_attr(implode(' ', $category_slugs)); ?>">
                            <a href="<?php the_permalink(); ?>" class="fs-news-card-link">
                                <div class="fs-news-card-img-wrap">
                                    <img src="<?php echo esc_url($thumbnail); ?>" alt="<?php the_title_attribute(); ?>"
                                        class="fs-news-card-img" loading="lazy">
                                    <span class="fs-news-card-category"><?php echo esc_html($category_name); ?></span>
                                </div>
                                <div class="fs-news-card-content">
                                    <div class="fs-news-card-meta">
                                        <span>üìÖ <?php echo get_the_date('M j, Y'); ?></span>
                                        <span>‚è±Ô∏è <?php echo ceil(str_word_count(get_the_content()) / 200); ?> min read</span>
                                    </div>
                                    <h2 class="fs-news-card-title"><?php the_title(); ?></h2>
                                    <p class="fs-news-card-excerpt"><?php echo wp_trim_words(get_the_excerpt(), 20, '...'); ?></p>
                                    <span class="fs-news-card-read-more">Read More ‚Üí</span>
                                </div>
                            </a>
                        </article>
                    <?php endwhile; ?>
                    <?php wp_reset_postdata(); ?>
                <?php else: ?>
                    <div class="fs-news-empty">
                        <div class="fs-news-empty-icon">üì≠</div>
                        <h3>No News Yet</h3>
                        <p>Check back soon for the latest updates and travel tips!</p>
                    </div>
                <?php endif; ?>
            </div>

            <?php if ($posts_query->found_posts > intval($atts['posts_per_page'])): ?>
                <div class="fs-news-load-more">
                    <button class="fs-news-load-more-btn">
                        Load More Articles üì∞
                    </button>
                </div>
            <?php endif; ?>
        </section>

        <!-- Newsletter CTA -->
        <section class="fs-news-newsletter">
            <div class="fs-news-newsletter-inner">
                <h2>üì¨ Stay Updated</h2>
                <p>Get the latest travel tips, exclusive deals, and Freestays news delivered to your inbox.</p>
                <form class="fs-news-newsletter-form" action="#" method="post">
                    <input type="email" class="fs-news-newsletter-input" placeholder="Enter your email" required>
                    <button type="submit" class="fs-news-newsletter-btn">Subscribe</button>
                </form>
            </div>
        </section>
    </div>

    <script>
        (function () {
            // Category filter functionality
            const filterBtns = document.querySelectorAll('.fs-news-filter-btn');
            const newsCards = document.querySelectorAll('.fs-news-card');

            filterBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const category = this.dataset.category;

                    // Update active state
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Filter cards
                    newsCards.forEach(card => {
                        if (category === 'all') {
                            card.style.display = 'block';
                            card.style.animation = 'fadeInUp 0.5s ease forwards';
                        } else {
                            const cardCategories = card.dataset.categories.split(' ');
                            if (cardCategories.includes(category)) {
                                card.style.display = 'block';
                                card.style.animation = 'fadeInUp 0.5s ease forwards';
                            } else {
                                card.style.display = 'none';
                            }
                        }
                    });
                });
            });

            // Add fadeInUp animation
            const style = document.createElement('style');
            style.textContent = `
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
            document.head.appendChild(style);
        })();
    </script>
    <?php
    return ob_get_clean();
});

// =============================================================================
// DEFINITIEVE MOBIELE OPLOSSING - SIMPEL & SNEL
// =============================================================================
add_action('wp_head', function () {
    ?>
    <style id="shorttrips-mobile-final">
        /* ===== MOBIELE OPTIMALISATIE - DEFINITIEF ===== */
        @media (max-width: 768px) {

            /* Basis reset */
            body,
            html {
                margin: 0;
                padding: 0;
            }

            /* Containers 8px padding */
            .st-fullbleed,
            .shorttrips-main-page,
            #shorttrips-search-form-container {
                padding: 0 8px;
            }

            /* Hotel cards full-width */
            .st-hotel-card {
                width: 100%;
            }

            /* Affiliate buttons ALTIJD zichtbaar */
            .st-affiliate-buttons {
                display: grid !important;
                grid-template-columns: 1fr !important;
                visibility: visible !important;
            }

            /* Verbeter touch targets (minimaal 44x44px) */
            button,
            a.button,
            .button,
            input[type="submit"],
            input[type="button"] {
                min-height: 44px;
                min-width: 44px;
                padding: 12px 16px;
            }

            /* Verbeter leesbaarheid op klein scherm */
            body {
                font-size: 16px;
                /* Voorkomt iOS zoom bij focus */
                line-height: 1.6;
            }

            /* Voorkom horizontaal scrollen */
            body,
            html {
                overflow-x: hidden;
            }

            * {
                max-width: 100%;
            }

            /* Verbeter formulier inputs voor mobiel */
            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="number"],
            input[type="date"],
            select,
            textarea {
                font-size: 16px !important;
                /* Voorkomt iOS zoom */
                padding: 12px 16px;
                border-radius: 8px;
            }

            /* Verbeter images */
            img {
                height: auto;
                max-width: 100%;
            }

            /* Tables horizontaal scrollbaar */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                white-space: nowrap;
            }

            /* Verbeter spacing op mobiel */
            section,
            .section {
                padding-top: 40px;
                padding-bottom: 40px;
            }

            h1 {
                font-size: 28px;
                line-height: 1.2;
            }

            h2 {
                font-size: 24px;
                line-height: 1.3;
            }

            h3 {
                font-size: 20px;
                line-height: 1.4;
            }
        }

        /* Extra kleine schermen (320-375px) */
        @media (max-width: 400px) {
            body {
                font-size: 15px;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            h3 {
                font-size: 18px;
            }

            .container {
                padding-left: 12px;
                padding-right: 12px;
            }
        }

        /* =================================================================
           HOTEL CARDS MOBILE OPTIMIZATION
           ================================================================= */
        @media (max-width: 768px) {

            .shorttrips-cards-grid,
            .hotels-grid,
            .search-results-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            .hotel-card,
            .shorttrips-card {
                flex-direction: column;
            }

            .hotel-card img,
            .shorttrips-card img {
                width: 100%;
                height: 220px;
                object-fit: cover;
            }

            .hotel-card-content,
            .shorttrips-card-content {
                padding: 16px;
            }

            .hotel-card-title {
                font-size: 18px;
            }

            .hotel-card-price {
                font-size: 20px;
            }
        }

        /* =================================================================
           CHECKOUT MOBILE OPTIMIZATION
           ================================================================= */
        @media (max-width: 768px) {
            .checkout-container {
                flex-direction: column;
            }

            .checkout-form,
            .checkout-summary {
                width: 100%;
            }

            /* Voucher cards stack verticaal */
            .voucher-selection-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .voucher-card {
                padding: 16px;
            }

            .voucher-card-title {
                font-size: 16px;
            }

            /* Payment buttons volledige breedte */
            .checkout-button,
            .payment-button {
                width: 100%;
                padding: 16px;
                font-size: 16px;
            }
        }

        /* =================================================================
           NAVIGATION MOBILE OPTIMIZATION
           ================================================================= */
        @media (max-width: 768px) {

            /* Header menu */
            .site-header {
                padding: 12px 16px;
            }

            .site-logo img {
                max-height: 40px;
            }

            /* Mobile menu (als je een custom menu hebt) */
            .mobile-menu-toggle {
                display: block;
                min-width: 44px;
                min-height: 44px;
            }

            .desktop-menu {
                display: none;
            }

            /* Footer stack verticaal */
            .site-footer {
                text-align: center;
            }

            .footer-columns {
                grid-template-columns: 1fr !important;
                gap: 32px;
                text-align: center;
            }

            .footer-column {
                margin-bottom: 24px;
            }
        }

        /* =================================================================
           CONTENT PAGES MOBILE OPTIMIZATION
           ================================================================= */
        @media (max-width: 768px) {

            /* Accordions */
            .accordion-item {
                margin-bottom: 8px;
            }

            .accordion-header {
                padding: 16px;
                font-size: 16px;
            }

            .accordion-content {
                padding: 16px;
                font-size: 15px;
            }

            /* Cards grid */
            .content-cards-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            /* Benefits/features grid */
            .features-grid,
            .benefits-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            /* Pricing tables */
            .pricing-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .pricing-columns {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }

            /* FAQ filters */
            .faq-filters {
                flex-wrap: wrap;
                gap: 8px;
            }

            .faq-filter-button {
                flex: 1 1 calc(50% - 4px);
                min-width: auto;
            }
        }

        /* =================================================================
           GALLERY/LIGHTBOX MOBILE OPTIMIZATION
           ================================================================= */
        @media (max-width: 768px) {

            /* Gallery grid */
            .gallery-grid,
            .image-gallery {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px;
            }

            /* Lightbox controls groter op mobiel */
            .lightbox-prev,
            .lightbox-next {
                width: 48px;
                height: 48px;
                font-size: 24px;
            }

            .lightbox-close {
                width: 44px;
                height: 44px;
                font-size: 28px;
            }
        }

        /* =================================================================
           TOUCH-FRIENDLY IMPROVEMENTS
           ================================================================= */

        /* Verbeter scroll gedrag */
        * {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            -webkit-touch-callout: none;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Verbeter button feedback */
        button,
        a.button,
        .button {
            -webkit-appearance: none;
            touch-action: manipulation;
            transition: all 0.15s ease;
        }

        button:active,
        a.button:active,
        .button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Voorkom zoom op double-tap */
        * {
            touch-action: manipulation;
        }

        /* Verbeter form select appearance op mobiel */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23666" d="M6 9L1 4h10z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
    </style>
    <?php
}, 999);

// =============================================================================
// COMPETITOR PRICE TABLES & QUEUE (GOOGLE CSE) ‚Äì DB & HELPERS
// =============================================================================

if (!function_exists('freestays_competitor_install_tables')) {
    function freestays_competitor_install_tables()
    {
        global $wpdb;
        $pricesTable = $wpdb->prefix . 'fs_competitor_prices';
        $queueTable = $wpdb->prefix . 'fs_competitor_queue';
        $charsetCollate = $wpdb->get_charset_collate();

        require_once ABSPATH . 'wp-admin/includes/upgrade.php';

        $sqlPrices = "CREATE TABLE {$pricesTable} (
            id BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            hotel_id BIGINT(20) UNSIGNED NOT NULL,
            checkin DATE NOT NULL,
            checkout DATE NOT NULL,
            rooms TINYINT(3) UNSIGNED NOT NULL DEFAULT 1,
            adults TINYINT(3) UNSIGNED NOT NULL DEFAULT 2,
            children TINYINT(3) UNSIGNED NOT NULL DEFAULT 0,
            meal VARCHAR(50) NOT NULL DEFAULT '',
            provider VARCHAR(100) NOT NULL DEFAULT '',
            price_total DECIMAL(12,2) DEFAULT NULL,
            price_per_night DECIMAL(12,2) DEFAULT NULL,
            currency CHAR(3) NOT NULL DEFAULT 'EUR',
            deeplink TEXT NULL,
            snippet TEXT NULL,
            fetched_at DATETIME NOT NULL,
            source_hash CHAR(32) NOT NULL,
            source VARCHAR(50) NOT NULL DEFAULT 'google_cse',
            PRIMARY KEY  (id),
            KEY idx_hotel_date (hotel_id, checkin, checkout),
            KEY idx_source_hash (source_hash)
        ) {$charsetCollate};";

        $sqlQueue = "CREATE TABLE {$queueTable} (
            id BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            hotel_id BIGINT(20) UNSIGNED NOT NULL,
            checkin DATE NOT NULL,
            checkout DATE NOT NULL,
            rooms TINYINT(3) UNSIGNED NOT NULL DEFAULT 1,
            adults TINYINT(3) UNSIGNED NOT NULL DEFAULT 2,
            children TINYINT(3) UNSIGNED NOT NULL DEFAULT 0,
            meal VARCHAR(50) NOT NULL DEFAULT '',
            source_hash CHAR(32) NOT NULL,
            status VARCHAR(20) NOT NULL DEFAULT 'pending',
            last_error TEXT NULL,
            created_at DATETIME NOT NULL,
            updated_at DATETIME NOT NULL,
            PRIMARY KEY  (id),
            KEY idx_status (status),
            KEY idx_source_hash (source_hash)
        ) {$charsetCollate};";

        dbDelta($sqlPrices);
        dbDelta($sqlQueue);

        update_option('freestays_competitor_db_version', '1.0');
    }

    add_action('after_switch_theme', 'freestays_competitor_install_tables');
    add_action('admin_init', function () {
        if (get_option('freestays_competitor_db_version') !== '1.0') {
            freestays_competitor_install_tables();
        }
    });
}

if (!function_exists('freestays_competitor_queue_request')) {
    /**
     * Queue a competitor price lookup for later processing.
     */
    function freestays_competitor_queue_request($hotelId, $checkin, $checkout, $rooms, $adults, $children, $meal = '')
    {
        if (get_option('freestays_show_competitor_prices_google', '0') !== '1') {
            return;
        }
        global $wpdb;
        $queueTable = $wpdb->prefix . 'fs_competitor_queue';

        $hotelId = (int) $hotelId;
        $rooms = max(1, (int) $rooms);
        $adults = max(1, (int) $adults);
        $children = max(0, (int) $children);
        $meal = (string) $meal;

        $sourceHash = md5($hotelId . '|' . $checkin . '|' . $checkout . '|' . $rooms . '|' . $adults . '|' . $children . '|' . $meal);

        // Skip if already in queue pending/processing
        $existingId = $wpdb->get_var(
            $wpdb->prepare(
                "SELECT id FROM {$queueTable} WHERE source_hash = %s AND status IN ('pending','processing') LIMIT 1",
                $sourceHash
            )
        );
        if ($existingId) {
            return;
        }

        $now = current_time('mysql');
        $wpdb->insert(
            $queueTable,
            [
                'hotel_id' => $hotelId,
                'checkin' => $checkin,
                'checkout' => $checkout,
                'rooms' => $rooms,
                'adults' => $adults,
                'children' => $children,
                'meal' => $meal,
                'source_hash' => $sourceHash,
                'status' => 'pending',
                'last_error' => '',
                'created_at' => $now,
                'updated_at' => $now,
            ],
            [
                '%d',
                '%s',
                '%s',
                '%d',
                '%d',
                '%d',
                '%s',
                '%s',
                '%s',
                '%s',
                '%s'
            ]
        );
    }
}

if (!function_exists('freestays_competitor_get_price')) {
    /**
     * Get a recent competitor price from the local table, if available.
     *
     * @return array|null
     */
    function freestays_competitor_get_price($hotelId, $checkin, $checkout, $rooms, $adults, $children, $meal = '')
    {
        global $wpdb;
        $pricesTable = $wpdb->prefix . 'fs_competitor_prices';

        $hotelId = (int) $hotelId;
        $rooms = max(1, (int) $rooms);
        $adults = max(1, (int) $adults);
        $children = max(0, (int) $children);
        // $meal wordt bewust niet meer hard gefilterd; we accepteren elke meal

        $ttlHours = (int) get_option('freestays_competitor_ttl_hours', 24);
        if ($ttlHours < 1) {
            $ttlHours = 1;
        } elseif ($ttlHours > 72) {
            $ttlHours = 72;
        }

        $threshold = gmdate('Y-m-d H:i:s', time() - $ttlHours * 3600);

        $row = $wpdb->get_row(
            $wpdb->prepare(
                "SELECT * FROM {$pricesTable}
                 WHERE hotel_id = %d
                   AND checkin = %s
                   AND checkout = %s
                   AND rooms = %d
                   AND adults = %d
                   AND children = %d
                   AND fetched_at >= %s
                 ORDER BY fetched_at DESC
                 LIMIT 1",
                $hotelId,
                $checkin,
                $checkout,
                $rooms,
                $adults,
                $children,
                $threshold
            ),
            ARRAY_A
        );

        return $row ?: null;
    }
}

if (!function_exists('freestays_competitor_process_queue')) {
    /**
     * Process queued competitor lookups using Google Custom Search.
     *
     * @param int|null $limit Optional max items to process; defaults to option.
     * @return array Summary with counts.
     */
    function freestays_competitor_process_queue($limit = null)
    {
        global $wpdb;
        $queueTable = $wpdb->prefix . 'fs_competitor_queue';
        $pricesTable = $wpdb->prefix . 'fs_competitor_prices';

        $maxPerRun = (int) get_option('freestays_competitor_max_queue_per_run', 20);
        if ($maxPerRun < 1) {
            $maxPerRun = 1;
        } elseif ($maxPerRun > 100) {
            $maxPerRun = 100;
        }
        if ($limit !== null) {
            $limit = (int) $limit;
            if ($limit > 0 && $limit < $maxPerRun) {
                $maxPerRun = $limit;
            }
        }

        $rows = $wpdb->get_results(
            $wpdb->prepare(
                "SELECT * FROM {$queueTable}
                 WHERE status = %s
                 ORDER BY created_at ASC
                 LIMIT %d",
                'pending',
                $maxPerRun
            ),
            ARRAY_A
        );

        if (empty($rows)) {
            return ['processed' => 0, 'success' => 0, 'errors' => 0];
        }

        $processed = 0;
        $success = 0;
        $errors = 0;

        foreach ($rows as $row) {
            $processed++;
            $queueId = (int) $row['id'];

            // Mark as processing
            $wpdb->update(
                $queueTable,
                ['status' => 'processing', 'updated_at' => current_time('mysql')],
                ['id' => $queueId],
                ['%s', '%s'],
                ['%d']
            );

            $hotelId = (int) $row['hotel_id'];
            $checkin = $row['checkin'];
            $checkout = $row['checkout'];
            $rooms = (int) $row['rooms'];
            $adults = (int) $row['adults'];
            $children = (int) $row['children'];
            $meal = (string) $row['meal'];

            // Bereken nachten (voor query-opbouw en validatie)
            try {
                $ci = new DateTime($checkin);
                $co = new DateTime($checkout);
                $nights = max(1, $ci->diff($co)->days);
                $checkinFmt = $ci->format('d-m-Y');
                $checkoutFmt = $co->format('d-m-Y');
            } catch (Exception $e) {
                $nights = 1;
                $checkinFmt = $checkin;
                $checkoutFmt = $checkout;
            }

            // Haal hotelnaam + locatie op
            $hotelName = '';
            $city = '';
            $country = '';
            $dbHotel = $wpdb->get_row(
                $wpdb->prepare(
                    "SELECT hotelname, title, city, country_name
                     FROM ghwk_bravo_hotels
                     WHERE hotel_id = %d",
                    $hotelId
                ),
                ARRAY_A
            );
            if ($dbHotel) {
                $hotelName = !empty($dbHotel['title']) ? $dbHotel['title'] : ($dbHotel['hotelname'] ?? '');
                $city = $dbHotel['city'] ?? '';
                $country = $dbHotel['country_name'] ?? '';
            }

            if ($hotelName === '') {
                $hotelName = 'Hotel ' . $hotelId;
            }

            // Bouw basiszoekquery met context (datums, nachten, volwassenen)
            $queryParts = [$hotelName];
            if ($city) {
                $queryParts[] = $city;
            }
            if ($country) {
                $queryParts[] = $country;
            }
            $queryBase = implode(' ', array_filter($queryParts));
            $ctxSuffix = trim($checkinFmt . ' tot ' . $checkoutFmt . ' ' . $nights . ' nachten ' . $adults . ' volwassenen');

            // Probeer meerdere query-varianten (algemeen + gericht op bekende OTA's en sites)
            $queriesToTry = [
                trim($queryBase . ' ' . $ctxSuffix . ' hotel prijzen'),
                trim($queryBase . ' ' . $ctxSuffix . ' prijzen site:booking.com'),
                trim($queryBase . ' ' . $ctxSuffix . ' prijzen site:expedia.nl'),
            ];

            $best = null;
            $lastErrorMsg = '';

            foreach ($queriesToTry as $q) {
                if ($q === '') {
                    continue;
                }

                $results = freestays_gcs_search($q, 10);
                if (is_wp_error($results)) {
                    // Bewaar laatste fout maar probeer eventueel volgende variant
                    $lastErrorMsg = $results->get_error_message();
                    continue;
                }

                $candidate = freestays_gcs_extract_lowest_price($results, [
                    'nights' => $nights,
                ]);
                if ($candidate !== null) {
                    // Als er al een beste is, kies de laagste prijs
                    if ($best === null || (float) $candidate['price_total'] < (float) $best['price_total']) {
                        $best = $candidate;
                    }
                }
            }
            // Fallback: als context-queries niets opleveren, probeer eenvoudiger varianten zonder datums
            if ($best === null) {
                $fallbackQueries = [
                    trim($queryBase . ' hotel prijzen'),
                    trim($queryBase . ' prijzen site:booking.com'),
                    trim($queryBase . ' prijzen site:expedia.nl'),
                ];
                foreach ($fallbackQueries as $q2) {
                    if ($q2 === '') {
                        continue;
                    }
                    $results2 = freestays_gcs_search($q2, 10);
                    if (is_wp_error($results2)) {
                        $lastErrorMsg = $results2->get_error_message();
                        continue;
                    }
                    $candidate2 = freestays_gcs_extract_lowest_price($results2, [
                        'nights' => $nights,
                    ]);
                    if ($candidate2 !== null) {
                        if ($best === null || (float) $candidate2['price_total'] < (float) $best['price_total']) {
                            $best = $candidate2;
                        }
                    }
                }
                // Voeg fallback-queries toe aan debugtekst
                $queriesToTry = array_merge($queriesToTry, $fallbackQueries);
            }

            if ($best === null) {
                $errors++;
                $wpdb->update(
                    $queueTable,
                    [
                        'status' => 'error',
                        'last_error' => $lastErrorMsg ? $lastErrorMsg : 'Geen prijs gevonden in zoekresultaten (geprobeerde queries: ' . implode(' | ', $queriesToTry) . ').',
                        'updated_at' => current_time('mysql'),
                    ],
                    ['id' => $queueId],
                    ['%s', '%s', '%s'],
                    ['%d']
                );
                continue;
            }

            // Bereken nachten voor per-nacht prijs
            try {
                $ci = new DateTime($checkin);
                $co = new DateTime($checkout);
                $nights = max(1, $ci->diff($co)->days);
            } catch (Exception $e) {
                $nights = 1;
            }

            $priceTotal = (float) $best['price_total'];
            $perNight = $nights > 0 ? $priceTotal / $nights : $priceTotal;

            // Upsert in prices table (REPLACE via source_hash)
            $sourceHash = $row['source_hash'];
            $existingPriceId = $wpdb->get_var(
                $wpdb->prepare(
                    "SELECT id FROM {$pricesTable} WHERE source_hash = %s LIMIT 1",
                    $sourceHash
                )
            );

            $data = [
                'hotel_id' => $hotelId,
                'checkin' => $checkin,
                'checkout' => $checkout,
                'rooms' => $rooms,
                'adults' => $adults,
                'children' => $children,
                'meal' => $meal,
                'provider' => $best['provider'],
                'price_total' => $priceTotal,
                'price_per_night' => $perNight,
                'currency' => $best['currency'],
                'deeplink' => $best['deeplink'],
                'snippet' => $best['snippet'],
                'fetched_at' => current_time('mysql'),
                'source_hash' => $sourceHash,
                'source' => $best['source'],
            ];

            if ($existingPriceId) {
                $wpdb->update(
                    $pricesTable,
                    $data,
                    ['id' => (int) $existingPriceId]
                );
            } else {
                $wpdb->insert($pricesTable, $data);
            }

            $success++;

            // Mark queue item as done
            $wpdb->update(
                $queueTable,
                [
                    'status' => 'done',
                    'last_error' => '',
                    'updated_at' => current_time('mysql'),
                ],
                ['id' => $queueId],
                ['%s', '%s', '%s'],
                ['%d']
            );
        }

        return [
            'processed' => $processed,
            'success' => $success,
            'errors' => $errors,
        ];
    }
}

// =============================================================================
// CRON HOOK ‚Äì AUTOMATISCHE VERWERKING VAN QUEUE
// =============================================================================

add_action('freestays_competitor_cron', function () {
    // Verwerk queue volgens ingestelde limiet / TTL
    freestays_competitor_process_queue(null);
});

// =============================================================================
// GOOGLE CUSTOM SEARCH HELPERS ‚Äì COMPETITOR PRICE COMPARISON (FUTURE USE)
// =============================================================================

if (!function_exists('freestays_gcs_search')) {
    /**
     * Call Google Programmable Search / Custom Search JSON API.
     *
     * @param string $query Zoekstring (hotelnaam, locatie, datums, etc.)
     * @param int    $num   Aantal resultaten (max 10)
     * @return array|\WP_Error
     */
    function freestays_gcs_search(string $query, int $num = 10)
    {
        $apiKey = defined('FREESTAYS_GCS_API_KEY') ? FREESTAYS_GCS_API_KEY : get_option('freestays_gcs_api_key', '');
        $cx = defined('FREESTAYS_GCS_CX') ? FREESTAYS_GCS_CX : get_option('freestays_gcs_cx', '');

        if (empty($apiKey) || empty($cx)) {
            return new WP_Error('gcs_config', 'Google Custom Search API credentials not configured (FREESTAYS_GCS_API_KEY / FREESTAYS_GCS_CX).');
        }

        $num = max(1, min(10, (int) $num));

        $url = add_query_arg(
            [
                'key' => $apiKey,
                'cx' => $cx,
                'q' => $query,
                'num' => $num,
                'gl' => 'nl', // geolocatie NL
                'hl' => 'nl', // taal NL
            ],
            'https://www.googleapis.com/customsearch/v1'
        );

        $response = wp_remote_get($url, ['timeout' => 10]);
        if (is_wp_error($response)) {
            return $response;
        }

        $code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);

        if ($code !== 200) {
            // Probeer extra foutdetail uit JSON te halen
            $errMsg = 'Google CSE HTTP error: ' . $code;
            $decoded = json_decode($body, true);
            if (is_array($decoded) && isset($decoded['error']['message'])) {
                $errMsg .= ' ‚Äì ' . $decoded['error']['message'];
            }
            return new WP_Error('gcs_http', $errMsg);
        }

        $data = json_decode($body, true);
        if (!is_array($data)) {
            return new WP_Error('gcs_json', 'Invalid JSON from Google CSE.');
        }

        return $data;
    }
}

if (!function_exists('freestays_gcs_extract_lowest_price')) {
    /**
     * Extract a lowest indicative price from Google CSE results.
     *
     * NOTE: This is heuristic and should be treated as an indication, not an exact guarantee.
     *
     * @param array $results Raw results from freestays_gcs_search().
     * @param array $context Optional context, e.g. ['nights' => 7].
     * @return array|null Array with provider, price_total, currency, deeplink, snippet OR null if nothing found.
     */
    function freestays_gcs_extract_lowest_price(array $results, array $context = [])
    {
        if (empty($results['items']) || !is_array($results['items'])) {
            return null;
        }

        $best = null;

        $ctxNights = isset($context['nights']) ? (int) $context['nights'] : null;
        if ($ctxNights !== null && $ctxNights < 1) {
            $ctxNights = null;
        }

        foreach ($results['items'] as $item) {
            if (!is_array($item)) {
                continue;
            }
            $title = isset($item['title']) ? (string) $item['title'] : '';
            $snippet = isset($item['snippet']) ? (string) $item['snippet'] : '';
            $link = isset($item['link']) ? (string) $item['link'] : '';

            $text = $title . ' ' . $snippet;
            $lowerText = mb_strtolower($text);

            // Zoek naar prijs-patronen zoals "‚Ç¨137", "‚Ç¨ 1.994" of "‚Ç¨1.994,50"
            if (!preg_match_all('/‚Ç¨\s*([\d\.,]+)/u', $text, $matches)) {
                continue;
            }

            foreach ($matches[1] as $raw) {
                // Normaliseer: "1.994,50" -> "1994.50", "1.994" -> "1994", "137" -> "137"
                $normalized = str_replace(['.', ','], ['', '.'], $raw);
                $amount = (float) $normalized;
                if ($amount <= 0) {
                    continue;
                }

                // Bepaal provider op basis van domein (best effort)
                $domain = (string) parse_url($link, PHP_URL_HOST);
                $provider = $domain ?: 'Unknown';
                $lowerDomain = strtolower($domain);
                if (strpos($lowerDomain, 'booking') !== false) {
                    $provider = 'Booking.com';
                } elseif (strpos($lowerDomain, 'expedia') !== false) {
                    $provider = 'Expedia';
                } elseif (strpos($lowerDomain, 'trivago') !== false) {
                    $provider = 'Trivago';
                } elseif (strpos($lowerDomain, 'hotels.com') !== false) {
                    $provider = 'Hotels.com';
                } elseif (strpos($lowerDomain, 'hrs.com') !== false) {
                    $provider = 'HRS';
                } elseif (strpos($lowerDomain, 'agoda') !== false) {
                    $provider = 'Agoda';
                }

                $effectiveTotal = $amount;

                // Als we context over het aantal nachten hebben, probeer te bepalen of dit
                // een per-nacht prijs of een totaalprijs voor X nachten/dagen is.
                if ($ctxNights !== null) {
                    // Verschillende notaties voor "per nacht"
                    $isPerNight = (bool) preg_match('/\b(per\s+nacht|per\s+night|p\.n\.|p\.p\.n\.)/iu', $lowerText);

                    $matchNights = null;
                    if (preg_match('/(\d+)\s*(nacht|nachten|night|nights)/iu', $lowerText, $m)) {
                        $matchNights = (int) $m[1];
                    }

                    $matchDays = null;
                    if (preg_match('/(\d+)\s*(dag|dagen|day|days)/iu', $lowerText, $m2)) {
                        $matchDays = (int) $m2[1];
                    }

                    if ($isPerNight) {
                        // Interpretatie: bedrag is per nacht ‚Üí vermenigvuldigen met aantal nachten van de zoekopdracht
                        $effectiveTotal = $amount * $ctxNights;
                    } elseif ($matchNights !== null && $matchNights === $ctxNights) {
                        // Tekst verwijst naar dezelfde nachtduur ‚Üí neem bedrag als totaal
                        $effectiveTotal = $amount;
                    } elseif ($matchDays !== null && abs($matchDays - $ctxNights) <= 1) {
                        // "6 dagen" i.p.v. "6 nachten" ‚Üí accepteer met marge van 1 dag
                        $effectiveTotal = $amount;
                    } else {
                        // Ambigue: geen duidelijke relatie met aantal nachten/dagen.
                        // Als het wel duidelijk een hotel/OTA-domein is, neem dan conservatief aan dat het per nacht is.
                        if ($provider !== 'Unknown') {
                            $effectiveTotal = $amount * $ctxNights;
                        } else {
                            continue;
                        }
                    }
                }

                if ($best === null || $effectiveTotal < $best['price_total']) {
                    $best = [
                        'provider' => $provider,
                        'price_total' => $effectiveTotal,
                        'currency' => 'EUR',
                        'deeplink' => $link,
                        'snippet' => mb_substr($snippet, 0, 200),
                        'source' => 'google_cse',
                    ];
                }
            }
        }

        return $best;
    }
}

